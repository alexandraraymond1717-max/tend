<!DOCTYPE html>
<html lang="en">
<!-- v2.2 - Daily Tends rename, Life Areas sidebar with editable values -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tend â€” Intentional Living</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;1,9..144,300;1,9..144,400&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBh7pjHsvlk_c3Ya22U-fWCkSoL89lvnKE",
      authDomain: "tend-17.firebaseapp.com",
      projectId: "tend-17",
      storageBucket: "tend-17.firebasestorage.app",
      messagingSenderId: "795612428176",
      appId: "1:795612428176:web:bff64a86add4ed2aee2515",
      measurementId: "G-2XFLRSET2Y"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-main: #FAF8F5;
      --bg-card: #FFFFFF;
      --bg-elevated: #F0EBE4;
      --text: #2D2A26;
      --text-light: #6B6660;
      --text-muted: #9A9590;
      --border: #E8E2D9;
      --border-dark: #D4CCC0;
      --accent: #7D9B76;
      --accent-light: #E8F0E6;
      
      --winter: #7EB3E0;
      --winter-light: #F5F9FC;
      --spring: #8FD4A0;
      --spring-light: #F5FBF6;
      --summer: #F9D07A;
      --summer-light: #FFFDF7;
      --fall: #E8A090;
      --fall-light: #FDF7F5;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background-color: var(--bg-main);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    h1, h2, h3, h4 { font-family: 'Fraunces', serif; font-weight: 400; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-dark); border-radius: 3px; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.7; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .slide-in { animation: slideIn 0.4s ease-out forwards; }

    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent) !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============ CONSTANTS ============
    const VLQ_DOMAINS = {
      family: { 
        name: 'Family', 
        description: 'Parents, siblings, children, extended family â€” feeling connected to and supported by your family.',
        icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§',
        color: '#E8A090'
      },
      partner: { 
        name: 'Partner & Romance', 
        description: 'Romantic relationship, intimacy, partnership â€” feeling loved and loving fully.',
        icon: 'ðŸ’•',
        color: '#E88B9C'
      },
      friendships: { 
        name: 'Friendships', 
        description: 'Close friends, social connections â€” feeling known, supported, and part of a community.',
        icon: 'ðŸ‘¯',
        color: '#F9D07A'
      },
      career: { 
        name: 'Work & Career', 
        description: 'Professional growth, meaningful work, financial stability â€” feeling purposeful in your work.',
        icon: 'ðŸ’¼',
        color: '#7EB3E0'
      },
      education: { 
        name: 'Learning & Growth', 
        description: 'Knowledge, skills, intellectual curiosity â€” feeling like you\'re growing and developing.',
        icon: 'ðŸ“š',
        color: '#B8A9C9'
      },
      recreation: { 
        name: 'Recreation & Fun', 
        description: 'Hobbies, play, leisure, relaxation â€” feeling joy and lightness in life.',
        icon: 'ðŸŽ¨',
        color: '#8FD4A0'
      },
      spirituality: { 
        name: 'Spirituality & Meaning', 
        description: 'Purpose, faith, inner life, connection to something larger â€” feeling grounded in meaning.',
        icon: 'âœ¨',
        color: '#C4B5D4'
      },
      community: { 
        name: 'Community & Citizenship', 
        description: 'Giving back, volunteering, social responsibility â€” feeling like you contribute to the world.',
        icon: 'ðŸŒ',
        color: '#8BC4A0'
      },
      health: { 
        name: 'Physical Health', 
        description: 'Body, movement, sleep, nutrition â€” feeling strong, energized, and well.',
        icon: 'ðŸ’ª',
        color: '#6BBF59'
      },
      mentalHealth: { 
        name: 'Mental Health', 
        description: 'Emotional wellbeing, self-care, inner peace â€” feeling balanced and at ease with yourself.',
        icon: 'ðŸ§ ',
        color: '#7EB3E0'
      },
    };

    const VLQ_ORDER = ['family', 'partner', 'friendships', 'career', 'education', 'recreation', 'spirituality', 'community', 'health', 'mentalHealth'];

    // Unique ID generator
    let idCounter = 0;
    const generateId = () => `${Date.now()}-${++idCounter}-${Math.random().toString(36).substr(2, 9)}`;

    const LIFE_AREAS = {
      health: { name: 'Health & Wellness', icon: 'â—', color: '#6BBF59' },
      relationships: { name: 'Relationships', icon: 'â™¡', color: '#E88B9C' },
      career: { name: 'Career & Work', icon: 'â—†', color: '#5B9BD5' },
      finances: { name: 'Finances', icon: 'â—‹', color: '#F4B942' },
      growth: { name: 'Personal Growth', icon: 'âœ¦', color: '#9B8AAE' },
      fun: { name: 'Fun & Adventure', icon: 'âœº', color: '#D66B4B' },
    };

    // ============ TENDY SYSTEM ============
    // Garden elements mapped to VLQ domains
    const GARDEN_ELEMENTS = {
      family: { element: 'Oak Tree', icon: 'ðŸŒ³', description: 'Deep-rooted trees' },
      partner: { element: 'Rose', icon: 'ðŸŒ¹', description: 'Intertwined blooms' },
      friendships: { element: 'Wildflowers', icon: 'ðŸŒ¸', description: 'Clustering flowers' },
      career: { element: 'Hedge', icon: 'ðŸŒ¿', description: 'Structured greens' },
      education: { element: 'Sapling', icon: 'ðŸŒ±', description: 'Growing trees' },
      recreation: { element: 'Butterfly', icon: 'ðŸ¦‹', description: 'Whimsy elements' },
      spirituality: { element: 'Stone', icon: 'ðŸª¨', description: 'Grounding features' },
      community: { element: 'Bench', icon: 'ðŸª‘', description: 'Shared spaces' },
      health: { element: 'Vegetable', icon: 'ðŸ¥¬', description: 'Nourishing plants' },
      mentalHealth: { element: 'Water Lily', icon: 'ðŸª·', description: 'Peaceful waters' },
    };

    // Tendy templates by domain and difficulty (1=easy, 2=medium, 3=hard)
    // Type weights per life area: { action: weight, reflective: weight }
    const TYPE_WEIGHTS = {
      career: { action: 1.0, reflective: 0.0 },
      health: { action: 1.0, reflective: 0.0 },
      education: { action: 1.0, reflective: 0.0 },
      recreation: { action: 1.0, reflective: 0.0 },
      family: { action: 0.7, reflective: 0.3 },
      partner: { action: 0.7, reflective: 0.3 },
      friendships: { action: 0.7, reflective: 0.3 },
      community: { action: 0.7, reflective: 0.3 },
      finances: { action: 0.5, reflective: 0.5 },
      spirituality: { action: 0.3, reflective: 0.7 },
      mentalHealth: { action: 0.3, reflective: 0.7 },
    };

    const TENDY_TEMPLATES = {
      family: [
        // Easy (5 min) - Action
        { text: 'Send a "thinking of you" text to a family member', type: 'action', difficulty: 1 },
        { text: 'Share a photo or memory with a family member', type: 'action', difficulty: 1 },
        { text: 'Send a voice note to a family member', type: 'action', difficulty: 1 },
        // Easy (5 min) - Reflective
        { text: 'Write down one thing you appreciate about a family member', type: 'reflective', difficulty: 1 },
        // Hard (30 min) - Action
        { text: 'Call a family member for a real conversation', type: 'action', difficulty: 3 },
        { text: 'Plan a family activity for the upcoming weekend', type: 'action', difficulty: 3 },
        { text: 'Write a heartfelt letter or long message to a family member', type: 'action', difficulty: 3 },
        // Hard (30 min) - Reflective
        { text: 'Journal about your relationship with your family and one way to improve it', type: 'reflective', difficulty: 3 },
      ],
      partner: [
        // Easy - Action
        { text: 'Leave a sweet note for your partner', type: 'action', difficulty: 1 },
        { text: 'Send your partner a message about what you appreciate about them', type: 'action', difficulty: 1 },
        { text: 'Give your partner a genuine compliment', type: 'action', difficulty: 1 },
        // Easy - Reflective
        { text: 'Write down one thing your partner did recently that you appreciated', type: 'reflective', difficulty: 1 },
        // Hard - Action
        { text: 'Have a device-free conversation about dreams and goals', type: 'action', difficulty: 3 },
        { text: 'Plan a surprise or date for your partner', type: 'action', difficulty: 3 },
        { text: 'Cook a meal together or for your partner', type: 'action', difficulty: 3 },
        // Hard - Reflective
        { text: 'Journal about what makes your relationship strong and one area to grow', type: 'reflective', difficulty: 3 },
      ],
      friendships: [
        // Easy - Action
        { text: 'Send a genuine message to a friend you haven\'t talked to recently', type: 'action', difficulty: 1 },
        { text: 'React to a friend\'s post with a thoughtful comment', type: 'action', difficulty: 1 },
        { text: 'Send a voice memo to a friend', type: 'action', difficulty: 1 },
        // Easy - Reflective
        { text: 'Write down one friend you want to reconnect with and why', type: 'reflective', difficulty: 1 },
        // Hard - Action
        { text: 'Call a friend for a real catch-up conversation', type: 'action', difficulty: 3 },
        { text: 'Plan a get-together with friends', type: 'action', difficulty: 3 },
        { text: 'Reach out to an old friend you\'ve lost touch with', type: 'action', difficulty: 3 },
        // Hard - Reflective
        { text: 'Journal about the friendships that matter most and how to nurture them', type: 'reflective', difficulty: 3 },
      ],
      career: [
        // Easy - Action (100% action for career)
        { text: 'Organize your workspace for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Write down your #1 priority for today', type: 'action', difficulty: 1 },
        { text: 'Send one networking message or professional email', type: 'action', difficulty: 1 },
        { text: 'Delete 10 emails or clear 3 items from your task list', type: 'action', difficulty: 1 },
        // Hard - Action
        { text: 'Spend 30 minutes learning a skill that would advance your career', type: 'action', difficulty: 3 },
        { text: 'Update one section of your resume or portfolio', type: 'action', difficulty: 3 },
        { text: 'Reach out to one person for career advice or mentorship', type: 'action', difficulty: 3 },
        { text: 'Complete one work task you\'ve been putting off', type: 'action', difficulty: 3 },
      ],
      education: [
        // Easy - Action (100% action)
        { text: 'Read one article about something you want to learn', type: 'action', difficulty: 1 },
        { text: 'Watch one 5-minute educational video', type: 'action', difficulty: 1 },
        { text: 'Learn one new word, concept, or fact and write it down', type: 'action', difficulty: 1 },
        { text: 'Add one book or course to your learning list', type: 'action', difficulty: 1 },
        // Hard - Action
        { text: 'Spend 30 minutes on a course, tutorial, or book', type: 'action', difficulty: 3 },
        { text: 'Practice a skill you\'re learning for 30 minutes', type: 'action', difficulty: 3 },
        { text: 'Teach someone one thing you know well', type: 'action', difficulty: 3 },
        { text: 'Work on a personal project for 30 minutes', type: 'action', difficulty: 3 },
      ],
      recreation: [
        // Easy - Action (100% action)
        { text: 'Do a crossword, sudoku, or word puzzle for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Listen to one song that brings you joy', type: 'action', difficulty: 1 },
        { text: 'Watch one funny video', type: 'action', difficulty: 1 },
        { text: 'Step outside and enjoy the weather for 5 minutes', type: 'action', difficulty: 1 },
        // Hard - Action
        { text: 'Spend 30 minutes on a hobby you\'ve been neglecting', type: 'action', difficulty: 3 },
        { text: 'Draw, paint, write, or make something creative for 30 minutes', type: 'action', difficulty: 3 },
        { text: 'Play a video game, board game, or card game for 30 minutes', type: 'action', difficulty: 3 },
        { text: 'Do something fun with zero productive purpose for 30 minutes', type: 'action', difficulty: 3 },
      ],
      spirituality: [
        // Easy - Action
        { text: 'Take 5 deep breaths and center yourself', type: 'action', difficulty: 1 },
        { text: 'Step outside and notice something beautiful', type: 'action', difficulty: 1 },
        // Easy - Reflective
        { text: 'Write down 3 things you\'re grateful for', type: 'reflective', difficulty: 1 },
        { text: 'Name one thing that gives your life meaning today', type: 'reflective', difficulty: 1 },
        { text: 'Pause and ask yourself: what do I need right now?', type: 'reflective', difficulty: 1 },
        // Hard - Action
        { text: 'Meditate or sit in stillness for 20+ minutes', type: 'action', difficulty: 3 },
        { text: 'Spend 30 minutes in nature without your phone', type: 'action', difficulty: 3 },
        // Hard - Reflective
        { text: 'Journal about what gives your life meaning', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on your values and whether you\'re living by them', type: 'reflective', difficulty: 3 },
        { text: 'Write about a difficult experience and what it taught you', type: 'reflective', difficulty: 3 },
      ],
      community: [
        // Easy - Action
        { text: 'Hold the door, smile at a stranger, or give a genuine compliment', type: 'action', difficulty: 1 },
        { text: 'Share or repost a cause you care about on social media', type: 'action', difficulty: 1 },
        { text: 'Leave a positive review for a local business you like', type: 'action', difficulty: 1 },
        // Easy - Reflective
        { text: 'Write down one way you could contribute to your community', type: 'reflective', difficulty: 1 },
        // Hard - Action
        { text: 'Volunteer your time for a cause you care about', type: 'action', difficulty: 3 },
        { text: 'Attend a community event or meeting', type: 'action', difficulty: 3 },
        { text: 'Donate to or support a local organization', type: 'action', difficulty: 3 },
        // Hard - Reflective
        { text: 'Research a local cause and write down how you could help', type: 'reflective', difficulty: 3 },
      ],
      health: [
        // Easy - Action (100% action)
        { text: 'Drink a full glass of water', type: 'action', difficulty: 1 },
        { text: 'Stretch for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Do 10 jumping jacks, squats, or pushups', type: 'action', difficulty: 1 },
        { text: 'Eat a piece of fruit or a vegetable', type: 'action', difficulty: 1 },
        // Hard - Action
        { text: 'Exercise for 30 minutes', type: 'action', difficulty: 3 },
        { text: 'Prepare a healthy meal from scratch', type: 'action', difficulty: 3 },
        { text: 'Go for a 30-minute walk or run', type: 'action', difficulty: 3 },
        { text: 'Do a full stretching or yoga session', type: 'action', difficulty: 3 },
      ],
      finances: [
        // Easy - Action
        { text: 'Check your bank balance and note any surprises', type: 'action', difficulty: 1 },
        { text: 'Unsubscribe from one thing you don\'t use', type: 'action', difficulty: 1 },
        { text: 'Add one expense to a tracker or budget', type: 'action', difficulty: 1 },
        // Easy - Reflective
        { text: 'Write down one financial goal for this month', type: 'reflective', difficulty: 1 },
        { text: 'Reflect on one recent purchase - was it worth it?', type: 'reflective', difficulty: 1 },
        // Hard - Action
        { text: 'Review and organize your budget for the month', type: 'action', difficulty: 3 },
        { text: 'Research one way to save money or grow wealth', type: 'action', difficulty: 3 },
        { text: 'Set up or review an automatic savings transfer', type: 'action', difficulty: 3 },
        // Hard - Reflective
        { text: 'Journal about your relationship with money and one shift you want to make', type: 'reflective', difficulty: 3 },
      ],
      mentalHealth: [
        // Easy - Action
        { text: 'Step away from screens for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Take 5 slow, deep breaths', type: 'action', difficulty: 1 },
        // Easy - Reflective
        { text: 'Name your current emotion without judgment', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing that\'s weighing on you', type: 'reflective', difficulty: 1 },
        { text: 'Ask yourself: what do I need right now?', type: 'reflective', difficulty: 1 },
        // Hard - Action
        { text: 'Take a bath, nap, or do another restorative activity for 30 minutes', type: 'action', difficulty: 3 },
        { text: 'Set one boundary or say no to one thing that\'s draining you', type: 'action', difficulty: 3 },
        // Hard - Reflective
        { text: 'Journal about how you\'re really feeling', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on your stress levels and write down one way to reduce them', type: 'reflective', difficulty: 3 },
        { text: 'Write a compassionate letter to yourself about something you\'re struggling with', type: 'reflective', difficulty: 3 },
      ],
    };

    // ============ TEND PERSONALIZATION SYSTEM ============
    
    // Context keywords that are relevant to each life area
    const DOMAIN_CONTEXT_KEYWORDS = {
      family: ['family', 'parent', 'sibling', 'mom', 'dad', 'brother', 'sister', 'kids', 'children'],
      partner: ['partner', 'spouse', 'husband', 'wife', 'girlfriend', 'boyfriend', 'relationship', 'married'],
      friendships: ['friend', 'social', 'friends'],
      career: ['work', 'job', 'career', 'office', 'remote', 'project', 'professional'],
      education: ['learn', 'study', 'course', 'school', 'skill', 'read'],
      recreation: ['hobby', 'fun', 'game', 'play', 'creative', 'music', 'art', 'sport'],
      spirituality: ['meditation', 'spiritual', 'faith', 'mindful', 'religion', 'practice'],
      community: ['volunteer', 'community', 'local', 'neighborhood', 'civic'],
      health: ['gym', 'exercise', 'fitness', 'workout', 'yoga', 'run', 'health', 'diet'],
      finances: ['budget', 'money', 'savings', 'invest', 'financial'],
      mentalHealth: ['therapy', 'mental', 'stress', 'anxiety', 'self-care', 'boundaries'],
    };
    
    // Calculate personalization readiness for a specific life area
    function calculateDomainReadiness(domain, userProfile) {
      const prefs = userProfile?.tendPreferences || {};
      const keywords = DOMAIN_CONTEXT_KEYWORDS[domain] || [];
      
      const capabilities = [];
      const missing = [];
      
      // Check 1: Life area specific notes (most valuable - 2 points)
      const hasLifeAreaNotes = !!prefs.lifeAreaNotes?.[domain];
      if (hasLifeAreaNotes) {
        capabilities.push({
          type: 'notes',
          label: `Has ${VLQ_DOMAINS[domain]?.name} notes`,
          detail: prefs.lifeAreaNotes[domain].substring(0, 50) + (prefs.lifeAreaNotes[domain].length > 50 ? '...' : ''),
          points: 2
        });
      } else {
        missing.push({
          type: 'notes',
          label: `Share details about ${VLQ_DOMAINS[domain]?.name.toLowerCase()}`,
          example: domain === 'family' ? "e.g., 'My mom is Sarah, we talk weekly'" : 
                   domain === 'career' ? "e.g., 'I work from home as a developer'" :
                   domain === 'health' ? "e.g., 'I have a gym membership'" :
                   `Share specific details about your ${VLQ_DOMAINS[domain]?.name.toLowerCase()}`
        });
      }
      
      // Check 1b: Structured profile info (2 points if has any filled fields)
      const structuredInfo = prefs.structuredInfo?.[domain] || {};
      const filledStructured = Object.entries(structuredInfo).filter(([_, v]) => v);
      if (filledStructured.length > 0) {
        capabilities.push({
          type: 'structured',
          label: 'Profile details',
          detail: filledStructured.map(([k, v]) => v).slice(0, 2).join(', ').substring(0, 60),
          points: Math.min(filledStructured.length, 2)
        });
      }
      
      // Check 2: Relevant context items (1 point each, max 2)
      const relevantContext = Object.entries(prefs.context || {})
        .filter(([key, value]) => value && keywords.some(kw => key.toLowerCase().includes(kw)))
        .map(([key]) => key.replace(/_/g, ' '));
      
      if (relevantContext.length > 0) {
        capabilities.push({
          type: 'context',
          label: 'Relevant context',
          detail: relevantContext.slice(0, 3).join(', '),
          points: Math.min(relevantContext.length, 2)
        });
      }
      
      // Check 3: Relevant resources (1 point each, max 2)
      const relevantResources = (prefs.resources || [])
        .filter(r => keywords.some(kw => r.toLowerCase().includes(kw)));
      
      if (relevantResources.length > 0) {
        capabilities.push({
          type: 'resources',
          label: 'Has resources',
          detail: relevantResources.slice(0, 3).join(', '),
          points: Math.min(relevantResources.length, 2)
        });
      }
      
      // Check 4: Relevant preferences (1 point)
      const relevantPreferences = (prefs.preferences || [])
        .filter(p => keywords.some(kw => p.toLowerCase().includes(kw)));
      
      if (relevantPreferences.length > 0) {
        capabilities.push({
          type: 'preferences',
          label: 'Has preferences',
          detail: relevantPreferences.slice(0, 2).join(', '),
          points: 1
        });
      }
      
      // Calculate total score (max 9 points per domain)
      const score = capabilities.reduce((sum, c) => sum + c.points, 0);
      const maxScore = 9;
      
      // Determine readiness level
      let level, color, aiRatio;
      if (score >= 6) {
        level = 'Rich';
        color = '#8FD4A0';
        aiRatio = 0.7; // 70% AI generation
      } else if (score >= 4) {
        level = 'Good';
        color = '#7EB3E0';
        aiRatio = 0.5; // 50% AI generation
      } else if (score >= 2) {
        level = 'Some';
        color = '#F9D07A';
        aiRatio = 0.2; // 20% AI generation
      } else {
        level = 'None';
        color = '#E8A090';
        aiRatio = 0; // 0% AI generation - pool only
      }
      
      return {
        domain,
        domainName: VLQ_DOMAINS[domain]?.name,
        score,
        maxScore,
        percentage: Math.round((score / maxScore) * 100),
        level,
        color,
        aiRatio,
        capabilities,
        missing,
        canPersonalize: score >= 1,
        canGenerateAI: score >= 3
      };
    }
    
    // Calculate readiness for all domains
    function calculateAllDomainReadiness(userProfile) {
      const readiness = {};
      VLQ_ORDER.forEach(domain => {
        readiness[domain] = calculateDomainReadiness(domain, userProfile);
      });
      return readiness;
    }
    
    // Get overall personalization summary
    function getPersonalizationSummary(userProfile) {
      const allReadiness = calculateAllDomainReadiness(userProfile);
      const domains = Object.values(allReadiness);
      
      const richCount = domains.filter(d => d.level === 'Rich').length;
      const goodCount = domains.filter(d => d.level === 'Good').length;
      const someCount = domains.filter(d => d.level === 'Some').length;
      const noneCount = domains.filter(d => d.level === 'None').length;
      
      const avgScore = domains.reduce((sum, d) => sum + d.score, 0) / domains.length;
      
      return {
        allReadiness,
        richCount,
        goodCount,
        someCount,
        noneCount,
        avgScore: Math.round(avgScore * 10) / 10,
        totalDomains: domains.length,
        personalizedDomains: domains.filter(d => d.canPersonalize).length
      };
    }

    // Personalize a template using AI (only if domain has context)
    async function personalizeTemplate(templateText, userProfile, domain, apiKey) {
      const prefs = userProfile?.tendPreferences || {};
      
      // If no preferences or no API key, return original
      if (!apiKey || Object.keys(prefs).length === 0) {
        return templateText;
      }
      
      // Build context string
      const contextParts = [];
      
      // Add gardener type for tone/style guidance
      if (prefs.gardenerType) {
        contextParts.push(`Gardener type: ${prefs.gardenerType.name} - ${prefs.gardenerType.strength}`);
      }
      
      if (prefs.resources?.length) contextParts.push(`Has: ${prefs.resources.join(', ')}`);
      if (prefs.context) {
        Object.entries(prefs.context).forEach(([k, v]) => {
          if (v) contextParts.push(k.replace(/_/g, ' '));
        });
      }
      if (prefs.lifeAreaNotes?.[domain]) contextParts.push(`${domain} notes: ${prefs.lifeAreaNotes[domain]}`);
      
      // Add structured profile info for this domain
      const structuredInfo = prefs.structuredInfo?.[domain] || {};
      Object.entries(structuredInfo).forEach(([key, value]) => {
        if (value) contextParts.push(`${key}: ${value}`);
      });
      
      if (contextParts.length === 0) return templateText;
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 60,
            system: `Personalize this wellness task for the user. Keep it under 15 words. If you can't meaningfully personalize it, return EXACTLY the original text with no changes.

User context: ${contextParts.join('. ')}`,
            messages: [{ role: 'user', content: `Task: "${templateText}"` }]
          })
        });
        
        const data = await response.json();
        const result = data.content?.[0]?.text?.trim();
        
        // Only use if reasonable length and actually different
        if (result && result.length < 80 && result.length > 5) {
          return result;
        }
        return templateText;
      } catch (error) {
        console.error('Personalization error:', error);
        return templateText;
      }
    }

    // Generate a completely fresh AI tend
    async function generateFreshAITend(domain, difficulty, type, userProfile, apiKey) {
      const prefs = userProfile?.tendPreferences || {};
      const domainInfo = VLQ_DOMAINS[domain];
      const timeLabel = difficulty === 1 ? '5 minutes' : '30 minutes';
      
      // Build rich context
      const contextParts = [];
      
      // Add gardener type for personalized tone and approach
      if (prefs.gardenerType) {
        contextParts.push(`User's gardener type: "${prefs.gardenerType.name}" - ${prefs.gardenerType.description}`);
        contextParts.push(`Their superpower: ${prefs.gardenerType.strength}`);
      }
      
      if (prefs.resources?.length) contextParts.push(`User has: ${prefs.resources.join(', ')}`);
      if (prefs.context) {
        Object.entries(prefs.context).forEach(([k, v]) => {
          if (v) contextParts.push(`User ${k.replace(/_/g, ' ')}`);
        });
      }
      if (prefs.preferences?.length) contextParts.push(`Prefers: ${prefs.preferences.join(', ')}`);
      if (prefs.lifeAreaNotes?.[domain]) contextParts.push(`Notes about ${domainInfo.name}: ${prefs.lifeAreaNotes[domain]}`);
      
      // Add structured profile info for this domain
      const structuredInfo = prefs.structuredInfo?.[domain] || {};
      Object.entries(structuredInfo).forEach(([key, value]) => {
        if (value) contextParts.push(`${key}: ${value}`);
      });
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 60,
            system: `Create a personalized ${timeLabel} wellness task for ${domainInfo.name}.

Requirements:
- ${type === 'action' ? 'Action-oriented (doing something concrete)' : 'Reflective (journaling, thinking, introspection)'}
- Specific and actionable, not vague
- Completable in exactly ${timeLabel}
- Personal to this user based on their context
- Match their personality style if gardener type is provided
- Warm and encouraging, not preachy
- Under 15 words

${contextParts.length > 0 ? `User context: ${contextParts.join('. ')}` : ''}

Respond with ONLY the task text, nothing else.`,
            messages: [{ role: 'user', content: 'Generate the task.' }]
          })
        });
        
        const data = await response.json();
        const text = data.content?.[0]?.text?.trim();
        
        if (text && text.length < 80 && text.length > 10) {
          return text;
        }
        return null;
      } catch (error) {
        console.error('Fresh AI tend error:', error);
        return null;
      }
    }

    // Probability calculation for domain selection
    function calculateDomainProbabilities(vlqScores) {
      const epsilon = 0.01; // Minimum probability floor
      const minImportance = 3; // Never select domains below this importance
      const weights = {};
      let totalWeight = 0;

      VLQ_ORDER.forEach(domain => {
        const scores = vlqScores[domain];
        const importance = scores?.importance || 5;
        
        // Skip domains below minimum importance threshold
        if (importance < minImportance) {
          weights[domain] = 0;
          return;
        }
        
        const consistency = scores?.consistency || 5;
        const gap = Math.max(0, importance - consistency);
        
        // Formula: base weight from importance, STRONGLY boosted by gap
        // Gap of 0 = 1x multiplier, Gap of 5 = 2x, Gap of 10 = 3x
        const gapMultiplier = 1 + (gap / 5);
        const weight = importance * gapMultiplier + epsilon;
        
        weights[domain] = weight;
        totalWeight += weight;
      });

      // Normalize to probabilities
      const probabilities = {};
      VLQ_ORDER.forEach(domain => {
        probabilities[domain] = totalWeight > 0 ? weights[domain] / totalWeight : 0;
      });
      
      // Log probabilities for debugging
      console.log('Domain probabilities:', Object.entries(probabilities)
        .filter(([_, p]) => p > 0)
        .sort((a, b) => b[1] - a[1])
        .map(([d, p]) => `${d}: ${(p * 100).toFixed(1)}%`)
        .join(', ')
      );

      return probabilities;
    }

    // Select a domain based on weighted probabilities
    function selectWeightedDomain(probabilities, exclude = [], penaltyWeights = {}) {
      // Filter out excluded domains AND domains below importance threshold (probability = 0)
      const availableDomains = VLQ_ORDER.filter(d => 
        !exclude.includes(d) && probabilities[d] > 0
      );
      
      if (availableDomains.length === 0) {
        // Fallback: pick any domain with non-zero probability
        const nonZeroDomains = VLQ_ORDER.filter(d => probabilities[d] > 0);
        if (nonZeroDomains.length === 0) return VLQ_ORDER[0]; // Ultimate fallback
        return nonZeroDomains[Math.floor(Math.random() * nonZeroDomains.length)];
      }

      // Apply soft recency penalties to probabilities
      const adjustedProbs = {};
      availableDomains.forEach(d => {
        const penalty = penaltyWeights[d] || 1.0;
        adjustedProbs[d] = probabilities[d] * penalty;
      });

      // Recalculate probabilities for available domains
      let totalProb = 0;
      availableDomains.forEach(d => totalProb += adjustedProbs[d]);
      
      const rand = Math.random() * totalProb;
      let cumulative = 0;
      
      for (const domain of availableDomains) {
        cumulative += adjustedProbs[domain];
        if (rand <= cumulative) return domain;
      }
      
      return availableDomains[availableDomains.length - 1];
    }

    // Generate today's tendies (3 options with different difficulties)
    // Helper function to get local date string (YYYY-MM-DD)
    function getLocalDateString(date = new Date()) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    function generateDailyTendies(vlqScores, tendyHistory = [], previousShownDomain = null) {
      const probabilities = calculateDomainProbabilities(vlqScores);
      const today = getLocalDateString();
      
      // GUARDRAIL 1: No same domain two days in a row
      // Check both completed tendies from yesterday AND the previously shown domain
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = getLocalDateString(yesterday);
      const yesterdayCompletedDomains = tendyHistory
        .filter(t => t.date === yesterdayStr)
        .map(t => t.domain);
      
      // Combine completed domains with the previously shown domain (if provided)
      const domainsToAvoid = [...yesterdayCompletedDomains];
      if (previousShownDomain && !domainsToAvoid.includes(previousShownDomain)) {
        domainsToAvoid.push(previousShownDomain);
      }
      
      console.log('Domain guardrail - avoiding:', domainsToAvoid);
      
      // GUARDRAIL 2: Soft recency penalty for recently-selected domains (last 7 days)
      const recentDomainCounts = {};
      VLQ_ORDER.forEach(d => recentDomainCounts[d] = 0);
      
      tendyHistory
        .filter(t => {
          const daysDiff = (new Date(today) - new Date(t.date)) / (1000 * 60 * 60 * 24);
          return daysDiff > 0 && daysDiff <= 7;
        })
        .forEach(t => {
          if (t.domain) recentDomainCounts[t.domain]++;
        });
      
      // Also penalize the previously shown domain even if not completed
      if (previousShownDomain) {
        recentDomainCounts[previousShownDomain] = (recentDomainCounts[previousShownDomain] || 0) + 1;
      }
      
      // Apply soft penalty: reduce probability by 20% per recent appearance
      const penaltyWeights = {};
      VLQ_ORDER.forEach(d => {
        penaltyWeights[d] = Math.pow(0.8, recentDomainCounts[d]);
      });

      // Select ONE domain for the entire day
      const todaysDomain = selectWeightedDomain(probabilities, domainsToAvoid, penaltyWeights);
      
      console.log('Selected domain for today:', todaysDomain);

      // Get type weights for this domain
      const typeWeights = TYPE_WEIGHTS[todaysDomain] || { action: 0.5, reflective: 0.5 };
      
      // Select type based on weights
      const selectType = () => {
        return Math.random() < typeWeights.action ? 'action' : 'reflective';
      };

      const tendies = [];
      const difficulties = [1, 3]; // Easy (5 min) and Hard (30 min) only

      // Get recent templates with different cooldowns per difficulty
      const recentEasyTemplates = tendyHistory
        .filter(t => {
          const daysDiff = (new Date(today) - new Date(t.date)) / (1000 * 60 * 60 * 24);
          return daysDiff < 7 && t.difficulty === 1; // 7-day cooldown for easy
        })
        .map(t => t.templateText || t.text);
      
      const recentHardTemplates = tendyHistory
        .filter(t => {
          const daysDiff = (new Date(today) - new Date(t.date)) / (1000 * 60 * 60 * 24);
          return daysDiff < 30 && t.difficulty === 3; // 30-day cooldown for hard
        })
        .map(t => t.templateText || t.text);

      difficulties.forEach(difficulty => {
        const recentTemplates = difficulty === 1 ? recentEasyTemplates : recentHardTemplates;
        const selectedType = selectType();
        
        // Get templates for this difficulty and type (not recently used)
        let templates = TENDY_TEMPLATES[todaysDomain].filter(t => 
          t.difficulty === difficulty && 
          t.type === selectedType && 
          !recentTemplates.includes(t.text)
        );

        // Fallback 1: any template of this difficulty and type (even if recently used)
        if (templates.length === 0) {
          templates = TENDY_TEMPLATES[todaysDomain].filter(t => 
            t.difficulty === difficulty && t.type === selectedType
          );
        }
        
        // Fallback 2: any template of this difficulty (any type)
        if (templates.length === 0) {
          templates = TENDY_TEMPLATES[todaysDomain].filter(t => 
            t.difficulty === difficulty && !recentTemplates.includes(t.text)
          );
        }
        
        // Fallback 3: any template of this difficulty
        if (templates.length === 0) {
          templates = TENDY_TEMPLATES[todaysDomain].filter(t => t.difficulty === difficulty);
        }

        if (templates.length > 0) {
          const template = templates[Math.floor(Math.random() * templates.length)];
          tendies.push({
            id: `${today}-${difficulty}`,
            domain: todaysDomain,
            text: template.text,
            originalText: template.text, // Keep original for cooldown tracking
            type: template.type,
            difficulty,
            points: difficulty, // 1 or 3 points
            gardenElement: GARDEN_ELEMENTS[todaysDomain],
            color: VLQ_DOMAINS[todaysDomain].color,
            domainName: VLQ_DOMAINS[todaysDomain].name,
            domainIcon: VLQ_DOMAINS[todaysDomain].icon,
            date: today,
            generatedAt: new Date().toISOString(),
            completed: false,
            selected: false,
            templateText: template.text,
            isPersonalized: false,
            isAIGenerated: false,
            source: 'pool', // 'pool', 'pool-personalized', 'ai-generated'
          });
        }
      });

      return tendies;
    }

    // Async version that personalizes or generates fresh AI tends
    // Uses PER-DOMAIN readiness, not global score
    async function generatePersonalizedTendies(vlqScores, tendyHistory, previousShownDomain, userProfile, apiKey) {
      // First generate base tendies from pool
      const baseTendies = generateDailyTendies(vlqScores, tendyHistory, previousShownDomain);
      
      if (!apiKey || baseTendies.length === 0) {
        return baseTendies;
      }
      
      // Get the domain for today's tendies (they all share the same domain)
      const todaysDomain = baseTendies[0]?.domain;
      if (!todaysDomain) return baseTendies;
      
      // Calculate readiness for THIS SPECIFIC domain
      const domainReadiness = calculateDomainReadiness(todaysDomain, userProfile);
      
      console.log(`Tend personalization for ${domainReadiness.domainName}:`, {
        score: `${domainReadiness.score}/${domainReadiness.maxScore}`,
        level: domainReadiness.level,
        aiRatio: `${(domainReadiness.aiRatio * 100).toFixed(0)}%`,
        capabilities: domainReadiness.capabilities.map(c => c.label)
      });
      
      // If no context for this domain at all, just return pool templates as-is
      if (!domainReadiness.canPersonalize) {
        console.log(`No ${domainReadiness.domainName} context - using pool templates only`);
        return baseTendies.map(t => ({
          ...t,
          personalizationNote: `No ${domainReadiness.domainName.toLowerCase()} info yet - share details via tend chat!`
        }));
      }
      
      // Process each tendy using THIS DOMAIN's AI ratio
      const enhancedTendies = await Promise.all(baseTendies.map(async (tendy) => {
        const roll = Math.random();
        
        // Only try AI generation if domain has enough context
        if (domainReadiness.canGenerateAI && roll < domainReadiness.aiRatio) {
          console.log(`Rolling AI generation for ${tendy.difficulty === 1 ? '5min' : '30min'} (roll: ${roll.toFixed(2)} < ${domainReadiness.aiRatio})`);
          const freshText = await generateFreshAITend(
            tendy.domain, 
            tendy.difficulty, 
            tendy.type, 
            userProfile, 
            apiKey
          );
          
          if (freshText) {
            return {
              ...tendy,
              text: freshText,
              isAIGenerated: true,
              isPersonalized: true,
              source: 'ai-generated',
              domainReadiness: domainReadiness.level,
            };
          }
        }
        
        // Try to personalize the pool template (if we have at least some context)
        if (domainReadiness.canPersonalize) {
          console.log(`Personalizing pool template for ${tendy.difficulty === 1 ? '5min' : '30min'}`);
          const personalizedText = await personalizeTemplate(tendy.originalText, userProfile, tendy.domain, apiKey);
          
          const wasPersonalized = personalizedText !== tendy.originalText;
          return {
            ...tendy,
            text: personalizedText,
            isPersonalized: wasPersonalized,
            source: wasPersonalized ? 'pool-personalized' : 'pool',
            domainReadiness: domainReadiness.level,
          };
        }
        
        // No personalization possible
        return {
          ...tendy,
          source: 'pool',
          domainReadiness: domainReadiness.level,
        };
      }));
      
      return enhancedTendies;
    }

    const VALUE_KEYWORDS = {
      'Freedom': ['freedom', 'free', 'autonomy', 'independent', 'flexible'],
      'Connection': ['connection', 'connected', 'together', 'relationship', 'partner', 'love', 'present', 'presence'],
      'Growth': ['growth', 'grow', 'learn', 'improve', 'better', 'develop'],
      'Peace': ['peace', 'calm', 'peaceful', 'stress', 'less stressed', 'relaxed', 'balance'],
      'Health': ['health', 'healthy', 'fit', 'strong', 'energy', 'wellness'],
      'Adventure': ['adventure', 'travel', 'explore', 'new', 'exciting', 'experience'],
      'Creativity': ['creative', 'creativity', 'create', 'art', 'make', 'build'],
      'Family': ['family', 'kids', 'children', 'parents', 'home'],
      'Joy': ['joy', 'happy', 'happiness', 'fun', 'laugh', 'enjoy'],
      'Security': ['security', 'secure', 'stable', 'stability', 'safe'],
    };

    const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const MONTH_FULL = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    const PHASES = { EXPLORE: 'explore', GROUND: 'ground', REVEAL: 'reveal', PLAN: 'plan' };
    const CENTER_VIEWS = { YEAR: 'year', SEASONS: 'seasons', MONTHLY: 'monthly', WEEKLY: 'weekly', DAILY: 'daily' };
    
    // Onboarding steps configuration
    const ONBOARDING_STEPS = {
      0: { id: 'vlq', label: 'Values', icon: 'ðŸ’š', required: true },
      1: { id: 'goals', label: 'Goals', icon: 'ðŸŽ¯', required: true },
      2: { id: 'habits', label: 'Habits', icon: 'ðŸ”„', required: true },
      3: { id: 'events', label: 'Events', icon: 'ðŸ“…', required: false },
      4: { id: 'quiz', label: 'Quiz', icon: 'ðŸŒ¸', required: false },
      5: { id: 'lifemap', label: 'Life Map', icon: 'ðŸ—ºï¸', required: true },
      6: { id: 'compass', label: 'Compass', icon: 'ðŸ§­', required: true },
      7: { id: 'tend', label: 'First Tend', icon: 'ðŸŒ±', required: true },
    };

    // ============ MAIN APP ============
    // ============ VLQ ASSESSMENT ============
    function VLQAssessment({ vlqScores, setVlqScores, vlqStep, setVlqStep, onComplete }) {
      
      // Calculate gaps for summary
      const getGaps = () => {
        return VLQ_ORDER.map(key => ({
          key,
          name: VLQ_DOMAINS[key].name,
          icon: VLQ_DOMAINS[key].icon,
          color: VLQ_DOMAINS[key].color,
          importance: vlqScores[key]?.importance || 5,
          consistency: vlqScores[key]?.consistency || 5,
          gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)
        })).sort((a, b) => b.gap - a.gap);
      };

      const vlqStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        card: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '24px',
          padding: '2.5rem',
          maxWidth: '700px',
          width: '100%',
          boxShadow: '0 4px 24px rgba(0,0,0,0.06)',
          border: '1px solid var(--border)',
        },
        header: {
          textAlign: 'center',
          marginBottom: '2rem',
        },
        stepIndicator: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
          textTransform: 'uppercase',
          letterSpacing: '0.1em',
          marginBottom: '0.5rem',
        },
        title: {
          fontSize: '1.5rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          fontSize: '0.9rem',
          color: 'var(--text-muted)',
          lineHeight: 1.5,
        },
        valuesGrid: {
          display: 'flex',
          flexDirection: 'column',
          gap: '0.75rem',
          marginBottom: '2rem',
        },
        valueRow: {
          display: 'grid',
          gridTemplateColumns: '140px 1fr 40px',
          alignItems: 'center',
          gap: '1rem',
          padding: '0.75rem 1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
        },
        valueInfo: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        valueIcon: {
          fontSize: '1.1rem',
        },
        valueName: {
          fontSize: '0.85rem',
          color: 'var(--text)',
          fontWeight: 500,
        },
        slider: {
          width: '100%',
          height: '6px',
          borderRadius: '3px',
          appearance: 'none',
          background: 'var(--border)',
          outline: 'none',
          cursor: 'pointer',
        },
        valueScore: {
          fontSize: '1.1rem',
          fontWeight: 600,
          textAlign: 'center',
          fontFamily: "'Fraunces', serif",
        },
        buttons: {
          display: 'flex',
          gap: '1rem',
          justifyContent: 'center',
        },
        backButton: {
          padding: '0.875rem 2rem',
          backgroundColor: 'transparent',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          color: 'var(--text-muted)',
          fontSize: '0.95rem',
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
        nextButton: {
          padding: '0.875rem 2.5rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '0.95rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
        hint: {
          textAlign: 'center',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
          marginBottom: '1.5rem',
          fontStyle: 'italic',
        },
        // Summary styles
        summarySection: {
          marginBottom: '1.5rem',
        },
        summarySectionTitle: {
          fontSize: '0.75rem',
          fontWeight: 600,
          textTransform: 'uppercase',
          letterSpacing: '0.1em',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
        },
        summaryItem: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.75rem',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '10px',
          marginBottom: '0.5rem',
        },
        summaryItemIcon: {
          fontSize: '1.25rem',
        },
        summaryItemName: {
          flex: 1,
          fontSize: '0.9rem',
          color: 'var(--text)',
        },
        summaryItemScores: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          fontSize: '0.85rem',
        },
        summaryItemGap: {
          fontSize: '0.75rem',
          padding: '0.2rem 0.5rem',
          borderRadius: '8px',
          fontWeight: 500,
        },
        intro: {
          textAlign: 'center',
        },
        introTitle: {
          fontSize: '2rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '1rem',
        },
        introText: {
          fontSize: '1rem',
          color: 'var(--text-muted)',
          lineHeight: 1.7,
          marginBottom: '2rem',
        },
        startButton: {
          padding: '1rem 3rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
      };

      const handleImportanceChange = (key, value) => {
        setVlqScores(prev => ({
          ...prev,
          [key]: { ...prev[key], importance: value }
        }));
      };

      const handleConsistencyChange = (key, value) => {
        setVlqScores(prev => ({
          ...prev,
          [key]: { ...prev[key], consistency: value }
        }));
      };

      // Intro screen
      if (vlqStep === -1) {
        return (
          <div style={vlqStyles.container}>
            <div style={{...vlqStyles.card, ...vlqStyles.intro, maxWidth: '500px'}}>
              <svg width="80" height="80" viewBox="0 0 80 80" fill="none" style={{marginBottom: '1.5rem', opacity: 0.8}}>
                <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="1.5" strokeLinecap="round"/>
                <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <circle cx="40" cy="70" r="3" fill="none" stroke="var(--accent)" strokeWidth="1.5"/>
              </svg>
              <h1 style={vlqStyles.introTitle}>Welcome to Tend</h1>
              <p style={{...vlqStyles.introText, marginBottom: '1.5rem'}}>
                Tend helps you design a life aligned with your values â€” not just survive, but live intentionally and mindfully.
              </p>
              <p style={vlqStyles.introText}>
                To get started, you'll reflect on <strong>10 areas of life</strong>. For each one, you'll rate:
                <br /><br />
                <em>How important is this to you?</em>
                <br />
                <em>How consistently have you been living it?</em>
                <br /><br />
                Think deeply, but don't worry about perfection â€” you can reassess your values anytime.
              </p>
              <button style={vlqStyles.startButton} onClick={() => setVlqStep(0)}>
                Let's Begin
              </button>
            </div>
          </div>
        );
      }

      // Step 0: Importance ratings for all values
      if (vlqStep === 0) {
        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <div style={vlqStyles.stepIndicator}>Step 1 of 2</div>
                <h2 style={vlqStyles.title}>How important is each area to you?</h2>
                <p style={vlqStyles.subtitle}>
                  Rate each value from 1 (not important) to 10 (extremely important).
                </p>
              </div>
              
              <p style={vlqStyles.hint}>
                Not everything can be a 10 â€” what truly matters most?
              </p>

              <div style={vlqStyles.valuesGrid}>
                {VLQ_ORDER.map(key => {
                  const domain = VLQ_DOMAINS[key];
                  const score = vlqScores[key]?.importance || 5;
                  return (
                    <div key={key} style={vlqStyles.valueRow}>
                      <div style={vlqStyles.valueInfo}>
                        <span style={vlqStyles.valueIcon}>{domain.icon}</span>
                        <span style={vlqStyles.valueName}>{domain.name}</span>
                      </div>
                      <input
                        type="range"
                        min="1"
                        max="10"
                        value={score}
                        onChange={(e) => handleImportanceChange(key, parseInt(e.target.value))}
                        style={{...vlqStyles.slider, accentColor: domain.color}}
                      />
                      <span style={{...vlqStyles.valueScore, color: domain.color}}>
                        {score}
                      </span>
                    </div>
                  );
                })}
              </div>

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(-1)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={() => setVlqStep(1)}>
                  Next
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Step 1: Consistency ratings for all values
      if (vlqStep === 1) {
        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <div style={vlqStyles.stepIndicator}>Step 2 of 2</div>
                <h2 style={vlqStyles.title}>How much have you been living each value?</h2>
                <p style={vlqStyles.subtitle}>
                  Rate your actual behavior â€” not what you wish, but what you've actually been doing.
                </p>
              </div>
              
              <p style={vlqStyles.hint}>
                1 = not at all lately Â· 10 = it's a major part of my life right now
              </p>

              <div style={vlqStyles.valuesGrid}>
                {VLQ_ORDER.map(key => {
                  const domain = VLQ_DOMAINS[key];
                  const score = vlqScores[key]?.consistency || 5;
                  return (
                    <div key={key} style={vlqStyles.valueRow}>
                      <div style={vlqStyles.valueInfo}>
                        <span style={vlqStyles.valueIcon}>{domain.icon}</span>
                        <span style={vlqStyles.valueName}>{domain.name}</span>
                      </div>
                      <input
                        type="range"
                        min="1"
                        max="10"
                        value={score}
                        onChange={(e) => handleConsistencyChange(key, parseInt(e.target.value))}
                        style={{...vlqStyles.slider, accentColor: domain.color}}
                      />
                      <span style={{...vlqStyles.valueScore, color: domain.color}}>
                        {score}
                      </span>
                    </div>
                  );
                })}
              </div>

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(0)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={() => setVlqStep(2)}>
                  See Results
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Step 2: Summary screen
      if (vlqStep === 2) {
        const gaps = getGaps();
        const growthAreas = gaps.filter(g => g.gap >= 3);
        const strengths = gaps.filter(g => g.importance >= 7 && g.consistency >= 7);
        const lowerPriority = gaps.filter(g => g.importance <= 5);

        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <h2 style={vlqStyles.title}>Your Values Landscape</h2>
                <p style={vlqStyles.subtitle}>
                  Here's what you shared about what matters and where you are.
                </p>
              </div>

              {growthAreas.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>ðŸŒ± Growth Areas</h3>
                  <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem', fontStyle: 'italic'}}>
                    High importance, room to grow
                  </p>
                  {growthAreas.map(item => (
                    <div key={item.key} style={vlqStyles.summaryItem}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: item.color, fontWeight: 600}}>{item.importance}</span>
                        <span style={{color: 'var(--text-muted)', margin: '0 0.25rem'}}>|</span>
                        <span style={{color: 'var(--text-muted)'}}>{item.consistency}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {strengths.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>ðŸ’ª Strengths</h3>
                  <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem', fontStyle: 'italic'}}>
                    Important and you're living it
                  </p>
                  {strengths.map(item => (
                    <div key={item.key} style={vlqStyles.summaryItem}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: item.color, fontWeight: 600}}>{item.importance}</span>
                        <span style={{color: 'var(--text-muted)', margin: '0 0.25rem'}}>|</span>
                        <span style={{color: item.color, fontWeight: 600}}>{item.consistency}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {lowerPriority.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>âšª Lower Priority Right Now</h3>
                  {lowerPriority.slice(0, 3).map(item => (
                    <div key={item.key} style={{...vlqStyles.summaryItem, opacity: 0.7}}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: 'var(--text-muted)'}}>{item.importance}</span>
                        <span style={{color: 'var(--text-muted)', margin: '0 0.25rem'}}>|</span>
                        <span style={{color: 'var(--text-muted)'}}>{item.consistency}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(1)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={onComplete}>
                  Chat with Tend â†’
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    // ============ AUTH MODAL ============
    function AuthModal({ onSuccess }) {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isLogin) {
            await auth.signInWithEmailAndPassword(email, password);
          } else {
            await auth.createUserWithEmailAndPassword(email, password);
          }
          onSuccess();
        } catch (err) {
          console.error('Auth error:', err);
          if (err.code === 'auth/email-already-in-use') {
            setError('This email is already registered. Try logging in.');
          } else if (err.code === 'auth/invalid-email') {
            setError('Please enter a valid email address.');
          } else if (err.code === 'auth/weak-password') {
            setError('Password should be at least 6 characters.');
          } else if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
            setError('Invalid email or password.');
          } else {
            setError(err.message);
          }
        } finally {
          setLoading(false);
        }
      };

      const authStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        card: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '24px',
          padding: '3rem',
          maxWidth: '400px',
          width: '100%',
          boxShadow: '0 4px 24px rgba(0,0,0,0.06)',
          border: '1px solid var(--border)',
          textAlign: 'center',
        },
        title: {
          fontSize: '1.75rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          fontSize: '0.9rem',
          color: 'var(--text-muted)',
          marginBottom: '2rem',
        },
        form: {
          display: 'flex',
          flexDirection: 'column',
          gap: '1rem',
        },
        input: {
          padding: '0.875rem 1rem',
          border: '1px solid var(--border)',
          borderRadius: '10px',
          fontSize: '0.95rem',
          fontFamily: "'DM Sans', sans-serif",
          backgroundColor: 'var(--bg-elevated)',
          color: 'var(--text)',
          outline: 'none',
        },
        button: {
          padding: '1rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
          marginTop: '0.5rem',
        },
        toggle: {
          marginTop: '1.5rem',
          fontSize: '0.85rem',
          color: 'var(--text-muted)',
        },
        toggleLink: {
          color: 'var(--accent)',
          cursor: 'pointer',
          fontWeight: 500,
        },
        error: {
          color: '#d32f2f',
          fontSize: '0.85rem',
          marginTop: '0.5rem',
          padding: '0.5rem',
          backgroundColor: '#ffebee',
          borderRadius: '8px',
        },
      };

      return (
        <div style={authStyles.container}>
          <div style={authStyles.card}>
            <svg width="60" height="60" viewBox="0 0 80 80" fill="none" style={{marginBottom: '1rem', opacity: 0.8}}>
              <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="1.5" strokeLinecap="round"/>
              <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <circle cx="40" cy="70" r="3" fill="none" stroke="var(--accent)" strokeWidth="1.5"/>
            </svg>
            <h1 style={authStyles.title}>{isLogin ? 'Welcome back' : 'Create account'}</h1>
            <p style={authStyles.subtitle}>
              {isLogin ? 'Sign in to continue your journey' : 'Start designing your intentional life'}
            </p>

            <form style={authStyles.form} onSubmit={handleSubmit}>
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                style={authStyles.input}
                required
              />
              <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                style={authStyles.input}
                required
              />
              {error && <div style={authStyles.error}>{error}</div>}
              <button type="submit" style={authStyles.button} disabled={loading}>
                {loading ? 'Please wait...' : (isLogin ? 'Sign In' : 'Create Account')}
              </button>
            </form>

            <p style={authStyles.toggle}>
              {isLogin ? "Don't have an account? " : "Already have an account? "}
              <span style={authStyles.toggleLink} onClick={() => { setIsLogin(!isLogin); setError(''); }}>
                {isLogin ? 'Sign up' : 'Sign in'}
              </span>
            </p>
          </div>
        </div>
      );
    }

    function TendApp() {
      // Auth state
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [dataLoaded, setDataLoaded] = useState(false);
      const [sessionGreeted, setSessionGreeted] = useState(false);
      const [showLoadingIcon, setShowLoadingIcon] = useState(true);
      const [appMode, setAppMode] = useState(null); // null = choose, 'journal', 'plan'

      const [phase, setPhase] = useState(PHASES.EXPLORE);
      const [vlqScores, setVlqScores] = useState({
        family: { importance: null, consistency: null },
        partner: { importance: null, consistency: null },
        friendships: { importance: null, consistency: null },
        career: { importance: null, consistency: null },
        education: { importance: null, consistency: null },
        recreation: { importance: null, consistency: null },
        spirituality: { importance: null, consistency: null },
        community: { importance: null, consistency: null },
        health: { importance: null, consistency: null },
        mentalHealth: { importance: null, consistency: null },
      });
      const [vlqCompleted, setVlqCompleted] = useState(false);
      const [vlqStep, setVlqStep] = useState(-1); // -1 for intro, 0-9 for domains, 10 for summary
      const [values, setValues] = useState([]);
      const [lifeAreaRatings, setLifeAreaRatings] = useState({
        health: { satisfaction: null, intention: null },
        relationships: { satisfaction: null, intention: null },
        career: { satisfaction: null, intention: null },
        finances: { satisfaction: null, intention: null },
        growth: { satisfaction: null, intention: null },
        fun: { satisfaction: null, intention: null }
      });
      const [lifeAreasCompleted, setLifeAreasCompleted] = useState(false);
      const [lifeAreasMode, setLifeAreasMode] = useState(false);
      const [currentLifeAreaIndex, setCurrentLifeAreaIndex] = useState(0);
      const [waitingForSatisfaction, setWaitingForSatisfaction] = useState(true);
      const [isLastLifeAreaResponse, setIsLastLifeAreaResponse] = useState(false);
      const lifeAreaOrder = ['health', 'relationships', 'career', 'finances', 'growth', 'fun'];
      const lifeAreaDescriptions = {
        health: 'physical energy, movement, sleep, how your body feels',
        relationships: 'partner, family, friendships, feeling connected',
        career: 'work satisfaction, growth, meaning in what you do',
        finances: 'financial security, freedom, relationship with money',
        growth: 'learning, self-improvement, becoming who you want to be',
        fun: 'play, adventure, hobbies, things that bring you joy'
      };
      const [events, setEvents] = useState([]);
      const [goals, setGoals] = useState([]);
      const [notes, setNotes] = useState(''); // Planning notes in sidebar
      const [journalEntries, setJournalEntries] = useState({}); // Daily journal entries by date
      const [monthlyReviews, setMonthlyReviews] = useState({}); // Monthly reviews by month (YYYY-MM)
      const [yearlyReflections, setYearlyReflections] = useState({}); // Yearly reflections by year
      const [seasonIntentions, setSeasonIntentions] = useState({
        winter: '', spring: '', summer: '', fall: ''
      });
      const [yearTheme, setYearTheme] = useState('');
      
      // Onboarding system (1-7 steps, null = completed)
      // 1: Goals, 2: Weekly Habits, 3: Events (optional), 4: Gardener Quiz (optional), 
      // 5: Life Map, 6: Compass Word, 7: Daily Tend
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [onboardingCompleted, setOnboardingCompleted] = useState(false);
      
      const [weeklyHabits, setWeeklyHabits] = useState([]);
      const [dailyHabits, setDailyHabits] = useState([]);
      const [habitCompletions, setHabitCompletions] = useState({}); // { '2026-01-20': { daily: [id1, id2], weekly: [id3] } }
      
      // Tendy system state
      const [todaysTendies, setTodaysTendies] = useState([]);
      const [tendyHistory, setTendyHistory] = useState([]); // Completed tendies
      const [tendyPoints, setTendyPoints] = useState(0);
      const [tendyStreak, setTendyStreak] = useState(0);
      const [flexPoints, setFlexPoints] = useState(3); // For rerolling tendies
      const [flexPointsTracking, setFlexPointsTracking] = useState({
        lastJournalDate: null,
        lastWeeklyIntentionWeek: null,
        lastCustomTendyWeek: null,
        lastMondayBonusWeek: null,
        last7DayStreakDate: null,
        lastMonthlyReviewMonth: null,
        completedGoalIds: []
      });
      const [weeklyCustomTendy, setWeeklyCustomTendy] = useState(null); // { text, status: 'pending'|'approved'|'rejected', weekOf, submittedAt }
      
      // Knowledge & Intelligence Layer
      const [savedConversations, setSavedConversations] = useState({}); // Archive of important conversations
      const [currentConversationType, setCurrentConversationType] = useState('general'); // 'general' | 'monthly_review' | 'yearly_review' | 'onboarding'
      const [userProfile, setUserProfile] = useState({
        name: '',
        occupation: '',
        location: '',
        lifeStage: '',
        tendPreferences: {}
      });
      
      // Chat history system
      const [chatHistory, setChatHistory] = useState([]); // Array of past chats
      const [currentChatId, setCurrentChatId] = useState(null);
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isTyping, setIsTyping] = useState(false);
      const [exchangeCount, setExchangeCount] = useState(0);
      const [showChatHistory, setShowChatHistory] = useState(false);
      const messagesEndRef = useRef(null);
      const chatContainerRef = useRef(null);

      const [revealed, setRevealed] = useState(false);
      const [activeTab, setActiveTab] = useState('events');
      const [sidebarExpanded, setSidebarExpanded] = useState(false);
      const [sidebarWidth, setSidebarWidth] = useState(240);
      const [isResizingSidebar, setIsResizingSidebar] = useState(false);
      const [centerView, setCenterView] = useState(CENTER_VIEWS.YEAR);
      const [expandedEvent, setExpandedEvent] = useState(null);
      const [showEventModal, setShowEventModal] = useState(false);
      const [showGoalModal, setShowGoalModal] = useState(false);
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('tend_api_key') || '');
      const [chatWidth, setChatWidth] = useState(320);
      const [chatMinimized, setChatMinimized] = useState(false);
      const [isResizing, setIsResizing] = useState(false);
      const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
      const [showAdminDashboard, setShowAdminDashboard] = useState(() => {
        const params = new URLSearchParams(window.location.search);
        return params.get('admin') === 'true';
      });

      // Get "Focus on" life areas (gap >= 2)
      const getFocusAreas = () => {
        return VLQ_ORDER
          .map(key => ({
            key,
            importance: vlqScores[key]?.importance || 5,
            consistency: vlqScores[key]?.consistency || 5,
            gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)
          }))
          .filter(a => a.gap >= 2)
          .map(a => a.key);
      };

      // Check if onboarding step is complete
      const isStepComplete = (step) => {
        const focusAreas = getFocusAreas();
        
        switch(step) {
          case 0: // VLQ - always complete if they can see onboarding
            return vlqCompleted;
          case 1: // Goals - at least 3, with 1+ per focus area
            if (goals.length < 3) return false;
            for (const area of focusAreas) {
              if (!goals.some(g => g.lifeArea === area)) return false;
            }
            return true;
          case 2: // Weekly Habits - at least 3, with 1+ per focus area
            if (weeklyHabits.length < 3) return false;
            for (const area of focusAreas) {
              if (!weeklyHabits.some(h => h.lifeArea === area)) return false;
            }
            return true;
          case 3: // Events - optional, complete only if they added events
            return events.length > 0;
          case 4: // Gardener Quiz - optional, complete only if they took it
            return !!userProfile?.tendPreferences?.gardenerType;
          case 5: // Life Map - at least 1 prompt answered
            const prefs = userProfile?.tendPreferences || {};
            return !!(prefs.lifeAreaNotes && Object.values(prefs.lifeAreaNotes).some(v => v && v.trim()));
          case 6: // Compass Word - has yearTheme
            return !!yearTheme;
          case 7: // Daily Tend - has completed a tend (not just generated)
            return todaysTendies.some(t => t.completed);
          default:
            return false;
        }
      };

      // Get onboarding progress info for UI
      const getOnboardingProgress = () => {
        const focusAreas = getFocusAreas();
        return {
          0: { current: vlqCompleted ? 1 : 0, required: 1 },
          1: {
            current: goals.length,
            required: 3,
            focusAreasCovered: focusAreas.filter(a => goals.some(g => g.lifeArea === a)).length,
            focusAreasRequired: focusAreas.length
          },
          2: {
            current: weeklyHabits.length,
            required: 3,
            focusAreasCovered: focusAreas.filter(a => weeklyHabits.some(h => h.lifeArea === a)).length,
            focusAreasRequired: focusAreas.length
          },
          3: { current: events.length, required: 0 },
          4: { current: userProfile?.tendPreferences?.gardenerType ? 1 : 0, required: 0 },
          5: { 
            current: Object.values(userProfile?.tendPreferences?.lifeAreaNotes || {}).filter(v => v && v.trim()).length,
            required: 1 
          },
          6: { current: yearTheme ? 1 : 0, required: 1 },
          7: { current: todaysTendies.some(t => t.completed) ? 1 : 0, required: 1 },
        };
      };

      // Suggest a compass word based on user data
      const getSuggestedCompassWord = () => {
        const focusAreas = getFocusAreas();
        const topFocus = focusAreas[0];
        
        const wordSuggestions = {
          'family': 'connection',
          'partner': 'love',
          'friendships': 'community',
          'career': 'growth',
          'education': 'learning',
          'recreation': 'joy',
          'spirituality': 'presence',
          'community': 'service',
          'health': 'vitality',
          'mentalHealth': 'balance',
        };
        
        return wordSuggestions[topFocus] || 'intention';
      };

      // Auth state listener
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((firebaseUser) => {
          setUser(firebaseUser);
          setAuthLoading(false);
          if (firebaseUser) {
            // Load user data from Firestore
            loadUserData(firebaseUser.uid);
          }
        });
        return () => unsubscribe();
      }, []);

      // Show loading icon for at least 1.5 seconds
      useEffect(() => {
        const timer = setTimeout(() => {
          setShowLoadingIcon(false);
        }, 1500);
        return () => clearTimeout(timer);
      }, []);

      // Load user data from Firestore
      const loadUserData = async (userId) => {
        try {
          const doc = await db.collection('users').doc(userId).get();
          if (doc.exists) {
            const data = doc.data();
            if (data.vlqScores) setVlqScores(data.vlqScores);
            if (data.vlqCompleted) setVlqCompleted(data.vlqCompleted);
            if (data.yearTheme) setYearTheme(data.yearTheme);
            if (data.events) setEvents(data.events);
            if (data.goals) setGoals(data.goals);
            if (data.notes) setNotes(data.notes);
            if (data.journalEntries) setJournalEntries(data.journalEntries);
            if (data.monthlyReviews) setMonthlyReviews(data.monthlyReviews);
            if (data.yearlyReflections) setYearlyReflections(data.yearlyReflections);
            if (data.seasonIntentions) setSeasonIntentions(data.seasonIntentions);
            // Fix duplicate IDs in habits (migration for existing data)
            if (data.weeklyHabits) {
              const seen = new Set();
              const hasDuplicates = data.weeklyHabits.some(h => {
                if (seen.has(h.id)) return true;
                seen.add(h.id);
                return false;
              });
              if (hasDuplicates) {
                // Regenerate all IDs if duplicates found
                const fixed = data.weeklyHabits.map((h, i) => ({
                  ...h,
                  id: `${Date.now()}-weekly-${i}-${Math.random().toString(36).substr(2, 9)}`
                }));
                setWeeklyHabits(fixed);
                setHabitCompletions({}); // Clear completions since IDs changed
                console.log('Fixed duplicate weekly habit IDs');
              } else {
                setWeeklyHabits(data.weeklyHabits);
              }
            }
            if (data.dailyHabits) {
              const seen = new Set();
              const hasDuplicates = data.dailyHabits.some(h => {
                if (seen.has(h.id)) return true;
                seen.add(h.id);
                return false;
              });
              if (hasDuplicates) {
                // Regenerate all IDs if duplicates found
                const fixed = data.dailyHabits.map((h, i) => ({
                  ...h,
                  id: `${Date.now()}-daily-${i}-${Math.random().toString(36).substr(2, 9)}`
                }));
                setDailyHabits(fixed);
                setHabitCompletions({}); // Clear completions since IDs changed
                console.log('Fixed duplicate daily habit IDs');
              } else {
                setDailyHabits(data.dailyHabits);
              }
            }
            if (data.habitCompletions && !data.weeklyHabits?.some((h, i, arr) => arr.findIndex(x => x.id === h.id) !== i) && !data.dailyHabits?.some((h, i, arr) => arr.findIndex(x => x.id === h.id) !== i)) {
              setHabitCompletions(data.habitCompletions);
            }
            // Check if todaysTendies are actually from today (using LOCAL date, not UTC)
            const today = getLocalDateString();
            const storedTendiesDate = data.todaysTendies?.[0]?.date;
            const storedTendyId = data.todaysTendies?.[0]?.id;
            const generatedAt = data.todaysTendies?.[0]?.generatedAt;
            const isSelectedButNotCompleted = data.todaysTendies?.some(t => t.selected) && !data.todaysTendies?.some(t => t.completed);
            
            // Check staleness - if no generatedAt (old format) or generated more than 18 hours ago, consider stale
            const isStale = !generatedAt || (new Date() - new Date(generatedAt)) > (18 * 60 * 60 * 1000);
            
            console.log('Firebase load - Tendies check:', { 
              today, 
              storedTendiesDate, 
              storedTendyId,
              generatedAt,
              isStale,
              isSelectedButNotCompleted,
              hasVlqScores: !!data.vlqScores 
            });
            
            // Check if tendies are old format (has difficulty=2, which we no longer use)
            const hasOldFormat = data.todaysTendies?.some(t => t.difficulty === 2);
            
            // Check if tendies are from today by BOTH date field AND id prefix, AND not stale, AND not old format
            const tendiesAreFromToday = data.todaysTendies && 
              data.todaysTendies.length > 0 && 
              storedTendiesDate === today &&
              storedTendyId?.startsWith(today) &&
              !isStale &&
              !hasOldFormat;
            
            if (tendiesAreFromToday) {
              // Tendies are from today, use them
              console.log('Using stored tendies from today');
              setTodaysTendies(data.todaysTendies);
            } else if (data.vlqScores && Object.keys(data.vlqScores).length > 0) {
              // Tendies are old, stale, old format, or missing - generate new ones
              const previousDomain = data.todaysTendies?.[0]?.domain || null;
              console.log('Generating fresh daily tendies for', today, '- stored date was', storedTendiesDate, 'isStale:', isStale, 'hasOldFormat:', hasOldFormat, 'previousDomain:', previousDomain);
              
              // Get API key for personalization
              const storedApiKey = localStorage.getItem('tend_api_key') || '';
              
              if (storedApiKey && data.userProfile) {
                // Use async personalized generation
                generatePersonalizedTendies(
                  data.vlqScores, 
                  data.tendyHistory || [], 
                  previousDomain, 
                  data.userProfile, 
                  storedApiKey
                ).then(newTendies => {
                  setTodaysTendies(newTendies);
                }).catch(err => {
                  console.error('Personalization failed, using base tendies:', err);
                  const newTendies = generateDailyTendies(data.vlqScores, data.tendyHistory || [], previousDomain);
                  setTodaysTendies(newTendies);
                });
              } else {
                // No API key or profile, use sync version
                const newTendies = generateDailyTendies(data.vlqScores, data.tendyHistory || [], previousDomain);
                setTodaysTendies(newTendies);
              }
            } else {
              console.log('No VLQ scores available, cannot generate tendies');
            }
            if (data.tendyHistory) setTendyHistory(data.tendyHistory);
            if (data.tendyPoints) setTendyPoints(data.tendyPoints);
            if (data.tendyStreak) setTendyStreak(data.tendyStreak);
            if (data.flexPoints !== undefined) setFlexPoints(data.flexPoints);
            if (data.flexPointsTracking) setFlexPointsTracking(data.flexPointsTracking);
            if (data.weeklyCustomTendy) setWeeklyCustomTendy(data.weeklyCustomTendy);
            if (data.savedConversations) setSavedConversations(data.savedConversations);
            if (data.userProfile) setUserProfile(data.userProfile);
            // Load chat history
            if (data.chatHistory) setChatHistory(data.chatHistory);
            
            // Check if user is still in onboarding
            const isStillOnboarding = !data.onboardingCompleted && data.onboardingStep;
            
            // For onboarding users: restore current chat directly (don't archive it)
            if (isStillOnboarding && data.currentChat && data.currentChat.messages && data.currentChat.messages.length > 0) {
              console.log('Restoring onboarding chat from currentChat');
              setMessages(data.currentChat.messages);
              setExchangeCount(data.currentChat.exchangeCount || data.currentChat.messages.length);
              setSessionGreeted(true); // Don't add another greeting
            } else {
              // Archive previous chat to history if it had real conversation (more than 1 message)
              if (data.currentChat && data.currentChat.messages && data.currentChat.messages.length > 1) {
                const prevChat = {
                  id: data.currentChat.id || Date.now().toString(),
                  messages: data.currentChat.messages,
                  createdAt: data.currentChat.createdAt || new Date().toISOString(),
                  title: generateChatTitle(data.currentChat.messages)
                };
                setChatHistory(prev => [prevChat, ...(prev || [])].slice(0, 50)); // Keep last 50 chats
              }
              // Start fresh - messages will be set by the greeting effect
              setMessages([]);
              setExchangeCount(0);
            }
            setCurrentChatId(Date.now().toString());
            // Trends are calculated, not loaded
            if (data.revealed) setRevealed(data.revealed);
            if (data.phase) setPhase(data.phase);
            // Load onboarding state
            if (data.onboardingStep !== undefined) setOnboardingStep(data.onboardingStep);
            if (data.onboardingCompleted !== undefined) setOnboardingCompleted(data.onboardingCompleted);
            // For existing users who already have compass word but no onboarding tracking, mark complete
            if (data.yearTheme && data.onboardingCompleted === undefined) {
              setOnboardingCompleted(true);
              setOnboardingStep(null);
            }
            // If VLQ was completed, skip to step 2 (after summary) and reveal content
            if (data.vlqCompleted) {
              setVlqStep(2);
              setRevealed(true);
            }
          } else {
            // New user - reset all state and initialize
            setCurrentChatId(Date.now().toString());
            setUserProfile({ name: '', occupation: '', location: '', lifeStage: '', tendPreferences: {} });
            setMessages([]);
            setChatHistory([]);
            setVlqScores({
              family: { importance: null, consistency: null },
              partner: { importance: null, consistency: null },
              friendships: { importance: null, consistency: null },
              career: { importance: null, consistency: null },
              education: { importance: null, consistency: null },
              recreation: { importance: null, consistency: null },
              spirituality: { importance: null, consistency: null },
              community: { importance: null, consistency: null },
              health: { importance: null, consistency: null },
              mentalHealth: { importance: null, consistency: null },
            });
            setVlqCompleted(false);
            setVlqStep(-1);
            setYearTheme('');
            setEvents([]);
            setGoals([]);
            setRevealed(false);
            setShowSettingsModal(false);
            setOnboardingStep(1);
            setOnboardingCompleted(false);
          }
          setDataLoaded(true);
        } catch (error) {
          console.error('Error loading user data:', error);
          setDataLoaded(true);
        }
      };

      // Generate a title for a chat based on its messages
      const generateChatTitle = (msgs) => {
        if (!msgs || msgs.length === 0) return 'New chat';
        // Find first user message
        const firstUserMsg = msgs.find(m => m.role === 'user');
        if (firstUserMsg) {
          const text = firstUserMsg.content.replace(/<[^>]*>/g, '').trim();
          return text.length > 40 ? text.substring(0, 40) + '...' : text;
        }
        // Fall back to date
        const date = msgs[0].timestamp ? new Date(msgs[0].timestamp) : new Date();
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };
      const extractInsights = (messages) => {
        const allText = messages.map(m => m.content).join(' ').toLowerCase();
        const userMessages = messages.filter(m => m.role === 'user').map(m => m.content).join(' ');
        
        // Extract themes (simple keyword matching for now)
        const themeKeywords = {
          'work-life balance': /work.{0,20}life|balance|burnout|overwhelm/,
          'career': /career|job|work|profession|promotion/,
          'health': /health|fitness|exercise|wellness|sleep/,
          'relationships': /relationship|family|friend|partner|social/,
          'finances': /money|financial|budget|savings|income/,
          'personal growth': /learn|growth|development|skill|course/,
        };
        
        const themes = [];
        Object.entries(themeKeywords).forEach(([theme, regex]) => {
          if (regex.test(allText)) themes.push(theme);
        });
        
        // Simple mood detection
        const positiveWords = /great|good|happy|excited|wonderful|amazing|love|proud/;
        const challengeWords = /difficult|hard|struggle|stress|worry|anxious|overwhelm/;
        const positiveCount = (allText.match(positiveWords) || []).length;
        const challengeCount = (allText.match(challengeWords) || []).length;
        
        let mood = 'neutral';
        if (positiveCount > challengeCount + 2) mood = 'positive';
        else if (challengeCount > positiveCount + 2) mood = 'challenging';
        
        // OPTION C: Auto-extract user profile
        const profileExtraction = {};
        
        // Extract occupation
        const occupationPatterns = [
          /i(?:'m| am) a ([a-z\s]{3,30}(?:developer|designer|engineer|teacher|doctor|nurse|manager|consultant|analyst|writer|artist|student))/i,
          /i work as (?:a |an )?([a-z\s]{3,30})/i,
          /my job is ([a-z\s]{3,30})/i,
          /i'm (?:a |an )?([a-z\s]{3,30}(?:developer|designer|engineer|teacher|doctor|nurse|manager|consultant|analyst|writer|artist|student))/i
        ];
        for (const pattern of occupationPatterns) {
          const match = userMessages.match(pattern);
          if (match && match[1]) {
            profileExtraction.occupation = match[1].trim();
            break;
          }
        }
        
        // Extract location
        const locationPatterns = [
          /i live in ([a-z\s,]{3,40})/i,
          /i'm (?:from|in) ([a-z\s,]{3,40}(?:city|state|country|york|angeles|francisco|chicago|boston|seattle|austin|denver|portland))/i,
          /based in ([a-z\s,]{3,40})/i,
          /located in ([a-z\s,]{3,40})/i
        ];
        for (const pattern of locationPatterns) {
          const match = userMessages.match(pattern);
          if (match && match[1]) {
            profileExtraction.location = match[1].trim();
            break;
          }
        }
        
        // Extract life stage indicators
        const lifeStagePatterns = [
          /i have (\d+) (?:kids|children)/i,
          /i'm (married|single|divorced|engaged)/i,
          /i'm in my (twenties|thirties|forties|fifties|early 20s|late 20s|early 30s|late 30s|early 40s)/i,
          /(?:my )?(?:partner|spouse|husband|wife)/i
        ];
        const lifeStageIndicators = [];
        lifeStagePatterns.forEach(pattern => {
          const match = userMessages.match(pattern);
          if (match) {
            lifeStageIndicators.push(match[0]);
          }
        });
        if (lifeStageIndicators.length > 0) {
          profileExtraction.lifeStage = lifeStageIndicators.join(', ');
        }
        
        return {
          themes,
          mood,
          profileExtraction, // NEW: Auto-extracted profile
          extractedAt: new Date().toISOString()
        };
      };

      // Save current conversation if it's important
      const saveCurrentConversation = () => {
        if (messages.length === 0) return;
        
        // Only save certain types of conversations
        const typesToSave = ['monthly_review', 'yearly_review', 'onboarding', 'year_theme', 'values_exploration', 'life_design', 'general'];
        if (!typesToSave.includes(currentConversationType)) {
          // For general conversations, just extract insights but don't save full conversation
          const insights = extractInsights(messages);
          console.log('Extracted insights from general conversation:', insights);
          
          // OPTION C: Update user profile if new info extracted
          if (insights.profileExtraction) {
            setUserProfile(prev => ({
              ...prev,
              ...Object.fromEntries(
                Object.entries(insights.profileExtraction)
                  .filter(([_, value]) => value && !prev[_]) // Only add if not already set
              )
            }));
          }
          return;
        }
        
        const conversationId = `${currentConversationType}_${Date.now()}`;
        const insights = extractInsights(messages);
        
        // OPTION C: Update user profile from saved conversations too
        if (insights.profileExtraction) {
          setUserProfile(prev => ({
            ...prev,
            ...Object.fromEntries(
              Object.entries(insights.profileExtraction)
                .filter(([_, value]) => value && !prev[_]) // Only add if not already set
            )
          }));
        }
        
        setSavedConversations(prev => ({
          ...prev,
          [conversationId]: {
            type: currentConversationType,
            messages: [...messages],
            startedAt: messages[0]?.timestamp || new Date().toISOString(),
            lastMessageAt: new Date().toISOString(),
            insights
          }
        }));
        
        console.log(`Saved ${currentConversationType} conversation:`, conversationId);
      };

      // Wrapper to save conversation before switching modes
      const switchAppMode = (newMode) => {
        if (messages.length >= 3) {
          saveCurrentConversation();
        }
        setAppMode(newMode);
      };

      // Calculate user trends from existing data
      const calculateTrends = () => {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        
        // Daily Tends Analysis
        const dailyTendsStats = {};
        VLQ_ORDER.forEach(area => {
          const areaHistory = tendyHistory.filter(t => t.lifeArea === area);
          const completed = areaHistory.filter(t => t.completed).length;
          const total = areaHistory.length;
          dailyTendsStats[area] = {
            completed,
            skipped: total - completed,
            completionRate: total > 0 ? Math.round((completed / total) * 100) : 0
          };
        });
        
        // Calculate current streak
        let currentStreak = 0;
        const sortedHistory = [...tendyHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
        for (let i = 0; i < sortedHistory.length; i++) {
          if (sortedHistory[i].completed) {
            currentStreak++;
          } else {
            break;
          }
        }
        
        // Journaling stats
        const journalEntryDates = Object.keys(journalEntries);
        const thisMonthEntries = journalEntryDates.filter(date => date.startsWith(today.substring(0, 7))).length;
        const thisYearEntries = journalEntryDates.filter(date => date.startsWith(today.substring(0, 4))).length;
        
        // Calculate journal streak
        let journalStreak = 0;
        let checkDate = new Date(today);
        while (journalEntries[checkDate.toISOString().split('T')[0]]) {
          journalStreak++;
          checkDate.setDate(checkDate.getDate() - 1);
        }
        
        // Goals stats
        const completedGoals = goals.filter(g => g.completed).length;
        const totalGoals = goals.length;
        
        // Goals by life area
        const goalsByArea = {};
        VLQ_ORDER.forEach(area => {
          const areaGoals = goals.filter(g => g.lifeArea === area);
          if (areaGoals.length > 0) {
            goalsByArea[area] = {
              created: areaGoals.length,
              completed: areaGoals.filter(g => g.completed).length
            };
          }
        });
        
        // OPTION D: Simple Pattern Detection
        const patterns = {};
        
        // Pattern: Which day of week user journals most
        const journalDayCounts = {};
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        journalEntryDates.forEach(dateStr => {
          const dayOfWeek = new Date(dateStr).getDay();
          journalDayCounts[dayOfWeek] = (journalDayCounts[dayOfWeek] || 0) + 1;
        });
        const mostJournalingDay = Object.entries(journalDayCounts)
          .sort((a, b) => b[1] - a[1])[0];
        if (mostJournalingDay) {
          patterns.mostJournalingDay = dayNames[mostJournalingDay[0]];
        }
        
        // Pattern: Which day of week user completes tends most
        const tendyDayCounts = {};
        tendyHistory.filter(t => t.completed && t.date).forEach(tendy => {
          const dayOfWeek = new Date(tendy.date).getDay();
          tendyDayCounts[dayOfWeek] = (tendyDayCounts[dayOfWeek] || 0) + 1;
        });
        const mostTendyDay = Object.entries(tendyDayCounts)
          .sort((a, b) => b[1] - a[1])[0];
        if (mostTendyDay) {
          patterns.mostProductiveDay = dayNames[mostTendyDay[0]];
        }
        
        // Pattern: Longest streaks
        let longestJournalStreak = 0;
        let currentJStreak = 0;
        const sortedJournalDates = journalEntryDates.sort();
        for (let i = 0; i < sortedJournalDates.length; i++) {
          if (i === 0) {
            currentJStreak = 1;
          } else {
            const prevDate = new Date(sortedJournalDates[i - 1]);
            const currDate = new Date(sortedJournalDates[i]);
            const dayDiff = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
            if (dayDiff === 1) {
              currentJStreak++;
            } else {
              longestJournalStreak = Math.max(longestJournalStreak, currentJStreak);
              currentJStreak = 1;
            }
          }
        }
        longestJournalStreak = Math.max(longestJournalStreak, currentJStreak);
        patterns.longestJournalStreak = longestJournalStreak;
        
        // Pattern: Completion rate trend (weekday vs weekend)
        const weekdayCompletions = tendyHistory.filter(t => {
          const day = new Date(t.date).getDay();
          return day >= 1 && day <= 5 && t.completed;
        }).length;
        const weekdayTotal = tendyHistory.filter(t => {
          const day = new Date(t.date).getDay();
          return day >= 1 && day <= 5;
        }).length;
        const weekendCompletions = tendyHistory.filter(t => {
          const day = new Date(t.date).getDay();
          return (day === 0 || day === 6) && t.completed;
        }).length;
        const weekendTotal = tendyHistory.filter(t => {
          const day = new Date(t.date).getDay();
          return day === 0 || day === 6;
        }).length;
        
        if (weekdayTotal > 0 && weekendTotal > 0) {
          const weekdayRate = Math.round((weekdayCompletions / weekdayTotal) * 100);
          const weekendRate = Math.round((weekendCompletions / weekendTotal) * 100);
          if (weekdayRate > weekendRate + 10) {
            patterns.completionTrend = 'You complete more tends on weekdays';
          } else if (weekendRate > weekdayRate + 10) {
            patterns.completionTrend = 'You complete more tends on weekends';
          }
        }
        
        return {
          dailyTends: {
            byLifeArea: dailyTendsStats,
            currentStreak,
            totalCompleted: tendyHistory.filter(t => t.completed).length
          },
          journaling: {
            entriesThisMonth: thisMonthEntries,
            entriesThisYear: thisYearEntries,
            currentStreak: journalStreak,
            totalEntries: journalEntryDates.length
          },
          goals: {
            totalCreated: totalGoals,
            completed: completedGoals,
            inProgress: totalGoals - completedGoals,
            completionRate: totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0,
            byLifeArea: goalsByArea
          },
          patterns, // NEW: Simple patterns
          calculatedAt: now.toISOString()
        };
      };

      // Save user data to Firestore (debounced)
      const saveTimeoutRef = useRef(null);
      const saveUserData = useCallback(() => {
        if (!user) return;
        
        // Clear existing timeout
        if (saveTimeoutRef.current) {
          clearTimeout(saveTimeoutRef.current);
        }
        
        // Debounce: save after 1 second of no changes
        saveTimeoutRef.current = setTimeout(async () => {
          try {
            // Calculate trends before saving
            const trends = calculateTrends();
            
            await db.collection('users').doc(user.uid).set({
              vlqScores,
              vlqCompleted,
              yearTheme,
              events,
              goals,
              notes,
              journalEntries,
              monthlyReviews,
              yearlyReflections,
              seasonIntentions,
              weeklyHabits,
              dailyHabits,
              habitCompletions,
              todaysTendies,
              tendyHistory,
              tendyPoints,
              tendyStreak,
              flexPoints,
              flexPointsTracking,
              weeklyCustomTendy,
              revealed,
              phase,
              // Onboarding
              onboardingStep,
              onboardingCompleted,
              // NEW: Knowledge & Intelligence
              savedConversations,
              userProfile,
              trends,
              // Chat history system
              chatHistory: chatHistory.slice(0, 50), // Keep last 50 chats
              // NEW: Current chat session (persists across refresh)
              currentChat: {
                id: currentChatId,
                messages,
                exchangeCount,
                conversationType: currentConversationType,
                createdAt: new Date().toISOString()
              },
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            }, { merge: true });
            console.log('Data saved (including current chat)');
          } catch (error) {
            console.error('Error saving user data:', error);
          }
        }, 1000);
      }, [user, vlqScores, vlqCompleted, yearTheme, events, goals, notes, journalEntries, monthlyReviews, yearlyReflections, seasonIntentions, weeklyHabits, dailyHabits, habitCompletions, todaysTendies, tendyHistory, tendyPoints, tendyStreak, flexPoints, flexPointsTracking, weeklyCustomTendy, revealed, phase, onboardingStep, onboardingCompleted, savedConversations, userProfile, messages, exchangeCount, currentConversationType, chatHistory, currentChatId]);

      // Onboarding: Auto-advance when required steps are complete
      useEffect(() => {
        if (!vlqCompleted || onboardingCompleted || !onboardingStep) return;
        
        // Check if current step is complete and auto-show "continue" prompt
        // We don't auto-advance because user should consciously move forward
        // But we update the progress bar which shows completion
        
        // Special case: When daily tend is completed (step 7), mark onboarding complete
        if (onboardingStep === 7 && todaysTendies.some(t => t.completed)) {
          setOnboardingCompleted(true);
          setOnboardingStep(null);
        }
      }, [vlqCompleted, onboardingCompleted, onboardingStep, goals, weeklyHabits, userProfile, yearTheme, todaysTendies]);

      // Onboarding: Auto-navigate to relevant view when step changes
      useEffect(() => {
        if (!vlqCompleted || onboardingCompleted || onboardingStep === null || onboardingStep === undefined) return;
        
        // Navigate to the appropriate view for each step
        switch(onboardingStep) {
          case 1: // Goals - open Life Areas sidebar
            setActiveTab('lifeareas');
            setSidebarExpanded(true);
            setAppMode(null); // Ensure we're in main view
            break;
          case 2: // Habits - show Weekly view
            setSidebarExpanded(false);
            setCenterView(CENTER_VIEWS.WEEKLY);
            setAppMode(null);
            break;
          case 3: // Events - open Events sidebar
            setActiveTab('events');
            setSidebarExpanded(true);
            setAppMode(null);
            break;
          case 4: // Quiz - go to Insights
            setAppMode('insights');
            break;
          case 5: // Life Map - go to Insights
            setAppMode('insights');
            break;
          case 6: // Compass Word - main chat
            setAppMode(null);
            break;
          case 7: // Daily Tend - go to Tendy
            setAppMode('tendy');
            break;
        }
      }, [vlqCompleted, onboardingCompleted, onboardingStep]);

      // Flex Points Awarding System
      useEffect(() => {
        if (!user || !dataLoaded) return;
        
        const today = new Date().toISOString().split('T')[0];
        const now = new Date();
        const currentWeek = `${now.getFullYear()}-W${Math.ceil(((now - new Date(now.getFullYear(), 0, 1)) / 86400000 + new Date(now.getFullYear(), 0, 1).getDay() + 1) / 7)}`;
        const currentMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        
        let pointsToAward = 0;
        let newTracking = {...flexPointsTracking};
        
        // 1. Monday bonus (1 point per week)
        // Only award if user has tracking history (not first-ever load)
        const isMonday = now.getDay() === 1;
        const hasTrackingHistory = newTracking.lastMondayBonusWeek !== null || 
                                   newTracking.lastJournalDate !== null;
        if (isMonday && hasTrackingHistory && newTracking.lastMondayBonusWeek !== currentWeek) {
          pointsToAward += 1;
          newTracking.lastMondayBonusWeek = currentWeek;
        }
        
        // 2. Journal entry (0.5 points per day)
        if (journalEntries[today] && newTracking.lastJournalDate !== today) {
          pointsToAward += 0.5;
          newTracking.lastJournalDate = today;
        }
        
        // 3. Weekly intention set (0.5 points per week)
        const hasWeeklyIntention = weeklyHabits && weeklyHabits.length > 0;
        if (hasWeeklyIntention && newTracking.lastWeeklyIntentionWeek !== currentWeek) {
          pointsToAward += 0.5;
          newTracking.lastWeeklyIntentionWeek = currentWeek;
        }
        
        // 4. Custom tendy submitted (0.5 points per week)
        if (weeklyCustomTendy && weeklyCustomTendy.weekOf === currentWeek && 
            newTracking.lastCustomTendyWeek !== currentWeek) {
          pointsToAward += 0.5;
          newTracking.lastCustomTendyWeek = currentWeek;
        }
        
        // 5. 7-day check-in streak (1 point)
        const last7Days = Array.from({length: 7}, (_, i) => {
          const d = new Date();
          d.setDate(d.getDate() - i);
          return d.toISOString().split('T')[0];
        });
        const has7DayStreak = last7Days.every(date => journalEntries[date]);
        if (has7DayStreak && newTracking.last7DayStreakDate !== today) {
          pointsToAward += 1;
          newTracking.last7DayStreakDate = today;
        }
        
        // 6. Goal completion (0.5 points per goal)
        const completedGoals = goals.filter(g => g.completed);
        completedGoals.forEach(goal => {
          if (!newTracking.completedGoalIds.includes(goal.id)) {
            pointsToAward += 0.5;
            newTracking.completedGoalIds.push(goal.id);
          }
        });
        
        // Award points if any were earned
        if (pointsToAward > 0) {
          setFlexPoints(flexPoints + pointsToAward);
          setFlexPointsTracking(newTracking);
        }
      }, [user, dataLoaded, journalEntries, monthlyReviews, weeklyHabits, weeklyCustomTendy, goals, flexPoints, flexPointsTracking]);

      // Auto-save when data changes
      useEffect(() => {
        if (user && dataLoaded) {
          saveUserData();
        }
      }, [vlqScores, vlqCompleted, yearTheme, events, goals, notes, journalEntries, monthlyReviews, yearlyReflections, seasonIntentions, weeklyHabits, dailyHabits, habitCompletions, todaysTendies, tendyHistory, tendyPoints, tendyStreak, flexPoints, flexPointsTracking, weeklyCustomTendy, revealed, phase, user, dataLoaded, messages, exchangeCount, currentConversationType, userProfile, savedConversations]);

      // Logout function
      const handleLogout = async () => {
        try {
          await auth.signOut();
          // Reset all state
          setVlqScores({
            family: { importance: null, consistency: null },
            partner: { importance: null, consistency: null },
            friendships: { importance: null, consistency: null },
            career: { importance: null, consistency: null },
            education: { importance: null, consistency: null },
            recreation: { importance: null, consistency: null },
            spirituality: { importance: null, consistency: null },
            community: { importance: null, consistency: null },
            health: { importance: null, consistency: null },
            mentalHealth: { importance: null, consistency: null },
          });
          setVlqCompleted(false);
          setVlqStep(-1);
          setYearTheme('');
          setEvents([]);
          setGoals([]);
          setNotes('');
          setSeasonIntentions({ winter: '', spring: '', summer: '', fall: '' });
          setWeeklyHabits([]);
          setDailyHabits([]);
          setRevealed(false);
          setPhase(PHASES.EXPLORE);
          setMessages([]);
          setChatHistory([]);
          setUserProfile({ name: '', occupation: '', location: '', lifeStage: '', tendPreferences: {} });
          setShowSettingsModal(false);
          setDataLoaded(false);
        } catch (error) {
          console.error('Error signing out:', error);
        }
      };

      // Delete account function
      const handleDeleteAccount = async () => {
        const confirmed = window.confirm(
          'Are you sure you want to delete your account? This will permanently delete all your data and cannot be undone.'
        );
        
        if (!confirmed) return;
        
        try {
          const userId = user.uid;
          
          // Try to delete the Firebase Auth user first
          try {
            await user.delete();
            console.log('User account deleted');
          } catch (authError) {
            if (authError.code === 'auth/requires-recent-login') {
              // Need to re-authenticate - ask for password
              const password = window.prompt('For security, please enter your password to delete your account:');
              if (!password) {
                return; // User cancelled
              }
              
              try {
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                await user.reauthenticateWithCredential(credential);
                await user.delete();
                console.log('User account deleted after re-auth');
              } catch (reAuthError) {
                if (reAuthError.code === 'auth/wrong-password') {
                  alert('Incorrect password. Please try again.');
                } else {
                  alert('Error: ' + reAuthError.message);
                }
                return;
              }
            } else {
              throw authError;
            }
          }
          
          // Delete user data from Firestore
          await db.collection('users').doc(userId).delete();
          console.log('User data deleted from Firestore');
          
          // Reset all state
          setVlqScores({
            family: { importance: null, consistency: null },
            partner: { importance: null, consistency: null },
            friendships: { importance: null, consistency: null },
            career: { importance: null, consistency: null },
            education: { importance: null, consistency: null },
            recreation: { importance: null, consistency: null },
            spirituality: { importance: null, consistency: null },
            community: { importance: null, consistency: null },
            health: { importance: null, consistency: null },
            mentalHealth: { importance: null, consistency: null },
          });
          setVlqCompleted(false);
          setVlqStep(-1);
          setYearTheme('');
          setEvents([]);
          setGoals([]);
          setNotes('');
          setSeasonIntentions({ winter: '', spring: '', summer: '', fall: '' });
          setWeeklyHabits([]);
          setDailyHabits([]);
          setRevealed(false);
          setPhase(PHASES.EXPLORE);
          setMessages([]);
          setChatHistory([]);
          setUserProfile({ name: '', occupation: '', location: '', lifeStage: '', tendPreferences: {} });
          setDataLoaded(false);
          
          alert('Your account has been deleted.');
        } catch (error) {
          console.error('Error deleting account:', error);
          alert('Error deleting account: ' + error.message);
        }
      };

      // Set conversation type based on phase and onboarding status
      useEffect(() => {
        if (phase === PHASES.EXPLORE || phase === PHASES.GROUND) {
          setCurrentConversationType('onboarding');
        } else if (phase === PHASES.REVEAL && !vlqCompleted) {
          setCurrentConversationType('onboarding');
        } else if (!onboardingCompleted && onboardingStep) {
          // Keep as 'onboarding' during the 7-step onboarding process
          setCurrentConversationType('onboarding');
        } else if (currentConversationType === 'onboarding' && onboardingCompleted) {
          // Save onboarding conversation once fully complete
          saveCurrentConversation();
          setCurrentConversationType('general');
        }
      }, [phase, vlqCompleted, onboardingCompleted, onboardingStep]);

      // Loading screen - just the icon
      const loadingScreen = (
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'var(--bg-main)',
        }}>
          <svg width="48" height="48" viewBox="0 0 80 80" fill="none" style={{opacity: 0.6}}>
            <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round"/>
            <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <circle cx="40" cy="70" r="4" fill="none" stroke="var(--accent)" strokeWidth="2"/>
          </svg>
        </div>
      );

      // Session greeting - add a fresh greeting each time user returns
      useEffect(() => {
        // Only greet after VLQ is complete and we haven't greeted this session
        // Also skip if messages already exist (restored from saved conversation)
        if (vlqCompleted && !sessionGreeted && messages.length === 0) {
          const timer = setTimeout(() => {
            setSessionGreeted(true);
            
            let openingMessage = '';
            const focusAreas = getFocusAreas();
            const focusAreaNames = focusAreas.map(k => VLQ_DOMAINS[k].name).slice(0, 3);

            // If onboarding is NOT complete, show step-specific message
            if (!onboardingCompleted && onboardingStep) {
              switch(onboardingStep) {
                case 1: // Goals
                  openingMessage = `Welcome to Tend! ðŸŒ± I'm here to help you design your year with intention.

Based on your values assessment, ${focusAreaNames.length > 0 ? `you want to focus on growing in: <strong>${focusAreaNames.join('</strong>, <strong>')}</strong>` : 'there are areas where you want to grow'}.

Let's start by setting <strong>at least 3 goals</strong>${focusAreaNames.length > 0 ? ` â€” and make sure at least one goal covers each of your focus areas` : ''}.

I've opened the Life Areas sidebar where your goals will appear. What's something you'd love to accomplish this year?`;
                  break;
                  
                case 2: // Habits
                  openingMessage = `Great progress on your goals! ðŸŽ¯ 

Now let's build <strong>habits</strong> that will help you reach them. Small, consistent actions compound over time.

You'll need <strong>at least 3 habits</strong>${focusAreaNames.length > 0 ? `, with at least one supporting each focus area (${focusAreaNames.join(', ')})` : ''}.

I've switched to the Weekly view where you can track your habits. What's one thing you'd like to do regularly?`;
                  break;
                  
                case 3: // Events (optional)
                  openingMessage = `Let's map out your year! ðŸ“…

Do you have any big events, trips, or milestones coming up? Adding them helps me understand the rhythm of your year and suggest timely tends.

I've opened the Events sidebar â€” you can add events there or tell me about them here. This step is optional.

[BUTTON: Skip to next step | next step]`;
                  break;
                  
                case 4: // Gardener Quiz (optional)
                  openingMessage = `Let's discover your tending style! ðŸŒ¸

The Gardener Quiz is a quick, fun way for me to understand how you approach growth and self-care. Your style helps me personalize your tends.

I've taken you to Insights where you can find the quiz. This is optional â€” you can skip if you'd like.

[BUTTON: Skip to next step | next step]`;
                  break;
                  
                case 5: // Life Map
                  openingMessage = `Let's build your Life Map! ðŸ—ºï¸

I'd love to know more about what's happening in your life right now. The more context I have, the better I can personalize your experience.

I've taken you to Insights where you'll find the Life Map prompts. Answer at least one to continue â€” but the more you share, the more I can help.`;
                  break;
                  
                case 6: // Compass Word
                  const suggestedWord = getSuggestedCompassWord();
                  openingMessage = `Almost there! ðŸ§­

Based on everything you've shared â€” your values, goals, and what you want to focus on â€” I think your <strong>compass word</strong> for this year could be:

<div style="text-align: center; margin: 1.5rem 0; padding: 1rem; background: var(--accent-light); border-radius: 12px; border: 1px solid var(--accent);">
<span style="font-size: 1.8rem; font-weight: 600; color: var(--accent); text-transform: capitalize;">${suggestedWord}</span>
</div>

This word can guide your decisions and intentions throughout the year. Does it feel right?

[BUTTON: Yes, that's perfect! | set compass ${suggestedWord}]
[BUTTON: I have a different word in mind | suggest compass]`;
                  break;
                  
                case 7: // Daily Tend
                  openingMessage = `You're all set up! ðŸŒ±

Your compass word is <strong>${yearTheme}</strong>, and you have goals, habits, and a Life Map to guide your journey.

I've taken you to your Daily Tend â€” select one and mark it complete to finish onboarding!`;
                  break;
                  
                default:
                  openingMessage = `Hey! ðŸŒ± Ready to continue setting up your intentional year?`;
              }
            } else {
              // Onboarding complete - show returning user message
              if (yearTheme) {
                const themeConnections = {
                  'growth': 'nurturing your growth',
                  'balance': 'finding your balance',
                  'presence': 'cultivating presence',
                  'intention': 'living with intention',
                  'connection': 'deepening your connections',
                  'foundation': 'building your foundation',
                  'clarity': 'finding clarity',
                  'peace': 'cultivating peace',
                  'freedom': 'creating freedom',
                  'joy': 'inviting more joy',
                  'courage': 'practicing courage',
                  'simplicity': 'embracing simplicity',
                  'authenticity': 'living authentically',
                  'resilience': 'building resilience',
                  'creativity': 'nurturing your creativity',
                };
                
                const themePhrase = themeConnections[yearTheme.toLowerCase()] || `living into <em>${yearTheme}</em>`;
                
                openingMessage = `Hey! Your compass word is <em>${yearTheme}</em>. ðŸŒ±

Where would you like to go today?

<strong>ðŸŒ± Generate a daily tend</strong> â€” a small action for today
<strong>ðŸŽ¯ Check your goals</strong> â€” see your progress
<strong>ðŸ““ Journal</strong> â€” reflect on your day

Or just chat â€” I'm here.

[BUTTON: Generate a daily tend | tendy]
[BUTTON: Check my goals | goals]
[BUTTON: Journal | journal]`;
              } else {
                openingMessage = `Hey! ðŸŒ± What would you like to explore today?

[BUTTON: Generate a daily tend | tendy]
[BUTTON: Set some goals | goals]
[BUTTON: Journal | journal]`;
              }
            }

          // Set greeting as the first message of new chat
          setMessages([{
            role: 'assistant',
            content: openingMessage,
            timestamp: new Date().toISOString()
          }]);
          
          // Scroll to bottom after greeting is added
          setTimeout(() => scrollChatToBottom(), 100);
          }, 50);
          
          return () => clearTimeout(timer);
        }
      }, [vlqCompleted, sessionGreeted, onboardingCompleted, onboardingStep, yearTheme, messages.length]);

      // Track view/tab for system prompt context (no auto-messages)

      // Chat resize handlers
      const handleMouseDown = (e) => {
        setIsResizing(true);
        e.preventDefault();
      };

      useEffect(() => {
        const handleMouseMove = (e) => {
          if (!isResizing) return;
          const newWidth = window.innerWidth - e.clientX;
          setChatWidth(Math.min(Math.max(280, newWidth), 600));
        };

        const handleMouseUp = () => {
          setIsResizing(false);
        };

        if (isResizing) {
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        }

        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isResizing]);

      // Sidebar resize handlers
      const handleSidebarMouseDown = (e) => {
        setIsResizingSidebar(true);
        e.preventDefault();
      };

      useEffect(() => {
        const handleSidebarMouseMove = (e) => {
          if (!isResizingSidebar) return;
          const newWidth = e.clientX;
          setSidebarWidth(Math.min(Math.max(200, newWidth), 400));
        };

        const handleSidebarMouseUp = () => {
          setIsResizingSidebar(false);
        };

        if (isResizingSidebar) {
          document.addEventListener('mousemove', handleSidebarMouseMove);
          document.addEventListener('mouseup', handleSidebarMouseUp);
        }

        return () => {
          document.removeEventListener('mousemove', handleSidebarMouseMove);
          document.removeEventListener('mouseup', handleSidebarMouseUp);
        };
      }, [isResizingSidebar]);

      // Scroll chat to bottom
      const scrollChatToBottom = () => {
        if (chatContainerRef.current) {
          chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
      };

      // Scroll when messages change
      useEffect(() => {
        // Use requestAnimationFrame to ensure DOM is updated
        requestAnimationFrame(() => {
          scrollChatToBottom();
        });
      }, [messages]);

      // Scroll after session greeting is added
      useEffect(() => {
        if (sessionGreeted) {
          // Give time for the greeting message to render
          [100, 300, 500].forEach(delay => {
            setTimeout(scrollChatToBottom, delay);
          });
        }
      }, [sessionGreeted]);

      // Also scroll on initial load - with multiple attempts to ensure it works
      useEffect(() => {
        if (dataLoaded && vlqCompleted && messages.length > 0) {
          // Multiple attempts with increasing delays
          [100, 300, 500, 1000].forEach(delay => {
            setTimeout(scrollChatToBottom, delay);
          });
        }
      }, [dataLoaded, vlqCompleted, messages.length]);

      const analyzeText = (text) => {
        const lower = text.toLowerCase();
        const detected = { values: [] };
        Object.entries(VALUE_KEYWORDS).forEach(([value, keywords]) => {
          if (keywords.some(kw => lower.includes(kw)) && !values.includes(value)) {
            detected.values.push(value);
          }
        });
        return detected;
      };

      const processAnalysis = (detected) => {
        if (detected.values.length > 0) {
          setValues(prev => [...new Set([...prev, ...detected.values])].slice(0, 4));
        }
      };

      const parseEvents = (text) => {
        const lower = text.toLowerCase();
        const foundEvents = [];
        MONTH_FULL.forEach((month, idx) => {
          if (lower.includes(month.toLowerCase())) {
            foundEvents.push({ month: idx });
          }
        });
        return foundEvents;
      };

      const generateResponse = (userMessage, currentPhase, exchangeNum) => {
        const detected = analyzeText(userMessage);
        processAnalysis(detected);
        const lower = userMessage.toLowerCase();

        if (currentPhase === PHASES.EXPLORE) {
          if (exchangeNum === 1) {
            // Try to extract a theme word from their response
            const words = userMessage.split(/\s+/).filter(w => w.length > 2 && w.length < 15);
            const potentialTheme = words.find(w => 
              /^[a-zA-Z]+$/.test(w) && 
              !['the', 'and', 'but', 'for', 'that', 'this', 'with', 'would', 'could', 'think', 'want', 'like', 'year', 'maybe', 'something'].includes(w.toLowerCase())
            );
            
            if (potentialTheme && words.length <= 5) {
              // They likely gave a single word or short phrase
              setYearTheme(potentialTheme.toLowerCase());
              return `<em>${potentialTheme.charAt(0).toUpperCase() + potentialTheme.slice(1).toLowerCase()}</em> â€” I love that.

What does ${potentialTheme.toLowerCase()} mean to you? What would it look like if this year actually embodied that word?`;
            }
            
            const hasFeeling = ['feel', 'feeling', 'want to be', 'less', 'more'].some(w => lower.includes(w));
            if (hasFeeling) {
              return `That's about <em>how</em> you want to feel â€” which is often more important than what you achieve.

If you had to distill that into one word, what would it be? And what's getting in the way of that right now?`;
            }
            return `Tell me more. If you could capture that in a single word â€” a theme for the year â€” what might it be?`;
          }
          
          if (exchangeNum === 2) {
            // Check if they gave a theme word this time
            const words = userMessage.split(/\s+/).filter(w => w.length > 2 && w.length < 15);
            const potentialTheme = words.find(w => 
              /^[a-zA-Z]+$/.test(w) && 
              !['the', 'and', 'but', 'for', 'that', 'this', 'with', 'would', 'could', 'think', 'want', 'like', 'year', 'maybe', 'something'].includes(w.toLowerCase())
            );
            
            if (potentialTheme && !yearTheme) {
              setYearTheme(potentialTheme.toLowerCase());
            }
            
            return `I'm starting to see what matters to you.

If nothing changed this year, how would that feel?`;
          }

          if (exchangeNum >= 3) {
            setPhase(PHASES.GROUND);
            return `Before I share what I'm hearing, help me understand what's already planned.

What's committed this year â€” trips, big events, deadlines? Just mention the month and what it is.`;
          }
        }

        if (currentPhase === PHASES.GROUND) {
          const foundEvents = parseEvents(userMessage);
          
          if (foundEvents.length > 0) {
            const newEvents = foundEvents.map((e, i) => ({
              id: Date.now() + i,
              title: `Event in ${MONTHS[e.month]}`,
              month: e.month,
              lifeArea: 'fun',
              details: { flights: '', stays: '', activities: '', notes: '' },
            }));
            setEvents(prev => [...prev, ...newEvents]);
          }

          setTimeout(() => {
            setPhase(PHASES.REVEAL);
            setRevealed(true);
          }, 500);

          const valuesSummary = values.length > 0 
            ? values.slice(0, 3).join(', ')
            : 'intention and presence';

          return `<strong>Here's what I'm hearing:</strong>

Your values center around <em>${valuesSummary}</em>.

${foundEvents.length > 0 
  ? `You have ${foundEvents.length} thing${foundEvents.length > 1 ? 's' : ''} anchoring the year.`
  : `Your calendar is open â€” that's space to be intentional.`}

Your year is taking shape. Switch between Year, Seasons, and Monthly views to explore different perspectives.

What's missing?`;
        }

        if (currentPhase === PHASES.REVEAL || currentPhase === PHASES.PLAN) {
          setPhase(PHASES.PLAN);

          // Sidebar tabs - Events
          if (activeTab === 'events') {
            if (lower.includes('trip') || lower.includes('travel') || lower.includes('vacation') || lower.includes('visit')) {
              return `A trip! Let's plan it.

Tell me:
â€¢ <em>Where</em> are you thinking?
â€¢ <em>When</em> â€” which month?
â€¢ <em>Who's going</em> â€” solo, partner, friends, family?

Once you add it, I can help with activities, stays, and logistics.`;
            }

            if (lower.includes('birthday') || lower.includes('anniversary') || lower.includes('celebration')) {
              return `Celebrations deserve planning too.

What would make this one special? Think about:
â€¢ The <em>experience</em> you want to create
â€¢ Who needs to be involved
â€¢ What you want to remember about it

Add it to your events and we can flesh out the details.`;
            }

            if (lower.includes('deadline') || lower.includes('work') || lower.includes('project') || lower.includes('launch')) {
              return `Work events anchor the year too.

For this deadline or project:
â€¢ What needs to happen <em>before</em> it?
â€¢ Do you need to protect time leading up to it?
â€¢ What would make it feel successful, not just done?`;
            }

            const eventCount = events.length;
            if (eventCount > 0) {
              return `You have ${eventCount} event${eventCount > 1 ? 's' : ''} planned. Want to add another, or dive deeper into one of these?

I can help with:
â€¢ Activity ideas for any trip
â€¢ Logistics and planning
â€¢ Making sure you're not over-scheduling`;
            }

            return `What's on the horizon? Trips, celebrations, deadlines, milestones?

Even tentative plans are worth capturing â€” they help you see the shape of your year.`;
          }

          // Sidebar tabs - Notes
          if (activeTab === 'notes') {
            return `This is your space to think out loud.

You can use it for:
â€¢ Brain dumps when your head is full
â€¢ Ideas you're not ready to act on
â€¢ Reflections on how things are going
â€¢ Anything that doesn't fit elsewhere

What's taking up mental space right now?`;
          }

          // Sidebar tabs - Goals
          if (activeTab === 'goals') {
            if (lower.includes('fitness') || lower.includes('health') || lower.includes('weight') || lower.includes('run') || lower.includes('exercise')) {
              return `Health goals are foundational.

Make them specific and achievable:
â€¢ <em>"Run a 5K"</em> beats "get in shape"
â€¢ <em>"Workout 3x/week for 3 months"</em> beats "exercise more"
â€¢ <em>"Lose 10 pounds by June"</em> beats "lose weight"

What's your real target?`;
            }

            if (lower.includes('read') || lower.includes('book') || lower.includes('learn')) {
              return `Learning goals expand your world.

Some ways to frame them:
â€¢ <em>"Read 12 books"</em> â€” one a month
â€¢ <em>"Finish one online course"</em>
â€¢ <em>"Learn conversational Spanish"</em>

What do you want to know by year's end?`;
            }

            if (lower.includes('save') || lower.includes('money') || lower.includes('financial') || lower.includes('invest')) {
              return `Financial goals create options.

Be specific:
â€¢ <em>"Save $10K for emergency fund"</em>
â€¢ <em>"Max out retirement contribution"</em>
â€¢ <em>"Pay off credit card by August"</em>

What number would make you feel more secure?`;
            }

            const goalCount = goals.length;
            if (goalCount > 0) {
              return `You have ${goalCount} goal${goalCount > 1 ? 's' : ''} set. Want to add another, or talk through how to make progress on one?

Goals work best when they're:
â€¢ Specific enough to know when you've hit them
â€¢ Connected to what actually matters to you`;
            }

            return `What do you want to be true by the end of this year that isn't true now?

Don't overthink it â€” you can always refine. Start with what comes to mind.`;
          }
          
          // Seasons view - help with season intentions
          if (centerView === CENTER_VIEWS.SEASONS) {
            const seasonWords = {
              winter: ['cozy', 'rest', 'reflect', 'hibernate', 'slow', 'quiet', 'warm'],
              spring: ['renew', 'fresh', 'start', 'bloom', 'energy', 'clean', 'grow'],
              summer: ['adventure', 'explore', 'freedom', 'play', 'travel', 'sun', 'joy'],
              fall: ['harvest', 'gather', 'prepare', 'focus', 'transition', 'gratitude', 'settle']
            };
            
            const currentSeasonName = (() => {
              const month = new Date().getMonth();
              if ([11, 0, 1].includes(month)) return 'winter';
              if ([2, 3, 4].includes(month)) return 'spring';
              if ([5, 6, 7].includes(month)) return 'summer';
              return 'fall';
            })();

            if (lower.includes('winter') || lower.includes('cold') || lower.includes('december') || lower.includes('january') || lower.includes('february')) {
              return `Winter is a time for slowing down.

Some intentions to consider:
â€¢ <em>"Rest without guilt"</em>
â€¢ <em>"Protect my mornings"</em>  
â€¢ <em>"Less doing, more being"</em>

What would make your winter feel nourishing rather than just something to get through?`;
            }
            
            if (lower.includes('spring') || lower.includes('march') || lower.includes('april') || lower.includes('may')) {
              return `Spring is about emergence and new energy.

Some intentions to consider:
â€¢ <em>"Start one thing I've been putting off"</em>
â€¢ <em>"Clear what's not serving me"</em>
â€¢ <em>"Say yes to something new"</em>

What wants to bloom in your life this spring?`;
            }

            if (lower.includes('summer') || lower.includes('june') || lower.includes('july') || lower.includes('august')) {
              return `Summer holds space for expansion and joy.

Some intentions to consider:
â€¢ <em>"Prioritize experiences over tasks"</em>
â€¢ <em>"Protect time for spontaneity"</em>
â€¢ <em>"Be present in the long days"</em>

What would a summer well-lived look like for you?`;
            }

            if (lower.includes('fall') || lower.includes('autumn') || lower.includes('september') || lower.includes('october') || lower.includes('november')) {
              return `Fall is a season of gathering and grounding.

Some intentions to consider:
â€¢ <em>"Harvest what I've built"</em>
â€¢ <em>"Simplify before winter"</em>
â€¢ <em>"Celebrate progress, not just goals"</em>

What do you want to carry into the darker months?`;
            }

            return `Think about what each season needs from you â€” and what you need from it.

You're in <em>${currentSeasonName}</em> right now. How's it going? What would help this season feel more aligned with what you want?`;
          }

          // Monthly view - help with specific month planning
          if (centerView === CENTER_VIEWS.MONTHLY) {
            const monthName = MONTH_FULL[selectedMonth];
            
            if (lower.includes('plan') || lower.includes('suggest') || lower.includes('ideas') || lower.includes('what should')) {
              return `For <em>${monthName}</em>, let's think about:

<strong>What's already anchored?</strong>
Work commitments, birthdays, holidays, travel

<strong>What do you want to protect?</strong>
Rest days, date nights, creative time, nothing-days

<strong>What's one thing that would make this month feel successful?</strong>

Tell me what's on your mind for ${monthName}.`;
            }

            const monthEvents = events.filter(e => e.month === selectedMonth);
            if (monthEvents.length > 0) {
              return `You have <em>${monthEvents.length}</em> thing${monthEvents.length > 1 ? 's' : ''} in ${monthName}: ${monthEvents.map(e => e.title).join(', ')}.

Want me to help you think through any of these? I can suggest activities, help with logistics, or just think through what would make it great.`;
            }

            return `${monthName} is open â€” that's possibility.

What would make this month feel intentional rather than just busy? Any trips, goals, or moments you want to create?`;
          }

          // Weekly view - help with weekly habits
          if (centerView === CENTER_VIEWS.WEEKLY) {
            if (lower.includes('exercise') || lower.includes('workout') || lower.includes('gym') || lower.includes('run') || lower.includes('movement')) {
              return `Movement is foundational. Some weekly rhythms to consider:

â€¢ <em>3x strength, 2x cardio</em> â€” classic balance
â€¢ <em>Daily walks + 2x intense sessions</em> â€” gentler approach
â€¢ <em>1 long active adventure</em> â€” hiking, biking, swimming

What feels sustainable for you? The best routine is one you'll actually do.`;
            }

            if (lower.includes('date') || lower.includes('partner') || lower.includes('relationship') || lower.includes('connect')) {
              return `Protecting time for relationships is one of the most important things you can do.

Ideas for weekly connection:
â€¢ <em>Weekly date night</em> â€” same night each week makes it automatic
â€¢ <em>Morning coffee together</em> â€” 15 minutes of presence
â€¢ <em>Phone-free dinner</em> â€” simple but powerful

What would help your relationships thrive?`;
            }

            if (lower.includes('creative') || lower.includes('hobby') || lower.includes('learn') || lower.includes('read')) {
              return `Making space for creativity and growth:

â€¢ <em>2 hours of creative time</em> â€” protect it like a meeting
â€¢ <em>One chapter a day</em> â€” books add up
â€¢ <em>Weekly learning session</em> â€” courses, podcasts, practice

What do you want to make more time for?`;
            }

            return `Think about the activities that, when you do them regularly, make everything else feel better.

What would you put on your <em>ideal week</em>? Start with just one or two â€” you can always add more.`;
          }

          // Daily view - help with daily habits  
          if (centerView === CENTER_VIEWS.DAILY) {
            if (lower.includes('morning') || lower.includes('wake') || lower.includes('routine')) {
              return `Mornings set the tone for everything.

Some daily morning practices:
â€¢ <em>No phone for first 30 minutes</em>
â€¢ <em>10 minutes of movement</em>
â€¢ <em>Write 3 things you're grateful for</em>
â€¢ <em>One intentional deep breath</em>

What would your ideal morning include?`;
            }

            if (lower.includes('water') || lower.includes('hydrat') || lower.includes('drink')) {
              return `Hydration is one of those small things with outsized impact.

Simple targets:
â€¢ <em>8 glasses / 2 liters</em> â€” the classic
â€¢ <em>Glass before each meal</em> â€” easy to remember
â€¢ <em>Water bottle always visible</em> â€” environment design

What would help you drink more water?`;
            }

            if (lower.includes('walk') || lower.includes('step') || lower.includes('move')) {
              return `Daily movement doesn't have to be intense to be transformative.

Ideas:
â€¢ <em>10,000 steps</em> â€” the gold standard
â€¢ <em>Walk after each meal</em> â€” aids digestion too
â€¢ <em>Standing desk + hourly movement breaks</em>

What level of daily movement feels right for you?`;
            }

            if (lower.includes('phone') || lower.includes('screen') || lower.includes('social media')) {
              return `Our relationship with technology shapes our days more than we realize.

Boundaries to consider:
â€¢ <em>No phone in bedroom</em>
â€¢ <em>App limits on social media</em>
â€¢ <em>Phone-free first and last hour</em>
â€¢ <em>Grayscale mode</em>

What boundary would give you the most peace?`;
            }

            return `Daily habits are about becoming the person you want to be, one small action at a time.

Start tiny â€” what's one thing you could do <em>every single day</em> that would compound over a year?`;
          }
          
          // Default planning responses
          if (lower.includes('plan') || lower.includes('suggest') || lower.includes('ideas') || lower.includes('activities') || lower.includes('where to stay')) {
            const eventMention = events.find(e => lower.includes(MONTHS[e.month].toLowerCase()) || lower.includes(e.title.toLowerCase()));
            if (eventMention) {
              return `For your ${MONTHS[eventMention.month]} event:

<strong>Activities:</strong>
â€¢ Explore the local neighborhood on foot
â€¢ Find one "must-do" and leave room for spontaneity
â€¢ Schedule downtime â€” rest is part of the trip

<strong>Stays:</strong>
â€¢ Look for somewhere with a kitchen for flexibility
â€¢ Consider location vs. price

Click on the event in the sidebar to add details.`;
            }
            return `What event would you like to plan? I can suggest activities, places to stay, and things to consider.`;
          }

          const prompts = [
            `What's one thing you've been wanting to plan but haven't?`,
            `Looking at the seasons â€” where do you need to protect space?`,
            `Is there a trip or experience you keep pushing off?`,
          ];
          return prompts[Math.floor(Math.random() * prompts.length)];
        }

        return `Tell me more about that.`;
      };

      // System prompt for Tend AI
      const getTendSystemPrompt = (pendingState = {}) => {
        const { 
          pendingLifeAreaUpdate, 
          pendingNextAreaIndex, 
          pendingWaitingForSatisfaction,
          pendingIsLastResponse 
        } = pendingState;
        
        // Use pending values if provided, otherwise use current state
        const effectiveAreaIndex = pendingNextAreaIndex !== undefined ? pendingNextAreaIndex : currentLifeAreaIndex;
        const effectiveWaitingFor = pendingWaitingForSatisfaction !== undefined ? pendingWaitingForSatisfaction : waitingForSatisfaction;
        const effectiveIsLast = pendingIsLastResponse || isLastLifeAreaResponse;
        
        // Build updated life area ratings including any pending update
        const effectiveRatings = pendingLifeAreaUpdate 
          ? {
              ...lifeAreaRatings,
              [pendingLifeAreaUpdate.area]: {
                ...lifeAreaRatings[pendingLifeAreaUpdate.area],
                [pendingLifeAreaUpdate.field]: pendingLifeAreaUpdate.score
              }
            }
          : lifeAreaRatings;

        const currentSeason = (() => {
          const month = new Date().getMonth();
          if ([11, 0, 1].includes(month)) return 'winter';
          if ([2, 3, 4].includes(month)) return 'spring';
          if ([5, 6, 7].includes(month)) return 'summer';
          return 'fall';
        })();

        const lifeAreasContext = vlqCompleted 
          ? VLQ_ORDER.map(key => {
              const scores = vlqScores[key];
              const gap = (scores?.importance || 0) - (scores?.consistency || 0);
              return `${VLQ_DOMAINS[key].name}: importance ${scores?.importance}/10, consistency ${scores?.consistency}/10${gap >= 3 ? ' (GROWTH AREA)' : ''}`;
            }).join('; ')
          : 'not assessed yet';

        // Check for misalignments between intentions and actual plans
        const getMisalignments = () => {
          if (!lifeAreasCompleted && !effectiveIsLast) return '';
          const ratingsToCheck = effectiveIsLast ? effectiveRatings : lifeAreaRatings;
          const misalignments = [];
          
          // High intention areas with low activity
          Object.entries(ratingsToCheck).forEach(([key, val]) => {
            if (val.intention >= 7) {
              const relatedHabits = weeklyHabits.filter(h => 
                h.text.toLowerCase().includes(key) || 
                (key === 'health' && /exercise|workout|gym|run|walk|yoga/i.test(h.text)) ||
                (key === 'relationships' && /date|partner|friend|family|call/i.test(h.text)) ||
                (key === 'fun' && /hobby|play|adventure|trip/i.test(h.text))
              );
              const relatedEvents = events.filter(e => e.lifeArea === key);
              
              if (relatedHabits.length === 0 && relatedEvents.length === 0) {
                misalignments.push(`${LIFE_AREAS[key].name} has high intention (${val.intention}) but no related habits or events`);
              }
            }
          });
          
          return misalignments.length > 0 
            ? `\n\nPotential misalignments to gently explore: ${misalignments.join('; ')}`
            : '';
        };

        // Get onboarding-specific context and instructions
        const getOnboardingContext = () => {
          if (onboardingCompleted || !onboardingStep) return '';
          
          const focusAreas = getFocusAreas();
          const focusAreaNames = focusAreas.map(k => VLQ_DOMAINS[k]?.name || k);
          
          // For step 1: Goals
          if (onboardingStep === 1) {
            const goalsWithAreas = goals.filter(g => g.lifeArea);
            const coveredAreas = focusAreas.filter(a => goals.some(g => g.lifeArea === a));
            const missingAreas = focusAreas.filter(a => !goals.some(g => g.lifeArea === a));
            const missingAreaNames = missingAreas.map(k => VLQ_DOMAINS[k]?.name || k);
            
            return `

=== ONBOARDING MODE: GOALS (Step 1 of 7) ===
The user is setting up Tend for the first time. Help them set meaningful goals.

REQUIREMENTS:
- Minimum 3 goals total
- At least one goal for EACH focus area: ${focusAreaNames.join(', ')}

CURRENT PROGRESS:
- Total goals: ${goals.length}/3 minimum
- Focus areas covered: ${coveredAreas.length}/${focusAreas.length}
${missingAreas.length > 0 ? `- STILL NEEDED: Goals for ${missingAreaNames.join(', ')}` : '- All focus areas covered! âœ“'}

YOUR APPROACH:
1. Listen to what the user shares about what they want to accomplish
2. Identify which life area(s) each goal fits
3. Confirm briefly and move on â€” don't repeat yourself

WHEN USER MENTIONS ONE GOAL:
- Simply say: "That sounds like a [Life Area] goal â€” does that feel right?"

WHEN USER MENTIONS MULTIPLE GOALS:
- List them briefly with life areas, then ask for confirmation ONCE
- Example: "So we have: fitness (Physical Health), making friends (Friendships), and community building (Community). Do those feel right?"
- DO NOT then repeat and ask about each one individually â€” that's redundant

4. When they confirm, add the goals and move on to prompt for missing areas

GOAL WRITING STYLE (apply when adding the goal):
- Make goals specific and actionable
- Start with a verb: "Establish...", "Build...", "Run...", "Learn..."
- Keep them concise: 3-8 words

5. When they confirm, include the marker (it's hidden from display): [GOAL: polished goal text | lifeAreaKey]
   - Just say something brief like "Got it!" or "Added!" â€” the marker is invisible to the user
   - Then immediately prompt for the next missing area or move on
6. Prompt for missing areas: "Got it! What about [Area] â€” what matters to you there?"
7. When all requirements met: "Great! Ready to move on to habits?"

LIFE AREA KEYS for [GOAL] marker:
family, partner, friendships, career, education, recreation, spirituality, community, health, mentalHealth

CRITICAL RULES:
- Be concise â€” don't repeat the same information twice
- The [GOAL: ...] marker is HIDDEN from the user â€” don't write it as visible text
- NEVER mention compass word â€” that's step 6
- After goals complete, NEXT step is HABITS (step 2)`;
          }
          
          // For step 2: Habits
          if (onboardingStep === 2) {
            const habitsWithAreas = weeklyHabits.filter(h => h.lifeArea);
            const coveredAreas = focusAreas.filter(a => weeklyHabits.some(h => h.lifeArea === a));
            const missingAreas = focusAreas.filter(a => !weeklyHabits.some(h => h.lifeArea === a));
            const missingAreaNames = missingAreas.map(k => VLQ_DOMAINS[k]?.name || k);
            
            return `

=== ONBOARDING MODE: HABITS (Step 2 of 7) ===
Help the user establish habits that support their goals.

REQUIREMENTS:
- Minimum 3 habits total
- At least one habit for EACH focus area: ${focusAreaNames.join(', ')}

CURRENT PROGRESS:
- Total habits: ${weeklyHabits.length}/3 minimum
- Focus areas covered: ${coveredAreas.length}/${focusAreas.length}
${missingAreas.length > 0 ? `- STILL NEEDED: Habits for ${missingAreaNames.join(', ')}` : '- All focus areas covered! âœ“'}

YOUR APPROACH:
1. Listen to what the user shares about habits or routines they want to build
2. Identify which life area it supports
3. Ask about frequency: "That sounds like a [Life Area] habit â€” how many times a week?"
4. When they give a frequency, confirm and add the habit

IMPORTANT: Daily habits are just habits with frequency 7. Don't ask about "daily vs weekly" â€” just ask how many times per week. If they say "daily" or "every day", that's frequency 7.

HABIT WRITING STYLE:
- Keep habits simple and specific (2-5 words)
- Use present tense action words
- Make them trackable/completable

EXAMPLES:
- "I want to go to the gym" â†’ "Physical Health habit â€” how many times a week?" â†’ "3" â†’ [WEEKLY_HABIT: Go to the gym | 3 | health]
- "I want to walk 10K steps daily" â†’ [WEEKLY_HABIT: Walk 10K steps | 7 | health]
- "Call my parents" â†’ "Family habit â€” how often?" â†’ "once a week" â†’ [WEEKLY_HABIT: Call parents | 1 | family]

5. Include the marker (hidden): [WEEKLY_HABIT: habit text | frequency | lifeAreaKey]
   - Just say "Got it!" â€” the marker is invisible to the user
6. Prompt for missing areas: "Got it! What about [Area]?"
7. When complete: "Great! Ready to add any events to your year?"

CRITICAL RULES:
- NEVER ask about "daily habits vs weekly habits" â€” all habits are weekly with frequency 1-7
- The [WEEKLY_HABIT: ...] marker is HIDDEN from the user
- NEVER mention compass word â€” that's step 6
- After habits complete, NEXT step is EVENTS (step 3)`;
          }
          
          // Default for other steps
          return `

=== ONBOARDING MODE: Step ${onboardingStep} of 7 ===
Guide the user through their onboarding journey. Be encouraging and help them make progress.

${onboardingStep < 6 ? `CRITICAL: Do NOT discuss or suggest a compass word. That happens at step 6, after the Life Map.` : ''}`;
        };

        return `You are Tend, a thoughtful AI companion for intentional living and life design. You help people design their year with intention â€” not just survive, but live intentionally and mindfully.

Your personality:
- Warm, calm, and grounded â€” like a wise friend
- You ask thoughtful questions rather than give prescriptive advice
- You're concise â€” 2-4 sentences is often enough, occasionally more for important moments
- You use gentle emphasis with *italics* for key words (use asterisks for italics)
- You avoid bullet points in conversation â€” speak naturally

Current context:
- The user is designing their 2026
- Current view: ${centerView}
- Current sidebar tab: ${activeTab}
- Current season: ${currentSeason}
- Their year theme: ${yearTheme || 'not set yet'}
- Their values: ${values.length > 0 ? values.join(', ') : 'not identified yet'}
- Life areas (from VLQ): ${lifeAreasContext}
- Their goals: ${goals.length > 0 ? goals.map(g => `${g.text}${g.lifeArea ? ` (${VLQ_DOMAINS[g.lifeArea]?.name || g.lifeArea})` : ''}`).join(', ') : 'none yet'}
- Their events: ${events.length > 0 ? events.map(e => `${MONTHS[e.month]}: ${e.title}`).join(', ') : 'none yet'}
- Weekly habits: ${weeklyHabits.length > 0 ? weeklyHabits.map(h => `${h.text} (${h.frequency}x/week)${h.lifeArea ? ` [${VLQ_DOMAINS[h.lifeArea]?.name || h.lifeArea}]` : ''}`).join(', ') : 'none yet'}
- Daily habits: ${dailyHabits.length > 0 ? dailyHabits.map(h => h.text).join(', ') : 'none yet'}
- Phase: ${phase} (explore = getting to know them, ground = understanding commitments, reveal = unlocking the app, plan = ongoing planning)
- Conversation length: ${messages.length} messages so far
${getMisalignments()}
${getOnboardingContext()}

The user has already completed the VLQ (Valued Living Questionnaire) assessment. You know their values - use this knowledge to personalize your guidance.

COMPASS WORD (THEME):
${yearTheme ? `Their compass word is "${yearTheme}". Reference it naturally when relevant â€” help them see how their actions connect to this guiding word.` : 
(!onboardingCompleted && onboardingStep && onboardingStep < 6) ? 
`They don't have a compass word yet. IMPORTANT: DO NOT discuss, mention, or suggest compass words right now. The user is in onboarding step ${onboardingStep} of 7. Compass word selection happens at step 6, AFTER the Life Map. Stay focused on the current step only.` :
`They don't have a compass word yet. If they choose to chat with you about their values:
1. Explore their VLQ results naturally â€” ask about growth areas, what's been getting in the way, what they want more of
2. After 3-5 exchanges, suggest a compass word: "Based on what you've shared, your compass word might be *[word]*..."
3. When they accept, include [YEAR_THEME: word] at the END of your response
4. Don't force it â€” if they want to do other things first, that's fine`}

SETTING THE YEAR THEME:
${(!onboardingCompleted && onboardingStep && onboardingStep < 6) ? `DO NOT set a year theme during onboarding steps 1-5. This happens at step 6.` : `When the user accepts a theme word, include this marker at the END:
[YEAR_THEME: word]

Examples:
- User says "yes, I love that" â†’ end with [YEAR_THEME: foundation]
- User says "my word is growth" â†’ end with [YEAR_THEME: growth]

Do NOT include if you're just suggesting and waiting for response.`}

EXTRACTING HABITS, EVENTS, GOALS, AND INTENTIONS:
When the user commits to something specific, include the appropriate marker at the END (hidden from user):

For GOALS: [GOAL: goal text | lifeArea]
Example: [GOAL: Run a 5K | health]
Life areas: family, partner, friendships, career, education, recreation, spirituality, community, health, mentalHealth

For WEEKLY habits: [WEEKLY_HABIT: habit text | frequency | lifeArea]
Example: [WEEKLY_HABIT: exercise | 3 | health]

For DAILY habits: [DAILY_HABIT: habit text]
Example: [DAILY_HABIT: morning meditation]

For EVENTS: [EVENT: descriptive title | month | life_area | event_type]
- Title should be SPECIFIC (never generic like "event")
- Month: 0-11 (0=January)
- Life area: family, partner, friendships, career, education, recreation, spirituality, community, health, finances, growth, fun
- Event type: trip, celebration, project, personal
Examples:
[EVENT: Move to Colorado | 5 | personal | project]
[EVENT: Japan trip | 3 | fun | trip]

For SEASON INTENTIONS: [SEASON: season | intention]
Example: [SEASON: winter | rest and reflection]

Only include markers when user has clearly committed, not for vague ideas.

CURRENT VIEW: ${centerView.toUpperCase()}
${centerView === 'year' ? `
You're on the YEAR view. ${yearTheme ? `Their theme word is "${yearTheme}". If this is a returning user, offer the three paths (Seasons, Events, Rhythms) and ask what they want to explore. Help them see how their year could unfold around this theme.` : `Focus on discovering their theme word through conversation. Don't ask directly - explore their VLQ results and what they want from the year, then suggest a word.`}
` : ''}${centerView === 'seasons' ? `
You're on the SEASONS view. Help them think about what each season could feel like and hold for them. Ask about:
- What's already planned for each season?
- How do they want each season to feel?
- Are there natural rhythms they want to honor (rest in winter, growth in spring, adventure in summer, harvest in fall)?
` : ''}${centerView === 'monthly' ? `
You're on the MONTHLY view. Help them plan specific events and commitments. Ask about:
- What trips, events, or milestones are coming up?
- Are there months that feel too full or too empty?
- What needs to be scheduled to honor their values?
` : ''}${centerView === 'weekly' ? `
You're on the WEEKLY view. Help them establish weekly rhythms and recurring commitments. Ask about:
- What weekly habits would support their values? (exercise, date nights, creative time, rest)
- What's a realistic frequency for each?
- How can they protect time for what matters?
` : ''}${centerView === 'daily' ? `
You're on the DAILY view. Help them identify small daily habits that compound over time. Ask about:
- What tiny habits would make the biggest difference?
- What do they want their mornings or evenings to look like?
- What daily practice would support their theme word?
` : ''}
If they mention specific events, habits, or plans, acknowledge those and help them think through the details. When they COMMIT to something specific (not just considering it), use the appropriate marker to add it to their plan automatically.
If they seem stuck, offer a gentle prompt or example.
If you notice a misalignment between their VLQ values (high importance areas) and their actual plans, gently bring it up.

Remember: You can add things to their plan automatically using markers. When they say "I want to exercise 3 times a week", add [WEEKLY_HABIT: exercise | 3]. When they commit to "a trip to Hawaii in June", add [EVENT: Hawaii trip | 5 | fun | trip]. When they mention "we're moving to Colorado in June", add [EVENT: Move to Colorado | 5 | personal | project]. Always use SPECIFIC, DESCRIPTIVE titles - never generic names like "event" or "thing". This makes the conversation feel magical â€” they talk, and things appear in their plan.

Keep responses focused and conversational. You're not a productivity app â€” you're helping them live with more intention.

NAVIGATION SYSTEM:
You are not just a chat assistant â€” you ARE the app's guide. You can navigate users to different parts of the app and help them do things through conversation.

CATEGORY 1 - Dual Input (Chat OR Direct):
These can be done through chat OR directly in the app tabs. User's choice.
- Goals, Events, Habits: User can tell you about them (you add via markers) OR add directly in tabs
- When suggesting these, offer both options with a button:
  "I've added that goal! You can keep telling me more, or add them directly in the Goals tab."
  [BUTTON: Take me to Goals | goals]

CATEGORY 2 - Experience Required (You Navigate):
These REQUIRE the user to interact with the UI directly. Navigate them there.
- Gardener Quiz: "Let me take you to discover your gardener type!" [NAVIGATE: quiz]
- Life Map: "Let me show you your Life Map where you can tell me about your life visually." [NAVIGATE: life map]  
- Journal Mode: "I'll take you to journal mode â€” a quieter space for reflection." [NAVIGATE: journal]

HOW TO USE:
- [BUTTON: Label | action] - Shows a clickable button in your message (for Category 1)
- [NAVIGATE: destination] - Auto-navigates the user (for Category 2, chat minimizes)

Valid destinations: goals, events, notes, plan, journal, insights, life map, quiz, tendy

When user says "what can I do?" or seems lost, offer options warmly:
"We could:
â€¢ Talk about goals you're working toward
â€¢ Build out your Life Map (I can take you there)
â€¢ Take the gardener personality quiz (it's fun!)
â€¢ Generate a daily tend
â€¢ Or just chat â€” what's on your mind?"`;
      };

      // Call Claude API
      const callClaudeAPI = async (userMessage, pendingState = {}) => {
        if (!apiKey) {
          return "I'd love to help you plan, but I need an API key to think deeply. Click the âš™ settings icon to add your Anthropic API key.";
        }

        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 500,
              system: getTendSystemPrompt(pendingState),
              messages: [
                ...messages.map(m => ({
                  role: m.role === 'assistant' ? 'assistant' : 'user',
                  content: m.content.replace(/<[^>]*>/g, '') // Strip HTML for API
                })),
                { role: 'user', content: userMessage }
              ]
            })
          });

          if (!response.ok) {
            const error = await response.json();
            console.error('API Error:', error);
            if (response.status === 401) {
              return "That API key doesn't seem to be working. Check your key in settings (âš™).";
            }
            return "Something went wrong connecting to Claude. Try again?";
          }

          const data = await response.json();
          return data.content[0].text;
        } catch (error) {
          console.error('Fetch error:', error);
          return "I couldn't connect to Claude. Check your internet connection and try again.";
        }
      };

      // Switch to a past chat
      const switchToChat = (chatId) => {
        // Save current chat to history first if it has messages
        if (messages.length > 1) {
          const currentChat = {
            id: currentChatId,
            messages: messages,
            createdAt: new Date().toISOString(),
            title: generateChatTitle(messages)
          };
          setChatHistory(prev => {
            // Remove if already exists, then add to front
            const filtered = prev.filter(c => c.id !== currentChatId);
            return [currentChat, ...filtered].slice(0, 50);
          });
        }
        
        // Load the selected chat
        const chat = chatHistory.find(c => c.id === chatId);
        if (chat) {
          setMessages(chat.messages);
          setCurrentChatId(chat.id);
          setShowChatHistory(false);
          setTimeout(() => scrollChatToBottom(), 100);
        }
      };

      // Start a new chat
      const startNewChat = () => {
        // Save current chat to history first if it has messages
        if (messages.length > 1) {
          const currentChat = {
            id: currentChatId,
            messages: messages,
            createdAt: new Date().toISOString(),
            title: generateChatTitle(messages)
          };
          setChatHistory(prev => {
            const filtered = prev.filter(c => c.id !== currentChatId);
            return [currentChat, ...filtered].slice(0, 50);
          });
        }
        
        // Reset for new chat
        setCurrentChatId(Date.now().toString());
        setSessionGreeted(false); // This will trigger a new greeting
        setMessages([]);
        setExchangeCount(0);
        setShowChatHistory(false);
      };

      // Handle navigation from chat buttons and NAVIGATE tags
      const handleChatNavigation = (action) => {
        const actionLower = action.toLowerCase().trim();
        
        // Handle "set compass X" pattern
        if (actionLower.startsWith('set compass ')) {
          const word = action.substring(12).trim();
          setYearTheme(word.charAt(0).toUpperCase() + word.slice(1).toLowerCase());
          if (!onboardingCompleted && onboardingStep === 6) {
            setOnboardingStep(7);
            setSessionGreeted(false); // Trigger new greeting for next step
          }
          return;
        }
        
        // Handle "suggest compass" - user wants to suggest their own word
        if (actionLower === 'suggest compass') {
          const assistantMsg = {
            role: 'assistant',
            content: `What word feels right to you? Type a single word that could guide your year â€” like "growth", "balance", "courage", or "joy".`,
            timestamp: new Date().toISOString()
          };
          setMessages(prev => [...prev, assistantMsg]);
          setTimeout(() => scrollChatToBottom(), 100);
          return;
        }
        
        // Handle "next step" - advance to next onboarding step
        if (actionLower === 'next step') {
          if (!onboardingCompleted && onboardingStep && onboardingStep < 7) {
            setOnboardingStep(prev => prev + 1);
            setSessionGreeted(false); // Trigger new greeting for next step
          }
          return;
        }
        
        // Handle "add event" - show event modal
        if (actionLower === 'add event') {
          setShowEventModal(true);
          return;
        }
        
        // Map actions to navigation
        const navigationMap = {
          'goals': () => { setActiveTab('lifeareas'); setSidebarExpanded(true); setShowGoalModal(true); },
          'habits': () => { setCenterView(CENTER_VIEWS.WEEKLY); },
          'weekly habits': () => { setCenterView(CENTER_VIEWS.WEEKLY); },
          'events': () => { setActiveTab('events'); setSidebarExpanded(true); },
          'lifeareas': () => { setActiveTab('lifeareas'); setSidebarExpanded(true); },
          'life areas': () => { setActiveTab('lifeareas'); setSidebarExpanded(true); },
          'notes': () => { setActiveTab('lifeareas'); setSidebarExpanded(true); },
          'plan': () => setAppMode('plan'),
          'design': () => setAppMode('plan'),
          'plan & design': () => setAppMode('plan'),
          'journal': () => setAppMode('journal'),
          'insights': () => setAppMode('insights'),
          'life map': () => setAppMode('insights'),
          'lifemap': () => setAppMode('insights'),
          'quiz': () => setAppMode('insights'),
          'gardener quiz': () => setAppMode('insights'),
          'personality quiz': () => setAppMode('insights'),
          'tendy': () => setAppMode('tendy'),
          'daily tend': () => setAppMode('tendy'),
          'tends': () => setAppMode('tendy'),
        };
        
        const navAction = navigationMap[actionLower];
        if (navAction) {
          navAction();
          // Don't minimize chat for Category 1 (dual-input) actions
          const category2Actions = ['journal', 'insights', 'life map', 'lifemap', 'quiz', 'gardener quiz', 'personality quiz'];
          if (category2Actions.includes(actionLower)) {
            setChatMinimized(true);
          }
        }
      };

      // Handle returning from an experience (Category 2) - add welcome back message
      const handleReturnFromExperience = (fromMode) => {
        setChatMinimized(false);
        setAppMode(null);
        
        // Add a welcome back message based on where they were
        const welcomeMessages = {
          'journal': `Welcome back from journaling! ðŸ““

How did that feel? Is there anything you want to explore or work on next?

[BUTTON: Generate a daily tend | tendy]
[BUTTON: Let's talk about goals | goals]
[BUTTON: Show me the Life Map | life map]`,
          'insights': `Welcome back! ðŸ—ºï¸

Did you discover anything interesting? Where would you like to go next?

[BUTTON: Generate a daily tend | tendy]
[BUTTON: Let's talk about goals | goals]
[BUTTON: Go to journal | journal]`,
          'tendy': `Welcome back! ðŸŒ±

How did your tends go? What would you like to explore next?

[BUTTON: Let's talk about goals | goals]
[BUTTON: Show me the Life Map | life map]
[BUTTON: Go to journal | journal]`,
        };
        
        const message = welcomeMessages[fromMode];
        if (message) {
          setMessages(prev => [...prev, { role: 'assistant', content: message }]);
        }
      };

      const handleSendMessage = async () => {
        if (!inputValue.trim()) return;
        
        const userMessage = inputValue.trim();
        setMessages(prev => [...prev, { 
          role: 'user', 
          content: userMessage,
          timestamp: new Date().toISOString()
        }]);
        setInputValue('');
        setIsTyping(true);
        setExchangeCount(prev => prev + 1);

        // Handle life areas mode - parse numbers
        let pendingLifeAreaUpdate = null;
        let pendingNextAreaIndex = currentLifeAreaIndex;
        let pendingWaitingForSatisfaction = waitingForSatisfaction;
        let pendingIsLastResponse = false;
        
        if (lifeAreasMode) {
          const numbers = userMessage.match(/\b([1-9]|10)\b/g);
          if (numbers && numbers.length > 0) {
            const score = parseInt(numbers[0]);
            const currentArea = lifeAreaOrder[currentLifeAreaIndex];
            
            if (waitingForSatisfaction) {
              pendingLifeAreaUpdate = { area: currentArea, field: 'satisfaction', score };
              setLifeAreaRatings(prev => ({
                ...prev,
                [currentArea]: { ...prev[currentArea], satisfaction: score }
              }));
              setWaitingForSatisfaction(false);
              pendingWaitingForSatisfaction = false;
            } else {
              pendingLifeAreaUpdate = { area: currentArea, field: 'intention', score };
              setLifeAreaRatings(prev => ({
                ...prev,
                [currentArea]: { ...prev[currentArea], intention: score }
              }));
              
              // Move to next area
              if (currentLifeAreaIndex < lifeAreaOrder.length - 1) {
                setCurrentLifeAreaIndex(prev => prev + 1);
                setWaitingForSatisfaction(true);
                pendingNextAreaIndex = currentLifeAreaIndex + 1;
                pendingWaitingForSatisfaction = true;
              } else {
                // This is the final area - flag for summary, then complete
                setIsLastLifeAreaResponse(true);
                pendingIsLastResponse = true;
              }
            }
          }
        }

        // Analyze for values/events even with API
        const detected = analyzeText(userMessage);
        processAnalysis(detected);
        
        // Parse events from message
        const foundEvents = parseEvents(userMessage);
        if (foundEvents.length > 0 && phase === PHASES.GROUND) {
          const newEvents = foundEvents.map((e, i) => ({
            id: Date.now() + i,
            title: `Event in ${MONTHS[e.month]}`,
            month: e.month,
            lifeArea: 'fun',
            details: { flights: '', stays: '', activities: '', notes: '' },
          }));
          setEvents(prev => [...prev, ...newEvents]);
        }

        // Note: Year theme is now primarily set by Claude using [YEAR_THEME: word] marker
        // This is a minimal fallback for very explicit user statements
        if (!yearTheme) {
          const explicitThemeMatch = userMessage.match(/(?:my word|my theme)(?:\s+for\s+(?:the\s+year|\d{4}))?\s+is\s+([a-z]{4,15})(?:\s|$|[.,!?])/i);
          if (explicitThemeMatch && explicitThemeMatch[1]) {
            const word = explicitThemeMatch[1].toLowerCase();
            const commonWords = ['that', 'this', 'with', 'would', 'could', 'think', 'want', 'like', 'year', 'maybe', 'something'];
            if (!commonWords.includes(word)) {
              setYearTheme(word);
              console.log('Year theme set from explicit statement (fallback):', word);
            }
          }
        }

        // Progress phases based on exchange count
        if (phase === PHASES.EXPLORE && exchangeCount >= 2) {
          setPhase(PHASES.GROUND);
        }
        if (phase === PHASES.GROUND && exchangeCount >= 3 && !revealed) {
          setPhase(PHASES.REVEAL);
          setRevealed(true);
          // Start life areas mode - Claude will handle the transition naturally via system prompt
          if (!lifeAreasCompleted) {
            setLifeAreasMode(true);
          }
        }

        // Get response from Claude API
        let response = await callClaudeAPI(userMessage, {
          pendingLifeAreaUpdate,
          pendingNextAreaIndex,
          pendingWaitingForSatisfaction,
          pendingIsLastResponse
        });
        
        // Parse for year theme marker from Claude's response
        const themeMatch = response.match(/\[YEAR_THEME:\s*([a-zA-Z]{4,15})\]/);
        if (themeMatch && themeMatch[1]) {
          const newTheme = themeMatch[1].toLowerCase();
          setYearTheme(newTheme);
          console.log('Year theme set by Claude:', newTheme);
          
          // Add a follow-up "what's next" message after a brief delay
          setTimeout(() => {
            setMessages(prev => [...prev, {
              role: 'assistant',
              content: `Your compass is set! âœ¨ <em>${newTheme}</em> will guide you this year.

Where would you like to go from here?

[BUTTON: Generate a daily tend | tendy]
[BUTTON: Let's talk about goals | goals]
[BUTTON: Show me the Life Map | life map]
[BUTTON: Take the gardener quiz | quiz]
[BUTTON: Go to journal | journal]`
            }]);
          }, 800);
        }
        
        // Parse for weekly habits: [WEEKLY_HABIT: habit text | frequency] or [WEEKLY_HABIT: habit text | frequency | lifeArea]
        const weeklyHabitMatches = response.matchAll(/\[WEEKLY_HABIT:\s*([^|]+)\s*\|\s*(\d+)(?:\s*\|\s*([a-zA-Z]+))?\]/g);
        for (const match of weeklyHabitMatches) {
          const habitText = match[1].trim();
          const frequency = parseInt(match[2]);
          const lifeArea = match[3]?.trim() || '';
          if (habitText && frequency >= 1 && frequency <= 7) {
            setWeeklyHabits(prev => {
              // Don't add duplicates
              if (prev.some(h => h.text.toLowerCase() === habitText.toLowerCase())) return prev;
              console.log('Weekly habit added by Claude:', habitText, frequency + 'x/week', lifeArea ? `[${lifeArea}]` : '');
              return [...prev, { 
                id: generateId(), 
                text: habitText, 
                frequency,
                lifeArea: lifeArea || undefined,
                color: lifeArea && VLQ_DOMAINS[lifeArea]?.color ? VLQ_DOMAINS[lifeArea].color : ['#7EB3E0', '#8FD4A0', '#F9D07A', '#E8A090', '#B8A9C9'][prev.length % 5]
              }];
            });
          }
        }
        
        // Parse for goals: [GOAL: goal text | lifeArea]
        const goalMatches = response.matchAll(/\[GOAL:\s*([^|]+)\s*\|\s*([a-zA-Z]+)\]/g);
        for (const match of goalMatches) {
          const goalText = match[1].trim();
          const lifeArea = match[2].trim();
          if (goalText && lifeArea) {
            setGoals(prev => {
              // Don't add duplicates
              if (prev.some(g => g.text.toLowerCase() === goalText.toLowerCase())) return prev;
              console.log('Goal added by Claude:', goalText, `[${lifeArea}]`);
              return [...prev, { 
                id: generateId(), 
                text: goalText, 
                lifeArea: lifeArea,
                completed: false
              }];
            });
          }
        }
        
        // Parse for daily habits: [DAILY_HABIT: habit text]
        const dailyHabitMatches = response.matchAll(/\[DAILY_HABIT:\s*([^\]]+)\]/g);
        for (const match of dailyHabitMatches) {
          const habitText = match[1].trim();
          if (habitText) {
            setDailyHabits(prev => {
              // Don't add duplicates
              if (prev.some(h => h.text.toLowerCase() === habitText.toLowerCase())) return prev;
              console.log('Daily habit added by Claude:', habitText);
              return [...prev, { id: generateId(), text: habitText }];
            });
          }
        }
        
        // Parse for events: [EVENT: title | month | life_area | event_type]
        // event_type is optional for backward compatibility
        const eventMatches = response.matchAll(/\[EVENT:\s*([^|]+)\s*\|\s*(\d+)\s*\|\s*([a-z]+)(?:\s*\|\s*([a-z]+))?\]/g);
        for (const match of eventMatches) {
          const title = match[1].trim();
          const month = parseInt(match[2]);
          const lifeArea = match[3].trim();
          const eventType = match[4]?.trim() || 'personal';
          const validTypes = ['trip', 'celebration', 'project', 'personal'];
          if (title && month >= 0 && month <= 11) {
            setEvents(prev => {
              // Don't add duplicates (by title)
              if (prev.some(e => e.title.toLowerCase() === title.toLowerCase())) return prev;
              console.log('Event added by Claude:', title, 'in month', month, 'type:', eventType);
              return [...prev, { 
                id: generateId(), 
                title, 
                month, 
                type: validTypes.includes(eventType) ? eventType : 'personal',
                lifeArea: VLQ_ORDER.includes(lifeArea) ? lifeArea : 'fun',
                details: { flights: '', stays: '', activities: '', notes: '' },
                relatedGoals: [],
                createdAt: new Date().toISOString()
              }];
            });
          }
        }
        
        // Parse for season intentions: [SEASON: season | intention]
        const seasonMatches = response.matchAll(/\[SEASON:\s*(winter|spring|summer|fall)\s*\|\s*([^\]]+)\]/g);
        for (const match of seasonMatches) {
          const season = match[1].toLowerCase();
          const intention = match[2].trim();
          if (season && intention) {
            setSeasonIntentions(prev => {
              console.log('Season intention set by Claude:', season, '-', intention);
              return { ...prev, [season]: intention };
            });
          }
        }
        
        // Process NAVIGATE tags (auto-navigation for Category 2 experiences)
        const navigateMatch = response.match(/\[NAVIGATE:\s*([^\]]+)\]/);
        if (navigateMatch) {
          const navTarget = navigateMatch[1].trim();
          // Delay navigation slightly so user sees the message first
          setTimeout(() => {
            handleChatNavigation(navTarget);
          }, 500);
        }
        
        // Remove all markers from displayed response (buttons handled by ChatMessage)
        response = response
          .replace(/\[YEAR_THEME:\s*[a-zA-Z]{4,15}\]/g, '')
          .replace(/\[GOAL:\s*[^\]]+\]/g, '')
          .replace(/\[WEEKLY_HABIT:\s*[^\]]+\]/g, '')
          .replace(/\[DAILY_HABIT:\s*[^\]]+\]/g, '')
          .replace(/\[EVENT:\s*[^\]]+\]/g, '')
          .replace(/\[SEASON:\s*[^\]]+\]/g, '')
          .replace(/\[NAVIGATE:\s*[^\]]+\]/g, '')
          .trim();
        
        setMessages(prev => [...prev, { 
          role: 'assistant', 
          content: response,
          timestamp: new Date().toISOString()
        }]);
        setIsTyping(false);
        
        // Save onboarding conversation periodically (when goals/habits are added)
        if (currentConversationType === 'onboarding' && !onboardingCompleted) {
          // Debounced save - let state settle first
          setTimeout(() => {
            saveCurrentConversation();
          }, 1000);
        }
        
        // Complete life areas after the summary response
        if (isLastLifeAreaResponse || pendingIsLastResponse) {
          setLifeAreasCompleted(true);
          setLifeAreasMode(false);
          setIsLastLifeAreaResponse(false);
        }
      };

      const handleSkip = () => {
        setPhase(PHASES.PLAN);
        setRevealed(true);
        setMessages(prev => [...prev, {
          role: 'assistant',
          content: `No problem â€” let's dive in.

Use the view switcher to explore your year. Add events, set season intentions, and plan the details.

I'm here to help with any planning.`
        }]);
      };

      const handleAddEvent = (eventData) => {
        setEvents(prev => [...prev, { 
          ...eventData, 
          id: generateId(),
          type: eventData.type || 'personal',
          location: '',
          startDate: '',
          endDate: '',
          budget: { estimated: 0, spent: 0 },
          sections: {
            logistics: { tasks: [], notes: '', chatHistory: [] },
            activities: { tasks: [], notes: '', chatHistory: [] },
            preparation: { tasks: [], notes: '', chatHistory: [] },
            budget: { tasks: [], notes: '', chatHistory: [] }
          },
          details: { flights: '', stays: '', activities: '', notes: '' },
          relatedGoals: [],
          createdAt: new Date().toISOString()
        }]);
        setShowEventModal(false);
      };

      const handleUpdateEventDetails = (eventId, field, value) => {
        setEvents(prev => prev.map(e => 
          e.id === eventId ? { ...e, details: { ...e.details, [field]: value } } : e
        ));
      };

      const handleAddGoal = (goalData) => {
        // OPTION B: Add relationship mapping fields
        setGoals(prev => [...prev, { 
          ...goalData, 
          id: Date.now(), 
          completed: false,
          relatedEvents: [], // Track which events support this goal
          createdAt: new Date().toISOString()
        }]);
        setShowGoalModal(false);
      };

      const handleVlqComplete = () => {
        setVlqCompleted(true);
        setRevealed(true);
        // Pre-fill values based on high-importance domains
        const highImportance = VLQ_ORDER
          .filter(key => vlqScores[key]?.importance >= 7)
          .map(key => VLQ_DOMAINS[key].name.split(' ')[0]);
        if (highImportance.length > 0) {
          setValues(highImportance.slice(0, 3));
        }
        
        // Immediately trigger onboarding greeting for new users
        // This ensures the greeting shows right after VLQ without waiting for effect
        const focusAreas = getFocusAreas();
        const focusAreaNames = focusAreas.map(k => VLQ_DOMAINS[k].name).slice(0, 3);
        
        const welcomeMessage = `Welcome to Tend! ðŸŒ± I'm here to help you design your year with intention.

Based on your values assessment, ${focusAreaNames.length > 0 ? `you want to focus on growing in: <strong>${focusAreaNames.join('</strong>, <strong>')}</strong>` : 'there are areas where you want to grow'}.

Let's start by setting <strong>at least 3 goals</strong>${focusAreaNames.length > 0 ? ` â€” and make sure at least one goal covers each of your focus areas` : ''}.

I've opened the Life Areas panel where your goals will appear. What's something you'd love to accomplish this year?`;
        
        setMessages([{
          role: 'assistant',
          content: welcomeMessage,
          timestamp: new Date().toISOString()
        }]);
        setSessionGreeted(true);
        
        // Open Life Areas panel for goals step
        setActiveTab('lifeareas');
        setSidebarExpanded(true);
      };

      // Mode selection screen
      const modeSelectionScreen = (
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'var(--bg-main)',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        }}>
          <svg width="48" height="48" viewBox="0 0 80 80" fill="none" style={{opacity: 0.7, marginBottom: '1.5rem'}}>
            <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round"/>
            <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <circle cx="40" cy="70" r="4" fill="none" stroke="var(--accent)" strokeWidth="2"/>
          </svg>
          
          {yearTheme && (
            <div style={{
              padding: '1rem 1.5rem',
              backgroundColor: 'var(--accent-light)',
              border: '2px solid var(--accent)',
              borderRadius: '12px',
              marginBottom: '1.5rem',
              textAlign: 'center',
              maxWidth: '320px',
              width: '100%',
            }}>
              <div style={{
                fontSize: '0.7rem',
                textTransform: 'uppercase',
                letterSpacing: '0.1em',
                color: 'var(--text-muted)',
                marginBottom: '0.25rem',
              }}>
                Your Word for {new Date().getFullYear()}
              </div>
              <div style={{
                fontFamily: "'Fraunces', serif",
                fontSize: '1.75rem',
                color: 'var(--accent)',
                fontWeight: 500,
              }}>
                {yearTheme}
              </div>
            </div>
          )}
          
          <h2 style={{
            fontFamily: "'Fraunces', serif",
            fontSize: '1.5rem',
            color: 'var(--text)',
            marginBottom: '0.5rem',
            fontWeight: 400,
          }}>
            {yearTheme ? `Welcome back` : 'Welcome'}
          </h2>
          <p style={{
            color: 'var(--text-muted)',
            fontSize: '0.95rem',
            marginBottom: '2rem',
          }}>
            What would you like to do today?
          </p>

          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '1rem',
            width: '100%',
            maxWidth: '320px',
          }}>
            {/* Tendies - Featured option */}
            <button
              onClick={() => setAppMode('tendy')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--accent-light)',
                border: '2px solid var(--accent)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>ðŸŒ±</span>
                <div style={{flex: 1}}>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Daily Tend</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>One small action aligned with your values</div>
                </div>
                {tendyPoints > 0 && (
                  <div style={{
                    backgroundColor: 'var(--accent)',
                    color: 'white',
                    fontSize: '0.7rem',
                    padding: '0.25rem 0.5rem',
                    borderRadius: '10px',
                    fontWeight: 500,
                  }}>
                    {tendyPoints} pts
                  </div>
                )}
              </div>
            </button>

            <button
              onClick={() => setAppMode('journal')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>ðŸ“</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Journal Mode</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>Reflect on your day</div>
                </div>
              </div>
            </button>

            <button
              onClick={() => setAppMode('insights')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>ðŸ“Š</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Your Insights</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>See your trends and progress</div>
                </div>
              </div>
            </button>

            <button
              onClick={() => setAppMode('plan')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>ðŸ—“ï¸</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Plan & Design Mode</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>Shape your year</div>
                </div>
              </div>
            </button>
          </div>
        </div>
      );

      // Show loading icon for minimum time
      if (showLoadingIcon || authLoading) {
        return loadingScreen;
      }

      // Show auth screen if not logged in
      if (!user) {
        return <AuthModal onSuccess={() => {}} />;
      }

      // Wait for user data to load from Firebase before deciding what to show
      if (!dataLoaded) {
        return loadingScreen;
      }

      // Show VLQ assessment first (new users)
      if (!vlqCompleted) {
        return (
          <VLQAssessment
            vlqScores={vlqScores}
            setVlqScores={setVlqScores}
            vlqStep={vlqStep}
            setVlqStep={setVlqStep}
            onComplete={handleVlqComplete}
          />
        );
      }

      // Journal mode
      if (appMode === 'journal') {
        return (
          <>
            <JournalView 
              yearTheme={yearTheme}
              vlqScores={vlqScores}
              journalEntries={journalEntries}
              setJournalEntries={setJournalEntries}
              monthlyReviews={monthlyReviews}
              setMonthlyReviews={setMonthlyReviews}
              yearlyReflections={yearlyReflections}
              setYearlyReflections={setYearlyReflections}
              todaysTendies={todaysTendies}
              tendyHistory={tendyHistory}
              flexPoints={flexPoints}
              setFlexPoints={setFlexPoints}
              flexPointsTracking={flexPointsTracking}
              setFlexPointsTracking={setFlexPointsTracking}
              goals={goals}
              setAppMode={setAppMode}
              setMessages={setMessages}
              onSwitchMode={() => setAppMode('plan')}
              onBack={() => setAppMode(null)}
            />
            {/* Floating chat bubble for navigation */}
            <div style={{ position: 'fixed', bottom: '1.5rem', right: '1.5rem', zIndex: 1000 }}>
              <button
                onClick={() => handleReturnFromExperience('journal')}
                style={{
                  width: '60px', height: '60px', borderRadius: '50%',
                  backgroundColor: 'var(--accent)', border: 'none',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.2)', cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem',
                }}
                title="Chat with Tend"
              >ðŸ’¬</button>
            </div>
          </>
        );
      }

      // Insights mode
      if (appMode === 'insights') {
        return (
          <>
            <InsightsView
              trends={calculateTrends()}
              vlqScores={vlqScores}
              yearTheme={yearTheme}
              flexPoints={flexPoints}
              userProfile={userProfile}
              setUserProfile={setUserProfile}
              onBack={() => setAppMode(null)}
              apiKey={apiKey}
            />
            {/* Floating chat bubble for navigation */}
            <div style={{ position: 'fixed', bottom: '1.5rem', right: '1.5rem', zIndex: 1000 }}>
              <button
                onClick={() => handleReturnFromExperience('insights')}
                style={{
                  width: '60px', height: '60px', borderRadius: '50%',
                  backgroundColor: 'var(--accent)', border: 'none',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.2)', cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem',
                }}
                title="Chat with Tend"
              >ðŸ’¬</button>
            </div>
          </>
        );
      }

      // Tendy mode
      if (appMode === 'tendy') {
        return (
          <>
            <TendyView
              vlqScores={vlqScores}
              todaysTendies={todaysTendies}
              setTodaysTendies={setTodaysTendies}
              tendyHistory={tendyHistory}
              setTendyHistory={setTendyHistory}
              tendyPoints={tendyPoints}
              setTendyPoints={setTendyPoints}
              tendyStreak={tendyStreak}
              setTendyStreak={setTendyStreak}
              flexPoints={flexPoints}
              setFlexPoints={setFlexPoints}
              weeklyCustomTendy={weeklyCustomTendy}
              setWeeklyCustomTendy={setWeeklyCustomTendy}
              userProfile={userProfile}
              setUserProfile={setUserProfile}
              apiKey={apiKey}
              onBack={() => setAppMode(null)}
              onTendComplete={() => setAppMode('journal')}
            />
            {/* Floating chat bubble for navigation */}
            <div style={{ position: 'fixed', bottom: '1.5rem', right: '1.5rem', zIndex: 1000 }}>
              <button
                onClick={() => handleReturnFromExperience('tendy')}
                style={{
                  width: '60px', height: '60px', borderRadius: '50%',
                  backgroundColor: 'var(--accent)', border: 'none',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.2)', cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem',
                }}
                title="Chat with Tend"
              >ðŸ’¬</button>
            </div>
          </>
        );
      }

      return (
        <div style={styles.container}>
          <header style={styles.header}>
            <div style={styles.logoContainer}>
              <svg width="28" height="28" viewBox="0 0 32 32" fill="none" style={{ marginRight: '8px' }}>
                <path d="M16 26 Q16 18 16 14" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round" fill="none"/>
                <path d="M16 18 Q10 16 8 10 Q14 12 16 18" fill="var(--accent)" opacity="0.5"/>
                <path d="M16 14 Q22 10 24 4 Q18 8 16 14" fill="var(--accent)"/>
                <path d="M16 10 Q14 6 16 2 Q18 6 16 10" fill="var(--accent)" opacity="0.7"/>
              </svg>
              <h1 style={styles.logoText}>tend</h1>
            </div>
            {yearTheme ? (
              <p style={{
                ...styles.tagline,
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem',
              }}>
                <span style={{opacity: 0.7}}>a space for designing your life with intention</span>
                <span style={{
                  padding: '0.25rem 0.75rem',
                  backgroundColor: 'var(--accent-light)',
                  border: '1px solid var(--accent)',
                  borderRadius: '6px',
                  color: 'var(--accent)',
                  fontSize: '0.8rem',
                  fontWeight: 500,
                }}>
                  {new Date().getFullYear()}: {yearTheme}
                </span>
              </p>
            ) : (
              <p style={styles.tagline}>a space for designing your life with intention</p>
            )}
            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
              <button 
                style={{
                  ...styles.settingsButton,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.375rem',
                  fontSize: '0.8rem',
                  padding: '0.375rem 0.75rem',
                  borderRadius: '8px',
                  backgroundColor: 'var(--bg-elevated)',
                  border: '1px solid var(--border)',
                }}
                onClick={() => switchAppMode('tendy')}
                title="Daily Tend"
              >
                ðŸŒ± Daily Tend
              </button>
              <button 
                style={{
                  ...styles.settingsButton,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.375rem',
                  fontSize: '0.8rem',
                  padding: '0.375rem 0.75rem',
                  borderRadius: '8px',
                  backgroundColor: 'var(--bg-elevated)',
                  border: '1px solid var(--border)',
                }}
                onClick={() => switchAppMode('journal')}
                title="Switch to Daily Journal"
              >
                ðŸ“ Journal
              </button>
              <button 
                style={{
                  ...styles.settingsButton,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.375rem',
                  fontSize: '0.8rem',
                  padding: '0.375rem 0.75rem',
                  borderRadius: '8px',
                  backgroundColor: 'var(--bg-elevated)',
                  border: '1px solid var(--border)',
                }}
                onClick={() => switchAppMode('insights')}
                title="Your Insights"
              >
                ðŸ“Š Insights
              </button>
              <button 
                style={styles.settingsButton} 
                onClick={() => setShowSettingsModal(true)}
                title="Settings"
              >
                âš™
              </button>
            </div>
          </header>

          <main style={{...styles.main, gridTemplateColumns: `64px 1fr ${chatMinimized ? '0px' : chatWidth + 'px'}`}}>
            {/* Left Sidebar - Always narrow, just icons */}
            <aside style={{
              ...styles.sidebar,
              width: 64,
              position: 'relative'
            }}>
              <div style={styles.sidebarNav}>
                {[
                  { id: 'events', icon: 'ðŸ“…', label: 'Events' },
                  { id: 'lifeareas', icon: 'ðŸŒ±', label: 'Life Areas' }
                ].map(item => (
                  <button
                    key={item.id}
                    style={{
                      ...styles.sidebarNavItem,
                      backgroundColor: activeTab === item.id && sidebarExpanded ? 'var(--accent-light)' : 'transparent',
                      borderLeft: activeTab === item.id && sidebarExpanded ? '3px solid var(--accent)' : '3px solid transparent'
                    }}
                    onClick={() => {
                      if (activeTab === item.id && sidebarExpanded) {
                        setSidebarExpanded(false);
                      } else {
                        setActiveTab(item.id);
                        setSidebarExpanded(true);
                      }
                    }}
                    title={item.label}
                  >
                    <span style={styles.sidebarNavIcon}>{item.icon}</span>
                  </button>
                ))}
              </div>
            </aside>

            <div style={styles.centerPanel}>
              {/* Onboarding Progress Bar */}
              {!onboardingCompleted && onboardingStep !== null && (
                <OnboardingProgressBar 
                  currentStep={onboardingStep}
                  onStepClick={(step) => {
                    setOnboardingStep(step);
                    setSessionGreeted(false); // Trigger new greeting
                  }}
                  isStepComplete={isStepComplete}
                  getProgress={getOnboardingProgress}
                />
              )}
              
              <div style={styles.viewSwitcher}>
                {[
                  { id: CENTER_VIEWS.YEAR, label: 'Home' },
                  { id: CENTER_VIEWS.SEASONS, label: 'Seasons' },
                  { id: CENTER_VIEWS.MONTHLY, label: 'Monthly' },
                  { id: CENTER_VIEWS.WEEKLY, label: 'Weekly' },
                ].map(view => (
                  <button
                    key={view.id}
                    style={{
                      ...styles.viewButton, 
                      ...(centerView === view.id && !sidebarExpanded && styles.viewButtonActive)
                    }}
                    onClick={() => {
                      setCenterView(view.id);
                      setSidebarExpanded(false); // Close sidebar when switching to a view
                    }}
                  >
                    {view.label}
                  </button>
                ))}
              </div>

              {/* Show sidebar content when expanded, otherwise show regular views */}
              {sidebarExpanded ? (
                <div style={{
                  flex: 1,
                  overflow: 'auto',
                  padding: '0 1rem',
                  maxWidth: '600px',
                  width: '100%',
                  margin: '0 auto'
                }}>
                  {/* Tab header */}
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                    marginBottom: '1rem',
                    paddingBottom: '0.75rem',
                    borderBottom: '1px solid var(--border)'
                  }}>
                    <h2 style={{
                      fontSize: '1.1rem',
                      fontWeight: 600,
                      color: 'var(--text)',
                      margin: 0,
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem'
                    }}>
                      {activeTab === 'events' && 'ðŸ“… Events'}
                      {activeTab === 'lifeareas' && 'ðŸŒ± Life Areas & Goals'}
                    </h2>
                    <button
                      onClick={() => setSidebarExpanded(false)}
                      style={{
                        background: 'none',
                        border: 'none',
                        fontSize: '1.2rem',
                        cursor: 'pointer',
                        color: 'var(--text-muted)',
                        padding: '0.25rem'
                      }}
                    >Ã—</button>
                  </div>
                  
                  {activeTab === 'events' && (
                    <EventsTab
                      events={events}
                      setEvents={setEvents}
                      expandedEvent={expandedEvent}
                      setExpandedEvent={setExpandedEvent}
                      onUpdateDetails={handleUpdateEventDetails}
                      onDelete={(id) => setEvents(events.filter(e => e.id !== id))}
                      onAdd={() => setShowEventModal(true)}
                      revealed={revealed}
                      apiKey={apiKey}
                    />
                  )}
                  {activeTab === 'lifeareas' && (
                    <LifeAreasTab 
                      vlqScores={vlqScores}
                      setVlqScores={setVlqScores}
                      goals={goals}
                      setGoals={setGoals}
                      onReassess={() => { setVlqStep(-1); setVlqCompleted(false); }}
                      onAddGoal={() => setShowGoalModal(true)}
                      revealed={revealed}
                    />
                  )}
                </div>
              ) : (
                <>
                  {centerView === CENTER_VIEWS.YEAR && (
                    <YearCircleView 
                      events={events}
                      revealed={revealed}
                      onAddEvent={() => setShowEventModal(true)}
                      yearTheme={yearTheme}
                      setYearTheme={setYearTheme}
                    />
                  )}
                  {centerView === CENTER_VIEWS.SEASONS && (
                    <SeasonsView 
                      seasonIntentions={seasonIntentions}
                      setSeasonIntentions={setSeasonIntentions}
                      revealed={revealed}
                    />
                  )}
                  {centerView === CENTER_VIEWS.MONTHLY && (
                    <MonthlyView 
                      events={events}
                      selectedMonth={selectedMonth}
                      setSelectedMonth={setSelectedMonth}
                      revealed={revealed}
                      onAddEvent={() => setShowEventModal(true)}
                      weeklyHabits={weeklyHabits}
                      dailyHabits={dailyHabits}
                      habitCompletions={habitCompletions}
                      setHabitCompletions={setHabitCompletions}
                    />
                  )}
                  {centerView === CENTER_VIEWS.WEEKLY && (
                    <WeeklyView 
                      weeklyHabits={weeklyHabits}
                      setWeeklyHabits={setWeeklyHabits}
                      revealed={revealed}
                      focusAreas={getFocusAreas()}
                    />
                  )}
                  {centerView === CENTER_VIEWS.DAILY && (
                    <DailyView 
                      dailyHabits={dailyHabits}
                      setDailyHabits={setDailyHabits}
                      revealed={revealed}
                    />
                  )}

                  <div style={styles.bottomSection}>
                    <div style={styles.vlqSummary}>
                      <div style={styles.vlqSummaryColumn}>
                        <span style={styles.vlqSummaryLabel}>ðŸŒ± Focus on</span>
                        <div style={styles.vlqSummaryItems}>
                          {(() => {
                            const allAreas = VLQ_ORDER.map(key => ({
                              key, 
                              ...VLQ_DOMAINS[key], 
                              importance: vlqScores[key]?.importance || 5,
                              consistency: vlqScores[key]?.consistency || 5,
                              gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)
                            }));
                            // Growth areas: gap >= 2
                            return allAreas
                              .filter(a => a.gap >= 2)
                              .sort((a, b) => b.gap - a.gap)
                              .slice(0, 3)
                              .map(area => (
                                <span key={area.key} style={{...styles.vlqSummaryTag, borderColor: area.color, color: area.color}}>
                                  {area.icon} {area.name.split(' ')[0]}
                                </span>
                              ));
                          })()}
                        </div>
                      </div>
                      <div style={styles.vlqSummaryColumn}>
                        <span style={styles.vlqSummaryLabel}>ðŸ’ª Thriving in</span>
                        <div style={styles.vlqSummaryItems}>
                          {VLQ_ORDER
                            .map(key => ({key, ...VLQ_DOMAINS[key], importance: vlqScores[key]?.importance || 5, consistency: vlqScores[key]?.consistency || 5, gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)}))
                            .filter(a => a.importance >= 6 && a.consistency >= 5 && a.gap < 2)
                            .sort((a, b) => b.consistency - a.consistency)
                            .slice(0, 3)
                            .map(area => (
                              <span key={area.key} style={{...styles.vlqSummaryTag, borderColor: area.color, color: area.color, opacity: 0.8}}>
                                {area.icon} {area.name.split(' ')[0]}
                              </span>
                            ))
                          }
                        </div>
                      </div>
                    </div>
                  </div>
                </>
              )}
            </div>

            {/* Chat Panel - Full or Minimized */}
            {!chatMinimized ? (
              <div style={styles.chatPanel}>
                <div 
                  style={styles.resizeHandle} 
                  onMouseDown={handleMouseDown}
                  title="Drag to resize"
                />
                {/* Chat header with minimize button */}
                <div style={{
                  padding: '0.75rem 1rem',
                  borderBottom: '1px solid var(--border)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  backgroundColor: 'var(--bg-elevated)',
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                    <span style={{ fontSize: '1rem' }}>ðŸ’¬</span>
                    <span style={{ fontSize: '0.85rem', fontWeight: 500, color: 'var(--text)' }}>Tend</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                    {/* New Chat button */}
                    <button
                      onClick={startNewChat}
                      style={{
                        background: 'none',
                        border: 'none',
                        fontSize: '1rem',
                        color: 'var(--text-muted)',
                        cursor: 'pointer',
                        padding: '0.25rem 0.5rem',
                        lineHeight: 1,
                        borderRadius: '4px',
                      }}
                      title="New chat"
                    >
                      âœï¸
                    </button>
                    {/* Chat History button */}
                    <div style={{ position: 'relative' }}>
                      <button
                        onClick={() => setShowChatHistory(!showChatHistory)}
                        style={{
                          background: showChatHistory ? 'var(--bg-main)' : 'none',
                          border: 'none',
                          fontSize: '1rem',
                          color: 'var(--text-muted)',
                          cursor: 'pointer',
                          padding: '0.25rem 0.5rem',
                          lineHeight: 1,
                          borderRadius: '4px',
                        }}
                        title="Chat history"
                      >
                        ðŸ“‹
                      </button>
                      {/* History dropdown */}
                      {showChatHistory && (
                        <div style={{
                          position: 'absolute',
                          top: '100%',
                          right: 0,
                          marginTop: '0.5rem',
                          backgroundColor: 'var(--bg-card)',
                          border: '1px solid var(--border)',
                          borderRadius: '8px',
                          boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                          width: '280px',
                          maxHeight: '400px',
                          overflowY: 'auto',
                          zIndex: 1000,
                        }}>
                          <div style={{
                            padding: '0.75rem 1rem',
                            borderBottom: '1px solid var(--border)',
                            fontWeight: 500,
                            fontSize: '0.85rem',
                            color: 'var(--text)',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                          }}>
                            <span>Past Chats</span>
                            <button
                              onClick={() => setShowChatHistory(false)}
                              style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'var(--text-muted)' }}
                            >âœ•</button>
                          </div>
                          {chatHistory.length === 0 ? (
                            <div style={{ padding: '1rem', color: 'var(--text-muted)', fontSize: '0.85rem', textAlign: 'center' }}>
                              No past chats yet
                            </div>
                          ) : (
                            chatHistory.map(chat => (
                              <button
                                key={chat.id}
                                onClick={() => switchToChat(chat.id)}
                                style={{
                                  display: 'block',
                                  width: '100%',
                                  padding: '0.75rem 1rem',
                                  textAlign: 'left',
                                  background: 'none',
                                  border: 'none',
                                  borderBottom: '1px solid var(--border)',
                                  cursor: 'pointer',
                                  transition: 'background 0.15s',
                                }}
                                onMouseEnter={e => e.target.style.background = 'var(--bg-main)'}
                                onMouseLeave={e => e.target.style.background = 'none'}
                              >
                                <div style={{ fontSize: '0.85rem', color: 'var(--text)', marginBottom: '0.25rem', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {chat.title}
                                </div>
                                <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                                  {new Date(chat.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}
                                </div>
                              </button>
                            ))
                          )}
                        </div>
                      )}
                    </div>
                    {/* Minimize button */}
                    <button
                      onClick={() => setChatMinimized(true)}
                      style={{
                        background: 'none',
                        border: 'none',
                        fontSize: '1.25rem',
                        color: 'var(--text-muted)',
                        cursor: 'pointer',
                        padding: '0.25rem',
                        lineHeight: 1,
                      }}
                      title="Minimize chat"
                    >
                      âˆ’
                    </button>
                  </div>
                </div>
                <div ref={chatContainerRef} style={styles.chatMessages}>
                  {messages.map((msg, idx) => (
                    <ChatMessage 
                      key={idx} 
                      message={msg} 
                      onButtonClick={handleChatNavigation}
                    />
                  ))}
                  {isTyping && <TypingIndicator />}
                  <div ref={messagesEndRef} />
                </div>
                
                <div style={styles.chatInputArea}>
                  {!revealed && phase === PHASES.EXPLORE && (
                    <button style={styles.skipButton} onClick={handleSkip}>Skip to planning â†’</button>
                  )}
                  <div style={styles.inputRow}>
                    <textarea
                      style={styles.chatInput}
                      value={inputValue}
                      onChange={(e) => setInputValue(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                          e.preventDefault();
                          handleSendMessage();
                        }
                      }}
                      placeholder="Say whatever comes to mind..."
                      rows={2}
                    />
                    <button 
                      style={{...styles.sendButton, ...(inputValue.trim() ? {} : styles.sendButtonDisabled)}}
                      onClick={handleSendMessage}
                      disabled={!inputValue.trim()}
                    >â†‘</button>
                  </div>
                </div>
              </div>
            ) : (
              /* Minimized Chat Bubble */
              <div style={{
                position: 'fixed',
                bottom: '1.5rem',
                right: '1.5rem',
                zIndex: 1000,
              }}>
                <button
                  onClick={() => setChatMinimized(false)}
                  style={{
                    width: '60px',
                    height: '60px',
                    borderRadius: '50%',
                    backgroundColor: 'var(--accent)',
                    border: 'none',
                    boxShadow: '0 4px 20px rgba(0,0,0,0.2)',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '1.5rem',
                    transition: 'transform 0.2s, box-shadow 0.2s',
                  }}
                  onMouseOver={(e) => { e.currentTarget.style.transform = 'scale(1.1)'; e.currentTarget.style.boxShadow = '0 6px 25px rgba(0,0,0,0.25)'; }}
                  onMouseOut={(e) => { e.currentTarget.style.transform = 'scale(1)'; e.currentTarget.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)'; }}
                  title="Chat with Tend"
                >
                  ðŸ’¬
                </button>
                <div style={{
                  position: 'absolute',
                  bottom: '-0.25rem',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  fontSize: '0.65rem',
                  color: 'var(--text-muted)',
                  whiteSpace: 'nowrap',
                  marginTop: '0.25rem',
                }}>
                  Chat with Tend
                </div>
              </div>
            )}
          </main>

          {showEventModal && <EventModal onClose={() => setShowEventModal(false)} onAdd={handleAddEvent} />}
          {showGoalModal && <GoalModal onClose={() => setShowGoalModal(false)} onAdd={handleAddGoal} focusAreas={getFocusAreas()} />}
          {showSettingsModal && (
            <SettingsModal 
              apiKey={apiKey} 
              setApiKey={(key) => {
                setApiKey(key);
                localStorage.setItem('tend_api_key', key);
              }} 
              onClose={() => setShowSettingsModal(false)}
              user={user}
              onLogout={handleLogout}
              onDeleteAccount={handleDeleteAccount}
              onOpenAdmin={() => setShowAdminDashboard(true)}
            />
          )}
          {showAdminDashboard && (
            <AdminDashboard
              user={user}
              savedConversations={savedConversations}
              trends={calculateTrends()}
              userProfile={userProfile}
              journalEntries={journalEntries}
              goals={goals}
              events={events}
              todaysTendies={todaysTendies}
              onClose={() => setShowAdminDashboard(false)}
            />
          )}
        </div>
      );
    }

    // ============ JOURNAL VIEW (TABBED) ============
    function JournalView({ 
      yearTheme, 
      vlqScores, 
      journalEntries, 
      setJournalEntries,
      monthlyReviews,
      setMonthlyReviews,
      yearlyReflections,
      setYearlyReflections,
      todaysTendies,
      tendyHistory,
      flexPoints,
      setFlexPoints,
      flexPointsTracking,
      setFlexPointsTracking,
      onSwitchMode, 
      onBack,
      setAppMode,
      setMessages,
      goals
    }) {
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
      
      // Check if it's time for monthly review (last 3 days of month)
      const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
      const daysUntilEndOfMonth = lastDayOfMonth - today.getDate();
      const isMonthlyReviewTime = daysUntilEndOfMonth <= 2;
      const monthlyReviewCompleted = monthlyReviews[currentMonth]?.completed;

      // Generate monthly summary
      const generateMonthlySummary = () => {
        const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const monthEntries = Object.entries(journalEntries).filter(([date]) => {
          const entryDate = new Date(date);
          return entryDate >= firstDayOfMonth && entryDate <= today;
        });
        
        const journalDays = monthEntries.length;
        const completedTends = tendyHistory.filter(t => {
          const tendDate = new Date(t.date);
          return tendDate >= firstDayOfMonth && tendDate <= today && t.completed;
        }).length;
        
        const completedGoals = goals.filter(g => {
          if (!g.completed) return false;
          // Assume completed this month if marked complete (we don't track completion date yet)
          return true;
        }).length;

        return `Hi! It's the end of ${monthName}, and I've prepared a summary of your month:

ðŸ“Š **Your Month in Numbers:**
- You journaled ${journalDays} days this month
- You completed ${completedTends} daily tends
- You achieved ${completedGoals} goals

ðŸŒ± **Areas You Focused On:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const gap = importance - (vlqScores[key]?.consistency || 5);
  return gap >= 2;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No specific focus areas'}

Let's reflect on your month together. What stood out to you most? What are you proud of? What would you like to carry forward into next month?`;
      };

      const startMonthlyReview = () => {
        // Save any previous conversation before starting new one
        saveCurrentConversation();
        
        const summary = generateMonthlySummary();
        setMessages([{
          role: 'assistant',
          content: summary
        }]);
        setCurrentConversationType('monthly_review');
        setMonthlyReviews(prev => ({
          ...prev,
          [currentMonth]: { 
            completed: true, 
            completedAt: new Date().toISOString(),
            conversationId: `monthly_${currentMonth}_${Date.now()}`
          }
        }));
        // Award flex points
        setFlexPoints(flexPoints + 1.5);
        setFlexPointsTracking(prev => ({
          ...prev,
          lastMonthlyReviewMonth: currentMonth
        }));
        // Switch to main view (which shows chat)
        setAppMode(null);
      };

      // Check if it's time for yearly review (last 7 days of December)
      const currentYear = today.getFullYear().toString();
      const isDecember = today.getMonth() === 11;
      const daysUntilEndOfYear = 31 - today.getDate();
      const isYearlyReviewTime = isDecember && daysUntilEndOfYear <= 6;
      const yearlyReviewCompleted = yearlyReflections[currentYear]?.completed;

      // Generate yearly summary
      const generateYearlySummary = () => {
        const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
        const yearEntries = Object.entries(journalEntries).filter(([date]) => {
          const entryDate = new Date(date);
          return entryDate >= firstDayOfYear && entryDate <= today;
        });
        
        const journalDays = yearEntries.length;
        const completedTends = tendyHistory.filter(t => {
          const tendDate = new Date(t.date);
          return tendDate >= firstDayOfYear && tendDate <= today && t.completed;
        }).length;
        
        const completedGoals = goals.filter(g => g.completed).length;

        // Count completed monthly reviews
        const monthsReviewed = Object.keys(monthlyReviews).filter(m => 
          m.startsWith(currentYear) && monthlyReviews[m]?.completed
        ).length;

        return `Hi! As we approach the end of ${currentYear}, I've prepared a reflection on your year:

ðŸŽŠ **Your Year in Numbers:**
- You journaled ${journalDays} days this year
- You completed ${completedTends} daily tends
- You achieved ${completedGoals} goals
- You completed ${monthsReviewed} monthly reflections

ðŸŒ± **Your Growth Areas This Year:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const gap = importance - (vlqScores[key]?.consistency || 5);
  return gap >= 2;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No specific focus areas'}

ðŸ’ª **Your Strengths:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const consistency = vlqScores[key]?.consistency || 5;
  const gap = importance - consistency;
  return importance >= 5 && gap < 3;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No identified strengths'}

This has been your year of growth and intention. What are you most proud of? What did you learn about yourself? As we move into ${parseInt(currentYear) + 1}, what do you want to carry forward, and what do you want to leave behind?`;
      };

      const startYearlyReview = () => {
        // Save any previous conversation before starting new one
        saveCurrentConversation();
        
        const summary = generateYearlySummary();
        setMessages([{
          role: 'assistant',
          content: summary
        }]);
        setCurrentConversationType('yearly_review');
        setYearlyReflections(prev => ({
          ...prev,
          [currentYear]: { 
            completed: true, 
            completedAt: new Date().toISOString(),
            conversationId: `yearly_${currentYear}_${Date.now()}`
          }
        }));
        // Award flex points (2 for yearly)
        setFlexPoints(flexPoints + 2);
        // Switch to main view (which shows chat)
        setAppMode(null);
      };

      const journalStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
        },
        header: {
          padding: '1rem 2rem',
          borderBottom: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        },
        headerLeft: {
          display: 'flex',
          alignItems: 'center',
          gap: '1rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.25rem',
          color: 'var(--text-muted)',
          cursor: 'pointer',
          padding: '0.25rem',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.25rem',
          color: 'var(--text)',
        },
        flexPointsBadge: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          padding: '0.375rem 0.75rem',
          backgroundColor: 'var(--accent-light)',
          border: '1px solid var(--accent)',
          borderRadius: '8px',
          fontSize: '0.8rem',
          color: 'var(--text)',
        },
        switchButton: {
          padding: '0.5rem 1rem',
          backgroundColor: 'var(--bg-elevated)',
          border: '1px solid var(--border)',
          borderRadius: '8px',
          color: 'var(--text-muted)',
          fontSize: '0.8rem',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        content: {
          flex: 1,
          padding: '2rem',
          maxWidth: '600px',
          margin: '0 auto',
          width: '100%',
        },
        reviewPrompt: {
          padding: '1.5rem',
          backgroundColor: 'var(--accent-light)',
          border: '2px solid var(--accent)',
          borderRadius: '12px',
          marginBottom: '2rem',
        },
        reviewPromptTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        reviewPromptText: {
          fontSize: '0.85rem',
          color: 'var(--text-muted)',
          marginBottom: '1rem',
        },
        reviewButton: {
          padding: '0.75rem 1.25rem',
          backgroundColor: 'var(--accent)',
          color: 'white',
          border: 'none',
          borderRadius: '8px',
          fontSize: '0.9rem',
          fontWeight: 500,
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
      };

      return (
        <div style={journalStyles.container}>
          <div style={journalStyles.header}>
            <div style={journalStyles.headerLeft}>
              <button style={journalStyles.backButton} onClick={onBack} title="Back">
                â†
              </button>
              <h2 style={journalStyles.title}>Daily Journal</h2>
            </div>
            <div style={{display: 'flex', gap: '0.75rem', alignItems: 'center'}}>
              <div style={journalStyles.flexPointsBadge}>
                <span>ðŸª´</span>
                <span>{flexPoints} flex</span>
              </div>
              <button style={journalStyles.switchButton} onClick={() => setAppMode('tendy')}>
                ðŸŒ± Daily Tend
              </button>
              <button style={journalStyles.switchButton} onClick={onSwitchMode}>
                ðŸ“ Plan
              </button>
              <button style={journalStyles.switchButton} onClick={() => setAppMode('insights')}>
                ðŸ“Š Insights
              </button>
            </div>
          </div>

          <div style={journalStyles.content}>
            {/* Monthly Review Prompt */}
            {isMonthlyReviewTime && !monthlyReviewCompleted && (
              <div style={journalStyles.reviewPrompt}>
                <h3 style={journalStyles.reviewPromptTitle}>
                  <span>ðŸŒ™</span>
                  <span>Monthly Reflection Available</span>
                </h3>
                <p style={journalStyles.reviewPromptText}>
                  It's the end of the month! Let's reflect on your journey together. I've prepared a summary of your month and we can chat about what you learned, what you're proud of, and what you want to focus on next month.
                </p>
                <p style={{...journalStyles.reviewPromptText, fontSize: '0.75rem', fontStyle: 'italic'}}>
                  Earn +1.5 flex points for completing your monthly reflection
                </p>
                <button style={journalStyles.reviewButton} onClick={startMonthlyReview}>
                  <span>âœ¨</span>
                  <span>Start Monthly Reflection</span>
                </button>
              </div>
            )}

            {/* Yearly Review Prompt */}
            {isYearlyReviewTime && !yearlyReviewCompleted && (
              <div style={journalStyles.reviewPrompt}>
                <h3 style={journalStyles.reviewPromptTitle}>
                  <span>ðŸŽŠ</span>
                  <span>Year in Review Available</span>
                </h3>
                <p style={journalStyles.reviewPromptText}>
                  As {currentYear} comes to a close, let's reflect on your entire year together. I've prepared a comprehensive summary of your growth, achievements, and journey. This is a special moment to honor how far you've come.
                </p>
                <p style={{...journalStyles.reviewPromptText, fontSize: '0.75rem', fontStyle: 'italic'}}>
                  Earn +2 flex points for completing your yearly reflection
                </p>
                <button style={journalStyles.reviewButton} onClick={startYearlyReview}>
                  <span>ðŸŒŸ</span>
                  <span>Start Year in Review</span>
                </button>
              </div>
            )}

            <DailyJournalTab 
              yearTheme={yearTheme}
              vlqScores={vlqScores}
              journalEntries={journalEntries}
              setJournalEntries={setJournalEntries}
              todaysTendies={todaysTendies}
              tendyHistory={tendyHistory}
            />
          </div>
        </div>
      );
    }
    // ============ DAILY JOURNAL TAB ============
    function DailyJournalTab({ yearTheme, vlqScores, journalEntries, setJournalEntries, todaysTendies, tendyHistory }) {
      const today = new Date();
      const dateKey = today.toISOString().split('T')[0];
      const dateString = today.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'long', 
        day: 'numeric' 
      });

      // Load today's entry or create empty
      const todayEntry = journalEntries[dateKey] || { 
        gratitude: '', 
        reflection: '',
        tendyCompleted: null,
        tendyFeeling: '',
        tendyObstacle: ''
      };

      // Update today's entry
      const updateEntry = (field, value) => {
        setJournalEntries(prev => ({
          ...prev,
          [dateKey]: {
            ...prev[dateKey],
            [field]: value
          }
        }));
      };

      // Get today's selected or completed tendy
      const selectedTendy = todaysTendies.find(t => t.selected || t.completed);
      const tendyCompleted = tendyHistory.find(t => t.date === dateKey && t.completed);

      const tabStyles = {
        date: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '2rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.75rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '100px',
        },
        radioGroup: {
          display: 'flex',
          gap: '1rem',
          marginBottom: '1rem',
        },
        radioOption: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
          cursor: 'pointer',
        },
        tendyCard: {
          padding: '1rem',
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '10px',
          marginBottom: '1rem',
        },
      };

      return (
        <div>
          <div style={tabStyles.date}>{dateString}</div>

          {/* Tendy Reflection */}
          {selectedTendy && (
            <div style={tabStyles.section}>
              <h3 style={tabStyles.sectionTitle}>Daily Tend Reflection</h3>
              <div style={tabStyles.tendyCard}>
                <div style={{fontSize: '0.9rem', marginBottom: '0.75rem', color: 'var(--text)'}}>
                  {selectedTendy.text}
                </div>
                <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>
                  {selectedTendy.domainIcon} {selectedTendy.domainName}
                </div>
              </div>

              <div style={{marginBottom: '1rem'}}>
                <div style={{...tabStyles.prompt, fontStyle: 'normal', marginBottom: '0.5rem'}}>
                  Did you complete it?
                </div>
                <div style={tabStyles.radioGroup}>
                  <label style={tabStyles.radioOption}>
                    <input 
                      type="radio" 
                      name="tendyCompleted"
                      checked={todayEntry.tendyCompleted === true}
                      onChange={() => updateEntry('tendyCompleted', true)}
                    />
                    <span>Yes</span>
                  </label>
                  <label style={tabStyles.radioOption}>
                    <input 
                      type="radio" 
                      name="tendyCompleted"
                      checked={todayEntry.tendyCompleted === false}
                      onChange={() => updateEntry('tendyCompleted', false)}
                    />
                    <span>No</span>
                  </label>
                </div>
              </div>

              {todayEntry.tendyCompleted === true && (
                <div>
                  <div style={tabStyles.prompt}>How did you feel afterwards?</div>
                  <textarea
                    style={tabStyles.textarea}
                    value={todayEntry.tendyFeeling || ''}
                    onChange={(e) => updateEntry('tendyFeeling', e.target.value)}
                    placeholder="What did you notice? How did it impact your day?"
                    rows={3}
                  />
                </div>
              )}

              {todayEntry.tendyCompleted === false && (
                <div>
                  <div style={tabStyles.prompt}>What was the limiting belief or obstacle stopping you?</div>
                  <textarea
                    style={tabStyles.textarea}
                    value={todayEntry.tendyObstacle || ''}
                    onChange={(e) => updateEntry('tendyObstacle', e.target.value)}
                    placeholder="What got in the way? What belief or barrier prevented you from completing it?"
                    rows={3}
                  />
                </div>
              )}
            </div>
          )}

          {/* Gratitude */}
          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Gratitude</h3>
            <div style={tabStyles.prompt}>What are you grateful for today?</div>
            <textarea
              style={tabStyles.textarea}
              value={todayEntry.gratitude || ''}
              onChange={(e) => updateEntry('gratitude', e.target.value)}
              placeholder="List three things you're grateful for..."
              rows={4}
            />
          </div>

          {/* Free Reflection */}
          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Reflection</h3>
            <div style={tabStyles.prompt}>What's on your mind?</div>
            <textarea
              style={tabStyles.textarea}
              value={todayEntry.reflection || ''}
              onChange={(e) => updateEntry('reflection', e.target.value)}
              placeholder="What happened today? What do you want to remember?"
              rows={8}
            />
          </div>
        </div>
      );
    }
    // ============ MONTHLY REVIEW TAB ============
    function MonthlyReviewTab({ monthlyReviews, setMonthlyReviews, flexPoints, setFlexPoints, flexPointsTracking, setFlexPointsTracking }) {
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
      const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      // Load this month's review or create empty
      const thisMonthReview = monthlyReviews[currentMonth] || {
        wins: '',
        challenges: '',
        lessons: '',
        nextMonth: ''
      };

      // Update this month's review
      const updateReview = (field, value) => {
        const wasComplete = isReviewComplete(thisMonthReview);
        
        const updatedReview = {
          ...thisMonthReview,
          [field]: value
        };
        
        setMonthlyReviews(prev => ({
          ...prev,
          [currentMonth]: updatedReview
        }));

        // Award flex points if review just became complete
        const isNowComplete = isReviewComplete(updatedReview);
        if (!wasComplete && isNowComplete && flexPointsTracking.lastMonthlyReviewMonth !== currentMonth) {
          setFlexPoints(flexPoints + 1.5);
          setFlexPointsTracking(prev => ({
            ...prev,
            lastMonthlyReviewMonth: currentMonth
          }));
        }
      };

      // Check if review is complete (all fields filled)
      const isReviewComplete = (review) => {
        return review.wins?.trim() && review.challenges?.trim() && 
               review.lessons?.trim() && review.nextMonth?.trim();
      };

      const completed = isReviewComplete(thisMonthReview);
      const alreadyAwarded = flexPointsTracking.lastMonthlyReviewMonth === currentMonth;

      const tabStyles = {
        monthName: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '2rem',
        },
        completionBadge: {
          display: 'inline-flex',
          alignItems: 'center',
          gap: '0.5rem',
          padding: '0.5rem 1rem',
          backgroundColor: 'var(--accent-light)',
          border: '1px solid var(--accent)',
          borderRadius: '8px',
          fontSize: '0.85rem',
          color: 'var(--text)',
          marginBottom: '2rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '100px',
        },
      };

      return (
        <div>
          <h2 style={tabStyles.monthName}>{monthName} Review</h2>
          <div style={tabStyles.subtitle}>
            Reflect on this month and earn 1.5 flex points for completing your review
          </div>

          {completed && alreadyAwarded && (
            <div style={tabStyles.completionBadge}>
              <span>âœ¨</span>
              <span>Review complete! +1.5 flex points earned</span>
            </div>
          )}

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Wins & Highlights</h3>
            <div style={tabStyles.prompt}>What were your biggest wins this month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.wins || ''}
              onChange={(e) => updateReview('wins', e.target.value)}
              placeholder="What went well? What are you proud of?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Challenges</h3>
            <div style={tabStyles.prompt}>What challenges did you face?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.challenges || ''}
              onChange={(e) => updateReview('challenges', e.target.value)}
              placeholder="What was difficult? What obstacles came up?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Lessons Learned</h3>
            <div style={tabStyles.prompt}>What did you learn about yourself this month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.lessons || ''}
              onChange={(e) => updateReview('lessons', e.target.value)}
              placeholder="What insights or realizations did you have?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Looking Ahead</h3>
            <div style={tabStyles.prompt}>What do you want to focus on next month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.nextMonth || ''}
              onChange={(e) => updateReview('nextMonth', e.target.value)}
              placeholder="What intentions or goals do you have for next month?"
              rows={5}
            />
          </div>
        </div>
      );
    }
    // ============ YEARLY REFLECTION TAB ============
    function YearlyReflectionTab({ yearlyReflections, setYearlyReflections }) {
      const today = new Date();
      const currentYear = today.getFullYear().toString();

      // Load this year's reflection or create empty
      const thisYearReflection = yearlyReflections[currentYear] || {
        definingMoments: '',
        growth: '',
        gratitude: '',
        intentions: ''
      };

      // Update this year's reflection
      const updateReflection = (field, value) => {
        setYearlyReflections(prev => ({
          ...prev,
          [currentYear]: {
            ...prev[currentYear],
            [field]: value
          }
        }));
      };

      const tabStyles = {
        yearName: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '2rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '120px',
        },
      };

      return (
        <div>
          <h2 style={tabStyles.yearName}>{currentYear} Reflection</h2>
          <div style={tabStyles.subtitle}>
            Take time to reflect on the year that was and set intentions for the year ahead
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Defining Moments</h3>
            <div style={tabStyles.prompt}>What were the defining moments of this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.definingMoments || ''}
              onChange={(e) => updateReflection('definingMoments', e.target.value)}
              placeholder="What experiences, decisions, or events shaped your year?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Growth & Change</h3>
            <div style={tabStyles.prompt}>How have you grown this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.growth || ''}
              onChange={(e) => updateReflection('growth', e.target.value)}
              placeholder="What have you learned? How have you changed?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Gratitude</h3>
            <div style={tabStyles.prompt}>What are you grateful for from this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.gratitude || ''}
              onChange={(e) => updateReflection('gratitude', e.target.value)}
              placeholder="Who and what are you thankful for?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Intentions for Next Year</h3>
            <div style={tabStyles.prompt}>What intentions do you have for the year ahead?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.intentions || ''}
              onChange={(e) => updateReflection('intentions', e.target.value)}
              placeholder="What do you want to focus on? What kind of year do you want to create?"
              rows={6}
            />
          </div>
        </div>
      );
    }

    // ============ YEAR CIRCLE VIEW ============
    function YearCircleView({ events, revealed, onAddEvent, yearTheme, setYearTheme }) {
      const size = 400;
      const center = size / 2;
      const outerRadius = 175;
      const innerRadius = 75;
      const monthRadius = 145;
      const currentMonth = new Date().getMonth();

      const getMonthPosition = (monthIndex) => {
        const angle = ((monthIndex - 2) / 12) * 2 * Math.PI - Math.PI / 2;
        return { x: center + Math.cos(angle) * monthRadius, y: center + Math.sin(angle) * monthRadius };
      };

      const getEventPosition = (monthIndex, eventIndex = 0) => {
        const angle = ((monthIndex - 2) / 12) * 2 * Math.PI - Math.PI / 2;
        const radius = innerRadius + 18 + (eventIndex * 12);
        return { x: center + Math.cos(angle) * radius, y: center + Math.sin(angle) * radius };
      };

      const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return { x: centerX + radius * Math.cos(angleInRadians), y: centerY + radius * Math.sin(angleInRadians) };
      };

      const describeArc = (startAngle, endAngle, radius) => {
        const start = polarToCartesian(center, center, radius, endAngle);
        const end = polarToCartesian(center, center, radius, startAngle);
        const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
        return `M ${start.x} ${start.y} A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y} L ${center} ${center} Z`;
      };

      const seasonArcs = [
        { id: 'winter', start: -60, end: 30, color: '#7EB3E0' },
        { id: 'spring', start: 30, end: 120, color: '#8FD4A0' },
        { id: 'summer', start: 120, end: 210, color: '#F9D07A' },
        { id: 'fall', start: 210, end: 300, color: '#E8A090' },
      ];

      return (
        <div style={styles.circleContainer}>
          <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
            {seasonArcs.map(season => (
              <path key={season.id} d={describeArc(season.start, season.end, outerRadius)} fill={season.color} opacity={0.35} />
            ))}

            <circle cx={center} cy={center} r={innerRadius} fill="var(--bg-card)" stroke="var(--border)" strokeWidth="1" />

            <text x={center} y={center - 12} textAnchor="middle" dominantBaseline="middle" fill="var(--text)"
              style={{ fontFamily: "'Fraunces', serif", fontSize: '1.75rem' }}>
              2026
            </text>

            {/* Theme word - only show if set */}
            {yearTheme && (
              <text x={center} y={center + 18} textAnchor="middle" dominantBaseline="middle" 
                fill="var(--accent)"
                style={{ fontFamily: "'Fraunces', serif", fontSize: '0.95rem', fontStyle: 'italic', cursor: 'pointer' }}
                onClick={() => {
                  const newTheme = prompt('Edit your theme word:', yearTheme);
                  if (newTheme !== null) setYearTheme(newTheme.toLowerCase());
                }}>
                {yearTheme}
              </text>
            )}

            {MONTHS.map((month, idx) => {
              const pos = getMonthPosition(idx);
              const isCurrent = idx === currentMonth;
              return (
                <g key={month}>
                  <text x={pos.x} y={pos.y} textAnchor="middle" dominantBaseline="middle"
                    fill={isCurrent ? 'var(--text)' : 'var(--text-light)'}
                    style={{ fontFamily: "'DM Sans', sans-serif", fontSize: '0.7rem', fontWeight: isCurrent ? 600 : 400 }}>
                    {month}
                  </text>
                  {isCurrent && <circle cx={pos.x} cy={pos.y + 10} r="2" fill="var(--accent)" />}
                </g>
              );
            })}

            {events.map((event) => {
              const monthEvents = events.filter(e => e.month === event.month);
              const eventIndex = monthEvents.indexOf(event);
              const pos = getEventPosition(event.month, eventIndex);
              const color = LIFE_AREAS[event.lifeArea]?.color || 'var(--accent)';
              return (
                <g key={event.id} className="fade-in">
                  <circle cx={pos.x} cy={pos.y} r="6" fill={color} />
                  <circle cx={pos.x} cy={pos.y} r="2.5" fill="white" opacity="0.5" />
                </g>
              );
            })}
          </svg>
        </div>
      );
    }

    // ============ SEASONS VIEW ============
    function SeasonsView({ seasonIntentions, setSeasonIntentions, revealed }) {
      const seasons = [
        { 
          id: 'winter', 
          name: 'Winter', 
          months: 'Dec â€“ Feb', 
          color: '#7EB3E0', 
          lightColor: '#F5F9FC', 
          elements: ['â„', 'Â·', 'â„', 'Â·', 'â„'],
          description: 'A time for rest, reflection, and turning inward. Shorter days invite quiet planning, cozy routines, and nurturing what matters most.'
        },
        { 
          id: 'spring', 
          name: 'Spring', 
          months: 'Mar â€“ May', 
          color: '#8FD4A0', 
          lightColor: '#F5FBF6', 
          elements: ['âœ¿', 'Â·', 'â€', 'Â·', 'âœ¿'],
          description: 'A time for new beginnings and fresh energy. Nature awakens â€” a good season to plant seeds, start projects, and embrace growth.'
        },
        { 
          id: 'summer', 
          name: 'Summer', 
          months: 'Jun â€“ Aug', 
          color: '#F9D07A', 
          lightColor: '#FFFDF7', 
          elements: ['â˜€', '~', 'â˜€', '~', 'â˜€'],
          description: 'A time for expansion, adventure, and connection. Long days invite travel, outdoor activities, and making memories with others.'
        },
        { 
          id: 'fall', 
          name: 'Fall', 
          months: 'Sep â€“ Nov', 
          color: '#E8A090', 
          lightColor: '#FDF7F5', 
          elements: ['ðŸ‚', 'Â·', 'ðŸ', 'Â·', 'ðŸ‚'],
          description: 'A time for harvest and gratitude. Energy turns toward completion, gathering, and preparing for the quieter months ahead.'
        },
      ];

      const currentSeason = (() => {
        const month = new Date().getMonth();
        if ([11, 0, 1].includes(month)) return 'winter';
        if ([2, 3, 4].includes(month)) return 'spring';
        if ([5, 6, 7].includes(month)) return 'summer';
        return 'fall';
      })();

      return (
        <div style={styles.seasonsContainer}>
          <div style={styles.seasonsGrid}>
            {seasons.map(season => (
              <div 
                key={season.id} 
                style={{
                  ...styles.seasonCard,
                  backgroundColor: season.lightColor,
                  borderColor: season.id === currentSeason ? season.color : 'transparent',
                  borderWidth: '2px',
                }}
              >
                {/* Decorative top */}
                <div style={{...styles.seasonDecorative, color: season.color}}>
                  {season.elements.map((el, i) => (
                    <span key={i} style={{opacity: i % 2 === 0 ? 1 : 0.5}}>{el}</span>
                  ))}
                </div>

                <div style={styles.seasonCardContent}>
                  <div style={styles.seasonCardHeader}>
                    <h3 style={{...styles.seasonName, color: season.color}}>{season.name}</h3>
                    <span style={styles.seasonMonths}>{season.months}</span>
                    {season.id === currentSeason && (
                      <span style={{...styles.currentBadge, backgroundColor: `${season.color}90`}}>Now</span>
                    )}
                  </div>
                  
                  <p style={styles.seasonDescription}>{season.description}</p>
                  
                  <div style={styles.seasonIntentionBox}>
                    <label style={{...styles.seasonLabel, color: season.color}}>What do you envision for this season?</label>
                    <textarea
                      style={{
                        ...styles.seasonTextarea,
                        borderColor: revealed ? season.color : 'var(--border)',
                        opacity: revealed ? 1 : 0.6,
                      }}
                      value={seasonIntentions[season.id] || ''}
                      onChange={(e) => setSeasonIntentions({...seasonIntentions, [season.id]: e.target.value})}
                      placeholder={revealed ? 'Your intention for this season...' : 'Complete conversation to unlock'}
                      disabled={!revealed}
                      rows={2}
                    />
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ============ MONTHLY VIEW ============
    function MonthlyView({ events, selectedMonth, setSelectedMonth, revealed, onAddEvent, weeklyHabits, dailyHabits, habitCompletions, setHabitCompletions }) {
      const year = 2026;
      const daysInMonth = new Date(year, selectedMonth + 1, 0).getDate();
      const firstDayOfMonth = new Date(year, selectedMonth, 1).getDay();
      const monthEvents = events.filter(e => e.month === selectedMonth);
      const currentMonth = new Date().getMonth();
      const today = new Date().getDate();
      const [selectedDay, setSelectedDay] = useState(null);

      const getSeasonColor = (monthIdx) => {
        if ([11, 0, 1].includes(monthIdx)) return '#7EB3E0';
        if ([2, 3, 4].includes(monthIdx)) return '#8FD4A0';
        if ([5, 6, 7].includes(monthIdx)) return '#F9D07A';
        return '#E8A090';
      };

      const seasonColor = getSeasonColor(selectedMonth);
      
      // Count total habits for display
      const totalHabits = (weeklyHabits?.length || 0) + (dailyHabits?.length || 0);
      
      // Get date string for a given day
      const getDateKey = (day) => {
        const month = (selectedMonth + 1).toString().padStart(2, '0');
        const dayStr = day.toString().padStart(2, '0');
        return `${year}-${month}-${dayStr}`;
      };
      
      // Check if a habit is completed for a given date
      const isHabitCompleted = (dateKey, habitId, type) => {
        const dayData = habitCompletions?.[dateKey];
        if (!dayData) return false;
        return type === 'daily' 
          ? dayData.daily?.includes(habitId)
          : dayData.weekly?.includes(habitId);
      };
      
      // Toggle habit completion
      const toggleHabit = (dateKey, habitId, type) => {
        setHabitCompletions(prev => {
          const dayData = prev[dateKey] || { daily: [], weekly: [] };
          const list = type === 'daily' ? [...(dayData.daily || [])] : [...(dayData.weekly || [])];
          
          if (list.includes(habitId)) {
            // Remove it
            const newList = list.filter(id => id !== habitId);
            return {
              ...prev,
              [dateKey]: {
                ...dayData,
                [type]: newList
              }
            };
          } else {
            // Add it
            return {
              ...prev,
              [dateKey]: {
                ...dayData,
                [type]: [...list, habitId]
              }
            };
          }
        });
      };
      
      // Count completions for a day
      const getCompletionCount = (day) => {
        const dateKey = getDateKey(day);
        const dayData = habitCompletions?.[dateKey];
        if (!dayData) return 0;
        return (dayData.daily?.length || 0) + (dayData.weekly?.length || 0);
      };

      // Day Detail Modal
      const DayDetail = ({ day, onClose }) => {
        const dayName = new Date(year, selectedMonth, day).toLocaleDateString('en-US', { weekday: 'long' });
        const fullDate = new Date(year, selectedMonth, day).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        const dateKey = getDateKey(day);
        
        return (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '1rem'
          }} onClick={onClose}>
            <div style={{
              backgroundColor: 'var(--bg-card)',
              borderRadius: '16px',
              padding: '1.5rem',
              maxWidth: '400px',
              width: '100%',
              maxHeight: '80vh',
              overflow: 'auto',
              boxShadow: '0 4px 24px rgba(0,0,0,0.15)'
            }} onClick={e => e.stopPropagation()}>
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'flex-start',
                marginBottom: '1.5rem'
              }}>
                <div>
                  <h3 style={{
                    fontFamily: "'Fraunces', serif",
                    fontSize: '1.25rem',
                    color: 'var(--text)',
                    marginBottom: '0.25rem'
                  }}>{dayName}</h3>
                  <p style={{
                    fontSize: '0.85rem',
                    color: 'var(--text-muted)'
                  }}>{fullDate}</p>
                </div>
                <button 
                  onClick={onClose}
                  style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '1.5rem',
                    color: 'var(--text-muted)',
                    cursor: 'pointer',
                    padding: '0.25rem'
                  }}
                >Ã—</button>
              </div>
              
              {/* Daily Habits */}
              {dailyHabits && dailyHabits.length > 0 && (
                <div style={{ marginBottom: '1.25rem' }}>
                  <h4 style={{
                    fontSize: '0.75rem',
                    fontWeight: 600,
                    color: 'var(--text-muted)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    marginBottom: '0.75rem'
                  }}>Daily</h4>
                  {dailyHabits.map(habit => {
                    const completed = isHabitCompleted(dateKey, habit.id, 'daily');
                    return (
                      <div 
                        key={habit.id} 
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.75rem',
                          padding: '0.6rem 0',
                          borderBottom: '1px solid var(--border)',
                          cursor: 'pointer'
                        }}
                        onClick={(e) => {
                          e.stopPropagation();
                          toggleHabit(dateKey, habit.id, 'daily');
                        }}
                      >
                        <div style={{
                          width: '20px',
                          height: '20px',
                          borderRadius: '4px',
                          border: completed ? 'none' : '2px solid var(--border)',
                          backgroundColor: completed ? (habit.color || '#8FD4A0') : 'transparent',
                          flexShrink: 0,
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'center',
                          transition: 'all 0.2s ease'
                        }}>
                          {completed && <span style={{ color: 'white', fontSize: '0.75rem', fontWeight: 'bold' }}>âœ“</span>}
                        </div>
                        <span style={{ 
                          fontSize: '0.9rem', 
                          color: completed ? 'var(--text-muted)' : 'var(--text)',
                          textDecoration: completed ? 'line-through' : 'none',
                          transition: 'all 0.2s ease'
                        }}>{habit.text}</span>
                      </div>
                    );
                  })}
                </div>
              )}
              
              {/* Weekly Habits */}
              {weeklyHabits && weeklyHabits.length > 0 && (
                <div style={{ marginBottom: '1.25rem' }}>
                  <h4 style={{
                    fontSize: '0.75rem',
                    fontWeight: 600,
                    color: 'var(--text-muted)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    marginBottom: '0.75rem'
                  }}>Weekly</h4>
                  {weeklyHabits.map(habit => {
                    const completed = isHabitCompleted(dateKey, habit.id, 'weekly');
                    return (
                      <div 
                        key={habit.id} 
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          padding: '0.6rem 0',
                          borderBottom: '1px solid var(--border)',
                          cursor: 'pointer'
                        }}
                        onClick={(e) => {
                          e.stopPropagation();
                          toggleHabit(dateKey, habit.id, 'weekly');
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                          <div style={{
                            width: '20px',
                            height: '20px',
                            borderRadius: '4px',
                            border: completed ? 'none' : '2px solid var(--border)',
                            backgroundColor: completed ? (habit.color || '#7EB3E0') : 'transparent',
                            flexShrink: 0,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'all 0.2s ease'
                          }}>
                            {completed && <span style={{ color: 'white', fontSize: '0.75rem', fontWeight: 'bold' }}>âœ“</span>}
                          </div>
                          <span style={{ 
                            fontSize: '0.9rem', 
                            color: completed ? 'var(--text-muted)' : 'var(--text)',
                            textDecoration: completed ? 'line-through' : 'none',
                            transition: 'all 0.2s ease'
                          }}>{habit.text}</span>
                        </div>
                        <span style={{
                          fontSize: '0.75rem',
                          color: 'var(--text-muted)',
                          backgroundColor: 'var(--bg-elevated)',
                          padding: '0.2rem 0.5rem',
                          borderRadius: '8px'
                        }}>{habit.frequency}x/wk</span>
                      </div>
                    );
                  })}
                </div>
              )}
              
              {/* Events for this specific day - placeholder */}
              {totalHabits === 0 && (
                <p style={{
                  fontSize: '0.9rem',
                  color: 'var(--text-muted)',
                  textAlign: 'center',
                  padding: '2rem 0'
                }}>No habits set yet. Add some in the Weekly or Daily tabs!</p>
              )}
            </div>
          </div>
        );
      };

      return (
        <div style={styles.monthlyContainer}>
          {/* Month selector strip */}
          <div style={styles.monthStrip}>
            {MONTHS.map((month, idx) => (
              <button
                key={idx}
                style={{
                  ...styles.monthStripButton,
                  backgroundColor: selectedMonth === idx ? `${getSeasonColor(idx)}40` : 'transparent',
                  color: selectedMonth === idx ? getSeasonColor(idx) : 'var(--text-muted)',
                  fontWeight: selectedMonth === idx ? 600 : 400,
                }}
                onClick={() => setSelectedMonth(idx)}
              >
                {month}
              </button>
            ))}
          </div>

          {/* Calendar */}
          <div style={{...styles.calendarWrapper, borderColor: seasonColor}}>
            <div style={{...styles.calendarHeader, backgroundColor: `${seasonColor}90`}}>
              <button style={styles.calendarNav} onClick={() => setSelectedMonth(selectedMonth === 0 ? 11 : selectedMonth - 1)}>â€¹</button>
              <h2 style={styles.calendarTitle}>{MONTH_FULL[selectedMonth]} 2026</h2>
              <button style={styles.calendarNav} onClick={() => setSelectedMonth(selectedMonth === 11 ? 0 : selectedMonth + 1)}>â€º</button>
            </div>

            <div style={styles.calendarBody}>
              <div style={styles.calendarGrid}>
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => (
                  <div key={i} style={styles.calendarDayHeader}>{day}</div>
                ))}
                {Array.from({ length: firstDayOfMonth }, (_, i) => (
                  <div key={`empty-${i}`} style={styles.calendarDayEmpty}></div>
                ))}
                {Array.from({ length: daysInMonth }, (_, i) => {
                  const day = i + 1;
                  const isToday = selectedMonth === currentMonth && day === today;
                  const completionCount = getCompletionCount(day);
                  const hasCompletions = completionCount > 0;
                  return (
                    <div 
                      key={day} 
                      style={{
                        ...styles.calendarDay, 
                        ...(isToday && {...styles.calendarDayToday, backgroundColor: `${seasonColor}70`}),
                        cursor: 'pointer',
                        position: 'relative',
                        ...(hasCompletions && { backgroundColor: `${seasonColor}20` })
                      }}
                      onClick={() => setSelectedDay(day)}
                    >
                      <span>{day}</span>
                      {/* Show completion indicator or habit dots */}
                      {totalHabits > 0 && (
                        <div style={{
                          position: 'absolute',
                          bottom: '4px',
                          left: '50%',
                          transform: 'translateX(-50%)',
                          display: 'flex',
                          gap: '2px',
                          alignItems: 'center'
                        }}>
                          {hasCompletions ? (
                            <div style={{
                              fontSize: '0.6rem',
                              color: seasonColor,
                              fontWeight: 600
                            }}>{completionCount}/{totalHabits}</div>
                          ) : (
                            <>
                              {dailyHabits && dailyHabits.slice(0, 2).map((h, idx) => (
                                <div key={idx} style={{
                                  width: '4px',
                                  height: '4px',
                                  borderRadius: '50%',
                                  backgroundColor: h.color || '#8FD4A0',
                                  opacity: 0.4
                                }}></div>
                              ))}
                              {weeklyHabits && weeklyHabits.slice(0, 2).map((h, idx) => (
                                <div key={idx} style={{
                                  width: '4px',
                                  height: '4px',
                                  borderRadius: '50%',
                                  backgroundColor: h.color || '#7EB3E0',
                                  opacity: 0.4
                                }}></div>
                              ))}
                            </>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Events for this month */}
          <div style={styles.monthEventsSection}>
            {monthEvents.length > 0 ? (
              <div style={styles.monthEventsList}>
                {monthEvents.map(event => (
                  <div key={event.id} style={styles.monthEventItem}>
                    <span style={{...styles.eventDot, backgroundColor: LIFE_AREAS[event.lifeArea]?.color}}></span>
                    <span>{event.title}</span>
                  </div>
                ))}
              </div>
            ) : (
              <p style={styles.noEventsText}>No events in {MONTH_FULL[selectedMonth]}</p>
            )}
            {revealed && <button style={{...styles.addEventSmall, borderColor: seasonColor, color: seasonColor}} onClick={onAddEvent}>+ Add Event</button>}
          </div>
          
          {/* Day Detail Modal */}
          {selectedDay && (
            <DayDetail day={selectedDay} onClose={() => setSelectedDay(null)} />
          )}
        </div>
      );
    }

    // ============ TENDY VIEW (Daily Values Tasks) ============
    function TendyView({ 
      vlqScores, 
      todaysTendies, 
      setTodaysTendies, 
      tendyHistory, 
      setTendyHistory,
      tendyPoints,
      setTendyPoints,
      tendyStreak,
      setTendyStreak,
      flexPoints,
      setFlexPoints,
      weeklyCustomTendy,
      setWeeklyCustomTendy,
      userProfile,
      setUserProfile,
      apiKey,
      onBack,
      onTendComplete
    }) {
      const today = getLocalDateString();
      const [showCelebration, setShowCelebration] = useState(false);
      const [justCompletedPoints, setJustCompletedPoints] = useState(0);
      const [showCustomTendyForm, setShowCustomTendyForm] = useState(false);
      const [customTendyText, setCustomTendyText] = useState('');
      const [isSubmittingCustom, setIsSubmittingCustom] = useState(false);
      
      // Tend chat state
      const [showTendChat, setShowTendChat] = useState(false);
      const [tendChatMessages, setTendChatMessages] = useState([]);
      const [tendChatInput, setTendChatInput] = useState('');
      const [isTendChatTyping, setIsTendChatTyping] = useState(false);
      const tendChatRef = useRef(null);

      // Get the week identifier (e.g., "2026-W03")
      const getWeekIdentifier = () => {
        const date = new Date();
        const year = date.getFullYear();
        const oneJan = new Date(year, 0, 1);
        const dayOfYear = Math.floor((date - oneJan) / 86400000) + 1;
        const weekNum = Math.ceil((dayOfYear + oneJan.getDay()) / 7);
        return `${year}-W${weekNum.toString().padStart(2, '0')}`;
      };

      const currentWeek = getWeekIdentifier();
      const canCreateCustomThisWeek = !weeklyCustomTendy || weeklyCustomTendy.weekOf !== currentWeek;
      
      // Check completions this week (stored as array of completion dates)
      const completionsThisWeek = weeklyCustomTendy?.completions?.filter(c => 
        c.startsWith(currentWeek)
      ) || [];
      const customCompletionsRemaining = 2 - completionsThisWeek.length;
      const hasApprovedCustom = weeklyCustomTendy?.status === 'approved' && 
                                weeklyCustomTendy.weekOf === currentWeek &&
                                customCompletionsRemaining > 0;

      // Check if we need to generate new tendies for today
      useEffect(() => {
        // Skip if no VLQ scores yet
        if (!vlqScores || Object.keys(vlqScores).length === 0) {
          console.log('TendyView: No VLQ scores yet, skipping tend generation');
          return;
        }
        
        const tendiesDate = todaysTendies[0]?.date;
        const generatedAt = todaysTendies[0]?.generatedAt;
        const isStale = !generatedAt || (new Date() - new Date(generatedAt)) > (18 * 60 * 60 * 1000);
        const hasOldFormat = todaysTendies.some(t => t.difficulty === 2);
        const tendiesAreFromToday = todaysTendies.length > 0 && tendiesDate === today && !isStale && !hasOldFormat;
        
        console.log('TendyView check:', { 
          today, 
          tendiesDate,
          generatedAt,
          isStale,
          hasOldFormat,
          tendiesAreFromToday, 
          tendiesCount: todaysTendies.length 
        });
        
        // Check if all tendies are from the same domain (v2 requirement)
        const allSameDomain = todaysTendies.length > 0 && 
          todaysTendies.every(t => t.domain === todaysTendies[0]?.domain);
        
        // Regenerate if: not from today, stale, old format, OR have different domains
        if (!tendiesAreFromToday || (tendiesAreFromToday && !allSameDomain)) {
          const previousDomain = todaysTendies[0]?.domain || null;
          console.log('Generating new tendies - date mismatch, stale, old format, or domain issue. Previous domain:', previousDomain);
          
          if (apiKey && userProfile) {
            // Use async personalized generation
            generatePersonalizedTendies(vlqScores, tendyHistory, previousDomain, userProfile, apiKey)
              .then(newTendies => setTodaysTendies(newTendies))
              .catch(err => {
                console.error('Personalization failed:', err);
                const newTendies = generateDailyTendies(vlqScores, tendyHistory, previousDomain);
                setTodaysTendies(newTendies);
              });
          } else {
            const newTendies = generateDailyTendies(vlqScores, tendyHistory, previousDomain);
            setTodaysTendies(newTendies);
          }
        }
      }, [today, vlqScores, todaysTendies.length, todaysTendies[0]?.date, todaysTendies[0]?.generatedAt]);

      const selectedTendy = todaysTendies.find(t => t.selected);
      const completedToday = todaysTendies.find(t => t.completed);

      const selectTendy = (tendyId) => {
        setTodaysTendies(todaysTendies.map(t => ({
          ...t,
          selected: t.id === tendyId
        })));
        // Allow both daily and custom tendy to be selected
      };

      const rerollTendy = () => {
        if (flexPoints < 1 || !selectedTendy) return;
        
        // Deduct flex point
        setFlexPoints(flexPoints - 1);
        
        // Deselect current tendy so they can pick a different difficulty
        setTodaysTendies(todaysTendies.map(t => ({
          ...t,
          selected: false
        })));
      };

      // Tend chat function
      const sendTendChatMessage = async () => {
        if (!tendChatInput.trim() || !apiKey || !selectedTendy) return;
        
        const userMessage = tendChatInput.trim();
        setTendChatInput('');
        setTendChatMessages(prev => [...prev, { role: 'user', content: userMessage }]);
        setIsTendChatTyping(true);
        
        try {
          const tendPreferences = userProfile?.tendPreferences || {};
          
          const systemPrompt = `You are Tend, a helpful assistant for a daily wellness app. The user has selected a daily tend (task) and wants to chat about it.

Current tend: "${selectedTendy.text}"
Life area: ${selectedTendy.domainName}
Type: ${selectedTendy.type || 'action'}
Difficulty: ${selectedTendy.difficulty === 1 ? '5 minutes' : '30 minutes'}

User's existing preferences (if any): ${JSON.stringify(tendPreferences)}

Your job is to:
1. Help them with this tend - clarify, motivate, or adapt it to their situation
2. Learn about their context, resources, and preferences to improve future tends
3. If they share relevant info (like "I have a gym", "I work from home", "I don't have a partner"), acknowledge it and let them know you'll remember it

When you learn something useful, include it at the END of your response in this exact format:
[LEARN: category | info]

Categories:
- resources: things they have (gym, meditation app, etc.)
- context: life situation (works from home, has kids, etc.)
- preferences: what they like/dislike about tends
- lifeAreaNotes.AREA: specific notes about a life area

Life areas (use the right one!):
- family: parents, siblings, kids, extended family (blood relatives)
- partner: romantic partner/spouse (just the two of them)
- friendships: friends, social circle
- career: work, job, professional life
- education: learning, courses, skills
- recreation: hobbies, fun activities
- spirituality: faith, meaning, inner peace
- community: volunteering, neighborhood, causes
- health: physical health, exercise, nutrition
- mentalHealth: emotional wellbeing, stress, boundaries

ONLY use multiple areas when the fact genuinely spans both. Most facts are single-area.

Multi-area examples (use sparingly):
[LEARN: lifeAreaNotes.partner,recreation | we love hiking together on weekends]
[LEARN: lifeAreaNotes.career,education | taking courses to get promoted]
[LEARN: lifeAreaNotes.family,community | volunteers at kids' school]

Single-area examples (most common):
[LEARN: lifeAreaNotes.partner | we cook dinner together every Sunday]
[LEARN: lifeAreaNotes.family | not close with extended family]
[LEARN: lifeAreaNotes.health | goes to the gym 3x per week]
[LEARN: resources | has gym membership]
[LEARN: context | works from home]
[LEARN: preferences | prefers outdoor activities]

Keep responses concise and supportive. Don't mention the LEARN tags will be processed - just naturally acknowledge you'll remember.`;

          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 500,
              system: systemPrompt,
              messages: [...tendChatMessages, { role: 'user', content: userMessage }].map(m => ({
                role: m.role,
                content: m.content
              }))
            })
          });

          const data = await response.json();
          let assistantMessage = data.content?.[0]?.text || "I'm sorry, I couldn't process that.";
          
          // Extract and process LEARN tags
          const learnMatches = assistantMessage.matchAll(/\[LEARN:\s*([^\|]+)\s*\|\s*([^\]]+)\]/g);
          const newPreferences = { ...tendPreferences };
          
          for (const match of learnMatches) {
            const category = match[1].trim();
            const info = match[2].trim();
            
            if (category.startsWith('lifeAreaNotes.')) {
              // Check for multi-domain (comma-separated)
              const domainsStr = category.replace('lifeAreaNotes.', '');
              const domains = domainsStr.split(',').map(d => d.trim()).filter(d => VLQ_ORDER.includes(d));
              
              if (domains.length > 1) {
                // Multi-domain fact - store in special array
                newPreferences.multiDomainFacts = newPreferences.multiDomainFacts || [];
                const exists = newPreferences.multiDomainFacts.some(f => f.text === info);
                if (!exists) {
                  newPreferences.multiDomainFacts.push({ domains, text: info, addedAt: new Date().toISOString() });
                }
              } else if (domains.length === 1) {
                // Single domain - store as before
                const lifeArea = domains[0];
                newPreferences.lifeAreaNotes = newPreferences.lifeAreaNotes || {};
                // Append to existing notes rather than replace
                const existing = newPreferences.lifeAreaNotes[lifeArea];
                if (existing && !existing.includes(info)) {
                  newPreferences.lifeAreaNotes[lifeArea] = existing + '; ' + info;
                } else if (!existing) {
                  newPreferences.lifeAreaNotes[lifeArea] = info;
                }
              }
            } else if (category === 'resources') {
              newPreferences.resources = newPreferences.resources || [];
              if (!newPreferences.resources.includes(info)) {
                newPreferences.resources.push(info);
              }
            } else if (category === 'context') {
              newPreferences.context = newPreferences.context || {};
              // Parse key-value from info like "works from home" -> { worksFromHome: true }
              const key = info.replace(/\s+/g, '_').toLowerCase();
              newPreferences.context[key] = true;
            } else if (category === 'preferences') {
              newPreferences.preferences = newPreferences.preferences || [];
              if (!newPreferences.preferences.includes(info)) {
                newPreferences.preferences.push(info);
              }
            }
          }
          
          // Update user profile if we learned something new
          if (JSON.stringify(newPreferences) !== JSON.stringify(tendPreferences)) {
            setUserProfile(prev => ({
              ...prev,
              tendPreferences: newPreferences
            }));
            console.log('Updated tend preferences:', newPreferences);
          }
          
          // Remove LEARN tags from displayed message
          assistantMessage = assistantMessage.replace(/\[LEARN:[^\]]+\]/g, '').trim();
          
          setTendChatMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);
        } catch (error) {
          console.error('Tend chat error:', error);
          setTendChatMessages(prev => [...prev, { 
            role: 'assistant', 
            content: "Sorry, I couldn't connect right now. Try again in a moment." 
          }]);
        }
        
        setIsTendChatTyping(false);
      };

      // Scroll tend chat to bottom
      useEffect(() => {
        if (tendChatRef.current) {
          tendChatRef.current.scrollTop = tendChatRef.current.scrollHeight;
        }
      }, [tendChatMessages]);

      const completeTendy = () => {
        // Check if custom tendy is selected
        if (weeklyCustomTendy?.selected) {
          const completionTimestamp = new Date().toISOString();
          const completedCustom = {
            id: `custom-${currentWeek}-${completionsThisWeek.length + 1}`,
            date: today,
            text: weeklyCustomTendy.text,
            points: 1,
            difficulty: 'custom',
            domainName: 'Custom',
            domainIcon: 'âœ¨',
            completed: true,
            completedAt: completionTimestamp,
            gardenElement: { icon: 'ðŸŒŸ', element: 'Star', description: 'Personal intention' }
          };

          // Add to history
          setTendyHistory([...tendyHistory, completedCustom]);

          // Update points
          setTendyPoints(tendyPoints + 1);

          // Update streak
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split('T')[0];
          const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
          
          if (completedYesterday || tendyStreak === 0) {
            setTendyStreak(tendyStreak + 1);
          }

          // Add completion to weeklyCustomTendy (track all completions this week)
          const existingCompletions = weeklyCustomTendy.completions || [];
          setWeeklyCustomTendy({
            ...weeklyCustomTendy, 
            completions: [...existingCompletions, completionTimestamp],
            selected: false
          });

          // Show celebration
          setJustCompletedPoints(1);
          setShowCelebration(true);
          setTimeout(() => {
            setShowCelebration(false);
            if (onTendComplete) onTendComplete();
          }, 2500);
          return;
        }

        // Regular tendy completion
        if (!selectedTendy) return;
        
        const completedTendy = {
          ...selectedTendy,
          completed: true,
          completedAt: new Date().toISOString()
        };

        // Update today's tendies
        setTodaysTendies(todaysTendies.map(t => 
          t.id === selectedTendy.id ? completedTendy : t
        ));

        // Add to history
        setTendyHistory([...tendyHistory, {
          ...completedTendy,
          templateText: completedTendy.text
        }]);

        // Update points
        const newPoints = tendyPoints + selectedTendy.points;
        setTendyPoints(newPoints);

        // Update streak (check if completed yesterday)
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
        
        if (completedYesterday || tendyStreak === 0) {
          setTendyStreak(tendyStreak + 1);
        }

        // Show celebration
        setJustCompletedPoints(selectedTendy.points);
        setShowCelebration(true);
        setTimeout(() => {
          setShowCelebration(false);
          if (onTendComplete) onTendComplete();
        }, 2500);
      };

      const submitCustomTendy = async () => {
        if (!customTendyText.trim() || !apiKey) return;
        
        setIsSubmittingCustom(true);
        
        try {
          // Call Claude API to review the custom tendy
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey,
              "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 200,
              messages: [{
                role: "user",
                content: `I'm building an intentional living app where users can create one custom "Tendy" per week - a small action aligned with their values. Please review this custom Tendy and respond with ONLY "APPROVED" or "REJECTED" followed by a brief reason.

Approve if it's:
- A specific, actionable task
- Reasonable to complete in a day
- Values-aligned and intentional
- Not harmful or inappropriate

Reject if it's:
- Too vague or unmeasurable
- Impossible to complete
- Inappropriate or harmful
- Just a to-do item with no values connection

Custom Tendy: "${customTendyText}"

Response format: "APPROVED: [reason]" or "REJECTED: [reason]"`
              }]
            })
          });

          if (!response.ok) {
            throw new Error('API request failed');
          }

          const data = await response.json();
          const aiResponse = data.content[0].text;
          
          const isApproved = aiResponse.toUpperCase().startsWith('APPROVED');
          
          setWeeklyCustomTendy({
            text: customTendyText,
            status: isApproved ? 'approved' : 'rejected',
            weekOf: currentWeek,
            submittedAt: new Date().toISOString(),
            aiResponse: aiResponse
          });

          setCustomTendyText('');
          setShowCustomTendyForm(false);
          
        } catch (error) {
          console.error('Error submitting custom tendy:', error);
          alert('Error submitting custom tendy. Please check your API key in settings.');
        } finally {
          setIsSubmittingCustom(false);
        }
      };

      const getDifficultyLabel = (difficulty) => {
        switch(difficulty) {
          case 1: return { text: '5 min', color: '#8FD4A0' };
          case 3: return { text: '30 min', color: '#E8A090' };
          default: return { text: 'Task', color: '#7EB3E0' };
        }
      };

      const tendyStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          padding: '1.5rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        header: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '2rem',
          maxWidth: '500px',
          margin: '0 auto 2rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          color: 'var(--text-muted)',
          fontSize: '0.9rem',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.25rem',
        },
        stats: {
          display: 'flex',
          gap: '1rem',
          alignItems: 'center',
        },
        stat: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          fontSize: '0.85rem',
          color: 'var(--text-light)',
          backgroundColor: 'var(--bg-card)',
          padding: '0.5rem 0.75rem',
          borderRadius: '20px',
          border: '1px solid var(--border)',
        },
        content: {
          maxWidth: '500px',
          margin: '0 auto',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.75rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
          textAlign: 'center',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.9rem',
          textAlign: 'center',
          marginBottom: '2rem',
          lineHeight: 1.5,
        },
        tendyCard: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          padding: '1.25rem',
          marginBottom: '1rem',
          border: '2px solid var(--border)',
          cursor: 'pointer',
          transition: 'all 0.2s',
        },
        tendyCardSelected: {
          borderColor: 'var(--accent)',
          backgroundColor: 'var(--accent-light)',
        },
        tendyHeader: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'flex-start',
          marginBottom: '0.75rem',
        },
        tendyDomain: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
        },
        difficultyBadge: {
          fontSize: '0.7rem',
          padding: '0.25rem 0.625rem',
          borderRadius: '12px',
          fontWeight: 500,
        },
        tendyText: {
          fontSize: '1rem',
          color: 'var(--text)',
          lineHeight: 1.5,
          marginBottom: '0.75rem',
        },
        tendyFooter: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
        },
        gardenReward: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
        },
        selectButton: {
          width: '100%',
          padding: '1rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          marginTop: '1rem',
        },
        selectButtonDisabled: {
          backgroundColor: 'var(--border-dark)',
          cursor: 'not-allowed',
        },
        completeSection: {
          textAlign: 'center',
          padding: '2rem',
        },
        selectedCard: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '20px',
          padding: '2rem',
          marginBottom: '1.5rem',
          border: '1px solid var(--border)',
          textAlign: 'left',
        },
        completeButton: {
          padding: '1rem 2rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
        },
        celebrationOverlay: {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(125, 155, 118, 0.95)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          animation: 'fadeIn 0.3s ease-out',
        },
        celebrationIcon: {
          fontSize: '4rem',
          marginBottom: '1rem',
        },
        celebrationText: {
          color: 'white',
          fontSize: '1.5rem',
          fontFamily: "'Fraunces', serif",
          marginBottom: '0.5rem',
        },
        celebrationPoints: {
          color: 'rgba(255,255,255,0.9)',
          fontSize: '1.1rem',
        },
        completedState: {
          textAlign: 'center',
          padding: '3rem 2rem',
        },
        completedIcon: {
          fontSize: '3rem',
          marginBottom: '1rem',
        },
        completedTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        completedSubtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.95rem',
          marginBottom: '2rem',
        },
        gardenPreview: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '0.5rem',
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
          marginBottom: '1rem',
        },
      };

      // Already completed today
      if (completedToday) {
        return (
          <div style={tendyStyles.container}>
            <div style={tendyStyles.header}>
              <button style={tendyStyles.backButton} onClick={onBack}>
                â† Back
              </button>
              <div style={tendyStyles.stats}>
                <div style={tendyStyles.stat}>
                  <span>ðŸŒ±</span> {tendyPoints} pts
                </div>
              </div>
            </div>
            <div style={tendyStyles.content}>
              <div style={tendyStyles.completedState}>
                <div style={tendyStyles.completedIcon}>âœ¨</div>
                <h2 style={tendyStyles.completedTitle}>Daily Tend Complete!</h2>
                <p style={tendyStyles.completedSubtitle}>
                  You earned {completedToday.points} point{completedToday.points !== 1 ? 's' : ''} for your garden
                </p>
                <div style={tendyStyles.gardenPreview}>
                  <span style={{fontSize: '1.5rem'}}>{completedToday.gardenElement?.icon}</span>
                  <span style={{color: 'var(--text-light)'}}>
                    +1 {completedToday.gardenElement?.element} growing in your garden
                  </span>
                </div>
                <p style={{color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic'}}>
                  Come back tomorrow for your next Daily Tend
                </p>
              </div>
            </div>
          </div>
        );
      }

      // Already selected - show completion view
      if (selectedTendy || weeklyCustomTendy?.selected) {
        const hasBothSelected = selectedTendy && weeklyCustomTendy?.selected;
        
        return (
          <div style={tendyStyles.container}>
            {showCelebration && (
              <div style={tendyStyles.celebrationOverlay}>
                <div style={tendyStyles.celebrationIcon}>âœ¨</div>
                <div style={tendyStyles.celebrationText}>Daily Tend Complete!</div>
                <div style={tendyStyles.celebrationPoints}>+{justCompletedPoints} point{justCompletedPoints !== 1 ? 's' : ''}</div>
              </div>
            )}
            
            {/* Tend Chat Modal */}
            {showTendChat && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                backgroundColor: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '1rem',
              }}>
                <div style={{
                  backgroundColor: 'var(--bg-card)',
                  borderRadius: '16px',
                  width: '100%',
                  maxWidth: '500px',
                  maxHeight: '80vh',
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden',
                }}>
                  {/* Chat Header */}
                  <div style={{
                    padding: '1rem',
                    borderBottom: '1px solid var(--border)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                  }}>
                    <div>
                      <div style={{ fontWeight: 600, color: 'var(--text)' }}>Chat about this tend</div>
                      <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>{selectedTendy?.domainName}</div>
                    </div>
                    <button 
                      onClick={() => setShowTendChat(false)}
                      style={{
                        background: 'none',
                        border: 'none',
                        fontSize: '1.5rem',
                        cursor: 'pointer',
                        color: 'var(--text-muted)',
                      }}
                    >Ã—</button>
                  </div>
                  
                  {/* Chat Messages */}
                  <div 
                    ref={tendChatRef}
                    style={{
                      flex: 1,
                      overflowY: 'auto',
                      padding: '1rem',
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '0.75rem',
                    }}
                  >
                    {tendChatMessages.map((msg, i) => (
                      <div 
                        key={i}
                        style={{
                          alignSelf: msg.role === 'user' ? 'flex-end' : 'flex-start',
                          backgroundColor: msg.role === 'user' ? 'var(--accent)' : 'var(--bg-elevated)',
                          color: msg.role === 'user' ? 'white' : 'var(--text)',
                          padding: '0.75rem 1rem',
                          borderRadius: '12px',
                          maxWidth: '85%',
                          fontSize: '0.9rem',
                          whiteSpace: 'pre-wrap',
                        }}
                      >
                        {msg.content}
                      </div>
                    ))}
                    {isTendChatTyping && (
                      <div style={{
                        alignSelf: 'flex-start',
                        backgroundColor: 'var(--bg-elevated)',
                        padding: '0.75rem 1rem',
                        borderRadius: '12px',
                        color: 'var(--text-muted)',
                        fontSize: '0.9rem',
                      }}>
                        Thinking...
                      </div>
                    )}
                  </div>
                  
                  {/* Chat Input */}
                  <div style={{
                    padding: '1rem',
                    borderTop: '1px solid var(--border)',
                    display: 'flex',
                    gap: '0.5rem',
                  }}>
                    <input
                      type="text"
                      value={tendChatInput}
                      onChange={(e) => setTendChatInput(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && sendTendChatMessage()}
                      placeholder="Ask about this tend..."
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        borderRadius: '10px',
                        border: '1px solid var(--border)',
                        backgroundColor: 'var(--bg-main)',
                        color: 'var(--text)',
                        fontSize: '0.9rem',
                      }}
                    />
                    <button
                      onClick={sendTendChatMessage}
                      disabled={!tendChatInput.trim() || isTendChatTyping}
                      style={{
                        padding: '0.75rem 1rem',
                        borderRadius: '10px',
                        border: 'none',
                        backgroundColor: 'var(--accent)',
                        color: 'white',
                        cursor: tendChatInput.trim() && !isTendChatTyping ? 'pointer' : 'not-allowed',
                        opacity: tendChatInput.trim() && !isTendChatTyping ? 1 : 0.5,
                      }}
                    >
                      Send
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            <div style={tendyStyles.header}>
              <button style={tendyStyles.backButton} onClick={onBack}>
                â† Back
              </button>
              <div style={tendyStyles.stats}>
                <div style={tendyStyles.stat}>
                  <span>ðŸª´</span> {flexPoints} flex
                </div>
                <div style={tendyStyles.stat}>
                  <span>ðŸŒ±</span> {tendyPoints} pts
                </div>
              </div>
            </div>
            <div style={tendyStyles.content}>
              <h1 style={tendyStyles.title}>{hasBothSelected ? 'Today\'s Tendies' : 'Today\'s Tendy'}</h1>
              <p style={tendyStyles.subtitle}>
                {hasBothSelected 
                  ? 'Complete these actions to tend to your values'
                  : 'Complete this small action to tend to your values'
                }
              </p>
              
              {/* Show regular tendy if selected */}
              {selectedTendy && (
                <div style={{marginBottom: hasBothSelected ? '1.5rem' : '0'}}>
                  <div style={tendyStyles.selectedCard}>
                    <div style={tendyStyles.tendyHeader}>
                      <div style={tendyStyles.tendyDomain}>
                        <span>{selectedTendy.domainIcon}</span>
                        <span>{selectedTendy.domainName}</span>
                      </div>
                      <span style={{
                        ...tendyStyles.difficultyBadge,
                        backgroundColor: getDifficultyLabel(selectedTendy.difficulty).color + '20',
                        color: getDifficultyLabel(selectedTendy.difficulty).color,
                      }}>
                        {getDifficultyLabel(selectedTendy.difficulty).text}
                      </span>
                    </div>
                    <p style={{...tendyStyles.tendyText, fontSize: '1.1rem'}}>
                      {selectedTendy.text}
                    </p>
                    <div style={tendyStyles.tendyFooter}>
                      <div style={tendyStyles.gardenReward}>
                        <span>{selectedTendy.gardenElement?.icon}</span>
                        <span>+{selectedTendy.points} pt{selectedTendy.points !== 1 ? 's' : ''}</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Reroll button - costs 1 flex point */}
                  {flexPoints >= 1 && !selectedTendy.completed && (
                    <button 
                      onClick={rerollTendy}
                      style={{
                        width: '100%',
                        padding: '0.75rem',
                        backgroundColor: 'transparent',
                        border: '1px solid var(--border-dark)',
                        borderRadius: '10px',
                        color: 'var(--text-muted)',
                        fontSize: '0.85rem',
                        cursor: 'pointer',
                        marginBottom: '0.75rem',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '0.5rem',
                      }}
                    >
                      <span>ðŸª´</span>
                      <span>Spend 1 flex point to pick a different difficulty</span>
                    </button>
                  )}
                  
                  {/* Chat about this tend button */}
                  <button 
                    onClick={() => {
                      setShowTendChat(true);
                      setTendChatMessages([{
                        role: 'assistant',
                        content: `This tend is: "${selectedTendy.text}"\n\nHow can I help? You can ask me to clarify, adapt it to your situation, or share what works/doesn't work for you.`
                      }]);
                    }}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      backgroundColor: 'transparent',
                      border: '1px solid var(--border)',
                      borderRadius: '10px',
                      color: 'var(--text-muted)',
                      fontSize: '0.85rem',
                      cursor: 'pointer',
                      marginBottom: '0.75rem',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '0.5rem',
                    }}
                  >
                    <span>ðŸ’¬</span>
                    <span>Chat about this tend</span>
                  </button>
                  
                  <button style={tendyStyles.completeButton} onClick={() => {
                    // Complete regular tendy
                    const completedTendy = {
                      ...selectedTendy,
                      completed: true,
                      completedAt: new Date().toISOString()
                    };
                    setTodaysTendies(todaysTendies.map(t => 
                      t.id === selectedTendy.id ? completedTendy : t
                    ));
                    setTendyHistory([...tendyHistory, {
                      ...completedTendy,
                      templateText: completedTendy.text
                    }]);
                    setTendyPoints(tendyPoints + selectedTendy.points);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
                    if (completedYesterday || tendyStreak === 0) {
                      setTendyStreak(tendyStreak + 1);
                    }
                    setJustCompletedPoints(selectedTendy.points);
                    setShowCelebration(true);
                    setTimeout(() => {
                      setShowCelebration(false);
                      if (onTendComplete) onTendComplete();
                    }, 2500);
                  }}>
                    âœ“ Mark Complete
                  </button>
                </div>
              )}

              {/* Show custom tendy if selected */}
              {weeklyCustomTendy?.selected && (
                <div>
                  <div style={tendyStyles.selectedCard}>
                    <div style={tendyStyles.tendyHeader}>
                      <div style={tendyStyles.tendyDomain}>
                        <span>âœ¨</span>
                        <span>Your Custom Tend</span>
                      </div>
                      <span style={{
                        ...tendyStyles.difficultyBadge,
                        backgroundColor: '#B8A9C920',
                        color: '#B8A9C9',
                      }}>
                        Personal
                      </span>
                    </div>
                    <p style={{...tendyStyles.tendyText, fontSize: '1.1rem'}}>
                      {weeklyCustomTendy.text}
                    </p>
                    <div style={tendyStyles.tendyFooter}>
                      <span>â± Self-paced</span>
                      <div style={tendyStyles.gardenReward}>
                        <span>ðŸŒŸ</span>
                        <span>+1 pt â€¢ {customCompletionsRemaining}/2 left</span>
                      </div>
                    </div>
                  </div>
                  <button style={tendyStyles.completeButton} onClick={() => {
                    // Complete custom tendy
                    const completionTimestamp = new Date().toISOString();
                    const completedCustom = {
                      id: `custom-${currentWeek}-${completionsThisWeek.length + 1}`,
                      date: today,
                      text: weeklyCustomTendy.text,
                      points: 1,
                      difficulty: 'custom',
                      domainName: 'Custom',
                      domainIcon: 'âœ¨',
                      completed: true,
                      completedAt: completionTimestamp,
                      gardenElement: { icon: 'ðŸŒŸ', element: 'Star', description: 'Personal intention' }
                    };
                    setTendyHistory([...tendyHistory, completedCustom]);
                    setTendyPoints(tendyPoints + 1);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
                    if (completedYesterday || tendyStreak === 0) {
                      setTendyStreak(tendyStreak + 1);
                    }
                    const existingCompletions = weeklyCustomTendy.completions || [];
                    setWeeklyCustomTendy({
                      ...weeklyCustomTendy, 
                      completions: [...existingCompletions, completionTimestamp],
                      selected: false
                    });
                    setJustCompletedPoints(1);
                    setShowCelebration(true);
                    setTimeout(() => {
                      setShowCelebration(false);
                      if (onTendComplete) onTendComplete();
                    }, 2500);
                  }}>
                    âœ“ Mark Complete
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Selection view - show all 3 tendies
      return (
        <div style={tendyStyles.container}>
          <div style={tendyStyles.header}>
            <button style={tendyStyles.backButton} onClick={onBack}>
              â† Back
            </button>
            <div style={tendyStyles.stats}>
              <div style={tendyStyles.stat}>
                <span>ðŸŒ±</span> {tendyPoints} pts
              </div>
            </div>
          </div>
          
          <div style={tendyStyles.content}>
            <h1 style={tendyStyles.title}>Choose Your Daily Tend</h1>
            <p style={tendyStyles.subtitle}>
              Pick a difficulty level to reveal your task for today.
            </p>

            {/* Today's Life Area */}
            {todaysTendies.length > 0 && (
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '0.5rem',
                padding: '1rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                marginBottom: '1.5rem',
                fontSize: '1rem',
              }}>
                <span style={{fontSize: '1.5rem'}}>{todaysTendies[0].domainIcon}</span>
                <span style={{fontWeight: 500, color: 'var(--text)'}}>Today's Focus: {todaysTendies[0].domainName}</span>
              </div>
            )}

            {todaysTendies.map(tendy => {
              const diffLabel = getDifficultyLabel(tendy.difficulty);
              return (
                <div
                  key={tendy.id}
                  style={{
                    ...tendyStyles.tendyCard,
                    borderColor: tendy.selected ? 'var(--accent)' : 'var(--border)',
                    backgroundColor: tendy.selected ? 'var(--accent-light)' : 'var(--bg-card)',
                  }}
                  onClick={() => selectTendy(tendy.id)}
                >
                  <div style={{
                    ...tendyStyles.tendyHeader,
                    justifyContent: 'center',
                  }}>
                    <span style={{
                      ...tendyStyles.difficultyBadge,
                      backgroundColor: diffLabel.color + '20',
                      color: diffLabel.color,
                    }}>
                      {diffLabel.text}
                    </span>
                  </div>
                  {/* Mystery box - no content shown until selected */}
                  <div style={{
                    padding: '2rem 1rem',
                    textAlign: 'center',
                    color: 'var(--text-muted)',
                    fontSize: '0.85rem',
                  }}>
                    <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>?</div>
                    <div>Select to reveal your daily tend</div>
                  </div>
                  <div style={tendyStyles.tendyFooter}>
                    <span style={{opacity: 0}}>placeholder</span>
                    <div style={tendyStyles.gardenReward}>
                      <span>{tendy.gardenElement?.icon}</span>
                      <span>+{tendy.points} pt{tendy.points !== 1 ? 's' : ''}</span>
                    </div>
                  </div>
                </div>
              );
            })}

            {/* Custom Tendy - if approved this week */}
            {hasApprovedCustom && (
              <div
                style={{
                  ...tendyStyles.tendyCard,
                  borderColor: weeklyCustomTendy.selected ? 'var(--accent)' : 'var(--border)',
                  backgroundColor: weeklyCustomTendy.selected ? 'var(--accent-light)' : 'var(--bg-card)',
                }}
                onClick={() => {
                  setWeeklyCustomTendy({...weeklyCustomTendy, selected: !weeklyCustomTendy.selected});
                  // Allow both daily and custom to be selected
                }}
              >
                <div style={tendyStyles.tendyHeader}>
                  <div style={tendyStyles.tendyDomain}>
                    <span>âœ¨</span>
                    <span>Your Custom Tend</span>
                  </div>
                  <span style={{
                    ...tendyStyles.difficultyBadge,
                    backgroundColor: '#B8A9C920',
                    color: '#B8A9C9',
                  }}>
                    Personal
                  </span>
                </div>
                <p style={tendyStyles.tendyText}>{weeklyCustomTendy.text}</p>
                <div style={tendyStyles.tendyFooter}>
                  <span>â± Self-paced</span>
                  <div style={tendyStyles.gardenReward}>
                    <span>ðŸŒŸ</span>
                    <span>+1 pt â€¢ {customCompletionsRemaining}/2 left</span>
                  </div>
                </div>
              </div>
            )}

            {/* Create Custom Tendy Form */}
            {canCreateCustomThisWeek && !showCustomTendyForm && (
              <button
                style={{
                  ...tendyStyles.tendyCard,
                  cursor: 'pointer',
                  borderStyle: 'dashed',
                  borderColor: 'var(--border-dark)',
                  textAlign: 'center',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  minHeight: '100px',
                  color: 'var(--text-muted)',
                }}
                onClick={() => setShowCustomTendyForm(true)}
              >
                <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>+</div>
                <div style={{fontWeight: 500}}>Create Your Own Custom Tend</div>
                <div style={{fontSize: '0.75rem', marginTop: '0.25rem'}}>Worth 1 point if completed</div>
              </button>
            )}

            {/* Custom Tendy Creation Form */}
            {showCustomTendyForm && (
              <div style={{
                ...tendyStyles.tendyCard,
                borderColor: 'var(--accent)',
              }}>
                <div style={{marginBottom: '0.75rem', fontWeight: 500, color: 'var(--text)'}}>
                  Create Your Custom Tend
                </div>
                <textarea
                  value={customTendyText}
                  onChange={(e) => setCustomTendyText(e.target.value)}
                  placeholder="Describe a specific action aligned with your values..."
                  style={{
                    width: '100%',
                    minHeight: '80px',
                    padding: '0.75rem',
                    backgroundColor: 'var(--bg-elevated)',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    fontSize: '0.9rem',
                    fontFamily: "'DM Sans', sans-serif",
                    color: 'var(--text)',
                    marginBottom: '0.75rem',
                    resize: 'vertical',
                  }}
                />
                <div style={{display: 'flex', gap: '0.5rem'}}>
                  <button
                    onClick={submitCustomTendy}
                    disabled={!customTendyText.trim() || isSubmittingCustom || !apiKey}
                    style={{
                      flex: 1,
                      padding: '0.625rem',
                      backgroundColor: isSubmittingCustom || !apiKey ? 'var(--border-dark)' : 'var(--accent)',
                      border: 'none',
                      borderRadius: '8px',
                      color: 'white',
                      fontSize: '0.85rem',
                      fontWeight: 500,
                      cursor: isSubmittingCustom || !apiKey ? 'not-allowed' : 'pointer',
                    }}
                  >
                    {isSubmittingCustom ? 'Submitting...' : 'Submit for Approval'}
                  </button>
                  <button
                    onClick={() => {
                      setShowCustomTendyForm(false);
                      setCustomTendyText('');
                    }}
                    style={{
                      padding: '0.625rem 1rem',
                      backgroundColor: 'transparent',
                      border: '1px solid var(--border)',
                      borderRadius: '8px',
                      color: 'var(--text-muted)',
                      fontSize: '0.85rem',
                      cursor: 'pointer',
                    }}
                  >
                    Cancel
                  </button>
                </div>
                {!apiKey && (
                  <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem', fontStyle: 'italic'}}>
                    Set your API key in settings to enable custom daily tends
                  </div>
                )}
              </div>
            )}

            {/* Rejected Custom Tendy Message */}
            {weeklyCustomTendy?.status === 'rejected' && weeklyCustomTendy.weekOf === currentWeek && (
              <div style={{
                padding: '1rem',
                backgroundColor: '#FFF5F5',
                border: '1px solid #FED7D7',
                borderRadius: '12px',
                fontSize: '0.85rem',
                color: '#C53030',
              }}>
                <div style={{fontWeight: 500, marginBottom: '0.25rem'}}>Custom Daily Tend Not Approved</div>
                <div style={{color: '#744210'}}>{weeklyCustomTendy.aiResponse}</div>
                <div style={{marginTop: '0.5rem', fontSize: '0.75rem', color: '#744210'}}>
                  You can try again with a different daily tend this week.
                </div>
              </div>
            )}

            <button
              style={{
                ...tendyStyles.selectButton,
                ...((todaysTendies.every(t => !t.selected) && !weeklyCustomTendy?.selected) ? tendyStyles.selectButtonDisabled : {}),
              }}
              onClick={() => {
                // Selections are already tracked
              }}
              disabled={todaysTendies.every(t => !t.selected) && !weeklyCustomTendy?.selected}
            >
              {(() => {
                const dailySelected = todaysTendies.some(t => t.selected);
                const customSelected = weeklyCustomTendy?.selected;
                if (dailySelected && customSelected) return 'Confirm Both Selections â†’';
                if (dailySelected || customSelected) return 'Confirm Selection â†’';
                return 'Select a Daily Tend above';
              })()}
            </button>
          </div>
        </div>
      );
    }

    // ============ WEEKLY VIEW ============
    function WeeklyView({ weeklyHabits, setWeeklyHabits, revealed, focusAreas = [] }) {
      const [newHabit, setNewHabit] = useState('');
      const [newFrequency, setNewFrequency] = useState(3);
      const [newLifeArea, setNewLifeArea] = useState('');

      const addHabit = () => {
        if (!newHabit.trim()) return;
        setWeeklyHabits([...weeklyHabits, {
          id: generateId(),
          text: newHabit,
          frequency: newFrequency,
          lifeArea: newLifeArea,
          color: newLifeArea ? VLQ_DOMAINS[newLifeArea]?.color : ['#7EB3E0', '#8FD4A0', '#F9D07A', '#E8A090', '#B8A9C9'][weeklyHabits.length % 5]
        }]);
        setNewHabit('');
        setNewFrequency(3);
        setNewLifeArea('');
      };

      return (
        <div style={styles.weeklyContainer}>
          <div style={styles.weeklyHeader}>
            <h2 style={styles.weeklyTitle}>Weekly Rhythms</h2>
            <p style={styles.weeklySubtitle}>What do you want to do each week?</p>
            {focusAreas.length > 0 && (
              <p style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                Cover your focus areas: {focusAreas.map(a => VLQ_DOMAINS[a]?.name.split(' ')[0]).join(', ')}
              </p>
            )}
          </div>

          {weeklyHabits.length > 0 ? (
            <div style={styles.weeklyHabitsList}>
              {weeklyHabits.map(habit => (
                <div key={habit.id} style={{
                  ...styles.weeklyHabitRow,
                  padding: '1rem 1.25rem',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between'
                }}>
                  <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                    <span style={{...styles.weeklyHabitDot, backgroundColor: habit.color}}></span>
                    <div>
                      <span style={styles.weeklyHabitText}>{habit.text}</span>
                      {habit.lifeArea && (
                        <span style={{fontSize: '0.7rem', color: 'var(--text-muted)', marginLeft: '0.5rem'}}>
                          {VLQ_DOMAINS[habit.lifeArea]?.icon} {VLQ_DOMAINS[habit.lifeArea]?.name.split(' ')[0]}
                        </span>
                      )}
                    </div>
                  </div>
                  <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                    <span style={{
                      fontSize: '0.8rem',
                      color: 'var(--text-muted)',
                      backgroundColor: 'var(--bg-elevated)',
                      padding: '0.25rem 0.75rem',
                      borderRadius: '12px'
                    }}>{habit.frequency}x/week</span>
                    <button 
                      style={styles.weeklyHabitDelete}
                      onClick={() => setWeeklyHabits(weeklyHabits.filter(h => h.id !== habit.id))}
                    >Ã—</button>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div style={styles.weeklyEmpty}>
              <p style={styles.weeklyEmptyText}>No weekly habits yet.</p>
              <p style={{...styles.weeklyEmptyText, fontStyle: 'normal', color: 'var(--text-light)'}}>What rhythm do you want to create?</p>
            </div>
          )}

          {revealed ? (
            <div style={styles.addHabitSection}>
              <input
                type="text"
                value={newHabit}
                onChange={(e) => setNewHabit(e.target.value)}
                placeholder="Exercise, read, date night..."
                style={styles.addHabitInput}
                onKeyDown={(e) => e.key === 'Enter' && addHabit()}
              />
              <select 
                value={newFrequency} 
                onChange={(e) => setNewFrequency(parseInt(e.target.value))}
                style={styles.addHabitSelect}
              >
                {[1,2,3,4,5,6,7].map(n => (
                  <option key={n} value={n}>{n}x/week</option>
                ))}
              </select>
              <select 
                value={newLifeArea} 
                onChange={(e) => setNewLifeArea(e.target.value)}
                style={{...styles.addHabitSelect, minWidth: '100px'}}
              >
                <option value="">Life Area</option>
                {VLQ_ORDER.map(key => (
                  <option key={key} value={key}>{VLQ_DOMAINS[key].icon} {VLQ_DOMAINS[key].name.split(' ')[0]}</option>
                ))}
              </select>
              <button onClick={addHabit} style={styles.addHabitButton}>+ Add</button>
            </div>
          ) : (
            <p style={styles.lockedText}>Complete the conversation to add weekly habits</p>
          )}
        </div>
      );
    }

    // ============ DAILY VIEW ============
    function DailyView({ dailyHabits, setDailyHabits, revealed }) {
      const [newHabit, setNewHabit] = useState('');

      const addHabit = () => {
        if (!newHabit.trim()) return;
        setDailyHabits([...dailyHabits, {
          id: generateId(),
          text: newHabit,
          color: ['#7EB3E0', '#8FD4A0', '#F9D07A', '#E8A090', '#B8A9C9'][dailyHabits.length % 5]
        }]);
        setNewHabit('');
      };

      return (
        <div style={styles.dailyContainer}>
          <div style={styles.dailyHeader}>
            <h2 style={styles.dailyTitle}>Daily Intentions</h2>
            <p style={styles.dailySubtitle}>Small things that add up to a life well-lived</p>
          </div>

          {dailyHabits.length > 0 ? (
            <div style={styles.dailyList}>
              {dailyHabits.map(habit => (
                <div key={habit.id} style={{
                  ...styles.dailyHabitCard,
                  padding: '1rem 1.25rem',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between'
                }}>
                  <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                    <div style={{...styles.dailyHabitAccent, backgroundColor: habit.color, position: 'static', width: '4px', height: '24px', borderRadius: '2px'}}></div>
                    <span style={styles.dailyHabitText}>{habit.text}</span>
                  </div>
                  <button 
                    style={styles.dailyHabitDelete}
                    onClick={() => setDailyHabits(dailyHabits.filter(h => h.id !== habit.id))}
                  >Ã—</button>
                </div>
              ))}
            </div>
          ) : (
            <div style={styles.dailyEmpty}>
              <p style={styles.dailyEmptyText}>What small daily practices would change your life?</p>
              <p style={styles.dailyEmptyExamples}>
                <em>10k steps Â· Morning pages Â· 8 glasses of water Â· Gratitude Â· Phone-free meals</em>
              </p>
            </div>
          )}

          {revealed ? (
            <div style={styles.addDailySection}>
              <input
                type="text"
                value={newHabit}
                onChange={(e) => setNewHabit(e.target.value)}
                placeholder="Walk 10k steps, drink water, journal..."
                style={styles.addDailyInput}
                onKeyDown={(e) => e.key === 'Enter' && addHabit()}
              />
              <button onClick={addHabit} style={styles.addDailyButton}>+ Add Daily Habit</button>
            </div>
          ) : (
            <p style={styles.lockedText}>Complete the conversation to add daily habits</p>
          )}
        </div>
      );
    }

    // ============ EVENTS TAB ============
    function EventsTab({ events, setEvents, expandedEvent, setExpandedEvent, onUpdateDetails, onDelete, onAdd, revealed, apiKey }) {
      const [planningEvent, setPlanningEvent] = useState(null);
      const [activeSection, setActiveSection] = useState('overview');
      const [sectionChat, setSectionChat] = useState('');
      const [isAiThinking, setIsAiThinking] = useState(false);
      const [newActivityText, setNewActivityText] = useState('');
      
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>Your events will appear here.</p></div>;
      }
      
      const EVENT_TYPES = {
        trip: { label: 'Trip', icon: 'âœˆï¸', color: '#7EB3E0' },
        celebration: { label: 'Celebration', icon: 'ðŸŽ‰', color: '#F9D07A' },
        project: { label: 'Project', icon: 'ðŸ“‹', color: '#8FD4A0' },
        personal: { label: 'Personal', icon: 'â­', color: '#E8A090' }
      };
      
      const SECTIONS = {
        overview: { label: 'Overview', icon: 'ðŸ“' },
        logistics: { label: 'Logistics', icon: 'ðŸš€' },
        activities: { label: 'Activities', icon: 'âœ¨' }
      };
      
      // Default logistics tasks based on event type
      const DEFAULT_LOGISTICS = {
        trip: [
          { id: 'book-flights', text: 'Book flights', completed: false },
          { id: 'book-hotel', text: 'Book hotel/accommodation', completed: false },
          { id: 'book-transport', text: 'Arrange transportation', completed: false },
          { id: 'travel-insurance', text: 'Get travel insurance', completed: false },
          { id: 'pack-bags', text: 'Pack bags', completed: false }
        ],
        celebration: [
          { id: 'book-venue', text: 'Book venue', completed: false },
          { id: 'send-invites', text: 'Send invitations', completed: false },
          { id: 'order-food', text: 'Order food/catering', completed: false },
          { id: 'decorations', text: 'Get decorations', completed: false },
          { id: 'confirm-guests', text: 'Confirm guest list', completed: false }
        ],
        project: [
          { id: 'define-scope', text: 'Define scope', completed: false },
          { id: 'set-timeline', text: 'Set timeline', completed: false },
          { id: 'gather-resources', text: 'Gather resources', completed: false },
          { id: 'assign-tasks', text: 'Assign tasks', completed: false }
        ],
        personal: [
          { id: 'set-date', text: 'Set date/time', completed: false },
          { id: 'make-reservation', text: 'Make reservations', completed: false },
          { id: 'prepare-items', text: 'Prepare needed items', completed: false }
        ]
      };
      
      // Initialize event sections if they don't exist
      const ensureEventSections = (event) => {
        if (!event.sections) {
          const eventType = event.type || 'personal';
          return {
            ...event,
            type: eventType,
            location: event.location || '',
            startDate: event.startDate || '',
            endDate: event.endDate || '',
            sections: {
              logistics: { 
                tasks: DEFAULT_LOGISTICS[eventType].map(t => ({ ...t, id: generateId() })),
                chatHistory: [] 
              },
              activities: { tasks: [], chatHistory: [] }
            }
          };
        }
        return event;
      };
      
      // Calculate progress
      const getProgress = (event) => {
        const e = ensureEventSections(event);
        let total = 0;
        let completed = 0;
        Object.values(e.sections || {}).forEach(section => {
          section.tasks?.forEach(task => {
            total++;
            if (task.completed) completed++;
          });
        });
        return total === 0 ? 0 : Math.round((completed / total) * 100);
      };
      
      // Chat with AI about activities
      const chatWithAI = async (event, message) => {
        if (!apiKey || !message.trim()) return;
        setIsAiThinking(true);
        
        const e = ensureEventSections(event);
        const existingActivities = e.sections?.activities?.tasks?.map(t => t.text).join(', ') || 'none yet';
        
        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 600,
              system: `You're helping plan activities for a ${event.type || 'event'} called "${event.title}"${event.location ? ` in/at ${event.location}` : ''}. Current activities planned: ${existingActivities}. Suggest specific, interesting activities. Be concise and helpful. When suggesting activities, list them clearly so the user can add them.`,
              messages: [
                ...(e.sections?.activities?.chatHistory || []).slice(-6),
                { role: 'user', content: message }
              ]
            })
          });
          
          const data = await response.json();
          const aiResponse = data.content[0].text;
          
          // Update chat history
          setEvents(prev => prev.map(ev => {
            if (ev.id !== event.id) return ev;
            const updated = ensureEventSections(ev);
            return {
              ...updated,
              sections: {
                ...updated.sections,
                activities: {
                  ...updated.sections.activities,
                  chatHistory: [
                    ...(updated.sections.activities?.chatHistory || []).slice(-8),
                    { role: 'user', content: message },
                    { role: 'assistant', content: aiResponse }
                  ]
                }
              }
            };
          }));
        } catch (error) {
          console.error('Error chatting with AI:', error);
        }
        setIsAiThinking(false);
        setSectionChat('');
      };
      
      // Toggle task completion
      const toggleTask = (eventId, sectionKey, taskId) => {
        setEvents(prev => prev.map(e => {
          if (e.id !== eventId) return e;
          const updated = ensureEventSections(e);
          return {
            ...updated,
            sections: {
              ...updated.sections,
              [sectionKey]: {
                ...updated.sections[sectionKey],
                tasks: updated.sections[sectionKey].tasks.map(t =>
                  t.id === taskId ? { ...t, completed: !t.completed } : t
                )
              }
            }
          };
        }));
      };
      
      // Delete task
      const deleteTask = (eventId, sectionKey, taskId) => {
        setEvents(prev => prev.map(e => {
          if (e.id !== eventId) return e;
          const updated = ensureEventSections(e);
          return {
            ...updated,
            sections: {
              ...updated.sections,
              [sectionKey]: {
                ...updated.sections[sectionKey],
                tasks: updated.sections[sectionKey].tasks.filter(t => t.id !== taskId)
              }
            }
          };
        }));
      };
      
      // Add activity
      const addActivity = (eventId) => {
        if (!newActivityText.trim()) return;
        setEvents(prev => prev.map(e => {
          if (e.id !== eventId) return e;
          const updated = ensureEventSections(e);
          return {
            ...updated,
            sections: {
              ...updated.sections,
              activities: {
                ...updated.sections.activities,
                tasks: [...(updated.sections.activities?.tasks || []), {
                  id: generateId(),
                  text: newActivityText,
                  completed: false
                }]
              }
            }
          };
        }));
        setNewActivityText('');
      };
      
      // Add custom logistics task
      const [newLogisticsText, setNewLogisticsText] = useState('');
      const addLogisticsTask = (eventId) => {
        if (!newLogisticsText.trim()) return;
        setEvents(prev => prev.map(e => {
          if (e.id !== eventId) return e;
          const updated = ensureEventSections(e);
          return {
            ...updated,
            sections: {
              ...updated.sections,
              logistics: {
                ...updated.sections.logistics,
                tasks: [...(updated.sections.logistics?.tasks || []), {
                  id: generateId(),
                  text: newLogisticsText,
                  completed: false
                }]
              }
            }
          };
        }));
        setNewLogisticsText('');
      };
      
      // Update event field
      const updateEventField = (eventId, field, value) => {
        setEvents(prev => prev.map(e => 
          e.id === eventId ? { ...e, [field]: value } : e
        ));
      };
      
      // Event List View
      if (!planningEvent) {
        return (
          <div style={styles.eventsTab}>
            <button style={styles.addItemButton} onClick={onAdd}>+ Add Event</button>
            
            {events.length === 0 ? (
              <div style={{ textAlign: 'center', padding: '2rem 1rem' }}>
                <p style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>ðŸ—“ï¸</p>
                <p style={styles.emptyText}>No events planned yet.</p>
                <p style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>Add trips, celebrations, or projects!</p>
              </div>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                {events.map(event => {
                  const e = ensureEventSections(event);
                  const progress = getProgress(e);
                  const typeInfo = EVENT_TYPES[e.type] || EVENT_TYPES.personal;
                  
                  return (
                    <div 
                      key={event.id} 
                      style={{
                        backgroundColor: 'var(--bg-card)',
                        borderRadius: '12px',
                        border: '1px solid var(--border)',
                        overflow: 'hidden',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                      }}
                      onClick={() => setPlanningEvent(event.id)}
                    >
                      <div style={{ padding: '0.875rem' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.4rem' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <span style={{ fontSize: '1.1rem' }}>{typeInfo.icon}</span>
                            <div>
                              <h3 style={{ 
                                fontFamily: "'Fraunces', serif",
                                fontSize: '0.95rem',
                                fontWeight: 600,
                                color: 'var(--text)',
                                margin: 0
                              }}>{event.title}</h3>
                              <p style={{ fontSize: '0.7rem', color: 'var(--text-muted)', margin: '0.1rem 0 0' }}>
                                {MONTHS[event.month]} {e.location && `â€¢ ${e.location}`}
                              </p>
                            </div>
                          </div>
                        </div>
                        
                        {/* Progress bar */}
                        <div style={{ 
                          height: '3px', 
                          backgroundColor: 'var(--border)', 
                          borderRadius: '2px',
                          overflow: 'hidden',
                          marginTop: '0.5rem'
                        }}>
                          <div style={{
                            height: '100%',
                            width: `${progress}%`,
                            backgroundColor: typeInfo.color,
                            borderRadius: '2px',
                            transition: 'width 0.3s ease'
                          }}></div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        );
      }
      
      // Event Planning View
      const event = events.find(e => e.id === planningEvent);
      if (!event) {
        setPlanningEvent(null);
        return null;
      }
      
      const e = ensureEventSections(event);
      const typeInfo = EVENT_TYPES[e.type] || EVENT_TYPES.personal;
      const currentSection = e.sections?.[activeSection] || { tasks: [], chatHistory: [] };
      
      return (
        <div style={{ 
          display: 'flex', 
          flexDirection: 'column', 
          height: '100%',
          backgroundColor: 'var(--bg)'
        }}>
          {/* Compact Header */}
          <div style={{
            padding: '0.75rem',
            borderBottom: '1px solid var(--border)',
            backgroundColor: 'var(--bg-card)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
              <button 
                onClick={() => setPlanningEvent(null)}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '1rem',
                  cursor: 'pointer',
                  color: 'var(--text-muted)',
                  padding: '0.15rem'
                }}
              >â†</button>
              <span style={{ fontSize: '1rem' }}>{typeInfo.icon}</span>
              <span style={{
                fontFamily: "'Fraunces', serif",
                fontSize: '0.9rem',
                fontWeight: 600,
                color: 'var(--text)',
                flex: 1
              }}>{event.title}</span>
              <span style={{ fontSize: '0.7rem', color: 'var(--text-muted)' }}>
                {MONTH_FULL[event.month]}
              </span>
            </div>
            
            {/* Section tabs */}
            <div style={{ 
              display: 'flex', 
              gap: '0.25rem'
            }}>
              {Object.entries(SECTIONS).map(([key, section]) => (
                <button
                  key={key}
                  onClick={() => setActiveSection(key)}
                  style={{
                    padding: '0.35rem 0.6rem',
                    borderRadius: '6px',
                    border: 'none',
                    backgroundColor: activeSection === key ? typeInfo.color : 'transparent',
                    color: activeSection === key ? 'white' : 'var(--text-muted)',
                    fontSize: '0.7rem',
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                >
                  {section.icon} {section.label}
                </button>
              ))}
              <button
                onClick={() => {
                  onDelete(event.id);
                  setPlanningEvent(null);
                }}
                style={{
                  marginLeft: 'auto',
                  background: 'none',
                  border: 'none',
                  color: '#E88B9C',
                  fontSize: '0.7rem',
                  cursor: 'pointer'
                }}
              >Delete</button>
            </div>
          </div>
          
          {/* Section Content */}
          <div style={{ flex: 1, overflow: 'auto', padding: '0.875rem' }}>
            {activeSection === 'overview' ? (
              /* Overview Section */
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.875rem' }}>
                <div>
                  <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Event Name</label>
                  <input
                    type="text"
                    value={event.title || ''}
                    onChange={(ev) => updateEventField(event.id, 'title', ev.target.value)}
                    placeholder="What is this event?"
                    style={{
                      width: '100%',
                      padding: '0.5rem',
                      marginTop: '0.35rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-elevated)',
                      fontSize: '0.9rem',
                      fontWeight: 500,
                      color: 'var(--text)'
                    }}
                  />
                </div>
                
                <div>
                  <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Type</label>
                  <div style={{ display: 'flex', gap: '0.4rem', marginTop: '0.4rem', flexWrap: 'wrap' }}>
                    {Object.entries(EVENT_TYPES).map(([key, type]) => (
                      <button
                        key={key}
                        onClick={() => updateEventField(event.id, 'type', key)}
                        style={{
                          padding: '0.35rem 0.6rem',
                          borderRadius: '6px',
                          border: e.type === key ? 'none' : '1px solid var(--border)',
                          backgroundColor: e.type === key ? type.color : 'var(--bg-elevated)',
                          color: e.type === key ? 'white' : 'var(--text)',
                          fontSize: '0.75rem',
                          cursor: 'pointer'
                        }}
                      >
                        {type.icon} {type.label}
                      </button>
                    ))}
                  </div>
                </div>
                
                <div>
                  <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Location</label>
                  <input
                    type="text"
                    value={e.location || ''}
                    onChange={(ev) => updateEventField(event.id, 'location', ev.target.value)}
                    placeholder="Where is this happening?"
                    style={{
                      width: '100%',
                      padding: '0.5rem',
                      marginTop: '0.35rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-elevated)',
                      fontSize: '0.8rem',
                      color: 'var(--text)'
                    }}
                  />
                </div>
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.6rem' }}>
                  <div>
                    <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Start</label>
                    <input
                      type="date"
                      value={e.startDate || ''}
                      onChange={(ev) => updateEventField(event.id, 'startDate', ev.target.value)}
                      style={{
                        width: '100%',
                        padding: '0.5rem',
                        marginTop: '0.35rem',
                        borderRadius: '6px',
                        border: '1px solid var(--border)',
                        backgroundColor: 'var(--bg-elevated)',
                        fontSize: '0.8rem',
                        color: 'var(--text)'
                      }}
                    />
                  </div>
                  <div>
                    <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase' }}>End</label>
                    <input
                      type="date"
                      value={e.endDate || ''}
                      onChange={(ev) => updateEventField(event.id, 'endDate', ev.target.value)}
                      style={{
                        width: '100%',
                        padding: '0.5rem',
                        marginTop: '0.35rem',
                        borderRadius: '6px',
                        border: '1px solid var(--border)',
                        backgroundColor: 'var(--bg-elevated)',
                        fontSize: '0.8rem',
                        color: 'var(--text)'
                      }}
                    />
                  </div>
                </div>
              </div>
            ) : activeSection === 'logistics' ? (
              /* Logistics Section */
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                {(currentSection.tasks || []).map(task => (
                  <div 
                    key={task.id}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.6rem',
                      padding: '0.6rem',
                      backgroundColor: 'var(--bg-card)',
                      borderRadius: '8px',
                      border: '1px solid var(--border)'
                    }}
                  >
                    <button
                      onClick={() => toggleTask(event.id, 'logistics', task.id)}
                      style={{
                        width: '18px',
                        height: '18px',
                        borderRadius: '4px',
                        border: task.completed ? 'none' : '2px solid var(--border)',
                        backgroundColor: task.completed ? typeInfo.color : 'transparent',
                        color: 'white',
                        fontSize: '0.65rem',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        flexShrink: 0
                      }}
                    >
                      {task.completed && 'âœ“'}
                    </button>
                    <span style={{
                      flex: 1,
                      fontSize: '0.8rem',
                      color: task.completed ? 'var(--text-muted)' : 'var(--text)',
                      textDecoration: task.completed ? 'line-through' : 'none'
                    }}>{task.text}</span>
                    <button
                      onClick={() => deleteTask(event.id, 'logistics', task.id)}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: 'var(--text-muted)',
                        fontSize: '0.9rem',
                        cursor: 'pointer',
                        padding: '0.2rem'
                      }}
                    >Ã—</button>
                  </div>
                ))}
                
                {/* Add custom logistics task */}
                <div style={{ display: 'flex', gap: '0.4rem', marginTop: '0.5rem' }}>
                  <input
                    type="text"
                    value={newLogisticsText}
                    onChange={(ev) => setNewLogisticsText(ev.target.value)}
                    onKeyDown={(ev) => ev.key === 'Enter' && addLogisticsTask(event.id)}
                    placeholder="Add a task..."
                    style={{
                      flex: 1,
                      padding: '0.5rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-elevated)',
                      fontSize: '0.8rem',
                      color: 'var(--text)'
                    }}
                  />
                  <button
                    onClick={() => addLogisticsTask(event.id)}
                    style={{
                      padding: '0.5rem 0.75rem',
                      borderRadius: '6px',
                      border: 'none',
                      backgroundColor: typeInfo.color,
                      color: 'white',
                      fontSize: '0.8rem',
                      cursor: 'pointer'
                    }}
                  >+</button>
                </div>
              </div>
            ) : (
              /* Activities Section */
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                {/* Activity List */}
                {(currentSection.tasks || []).length > 0 && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                    {currentSection.tasks.map(activity => (
                      <div 
                        key={activity.id}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.6rem',
                          padding: '0.6rem',
                          backgroundColor: 'var(--bg-card)',
                          borderRadius: '8px',
                          border: '1px solid var(--border)'
                        }}
                      >
                        <button
                          onClick={() => toggleTask(event.id, 'activities', activity.id)}
                          style={{
                            width: '18px',
                            height: '18px',
                            borderRadius: '4px',
                            border: activity.completed ? 'none' : '2px solid var(--border)',
                            backgroundColor: activity.completed ? typeInfo.color : 'transparent',
                            color: 'white',
                            fontSize: '0.65rem',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                          }}
                        >
                          {activity.completed && 'âœ“'}
                        </button>
                        <span style={{
                          flex: 1,
                          fontSize: '0.8rem',
                          color: activity.completed ? 'var(--text-muted)' : 'var(--text)',
                          textDecoration: activity.completed ? 'line-through' : 'none'
                        }}>{activity.text}</span>
                        <button
                          onClick={() => deleteTask(event.id, 'activities', activity.id)}
                          style={{
                            background: 'none',
                            border: 'none',
                            color: 'var(--text-muted)',
                            fontSize: '0.9rem',
                            cursor: 'pointer',
                            padding: '0.2rem'
                          }}
                        >Ã—</button>
                      </div>
                    ))}
                  </div>
                )}
                
                {/* Add Activity Input */}
                <div style={{ display: 'flex', gap: '0.4rem' }}>
                  <input
                    type="text"
                    value={newActivityText}
                    onChange={(ev) => setNewActivityText(ev.target.value)}
                    onKeyDown={(ev) => ev.key === 'Enter' && addActivity(event.id)}
                    placeholder="Add an activity..."
                    style={{
                      flex: 1,
                      padding: '0.5rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-elevated)',
                      fontSize: '0.8rem',
                      color: 'var(--text)'
                    }}
                  />
                  <button
                    onClick={() => addActivity(event.id)}
                    style={{
                      padding: '0.5rem 0.75rem',
                      borderRadius: '6px',
                      border: 'none',
                      backgroundColor: typeInfo.color,
                      color: 'white',
                      fontSize: '0.8rem',
                      cursor: 'pointer'
                    }}
                  >+</button>
                </div>
                
                {/* AI Chat Section */}
                <div style={{
                  marginTop: '0.5rem',
                  padding: '0.75rem',
                  backgroundColor: 'var(--bg-card)',
                  borderRadius: '10px',
                  border: '1px solid var(--border)'
                }}>
                  <h4 style={{
                    fontSize: '0.7rem',
                    fontWeight: 600,
                    color: 'var(--text-muted)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    marginBottom: '0.6rem'
                  }}>ðŸ’¬ Ask for activity ideas</h4>
                  
                  {/* Chat History */}
                  {currentSection.chatHistory?.length > 0 && (
                    <div style={{
                      maxHeight: '180px',
                      overflowY: 'auto',
                      marginBottom: '0.6rem',
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '0.4rem'
                    }}>
                      {currentSection.chatHistory.map((msg, i) => (
                        <div 
                          key={i}
                          style={{
                            padding: '0.4rem 0.6rem',
                            borderRadius: '6px',
                            backgroundColor: msg.role === 'user' ? `${typeInfo.color}20` : 'var(--bg-elevated)',
                            fontSize: '0.75rem',
                            color: 'var(--text)',
                            alignSelf: msg.role === 'user' ? 'flex-end' : 'flex-start',
                            maxWidth: '85%'
                          }}
                        >
                          {msg.content}
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* Chat Input */}
                  <div style={{ display: 'flex', gap: '0.4rem' }}>
                    <input
                      type="text"
                      value={sectionChat}
                      onChange={(ev) => setSectionChat(ev.target.value)}
                      onKeyDown={(ev) => ev.key === 'Enter' && chatWithAI(e, sectionChat)}
                      placeholder={e.location ? `What to do in ${e.location}?` : 'What activities should I plan?'}
                      disabled={isAiThinking}
                      style={{
                        flex: 1,
                        padding: '0.5rem',
                        borderRadius: '6px',
                        border: '1px solid var(--border)',
                        backgroundColor: 'var(--bg-elevated)',
                        fontSize: '0.75rem',
                        color: 'var(--text)'
                      }}
                    />
                    <button
                      onClick={() => chatWithAI(e, sectionChat)}
                      disabled={isAiThinking || !sectionChat.trim()}
                      style={{
                        padding: '0.5rem 0.75rem',
                        borderRadius: '6px',
                        border: 'none',
                        backgroundColor: isAiThinking ? 'var(--border)' : typeInfo.color,
                        color: 'white',
                        fontSize: '0.75rem',
                        cursor: isAiThinking ? 'default' : 'pointer'
                      }}
                    >
                      {isAiThinking ? '...' : 'â†’'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function NotesTab({ notes, setNotes, revealed }) {
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>A scratchpad for planning ideas.</p></div>;
      }
      return (
        <div style={styles.notesTab}>
          <textarea style={styles.notesTextarea} value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Jot down future plans, trip ideas, things to remember..." />
        </div>
      );
    }

    function GoalsTab({ goals, setGoals, onAdd, revealed }) {
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>Your goals will live here.</p></div>;
      }

      return (
        <div style={styles.goalsTab}>
          <button style={styles.addItemButton} onClick={onAdd}>+ Add Goal</button>
          {goals.length === 0 ? (
            <p style={styles.emptyText}>No goals yet.</p>
          ) : (
            <div style={styles.goalsList}>
              {goals.map(goal => (
                <div key={goal.id} style={{...styles.goalCard, opacity: goal.completed ? 0.6 : 1}}>
                  <button
                    style={{...styles.goalCheck, backgroundColor: goal.completed ? 'var(--accent)' : 'transparent'}}
                    onClick={() => setGoals(goals.map(g => g.id === goal.id ? {...g, completed: !g.completed} : g))}
                  >{goal.completed && 'âœ“'}</button>
                  <span style={{...styles.goalText, textDecoration: goal.completed ? 'line-through' : 'none'}}>{goal.text}</span>
                  <button style={styles.goalDelete} onClick={() => setGoals(goals.filter(g => g.id !== goal.id))}>Ã—</button>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function LifeAreasTab({ vlqScores, setVlqScores, goals, setGoals, onReassess, onAddGoal, revealed }) {
      if (!revealed) {
        return <div style={{padding: '1rem'}}><p style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontStyle: 'italic'}}>Complete the assessment to see your life areas.</p></div>;
      }

      // Categorize life areas
      const focusAreas = []; // gap >= 2
      const strengths = []; // importance >= 5, gap < 3
      const lowImportance = []; // importance < 5, gap < 3

      VLQ_ORDER.forEach(areaKey => {
        const area = VLQ_DOMAINS[areaKey];
        const importance = vlqScores[areaKey]?.importance || 5;
        const consistency = vlqScores[areaKey]?.consistency || 5;
        const gap = importance - consistency;

        const areaData = {
          key: areaKey,
          ...area,
          importance,
          consistency,
          gap
        };

        if (gap >= 2) {
          focusAreas.push(areaData);
        } else if (importance >= 5 && gap < 3) {
          strengths.push(areaData);
        } else if (importance < 5 && gap < 3) {
          lowImportance.push(areaData);
        }
      });

      // Get goals for a specific life area
      const getAreaGoals = (areaKey) => goals.filter(g => g.lifeArea === areaKey);
      
      // Get goals without a life area
      const unassignedGoals = goals.filter(g => !g.lifeArea);

      const renderAreaCard = (area) => {
        const areaGoals = getAreaGoals(area.key);
        
        return (
          <div key={area.key} style={{
            padding: '0.5rem',
            backgroundColor: 'var(--bg-elevated)',
            borderRadius: '8px',
            borderLeft: `3px solid ${area.color}`,
            fontSize: '0.75rem'
          }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '0.375rem',
              marginBottom: '0.25rem'
            }}>
              <span style={{fontSize: '0.9rem'}}>{area.icon}</span>
              <span style={{fontWeight: 500, color: 'var(--text)'}}>{area.name}</span>
            </div>
            <div style={{
              display: 'flex',
              gap: '0.75rem',
              fontSize: '0.65rem',
              color: 'var(--text-muted)',
              marginBottom: areaGoals.length > 0 ? '0.5rem' : 0
            }}>
              <span>Importance: {area.importance}</span>
              <span>Consistency: {area.consistency}</span>
            </div>
            
            {/* Goals for this area */}
            {areaGoals.length > 0 && (
              <div style={{
                marginTop: '0.375rem',
                paddingTop: '0.375rem',
                borderTop: '1px solid var(--border)',
                display: 'flex',
                flexDirection: 'column',
                gap: '0.25rem'
              }}>
                {areaGoals.map(goal => (
                  <div key={goal.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.375rem',
                    padding: '0.25rem 0',
                    opacity: goal.completed ? 0.5 : 1
                  }}>
                    <input
                      type="checkbox"
                      checked={goal.completed}
                      onChange={() => setGoals(goals.map(g => g.id === goal.id ? {...g, completed: !g.completed} : g))}
                      style={{margin: 0, cursor: 'pointer', accentColor: area.color, width: '14px', height: '14px'}}
                    />
                    <span style={{
                      fontSize: '0.75rem',
                      textDecoration: goal.completed ? 'line-through' : 'none',
                      flex: 1,
                      color: 'var(--text)'
                    }}>{goal.text}</span>
                    <button 
                      style={{background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.7rem', padding: '0 2px'}}
                      onClick={() => setGoals(goals.filter(g => g.id !== goal.id))}
                    >Ã—</button>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      };

      return (
        <div style={{padding: '0.75rem', display: 'flex', flexDirection: 'column', gap: '1rem', height: '100%', overflowY: 'auto'}}>
          
          {/* Add Goal Button */}
          <button style={{
            padding: '0.5rem',
            backgroundColor: 'var(--accent-light)',
            border: '1px solid var(--accent)',
            borderRadius: '8px',
            color: 'var(--accent)',
            fontSize: '0.75rem',
            cursor: 'pointer',
            fontWeight: 500
          }} onClick={onAddGoal}>+ Add Goal</button>
          
          {/* Focus Areas */}
          {focusAreas.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                ðŸŒ± Focus On
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                {focusAreas.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Strengths */}
          {strengths.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                ðŸ’ª Thriving
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                {strengths.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Low Importance */}
          {lowImportance.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                ðŸ“Š Low Priority
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                {lowImportance.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Unassigned Goals */}
          {unassignedGoals.length > 0 && (
            <div style={{marginTop: '0.5rem'}}>
              <h3 style={{fontSize: '0.7rem', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                ðŸŽ¯ Other Goals
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.375rem'}}>
                {unassignedGoals.map(goal => (
                  <div key={goal.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                    padding: '0.5rem 0.625rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    opacity: goal.completed ? 0.5 : 1
                  }}>
                    <input
                      type="checkbox"
                      checked={goal.completed}
                      onChange={() => setGoals(goals.map(g => g.id === goal.id ? {...g, completed: !g.completed} : g))}
                      style={{margin: 0, cursor: 'pointer', accentColor: 'var(--accent)'}}
                    />
                    <span style={{
                      fontSize: '0.8rem',
                      textDecoration: goal.completed ? 'line-through' : 'none',
                      flex: 1,
                      color: 'var(--text)'
                    }}>{goal.text}</span>
                    <button 
                      style={{background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.8rem'}}
                      onClick={() => setGoals(goals.filter(g => g.id !== goal.id))}
                    >Ã—</button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Reassess Button */}
          <button 
            style={{
              padding: '0.625rem',
              backgroundColor: 'transparent',
              border: '1px dashed var(--border)',
              borderRadius: '8px',
              color: 'var(--text-muted)',
              fontSize: '0.75rem',
              cursor: 'pointer',
              marginTop: 'auto'
            }}
            onClick={onReassess}
          >
            Reassess My Values
          </button>
        </div>
      );
    }

    function ChatMessage({ message, onNavigate, onButtonClick }) {
      const isAssistant = message.role === 'assistant';
      
      // Parse content for buttons and clean display text
      const parseContent = (content) => {
        // Extract buttons [BUTTON: label | action]
        const buttons = [];
        const buttonRegex = /\[BUTTON:\s*([^\|]+)\s*\|\s*([^\]]+)\]/g;
        let match;
        while ((match = buttonRegex.exec(content)) !== null) {
          buttons.push({ label: match[1].trim(), action: match[2].trim() });
        }
        
        // Remove button tags from display
        let cleanContent = content.replace(/\[BUTTON:[^\]]+\]/g, '').trim();
        // Remove navigate tags from display (handled separately)
        cleanContent = cleanContent.replace(/\[NAVIGATE:[^\]]+\]/g, '').trim();
        
        return { cleanContent, buttons };
      };
      
      const { cleanContent, buttons } = parseContent(message.content);
      
      return (
        <div style={{...styles.chatMessage, justifyContent: isAssistant ? 'flex-start' : 'flex-end'}} className="fade-in">
          {isAssistant && <div style={styles.chatAvatar}><span style={styles.chatAvatarText}>T</span></div>}
          <div style={{...styles.chatBubble, ...(isAssistant ? styles.chatBubbleAssistant : styles.chatBubbleUser)}}>
            <div dangerouslySetInnerHTML={{ __html: cleanContent.replace(/\n/g, '<br/>') }} />
            {buttons.length > 0 && (
              <div style={{ marginTop: '0.75rem', display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                {buttons.map((btn, i) => (
                  <button
                    key={i}
                    onClick={() => onButtonClick && onButtonClick(btn.action)}
                    style={{
                      padding: '0.6rem 1rem',
                      backgroundColor: 'var(--accent)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '0.85rem',
                      fontWeight: 500,
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      justifyContent: 'center',
                    }}
                  >
                    <span>ðŸ“</span> {btn.label}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    function TypingIndicator() {
      return (
        <div style={styles.chatMessage} className="fade-in">
          <div style={styles.chatAvatar}><span style={styles.chatAvatarText}>T</span></div>
          <div style={styles.typingBubble}>
            <span style={{...styles.typingDot, animationDelay: '0s'}}>â€¢</span>
            <span style={{...styles.typingDot, animationDelay: '0.15s'}}>â€¢</span>
            <span style={{...styles.typingDot, animationDelay: '0.3s'}}>â€¢</span>
          </div>
        </div>
      );
    }

    // Onboarding Progress Bar Component
    function OnboardingProgressBar({ currentStep, onStepClick, isStepComplete, getProgress }) {
      const steps = [
        { num: 0, id: 'vlq', label: 'Values', icon: 'ðŸ’š' },
        { num: 1, id: 'goals', label: 'Goals', icon: 'ðŸŽ¯' },
        { num: 2, id: 'habits', label: 'Habits', icon: 'ðŸ”„' },
        { num: 3, id: 'events', label: 'Events', icon: 'ðŸ“…', optional: true },
        { num: 4, id: 'quiz', label: 'Quiz', icon: 'ðŸŒ¸', optional: true },
        { num: 5, id: 'lifemap', label: 'Life Map', icon: 'ðŸ—ºï¸' },
        { num: 6, id: 'compass', label: 'Compass', icon: 'ðŸ§­' },
        { num: 7, id: 'tend', label: 'First Tend', icon: 'ðŸŒ±' },
      ];

      const progress = getProgress();

      return (
        <div style={{
          background: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '0.75rem 1rem 0.5rem',
          width: '100%',
          maxWidth: '600px',
        }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '0.1rem',
          }}>
            {steps.map((step, idx) => {
              const isActive = currentStep === step.num;
              const isComplete = isStepComplete(step.num);
              const isPast = step.num < currentStep;
              const isClickable = step.num <= currentStep || isComplete;
              const stepProgress = progress[step.num];
              
              return (
                <React.Fragment key={step.num}>
                  {idx > 0 && (
                    <div style={{
                      flex: '1',
                      height: '2px',
                      maxWidth: '16px',
                      backgroundColor: isPast || isComplete ? 'var(--accent)' : 'var(--border)',
                      transition: 'background-color 0.3s ease',
                      borderRadius: '1px',
                    }} />
                  )}
                  <button
                    onClick={() => isClickable && onStepClick(step.num)}
                    disabled={!isClickable}
                    style={{
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      gap: '0.25rem',
                      padding: '0.35rem 0.35rem 0.25rem',
                      backgroundColor: isActive ? 'var(--accent-light)' : 'transparent',
                      border: 'none',
                      borderRadius: '10px',
                      cursor: isClickable ? 'pointer' : 'default',
                      opacity: isClickable ? 1 : 0.4,
                      transition: 'all 0.2s ease',
                      minWidth: '42px',
                      position: 'relative',
                    }}
                    title={step.optional ? `${step.label} (optional)` : step.label}
                  >
                    <div style={{
                      width: '26px',
                      height: '26px',
                      borderRadius: '50%',
                      backgroundColor: isComplete ? 'var(--accent)' : isActive ? 'white' : 'var(--bg-elevated)',
                      border: isActive ? '2px solid var(--accent)' : '1px solid var(--border)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '0.85rem',
                      transition: 'all 0.2s ease',
                      boxShadow: isActive ? '0 2px 6px rgba(107, 139, 98, 0.3)' : 'none',
                    }}>
                      {isComplete ? <span style={{ color: 'white', fontSize: '0.7rem' }}>âœ“</span> : step.icon}
                    </div>
                    <span style={{
                      fontSize: '0.55rem',
                      fontWeight: isActive ? 600 : 400,
                      color: isActive ? 'var(--accent)' : 'var(--text-muted)',
                      whiteSpace: 'nowrap',
                      letterSpacing: '0.02em',
                    }}>
                      {step.label}
                    </span>
                    {step.optional && !isComplete && (
                      <span style={{
                        position: 'absolute',
                        top: '2px',
                        right: '2px',
                        fontSize: '0.5rem',
                        color: 'var(--text-muted)',
                        opacity: 0.6,
                      }}>skip</span>
                    )}
                  </button>
                </React.Fragment>
              );
            })}
          </div>
          {/* Progress hint for current step */}
          {currentStep !== null && progress[currentStep] && (
            <div style={{
              textAlign: 'center',
              marginTop: '0.35rem',
              fontSize: '0.65rem',
              color: 'var(--text-muted)',
            }}>
              {currentStep === 0 && <span>Values assessment complete!</span>}
              {currentStep === 1 && (
                <span>
                  {progress[1].current}/{progress[1].required} goals
                  {progress[1].focusAreasRequired > 0 && ` Â· ${progress[1].focusAreasCovered}/${progress[1].focusAreasRequired} focus areas covered`}
                </span>
              )}
              {currentStep === 2 && (
                <span>
                  {progress[2].current}/{progress[2].required} habits
                  {progress[2].focusAreasRequired > 0 && ` Â· ${progress[2].focusAreasCovered}/${progress[2].focusAreasRequired} focus areas covered`}
                </span>
              )}
              {currentStep === 3 && <span>{progress[3].current} events added (optional)</span>}
              {currentStep === 4 && <span>{progress[4].current === 1 ? 'Quiz completed!' : 'Take the quiz (optional)'}</span>}
              {currentStep === 5 && <span>{progress[5].current}/{progress[5].required} prompts answered</span>}
              {currentStep === 6 && <span>{progress[6].current === 1 ? 'Compass word set!' : 'Choose your compass word'}</span>}
              {currentStep === 7 && <span>{progress[7].current === 1 ? 'First tend completed!' : 'Complete your first daily tend'}</span>}
            </div>
          )}
        </div>
      );
    }

    function EventModal({ onClose, onAdd }) {
      const [title, setTitle] = useState('');
      const [month, setMonth] = useState(new Date().getMonth());
      const [lifeArea, setLifeArea] = useState('');
      const [eventType, setEventType] = useState('personal');
      
      const EVENT_TYPES = {
        trip: { label: 'Trip', icon: 'âœˆï¸' },
        celebration: { label: 'Celebration', icon: 'ðŸŽ‰' },
        project: { label: 'Project', icon: 'ðŸ“‹' },
        personal: { label: 'Personal', icon: 'â­' }
      };

      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={styles.modal} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Add an event</h3>
              <button style={styles.modalClose} onClick={onClose}>Ã—</button>
            </div>
            <form onSubmit={(e) => { e.preventDefault(); if (title) onAdd({ title, month, lifeArea, type: eventType }); }} style={styles.modalForm}>
              <div style={styles.formField}>
                <label style={styles.formLabel}>What is it?</label>
                <input type="text" style={styles.textInput} value={title} onChange={(e) => setTitle(e.target.value)} placeholder="Trip, birthday, deadline..." autoFocus />
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>Type</label>
                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                  {Object.entries(EVENT_TYPES).map(([key, type]) => (
                    <button
                      key={key}
                      type="button"
                      onClick={() => setEventType(key)}
                      style={{
                        padding: '0.4rem 0.75rem',
                        borderRadius: '8px',
                        border: eventType === key ? 'none' : '1px solid var(--border)',
                        backgroundColor: eventType === key ? 'var(--accent)' : 'var(--bg-elevated)',
                        color: eventType === key ? 'white' : 'var(--text)',
                        fontSize: '0.8rem',
                        cursor: 'pointer'
                      }}
                    >
                      {type.icon} {type.label}
                    </button>
                  ))}
                </div>
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>When?</label>
                <select style={styles.selectInput} value={month} onChange={(e) => setMonth(parseInt(e.target.value))}>
                  {MONTHS.map((m, i) => <option key={i} value={i}>{m} 2026</option>)}
                </select>
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>Life Area</label>
                <select style={styles.selectInput} value={lifeArea} onChange={(e) => setLifeArea(e.target.value)}>
                  <option value="">â€” N/A â€”</option>
                  {VLQ_ORDER.map(key => (
                    <option key={key} value={key}>{VLQ_DOMAINS[key].icon} {VLQ_DOMAINS[key].name}</option>
                  ))}
                </select>
              </div>
              <button type="submit" style={{...styles.submitButton, ...(!title ? styles.submitButtonDisabled : {})}} disabled={!title}>Add to year</button>
            </form>
          </div>
        </div>
      );
    }

    function GoalModal({ onClose, onAdd, focusAreas = [] }) {
      const [text, setText] = useState('');
      const [lifeArea, setLifeArea] = useState('');
      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={styles.modal} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Add a goal</h3>
              <button style={styles.modalClose} onClick={onClose}>Ã—</button>
            </div>
            <form onSubmit={(e) => { e.preventDefault(); if (text) onAdd({ text, lifeArea }); }} style={styles.modalForm}>
              <div style={styles.formField}>
                <label style={styles.formLabel}>What do you want to achieve?</label>
                <input type="text" style={styles.textInput} value={text} onChange={(e) => setText(e.target.value)} placeholder="Run a 5K, read 12 books..." autoFocus />
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>Life Area {focusAreas.length > 0 && <span style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>(cover your focus areas: {focusAreas.map(a => VLQ_DOMAINS[a]?.name.split(' ')[0]).join(', ')})</span>}</label>
                <select style={styles.selectInput} value={lifeArea} onChange={(e) => setLifeArea(e.target.value)}>
                  <option value="">â€” Select life area â€”</option>
                  {VLQ_ORDER.map(key => (
                    <option key={key} value={key} style={focusAreas.includes(key) ? { fontWeight: 'bold' } : {}}>
                      {VLQ_DOMAINS[key].icon} {VLQ_DOMAINS[key].name} {focusAreas.includes(key) ? 'â­' : ''}
                    </option>
                  ))}
                </select>
              </div>
              <button type="submit" style={{...styles.submitButton, ...(!text ? styles.submitButtonDisabled : {})}} disabled={!text}>Add goal</button>
            </form>
          </div>
        </div>
      );
    }

    function SettingsModal({ apiKey, setApiKey, onClose, user, onLogout, onDeleteAccount, onOpenAdmin }) {
      const [key, setKey] = useState(apiKey);
      
      const handleSave = () => {
        setApiKey(key);
        onClose();
      };

      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={{...styles.modal, maxWidth: '420px'}} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Settings</h3>
              <button style={styles.modalClose} onClick={onClose}>Ã—</button>
            </div>
            <div style={styles.modalForm}>
              {/* Account Section */}
              <div style={{...styles.formField, marginBottom: '1.5rem', paddingBottom: '1.5rem', borderBottom: '1px solid var(--border)'}}>
                <label style={styles.formLabel}>Account</label>
                <p style={{fontSize: '0.9rem', color: 'var(--text)', marginBottom: '0.75rem'}}>
                  {user?.email}
                </p>
                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                  <button 
                    onClick={() => { onLogout(); onClose(); }} 
                    style={{
                      padding: '0.5rem 1rem',
                      backgroundColor: 'transparent',
                      border: '1px solid var(--border)',
                      borderRadius: '8px',
                      color: 'var(--text-muted)',
                      fontSize: '0.8rem',
                      cursor: 'pointer',
                    }}
                  >
                    Sign Out
                  </button>
                  <button 
                    onClick={() => { onDeleteAccount(); }} 
                    style={{
                      padding: '0.5rem 1rem',
                      backgroundColor: 'transparent',
                      border: '1px solid #dc3545',
                      borderRadius: '8px',
                      color: '#dc3545',
                      fontSize: '0.8rem',
                      cursor: 'pointer',
                    }}
                  >
                    Delete Account
                  </button>
                </div>
              </div>

              {/* API Key Section */}
              <div style={{...styles.formField, marginBottom: '1.5rem', paddingBottom: '1.5rem', borderBottom: '1px solid var(--border)'}}>
                <label style={styles.formLabel}>Anthropic API Key</label>
                <input 
                  type="password" 
                  style={styles.textInput} 
                  value={key} 
                  onChange={(e) => setKey(e.target.value)} 
                  placeholder="sk-ant-..." 
                  autoFocus 
                />
                <p style={styles.settingsHint}>
                  Your key is stored locally in your browser only. Get one at{' '}
                  <a href="https://console.anthropic.com/api-keys" target="_blank" rel="noopener noreferrer" style={styles.settingsLink}>
                    console.anthropic.com
                  </a>
                </p>
              </div>
              
              {/* Beta Tools Section */}
              <div style={styles.formField}>
                <label style={styles.formLabel}>Beta Tools</label>
                <button 
                  onClick={() => { onOpenAdmin(); onClose(); }} 
                  style={{
                    padding: '0.5rem 1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    color: 'var(--text)',
                    fontSize: '0.8rem',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                  }}
                >
                  <span>ðŸ› ï¸</span> Admin Dashboard
                </button>
                <p style={{...styles.settingsHint, marginTop: '0.5rem'}}>
                  View your data, tend system info, and debug tools
                </p>
              </div>
              
              <button onClick={handleSave} style={{...styles.submitButton, marginTop: '1.5rem'}}>Save</button>
              {apiKey && (
                <p style={styles.settingsStatus}>âœ“ API key is set</p>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Admin Dashboard - For Tend team to view user data structure
    function AdminDashboard({ 
      user,
      savedConversations, 
      trends, 
      userProfile,
      journalEntries,
      goals,
      events,
      todaysTendies,
      onClose 
    }) {
      const conversationCount = Object.keys(savedConversations).length;
      const journalCount = Object.keys(journalEntries).length;
      const goalsCount = goals.length;
      const eventsCount = events.length;
      
      const dashStyles = {
        overlay: {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 10000,
          padding: '2rem'
        },
        container: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          maxWidth: '900px',
          width: '100%',
          maxHeight: '90vh',
          overflow: 'auto',
          padding: '2rem'
        },
        header: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '1.5rem'
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)'
        },
        closeButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.5rem',
          color: 'var(--text-muted)',
          cursor: 'pointer'
        },
        section: {
          marginBottom: '1.5rem',
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px'
        },
        sectionTitle: {
          fontSize: '1rem',
          fontWeight: 600,
          color: 'var(--text)',
          marginBottom: '0.75rem'
        },
        grid: {
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
          gap: '1rem'
        },
        stat: {
          padding: '0.75rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '8px'
        },
        statLabel: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
          marginBottom: '0.25rem'
        },
        statValue: {
          fontSize: '1.5rem',
          fontWeight: 600,
          color: 'var(--accent)'
        },
        code: {
          fontFamily: 'monospace',
          fontSize: '0.85rem',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '8px',
          overflowX: 'auto'
        },
        userId: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
          fontFamily: 'monospace'
        }
      };
      
      return (
        <div style={dashStyles.overlay} onClick={onClose}>
          <div style={dashStyles.container} onClick={(e) => e.stopPropagation()}>
            <div style={dashStyles.header}>
              <div>
                <h2 style={dashStyles.title}>Admin Dashboard</h2>
                <div style={dashStyles.userId}>User ID: {user?.uid.substring(0, 8)}...</div>
              </div>
              <button style={dashStyles.closeButton} onClick={onClose}>Ã—</button>
            </div>
            
            {/* Storage Overview */}
            <div style={dashStyles.section}>
              <h3 style={dashStyles.sectionTitle}>ðŸ“Š Data Overview</h3>
              <div style={dashStyles.grid}>
                <div style={dashStyles.stat}>
                  <div style={dashStyles.statLabel}>Exploration Chats</div>
                  <div style={dashStyles.statValue}>{conversationCount}</div>
                  <div style={{fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>Archived conversations from life design chat</div>
                </div>
                <div style={dashStyles.stat}>
                  <div style={dashStyles.statLabel}>Journal Entries</div>
                  <div style={dashStyles.statValue}>{journalCount}</div>
                  <div style={{fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>Daily reflections written</div>
                </div>
                <div style={dashStyles.stat}>
                  <div style={dashStyles.statLabel}>Goals</div>
                  <div style={dashStyles.statValue}>{goalsCount}</div>
                  <div style={{fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>Yearly goals set</div>
                </div>
                <div style={dashStyles.stat}>
                  <div style={dashStyles.statLabel}>Events</div>
                  <div style={dashStyles.statValue}>{eventsCount}</div>
                  <div style={{fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>Calendar events planned</div>
                </div>
              </div>
            </div>
            
            {/* Trends */}
            {trends && (
              <div style={dashStyles.section}>
                <h3 style={dashStyles.sectionTitle}>ðŸ“ˆ Calculated Trends</h3>
                <pre style={dashStyles.code}>{JSON.stringify(trends, null, 2)}</pre>
              </div>
            )}
            
            {/* User Profile */}
            <div style={dashStyles.section}>
              <h3 style={dashStyles.sectionTitle}>ðŸ‘¤ User Profile</h3>
              <pre style={dashStyles.code}>{JSON.stringify(userProfile, null, 2)}</pre>
            </div>
            
            {/* Tend System */}
            <div style={dashStyles.section}>
              <h3 style={dashStyles.sectionTitle}>ðŸŒ± Tend Personalization System</h3>
              
              {/* How It Works Explanation */}
              <div style={{
                padding: '0.75rem',
                backgroundColor: 'var(--bg-card)',
                borderRadius: '8px',
                marginBottom: '1rem',
                fontSize: '0.8rem',
                color: 'var(--text-muted)',
                lineHeight: 1.5
              }}>
                <strong style={{color: 'var(--text)'}}>How it works:</strong> Personalization is <strong>per life area</strong>. When a domain is selected for your daily tend, AI generation depends on how much you've shared about <em>that specific area</em>. Share details via the "Chat about this tend" button.
              </div>
              
              {/* Per-Domain Readiness */}
              {(() => {
                const summary = getPersonalizationSummary(userProfile);
                return (
                  <div style={{marginBottom: '1rem'}}>
                    {/* Summary Stats */}
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(4, 1fr)',
                      gap: '0.5rem',
                      marginBottom: '1rem'
                    }}>
                      <div style={{padding: '0.75rem', backgroundColor: '#8FD4A020', borderRadius: '8px', textAlign: 'center'}}>
                        <div style={{fontSize: '1.5rem', fontWeight: 700, color: '#8FD4A0'}}>{summary.richCount}</div>
                        <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>Rich</div>
                      </div>
                      <div style={{padding: '0.75rem', backgroundColor: '#7EB3E020', borderRadius: '8px', textAlign: 'center'}}>
                        <div style={{fontSize: '1.5rem', fontWeight: 700, color: '#7EB3E0'}}>{summary.goodCount}</div>
                        <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>Good</div>
                      </div>
                      <div style={{padding: '0.75rem', backgroundColor: '#F9D07A20', borderRadius: '8px', textAlign: 'center'}}>
                        <div style={{fontSize: '1.5rem', fontWeight: 700, color: '#F9D07A'}}>{summary.someCount}</div>
                        <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>Some</div>
                      </div>
                      <div style={{padding: '0.75rem', backgroundColor: '#E8A09020', borderRadius: '8px', textAlign: 'center'}}>
                        <div style={{fontSize: '1.5rem', fontWeight: 700, color: '#E8A090'}}>{summary.noneCount}</div>
                        <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>None</div>
                      </div>
                    </div>
                    
                    {/* Domain List */}
                    <div style={{fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text)', fontSize: '0.9rem'}}>
                      Per-Domain Readiness
                    </div>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                      {VLQ_ORDER.map(domain => {
                        const readiness = summary.allReadiness[domain];
                        const prefs = userProfile?.tendPreferences || {};
                        const lifeAreaNote = prefs.lifeAreaNotes?.[domain];
                        const keywords = DOMAIN_CONTEXT_KEYWORDS[domain] || [];
                        
                        // Get all relevant info for this domain
                        const relevantResources = (prefs.resources || [])
                          .filter(r => keywords.some(kw => r.toLowerCase().includes(kw)));
                        const relevantContext = Object.entries(prefs.context || {})
                          .filter(([k, v]) => v && keywords.some(kw => k.toLowerCase().includes(kw)))
                          .map(([k]) => k.replace(/_/g, ' '));
                        const relevantPreferences = (prefs.preferences || [])
                          .filter(p => keywords.some(kw => p.toLowerCase().includes(kw)));
                        
                        return (
                          <div key={domain} style={{
                            padding: '0.75rem',
                            backgroundColor: 'var(--bg-card)',
                            borderRadius: '8px',
                            borderLeft: `3px solid ${readiness.color}`
                          }}>
                            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem'}}>
                              <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                <span>{VLQ_DOMAINS[domain]?.icon}</span>
                                <span style={{fontWeight: 500, color: 'var(--text)'}}>{readiness.domainName}</span>
                              </div>
                              <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                <span style={{
                                  padding: '0.2rem 0.5rem',
                                  backgroundColor: `${readiness.color}20`,
                                  color: readiness.color,
                                  borderRadius: '4px',
                                  fontSize: '0.7rem',
                                  fontWeight: 600
                                }}>{readiness.level}</span>
                                <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>
                                  {(readiness.aiRatio * 100).toFixed(0)}% AI
                                </span>
                              </div>
                            </div>
                            
                            {/* Progress bar */}
                            <div style={{height: '4px', backgroundColor: 'var(--border)', borderRadius: '2px', marginBottom: '0.5rem'}}>
                              <div style={{
                                height: '100%',
                                width: `${readiness.percentage}%`,
                                backgroundColor: readiness.color,
                                borderRadius: '2px',
                                transition: 'width 0.3s'
                              }} />
                            </div>
                            
                            {/* Show ALL info for this domain */}
                            {(lifeAreaNote || relevantResources.length > 0 || relevantContext.length > 0 || relevantPreferences.length > 0) ? (
                              <div style={{fontSize: '0.75rem'}}>
                                {lifeAreaNote && (
                                  <div style={{marginBottom: '0.5rem', padding: '0.5rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '4px'}}>
                                    <div style={{color: 'var(--text-muted)', fontSize: '0.65rem', marginBottom: '0.25rem'}}>ðŸ“ Life Area Notes</div>
                                    <div style={{color: 'var(--text)'}}>{lifeAreaNote}</div>
                                  </div>
                                )}
                                {relevantResources.length > 0 && (
                                  <div style={{marginBottom: '0.35rem'}}>
                                    <span style={{color: 'var(--text-muted)'}}>ðŸŽ’ Resources: </span>
                                    <span style={{color: '#8FD4A0'}}>{relevantResources.join(', ')}</span>
                                  </div>
                                )}
                                {relevantContext.length > 0 && (
                                  <div style={{marginBottom: '0.35rem'}}>
                                    <span style={{color: 'var(--text-muted)'}}>ðŸ  Context: </span>
                                    <span style={{color: '#8FD4A0'}}>{relevantContext.join(', ')}</span>
                                  </div>
                                )}
                                {relevantPreferences.length > 0 && (
                                  <div style={{marginBottom: '0.35rem'}}>
                                    <span style={{color: 'var(--text-muted)'}}>ðŸ’œ Preferences: </span>
                                    <span style={{color: '#8FD4A0'}}>{relevantPreferences.join(', ')}</span>
                                  </div>
                                )}
                              </div>
                            ) : (
                              <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', fontStyle: 'italic'}}>
                                No info yet - share details via "Chat about this tend"
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                );
              })()}
              
              {/* Template Pool Summary */}
              <div style={{marginBottom: '1rem'}}>
                <div style={{fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text)', fontSize: '0.9rem'}}>ðŸ“‹ Template Pool</div>
                <div style={{fontSize: '0.8rem', display: 'grid', gridTemplateColumns: '1fr auto auto', gap: '0.25rem 1rem'}}>
                  <div style={{fontWeight: 600, color: 'var(--text-muted)'}}>Life Area</div>
                  <div style={{fontWeight: 600, color: 'var(--text-muted)'}}>5 min</div>
                  <div style={{fontWeight: 600, color: 'var(--text-muted)'}}>30 min</div>
                  {Object.entries(TENDY_TEMPLATES).map(([domain, templates]) => (
                    <React.Fragment key={domain}>
                      <div style={{color: 'var(--text)'}}>{VLQ_DOMAINS[domain]?.icon} {VLQ_DOMAINS[domain]?.name}</div>
                      <div style={{color: 'var(--text-muted)', textAlign: 'center'}}>{templates.filter(t => t.difficulty === 1).length}</div>
                      <div style={{color: 'var(--text-muted)', textAlign: 'center'}}>{templates.filter(t => t.difficulty === 3).length}</div>
                    </React.Fragment>
                  ))}
                  <div style={{fontWeight: 600, color: 'var(--text)', borderTop: '1px solid var(--border)', paddingTop: '0.25rem', marginTop: '0.25rem'}}>Total</div>
                  <div style={{fontWeight: 600, color: 'var(--text)', borderTop: '1px solid var(--border)', paddingTop: '0.25rem', marginTop: '0.25rem', textAlign: 'center'}}>
                    {Object.values(TENDY_TEMPLATES).reduce((sum, t) => sum + t.filter(x => x.difficulty === 1).length, 0)}
                  </div>
                  <div style={{fontWeight: 600, color: 'var(--text)', borderTop: '1px solid var(--border)', paddingTop: '0.25rem', marginTop: '0.25rem', textAlign: 'center'}}>
                    {Object.values(TENDY_TEMPLATES).reduce((sum, t) => sum + t.filter(x => x.difficulty === 3).length, 0)}
                  </div>
                </div>
              </div>
              
              {/* Today's Tendies */}
              <div>
                <div style={{fontWeight: 600, marginBottom: '0.5rem', color: 'var(--text)', fontSize: '0.9rem'}}>ðŸŒ¿ Today's Generated Tendies</div>
                {(todaysTendies || []).length > 0 ? (
                  <div>
                    {(todaysTendies || []).map((tendy, i) => {
                      const domainReadiness = calculateDomainReadiness(tendy.domain, userProfile);
                      return (
                        <div key={i} style={{
                          padding: '0.75rem',
                          backgroundColor: 'var(--bg-card)',
                          borderRadius: '8px',
                          marginBottom: '0.5rem',
                          borderLeft: `3px solid ${
                            tendy.isAIGenerated ? 'var(--accent)' : 
                            tendy.isPersonalized ? '#8FD4A0' : 
                            'var(--border)'
                          }`
                        }}>
                          <div style={{color: 'var(--text)', fontSize: '0.9rem', marginBottom: '0.25rem'}}>{tendy.text}</div>
                          {tendy.originalText && tendy.originalText !== tendy.text && (
                            <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', fontStyle: 'italic', marginBottom: '0.25rem'}}>
                              Original: {tendy.originalText}
                            </div>
                          )}
                          <div style={{display: 'flex', gap: '0.5rem', alignItems: 'center', flexWrap: 'wrap'}}>
                            <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>
                              {tendy.domainIcon} {tendy.domainName}
                            </span>
                            <span style={{fontSize: '0.75rem', padding: '0.1rem 0.4rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '4px'}}>
                              {tendy.difficulty === 1 ? '5 min' : '30 min'}
                            </span>
                            <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>{tendy.type}</span>
                            <span style={{
                              fontSize: '0.7rem',
                              padding: '0.1rem 0.4rem',
                              borderRadius: '4px',
                              backgroundColor: tendy.isAIGenerated ? 'var(--accent)' : tendy.isPersonalized ? '#8FD4A020' : 'transparent',
                              color: tendy.isAIGenerated ? 'white' : tendy.isPersonalized ? '#8FD4A0' : 'var(--text-muted)',
                            }}>
                              {tendy.source || 'pool'}
                            </span>
                            <span style={{
                              fontSize: '0.65rem',
                              padding: '0.1rem 0.4rem',
                              borderRadius: '4px',
                              backgroundColor: `${domainReadiness.color}20`,
                              color: domainReadiness.color,
                            }}>
                              {domainReadiness.level} context
                            </span>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <div style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>No tendies generated yet</div>
                )}
              </div>
            </div>
            
            {/* Conversations */}
            {conversationCount > 0 && (
              <div style={dashStyles.section}>
                <h3 style={dashStyles.sectionTitle}>ðŸ’¬ Saved Conversations</h3>
                {Object.entries(savedConversations).map(([id, conv]) => (
                  <div key={id} style={{marginBottom: '1rem'}}>
                    <div style={{fontSize: '0.85rem', color: 'var(--text)', marginBottom: '0.5rem'}}>
                      <strong>{conv.type}</strong> - {new Date(conv.lastMessageAt).toLocaleDateString()}
                    </div>
                    <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>
                      Messages: {conv.messages?.length || 0} | Themes: {conv.insights?.themes?.join(', ') || 'none'}
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            {/* Sample Data */}
            <div style={dashStyles.section}>
              <h3 style={dashStyles.sectionTitle}>ðŸ“ Sample Journal Entry</h3>
              {journalCount > 0 ? (
                <pre style={dashStyles.code}>{JSON.stringify(
                  Object.entries(journalEntries)[0], 
                  null, 
                  2
                ).substring(0, 500)}...</pre>
              ) : (
                <div style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>No journal entries yet</div>
              )}
            </div>
            
            <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '1.5rem', textAlign: 'center'}}>
              ðŸ”’ This is a development/QA view. User data is private and encrypted.
            </div>
          </div>
        </div>
      );
    }

    // ============ INSIGHTS VIEW (USER-FACING TRENDS) ============
    // Structured prompts for each life area - used in profile section
    const LIFE_AREA_PROMPTS = {
      family: {
        title: 'Family',
        why: 'Help me personalize family-related tends',
        example: '"Call your mom Sarah" instead of "Call a family member"',
        prompts: [
          { key: 'members', label: 'Family members you connect with', placeholder: 'e.g., Mom (Sarah), Sister (Amy), Dad' },
          { key: 'frequency', label: 'How often do you typically connect?', placeholder: 'e.g., Call mom weekly, text sister daily' },
        ]
      },
      partner: {
        title: 'Partner/Relationship',
        why: 'Help me suggest meaningful connection activities',
        example: '"Plan a date with Sarah" instead of "Spend quality time"',
        prompts: [
          { key: 'name', label: "Partner's name", placeholder: 'e.g., Sarah' },
          { key: 'activities', label: 'Things you enjoy doing together', placeholder: 'e.g., cooking, hiking, movie nights' },
        ]
      },
      friendships: {
        title: 'Friendships',
        why: 'Help me remind you to nurture friendships',
        example: '"Text your friend Mike" instead of "Reach out to a friend"',
        prompts: [
          { key: 'closeFriends', label: 'Close friends you want to stay connected with', placeholder: 'e.g., Mike, Jessica, the book club group' },
          { key: 'socialPrefs', label: 'How you prefer to connect', placeholder: 'e.g., prefer calls over texts, love group dinners' },
        ]
      },
      career: {
        title: 'Career & Work',
        why: 'Help me understand your work context',
        example: '"Work on Tend for 30 min" instead of "Work on a project"',
        prompts: [
          { key: 'situation', label: 'Your work situation', placeholder: 'e.g., Software engineer, work from home' },
          { key: 'projects', label: 'Current projects or focus areas', placeholder: 'e.g., Building Tend app, Q1 planning' },
        ]
      },
      education: {
        title: 'Learning & Growth',
        why: 'Help me suggest relevant learning activities',
        example: '"Practice guitar for 10 min" instead of "Learn something new"',
        prompts: [
          { key: 'learning', label: 'What are you currently learning?', placeholder: 'e.g., Guitar, Spanish, cooking' },
          { key: 'resources', label: 'Resources you use', placeholder: 'e.g., Duolingo, YouTube tutorials, local class' },
        ]
      },
      recreation: {
        title: 'Recreation & Fun',
        why: 'Help me suggest activities you actually enjoy',
        example: '"Play a round of chess" instead of "Do something fun"',
        prompts: [
          { key: 'hobbies', label: 'Hobbies and interests', placeholder: 'e.g., Chess, reading, gardening, video games' },
          { key: 'resources', label: 'Things you have access to', placeholder: 'e.g., Chess.com account, Kindle, garden' },
        ]
      },
      spirituality: {
        title: 'Spirituality & Meaning',
        why: 'Help me respect your spiritual practice',
        example: '"10 min meditation with Headspace" instead of "Practice mindfulness"',
        prompts: [
          { key: 'practices', label: 'Spiritual or mindfulness practices', placeholder: 'e.g., Meditation, prayer, journaling, yoga' },
          { key: 'resources', label: 'Apps or resources you use', placeholder: 'e.g., Headspace, local temple, meditation group' },
        ]
      },
      community: {
        title: 'Community & Contribution',
        why: 'Help me suggest ways to contribute',
        example: '"Volunteer at the food bank" instead of "Help your community"',
        prompts: [
          { key: 'involvement', label: 'How are you involved in your community?', placeholder: 'e.g., Food bank volunteer, neighborhood association' },
          { key: 'causes', label: 'Causes you care about', placeholder: 'e.g., Environment, education, homelessness' },
        ]
      },
      health: {
        title: 'Physical Health',
        why: 'Help me suggest realistic health activities',
        example: '"Go to your yoga class" instead of "Exercise"',
        prompts: [
          { key: 'activities', label: 'Exercise or health activities you do', placeholder: 'e.g., Yoga, running, gym workouts' },
          { key: 'resources', label: 'Resources you have', placeholder: 'e.g., Gym membership, Peloton, running shoes' },
        ]
      },
      mentalHealth: {
        title: 'Mental & Emotional Health',
        why: 'Help me support your wellbeing',
        example: '"Journal about your day" instead of "Practice self-care"',
        prompts: [
          { key: 'practices', label: 'Self-care practices that help you', placeholder: 'e.g., Journaling, therapy, baths, walks' },
          { key: 'boundaries', label: 'Boundaries or needs', placeholder: 'e.g., Need alone time, avoid work after 7pm' },
        ]
      },
    };

    function InsightsView({ trends, vlqScores, yearTheme, flexPoints, userProfile, setUserProfile, onBack, apiKey }) {
      const [expandedArea, setExpandedArea] = useState(null);
      const [editingArea, setEditingArea] = useState(null);
      const [tempFormData, setTempFormData] = useState({});
      const [tempNotes, setTempNotes] = useState('');
      
      if (!trends) return null;
      
      const insightsStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
        },
        header: {
          padding: '1rem 2rem',
          borderBottom: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        },
        headerLeft: {
          display: 'flex',
          alignItems: 'center',
          gap: '1rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.25rem',
          color: 'var(--text-muted)',
          cursor: 'pointer',
          padding: '0.25rem',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.25rem',
          color: 'var(--text)',
        },
        content: {
          flex: 1,
          padding: '2rem',
          maxWidth: '800px',
          margin: '0 auto',
          width: '100%',
        },
        section: {
          marginBottom: '2rem',
          padding: '1.5rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          border: '1px solid var(--border)',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '1rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        statsGrid: {
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
          gap: '1rem',
        },
        statCard: {
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
          textAlign: 'center',
        },
        statValue: {
          fontSize: '2rem',
          fontWeight: 600,
          color: 'var(--accent)',
          marginBottom: '0.25rem',
        },
        statLabel: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
        },
        areaItem: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '8px',
          marginBottom: '0.5rem',
        },
        areaName: {
          fontSize: '0.85rem',
          color: 'var(--text)',
        },
        areaStats: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
        },
        completionRate: {
          fontSize: '0.9rem',
          fontWeight: 600,
          color: 'var(--accent)',
        },
      };
      
      // Calculate top 3 life areas by completion rate
      const topAreas = Object.entries(trends.dailyTends.byLifeArea)
        .filter(([_, stats]) => stats.completed + stats.skipped > 0)
        .sort((a, b) => b[1].completionRate - a[1].completionRate)
        .slice(0, 3);
      
      return (
        <div style={insightsStyles.container}>
          <div style={insightsStyles.header}>
            <div style={insightsStyles.headerLeft}>
              <button style={insightsStyles.backButton} onClick={onBack} title="Back">
                â†
              </button>
              <h2 style={insightsStyles.title}>Your Insights</h2>
            </div>
            <div style={{fontSize: '0.9rem', color: 'var(--text-muted)'}}>
              {yearTheme && `${new Date().getFullYear()}: ${yearTheme}`}
            </div>
          </div>
          
          <div style={insightsStyles.content}>
            {/* Gardener Type Section - At the very top */}
            {(() => {
              const savedGardenerType = userProfile?.tendPreferences?.gardenerType;
              const quizStep = tempFormData.quizStep || 0;
              const quizAnswers = tempFormData.quizAnswers || {};
              const isGenerating = tempFormData.isGenerating || false;
              const generatedResult = tempFormData.generatedResult || null;
              
              // If taking the quiz, show it here
              if (expandedArea === 'quiz') {
                const quizQuestions = [
                  { q: "It's Saturday morning. What sounds most appealing?", options: [
                    { text: "A quiet cup of coffee and a good book", id: 'a' },
                    { text: "Brunch with friends â€” the more the merrier", id: 'b' },
                    { text: "Finally tackling that project I've been putting off", id: 'c' },
                    { text: "No plans â€” I'll see where the day takes me", id: 'd' },
                  ]},
                  { q: "A friend is going through a hard time. You:", options: [
                    { text: "Listen deeply and help them process their feelings", id: 'a' },
                    { text: "Rally the troops and organize support", id: 'b' },
                    { text: "Research solutions and make a practical plan", id: 'c' },
                    { text: "Surprise them with something to lift their spirits", id: 'd' },
                  ]},
                  { q: "Your ideal vacation involves:", options: [
                    { text: "A peaceful retreat with time to reflect", id: 'a' },
                    { text: "Exploring a new city with people I love", id: 'b' },
                    { text: "A well-planned itinerary hitting all the highlights", id: 'c' },
                    { text: "Booking a flight and figuring out the rest later", id: 'd' },
                  ]},
                  { q: "When you're stressed, you tend to:", options: [
                    { text: "Need alone time to think things through", id: 'a' },
                    { text: "Talk it out with someone I trust", id: 'b' },
                    { text: "Make lists and break things into manageable steps", id: 'c' },
                    { text: "Do something completely different to reset", id: 'd' },
                  ]},
                  { q: "The best part of achieving a goal is:", options: [
                    { text: "The growth and self-discovery along the way", id: 'a' },
                    { text: "Celebrating with the people who supported me", id: 'b' },
                    { text: "The satisfaction of crossing it off my list", id: 'c' },
                    { text: "The freedom to move on to the next adventure", id: 'd' },
                  ]},
                  { q: "Your ideal place to feel grounded is:", options: [
                    { text: "A quiet forest, surrounded by trees", id: 'a' },
                    { text: "A cozy cafÃ© or gathering spot with good energy", id: 'b' },
                    { text: "A tidy home office or workshop", id: 'c' },
                    { text: "Somewhere new â€” a beach, desert, or open road", id: 'd' },
                  ]},
                  { q: "Your energy comes from:", options: [
                    { text: "Meaningful one-on-one conversations", id: 'a' },
                    { text: "Being around people and social gatherings", id: 'b' },
                    { text: "Making visible progress on things that matter", id: 'c' },
                    { text: "New experiences and breaking routine", id: 'd' },
                  ]},
                  { q: "When making a big decision, you:", options: [
                    { text: "Trust your gut and inner wisdom", id: 'a' },
                    { text: "Ask for input from people you trust", id: 'b' },
                    { text: "Weigh pros and cons systematically", id: 'c' },
                    { text: "Go with what excites you most", id: 'd' },
                  ]},
                  { q: "You'd most like to be remembered for:", options: [
                    { text: "Your wisdom and thoughtfulness", id: 'a' },
                    { text: "Your warmth and the relationships you built", id: 'b' },
                    { text: "Your reliability and what you accomplished", id: 'c' },
                    { text: "Your adventurous spirit and zest for life", id: 'd' },
                  ]},
                  { q: "In a garden, you'd be drawn to:", options: [
                    { text: "A quiet corner with a bench for thinking", id: 'a' },
                    { text: "A gathering space where people can connect", id: 'b' },
                    { text: "Neat rows of thriving, well-tended plants", id: 'c' },
                    { text: "A wild, overgrown corner full of surprises", id: 'd' },
                  ]},
                ];
                
                const generateGardenerType = async (answers) => {
                  setTempFormData(prev => ({ ...prev, isGenerating: true }));
                  const answerSummary = quizQuestions.map((q, i) => {
                    const selectedOption = q.options.find(o => o.id === answers[i]);
                    return `Q: ${q.q}\nA: ${selectedOption?.text || 'No answer'}`;
                  }).join('\n\n');
                  
                  const prefs = userProfile?.tendPreferences || {};
                  const lifeMapContext = [];
                  VLQ_ORDER.forEach(domain => {
                    const structured = prefs.structuredInfo?.[domain] || {};
                    const notes = prefs.lifeAreaNotes?.[domain];
                    const filledValues = Object.values(structured).filter(v => v);
                    if (filledValues.length > 0 || notes) {
                      lifeMapContext.push(`${VLQ_DOMAINS[domain]?.name}: ${[...filledValues, notes].filter(Boolean).join(', ')}`);
                    }
                  });
                  
                  try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                      body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 800,
                        system: `You are creating a unique, personalized "gardener archetype" for someone based on their personality quiz answers. This is for a wellness app called Tend.

Create a ONE-OF-A-KIND gardener type that feels deeply personal and insightful. Be creative, warm, and specific. The name should be evocative and unique (not generic like "The Caring Gardener" â€” think more like "The Midnight Bloom Keeper" or "The Storm-Dancing Cultivator").

The description should be 4-5 sentences that feel like they were written specifically for this person. Reference patterns you notice in their answers. Make them feel truly seen and understood.

Respond in this exact JSON format only:
{
  "name": "The [Unique Evocative Name]",
  "emoji": "[single plant/nature emoji]",
  "description": "[4-5 sentences personally written for this person about their patterns, strengths, and approach to life.]",
  "strength": "[Their superpower in 4-6 words]",
  "color": "[hex color matching the vibe]"
}`,
                        messages: [{ role: 'user', content: `Based on these quiz answers, create a unique gardener archetype:\n\n${answerSummary}${lifeMapContext.length > 0 ? `\n\nAdditional context:\n${lifeMapContext.join('\n')}` : ''}` }]
                      })
                    });
                    const data = await response.json();
                    const text = data.content?.[0]?.text;
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                      const result = JSON.parse(jsonMatch[0]);
                      setTempFormData(prev => ({ ...prev, isGenerating: false, generatedResult: result }));
                    } else throw new Error('Parse failed');
                  } catch (error) {
                    console.error('Error generating gardener type:', error);
                    setTempFormData(prev => ({ ...prev, isGenerating: false, generatedResult: {
                      name: "The Gentle Cultivator", emoji: "ðŸŒ±",
                      description: "You have a unique way of nurturing growth in yourself and others. Your approach to life is thoughtful and intentional, always seeking the deeper meaning beneath the surface. You understand that the most beautiful gardens aren't rushed â€” they unfold in their own time. There's a quiet strength in how you tend to the things that matter most.",
                      strength: "Nurturing potential into bloom", color: "#85B79D"
                    }}));
                  }
                };
                
                const currentQ = quizQuestions[quizStep];
                const progress = (quizStep / quizQuestions.length) * 100;
                
                return (
                  <div style={{ ...insightsStyles.section, marginBottom: '2rem', border: '2px solid var(--accent)' }}>
                    {!generatedResult && !isGenerating && (
                      <div style={{ height: '4px', backgroundColor: '#EDE8DD', marginBottom: '1rem', borderRadius: '2px' }}>
                        <div style={{ height: '100%', width: `${progress}%`, backgroundColor: 'var(--accent)', transition: 'width 0.3s', borderRadius: '2px' }} />
                      </div>
                    )}
                    
                    {!generatedResult && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1.5rem' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                          <span style={{ fontSize: '2rem' }}>ðŸŒ±</span>
                          <div>
                            <div style={{ fontWeight: 600, fontSize: '1.1rem' }}>{isGenerating ? 'Discovering your type...' : 'What kind of gardener are you?'}</div>
                            <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>{isGenerating ? 'This takes a moment' : `Question ${quizStep + 1} of ${quizQuestions.length}`}</div>
                          </div>
                        </div>
                        {!isGenerating && <button onClick={() => { setExpandedArea(null); setTempFormData({}); }} style={{ background: 'none', border: 'none', fontSize: '1.5rem', color: 'var(--text-muted)', cursor: 'pointer' }}>Ã—</button>}
                      </div>
                    )}
                    {generatedResult && (
                      <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '0.5rem' }}>
                        <button onClick={() => { setExpandedArea(null); setTempFormData({}); }} style={{ background: 'none', border: 'none', fontSize: '1.5rem', color: 'var(--text-muted)', cursor: 'pointer' }}>Ã—</button>
                      </div>
                    )}
                    
                    {isGenerating ? (
                      <div style={{ textAlign: 'center', padding: '2rem 1rem' }}>
                        <div style={{ fontSize: '3rem', marginBottom: '1rem', animation: 'pulse 1.5s ease-in-out infinite' }}>ðŸŒ±</div>
                        <div style={{ fontWeight: 500 }}>Growing your unique gardener profile...</div>
                        <div style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>Analyzing your answers to create something just for you</div>
                        <style>{`@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); opacity: 0.8; } }`}</style>
                      </div>
                    ) : generatedResult ? (
                      <div>
                        <div style={{ padding: '1.75rem', backgroundColor: `${generatedResult.color}12`, borderRadius: '16px', marginBottom: '1.25rem', border: `1px solid ${generatedResult.color}25` }}>
                          <div style={{ fontSize: '4rem', textAlign: 'center', marginBottom: '0.75rem' }}>{generatedResult.emoji}</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 700, color: generatedResult.color, textAlign: 'center', marginBottom: '0.35rem', fontFamily: "'Fraunces', serif" }}>{generatedResult.name}</div>
                          <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', textAlign: 'center', marginBottom: '1.25rem', textTransform: 'uppercase', letterSpacing: '1px' }}>Your Gardener Type</div>
                          <div style={{ fontSize: '0.95rem', lineHeight: 1.7, textAlign: 'center', marginBottom: '1.25rem' }}>{generatedResult.description}</div>
                          <div style={{ padding: '0.75rem', backgroundColor: 'white', borderRadius: '8px', textAlign: 'center' }}>
                            <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginBottom: '0.25rem', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Your superpower</div>
                            <div style={{ fontSize: '0.95rem', color: generatedResult.color, fontWeight: 600 }}>{generatedResult.strength}</div>
                          </div>
                        </div>
                        <button onClick={() => { setUserProfile(prev => ({ ...prev, tendPreferences: { ...prev?.tendPreferences, gardenerType: { ...generatedResult, answers: quizAnswers, completedAt: new Date().toISOString() } } })); setTempFormData({}); setExpandedArea(null); }}
                          style={{ width: '100%', padding: '1rem', border: 'none', borderRadius: '12px', backgroundColor: generatedResult.color, color: 'white', fontSize: '1rem', cursor: 'pointer', fontWeight: 600 }}>
                          Save my gardener type
                        </button>
                        <button onClick={() => setTempFormData({ quizStep: 0, quizAnswers: {}, isGenerating: false, generatedResult: null })}
                          style={{ width: '100%', padding: '0.75rem', border: 'none', backgroundColor: 'transparent', color: 'var(--text-muted)', fontSize: '0.85rem', cursor: 'pointer', marginTop: '0.75rem' }}>
                          Retake quiz
                        </button>
                      </div>
                    ) : (
                      <div>
                        <div style={{ fontSize: '1.05rem', marginBottom: '1.25rem', fontWeight: 500, lineHeight: 1.4 }}>{currentQ?.q}</div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                          {currentQ?.options.map((option, i) => (
                            <button key={i} onClick={() => {
                              const newAnswers = { ...quizAnswers, [quizStep]: option.id };
                              if (quizStep < quizQuestions.length - 1) setTempFormData({ quizStep: quizStep + 1, quizAnswers: newAnswers });
                              else { setTempFormData({ quizStep, quizAnswers: newAnswers }); generateGardenerType(newAnswers); }
                            }}
                            style={{ padding: '1rem 1.25rem', border: '1px solid var(--border)', borderRadius: '12px', backgroundColor: 'var(--bg-elevated)', fontSize: '0.9rem', cursor: 'pointer', textAlign: 'left', transition: 'all 0.15s' }}
                            onMouseOver={(e) => { e.currentTarget.style.backgroundColor = 'var(--accent-light)'; e.currentTarget.style.borderColor = 'var(--accent)'; }}
                            onMouseOut={(e) => { e.currentTarget.style.backgroundColor = 'var(--bg-elevated)'; e.currentTarget.style.borderColor = 'var(--border)'; }}>
                              {option.text}
                            </button>
                          ))}
                        </div>
                        {quizStep > 0 && <button onClick={() => setTempFormData({ ...tempFormData, quizStep: quizStep - 1 })} style={{ marginTop: '1rem', padding: '0.5rem', border: 'none', backgroundColor: 'transparent', color: 'var(--text-muted)', fontSize: '0.85rem', cursor: 'pointer' }}>â† Back</button>}
                      </div>
                    )}
                  </div>
                );
              }
              
              // If they have a saved gardener type, show it
              if (savedGardenerType) {
                return (
                  <div style={{ ...insightsStyles.section, marginBottom: '2rem', background: `linear-gradient(135deg, ${savedGardenerType.color}08 0%, ${savedGardenerType.color}15 100%)`, border: `1px solid ${savedGardenerType.color}30` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                      <div style={{ fontSize: '3rem' }}>{savedGardenerType.emoji}</div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '0.25rem' }}>Your Gardener Type</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: 700, color: savedGardenerType.color, fontFamily: "'Fraunces', serif" }}>{savedGardenerType.name}</div>
                      </div>
                      <button onClick={() => { setExpandedArea('quiz'); setTempFormData({ quizStep: 0, quizAnswers: {}, isGenerating: false, generatedResult: null }); }}
                        style={{ padding: '0.5rem 1rem', border: `1px solid ${savedGardenerType.color}40`, borderRadius: '8px', backgroundColor: 'transparent', color: savedGardenerType.color, fontSize: '0.8rem', cursor: 'pointer' }}>
                        Retake
                      </button>
                    </div>
                    <div style={{ marginTop: '1rem', fontSize: '0.9rem', lineHeight: 1.6, color: 'var(--text)' }}>{savedGardenerType.description}</div>
                    <div style={{ marginTop: '1rem', padding: '0.6rem 1rem', backgroundColor: 'white', borderRadius: '8px', display: 'inline-block' }}>
                      <span style={{ fontSize: '0.7rem', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Superpower: </span>
                      <span style={{ fontSize: '0.85rem', color: savedGardenerType.color, fontWeight: 600 }}>{savedGardenerType.strength}</span>
                    </div>
                  </div>
                );
              }
              
              // Otherwise show the quiz teaser
              return (
                <div onClick={() => setExpandedArea('quiz')} style={{
                  ...insightsStyles.section,
                  marginBottom: '2rem',
                  background: 'linear-gradient(135deg, #F5EBD9 0%, #FBF7F0 100%)',
                  border: '1px solid #E8DCC8',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '1rem',
                  transition: 'transform 0.15s, box-shadow 0.15s',
                }}
                onMouseOver={(e) => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)'; }}
                onMouseOut={(e) => { e.currentTarget.style.transform = 'none'; e.currentTarget.style.boxShadow = 'none'; }}>
                  <div style={{ fontSize: '2.5rem' }}>ðŸŒ»</div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, color: '#5D4E37', fontSize: '1rem', marginBottom: '0.25rem' }}>What kind of gardener are you?</div>
                    <div style={{ fontSize: '0.85rem', color: '#8A7B62' }}>Take a 2-minute quiz to discover your unique tending style</div>
                  </div>
                  <div style={{ color: '#8A7B62', fontSize: '1.5rem' }}>â†’</div>
                </div>
              );
            })()}
            

            {/* Your Life Map - Visual Knowledge Graph */}
            <div style={insightsStyles.section}>
              <h3 style={insightsStyles.sectionTitle}>
                <span>âœ¨</span>
                <span>Your Life Map</span>
              </h3>
              
              {/* Visual Knowledge Graph */}
              {(() => {
                const prefs = userProfile?.tendPreferences || {};
                
                // Collect all facts from profile, tracking multi-domain facts
                const allFacts = [];
                const domainFactCounts = {};
                VLQ_ORDER.forEach(d => domainFactCounts[d] = 0);
                
                // Check for multi-domain facts (stored as comma-separated domains)
                const multiDomainFacts = prefs.multiDomainFacts || [];
                
                VLQ_ORDER.forEach(domain => {
                  const color = VLQ_DOMAINS[domain]?.color || '#888';
                  const structured = prefs.structuredInfo?.[domain] || {};
                  const notes = prefs.lifeAreaNotes?.[domain];
                  
                  Object.entries(structured).forEach(([key, value]) => {
                    if (value) {
                      allFacts.push({ domain, domains: [domain], text: value, color, type: 'structured' });
                      domainFactCounts[domain]++;
                    }
                  });
                  
                  if (notes) {
                    allFacts.push({ domain, domains: [domain], text: notes, color, type: 'notes' });
                    domainFactCounts[domain]++;
                  }
                });
                
                // Add multi-domain facts
                multiDomainFacts.forEach(fact => {
                  if (fact.domains && fact.domains.length > 0 && fact.text) {
                    const primaryDomain = fact.domains[0];
                    allFacts.push({
                      domain: primaryDomain,
                      domains: fact.domains,
                      text: fact.text,
                      color: VLQ_DOMAINS[primaryDomain]?.color || '#888',
                      type: 'multi'
                    });
                    fact.domains.forEach(d => domainFactCounts[d]++);
                  }
                });
                
                // Calculate icon scale based on fact count (1.0 to 1.6)
                const maxFacts = Math.max(...Object.values(domainFactCounts), 1);
                const getIconScale = (domain) => {
                  const count = domainFactCounts[domain] || 0;
                  if (count === 0) return 1.0;
                  return 1.0 + (count / maxFacts) * 0.6; // Scale from 1.0 to 1.6
                };
                
                // Cleaner SVG layout - wider to prevent overlap
                const width = 400;
                const height = 280;
                const centerX = width / 2;
                const centerY = height / 2;
                
                // Position facts in layers around center
                const factNodes = allFacts.map((fact, i) => {
                  const angle = (i / Math.max(allFacts.length, 1)) * Math.PI * 2 - Math.PI / 2;
                  const layer = Math.floor(i / 8);
                  const radius = 50 + layer * 25;
                  return { ...fact, x: centerX + Math.cos(angle) * radius, y: centerY + Math.sin(angle) * radius };
                });
                
                // Life area icons - positioned in a wider ellipse, with growing sizes
                const categoryNodes = VLQ_ORDER.map((domain, i) => {
                  const angle = (i / VLQ_ORDER.length) * Math.PI * 2 - Math.PI / 2;
                  const hasContent = prefs.structuredInfo?.[domain] || prefs.lifeAreaNotes?.[domain];
                  const factCount = domainFactCounts[domain] || 0;
                  const scale = getIconScale(domain);
                  return {
                    domain,
                    icon: VLQ_DOMAINS[domain]?.icon,
                    color: VLQ_DOMAINS[domain]?.color,
                    x: centerX + Math.cos(angle) * 160,
                    y: centerY + Math.sin(angle) * 100,
                    hasContent: !!hasContent,
                    factCount,
                    scale,
                    baseRadius: 20,
                  };
                });
                
                // Find multi-domain connections (facts that link multiple areas)
                const connections = [];
                allFacts.filter(f => f.domains && f.domains.length > 1).forEach(fact => {
                  const domainNodes = fact.domains.map(d => categoryNodes.find(n => n.domain === d)).filter(Boolean);
                  for (let i = 0; i < domainNodes.length; i++) {
                    for (let j = i + 1; j < domainNodes.length; j++) {
                      connections.push({
                        from: domainNodes[i],
                        to: domainNodes[j],
                        color: fact.color,
                        text: fact.text
                      });
                    }
                  }
                });
                
                return (
                  <div>
                    {/* The Constellation */}
                    <div style={{
                      position: 'relative',
                      background: 'linear-gradient(180deg, #FDFBF7 0%, #F8F4EC 100%)',
                      borderRadius: '20px',
                      padding: '1.25rem 0.5rem',
                      marginBottom: '1rem',
                      border: '1px solid #EDE8DD',
                    }}>
                      <svg width={width} height={height} style={{ display: 'block', margin: '0 auto' }}>
                        {/* Subtle decorative rings */}
                        <circle cx={centerX} cy={centerY} r="30" fill="none" stroke="#C5B89A" strokeWidth="0.5" opacity="0.2" />
                        <circle cx={centerX} cy={centerY} r="65" fill="none" stroke="#C5B89A" strokeWidth="0.5" opacity="0.15" strokeDasharray="3 3" />
                        
                        {/* Multi-domain connection lines (curved) */}
                        {connections.map((conn, i) => {
                          const midX = (conn.from.x + conn.to.x) / 2;
                          const midY = (conn.from.y + conn.to.y) / 2;
                          // Curve toward center
                          const ctrlX = midX + (centerX - midX) * 0.5;
                          const ctrlY = midY + (centerY - midY) * 0.5;
                          return (
                            <g key={`conn-${i}`}>
                              <path
                                d={`M ${conn.from.x} ${conn.from.y} Q ${ctrlX} ${ctrlY} ${conn.to.x} ${conn.to.y}`}
                                fill="none"
                                stroke={conn.color}
                                strokeWidth="2.5"
                                opacity="0.35"
                                strokeLinecap="round"
                              />
                              <title>{conn.text}</title>
                            </g>
                          );
                        })}
                        
                        {/* Connection lines from center to facts */}
                        {factNodes.map((node, i) => (
                          <line key={`line-${i}`} x1={centerX} y1={centerY} x2={node.x} y2={node.y}
                            stroke={node.color} strokeWidth="1.5" opacity="0.2" />
                        ))}
                        
                        {/* Fact nodes (colored dots) */}
                        {factNodes.map((node, i) => (
                          <g key={`fact-${i}`}>
                            <circle cx={node.x} cy={node.y} r={node.domains?.length > 1 ? 7 : 5} 
                              fill={node.color} opacity="0.85" 
                              stroke={node.domains?.length > 1 ? "white" : "none"}
                              strokeWidth={node.domains?.length > 1 ? 2 : 0} />
                            <title>{node.text}{node.domains?.length > 1 ? ` (${node.domains.map(d => VLQ_DOMAINS[d]?.name).join(' + ')})` : ''}</title>
                          </g>
                        ))}
                        
                        {/* Category icons (outer ellipse) - with growing sizes */}
                        {categoryNodes.map((node, i) => {
                          const r = node.baseRadius * node.scale;
                          const fontSize = 15 * node.scale;
                          return (
                            <g key={`cat-${i}`} style={{ cursor: 'pointer' }}
                              onClick={() => setExpandedArea(expandedArea === node.domain ? null : node.domain)}>
                              <circle cx={node.x} cy={node.y} r={r}
                                fill={node.hasContent ? node.color : '#FDFBF7'}
                                stroke={node.color} strokeWidth={node.hasContent ? "0" : "1.5"}
                                opacity={node.hasContent ? 0.85 : 0.6} />
                              <text x={node.x} y={node.y + fontSize * 0.4} textAnchor="middle" fontSize={fontSize} style={{ pointerEvents: 'none' }}>
                                {node.icon}
                              </text>
                              {node.factCount > 0 && (
                                <g>
                                  <circle cx={node.x + r * 0.7} cy={node.y - r * 0.7} r="8" fill="var(--accent)" />
                                  <text x={node.x + r * 0.7} y={node.y - r * 0.7 + 3} textAnchor="middle" fill="white" fontSize="9" fontWeight="600">
                                    {node.factCount}
                                  </text>
                                </g>
                              )}
                            </g>
                          );
                        })}
                        
                        {/* Center node */}
                        <circle cx={centerX} cy={centerY} r="28" fill="var(--accent)" />
                        <text x={centerX} y={centerY - 2} textAnchor="middle" fill="white" fontSize="11" fontWeight="600">You</text>
                        <text x={centerX} y={centerY + 11} textAnchor="middle" fill="white" fontSize="9" opacity="0.9">
                          {allFacts.length} {allFacts.length === 1 ? 'fact' : 'facts'}
                        </text>
                      </svg>
                      
                      {/* Empty state text - positioned below SVG */}
                      {allFacts.length === 0 && (
                        <div style={{ textAlign: 'center', color: '#9A8F7D', fontSize: '0.8rem', marginTop: '-0.25rem' }}>
                          Tap any icon to start building your map
                        </div>
                      )}
                    </div>
                    
                    {/* Life Area Discovery Cards */}
                    {expandedArea && expandedArea !== 'quiz' && (() => {
                      const domain = expandedArea;
                      const areaConfig = LIFE_AREA_PROMPTS[domain];
                      const prefs = userProfile?.tendPreferences || {};
                      const notes = prefs.lifeAreaNotes?.[domain] || '';
                      const structured = prefs.structuredInfo?.[domain] || {};
                      const hasInfo = notes || Object.values(structured).some(v => v);
                      const domainColor = VLQ_DOMAINS[domain]?.color;
                      
                      // Discovery questions with input fields per area
                      const discoveryQs = {
                        family: [
                          { key: 'closeTo', q: "Who are you closest to?", placeholder: "Names, relationships..." },
                          { key: 'tradition', q: "What's a tradition you cherish?", placeholder: "Weekly calls, holiday rituals..." },
                        ],
                        partner: [
                          { key: 'name', q: "What's their name?", placeholder: "Your person..." },
                          { key: 'together', q: "What do you love doing together?", placeholder: "Cooking, hiking, lazy Sundays..." },
                        ],
                        friendships: [
                          { key: 'crew', q: "Who's in your inner circle?", placeholder: "Best friends, your people..." },
                          { key: 'hangout', q: "How do you like to connect?", placeholder: "Calls, dinners, adventures..." },
                        ],
                        career: [
                          { key: 'role', q: "What do you do?", placeholder: "Your work, your craft..." },
                          { key: 'focus', q: "What's energizing you right now?", placeholder: "Projects, goals, challenges..." },
                        ],
                        education: [
                          { key: 'learning', q: "What are you learning?", placeholder: "Skills, subjects, interests..." },
                          { key: 'curious', q: "What makes you curious?", placeholder: "Topics you'd love to explore..." },
                        ],
                        recreation: [
                          { key: 'fun', q: "What's fun for you?", placeholder: "Hobbies, guilty pleasures..." },
                          { key: 'loseTrack', q: "What makes you lose track of time?", placeholder: "That thing you could do for hours..." },
                        ],
                        spirituality: [
                          { key: 'peace', q: "What brings you peace?", placeholder: "Meditation, nature, music..." },
                          { key: 'believe', q: "What do you believe in?", placeholder: "Values, faith, philosophy..." },
                        ],
                        community: [
                          { key: 'belong', q: "Where do you feel you belong?", placeholder: "Groups, places, causes..." },
                          { key: 'give', q: "How do you like to give back?", placeholder: "Volunteering, helping..." },
                        ],
                        health: [
                          { key: 'move', q: "How do you like to move?", placeholder: "Workouts, sports, dancing..." },
                          { key: 'fuel', q: "What makes your body feel good?", placeholder: "Foods, habits, routines..." },
                        ],
                        mentalHealth: [
                          { key: 'recharge', q: "How do you recharge?", placeholder: "Rest, solitude, activities..." },
                          { key: 'boundaries', q: "What boundaries matter to you?", placeholder: "Time, energy, space..." },
                        ],
                      };
                      
                      const questions = discoveryQs[domain] || [];
                      
                      return (
                        <div style={{
                          backgroundColor: '#FFFDF9',
                          borderRadius: '20px',
                          border: `2px solid ${domainColor}60`,
                          padding: '1.5rem',
                          marginBottom: '1rem',
                        }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1.25rem' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                              <span style={{ 
                                fontSize: '1.75rem', width: '48px', height: '48px',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                backgroundColor: `${domainColor}15`, borderRadius: '12px',
                              }}>
                                {VLQ_DOMAINS[domain]?.icon}
                              </span>
                              <div>
                                <div style={{ fontWeight: 600, color: 'var(--text)', fontSize: '1.1rem' }}>
                                  {areaConfig?.title || VLQ_DOMAINS[domain]?.name}
                                </div>
                                <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)', marginTop: '0.1rem' }}>
                                  {hasInfo ? `${Object.values(structured).filter(v => v).length + (notes ? 1 : 0)} things shared` : 'Tell me about this part of your life'}
                                </div>
                              </div>
                            </div>
                            <button onClick={() => { setExpandedArea(null); setTempFormData({}); setTempNotes(''); }}
                              style={{ background: 'none', border: 'none', fontSize: '1.5rem', color: 'var(--text-muted)', cursor: 'pointer' }}>Ã—</button>
                          </div>
                          
                          {/* Current answers display */}
                          {hasInfo && (
                            <div style={{ marginBottom: '1.25rem', padding: '1rem', backgroundColor: `${domainColor}08`, borderRadius: '12px' }}>
                              {Object.entries(structured).filter(([_, v]) => v).map(([key, value]) => (
                                <div key={key} style={{ display: 'flex', alignItems: 'flex-start', gap: '0.5rem', padding: '0.35rem 0' }}>
                                  <span style={{ color: domainColor }}>â€¢</span>
                                  <span style={{ color: 'var(--text)', fontSize: '0.9rem' }}>{value}</span>
                                </div>
                              ))}
                              {notes && (
                                <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.5rem', padding: '0.35rem 0' }}>
                                  <span style={{ color: domainColor }}>â€¢</span>
                                  <span style={{ color: 'var(--text)', fontSize: '0.9rem' }}>{notes}</span>
                                </div>
                              )}
                            </div>
                          )}
                          
                          {/* Question inputs - each question with its own text box */}
                          {questions.map((item) => (
                            <div key={item.key} style={{ marginBottom: '1.25rem' }}>
                              <label style={{ display: 'block', fontSize: '0.95rem', color: 'var(--text)', marginBottom: '0.5rem', fontWeight: 500 }}>
                                {item.q}
                              </label>
                              <input type="text" value={tempFormData[item.key] !== undefined ? tempFormData[item.key] : (structured[item.key] || '')}
                                onChange={(e) => setTempFormData(prev => ({...prev, [item.key]: e.target.value}))}
                                placeholder={item.placeholder}
                                style={{
                                  width: '100%', padding: '0.85rem 1rem', border: '1px solid #E5DFD3', borderRadius: '12px',
                                  backgroundColor: 'white', color: 'var(--text)', fontSize: '0.9rem', boxSizing: 'border-box',
                                }}
                              />
                            </div>
                          ))}
                          
                          {/* Custom AI-generated questions */}
                          {tempFormData.customQuestions?.map((item, idx) => (
                            <div key={`custom_${idx}`} style={{ marginBottom: '1.25rem' }}>
                              <label style={{ display: 'block', fontSize: '0.95rem', color: 'var(--text)', marginBottom: '0.5rem', fontWeight: 500 }}>
                                {item.q}
                              </label>
                              <input type="text" value={tempFormData[`custom_${idx}`] || ''}
                                onChange={(e) => setTempFormData(prev => ({...prev, [`custom_${idx}`]: e.target.value}))}
                                placeholder={item.placeholder}
                                style={{
                                  width: '100%', padding: '0.85rem 1rem', border: '1px solid #E5DFD3', borderRadius: '12px',
                                  backgroundColor: 'white', color: 'var(--text)', fontSize: '0.9rem', boxSizing: 'border-box',
                                }}
                              />
                            </div>
                          ))}
                          
                          {/* Request different questions */}
                          <button
                            onClick={async () => {
                              if (!apiKey) return;
                              setTempFormData(prev => ({ ...prev, loadingNewQs: true }));
                              try {
                                const existingQs = questions.map(q => q.q).join(', ');
                                const customQs = tempFormData.customQuestions?.map(q => q.q).join(', ') || '';
                                const response = await fetch('https://api.anthropic.com/v1/messages', {
                                  method: 'POST',
                                  headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                                  body: JSON.stringify({
                                    model: 'claude-sonnet-4-20250514',
                                    max_tokens: 200,
                                    system: `Generate 1 new discovery question for the "${VLQ_DOMAINS[domain]?.name}" life area. This should be a warm, personal question that helps someone share about this part of their life. Make it different from these existing questions: ${existingQs}${customQs ? `, ${customQs}` : ''}

Respond in JSON only: {"q": "Your question here?", "placeholder": "Example hints..."}`,
                                    messages: [{ role: 'user', content: 'Generate a new question.' }]
                                  })
                                });
                                const data = await response.json();
                                const text = data.content?.[0]?.text;
                                const jsonMatch = text.match(/\{[\s\S]*\}/);
                                if (jsonMatch) {
                                  const newQ = JSON.parse(jsonMatch[0]);
                                  setTempFormData(prev => ({ 
                                    ...prev, 
                                    loadingNewQs: false,
                                    customQuestions: [...(prev.customQuestions || []), newQ]
                                  }));
                                }
                              } catch (e) {
                                console.error('Error generating question:', e);
                                setTempFormData(prev => ({ ...prev, loadingNewQs: false }));
                              }
                            }}
                            disabled={tempFormData.loadingNewQs || !apiKey}
                            style={{
                              display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem',
                              width: '100%', padding: '0.7rem', marginBottom: '1.25rem',
                              border: '1px dashed #D5CCBA', borderRadius: '10px',
                              backgroundColor: 'transparent', color: '#8A7B62', fontSize: '0.85rem',
                              cursor: (tempFormData.loadingNewQs || !apiKey) ? 'default' : 'pointer',
                              opacity: (tempFormData.loadingNewQs || !apiKey) ? 0.5 : 1,
                            }}
                          >
                            {tempFormData.loadingNewQs ? 'âœ¨ Generating...' : 'âœ¨ Give me a different question'}
                          </button>
                          
                          {/* Free-form notes */}
                          <div style={{ marginBottom: '1.25rem' }}>
                            <label style={{ display: 'block', fontSize: '0.95rem', color: 'var(--text)', marginBottom: '0.5rem', fontWeight: 500 }}>
                              Anything else?
                            </label>
                            <textarea value={tempNotes !== '' ? tempNotes : notes}
                              onChange={(e) => setTempNotes(e.target.value)}
                              placeholder="Write whatever comes to mind..."
                              rows={2}
                              style={{
                                width: '100%', padding: '0.85rem 1rem', border: '1px solid #E5DFD3', borderRadius: '12px',
                                backgroundColor: 'white', color: 'var(--text)', fontSize: '0.9rem', resize: 'vertical', boxSizing: 'border-box',
                              }}
                            />
                          </div>
                          
                          <button
                            onClick={() => {
                              const newStructured = { ...structured };
                              // Save regular and custom question responses
                              Object.keys(tempFormData).forEach(k => {
                                // Skip helper properties, only save actual answers
                                if (k !== 'loadingNewQs' && k !== 'customQuestions' && tempFormData[k] !== undefined && tempFormData[k] !== '') {
                                  newStructured[k] = tempFormData[k];
                                }
                              });
                              // Also save custom question responses with their question text as context
                              if (tempFormData.customQuestions) {
                                tempFormData.customQuestions.forEach((q, idx) => {
                                  const answer = tempFormData[`custom_${idx}`];
                                  if (answer) {
                                    newStructured[`custom_${idx}`] = answer;
                                  }
                                });
                              }
                              setUserProfile(prev => ({
                                ...prev,
                                tendPreferences: {
                                  ...prev?.tendPreferences,
                                  structuredInfo: { ...prev?.tendPreferences?.structuredInfo, [domain]: newStructured },
                                  lifeAreaNotes: { ...prev?.tendPreferences?.lifeAreaNotes, [domain]: tempNotes || notes || undefined }
                                }
                              }));
                              setTempFormData({});
                              setTempNotes('');
                              setExpandedArea(null);
                            }}
                            style={{
                              width: '100%', padding: '1rem', border: 'none', borderRadius: '12px',
                              backgroundColor: domainColor, color: 'white', fontSize: '1rem', cursor: 'pointer', fontWeight: 600,
                            }}
                          >
                            Save to my map
                          </button>
                        </div>
                      );
                    })()}
                    
                    {/* Quick category pills */}
                    {!expandedArea && (
                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem', justifyContent: 'center' }}>
                        {VLQ_ORDER.map(domain => {
                          const hasContent = prefs.structuredInfo?.[domain] || prefs.lifeAreaNotes?.[domain];
                          const color = VLQ_DOMAINS[domain]?.color;
                          return (
                            <button key={domain} onClick={() => setExpandedArea(domain)}
                              style={{
                                padding: '0.5rem 0.85rem',
                                border: hasContent ? 'none' : '1.5px dashed #D5CCBA',
                                borderRadius: '20px',
                                backgroundColor: hasContent ? `${color}18` : 'transparent',
                                color: hasContent ? color : '#9A8F7D',
                                fontSize: '0.8rem', cursor: 'pointer',
                                display: 'flex', alignItems: 'center', gap: '0.4rem',
                                fontWeight: hasContent ? 500 : 400,
                              }}
                            >
                              <span>{VLQ_DOMAINS[domain]?.icon}</span>
                              <span>{VLQ_DOMAINS[domain]?.name}</span>
                            </button>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })()}
            </div>
            
            {/* Overview Stats */}
            <div style={insightsStyles.section}>
              <h3 style={insightsStyles.sectionTitle}>
                <span>ðŸ“Š</span>
                <span>Your Progress</span>
              </h3>
              <div style={insightsStyles.statsGrid}>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.dailyTends.totalCompleted}</div>
                  <div style={insightsStyles.statLabel}>Daily Tends Completed</div>
                </div>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.dailyTends.currentStreak}</div>
                  <div style={insightsStyles.statLabel}>Current Streak</div>
                </div>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.journaling.totalEntries}</div>
                  <div style={insightsStyles.statLabel}>Journal Entries</div>
                </div>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.journaling.currentStreak}</div>
                  <div style={insightsStyles.statLabel}>Journal Streak</div>
                </div>
              </div>
            </div>
            
            {/* Daily Tends by Life Area - WITH CHART */}
            <div style={insightsStyles.section}>
              <h3 style={insightsStyles.sectionTitle}>
                <span>ðŸŒ±</span>
                <span>Daily Tends by Life Area</span>
              </h3>
              {Object.keys(trends.dailyTends.byLifeArea).filter(key => {
                const stats = trends.dailyTends.byLifeArea[key];
                return stats.completed + stats.skipped > 0;
              }).length > 0 ? (
                <>
                  {/* OPTION A: Bar Chart */}
                  <div style={{marginBottom: '1.5rem'}}>
                    {Object.entries(trends.dailyTends.byLifeArea)
                      .filter(([_, stats]) => stats.completed + stats.skipped > 0)
                      .sort((a, b) => b[1].completionRate - a[1].completionRate)
                      .map(([areaKey, stats]) => {
                        const area = VLQ_DOMAINS[areaKey];
                        if (!area) return null;
                        return (
                          <div key={areaKey} style={{marginBottom: '1rem'}}>
                            <div style={{
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center',
                              marginBottom: '0.375rem'
                            }}>
                              <div style={{fontSize: '0.85rem', color: 'var(--text)'}}>
                                {area.icon} {area.name}
                              </div>
                              <div style={{fontSize: '0.85rem', fontWeight: 600, color: 'var(--accent)'}}>
                                {stats.completionRate}%
                              </div>
                            </div>
                            {/* Bar Chart */}
                            <div style={{
                              width: '100%',
                              height: '8px',
                              backgroundColor: 'var(--bg-elevated)',
                              borderRadius: '4px',
                              overflow: 'hidden'
                            }}>
                              <div style={{
                                width: `${stats.completionRate}%`,
                                height: '100%',
                                backgroundColor: 'var(--accent)',
                                borderRadius: '4px',
                                transition: 'width 0.3s ease'
                              }}></div>
                            </div>
                            <div style={{
                              fontSize: '0.7rem',
                              color: 'var(--text-muted)',
                              marginTop: '0.25rem'
                            }}>
                              {stats.completed} completed, {stats.skipped} skipped
                            </div>
                          </div>
                        );
                      })}
                  </div>
                </>
              ) : (
                <div style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>
                  Complete some daily tends to see your progress!
                </div>
              )}
            </div>
            
            {/* OPTION D: Patterns Section */}
            {trends.patterns && Object.keys(trends.patterns).length > 0 && (
              <div style={insightsStyles.section}>
                <h3 style={insightsStyles.sectionTitle}>
                  <span>âœ¨</span>
                  <span>Your Patterns</span>
                </h3>
                <div style={{
                  display: 'flex',
                  flexDirection: 'column',
                  gap: '0.75rem'
                }}>
                  {trends.patterns.mostJournalingDay && (
                    <div style={{
                      padding: '0.75rem',
                      backgroundColor: 'var(--bg-elevated)',
                      borderRadius: '8px',
                      fontSize: '0.85rem',
                      color: 'var(--text)'
                    }}>
                      ðŸ“ You journal most on <strong>{trends.patterns.mostJournalingDay}s</strong>
                    </div>
                  )}
                  {trends.patterns.mostProductiveDay && (
                    <div style={{
                      padding: '0.75rem',
                      backgroundColor: 'var(--bg-elevated)',
                      borderRadius: '8px',
                      fontSize: '0.85rem',
                      color: 'var(--text)'
                    }}>
                      ðŸŒ± You complete the most tends on <strong>{trends.patterns.mostProductiveDay}s</strong>
                    </div>
                  )}
                  {trends.patterns.longestJournalStreak > 0 && (
                    <div style={{
                      padding: '0.75rem',
                      backgroundColor: 'var(--bg-elevated)',
                      borderRadius: '8px',
                      fontSize: '0.85rem',
                      color: 'var(--text)'
                    }}>
                      ðŸ”¥ Your longest journal streak: <strong>{trends.patterns.longestJournalStreak} days</strong>
                    </div>
                  )}
                  {trends.patterns.completionTrend && (
                    <div style={{
                      padding: '0.75rem',
                      backgroundColor: 'var(--bg-elevated)',
                      borderRadius: '8px',
                      fontSize: '0.85rem',
                      color: 'var(--text)'
                    }}>
                      ðŸ“Š {trends.patterns.completionTrend}
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* Goals Progress */}
            {trends.goals.totalCreated > 0 && (
              <div style={insightsStyles.section}>
                <h3 style={insightsStyles.sectionTitle}>
                  <span>ðŸŽ¯</span>
                  <span>Goals</span>
                </h3>
                <div style={insightsStyles.statsGrid}>
                  <div style={insightsStyles.statCard}>
                    <div style={insightsStyles.statValue}>{trends.goals.completed}</div>
                    <div style={insightsStyles.statLabel}>Completed</div>
                  </div>
                  <div style={insightsStyles.statCard}>
                    <div style={insightsStyles.statValue}>{trends.goals.inProgress}</div>
                    <div style={insightsStyles.statLabel}>In Progress</div>
                  </div>
                  <div style={insightsStyles.statCard}>
                    <div style={insightsStyles.statValue}>{trends.goals.completionRate}%</div>
                    <div style={insightsStyles.statLabel}>Completion Rate</div>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    const styles = {
      container: { height: '100vh', maxHeight: '100vh', display: 'flex', flexDirection: 'column', backgroundColor: 'var(--bg-main)', overflow: 'hidden' },
      header: { padding: '0.875rem 2rem', borderBottom: '1px solid var(--border)', backgroundColor: 'var(--bg-card)', display: 'flex', alignItems: 'baseline', gap: '1rem' },
      logoContainer: { display: 'flex', alignItems: 'center' },
      logoText: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", fontWeight: 400, color: 'var(--text)' },
      tagline: { fontSize: '0.85rem', color: 'var(--text-muted)', fontStyle: 'italic', flex: 1 },
      settingsButton: { background: 'none', border: 'none', fontSize: '1.25rem', color: 'var(--text-muted)', cursor: 'pointer', padding: '0.25rem', opacity: 0.7, transition: 'opacity 0.2s' },

      main: { display: 'grid', gridTemplateColumns: '64px 1fr 320px', flex: 1, height: 'calc(100vh - 56px)', overflow: 'hidden' },

      sidebar: { backgroundColor: 'var(--bg-card)', borderRight: '1px solid var(--border)', display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden' },
      sidebarResizeHandle: { position: 'absolute', right: 0, top: 0, bottom: 0, width: '4px', cursor: 'ew-resize', backgroundColor: 'transparent', zIndex: 10, transition: 'background-color 0.2s' },
      sidebarNav: { display: 'flex', flexDirection: 'column', padding: '0.75rem 0.5rem', gap: '0.25rem', borderBottom: '1px solid var(--border)' },
      sidebarNavItem: { display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem', border: 'none', borderRadius: '10px', cursor: 'pointer', transition: 'background-color 0.2s', textAlign: 'left', width: '100%' },
      sidebarNavItemActive: { backgroundColor: 'var(--bg-elevated)' },
      sidebarNavIcon: { fontSize: '1.25rem', flexShrink: 0 },
      sidebarNavLabel: { fontSize: '0.85rem', color: 'var(--text)', fontWeight: 500, whiteSpace: 'nowrap', overflow: 'hidden', transition: 'opacity 0.2s, width 0.2s' },
      tabs: { display: 'flex', flex: 1 },
      tab: { flex: 1, padding: '0.875rem 0.375rem', backgroundColor: 'transparent', border: 'none', borderBottom: '2px solid transparent', color: 'var(--text-muted)', fontSize: '0.7rem', fontWeight: 500, cursor: 'pointer', whiteSpace: 'nowrap' },
      tabActive: { color: 'var(--text)', borderBottomColor: 'var(--accent)' },
      tabContent: { flex: 1, overflow: 'auto', padding: '1rem', minHeight: 0 },
      tabPlaceholder: { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', padding: '2rem' },
      placeholderText: { color: 'var(--text-muted)', fontSize: '0.85rem', textAlign: 'center', fontStyle: 'italic' },

      eventsTab: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      addItemButton: { padding: '0.625rem 1rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '8px', color: 'white', fontSize: '0.8rem', cursor: 'pointer', alignSelf: 'flex-start' },
      eventsList: { display: 'flex', flexDirection: 'column', gap: '0.5rem' },
      eventCard: { backgroundColor: 'var(--bg-elevated)', borderRadius: '10px', overflow: 'hidden' },
      eventHeader: { padding: '0.875rem 1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer' },
      eventHeaderLeft: { display: 'flex', alignItems: 'center', gap: '0.625rem' },
      eventDot: { width: '8px', height: '8px', borderRadius: '50%', flexShrink: 0 },
      eventMonth: { fontSize: '0.7rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase' },
      eventTitle: { fontSize: '0.875rem', color: 'var(--text)' },
      expandIcon: { color: 'var(--text-muted)', fontSize: '1rem' },
      eventDetails: { padding: '0 1rem 1rem', display: 'flex', flexDirection: 'column', gap: '0.75rem', borderTop: '1px solid var(--border)', paddingTop: '0.875rem' },
      detailField: { display: 'flex', flexDirection: 'column', gap: '0.25rem' },
      detailLabel: { fontSize: '0.7rem', color: 'var(--text-muted)' },
      detailInput: { padding: '0.5rem 0.75rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '6px', fontSize: '0.8rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none' },
      deleteEventButton: { padding: '0.5rem', backgroundColor: 'transparent', border: '1px solid var(--border)', borderRadius: '6px', color: 'var(--text-muted)', fontSize: '0.75rem', cursor: 'pointer', marginTop: '0.25rem' },
      emptyText: { color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic' },
      tipText: { color: 'var(--text-muted)', fontSize: '0.75rem', marginTop: 'auto', paddingTop: '1rem' },

      notesTab: { height: '100%' },
      notesTextarea: { width: '100%', height: '100%', minHeight: '300px', padding: '1rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.875rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none', lineHeight: 1.7 },

      goalsTab: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      goalsList: { display: 'flex', flexDirection: 'column', gap: '0.5rem' },
      goalCard: { display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '8px' },
      goalCheck: { width: '20px', height: '20px', borderRadius: '50%', border: '2px solid var(--accent)', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', color: 'white', fontSize: '0.7rem', flexShrink: 0 },
      goalText: { flex: 1, fontSize: '0.875rem', color: 'var(--text)' },
      goalDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1rem', opacity: 0.5 },

      centerPanel: { display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '1.5rem 1.25rem', backgroundColor: 'var(--bg-main)', gap: '1.5rem', overflow: 'auto', height: '100%', minHeight: 0 },
      viewSwitcher: { display: 'flex', gap: '2px', backgroundColor: 'var(--bg-card)', padding: '4px', borderRadius: '12px', border: '1px solid var(--border)' },
      viewButton: { padding: '0.5rem 1rem', backgroundColor: 'transparent', border: 'none', borderRadius: '10px', color: 'var(--text-muted)', fontSize: '0.8rem', fontWeight: 500, cursor: 'pointer', transition: 'all 0.2s ease' },
      viewButtonActive: { backgroundColor: 'var(--accent)', color: 'white' },

      circleContainer: { display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '1rem' },
      circleAddButton: { padding: '0.5rem 1.25rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '20px', color: 'white', fontSize: '0.8rem', cursor: 'pointer' },

      // Seasons
      seasonsContainer: { width: '100%', maxWidth: '580px' },
      seasonsGrid: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem' },
      seasonCard: { borderRadius: '16px', overflow: 'hidden', border: '2px solid transparent' },
      seasonDecorative: { padding: '0.75rem', display: 'flex', justifyContent: 'center', gap: '0.75rem', fontSize: '1rem', opacity: 0.7 },
      seasonCardContent: { padding: '1rem', backgroundColor: 'var(--bg-card)', borderBottomLeftRadius: '14px', borderBottomRightRadius: '14px' },
      seasonCardHeader: { marginBottom: '0.5rem', position: 'relative' },
      seasonName: { fontSize: '1.125rem', fontFamily: "'Fraunces', serif", marginBottom: '0.125rem' },
      seasonMonths: { fontSize: '0.75rem', color: 'var(--text-muted)' },
      currentBadge: { position: 'absolute', top: 0, right: 0, fontSize: '0.6rem', color: 'white', padding: '0.2rem 0.5rem', borderRadius: '8px' },
      seasonDescription: { fontSize: '0.75rem', color: 'var(--text-muted)', lineHeight: 1.5, marginBottom: '0.75rem', fontStyle: 'italic' },
      seasonIntentionBox: { },
      seasonLabel: { fontSize: '0.7rem', fontWeight: 500, display: 'block', marginBottom: '0.375rem' },
      seasonTextarea: { width: '100%', padding: '0.625rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', fontSize: '0.8rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none', lineHeight: 1.5 },

      // Monthly
      monthlyContainer: { width: '100%', maxWidth: '500px', display: 'flex', flexDirection: 'column', gap: '1rem' },
      monthStrip: { display: 'flex', gap: '2px', backgroundColor: 'var(--bg-card)', padding: '4px', borderRadius: '10px', border: '1px solid var(--border)' },
      monthStripButton: { flex: 1, padding: '0.5rem 0.25rem', border: 'none', borderRadius: '6px', fontSize: '0.65rem', fontWeight: 500, cursor: 'pointer', transition: 'all 0.2s ease' },
      calendarWrapper: { backgroundColor: 'var(--bg-card)', borderRadius: '16px', overflow: 'hidden', border: '1px solid var(--border)' },
      calendarHeader: { padding: '0.875rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', opacity: 0.85 },
      calendarNav: { background: 'none', border: 'none', color: 'white', fontSize: '1.25rem', cursor: 'pointer', padding: '0 0.5rem', opacity: 0.9 },
      calendarTitle: { color: 'white', fontSize: '1rem', fontFamily: "'Fraunces', serif" },
      calendarBody: { padding: '1rem' },
      calendarGrid: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' },
      calendarDayHeader: { padding: '0.5rem', textAlign: 'center', fontSize: '0.65rem', color: 'var(--text-muted)', fontWeight: 500 },
      calendarDayEmpty: { aspectRatio: '1' },
      calendarDay: { aspectRatio: '1', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.8rem', color: 'var(--text-light)', backgroundColor: 'var(--bg-elevated)', borderRadius: '8px' },
      calendarDayToday: { color: 'white', fontWeight: 600 },
      monthEventsSection: { display: 'flex', flexDirection: 'column', gap: '0.5rem', alignItems: 'center' },
      monthEventsList: { width: '100%', display: 'flex', flexDirection: 'column', gap: '0.375rem' },
      monthEventItem: { display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-card)', borderRadius: '8px', fontSize: '0.85rem', border: '1px solid var(--border)' },
      noEventsText: { color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic' },
      addEventSmall: { padding: '0.5rem 1rem', backgroundColor: 'transparent', border: '1px solid', borderRadius: '20px', fontSize: '0.8rem', cursor: 'pointer' },

      // Weekly
      weeklyContainer: { width: '100%', maxWidth: '650px', display: 'flex', flexDirection: 'column', gap: '1.5rem', padding: '1rem' },
      weeklyHeader: { textAlign: 'center', marginBottom: '0.5rem' },
      weeklyTitle: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", color: 'var(--text)', marginBottom: '0.375rem' },
      weeklySubtitle: { fontSize: '0.9rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      weeklyGrid: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      weeklyDaysHeader: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', maxWidth: '350px', margin: '0 auto' },
      weeklyDayLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', textAlign: 'center', fontWeight: 500 },
      weeklyHabitsList: { display: 'flex', flexDirection: 'column', gap: '0.75rem' },
      weeklyHabitRow: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '1.5rem', padding: '1rem 1.25rem', backgroundColor: 'var(--bg-card)', borderRadius: '12px', border: '1px solid var(--border)' },
      weeklyHabitInfo: { display: 'flex', alignItems: 'center', gap: '0.625rem', flex: '1' },
      weeklyHabitDot: { width: '10px', height: '10px', borderRadius: '50%', flexShrink: 0 },
      weeklyHabitText: { fontSize: '0.95rem', color: 'var(--text)', fontWeight: 500 },
      weeklyHabitFreq: { fontSize: '0.75rem', color: 'var(--text-muted)', backgroundColor: 'var(--bg-elevated)', padding: '0.25rem 0.625rem', borderRadius: '12px', marginLeft: '0.5rem' },
      weeklyHabitDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1.125rem', opacity: 0.5, marginLeft: '0.5rem' },
      weeklyHabitDays: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', width: '280px', flexShrink: 0 },
      weeklyDayCircle: { width: '32px', height: '32px', borderRadius: '50%', border: '2px solid', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto' },
      weeklyEmpty: { textAlign: 'center', padding: '3rem 2rem', backgroundColor: 'var(--bg-card)', borderRadius: '16px', border: '1px dashed var(--border)' },
      weeklyEmptyText: { fontSize: '1rem', color: 'var(--text-muted)', fontStyle: 'italic', marginBottom: '0.25rem' },
      addHabitSection: { display: 'flex', gap: '0.625rem', alignItems: 'center', justifyContent: 'center', flexWrap: 'wrap' },
      addHabitInput: { flex: '1', minWidth: '200px', maxWidth: '280px', padding: '0.75rem 1rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.9rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif" },
      addHabitSelect: { padding: '0.75rem 1rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.85rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif" },
      addHabitButton: { padding: '0.75rem 1.5rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '10px', color: 'white', fontSize: '0.85rem', cursor: 'pointer', fontWeight: 500 },
      lockedText: { textAlign: 'center', color: 'var(--text-muted)', fontSize: '0.9rem', fontStyle: 'italic', padding: '1rem' },

      // Daily
      dailyContainer: { width: '100%', maxWidth: '550px', display: 'flex', flexDirection: 'column', gap: '1.5rem', padding: '1rem' },
      dailyHeader: { textAlign: 'center', marginBottom: '0.5rem' },
      dailyTitle: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", color: 'var(--text)', marginBottom: '0.375rem' },
      dailySubtitle: { fontSize: '0.9rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      dailyList: { display: 'flex', flexDirection: 'column', gap: '0.75rem' },
      dailyHabitCard: { display: 'flex', alignItems: 'center', backgroundColor: 'var(--bg-card)', borderRadius: '14px', border: '1px solid var(--border)', overflow: 'hidden' },
      dailyHabitAccent: { width: '5px', height: '100%', minHeight: '70px', flexShrink: 0 },
      dailyHabitContent: { flex: 1, padding: '1rem 1.25rem', display: 'flex', flexDirection: 'column', gap: '0.2rem' },
      dailyHabitText: { fontSize: '1rem', color: 'var(--text)', fontWeight: 500 },
      dailyHabitLabel: { fontSize: '0.75rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      dailyHabitDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1.25rem', padding: '1rem', opacity: 0.5 },
      dailyEmpty: { textAlign: 'center', padding: '3rem 2rem', backgroundColor: 'var(--bg-card)', borderRadius: '16px', border: '1px dashed var(--border)' },
      dailyEmptyText: { fontSize: '1rem', color: 'var(--text-muted)', marginBottom: '0.75rem' },
      dailyEmptyExamples: { fontSize: '0.85rem', color: 'var(--text-muted)' },
      addDailySection: { display: 'flex', flexDirection: 'column', gap: '0.625rem', alignItems: 'center' },
      addDailyInput: { width: '100%', maxWidth: '400px', padding: '0.875rem 1.125rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '12px', fontSize: '0.95rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", textAlign: 'center' },
      addDailyButton: { padding: '0.75rem 1.5rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '12px', color: 'white', fontSize: '0.9rem', cursor: 'pointer', fontWeight: 500 },

      // Bottom section - VLQ Summary
      bottomSection: { display: 'flex', justifyContent: 'center', gap: '2rem', width: '100%', maxWidth: '600px', padding: '1rem 1.5rem', backgroundColor: 'var(--bg-card)', borderRadius: '14px', border: '1px solid var(--border)', marginTop: 'auto' },
      vlqSummary: { display: 'flex', gap: '2.5rem', justifyContent: 'center', width: '100%' },
      vlqSummaryColumn: { display: 'flex', flexDirection: 'column', gap: '0.5rem', alignItems: 'center' },
      vlqSummaryLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', fontWeight: 500 },
      vlqSummaryItems: { display: 'flex', flexWrap: 'wrap', gap: '0.375rem', justifyContent: 'center' },
      vlqSummaryTag: { display: 'inline-flex', alignItems: 'center', gap: '0.25rem', padding: '0.3rem 0.6rem', backgroundColor: 'transparent', border: '1px solid', borderRadius: '12px', fontSize: '0.7rem' },
      sectionLabel: { fontSize: '0.65rem', textTransform: 'uppercase', letterSpacing: '0.1em', color: 'var(--text-muted)', marginBottom: '0.5rem', fontFamily: "'DM Sans', sans-serif", fontWeight: 600 },
      slider: { width: '100%', height: '3px', cursor: 'pointer' },

      // Chat
      chatPanel: { backgroundColor: 'var(--bg-card)', borderLeft: '1px solid var(--border)', display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden', position: 'relative' },
      resizeHandle: { position: 'absolute', left: 0, top: 0, bottom: 0, width: '6px', cursor: 'ew-resize', backgroundColor: 'transparent', zIndex: 10, transition: 'background-color 0.2s' },
      chatMessages: { flex: 1, padding: '1.25rem', overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '0.875rem', minHeight: 0 },
      chatInputArea: { padding: '1rem 1.25rem 1.25rem', borderTop: '1px solid var(--border)' },
      skipButton: { width: '100%', padding: '0.5rem', marginBottom: '0.75rem', backgroundColor: 'transparent', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text-muted)', fontSize: '0.8rem', cursor: 'pointer' },
      inputRow: { display: 'flex', gap: '0.625rem', alignItems: 'flex-end' },
      chatInput: { flex: 1, padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '12px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif", resize: 'none' },
      sendButton: { width: '40px', height: '40px', borderRadius: '50%', backgroundColor: 'var(--accent)', border: 'none', color: 'white', fontSize: '1rem', cursor: 'pointer', flexShrink: 0 },
      sendButtonDisabled: { backgroundColor: 'var(--border)', cursor: 'not-allowed' },
      chatMessage: { display: 'flex', gap: '0.625rem', alignItems: 'flex-start' },
      chatAvatar: { width: '28px', height: '28px', borderRadius: '50%', backgroundColor: 'var(--accent-light)', border: '1px solid var(--accent)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 },
      chatAvatarText: { fontFamily: "'Fraunces', serif", fontSize: '0.75rem', color: 'var(--accent)' },
      chatBubble: { padding: '0.75rem 1rem', borderRadius: '14px', maxWidth: '88%', fontSize: '0.875rem', lineHeight: 1.55 },
      chatBubbleAssistant: { backgroundColor: 'var(--bg-elevated)', borderTopLeftRadius: '4px', color: 'var(--text)' },
      chatBubbleUser: { backgroundColor: 'var(--accent)', borderTopRightRadius: '4px', color: 'white' },
      typingBubble: { padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '14px', borderTopLeftRadius: '4px', display: 'flex', gap: '4px' },
      typingDot: { color: 'var(--accent)', fontSize: '1.125rem', lineHeight: 1, animation: 'pulse 1s infinite' },

      modalOverlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 },
      modal: { backgroundColor: 'var(--bg-card)', borderRadius: '16px', padding: '1.5rem', width: '90%', maxWidth: '360px', border: '1px solid var(--border)' },
      modalHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.25rem' },
      modalTitle: { fontSize: '1.125rem', fontFamily: "'Fraunces', serif", color: 'var(--text)' },
      modalClose: { width: '28px', height: '28px', borderRadius: '50%', backgroundColor: 'var(--bg-elevated)', border: 'none', color: 'var(--text-muted)', fontSize: '1rem', cursor: 'pointer' },
      modalForm: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      formField: { display: 'flex', flexDirection: 'column', gap: '0.375rem' },
      formLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', fontWeight: 500 },
      textInput: { padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif" },
      selectInput: { padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif" },
      submitButton: { padding: '0.75rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '10px', color: 'white', fontSize: '0.875rem', fontWeight: 500, cursor: 'pointer', marginTop: '0.5rem' },
      submitButtonDisabled: { backgroundColor: 'var(--border-dark)', cursor: 'not-allowed' },
      settingsHint: { fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem', lineHeight: 1.5 },
      settingsLink: { color: 'var(--accent)', textDecoration: 'none' },
      settingsStatus: { fontSize: '0.8rem', color: 'var(--accent)', textAlign: 'center', marginTop: '0.5rem' },
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TendApp />);
  </script>
</body>
</html>
