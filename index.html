<!DOCTYPE html>
<html lang="en">
<!-- v2.2 - Daily Tends rename, Life Areas sidebar with editable values -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tend â€” Intentional Living</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;1,9..144,300;1,9..144,400&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBh7pjHsvlk_c3Ya22U-fWCkSoL89lvnKE",
      authDomain: "tend-17.firebaseapp.com",
      projectId: "tend-17",
      storageBucket: "tend-17.firebasestorage.app",
      messagingSenderId: "795612428176",
      appId: "1:795612428176:web:bff64a86add4ed2aee2515",
      measurementId: "G-2XFLRSET2Y"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-main: #FAF8F5;
      --bg-card: #FFFFFF;
      --bg-elevated: #F0EBE4;
      --text: #2D2A26;
      --text-light: #6B6660;
      --text-muted: #9A9590;
      --border: #E8E2D9;
      --border-dark: #D4CCC0;
      --accent: #7D9B76;
      --accent-light: #E8F0E6;
      
      --winter: #7EB3E0;
      --winter-light: #F5F9FC;
      --spring: #8FD4A0;
      --spring-light: #F5FBF6;
      --summer: #F9D07A;
      --summer-light: #FFFDF7;
      --fall: #E8A090;
      --fall-light: #FDF7F5;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background-color: var(--bg-main);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    h1, h2, h3, h4 { font-family: 'Fraunces', serif; font-weight: 400; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-dark); border-radius: 3px; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.7; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .slide-in { animation: slideIn 0.4s ease-out forwards; }

    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent) !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============ CONSTANTS ============
    const VLQ_DOMAINS = {
      family: { 
        name: 'Family', 
        description: 'Parents, siblings, children, extended family â€” feeling connected to and supported by your family.',
        icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§',
        color: '#E8A090'
      },
      partner: { 
        name: 'Partner & Romance', 
        description: 'Romantic relationship, intimacy, partnership â€” feeling loved and loving fully.',
        icon: 'ðŸ’•',
        color: '#E88B9C'
      },
      friendships: { 
        name: 'Friendships', 
        description: 'Close friends, social connections â€” feeling known, supported, and part of a community.',
        icon: 'ðŸ‘¯',
        color: '#F9D07A'
      },
      career: { 
        name: 'Work & Career', 
        description: 'Professional growth, meaningful work, financial stability â€” feeling purposeful in your work.',
        icon: 'ðŸ’¼',
        color: '#7EB3E0'
      },
      education: { 
        name: 'Learning & Growth', 
        description: 'Knowledge, skills, intellectual curiosity â€” feeling like you\'re growing and developing.',
        icon: 'ðŸ“š',
        color: '#B8A9C9'
      },
      recreation: { 
        name: 'Recreation & Fun', 
        description: 'Hobbies, play, leisure, relaxation â€” feeling joy and lightness in life.',
        icon: 'ðŸŽ¨',
        color: '#8FD4A0'
      },
      spirituality: { 
        name: 'Spirituality & Meaning', 
        description: 'Purpose, faith, inner life, connection to something larger â€” feeling grounded in meaning.',
        icon: 'âœ¨',
        color: '#C4B5D4'
      },
      community: { 
        name: 'Community & Citizenship', 
        description: 'Giving back, volunteering, social responsibility â€” feeling like you contribute to the world.',
        icon: 'ðŸŒ',
        color: '#8BC4A0'
      },
      health: { 
        name: 'Physical Health', 
        description: 'Body, movement, sleep, nutrition â€” feeling strong, energized, and well.',
        icon: 'ðŸ’ª',
        color: '#6BBF59'
      },
      mentalHealth: { 
        name: 'Mental Health', 
        description: 'Emotional wellbeing, self-care, inner peace â€” feeling balanced and at ease with yourself.',
        icon: 'ðŸ§ ',
        color: '#7EB3E0'
      },
    };

    const VLQ_ORDER = ['family', 'partner', 'friendships', 'career', 'education', 'recreation', 'spirituality', 'community', 'health', 'mentalHealth'];

    const LIFE_AREAS = {
      health: { name: 'Health & Wellness', icon: 'â—', color: '#6BBF59' },
      relationships: { name: 'Relationships', icon: 'â™¡', color: '#E88B9C' },
      career: { name: 'Career & Work', icon: 'â—†', color: '#5B9BD5' },
      finances: { name: 'Finances', icon: 'â—‹', color: '#F4B942' },
      growth: { name: 'Personal Growth', icon: 'âœ¦', color: '#9B8AAE' },
      fun: { name: 'Fun & Adventure', icon: 'âœº', color: '#D66B4B' },
    };

    // ============ TENDY SYSTEM ============
    // Garden elements mapped to VLQ domains
    const GARDEN_ELEMENTS = {
      family: { element: 'Oak Tree', icon: 'ðŸŒ³', description: 'Deep-rooted trees' },
      partner: { element: 'Rose', icon: 'ðŸŒ¹', description: 'Intertwined blooms' },
      friendships: { element: 'Wildflowers', icon: 'ðŸŒ¸', description: 'Clustering flowers' },
      career: { element: 'Hedge', icon: 'ðŸŒ¿', description: 'Structured greens' },
      education: { element: 'Sapling', icon: 'ðŸŒ±', description: 'Growing trees' },
      recreation: { element: 'Butterfly', icon: 'ðŸ¦‹', description: 'Whimsy elements' },
      spirituality: { element: 'Stone', icon: 'ðŸª¨', description: 'Grounding features' },
      community: { element: 'Bench', icon: 'ðŸª‘', description: 'Shared spaces' },
      health: { element: 'Vegetable', icon: 'ðŸ¥¬', description: 'Nourishing plants' },
      mentalHealth: { element: 'Water Lily', icon: 'ðŸª·', description: 'Peaceful waters' },
    };

    // Tendy templates by domain and difficulty (1=easy, 2=medium, 3=hard)
    const TENDY_TEMPLATES = {
      family: [
        { text: 'Send a quick "thinking of you" text to a family member', difficulty: 1, duration: '2 min' },
        { text: 'Call a family member you haven\'t spoken to recently', difficulty: 2, duration: '15 min' },
        { text: 'Plan a family activity for the upcoming weekend', difficulty: 3, duration: '30 min' },
        { text: 'Share a favorite memory with a family member', difficulty: 1, duration: '5 min' },
        { text: 'Look through old family photos and share one', difficulty: 2, duration: '10 min' },
      ],
      partner: [
        { text: 'Leave a sweet note for your partner', difficulty: 1, duration: '2 min' },
        { text: 'Plan a surprise for your partner', difficulty: 2, duration: '15 min' },
        { text: 'Have a device-free conversation about dreams and goals', difficulty: 3, duration: '30 min' },
        { text: 'Send your partner a message about what you appreciate', difficulty: 1, duration: '3 min' },
        { text: 'Cook or order your partner\'s favorite meal', difficulty: 2, duration: '20 min' },
      ],
      friendships: [
        { text: 'React to a friend\'s social media post with a genuine comment', difficulty: 1, duration: '2 min' },
        { text: 'Reach out to a friend you haven\'t talked to in a while', difficulty: 2, duration: '10 min' },
        { text: 'Plan a get-together with friends', difficulty: 3, duration: '20 min' },
        { text: 'Send a voice memo to a friend', difficulty: 1, duration: '3 min' },
        { text: 'Share something that made you think of a specific friend', difficulty: 2, duration: '5 min' },
      ],
      career: [
        { text: 'Organize your workspace for 5 minutes', difficulty: 1, duration: '5 min' },
        { text: 'Reach out to a colleague to offer help or collaboration', difficulty: 2, duration: '10 min' },
        { text: 'Work on a skill that would advance your career', difficulty: 3, duration: '30 min' },
        { text: 'Review and update one section of your resume or portfolio', difficulty: 2, duration: '15 min' },
        { text: 'Write down 3 wins from your recent work', difficulty: 1, duration: '5 min' },
      ],
      education: [
        { text: 'Read an article about something you want to learn', difficulty: 1, duration: '10 min' },
        { text: 'Watch an educational video or tutorial', difficulty: 2, duration: '20 min' },
        { text: 'Start or continue a course or book chapter', difficulty: 3, duration: '45 min' },
        { text: 'Write down 3 things you learned today', difficulty: 1, duration: '5 min' },
        { text: 'Teach someone something you know well', difficulty: 2, duration: '15 min' },
      ],
      recreation: [
        { text: 'Do something playful for 5 minutes', difficulty: 1, duration: '5 min' },
        { text: 'Spend time on a hobby you\'ve been neglecting', difficulty: 2, duration: '20 min' },
        { text: 'Try something creative or artistic', difficulty: 3, duration: '30 min' },
        { text: 'Listen to music that brings you joy', difficulty: 1, duration: '10 min' },
        { text: 'Play a game (video game, card game, puzzle)', difficulty: 2, duration: '20 min' },
      ],
      spirituality: [
        { text: 'Take 5 deep breaths and notice how you feel', difficulty: 1, duration: '2 min' },
        { text: 'Spend 10 minutes in quiet reflection or meditation', difficulty: 2, duration: '10 min' },
        { text: 'Journal about what gives your life meaning', difficulty: 3, duration: '20 min' },
        { text: 'Practice gratitude by naming 3 things you\'re thankful for', difficulty: 1, duration: '3 min' },
        { text: 'Spend time in nature, noticing the world around you', difficulty: 2, duration: '15 min' },
      ],
      community: [
        { text: 'Do one small act of kindness for a stranger', difficulty: 1, duration: '5 min' },
        { text: 'Research a local cause or organization to support', difficulty: 2, duration: '15 min' },
        { text: 'Volunteer your time or skills for a cause you care about', difficulty: 3, duration: '60 min' },
        { text: 'Share or amplify an important cause on social media', difficulty: 1, duration: '3 min' },
        { text: 'Donate to or support a local business', difficulty: 2, duration: '10 min' },
      ],
      health: [
        { text: 'Drink a full glass of water right now', difficulty: 1, duration: '1 min' },
        { text: 'Go for a 15-minute walk', difficulty: 2, duration: '15 min' },
        { text: 'Do a full workout or fitness class', difficulty: 3, duration: '45 min' },
        { text: 'Stretch for 5 minutes', difficulty: 1, duration: '5 min' },
        { text: 'Prepare a healthy meal or snack', difficulty: 2, duration: '20 min' },
      ],
      mentalHealth: [
        { text: 'Step away from screens for 10 minutes', difficulty: 1, duration: '10 min' },
        { text: 'Journal about how you\'re really feeling', difficulty: 2, duration: '15 min' },
        { text: 'Do something that\'s purely self-care', difficulty: 3, duration: '30 min' },
        { text: 'Name your current emotion without judgment', difficulty: 1, duration: '2 min' },
        { text: 'Set a boundary or say no to something draining', difficulty: 2, duration: '5 min' },
      ],
    };

    // Probability calculation for domain selection
    function calculateDomainProbabilities(vlqScores) {
      const epsilon = 0.01; // Reduced from 0.05 - minimum probability floor
      const minImportance = 3; // Never select domains below this importance
      const weights = {};
      let totalWeight = 0;

      VLQ_ORDER.forEach(domain => {
        const scores = vlqScores[domain];
        const importance = scores?.importance || 5;
        
        // Skip domains below minimum importance threshold
        if (importance < minImportance) {
          weights[domain] = 0;
          return;
        }
        
        const consistency = scores?.consistency || 5;
        const gap = Math.max(0, importance - consistency);
        
        // Formula: importance * (1 + gap_factor) + epsilon
        // Higher importance AND higher gap = higher weight
        const gapFactor = gap / 10; // Normalize gap to 0-1 range
        const weight = importance * (1 + gapFactor * 0.5) + epsilon;
        
        weights[domain] = weight;
        totalWeight += weight;
      });

      // Normalize to probabilities
      const probabilities = {};
      VLQ_ORDER.forEach(domain => {
        probabilities[domain] = totalWeight > 0 ? weights[domain] / totalWeight : 0;
      });

      return probabilities;
    }

    // Select a domain based on weighted probabilities
    function selectWeightedDomain(probabilities, exclude = [], penaltyWeights = {}) {
      // Filter out excluded domains AND domains below importance threshold (probability = 0)
      const availableDomains = VLQ_ORDER.filter(d => 
        !exclude.includes(d) && probabilities[d] > 0
      );
      
      if (availableDomains.length === 0) {
        // Fallback: pick any domain with non-zero probability
        const nonZeroDomains = VLQ_ORDER.filter(d => probabilities[d] > 0);
        if (nonZeroDomains.length === 0) return VLQ_ORDER[0]; // Ultimate fallback
        return nonZeroDomains[Math.floor(Math.random() * nonZeroDomains.length)];
      }

      // Apply soft recency penalties to probabilities
      const adjustedProbs = {};
      availableDomains.forEach(d => {
        const penalty = penaltyWeights[d] || 1.0;
        adjustedProbs[d] = probabilities[d] * penalty;
      });

      // Recalculate probabilities for available domains
      let totalProb = 0;
      availableDomains.forEach(d => totalProb += adjustedProbs[d]);
      
      const rand = Math.random() * totalProb;
      let cumulative = 0;
      
      for (const domain of availableDomains) {
        cumulative += adjustedProbs[domain];
        if (rand <= cumulative) return domain;
      }
      
      return availableDomains[availableDomains.length - 1];
    }

    // Generate today's tendies (3 options with different difficulties)
    function generateDailyTendies(vlqScores, tendyHistory = []) {
      const probabilities = calculateDomainProbabilities(vlqScores);
      const today = new Date().toISOString().split('T')[0];
      
      // GUARDRAIL 1: No same domain two days in a row
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = yesterday.toISOString().split('T')[0];
      const yesterdayDomains = tendyHistory
        .filter(t => t.date === yesterdayStr)
        .map(t => t.domain);
      
      // GUARDRAIL 2: Soft recency penalty for recently-selected domains (last 7 days)
      const recentDomainCounts = {};
      VLQ_ORDER.forEach(d => recentDomainCounts[d] = 0);
      
      tendyHistory
        .filter(t => {
          const daysDiff = (new Date(today) - new Date(t.date)) / (1000 * 60 * 60 * 24);
          return daysDiff > 0 && daysDiff <= 7;
        })
        .forEach(t => {
          if (t.domain) recentDomainCounts[t.domain]++;
        });
      
      // Apply soft penalty: reduce probability by 20% per recent appearance
      const penaltyWeights = {};
      VLQ_ORDER.forEach(d => {
        penaltyWeights[d] = Math.pow(0.8, recentDomainCounts[d]);
      });
      
      // GUARDRAIL 3: Template cooldown (30 days instead of 7)
      const recentTemplates = tendyHistory
        .filter(t => {
          const daysDiff = (new Date(today) - new Date(t.date)) / (1000 * 60 * 60 * 24);
          return daysDiff < 30;
        })
        .map(t => t.templateText || t.text);

      // NEW: Select ONE domain for the entire day (all 3 difficulties)
      const todaysDomain = selectWeightedDomain(probabilities, yesterdayDomains, penaltyWeights);

      const tendies = [];
      const difficulties = [1, 2, 3]; // Easy, Medium, Hard

      difficulties.forEach(difficulty => {
        // Get templates for this difficulty (not used in last 30 days)
        const templates = TENDY_TEMPLATES[todaysDomain].filter(t => 
          t.difficulty === difficulty && !recentTemplates.includes(t.text)
        );

        // Fallback to any template of this difficulty if no unused ones
        const fallbackTemplates = TENDY_TEMPLATES[todaysDomain].filter(t => t.difficulty === difficulty);
        const availableTemplates = templates.length > 0 ? templates : fallbackTemplates;

        if (availableTemplates.length > 0) {
          const template = availableTemplates[Math.floor(Math.random() * availableTemplates.length)];
          tendies.push({
            id: `${today}-${difficulty}`,
            domain: todaysDomain,
            text: template.text,
            difficulty,
            duration: template.duration,
            points: difficulty, // 1, 2, or 3 points
            gardenElement: GARDEN_ELEMENTS[todaysDomain],
            color: VLQ_DOMAINS[todaysDomain].color,
            domainName: VLQ_DOMAINS[todaysDomain].name,
            domainIcon: VLQ_DOMAINS[todaysDomain].icon,
            date: today,
            completed: false,
            selected: false,
            templateText: template.text, // Store for cooldown tracking
          });
        }
      });

      return tendies;
    }

    const VALUE_KEYWORDS = {
      'Freedom': ['freedom', 'free', 'autonomy', 'independent', 'flexible'],
      'Connection': ['connection', 'connected', 'together', 'relationship', 'partner', 'love', 'present', 'presence'],
      'Growth': ['growth', 'grow', 'learn', 'improve', 'better', 'develop'],
      'Peace': ['peace', 'calm', 'peaceful', 'stress', 'less stressed', 'relaxed', 'balance'],
      'Health': ['health', 'healthy', 'fit', 'strong', 'energy', 'wellness'],
      'Adventure': ['adventure', 'travel', 'explore', 'new', 'exciting', 'experience'],
      'Creativity': ['creative', 'creativity', 'create', 'art', 'make', 'build'],
      'Family': ['family', 'kids', 'children', 'parents', 'home'],
      'Joy': ['joy', 'happy', 'happiness', 'fun', 'laugh', 'enjoy'],
      'Security': ['security', 'secure', 'stable', 'stability', 'safe'],
    };

    const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const MONTH_FULL = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    const PHASES = { EXPLORE: 'explore', GROUND: 'ground', REVEAL: 'reveal', PLAN: 'plan' };
    const CENTER_VIEWS = { YEAR: 'year', SEASONS: 'seasons', MONTHLY: 'monthly', WEEKLY: 'weekly', DAILY: 'daily' };

    // ============ MAIN APP ============
    // ============ VLQ ASSESSMENT ============
    function VLQAssessment({ vlqScores, setVlqScores, vlqStep, setVlqStep, onComplete }) {
      
      // Calculate gaps for summary
      const getGaps = () => {
        return VLQ_ORDER.map(key => ({
          key,
          name: VLQ_DOMAINS[key].name,
          icon: VLQ_DOMAINS[key].icon,
          color: VLQ_DOMAINS[key].color,
          importance: vlqScores[key]?.importance || 5,
          consistency: vlqScores[key]?.consistency || 5,
          gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)
        })).sort((a, b) => b.gap - a.gap);
      };

      const vlqStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        card: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '24px',
          padding: '2.5rem',
          maxWidth: '700px',
          width: '100%',
          boxShadow: '0 4px 24px rgba(0,0,0,0.06)',
          border: '1px solid var(--border)',
        },
        header: {
          textAlign: 'center',
          marginBottom: '2rem',
        },
        stepIndicator: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
          textTransform: 'uppercase',
          letterSpacing: '0.1em',
          marginBottom: '0.5rem',
        },
        title: {
          fontSize: '1.5rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          fontSize: '0.9rem',
          color: 'var(--text-muted)',
          lineHeight: 1.5,
        },
        valuesGrid: {
          display: 'flex',
          flexDirection: 'column',
          gap: '0.75rem',
          marginBottom: '2rem',
        },
        valueRow: {
          display: 'grid',
          gridTemplateColumns: '140px 1fr 40px',
          alignItems: 'center',
          gap: '1rem',
          padding: '0.75rem 1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
        },
        valueInfo: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        valueIcon: {
          fontSize: '1.1rem',
        },
        valueName: {
          fontSize: '0.85rem',
          color: 'var(--text)',
          fontWeight: 500,
        },
        slider: {
          width: '100%',
          height: '6px',
          borderRadius: '3px',
          appearance: 'none',
          background: 'var(--border)',
          outline: 'none',
          cursor: 'pointer',
        },
        valueScore: {
          fontSize: '1.1rem',
          fontWeight: 600,
          textAlign: 'center',
          fontFamily: "'Fraunces', serif",
        },
        buttons: {
          display: 'flex',
          gap: '1rem',
          justifyContent: 'center',
        },
        backButton: {
          padding: '0.875rem 2rem',
          backgroundColor: 'transparent',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          color: 'var(--text-muted)',
          fontSize: '0.95rem',
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
        nextButton: {
          padding: '0.875rem 2.5rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '0.95rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
        hint: {
          textAlign: 'center',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
          marginBottom: '1.5rem',
          fontStyle: 'italic',
        },
        // Summary styles
        summarySection: {
          marginBottom: '1.5rem',
        },
        summarySectionTitle: {
          fontSize: '0.75rem',
          fontWeight: 600,
          textTransform: 'uppercase',
          letterSpacing: '0.1em',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
        },
        summaryItem: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.75rem',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '10px',
          marginBottom: '0.5rem',
        },
        summaryItemIcon: {
          fontSize: '1.25rem',
        },
        summaryItemName: {
          flex: 1,
          fontSize: '0.9rem',
          color: 'var(--text)',
        },
        summaryItemScores: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          fontSize: '0.85rem',
        },
        summaryItemGap: {
          fontSize: '0.75rem',
          padding: '0.2rem 0.5rem',
          borderRadius: '8px',
          fontWeight: 500,
        },
        intro: {
          textAlign: 'center',
        },
        introTitle: {
          fontSize: '2rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '1rem',
        },
        introText: {
          fontSize: '1rem',
          color: 'var(--text-muted)',
          lineHeight: 1.7,
          marginBottom: '2rem',
        },
        startButton: {
          padding: '1rem 3rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
      };

      const handleImportanceChange = (key, value) => {
        setVlqScores(prev => ({
          ...prev,
          [key]: { ...prev[key], importance: value }
        }));
      };

      const handleConsistencyChange = (key, value) => {
        setVlqScores(prev => ({
          ...prev,
          [key]: { ...prev[key], consistency: value }
        }));
      };

      // Intro screen
      if (vlqStep === -1) {
        return (
          <div style={vlqStyles.container}>
            <div style={{...vlqStyles.card, ...vlqStyles.intro, maxWidth: '500px'}}>
              <svg width="80" height="80" viewBox="0 0 80 80" fill="none" style={{marginBottom: '1.5rem', opacity: 0.8}}>
                <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="1.5" strokeLinecap="round"/>
                <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <circle cx="40" cy="70" r="3" fill="none" stroke="var(--accent)" strokeWidth="1.5"/>
              </svg>
              <h1 style={vlqStyles.introTitle}>Welcome to Tend</h1>
              <p style={{...vlqStyles.introText, marginBottom: '1.5rem'}}>
                Tend helps you design a life aligned with your values â€” not just survive, but live intentionally and mindfully.
              </p>
              <p style={vlqStyles.introText}>
                To get started, you'll reflect on <strong>10 areas of life</strong>. For each one, you'll rate:
                <br /><br />
                <em>How important is this to you?</em>
                <br />
                <em>How consistently have you been living it?</em>
                <br /><br />
                Think deeply, but don't worry about perfection â€” you can reassess your values anytime.
              </p>
              <button style={vlqStyles.startButton} onClick={() => setVlqStep(0)}>
                Let's Begin
              </button>
            </div>
          </div>
        );
      }

      // Step 0: Importance ratings for all values
      if (vlqStep === 0) {
        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <div style={vlqStyles.stepIndicator}>Step 1 of 2</div>
                <h2 style={vlqStyles.title}>How important is each area to you?</h2>
                <p style={vlqStyles.subtitle}>
                  Rate each value from 1 (not important) to 10 (extremely important).
                </p>
              </div>
              
              <p style={vlqStyles.hint}>
                Not everything can be a 10 â€” what truly matters most?
              </p>

              <div style={vlqStyles.valuesGrid}>
                {VLQ_ORDER.map(key => {
                  const domain = VLQ_DOMAINS[key];
                  const score = vlqScores[key]?.importance || 5;
                  return (
                    <div key={key} style={vlqStyles.valueRow}>
                      <div style={vlqStyles.valueInfo}>
                        <span style={vlqStyles.valueIcon}>{domain.icon}</span>
                        <span style={vlqStyles.valueName}>{domain.name}</span>
                      </div>
                      <input
                        type="range"
                        min="1"
                        max="10"
                        value={score}
                        onChange={(e) => handleImportanceChange(key, parseInt(e.target.value))}
                        style={{...vlqStyles.slider, accentColor: domain.color}}
                      />
                      <span style={{...vlqStyles.valueScore, color: domain.color}}>
                        {score}
                      </span>
                    </div>
                  );
                })}
              </div>

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(-1)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={() => setVlqStep(1)}>
                  Next
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Step 1: Consistency ratings for all values
      if (vlqStep === 1) {
        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <div style={vlqStyles.stepIndicator}>Step 2 of 2</div>
                <h2 style={vlqStyles.title}>How much have you been living each value?</h2>
                <p style={vlqStyles.subtitle}>
                  Rate your actual behavior â€” not what you wish, but what you've actually been doing.
                </p>
              </div>
              
              <p style={vlqStyles.hint}>
                1 = not at all lately Â· 10 = it's a major part of my life right now
              </p>

              <div style={vlqStyles.valuesGrid}>
                {VLQ_ORDER.map(key => {
                  const domain = VLQ_DOMAINS[key];
                  const score = vlqScores[key]?.consistency || 5;
                  const importance = vlqScores[key]?.importance || 5;
                  return (
                    <div key={key} style={vlqStyles.valueRow}>
                      <div style={vlqStyles.valueInfo}>
                        <span style={vlqStyles.valueIcon}>{domain.icon}</span>
                        <span style={vlqStyles.valueName}>{domain.name}</span>
                        <span style={{fontSize: '0.7rem', color: 'var(--text-muted)', marginLeft: '0.25rem'}}>
                          (imp: {importance})
                        </span>
                      </div>
                      <input
                        type="range"
                        min="1"
                        max="10"
                        value={score}
                        onChange={(e) => handleConsistencyChange(key, parseInt(e.target.value))}
                        style={{...vlqStyles.slider, accentColor: domain.color}}
                      />
                      <span style={{...vlqStyles.valueScore, color: domain.color}}>
                        {score}
                      </span>
                    </div>
                  );
                })}
              </div>

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(0)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={() => setVlqStep(2)}>
                  See Results
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Step 2: Summary screen
      if (vlqStep === 2) {
        const gaps = getGaps();
        const growthAreas = gaps.filter(g => g.gap >= 3);
        const strengths = gaps.filter(g => g.importance >= 7 && g.consistency >= 7);
        const lowerPriority = gaps.filter(g => g.importance <= 5);

        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <h2 style={vlqStyles.title}>Your Values Landscape</h2>
                <p style={vlqStyles.subtitle}>
                  Here's what you shared about what matters and where you are.
                </p>
              </div>

              {growthAreas.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>ðŸŒ± Growth Areas</h3>
                  <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem', fontStyle: 'italic'}}>
                    High importance, room to grow
                  </p>
                  {growthAreas.map(item => (
                    <div key={item.key} style={vlqStyles.summaryItem}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: 'var(--text-muted)'}}>{item.consistency}</span>
                        <span style={{color: 'var(--text-muted)'}}>â†’</span>
                        <span style={{color: item.color, fontWeight: 600}}>{item.importance}</span>
                      </div>
                      <span style={{
                        ...vlqStyles.summaryItemGap,
                        backgroundColor: `${item.color}20`,
                        color: item.color
                      }}>
                        +{item.gap}
                      </span>
                    </div>
                  ))}
                </div>
              )}

              {strengths.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>ðŸ’ª Strengths</h3>
                  <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem', fontStyle: 'italic'}}>
                    Important and you're living it
                  </p>
                  {strengths.map(item => (
                    <div key={item.key} style={vlqStyles.summaryItem}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: item.color, fontWeight: 600}}>{item.consistency}</span>
                        <span style={{color: 'var(--text-muted)'}}>/</span>
                        <span style={{color: item.color, fontWeight: 600}}>{item.importance}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {lowerPriority.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>âšª Lower Priority Right Now</h3>
                  {lowerPriority.slice(0, 3).map(item => (
                    <div key={item.key} style={{...vlqStyles.summaryItem, opacity: 0.7}}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <span style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>{item.importance}/10</span>
                    </div>
                  ))}
                </div>
              )}

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(1)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={onComplete}>
                  Continue to Planning â†’
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    // ============ AUTH MODAL ============
    function AuthModal({ onSuccess }) {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isLogin) {
            await auth.signInWithEmailAndPassword(email, password);
          } else {
            await auth.createUserWithEmailAndPassword(email, password);
          }
          onSuccess();
        } catch (err) {
          console.error('Auth error:', err);
          if (err.code === 'auth/email-already-in-use') {
            setError('This email is already registered. Try logging in.');
          } else if (err.code === 'auth/invalid-email') {
            setError('Please enter a valid email address.');
          } else if (err.code === 'auth/weak-password') {
            setError('Password should be at least 6 characters.');
          } else if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
            setError('Invalid email or password.');
          } else {
            setError(err.message);
          }
        } finally {
          setLoading(false);
        }
      };

      const authStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        card: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '24px',
          padding: '3rem',
          maxWidth: '400px',
          width: '100%',
          boxShadow: '0 4px 24px rgba(0,0,0,0.06)',
          border: '1px solid var(--border)',
          textAlign: 'center',
        },
        title: {
          fontSize: '1.75rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          fontSize: '0.9rem',
          color: 'var(--text-muted)',
          marginBottom: '2rem',
        },
        form: {
          display: 'flex',
          flexDirection: 'column',
          gap: '1rem',
        },
        input: {
          padding: '0.875rem 1rem',
          border: '1px solid var(--border)',
          borderRadius: '10px',
          fontSize: '0.95rem',
          fontFamily: "'DM Sans', sans-serif",
          backgroundColor: 'var(--bg-elevated)',
          color: 'var(--text)',
          outline: 'none',
        },
        button: {
          padding: '1rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
          marginTop: '0.5rem',
        },
        toggle: {
          marginTop: '1.5rem',
          fontSize: '0.85rem',
          color: 'var(--text-muted)',
        },
        toggleLink: {
          color: 'var(--accent)',
          cursor: 'pointer',
          fontWeight: 500,
        },
        error: {
          color: '#d32f2f',
          fontSize: '0.85rem',
          marginTop: '0.5rem',
          padding: '0.5rem',
          backgroundColor: '#ffebee',
          borderRadius: '8px',
        },
      };

      return (
        <div style={authStyles.container}>
          <div style={authStyles.card}>
            <svg width="60" height="60" viewBox="0 0 80 80" fill="none" style={{marginBottom: '1rem', opacity: 0.8}}>
              <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="1.5" strokeLinecap="round"/>
              <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <circle cx="40" cy="70" r="3" fill="none" stroke="var(--accent)" strokeWidth="1.5"/>
            </svg>
            <h1 style={authStyles.title}>{isLogin ? 'Welcome back' : 'Create account'}</h1>
            <p style={authStyles.subtitle}>
              {isLogin ? 'Sign in to continue your journey' : 'Start designing your intentional life'}
            </p>

            <form style={authStyles.form} onSubmit={handleSubmit}>
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                style={authStyles.input}
                required
              />
              <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                style={authStyles.input}
                required
              />
              {error && <div style={authStyles.error}>{error}</div>}
              <button type="submit" style={authStyles.button} disabled={loading}>
                {loading ? 'Please wait...' : (isLogin ? 'Sign In' : 'Create Account')}
              </button>
            </form>

            <p style={authStyles.toggle}>
              {isLogin ? "Don't have an account? " : "Already have an account? "}
              <span style={authStyles.toggleLink} onClick={() => { setIsLogin(!isLogin); setError(''); }}>
                {isLogin ? 'Sign up' : 'Sign in'}
              </span>
            </p>
          </div>
        </div>
      );
    }

    function TendApp() {
      // Auth state
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [dataLoaded, setDataLoaded] = useState(false);
      const [showLoadingIcon, setShowLoadingIcon] = useState(true);
      const [appMode, setAppMode] = useState(null); // null = choose, 'journal', 'plan'

      const [phase, setPhase] = useState(PHASES.EXPLORE);
      const [vlqScores, setVlqScores] = useState({
        family: { importance: null, consistency: null },
        partner: { importance: null, consistency: null },
        friendships: { importance: null, consistency: null },
        career: { importance: null, consistency: null },
        education: { importance: null, consistency: null },
        recreation: { importance: null, consistency: null },
        spirituality: { importance: null, consistency: null },
        community: { importance: null, consistency: null },
        health: { importance: null, consistency: null },
        mentalHealth: { importance: null, consistency: null },
      });
      const [vlqCompleted, setVlqCompleted] = useState(false);
      const [vlqStep, setVlqStep] = useState(-1); // -1 for intro, 0-9 for domains, 10 for summary
      const [values, setValues] = useState([]);
      const [lifeAreaRatings, setLifeAreaRatings] = useState({
        health: { satisfaction: null, intention: null },
        relationships: { satisfaction: null, intention: null },
        career: { satisfaction: null, intention: null },
        finances: { satisfaction: null, intention: null },
        growth: { satisfaction: null, intention: null },
        fun: { satisfaction: null, intention: null }
      });
      const [lifeAreasCompleted, setLifeAreasCompleted] = useState(false);
      const [lifeAreasMode, setLifeAreasMode] = useState(false);
      const [currentLifeAreaIndex, setCurrentLifeAreaIndex] = useState(0);
      const [waitingForSatisfaction, setWaitingForSatisfaction] = useState(true);
      const [isLastLifeAreaResponse, setIsLastLifeAreaResponse] = useState(false);
      const lifeAreaOrder = ['health', 'relationships', 'career', 'finances', 'growth', 'fun'];
      const lifeAreaDescriptions = {
        health: 'physical energy, movement, sleep, how your body feels',
        relationships: 'partner, family, friendships, feeling connected',
        career: 'work satisfaction, growth, meaning in what you do',
        finances: 'financial security, freedom, relationship with money',
        growth: 'learning, self-improvement, becoming who you want to be',
        fun: 'play, adventure, hobbies, things that bring you joy'
      };
      const [events, setEvents] = useState([]);
      const [goals, setGoals] = useState([]);
      const [notes, setNotes] = useState(''); // Planning notes in sidebar
      const [journalEntries, setJournalEntries] = useState({}); // Daily journal entries by date
      const [monthlyReviews, setMonthlyReviews] = useState({}); // Monthly reviews by month (YYYY-MM)
      const [yearlyReflections, setYearlyReflections] = useState({}); // Yearly reflections by year
      const [seasonIntentions, setSeasonIntentions] = useState({
        winter: '', spring: '', summer: '', fall: ''
      });
      const [yearTheme, setYearTheme] = useState('');
      const [weeklyHabits, setWeeklyHabits] = useState([]);
      const [dailyHabits, setDailyHabits] = useState([]);
      
      // Tendy system state
      const [todaysTendies, setTodaysTendies] = useState([]);
      const [tendyHistory, setTendyHistory] = useState([]); // Completed tendies
      const [tendyPoints, setTendyPoints] = useState(0);
      const [tendyStreak, setTendyStreak] = useState(0);
      const [flexPoints, setFlexPoints] = useState(3); // For rerolling tendies
      const [flexPointsTracking, setFlexPointsTracking] = useState({
        lastJournalDate: null,
        lastWeeklyIntentionWeek: null,
        lastCustomTendyWeek: null,
        lastMondayBonusWeek: null,
        last7DayStreakDate: null,
        lastMonthlyReviewMonth: null,
        completedGoalIds: []
      });
      const [weeklyCustomTendy, setWeeklyCustomTendy] = useState(null); // { text, status: 'pending'|'approved'|'rejected', weekOf, submittedAt }
      
      // Knowledge & Intelligence Layer
      const [savedConversations, setSavedConversations] = useState({}); // Archive of important conversations
      const [currentConversationType, setCurrentConversationType] = useState('general'); // 'general' | 'monthly_review' | 'yearly_review' | 'onboarding'
      const [userProfile, setUserProfile] = useState({
        name: '',
        occupation: '',
        location: '',
        lifeStage: ''
      });
      
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isTyping, setIsTyping] = useState(false);
      const [exchangeCount, setExchangeCount] = useState(0);
      const messagesEndRef = useRef(null);

      const [revealed, setRevealed] = useState(false);
      const [activeTab, setActiveTab] = useState('events');
      const [sidebarExpanded, setSidebarExpanded] = useState(false);
      const [sidebarWidth, setSidebarWidth] = useState(240);
      const [isResizingSidebar, setIsResizingSidebar] = useState(false);
      const [centerView, setCenterView] = useState(CENTER_VIEWS.YEAR);
      const [expandedEvent, setExpandedEvent] = useState(null);
      const [showEventModal, setShowEventModal] = useState(false);
      const [showGoalModal, setShowGoalModal] = useState(false);
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('tend_api_key') || '');
      const [chatWidth, setChatWidth] = useState(320);
      const [isResizing, setIsResizing] = useState(false);
      const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
      const [showAdminDashboard, setShowAdminDashboard] = useState(() => {
        const params = new URLSearchParams(window.location.search);
        return params.get('admin') === 'true';
      });

      // Auth state listener
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((firebaseUser) => {
          setUser(firebaseUser);
          setAuthLoading(false);
          if (firebaseUser) {
            // Load user data from Firestore
            loadUserData(firebaseUser.uid);
          }
        });
        return () => unsubscribe();
      }, []);

      // Show loading icon for at least 1.5 seconds
      useEffect(() => {
        const timer = setTimeout(() => {
          setShowLoadingIcon(false);
        }, 1500);
        return () => clearTimeout(timer);
      }, []);

      // Load user data from Firestore
      const loadUserData = async (userId) => {
        try {
          const doc = await db.collection('users').doc(userId).get();
          if (doc.exists) {
            const data = doc.data();
            if (data.vlqScores) setVlqScores(data.vlqScores);
            if (data.vlqCompleted) setVlqCompleted(data.vlqCompleted);
            if (data.yearTheme) setYearTheme(data.yearTheme);
            if (data.events) setEvents(data.events);
            if (data.goals) setGoals(data.goals);
            if (data.notes) setNotes(data.notes);
            if (data.journalEntries) setJournalEntries(data.journalEntries);
            if (data.monthlyReviews) setMonthlyReviews(data.monthlyReviews);
            if (data.yearlyReflections) setYearlyReflections(data.yearlyReflections);
            if (data.seasonIntentions) setSeasonIntentions(data.seasonIntentions);
            if (data.weeklyHabits) setWeeklyHabits(data.weeklyHabits);
            if (data.dailyHabits) setDailyHabits(data.dailyHabits);
            if (data.todaysTendies) setTodaysTendies(data.todaysTendies);
            if (data.tendyHistory) setTendyHistory(data.tendyHistory);
            if (data.tendyPoints) setTendyPoints(data.tendyPoints);
            if (data.tendyStreak) setTendyStreak(data.tendyStreak);
            if (data.flexPoints !== undefined) setFlexPoints(data.flexPoints);
            if (data.flexPointsTracking) setFlexPointsTracking(data.flexPointsTracking);
            if (data.weeklyCustomTendy) setWeeklyCustomTendy(data.weeklyCustomTendy);
            if (data.savedConversations) setSavedConversations(data.savedConversations);
            if (data.userProfile) setUserProfile(data.userProfile);
            // Trends are calculated, not loaded
            if (data.revealed) setRevealed(data.revealed);
            if (data.phase) setPhase(data.phase);
            // If VLQ was completed, skip to step 2 (after summary) and reveal content
            if (data.vlqCompleted) {
              setVlqStep(2);
              setRevealed(true);
            }
          }
          setDataLoaded(true);
        } catch (error) {
          console.error('Error loading user data:', error);
          setDataLoaded(true);
        }
      };

      // Extract insights from a conversation
      const extractInsights = (messages) => {
        const allText = messages.map(m => m.content).join(' ').toLowerCase();
        
        // Extract themes (simple keyword matching for now)
        const themeKeywords = {
          'work-life balance': /work.{0,20}life|balance|burnout|overwhelm/,
          'career': /career|job|work|profession|promotion/,
          'health': /health|fitness|exercise|wellness|sleep/,
          'relationships': /relationship|family|friend|partner|social/,
          'finances': /money|financial|budget|savings|income/,
          'personal growth': /learn|growth|development|skill|course/,
        };
        
        const themes = [];
        Object.entries(themeKeywords).forEach(([theme, regex]) => {
          if (regex.test(allText)) themes.push(theme);
        });
        
        // Simple mood detection
        const posit iveWords = /great|good|happy|excited|wonderful|amazing|love|proud/;
        const challengeWords = /difficult|hard|struggle|stress|worry|anxious|overwhelm/;
        const positiveCount = (allText.match(positiveWords) || []).length;
        const challengeCount = (allText.match(challengeWords) || []).length;
        
        let mood = 'neutral';
        if (positiveCount > challengeCount + 2) mood = 'positive';
        else if (challengeCount > positiveCount + 2) mood = 'challenging';
        
        return {
          themes,
          mood,
          extractedAt: new Date().toISOString()
        };
      };

      // Save current conversation if it's important
      const saveCurrentConversation = () => {
        if (messages.length === 0) return;
        
        // Only save certain types of conversations
        const typesToSave = ['monthly_review', 'yearly_review', 'onboarding'];
        if (!typesToSave.includes(currentConversationType)) {
          // For general conversations, just extract insights but don't save full conversation
          const insights = extractInsights(messages);
          console.log('Extracted insights from general conversation:', insights);
          return;
        }
        
        const conversationId = `${currentConversationType}_${Date.now()}`;
        const insights = extractInsights(messages);
        
        setSavedConversations(prev => ({
          ...prev,
          [conversationId]: {
            type: currentConversationType,
            messages: [...messages],
            startedAt: messages[0]?.timestamp || new Date().toISOString(),
            lastMessageAt: new Date().toISOString(),
            insights
          }
        }));
        
        console.log(`Saved ${currentConversationType} conversation:`, conversationId);
      };

      // Calculate user trends from existing data
      const calculateTrends = () => {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        
        // Daily Tends Analysis
        const dailyTendsStats = {};
        VLQ_ORDER.forEach(area => {
          const areaHistory = tendyHistory.filter(t => t.lifeArea === area);
          const completed = areaHistory.filter(t => t.completed).length;
          const total = areaHistory.length;
          dailyTendsStats[area] = {
            completed,
            skipped: total - completed,
            completionRate: total > 0 ? Math.round((completed / total) * 100) : 0
          };
        });
        
        // Calculate current streak
        let currentStreak = 0;
        const sortedHistory = [...tendyHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
        for (let i = 0; i < sortedHistory.length; i++) {
          if (sortedHistory[i].completed) {
            currentStreak++;
          } else {
            break;
          }
        }
        
        // Journaling stats
        const journalEntryDates = Object.keys(journalEntries);
        const thisMonthEntries = journalEntryDates.filter(date => date.startsWith(today.substring(0, 7))).length;
        const thisYearEntries = journalEntryDates.filter(date => date.startsWith(today.substring(0, 4))).length;
        
        // Calculate journal streak
        let journalStreak = 0;
        let checkDate = new Date(today);
        while (journalEntries[checkDate.toISOString().split('T')[0]]) {
          journalStreak++;
          checkDate.setDate(checkDate.getDate() - 1);
        }
        
        // Goals stats
        const completedGoals = goals.filter(g => g.completed).length;
        const totalGoals = goals.length;
        
        // Goals by life area
        const goalsByArea = {};
        VLQ_ORDER.forEach(area => {
          const areaGoals = goals.filter(g => g.lifeArea === area);
          if (areaGoals.length > 0) {
            goalsByArea[area] = {
              created: areaGoals.length,
              completed: areaGoals.filter(g => g.completed).length
            };
          }
        });
        
        return {
          dailyTends: {
            byLifeArea: dailyTendsStats,
            currentStreak,
            totalCompleted: tendyHistory.filter(t => t.completed).length
          },
          journaling: {
            entriesThisMonth: thisMonthEntries,
            entriesThisYear: thisYearEntries,
            currentStreak: journalStreak,
            totalEntries: journalEntryDates.length
          },
          goals: {
            totalCreated: totalGoals,
            completed: completedGoals,
            inProgress: totalGoals - completedGoals,
            completionRate: totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0,
            byLifeArea: goalsByArea
          },
          calculatedAt: now.toISOString()
        };
      };

      // Save user data to Firestore (debounced)
      const saveTimeoutRef = useRef(null);
      const saveUserData = useCallback(() => {
        if (!user) return;
        
        // Clear existing timeout
        if (saveTimeoutRef.current) {
          clearTimeout(saveTimeoutRef.current);
        }
        
        // Debounce: save after 1 second of no changes
        saveTimeoutRef.current = setTimeout(async () => {
          try {
            // Calculate trends before saving
            const trends = calculateTrends();
            
            await db.collection('users').doc(user.uid).set({
              vlqScores,
              vlqCompleted,
              yearTheme,
              events,
              goals,
              notes,
              journalEntries,
              monthlyReviews,
              yearlyReflections,
              seasonIntentions,
              weeklyHabits,
              dailyHabits,
              todaysTendies,
              tendyHistory,
              tendyPoints,
              tendyStreak,
              flexPoints,
              flexPointsTracking,
              weeklyCustomTendy,
              revealed,
              phase,
              // NEW: Knowledge & Intelligence
              savedConversations,
              userProfile,
              trends,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            }, { merge: true });
            console.log('Data saved (including trends & conversations)');
          } catch (error) {
            console.error('Error saving user data:', error);
          }
        }, 1000);
      }, [user, vlqScores, vlqCompleted, yearTheme, events, goals, notes, journalEntries, monthlyReviews, yearlyReflections, seasonIntentions, weeklyHabits, dailyHabits, todaysTendies, tendyHistory, tendyPoints, tendyStreak, flexPoints, flexPointsTracking, weeklyCustomTendy, revealed, phase, savedConversations, userProfile]);

      // Flex Points Awarding System
      useEffect(() => {
        if (!user || !dataLoaded) return;
        
        const today = new Date().toISOString().split('T')[0];
        const now = new Date();
        const currentWeek = `${now.getFullYear()}-W${Math.ceil(((now - new Date(now.getFullYear(), 0, 1)) / 86400000 + new Date(now.getFullYear(), 0, 1).getDay() + 1) / 7)}`;
        const currentMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        
        let pointsToAward = 0;
        let newTracking = {...flexPointsTracking};
        
        // 1. Monday bonus (1 point per week)
        // Only award if user has tracking history (not first-ever load)
        const isMonday = now.getDay() === 1;
        const hasTrackingHistory = newTracking.lastMondayBonusWeek !== null || 
                                   newTracking.lastJournalDate !== null;
        if (isMonday && hasTrackingHistory && newTracking.lastMondayBonusWeek !== currentWeek) {
          pointsToAward += 1;
          newTracking.lastMondayBonusWeek = currentWeek;
        }
        
        // 2. Journal entry (0.5 points per day)
        if (journalEntries[today] && newTracking.lastJournalDate !== today) {
          pointsToAward += 0.5;
          newTracking.lastJournalDate = today;
        }
        
        // 3. Weekly intention set (0.5 points per week)
        const hasWeeklyIntention = weeklyHabits && weeklyHabits.length > 0;
        if (hasWeeklyIntention && newTracking.lastWeeklyIntentionWeek !== currentWeek) {
          pointsToAward += 0.5;
          newTracking.lastWeeklyIntentionWeek = currentWeek;
        }
        
        // 4. Custom tendy submitted (0.5 points per week)
        if (weeklyCustomTendy && weeklyCustomTendy.weekOf === currentWeek && 
            newTracking.lastCustomTendyWeek !== currentWeek) {
          pointsToAward += 0.5;
          newTracking.lastCustomTendyWeek = currentWeek;
        }
        
        // 5. 7-day check-in streak (1 point)
        const last7Days = Array.from({length: 7}, (_, i) => {
          const d = new Date();
          d.setDate(d.getDate() - i);
          return d.toISOString().split('T')[0];
        });
        const has7DayStreak = last7Days.every(date => journalEntries[date]);
        if (has7DayStreak && newTracking.last7DayStreakDate !== today) {
          pointsToAward += 1;
          newTracking.last7DayStreakDate = today;
        }
        
        // 6. Goal completion (0.5 points per goal)
        const completedGoals = goals.filter(g => g.completed);
        completedGoals.forEach(goal => {
          if (!newTracking.completedGoalIds.includes(goal.id)) {
            pointsToAward += 0.5;
            newTracking.completedGoalIds.push(goal.id);
          }
        });
        
        // Award points if any were earned
        if (pointsToAward > 0) {
          setFlexPoints(flexPoints + pointsToAward);
          setFlexPointsTracking(newTracking);
        }
      }, [user, dataLoaded, journalEntries, monthlyReviews, weeklyHabits, weeklyCustomTendy, goals, flexPoints, flexPointsTracking]);

      // Auto-save when data changes
      useEffect(() => {
        if (user && dataLoaded) {
          saveUserData();
        }
      }, [vlqScores, vlqCompleted, yearTheme, events, goals, notes, journalEntries, monthlyReviews, yearlyReflections, seasonIntentions, weeklyHabits, dailyHabits, todaysTendies, tendyHistory, tendyPoints, tendyStreak, flexPoints, flexPointsTracking, weeklyCustomTendy, revealed, phase, user, dataLoaded]);

      // Logout function
      const handleLogout = async () => {
        try {
          await auth.signOut();
          // Reset all state
          setVlqScores({
            family: { importance: null, consistency: null },
            partner: { importance: null, consistency: null },
            friendships: { importance: null, consistency: null },
            career: { importance: null, consistency: null },
            education: { importance: null, consistency: null },
            recreation: { importance: null, consistency: null },
            spirituality: { importance: null, consistency: null },
            community: { importance: null, consistency: null },
            health: { importance: null, consistency: null },
            mentalHealth: { importance: null, consistency: null },
          });
          setVlqCompleted(false);
          setVlqStep(-1);
          setYearTheme('');
          setEvents([]);
          setGoals([]);
          setNotes('');
          setSeasonIntentions({ winter: '', spring: '', summer: '', fall: '' });
          setWeeklyHabits([]);
          setDailyHabits([]);
          setRevealed(false);
          setPhase(PHASES.EXPLORE);
          setMessages([]);
          setDataLoaded(false);
        } catch (error) {
          console.error('Error signing out:', error);
        }
      };

      // Set conversation type based on phase
      useEffect(() => {
        if (phase === PHASES.EXPLORE || phase === PHASES.GROUND) {
          setCurrentConversationType('onboarding');
        } else if (phase === PHASES.REVEAL && !vlqCompleted) {
          setCurrentConversationType('onboarding');
        } else if (currentConversationType === 'onboarding' && vlqCompleted) {
          // Save onboarding conversation once VLQ is complete
          saveCurrentConversation();
          setCurrentConversationType('general');
        }
      }, [phase, vlqCompleted]);

      // Loading screen - just the icon
      const loadingScreen = (
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'var(--bg-main)',
        }}>
          <svg width="48" height="48" viewBox="0 0 80 80" fill="none" style={{opacity: 0.6}}>
            <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round"/>
            <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <circle cx="40" cy="70" r="4" fill="none" stroke="var(--accent)" strokeWidth="2"/>
          </svg>
        </div>
      );

      // Initial chat message after VLQ
      useEffect(() => {
        // Only set initial message after VLQ is complete and data is loaded
        if (vlqCompleted && messages.length === 0 && dataLoaded) {
          // Find top growth areas - include all needed fields
          const gaps = VLQ_ORDER.map(key => ({
            key,
            name: VLQ_DOMAINS[key].name,
            importance: vlqScores[key]?.importance || 5,
            consistency: vlqScores[key]?.consistency || 5,
            gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)
          })).sort((a, b) => b.gap - a.gap);
          
          // Find the biggest growth area (gap >= 2) to explore
          const biggestGap = gaps.find(g => g.gap >= 2);
          
          // Find a strength (high importance AND high consistency)
          const topStrength = gaps.find(a => a.importance >= 7 && a.consistency >= 6);

          let openingMessage = '';

          // If they already have a theme word, welcome them back with next steps
          if (yearTheme) {
            openingMessage = `Welcome back! Your word for the year is <em>${yearTheme}</em>.

Now that you have your compass, there are a few paths we could explore together:

<strong>ðŸŒ¸ Seasons</strong> â€” What do you want each season to feel like? Winter might be for rest, spring for new beginnings...

<strong>ðŸ“… Events</strong> â€” Are there trips, milestones, or commitments to map out? Let's make sure your calendar reflects your values.

<strong>ðŸ” Rhythms</strong> â€” What weekly or daily habits would help you live into <em>${yearTheme}</em>?

What feels most alive for you right now?`;
          } else {
            // New user - introduce the process
            openingMessage = `Thank you for sharing what matters to you.

My goal is to help you design a year that actually aligns with your values â€” not just a list of goals, but a life that feels intentional and true to who you are.

To do that, we'll start by finding a <em>theme word</em> for your year â€” one guiding word you can return to when making decisions, setting priorities, or just checking in with yourself.

But first, I'd love to understand your values a bit more deeply.`;
          
            if (biggestGap && biggestGap.gap >= 2) {
              openingMessage += `

I noticed <em>${biggestGap.name}</em> really matters to you (${biggestGap.importance}/10), but you rated how you've been living it as ${biggestGap.consistency}/10. That gap is meaningful.

What's been getting in the way there?`;
            } else if (topStrength) {
              openingMessage += `

I see <em>${topStrength.name}</em> is both important to you and something you're living well â€” that's a real strength.

What's helped you stay consistent there? And are there other areas you'd like to bring that same energy to?`;
            } else {
              openingMessage += `

Looking at your values, what's been on your mind lately? What do you wish had more space in your life this year?`;
            }
          }

          setMessages([{
            role: 'assistant',
            content: openingMessage
          }]);
        }
      }, [vlqCompleted, dataLoaded, yearTheme]);

      // Track view/tab for system prompt context (no auto-messages)

      // Chat resize handlers
      const handleMouseDown = (e) => {
        setIsResizing(true);
        e.preventDefault();
      };

      useEffect(() => {
        const handleMouseMove = (e) => {
          if (!isResizing) return;
          const newWidth = window.innerWidth - e.clientX;
          setChatWidth(Math.min(Math.max(280, newWidth), 600));
        };

        const handleMouseUp = () => {
          setIsResizing(false);
        };

        if (isResizing) {
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        }

        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isResizing]);

      // Sidebar resize handlers
      const handleSidebarMouseDown = (e) => {
        setIsResizingSidebar(true);
        e.preventDefault();
      };

      useEffect(() => {
        const handleSidebarMouseMove = (e) => {
          if (!isResizingSidebar) return;
          const newWidth = e.clientX;
          setSidebarWidth(Math.min(Math.max(200, newWidth), 400));
        };

        const handleSidebarMouseUp = () => {
          setIsResizingSidebar(false);
        };

        if (isResizingSidebar) {
          document.addEventListener('mousemove', handleSidebarMouseMove);
          document.addEventListener('mouseup', handleSidebarMouseUp);
        }

        return () => {
          document.removeEventListener('mousemove', handleSidebarMouseMove);
          document.removeEventListener('mouseup', handleSidebarMouseUp);
        };
      }, [isResizingSidebar]);

      useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
      }, [messages]);

      const analyzeText = (text) => {
        const lower = text.toLowerCase();
        const detected = { values: [] };
        Object.entries(VALUE_KEYWORDS).forEach(([value, keywords]) => {
          if (keywords.some(kw => lower.includes(kw)) && !values.includes(value)) {
            detected.values.push(value);
          }
        });
        return detected;
      };

      const processAnalysis = (detected) => {
        if (detected.values.length > 0) {
          setValues(prev => [...new Set([...prev, ...detected.values])].slice(0, 4));
        }
      };

      const parseEvents = (text) => {
        const lower = text.toLowerCase();
        const foundEvents = [];
        MONTH_FULL.forEach((month, idx) => {
          if (lower.includes(month.toLowerCase())) {
            foundEvents.push({ month: idx });
          }
        });
        return foundEvents;
      };

      const generateResponse = (userMessage, currentPhase, exchangeNum) => {
        const detected = analyzeText(userMessage);
        processAnalysis(detected);
        const lower = userMessage.toLowerCase();

        if (currentPhase === PHASES.EXPLORE) {
          if (exchangeNum === 1) {
            // Try to extract a theme word from their response
            const words = userMessage.split(/\s+/).filter(w => w.length > 2 && w.length < 15);
            const potentialTheme = words.find(w => 
              /^[a-zA-Z]+$/.test(w) && 
              !['the', 'and', 'but', 'for', 'that', 'this', 'with', 'would', 'could', 'think', 'want', 'like', 'year', 'maybe', 'something'].includes(w.toLowerCase())
            );
            
            if (potentialTheme && words.length <= 5) {
              // They likely gave a single word or short phrase
              setYearTheme(potentialTheme.toLowerCase());
              return `<em>${potentialTheme.charAt(0).toUpperCase() + potentialTheme.slice(1).toLowerCase()}</em> â€” I love that.

What does ${potentialTheme.toLowerCase()} mean to you? What would it look like if this year actually embodied that word?`;
            }
            
            const hasFeeling = ['feel', 'feeling', 'want to be', 'less', 'more'].some(w => lower.includes(w));
            if (hasFeeling) {
              return `That's about <em>how</em> you want to feel â€” which is often more important than what you achieve.

If you had to distill that into one word, what would it be? And what's getting in the way of that right now?`;
            }
            return `Tell me more. If you could capture that in a single word â€” a theme for the year â€” what might it be?`;
          }
          
          if (exchangeNum === 2) {
            // Check if they gave a theme word this time
            const words = userMessage.split(/\s+/).filter(w => w.length > 2 && w.length < 15);
            const potentialTheme = words.find(w => 
              /^[a-zA-Z]+$/.test(w) && 
              !['the', 'and', 'but', 'for', 'that', 'this', 'with', 'would', 'could', 'think', 'want', 'like', 'year', 'maybe', 'something'].includes(w.toLowerCase())
            );
            
            if (potentialTheme && !yearTheme) {
              setYearTheme(potentialTheme.toLowerCase());
            }
            
            return `I'm starting to see what matters to you.

If nothing changed this year, how would that feel?`;
          }

          if (exchangeNum >= 3) {
            setPhase(PHASES.GROUND);
            return `Before I share what I'm hearing, help me understand what's already planned.

What's committed this year â€” trips, big events, deadlines? Just mention the month and what it is.`;
          }
        }

        if (currentPhase === PHASES.GROUND) {
          const foundEvents = parseEvents(userMessage);
          
          if (foundEvents.length > 0) {
            const newEvents = foundEvents.map((e, i) => ({
              id: Date.now() + i,
              title: `Event in ${MONTHS[e.month]}`,
              month: e.month,
              lifeArea: 'fun',
              details: { flights: '', stays: '', activities: '', notes: '' },
            }));
            setEvents(prev => [...prev, ...newEvents]);
          }

          setTimeout(() => {
            setPhase(PHASES.REVEAL);
            setRevealed(true);
          }, 500);

          const valuesSummary = values.length > 0 
            ? values.slice(0, 3).join(', ')
            : 'intention and presence';

          return `<strong>Here's what I'm hearing:</strong>

Your values center around <em>${valuesSummary}</em>.

${foundEvents.length > 0 
  ? `You have ${foundEvents.length} thing${foundEvents.length > 1 ? 's' : ''} anchoring the year.`
  : `Your calendar is open â€” that's space to be intentional.`}

Your year is taking shape. Switch between Year, Seasons, and Monthly views to explore different perspectives.

What's missing?`;
        }

        if (currentPhase === PHASES.REVEAL || currentPhase === PHASES.PLAN) {
          setPhase(PHASES.PLAN);

          // Sidebar tabs - Events
          if (activeTab === 'events') {
            if (lower.includes('trip') || lower.includes('travel') || lower.includes('vacation') || lower.includes('visit')) {
              return `A trip! Let's plan it.

Tell me:
â€¢ <em>Where</em> are you thinking?
â€¢ <em>When</em> â€” which month?
â€¢ <em>Who's going</em> â€” solo, partner, friends, family?

Once you add it, I can help with activities, stays, and logistics.`;
            }

            if (lower.includes('birthday') || lower.includes('anniversary') || lower.includes('celebration')) {
              return `Celebrations deserve planning too.

What would make this one special? Think about:
â€¢ The <em>experience</em> you want to create
â€¢ Who needs to be involved
â€¢ What you want to remember about it

Add it to your events and we can flesh out the details.`;
            }

            if (lower.includes('deadline') || lower.includes('work') || lower.includes('project') || lower.includes('launch')) {
              return `Work events anchor the year too.

For this deadline or project:
â€¢ What needs to happen <em>before</em> it?
â€¢ Do you need to protect time leading up to it?
â€¢ What would make it feel successful, not just done?`;
            }

            const eventCount = events.length;
            if (eventCount > 0) {
              return `You have ${eventCount} event${eventCount > 1 ? 's' : ''} planned. Want to add another, or dive deeper into one of these?

I can help with:
â€¢ Activity ideas for any trip
â€¢ Logistics and planning
â€¢ Making sure you're not over-scheduling`;
            }

            return `What's on the horizon? Trips, celebrations, deadlines, milestones?

Even tentative plans are worth capturing â€” they help you see the shape of your year.`;
          }

          // Sidebar tabs - Notes
          if (activeTab === 'notes') {
            return `This is your space to think out loud.

You can use it for:
â€¢ Brain dumps when your head is full
â€¢ Ideas you're not ready to act on
â€¢ Reflections on how things are going
â€¢ Anything that doesn't fit elsewhere

What's taking up mental space right now?`;
          }

          // Sidebar tabs - Goals
          if (activeTab === 'goals') {
            if (lower.includes('fitness') || lower.includes('health') || lower.includes('weight') || lower.includes('run') || lower.includes('exercise')) {
              return `Health goals are foundational.

Make them specific and achievable:
â€¢ <em>"Run a 5K"</em> beats "get in shape"
â€¢ <em>"Workout 3x/week for 3 months"</em> beats "exercise more"
â€¢ <em>"Lose 10 pounds by June"</em> beats "lose weight"

What's your real target?`;
            }

            if (lower.includes('read') || lower.includes('book') || lower.includes('learn')) {
              return `Learning goals expand your world.

Some ways to frame them:
â€¢ <em>"Read 12 books"</em> â€” one a month
â€¢ <em>"Finish one online course"</em>
â€¢ <em>"Learn conversational Spanish"</em>

What do you want to know by year's end?`;
            }

            if (lower.includes('save') || lower.includes('money') || lower.includes('financial') || lower.includes('invest')) {
              return `Financial goals create options.

Be specific:
â€¢ <em>"Save $10K for emergency fund"</em>
â€¢ <em>"Max out retirement contribution"</em>
â€¢ <em>"Pay off credit card by August"</em>

What number would make you feel more secure?`;
            }

            const goalCount = goals.length;
            if (goalCount > 0) {
              return `You have ${goalCount} goal${goalCount > 1 ? 's' : ''} set. Want to add another, or talk through how to make progress on one?

Goals work best when they're:
â€¢ Specific enough to know when you've hit them
â€¢ Connected to what actually matters to you`;
            }

            return `What do you want to be true by the end of this year that isn't true now?

Don't overthink it â€” you can always refine. Start with what comes to mind.`;
          }
          
          // Seasons view - help with season intentions
          if (centerView === CENTER_VIEWS.SEASONS) {
            const seasonWords = {
              winter: ['cozy', 'rest', 'reflect', 'hibernate', 'slow', 'quiet', 'warm'],
              spring: ['renew', 'fresh', 'start', 'bloom', 'energy', 'clean', 'grow'],
              summer: ['adventure', 'explore', 'freedom', 'play', 'travel', 'sun', 'joy'],
              fall: ['harvest', 'gather', 'prepare', 'focus', 'transition', 'gratitude', 'settle']
            };
            
            const currentSeasonName = (() => {
              const month = new Date().getMonth();
              if ([11, 0, 1].includes(month)) return 'winter';
              if ([2, 3, 4].includes(month)) return 'spring';
              if ([5, 6, 7].includes(month)) return 'summer';
              return 'fall';
            })();

            if (lower.includes('winter') || lower.includes('cold') || lower.includes('december') || lower.includes('january') || lower.includes('february')) {
              return `Winter is a time for slowing down.

Some intentions to consider:
â€¢ <em>"Rest without guilt"</em>
â€¢ <em>"Protect my mornings"</em>  
â€¢ <em>"Less doing, more being"</em>

What would make your winter feel nourishing rather than just something to get through?`;
            }
            
            if (lower.includes('spring') || lower.includes('march') || lower.includes('april') || lower.includes('may')) {
              return `Spring is about emergence and new energy.

Some intentions to consider:
â€¢ <em>"Start one thing I've been putting off"</em>
â€¢ <em>"Clear what's not serving me"</em>
â€¢ <em>"Say yes to something new"</em>

What wants to bloom in your life this spring?`;
            }

            if (lower.includes('summer') || lower.includes('june') || lower.includes('july') || lower.includes('august')) {
              return `Summer holds space for expansion and joy.

Some intentions to consider:
â€¢ <em>"Prioritize experiences over tasks"</em>
â€¢ <em>"Protect time for spontaneity"</em>
â€¢ <em>"Be present in the long days"</em>

What would a summer well-lived look like for you?`;
            }

            if (lower.includes('fall') || lower.includes('autumn') || lower.includes('september') || lower.includes('october') || lower.includes('november')) {
              return `Fall is a season of gathering and grounding.

Some intentions to consider:
â€¢ <em>"Harvest what I've built"</em>
â€¢ <em>"Simplify before winter"</em>
â€¢ <em>"Celebrate progress, not just goals"</em>

What do you want to carry into the darker months?`;
            }

            return `Think about what each season needs from you â€” and what you need from it.

You're in <em>${currentSeasonName}</em> right now. How's it going? What would help this season feel more aligned with what you want?`;
          }

          // Monthly view - help with specific month planning
          if (centerView === CENTER_VIEWS.MONTHLY) {
            const monthName = MONTH_FULL[selectedMonth];
            
            if (lower.includes('plan') || lower.includes('suggest') || lower.includes('ideas') || lower.includes('what should')) {
              return `For <em>${monthName}</em>, let's think about:

<strong>What's already anchored?</strong>
Work commitments, birthdays, holidays, travel

<strong>What do you want to protect?</strong>
Rest days, date nights, creative time, nothing-days

<strong>What's one thing that would make this month feel successful?</strong>

Tell me what's on your mind for ${monthName}.`;
            }

            const monthEvents = events.filter(e => e.month === selectedMonth);
            if (monthEvents.length > 0) {
              return `You have <em>${monthEvents.length}</em> thing${monthEvents.length > 1 ? 's' : ''} in ${monthName}: ${monthEvents.map(e => e.title).join(', ')}.

Want me to help you think through any of these? I can suggest activities, help with logistics, or just think through what would make it great.`;
            }

            return `${monthName} is open â€” that's possibility.

What would make this month feel intentional rather than just busy? Any trips, goals, or moments you want to create?`;
          }

          // Weekly view - help with weekly habits
          if (centerView === CENTER_VIEWS.WEEKLY) {
            if (lower.includes('exercise') || lower.includes('workout') || lower.includes('gym') || lower.includes('run') || lower.includes('movement')) {
              return `Movement is foundational. Some weekly rhythms to consider:

â€¢ <em>3x strength, 2x cardio</em> â€” classic balance
â€¢ <em>Daily walks + 2x intense sessions</em> â€” gentler approach
â€¢ <em>1 long active adventure</em> â€” hiking, biking, swimming

What feels sustainable for you? The best routine is one you'll actually do.`;
            }

            if (lower.includes('date') || lower.includes('partner') || lower.includes('relationship') || lower.includes('connect')) {
              return `Protecting time for relationships is one of the most important things you can do.

Ideas for weekly connection:
â€¢ <em>Weekly date night</em> â€” same night each week makes it automatic
â€¢ <em>Morning coffee together</em> â€” 15 minutes of presence
â€¢ <em>Phone-free dinner</em> â€” simple but powerful

What would help your relationships thrive?`;
            }

            if (lower.includes('creative') || lower.includes('hobby') || lower.includes('learn') || lower.includes('read')) {
              return `Making space for creativity and growth:

â€¢ <em>2 hours of creative time</em> â€” protect it like a meeting
â€¢ <em>One chapter a day</em> â€” books add up
â€¢ <em>Weekly learning session</em> â€” courses, podcasts, practice

What do you want to make more time for?`;
            }

            return `Think about the activities that, when you do them regularly, make everything else feel better.

What would you put on your <em>ideal week</em>? Start with just one or two â€” you can always add more.`;
          }

          // Daily view - help with daily habits  
          if (centerView === CENTER_VIEWS.DAILY) {
            if (lower.includes('morning') || lower.includes('wake') || lower.includes('routine')) {
              return `Mornings set the tone for everything.

Some daily morning practices:
â€¢ <em>No phone for first 30 minutes</em>
â€¢ <em>10 minutes of movement</em>
â€¢ <em>Write 3 things you're grateful for</em>
â€¢ <em>One intentional deep breath</em>

What would your ideal morning include?`;
            }

            if (lower.includes('water') || lower.includes('hydrat') || lower.includes('drink')) {
              return `Hydration is one of those small things with outsized impact.

Simple targets:
â€¢ <em>8 glasses / 2 liters</em> â€” the classic
â€¢ <em>Glass before each meal</em> â€” easy to remember
â€¢ <em>Water bottle always visible</em> â€” environment design

What would help you drink more water?`;
            }

            if (lower.includes('walk') || lower.includes('step') || lower.includes('move')) {
              return `Daily movement doesn't have to be intense to be transformative.

Ideas:
â€¢ <em>10,000 steps</em> â€” the gold standard
â€¢ <em>Walk after each meal</em> â€” aids digestion too
â€¢ <em>Standing desk + hourly movement breaks</em>

What level of daily movement feels right for you?`;
            }

            if (lower.includes('phone') || lower.includes('screen') || lower.includes('social media')) {
              return `Our relationship with technology shapes our days more than we realize.

Boundaries to consider:
â€¢ <em>No phone in bedroom</em>
â€¢ <em>App limits on social media</em>
â€¢ <em>Phone-free first and last hour</em>
â€¢ <em>Grayscale mode</em>

What boundary would give you the most peace?`;
            }

            return `Daily habits are about becoming the person you want to be, one small action at a time.

Start tiny â€” what's one thing you could do <em>every single day</em> that would compound over a year?`;
          }
          
          // Default planning responses
          if (lower.includes('plan') || lower.includes('suggest') || lower.includes('ideas') || lower.includes('activities') || lower.includes('where to stay')) {
            const eventMention = events.find(e => lower.includes(MONTHS[e.month].toLowerCase()) || lower.includes(e.title.toLowerCase()));
            if (eventMention) {
              return `For your ${MONTHS[eventMention.month]} event:

<strong>Activities:</strong>
â€¢ Explore the local neighborhood on foot
â€¢ Find one "must-do" and leave room for spontaneity
â€¢ Schedule downtime â€” rest is part of the trip

<strong>Stays:</strong>
â€¢ Look for somewhere with a kitchen for flexibility
â€¢ Consider location vs. price

Click on the event in the sidebar to add details.`;
            }
            return `What event would you like to plan? I can suggest activities, places to stay, and things to consider.`;
          }

          const prompts = [
            `What's one thing you've been wanting to plan but haven't?`,
            `Looking at the seasons â€” where do you need to protect space?`,
            `Is there a trip or experience you keep pushing off?`,
          ];
          return prompts[Math.floor(Math.random() * prompts.length)];
        }

        return `Tell me more about that.`;
      };

      // System prompt for Tend AI
      const getTendSystemPrompt = (pendingState = {}) => {
        const { 
          pendingLifeAreaUpdate, 
          pendingNextAreaIndex, 
          pendingWaitingForSatisfaction,
          pendingIsLastResponse 
        } = pendingState;
        
        // Use pending values if provided, otherwise use current state
        const effectiveAreaIndex = pendingNextAreaIndex !== undefined ? pendingNextAreaIndex : currentLifeAreaIndex;
        const effectiveWaitingFor = pendingWaitingForSatisfaction !== undefined ? pendingWaitingForSatisfaction : waitingForSatisfaction;
        const effectiveIsLast = pendingIsLastResponse || isLastLifeAreaResponse;
        
        // Build updated life area ratings including any pending update
        const effectiveRatings = pendingLifeAreaUpdate 
          ? {
              ...lifeAreaRatings,
              [pendingLifeAreaUpdate.area]: {
                ...lifeAreaRatings[pendingLifeAreaUpdate.area],
                [pendingLifeAreaUpdate.field]: pendingLifeAreaUpdate.score
              }
            }
          : lifeAreaRatings;

        const currentSeason = (() => {
          const month = new Date().getMonth();
          if ([11, 0, 1].includes(month)) return 'winter';
          if ([2, 3, 4].includes(month)) return 'spring';
          if ([5, 6, 7].includes(month)) return 'summer';
          return 'fall';
        })();

        const lifeAreasContext = vlqCompleted 
          ? VLQ_ORDER.map(key => {
              const scores = vlqScores[key];
              const gap = (scores?.importance || 0) - (scores?.consistency || 0);
              return `${VLQ_DOMAINS[key].name}: importance ${scores?.importance}/10, consistency ${scores?.consistency}/10${gap >= 3 ? ' (GROWTH AREA)' : ''}`;
            }).join('; ')
          : 'not assessed yet';

        // Check for misalignments between intentions and actual plans
        const getMisalignments = () => {
          if (!lifeAreasCompleted && !effectiveIsLast) return '';
          const ratingsToCheck = effectiveIsLast ? effectiveRatings : lifeAreaRatings;
          const misalignments = [];
          
          // High intention areas with low activity
          Object.entries(ratingsToCheck).forEach(([key, val]) => {
            if (val.intention >= 7) {
              const relatedHabits = weeklyHabits.filter(h => 
                h.text.toLowerCase().includes(key) || 
                (key === 'health' && /exercise|workout|gym|run|walk|yoga/i.test(h.text)) ||
                (key === 'relationships' && /date|partner|friend|family|call/i.test(h.text)) ||
                (key === 'fun' && /hobby|play|adventure|trip/i.test(h.text))
              );
              const relatedEvents = events.filter(e => e.lifeArea === key);
              
              if (relatedHabits.length === 0 && relatedEvents.length === 0) {
                misalignments.push(`${LIFE_AREAS[key].name} has high intention (${val.intention}) but no related habits or events`);
              }
            }
          });
          
          return misalignments.length > 0 
            ? `\n\nPotential misalignments to gently explore: ${misalignments.join('; ')}`
            : '';
        };

        return `You are Tend, a thoughtful AI companion for intentional living and life design. You help people design their year with intention â€” not just survive, but live intentionally and mindfully.

Your personality:
- Warm, calm, and grounded â€” like a wise friend
- You ask thoughtful questions rather than give prescriptive advice
- You're concise â€” 2-4 sentences is often enough, occasionally more for important moments
- You use gentle emphasis with *italics* for key words (use asterisks for italics)
- You avoid bullet points in conversation â€” speak naturally

Current context:
- The user is designing their 2026
- Current view: ${centerView}
- Current sidebar tab: ${activeTab}
- Current season: ${currentSeason}
- Their year theme: ${yearTheme || 'not set yet'}
- Their values: ${values.length > 0 ? values.join(', ') : 'not identified yet'}
- Life areas (from VLQ): ${lifeAreasContext}
- Their events: ${events.length > 0 ? events.map(e => `${MONTHS[e.month]}: ${e.title}`).join(', ') : 'none yet'}
- Weekly habits: ${weeklyHabits.length > 0 ? weeklyHabits.map(h => `${h.text} (${h.frequency}x/week)`).join(', ') : 'none yet'}
- Daily habits: ${dailyHabits.length > 0 ? dailyHabits.map(h => h.text).join(', ') : 'none yet'}
- Phase: ${phase} (explore = getting to know them, ground = understanding commitments, reveal = unlocking the app, plan = ongoing planning)
- Conversation length: ${messages.length} messages so far
${getMisalignments()}

The user has already completed the VLQ (Valued Living Questionnaire) assessment. You know their values - use this knowledge to personalize your guidance.

IMPORTANT - Theme Word Discovery Process (in EXPLORE phase):
1. DO NOT ask the user "what word do you want for your year" upfront
2. Instead, EXPLORE their VLQ results through conversation:
   - Ask about their growth areas (high importance, low consistency)
   - Ask what's been getting in the way
   - Ask what they wish was different
   - Ask what they want more of
3. After 4-6 exchanges of genuine conversation, SUGGEST a theme word based on what you've learned. Frame it like this:
   - Explain what a theme word is: "A theme word is like a compass â€” one guiding word you can return to throughout the year to center yourself and make decisions."
   - Then suggest: "Based on what you've shared about [summarize key themes], I think your word might be *[word]*. It captures [specific reason tied to what they said]."
   - Ask: "Does that resonate? Feel free to try it on, adjust it, or suggest something else."
4. Let them accept, modify, or suggest alternatives
5. Once they accept a word, celebrate briefly then offer three paths forward:
   - "Now that you have your compass, here are some ways we could go deeper:"
   - **Seasons** â€” "We could think about what you want each season to feel like"
   - **Events** â€” "We could map out trips, milestones, or commitments for the year"  
   - **Rhythms** â€” "We could establish weekly or daily habits that support your theme"
   - Ask: "What feels most alive for you right now?"

CURRENT VIEW: ${centerView.toUpperCase()}
${centerView === 'year' ? `
You're on the YEAR view. ${yearTheme ? `Their theme word is "${yearTheme}". If this is a returning user, offer the three paths (Seasons, Events, Rhythms) and ask what they want to explore. Help them see how their year could unfold around this theme.` : `Focus on discovering their theme word through conversation. Don't ask directly - explore their VLQ results and what they want from the year, then suggest a word.`}
` : ''}${centerView === 'seasons' ? `
You're on the SEASONS view. Help them think about what each season could feel like and hold for them. Ask about:
- What's already planned for each season?
- How do they want each season to feel?
- Are there natural rhythms they want to honor (rest in winter, growth in spring, adventure in summer, harvest in fall)?
` : ''}${centerView === 'monthly' ? `
You're on the MONTHLY view. Help them plan specific events and commitments. Ask about:
- What trips, events, or milestones are coming up?
- Are there months that feel too full or too empty?
- What needs to be scheduled to honor their values?
` : ''}${centerView === 'weekly' ? `
You're on the WEEKLY view. Help them establish weekly rhythms and recurring commitments. Ask about:
- What weekly habits would support their values? (exercise, date nights, creative time, rest)
- What's a realistic frequency for each?
- How can they protect time for what matters?
` : ''}${centerView === 'daily' ? `
You're on the DAILY view. Help them identify small daily habits that compound over time. Ask about:
- What tiny habits would make the biggest difference?
- What do they want their mornings or evenings to look like?
- What daily practice would support their theme word?
` : ''}
If they mention specific events, habits, or plans, acknowledge those and help them think through the details.
If they seem stuck, offer a gentle prompt or example.
If you notice a misalignment between their VLQ values (high importance areas) and their actual plans, gently bring it up.

Keep responses focused and conversational. You're not a productivity app â€” you're helping them live with more intention.`;
      };

      // Call Claude API
      const callClaudeAPI = async (userMessage, pendingState = {}) => {
        if (!apiKey) {
          return "I'd love to help you plan, but I need an API key to think deeply. Click the âš™ settings icon to add your Anthropic API key.";
        }

        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 500,
              system: getTendSystemPrompt(pendingState),
              messages: [
                ...messages.map(m => ({
                  role: m.role === 'assistant' ? 'assistant' : 'user',
                  content: m.content.replace(/<[^>]*>/g, '') // Strip HTML for API
                })),
                { role: 'user', content: userMessage }
              ]
            })
          });

          if (!response.ok) {
            const error = await response.json();
            console.error('API Error:', error);
            if (response.status === 401) {
              return "That API key doesn't seem to be working. Check your key in settings (âš™).";
            }
            return "Something went wrong connecting to Claude. Try again?";
          }

          const data = await response.json();
          return data.content[0].text;
        } catch (error) {
          console.error('Fetch error:', error);
          return "I couldn't connect to Claude. Check your internet connection and try again.";
        }
      };

      const handleSendMessage = async () => {
        if (!inputValue.trim()) return;
        
        const userMessage = inputValue.trim();
        setMessages(prev => [...prev, { 
          role: 'user', 
          content: userMessage,
          timestamp: new Date().toISOString()
        }]);
        setInputValue('');
        setIsTyping(true);
        setExchangeCount(prev => prev + 1);

        // Handle life areas mode - parse numbers
        let pendingLifeAreaUpdate = null;
        let pendingNextAreaIndex = currentLifeAreaIndex;
        let pendingWaitingForSatisfaction = waitingForSatisfaction;
        let pendingIsLastResponse = false;
        
        if (lifeAreasMode) {
          const numbers = userMessage.match(/\b([1-9]|10)\b/g);
          if (numbers && numbers.length > 0) {
            const score = parseInt(numbers[0]);
            const currentArea = lifeAreaOrder[currentLifeAreaIndex];
            
            if (waitingForSatisfaction) {
              pendingLifeAreaUpdate = { area: currentArea, field: 'satisfaction', score };
              setLifeAreaRatings(prev => ({
                ...prev,
                [currentArea]: { ...prev[currentArea], satisfaction: score }
              }));
              setWaitingForSatisfaction(false);
              pendingWaitingForSatisfaction = false;
            } else {
              pendingLifeAreaUpdate = { area: currentArea, field: 'intention', score };
              setLifeAreaRatings(prev => ({
                ...prev,
                [currentArea]: { ...prev[currentArea], intention: score }
              }));
              
              // Move to next area
              if (currentLifeAreaIndex < lifeAreaOrder.length - 1) {
                setCurrentLifeAreaIndex(prev => prev + 1);
                setWaitingForSatisfaction(true);
                pendingNextAreaIndex = currentLifeAreaIndex + 1;
                pendingWaitingForSatisfaction = true;
              } else {
                // This is the final area - flag for summary, then complete
                setIsLastLifeAreaResponse(true);
                pendingIsLastResponse = true;
              }
            }
          }
        }

        // Analyze for values/events even with API
        const detected = analyzeText(userMessage);
        processAnalysis(detected);
        
        // Parse events from message
        const foundEvents = parseEvents(userMessage);
        if (foundEvents.length > 0 && phase === PHASES.GROUND) {
          const newEvents = foundEvents.map((e, i) => ({
            id: Date.now() + i,
            title: `Event in ${MONTHS[e.month]}`,
            month: e.month,
            lifeArea: 'fun',
            details: { flights: '', stays: '', activities: '', notes: '' },
          }));
          setEvents(prev => [...prev, ...newEvents]);
        }

        // Check for theme word throughout conversation (not just early exchanges)
        if (!yearTheme) {
          const lowerMessage = userMessage.toLowerCase();
          
          // Get AI's last message to check if it suggested a word
          const lastAIMessage = messages.length >= 2 ? messages[messages.length - 2]?.content : '';
          
          // Check if user is agreeing to AI's suggestion
          const isAgreement = /^(yes|yeah|yep|yup|sure|absolutely|definitely|love it|like it|i like it|i love it|that's perfect|perfect|sounds good|that works|that's good|agreed|great|sounds great|i agree|let's do it|let's go with that)$/i.test(userMessage.trim()) ||
                            /^(yes|yeah|yep|sure|love it|like it|perfect|great|sounds good)[,!.\s]*$/i.test(userMessage.trim());
          
          if (isAgreement && lastAIMessage) {
            // Extract word from AI's message - look for quoted words or words in context
            const suggestionPatterns = [
              /"([a-z]+)"/i,  // Quoted words
              /how about "([a-z]+)"/i,
              /what about "([a-z]+)"/i,
              /suggest(?:ing)? "([a-z]+)"/i,
              /word.*"([a-z]+)"/i,
              /theme.*"([a-z]+)"/i,
              /how about ([a-z]+)[?.!\s]/i,
              /what about ([a-z]+)[?.!\s]/i,
              /maybe ([a-z]+)[?.!\s]/i,
              /perhaps ([a-z]+)[?.!\s]/i,
            ];
            
            for (const pattern of suggestionPatterns) {
              const match = lastAIMessage.match(pattern);
              if (match && match[1]) {
                const word = match[1].toLowerCase();
                if (word.length >= 4 && word.length <= 15 && !['the', 'and', 'but', 'for', 'that', 'this', 'with', 'would', 'could'].includes(word)) {
                  setYearTheme(word);
                  console.log('Year theme set from AI suggestion:', word);
                  break;
                }
              }
            }
          }
          
          // Check for explicit user statements like "my word is X"
          if (!yearTheme) {
            const explicitPatterns = [
              /(?:my word|the word|my theme|the theme)(?:\s+for\s+(?:the\s+year|\d{4}))?\s+is\s+([a-z]+)/i,
              /(?:i choose|i'll go with|let's go with|i'll choose|i want)\s+([a-z]+)/i,
            ];
            
            for (const pattern of explicitPatterns) {
              const match = userMessage.match(pattern);
              if (match && match[1]) {
                const word = match[1].toLowerCase();
                // Filter out common words
                if (!['the', 'and', 'but', 'for', 'that', 'this', 'with', 'would', 'could', 'think', 'want', 'like', 'year', 'maybe', 'something', 'okay', 'sure', 'yes', 'great', 'good', 'nice'].includes(word)) {
                  setYearTheme(word);
                  console.log('Year theme set from explicit statement:', word);
                  break;
                }
              }
            }
          }
          
          // Check for single-word responses (but only if it seems intentional)
          if (!yearTheme && /^[a-z]{4,15}$/i.test(userMessage.trim())) {
            const word = userMessage.trim().toLowerCase();
            if (!['the', 'and', 'but', 'for', 'that', 'this', 'with', 'would', 'could', 'think', 'want', 'like', 'year', 'maybe', 'something', 'okay', 'sure', 'yes', 'great', 'good', 'nice', 'yeah', 'yep', 'nope'].includes(word)) {
              // Check if AI's last message was asking about themes/words
              if (lastAIMessage && /(word|theme|intention|focus)/i.test(lastAIMessage)) {
                setYearTheme(word);
                console.log('Year theme set from single-word response:', word);
              }
            }
          }
          
          // Fallback: check for theme word in early exchanges (original logic)
          if (!yearTheme && phase === PHASES.EXPLORE && exchangeCount < 3) {
            const words = userMessage.split(/\s+/).filter(w => w.length > 2 && w.length < 15);
            const potentialTheme = words.find(w => 
              /^[a-zA-Z]+$/.test(w) && 
              !['the', 'and', 'but', 'for', 'that', 'this', 'with', 'would', 'could', 'think', 'want', 'like', 'year', 'maybe', 'something'].includes(w.toLowerCase())
            );
            if (potentialTheme && words.length <= 5) {
              setYearTheme(potentialTheme.toLowerCase());
              console.log('Year theme set from early exchange:', potentialTheme.toLowerCase());
            }
          }
        }

        // Progress phases based on exchange count
        if (phase === PHASES.EXPLORE && exchangeCount >= 2) {
          setPhase(PHASES.GROUND);
        }
        if (phase === PHASES.GROUND && exchangeCount >= 3 && !revealed) {
          setPhase(PHASES.REVEAL);
          setRevealed(true);
          // Start life areas mode - Claude will handle the transition naturally via system prompt
          if (!lifeAreasCompleted) {
            setLifeAreasMode(true);
          }
        }

        // Get response from Claude API
        const response = await callClaudeAPI(userMessage, {
          pendingLifeAreaUpdate,
          pendingNextAreaIndex,
          pendingWaitingForSatisfaction,
          pendingIsLastResponse
        });
        setMessages(prev => [...prev, { 
          role: 'assistant', 
          content: response,
          timestamp: new Date().toISOString()
        }]);
        setIsTyping(false);
        
        // Complete life areas after the summary response
        if (isLastLifeAreaResponse || pendingIsLastResponse) {
          setLifeAreasCompleted(true);
          setLifeAreasMode(false);
          setIsLastLifeAreaResponse(false);
        }
      };

      const handleSkip = () => {
        setPhase(PHASES.PLAN);
        setRevealed(true);
        setMessages(prev => [...prev, {
          role: 'assistant',
          content: `No problem â€” let's dive in.

Use the view switcher to explore your year. Add events, set season intentions, and plan the details.

I'm here to help with any planning.`
        }]);
      };

      const handleAddEvent = (eventData) => {
        setEvents(prev => [...prev, { 
          ...eventData, 
          id: Date.now(),
          details: { flights: '', stays: '', activities: '', notes: '' },
        }]);
        setShowEventModal(false);
      };

      const handleUpdateEventDetails = (eventId, field, value) => {
        setEvents(prev => prev.map(e => 
          e.id === eventId ? { ...e, details: { ...e.details, [field]: value } } : e
        ));
      };

      const handleAddGoal = (goalData) => {
        setGoals(prev => [...prev, { ...goalData, id: Date.now(), completed: false }]);
        setShowGoalModal(false);
      };

      const handleVlqComplete = () => {
        setVlqCompleted(true);
        // Pre-fill values based on high-importance domains
        const highImportance = VLQ_ORDER
          .filter(key => vlqScores[key]?.importance >= 7)
          .map(key => VLQ_DOMAINS[key].name.split(' ')[0]);
        if (highImportance.length > 0) {
          setValues(highImportance.slice(0, 3));
        }
      };

      // Mode selection screen
      const modeSelectionScreen = (
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'var(--bg-main)',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        }}>
          <svg width="48" height="48" viewBox="0 0 80 80" fill="none" style={{opacity: 0.7, marginBottom: '1.5rem'}}>
            <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round"/>
            <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <circle cx="40" cy="70" r="4" fill="none" stroke="var(--accent)" strokeWidth="2"/>
          </svg>
          
          {yearTheme && (
            <div style={{
              padding: '1rem 1.5rem',
              backgroundColor: 'var(--accent-light)',
              border: '2px solid var(--accent)',
              borderRadius: '12px',
              marginBottom: '1.5rem',
              textAlign: 'center',
              maxWidth: '320px',
              width: '100%',
            }}>
              <div style={{
                fontSize: '0.7rem',
                textTransform: 'uppercase',
                letterSpacing: '0.1em',
                color: 'var(--text-muted)',
                marginBottom: '0.25rem',
              }}>
                Your Word for {new Date().getFullYear()}
              </div>
              <div style={{
                fontFamily: "'Fraunces', serif",
                fontSize: '1.75rem',
                color: 'var(--accent)',
                fontWeight: 500,
              }}>
                {yearTheme}
              </div>
            </div>
          )}
          
          <h2 style={{
            fontFamily: "'Fraunces', serif",
            fontSize: '1.5rem',
            color: 'var(--text)',
            marginBottom: '0.5rem',
            fontWeight: 400,
          }}>
            {yearTheme ? `Welcome back` : 'Welcome'}
          </h2>
          <p style={{
            color: 'var(--text-muted)',
            fontSize: '0.95rem',
            marginBottom: '2rem',
          }}>
            What would you like to do today?
          </p>

          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '1rem',
            width: '100%',
            maxWidth: '320px',
          }}>
            {/* Tendies - Featured option */}
            <button
              onClick={() => setAppMode('tendy')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--accent-light)',
                border: '2px solid var(--accent)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>ðŸŒ±</span>
                <div style={{flex: 1}}>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Daily Tend</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>One small action aligned with your values</div>
                </div>
                {tendyPoints > 0 && (
                  <div style={{
                    backgroundColor: 'var(--accent)',
                    color: 'white',
                    fontSize: '0.7rem',
                    padding: '0.25rem 0.5rem',
                    borderRadius: '10px',
                    fontWeight: 500,
                  }}>
                    {tendyPoints} pts
                  </div>
                )}
              </div>
            </button>

            <button
              onClick={() => setAppMode('journal')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>ðŸ“</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Journal Mode</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>Reflect on your day</div>
                </div>
              </div>
            </button>

            <button
              onClick={() => setAppMode('insights')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>ðŸ“Š</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Your Insights</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>See your trends and progress</div>
                </div>
              </div>
            </button>

            <button
              onClick={() => setAppMode('plan')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>ðŸ—“ï¸</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Plan & Design Mode</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>Shape your year</div>
                </div>
              </div>
            </button>
          </div>
        </div>
      );

      // Show loading icon for minimum time
      if (showLoadingIcon || authLoading) {
        return loadingScreen;
      }

      // Show auth screen if not logged in
      if (!user) {
        return <AuthModal onSuccess={() => {}} />;
      }

      // Wait for user data to load from Firebase before deciding what to show
      if (!dataLoaded) {
        return loadingScreen;
      }

      // Show VLQ assessment first (new users)
      if (!vlqCompleted) {
        return (
          <VLQAssessment
            vlqScores={vlqScores}
            setVlqScores={setVlqScores}
            vlqStep={vlqStep}
            setVlqStep={setVlqStep}
            onComplete={handleVlqComplete}
          />
        );
      }

      // Show mode selection for all returning users who have completed VLQ
      if (appMode === null) {
        return modeSelectionScreen;
      }

      // Journal mode
      if (appMode === 'journal') {
        return (
          <JournalView 
            yearTheme={yearTheme}
            vlqScores={vlqScores}
            journalEntries={journalEntries}
            setJournalEntries={setJournalEntries}
            monthlyReviews={monthlyReviews}
            setMonthlyReviews={setMonthlyReviews}
            yearlyReflections={yearlyReflections}
            setYearlyReflections={setYearlyReflections}
            todaysTendies={todaysTendies}
            tendyHistory={tendyHistory}
            flexPoints={flexPoints}
            setFlexPoints={setFlexPoints}
            flexPointsTracking={flexPointsTracking}
            setFlexPointsTracking={setFlexPointsTracking}
            goals={goals}
            setAppMode={setAppMode}
            setMessages={setMessages}
            onSwitchMode={() => setAppMode('plan')}
            onBack={() => setAppMode(null)}
          />
        );
      }

      // Insights mode
      if (appMode === 'insights') {
        return (
          <InsightsView
            trends={calculateTrends()}
            vlqScores={vlqScores}
            yearTheme={yearTheme}
            flexPoints={flexPoints}
            onBack={() => setAppMode(null)}
          />
        );
      }

      // Tendy mode
      if (appMode === 'tendy') {
        return (
          <TendyView
            vlqScores={vlqScores}
            todaysTendies={todaysTendies}
            setTodaysTendies={setTodaysTendies}
            tendyHistory={tendyHistory}
            setTendyHistory={setTendyHistory}
            tendyPoints={tendyPoints}
            setTendyPoints={setTendyPoints}
            tendyStreak={tendyStreak}
            setTendyStreak={setTendyStreak}
            flexPoints={flexPoints}
            setFlexPoints={setFlexPoints}
            weeklyCustomTendy={weeklyCustomTendy}
            setWeeklyCustomTendy={setWeeklyCustomTendy}
            apiKey={apiKey}
            onBack={() => setAppMode(null)}
          />
        );
      }

      return (
        <div style={styles.container}>
          <header style={styles.header}>
            <div style={styles.logoContainer}>
              <svg width="28" height="28" viewBox="0 0 32 32" fill="none" style={{ marginRight: '8px' }}>
                <path d="M16 26 Q16 18 16 14" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round" fill="none"/>
                <path d="M16 18 Q10 16 8 10 Q14 12 16 18" fill="var(--accent)" opacity="0.5"/>
                <path d="M16 14 Q22 10 24 4 Q18 8 16 14" fill="var(--accent)"/>
                <path d="M16 10 Q14 6 16 2 Q18 6 16 10" fill="var(--accent)" opacity="0.7"/>
              </svg>
              <h1 style={styles.logoText}>tend</h1>
            </div>
            {yearTheme ? (
              <p style={{
                ...styles.tagline,
                display: 'flex',
                alignItems: 'center',
                gap: '0.5rem',
              }}>
                <span style={{opacity: 0.7}}>a space for designing your life with intention</span>
                <span style={{
                  padding: '0.25rem 0.75rem',
                  backgroundColor: 'var(--accent-light)',
                  border: '1px solid var(--accent)',
                  borderRadius: '6px',
                  color: 'var(--accent)',
                  fontSize: '0.8rem',
                  fontWeight: 500,
                }}>
                  {new Date().getFullYear()}: {yearTheme}
                </span>
              </p>
            ) : (
              <p style={styles.tagline}>a space for designing your life with intention</p>
            )}
            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
              <button 
                style={{
                  ...styles.settingsButton,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.375rem',
                  fontSize: '0.8rem',
                  padding: '0.375rem 0.75rem',
                  borderRadius: '8px',
                  backgroundColor: 'var(--bg-elevated)',
                  border: '1px solid var(--border)',
                }}
                onClick={() => setAppMode('tendy')}
                title="Daily Tend"
              >
                ðŸŒ± Daily Tend
              </button>
              <button 
                style={{
                  ...styles.settingsButton,
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.375rem',
                  fontSize: '0.8rem',
                  padding: '0.375rem 0.75rem',
                  borderRadius: '8px',
                  backgroundColor: 'var(--bg-elevated)',
                  border: '1px solid var(--border)',
                }}
                onClick={() => setAppMode('journal')}
                title="Switch to Daily Journal"
              >
                ðŸ“ Journal
              </button>
              <button 
                style={styles.settingsButton} 
                onClick={() => setShowSettingsModal(true)}
                title="Settings"
              >
                âš™
              </button>
            </div>
          </header>

          <main style={{...styles.main, gridTemplateColumns: `${sidebarExpanded ? sidebarWidth : 64}px 1fr ${chatWidth}px`}}>
            {/* Left Sidebar */}
            <aside style={{
              ...styles.sidebar,
              width: sidebarExpanded ? sidebarWidth : 64,
              transition: sidebarExpanded ? 'none' : 'width 0.2s ease',
              position: 'relative'
            }}>
              {/* Resize handle when expanded */}
              {sidebarExpanded && (
                <div 
                  style={styles.sidebarResizeHandle}
                  onMouseDown={handleSidebarMouseDown}
                  title="Drag to resize"
                />
              )}
              
              <div style={styles.sidebarNav}>
                {[
                  { id: 'events', icon: 'ðŸ“…', label: 'Events' },
                  { id: 'notes', icon: 'ðŸ—’ï¸', label: 'Notes' },
                  { id: 'lifeareas', icon: 'ðŸŒ±', label: 'Life Areas' }
                ].map(item => (
                  <button
                    key={item.id}
                    style={{
                      ...styles.sidebarNavItem,
                      ...(activeTab === item.id && sidebarExpanded && styles.sidebarNavItemActive),
                      backgroundColor: activeTab === item.id && sidebarExpanded ? 'var(--bg-elevated)' : 'transparent'
                    }}
                    onClick={() => {
                      if (activeTab === item.id && sidebarExpanded) {
                        setSidebarExpanded(false);
                      } else {
                        setActiveTab(item.id);
                        setSidebarExpanded(true);
                      }
                    }}
                    title={item.label}
                  >
                    <span style={styles.sidebarNavIcon}>{item.icon}</span>
                    <span style={{
                      ...styles.sidebarNavLabel,
                      opacity: sidebarExpanded ? 1 : 0,
                      width: sidebarExpanded ? 'auto' : 0
                    }}>{item.label}</span>
                  </button>
                ))}
              </div>

              {/* Tab content when expanded */}
              {sidebarExpanded && (
                <div style={styles.tabContent}>
                  {activeTab === 'events' && (
                    <EventsTab
                      events={events}
                      expandedEvent={expandedEvent}
                      setExpandedEvent={setExpandedEvent}
                      onUpdateDetails={handleUpdateEventDetails}
                      onDelete={(id) => setEvents(events.filter(e => e.id !== id))}
                      onAdd={() => setShowEventModal(true)}
                      revealed={revealed}
                    />
                  )}
                  {activeTab === 'notes' && (
                    <NotesTab notes={notes} setNotes={setNotes} revealed={revealed} />
                  )}
                  {activeTab === 'lifeareas' && (
                    <LifeAreasTab 
                      vlqScores={vlqScores}
                      setVlqScores={setVlqScores}
                      goals={goals}
                      setGoals={setGoals}
                      onReassess={() => { setVlqStep(-1); setVlqCompleted(false); }}
                      onAddGoal={() => setShowGoalModal(true)}
                      revealed={revealed}
                    />
                  )}
                </div>
              )}
            </aside>

            <div style={styles.centerPanel}>
              <div style={styles.viewSwitcher}>
                {[
                  { id: CENTER_VIEWS.YEAR, label: 'Year' },
                  { id: CENTER_VIEWS.SEASONS, label: 'Seasons' },
                  { id: CENTER_VIEWS.MONTHLY, label: 'Monthly' },
                  { id: CENTER_VIEWS.WEEKLY, label: 'Weekly' },
                  { id: CENTER_VIEWS.DAILY, label: 'Daily' },
                ].map(view => (
                  <button
                    key={view.id}
                    style={{...styles.viewButton, ...(centerView === view.id && styles.viewButtonActive)}}
                    onClick={() => setCenterView(view.id)}
                  >
                    {view.label}
                  </button>
                ))}
              </div>

              {centerView === CENTER_VIEWS.YEAR && (
                <YearCircleView 
                  events={events}
                  revealed={revealed}
                  onAddEvent={() => setShowEventModal(true)}
                  yearTheme={yearTheme}
                  setYearTheme={setYearTheme}
                />
              )}
              {centerView === CENTER_VIEWS.SEASONS && (
                <SeasonsView 
                  seasonIntentions={seasonIntentions}
                  setSeasonIntentions={setSeasonIntentions}
                  revealed={revealed}
                />
              )}
              {centerView === CENTER_VIEWS.MONTHLY && (
                <MonthlyView 
                  events={events}
                  selectedMonth={selectedMonth}
                  setSelectedMonth={setSelectedMonth}
                  revealed={revealed}
                  onAddEvent={() => setShowEventModal(true)}
                />
              )}
              {centerView === CENTER_VIEWS.WEEKLY && (
                <WeeklyView 
                  weeklyHabits={weeklyHabits}
                  setWeeklyHabits={setWeeklyHabits}
                  revealed={revealed}
                />
              )}
              {centerView === CENTER_VIEWS.DAILY && (
                <DailyView 
                  dailyHabits={dailyHabits}
                  setDailyHabits={setDailyHabits}
                  revealed={revealed}
                />
              )}

              <div style={styles.bottomSection}>
                <div style={styles.vlqSummary}>
                  <div style={styles.vlqSummaryColumn}>
                    <span style={styles.vlqSummaryLabel}>ðŸŒ± Focus on</span>
                    <div style={styles.vlqSummaryItems}>
                      {(() => {
                        const allAreas = VLQ_ORDER.map(key => ({
                          key, 
                          ...VLQ_DOMAINS[key], 
                          importance: vlqScores[key]?.importance || 5,
                          consistency: vlqScores[key]?.consistency || 5,
                          gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)
                        }));
                        // Strengths: high importance AND consistency is close to importance (gap < 2)
                        const strengthKeys = allAreas
                          .filter(a => a.importance >= 7 && a.consistency >= 6 && a.gap < 2)
                          .map(a => a.key);
                        // Growth: gap >= 2 AND not already a strength
                        return allAreas
                          .filter(a => a.gap >= 2 && !strengthKeys.includes(a.key))
                          .sort((a, b) => b.gap - a.gap)
                          .slice(0, 3)
                          .map(area => (
                            <span key={area.key} style={{...styles.vlqSummaryTag, borderColor: area.color, color: area.color}}>
                              {area.icon} {area.name.split(' ')[0]}
                            </span>
                          ));
                      })()}
                    </div>
                  </div>
                  <div style={styles.vlqSummaryColumn}>
                    <span style={styles.vlqSummaryLabel}>ðŸ’ª Thriving in</span>
                    <div style={styles.vlqSummaryItems}>
                      {VLQ_ORDER
                        .map(key => ({key, ...VLQ_DOMAINS[key], importance: vlqScores[key]?.importance || 5, consistency: vlqScores[key]?.consistency || 5, gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)}))
                        .filter(a => a.importance >= 7 && a.consistency >= 6 && a.gap < 2)
                        .slice(0, 3)
                        .map(area => (
                          <span key={area.key} style={{...styles.vlqSummaryTag, borderColor: area.color, color: area.color, opacity: 0.8}}>
                            {area.icon} {area.name.split(' ')[0]}
                          </span>
                        ))
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div style={styles.chatPanel}>
              <div 
                style={styles.resizeHandle} 
                onMouseDown={handleMouseDown}
                title="Drag to resize"
              />
              <div style={styles.chatMessages}>
                {messages.map((msg, idx) => (
                  <ChatMessage key={idx} message={msg} />
                ))}
                {isTyping && <TypingIndicator />}
                <div ref={messagesEndRef} />
              </div>
              
              <div style={styles.chatInputArea}>
                {!revealed && phase === PHASES.EXPLORE && (
                  <button style={styles.skipButton} onClick={handleSkip}>Skip to planning â†’</button>
                )}
                <div style={styles.inputRow}>
                  <textarea
                    style={styles.chatInput}
                    value={inputValue}
                    onChange={(e) => setInputValue(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                      }
                    }}
                    placeholder="Say whatever comes to mind..."
                    rows={2}
                  />
                  <button 
                    style={{...styles.sendButton, ...(inputValue.trim() ? {} : styles.sendButtonDisabled)}}
                    onClick={handleSendMessage}
                    disabled={!inputValue.trim()}
                  >â†‘</button>
                </div>
              </div>
            </div>
          </main>

          {showEventModal && <EventModal onClose={() => setShowEventModal(false)} onAdd={handleAddEvent} />}
          {showGoalModal && <GoalModal onClose={() => setShowGoalModal(false)} onAdd={handleAddGoal} />}
          {showSettingsModal && (
            <SettingsModal 
              apiKey={apiKey} 
              setApiKey={(key) => {
                setApiKey(key);
                localStorage.setItem('tend_api_key', key);
              }} 
              onClose={() => setShowSettingsModal(false)}
              user={user}
              onLogout={handleLogout}
            />
          )}
          {showAdminDashboard && (
            <AdminDashboard
              user={user}
              savedConversations={savedConversations}
              trends={calculateTrends()}
              userProfile={userProfile}
              journalEntries={journalEntries}
              goals={goals}
              events={events}
              onClose={() => setShowAdminDashboard(false)}
            />
          )}
        </div>
      );
    }

    // ============ JOURNAL VIEW (TABBED) ============
    function JournalView({ 
      yearTheme, 
      vlqScores, 
      journalEntries, 
      setJournalEntries,
      monthlyReviews,
      setMonthlyReviews,
      yearlyReflections,
      setYearlyReflections,
      todaysTendies,
      tendyHistory,
      flexPoints,
      setFlexPoints,
      flexPointsTracking,
      setFlexPointsTracking,
      onSwitchMode, 
      onBack,
      setAppMode,
      setMessages,
      goals
    }) {
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
      
      // Check if it's time for monthly review (last 3 days of month)
      const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
      const daysUntilEndOfMonth = lastDayOfMonth - today.getDate();
      const isMonthlyReviewTime = daysUntilEndOfMonth <= 2;
      const monthlyReviewCompleted = monthlyReviews[currentMonth]?.completed;

      // Generate monthly summary
      const generateMonthlySummary = () => {
        const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const monthEntries = Object.entries(journalEntries).filter(([date]) => {
          const entryDate = new Date(date);
          return entryDate >= firstDayOfMonth && entryDate <= today;
        });
        
        const journalDays = monthEntries.length;
        const completedTends = tendyHistory.filter(t => {
          const tendDate = new Date(t.date);
          return tendDate >= firstDayOfMonth && tendDate <= today && t.completed;
        }).length;
        
        const completedGoals = goals.filter(g => {
          if (!g.completed) return false;
          // Assume completed this month if marked complete (we don't track completion date yet)
          return true;
        }).length;

        return `Hi! It's the end of ${monthName}, and I've prepared a summary of your month:

ðŸ“Š **Your Month in Numbers:**
- You journaled ${journalDays} days this month
- You completed ${completedTends} daily tends
- You achieved ${completedGoals} goals

ðŸŒ± **Areas You Focused On:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const gap = importance - (vlqScores[key]?.consistency || 5);
  return gap >= 2;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No specific focus areas'}

Let's reflect on your month together. What stood out to you most? What are you proud of? What would you like to carry forward into next month?`;
      };

      const startMonthlyReview = () => {
        // Save any previous conversation before starting new one
        saveCurrentConversation();
        
        const summary = generateMonthlySummary();
        setMessages([{
          role: 'assistant',
          content: summary
        }]);
        setCurrentConversationType('monthly_review');
        setMonthlyReviews(prev => ({
          ...prev,
          [currentMonth]: { 
            completed: true, 
            completedAt: new Date().toISOString(),
            conversationId: `monthly_${currentMonth}_${Date.now()}`
          }
        }));
        // Award flex points
        setFlexPoints(flexPoints + 1.5);
        setFlexPointsTracking(prev => ({
          ...prev,
          lastMonthlyReviewMonth: currentMonth
        }));
        // Switch to main view (which shows chat)
        setAppMode(null);
      };

      // Check if it's time for yearly review (last 7 days of December)
      const currentYear = today.getFullYear().toString();
      const isDecember = today.getMonth() === 11;
      const daysUntilEndOfYear = 31 - today.getDate();
      const isYearlyReviewTime = isDecember && daysUntilEndOfYear <= 6;
      const yearlyReviewCompleted = yearlyReflections[currentYear]?.completed;

      // Generate yearly summary
      const generateYearlySummary = () => {
        const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
        const yearEntries = Object.entries(journalEntries).filter(([date]) => {
          const entryDate = new Date(date);
          return entryDate >= firstDayOfYear && entryDate <= today;
        });
        
        const journalDays = yearEntries.length;
        const completedTends = tendyHistory.filter(t => {
          const tendDate = new Date(t.date);
          return tendDate >= firstDayOfYear && tendDate <= today && t.completed;
        }).length;
        
        const completedGoals = goals.filter(g => g.completed).length;

        // Count completed monthly reviews
        const monthsReviewed = Object.keys(monthlyReviews).filter(m => 
          m.startsWith(currentYear) && monthlyReviews[m]?.completed
        ).length;

        return `Hi! As we approach the end of ${currentYear}, I've prepared a reflection on your year:

ðŸŽŠ **Your Year in Numbers:**
- You journaled ${journalDays} days this year
- You completed ${completedTends} daily tends
- You achieved ${completedGoals} goals
- You completed ${monthsReviewed} monthly reflections

ðŸŒ± **Your Growth Areas This Year:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const gap = importance - (vlqScores[key]?.consistency || 5);
  return gap >= 2;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No specific focus areas'}

ðŸ’ª **Your Strengths:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const consistency = vlqScores[key]?.consistency || 5;
  const gap = importance - consistency;
  return importance >= 5 && gap < 3;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No identified strengths'}

This has been your year of growth and intention. What are you most proud of? What did you learn about yourself? As we move into ${parseInt(currentYear) + 1}, what do you want to carry forward, and what do you want to leave behind?`;
      };

      const startYearlyReview = () => {
        // Save any previous conversation before starting new one
        saveCurrentConversation();
        
        const summary = generateYearlySummary();
        setMessages([{
          role: 'assistant',
          content: summary
        }]);
        setCurrentConversationType('yearly_review');
        setYearlyReflections(prev => ({
          ...prev,
          [currentYear]: { 
            completed: true, 
            completedAt: new Date().toISOString(),
            conversationId: `yearly_${currentYear}_${Date.now()}`
          }
        }));
        // Award flex points (2 for yearly)
        setFlexPoints(flexPoints + 2);
        // Switch to main view (which shows chat)
        setAppMode(null);
      };

      const journalStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
        },
        header: {
          padding: '1rem 2rem',
          borderBottom: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        },
        headerLeft: {
          display: 'flex',
          alignItems: 'center',
          gap: '1rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.25rem',
          color: 'var(--text-muted)',
          cursor: 'pointer',
          padding: '0.25rem',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.25rem',
          color: 'var(--text)',
        },
        flexPointsBadge: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          padding: '0.375rem 0.75rem',
          backgroundColor: 'var(--accent-light)',
          border: '1px solid var(--accent)',
          borderRadius: '8px',
          fontSize: '0.8rem',
          color: 'var(--text)',
        },
        switchButton: {
          padding: '0.5rem 1rem',
          backgroundColor: 'var(--bg-elevated)',
          border: '1px solid var(--border)',
          borderRadius: '8px',
          color: 'var(--text-muted)',
          fontSize: '0.8rem',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        content: {
          flex: 1,
          padding: '2rem',
          maxWidth: '600px',
          margin: '0 auto',
          width: '100%',
        },
        reviewPrompt: {
          padding: '1.5rem',
          backgroundColor: 'var(--accent-light)',
          border: '2px solid var(--accent)',
          borderRadius: '12px',
          marginBottom: '2rem',
        },
        reviewPromptTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        reviewPromptText: {
          fontSize: '0.85rem',
          color: 'var(--text-muted)',
          marginBottom: '1rem',
        },
        reviewButton: {
          padding: '0.75rem 1.25rem',
          backgroundColor: 'var(--accent)',
          color: 'white',
          border: 'none',
          borderRadius: '8px',
          fontSize: '0.9rem',
          fontWeight: 500,
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
      };

      return (
        <div style={journalStyles.container}>
          <div style={journalStyles.header}>
            <div style={journalStyles.headerLeft}>
              <button style={journalStyles.backButton} onClick={onBack} title="Back">
                â†
              </button>
              <h2 style={journalStyles.title}>Daily Journal</h2>
            </div>
            <div style={{display: 'flex', gap: '0.75rem', alignItems: 'center'}}>
              <div style={journalStyles.flexPointsBadge}>
                <span>ðŸª´</span>
                <span>{flexPoints} flex</span>
              </div>
              <button style={journalStyles.switchButton} onClick={() => setAppMode('tendy')}>
                ðŸŒ± Daily Tend
              </button>
              <button style={journalStyles.switchButton} onClick={onSwitchMode}>
                ðŸ“ Plan
              </button>
            </div>
          </div>

          <div style={journalStyles.content}>
            {/* Monthly Review Prompt */}
            {isMonthlyReviewTime && !monthlyReviewCompleted && (
              <div style={journalStyles.reviewPrompt}>
                <h3 style={journalStyles.reviewPromptTitle}>
                  <span>ðŸŒ™</span>
                  <span>Monthly Reflection Available</span>
                </h3>
                <p style={journalStyles.reviewPromptText}>
                  It's the end of the month! Let's reflect on your journey together. I've prepared a summary of your month and we can chat about what you learned, what you're proud of, and what you want to focus on next month.
                </p>
                <p style={{...journalStyles.reviewPromptText, fontSize: '0.75rem', fontStyle: 'italic'}}>
                  Earn +1.5 flex points for completing your monthly reflection
                </p>
                <button style={journalStyles.reviewButton} onClick={startMonthlyReview}>
                  <span>âœ¨</span>
                  <span>Start Monthly Reflection</span>
                </button>
              </div>
            )}

            {/* Yearly Review Prompt */}
            {isYearlyReviewTime && !yearlyReviewCompleted && (
              <div style={journalStyles.reviewPrompt}>
                <h3 style={journalStyles.reviewPromptTitle}>
                  <span>ðŸŽŠ</span>
                  <span>Year in Review Available</span>
                </h3>
                <p style={journalStyles.reviewPromptText}>
                  As {currentYear} comes to a close, let's reflect on your entire year together. I've prepared a comprehensive summary of your growth, achievements, and journey. This is a special moment to honor how far you've come.
                </p>
                <p style={{...journalStyles.reviewPromptText, fontSize: '0.75rem', fontStyle: 'italic'}}>
                  Earn +2 flex points for completing your yearly reflection
                </p>
                <button style={journalStyles.reviewButton} onClick={startYearlyReview}>
                  <span>ðŸŒŸ</span>
                  <span>Start Year in Review</span>
                </button>
              </div>
            )}

            <DailyJournalTab 
              yearTheme={yearTheme}
              vlqScores={vlqScores}
              journalEntries={journalEntries}
              setJournalEntries={setJournalEntries}
              todaysTendies={todaysTendies}
              tendyHistory={tendyHistory}
            />
          </div>
        </div>
      );
    }
    // ============ DAILY JOURNAL TAB ============
    function DailyJournalTab({ yearTheme, vlqScores, journalEntries, setJournalEntries, todaysTendies, tendyHistory }) {
      const today = new Date();
      const dateKey = today.toISOString().split('T')[0];
      const dateString = today.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'long', 
        day: 'numeric' 
      });

      // Load today's entry or create empty
      const todayEntry = journalEntries[dateKey] || { 
        gratitude: '', 
        reflection: '',
        tendyCompleted: null,
        tendyFeeling: '',
        tendyObstacle: ''
      };

      // Update today's entry
      const updateEntry = (field, value) => {
        setJournalEntries(prev => ({
          ...prev,
          [dateKey]: {
            ...prev[dateKey],
            [field]: value
          }
        }));
      };

      // Get today's selected or completed tendy
      const selectedTendy = todaysTendies.find(t => t.selected || t.completed);
      const tendyCompleted = tendyHistory.find(t => t.date === dateKey && t.completed);

      const tabStyles = {
        date: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '2rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.75rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '100px',
        },
        radioGroup: {
          display: 'flex',
          gap: '1rem',
          marginBottom: '1rem',
        },
        radioOption: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
          cursor: 'pointer',
        },
        tendyCard: {
          padding: '1rem',
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '10px',
          marginBottom: '1rem',
        },
      };

      return (
        <div>
          <div style={tabStyles.date}>{dateString}</div>

          {/* Tendy Reflection */}
          {selectedTendy && (
            <div style={tabStyles.section}>
              <h3 style={tabStyles.sectionTitle}>Daily Tend Reflection</h3>
              <div style={tabStyles.tendyCard}>
                <div style={{fontSize: '0.9rem', marginBottom: '0.75rem', color: 'var(--text)'}}>
                  {selectedTendy.text}
                </div>
                <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>
                  {selectedTendy.domainIcon} {selectedTendy.domainName}
                </div>
              </div>

              <div style={{marginBottom: '1rem'}}>
                <div style={{...tabStyles.prompt, fontStyle: 'normal', marginBottom: '0.5rem'}}>
                  Did you complete it?
                </div>
                <div style={tabStyles.radioGroup}>
                  <label style={tabStyles.radioOption}>
                    <input 
                      type="radio" 
                      name="tendyCompleted"
                      checked={todayEntry.tendyCompleted === true}
                      onChange={() => updateEntry('tendyCompleted', true)}
                    />
                    <span>Yes</span>
                  </label>
                  <label style={tabStyles.radioOption}>
                    <input 
                      type="radio" 
                      name="tendyCompleted"
                      checked={todayEntry.tendyCompleted === false}
                      onChange={() => updateEntry('tendyCompleted', false)}
                    />
                    <span>No</span>
                  </label>
                </div>
              </div>

              {todayEntry.tendyCompleted === true && (
                <div>
                  <div style={tabStyles.prompt}>How did you feel afterwards?</div>
                  <textarea
                    style={tabStyles.textarea}
                    value={todayEntry.tendyFeeling || ''}
                    onChange={(e) => updateEntry('tendyFeeling', e.target.value)}
                    placeholder="What did you notice? How did it impact your day?"
                    rows={3}
                  />
                </div>
              )}

              {todayEntry.tendyCompleted === false && (
                <div>
                  <div style={tabStyles.prompt}>What was the limiting belief or obstacle stopping you?</div>
                  <textarea
                    style={tabStyles.textarea}
                    value={todayEntry.tendyObstacle || ''}
                    onChange={(e) => updateEntry('tendyObstacle', e.target.value)}
                    placeholder="What got in the way? What belief or barrier prevented you from completing it?"
                    rows={3}
                  />
                </div>
              )}
            </div>
          )}

          {/* Gratitude */}
          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Gratitude</h3>
            <div style={tabStyles.prompt}>What are you grateful for today?</div>
            <textarea
              style={tabStyles.textarea}
              value={todayEntry.gratitude || ''}
              onChange={(e) => updateEntry('gratitude', e.target.value)}
              placeholder="List three things you're grateful for..."
              rows={4}
            />
          </div>

          {/* Free Reflection */}
          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Reflection</h3>
            <div style={tabStyles.prompt}>What's on your mind?</div>
            <textarea
              style={tabStyles.textarea}
              value={todayEntry.reflection || ''}
              onChange={(e) => updateEntry('reflection', e.target.value)}
              placeholder="What happened today? What do you want to remember?"
              rows={8}
            />
          </div>
        </div>
      );
    }
    // ============ MONTHLY REVIEW TAB ============
    function MonthlyReviewTab({ monthlyReviews, setMonthlyReviews, flexPoints, setFlexPoints, flexPointsTracking, setFlexPointsTracking }) {
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
      const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      // Load this month's review or create empty
      const thisMonthReview = monthlyReviews[currentMonth] || {
        wins: '',
        challenges: '',
        lessons: '',
        nextMonth: ''
      };

      // Update this month's review
      const updateReview = (field, value) => {
        const wasComplete = isReviewComplete(thisMonthReview);
        
        const updatedReview = {
          ...thisMonthReview,
          [field]: value
        };
        
        setMonthlyReviews(prev => ({
          ...prev,
          [currentMonth]: updatedReview
        }));

        // Award flex points if review just became complete
        const isNowComplete = isReviewComplete(updatedReview);
        if (!wasComplete && isNowComplete && flexPointsTracking.lastMonthlyReviewMonth !== currentMonth) {
          setFlexPoints(flexPoints + 1.5);
          setFlexPointsTracking(prev => ({
            ...prev,
            lastMonthlyReviewMonth: currentMonth
          }));
        }
      };

      // Check if review is complete (all fields filled)
      const isReviewComplete = (review) => {
        return review.wins?.trim() && review.challenges?.trim() && 
               review.lessons?.trim() && review.nextMonth?.trim();
      };

      const completed = isReviewComplete(thisMonthReview);
      const alreadyAwarded = flexPointsTracking.lastMonthlyReviewMonth === currentMonth;

      const tabStyles = {
        monthName: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '2rem',
        },
        completionBadge: {
          display: 'inline-flex',
          alignItems: 'center',
          gap: '0.5rem',
          padding: '0.5rem 1rem',
          backgroundColor: 'var(--accent-light)',
          border: '1px solid var(--accent)',
          borderRadius: '8px',
          fontSize: '0.85rem',
          color: 'var(--text)',
          marginBottom: '2rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '100px',
        },
      };

      return (
        <div>
          <h2 style={tabStyles.monthName}>{monthName} Review</h2>
          <div style={tabStyles.subtitle}>
            Reflect on this month and earn 1.5 flex points for completing your review
          </div>

          {completed && alreadyAwarded && (
            <div style={tabStyles.completionBadge}>
              <span>âœ¨</span>
              <span>Review complete! +1.5 flex points earned</span>
            </div>
          )}

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Wins & Highlights</h3>
            <div style={tabStyles.prompt}>What were your biggest wins this month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.wins || ''}
              onChange={(e) => updateReview('wins', e.target.value)}
              placeholder="What went well? What are you proud of?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Challenges</h3>
            <div style={tabStyles.prompt}>What challenges did you face?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.challenges || ''}
              onChange={(e) => updateReview('challenges', e.target.value)}
              placeholder="What was difficult? What obstacles came up?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Lessons Learned</h3>
            <div style={tabStyles.prompt}>What did you learn about yourself this month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.lessons || ''}
              onChange={(e) => updateReview('lessons', e.target.value)}
              placeholder="What insights or realizations did you have?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Looking Ahead</h3>
            <div style={tabStyles.prompt}>What do you want to focus on next month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.nextMonth || ''}
              onChange={(e) => updateReview('nextMonth', e.target.value)}
              placeholder="What intentions or goals do you have for next month?"
              rows={5}
            />
          </div>
        </div>
      );
    }
    // ============ YEARLY REFLECTION TAB ============
    function YearlyReflectionTab({ yearlyReflections, setYearlyReflections }) {
      const today = new Date();
      const currentYear = today.getFullYear().toString();

      // Load this year's reflection or create empty
      const thisYearReflection = yearlyReflections[currentYear] || {
        definingMoments: '',
        growth: '',
        gratitude: '',
        intentions: ''
      };

      // Update this year's reflection
      const updateReflection = (field, value) => {
        setYearlyReflections(prev => ({
          ...prev,
          [currentYear]: {
            ...prev[currentYear],
            [field]: value
          }
        }));
      };

      const tabStyles = {
        yearName: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '2rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '120px',
        },
      };

      return (
        <div>
          <h2 style={tabStyles.yearName}>{currentYear} Reflection</h2>
          <div style={tabStyles.subtitle}>
            Take time to reflect on the year that was and set intentions for the year ahead
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Defining Moments</h3>
            <div style={tabStyles.prompt}>What were the defining moments of this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.definingMoments || ''}
              onChange={(e) => updateReflection('definingMoments', e.target.value)}
              placeholder="What experiences, decisions, or events shaped your year?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Growth & Change</h3>
            <div style={tabStyles.prompt}>How have you grown this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.growth || ''}
              onChange={(e) => updateReflection('growth', e.target.value)}
              placeholder="What have you learned? How have you changed?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Gratitude</h3>
            <div style={tabStyles.prompt}>What are you grateful for from this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.gratitude || ''}
              onChange={(e) => updateReflection('gratitude', e.target.value)}
              placeholder="Who and what are you thankful for?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Intentions for Next Year</h3>
            <div style={tabStyles.prompt}>What intentions do you have for the year ahead?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.intentions || ''}
              onChange={(e) => updateReflection('intentions', e.target.value)}
              placeholder="What do you want to focus on? What kind of year do you want to create?"
              rows={6}
            />
          </div>
        </div>
      );
    }

    // ============ YEAR CIRCLE VIEW ============
    function YearCircleView({ events, revealed, onAddEvent, yearTheme, setYearTheme }) {
      const size = 400;
      const center = size / 2;
      const outerRadius = 175;
      const innerRadius = 75;
      const monthRadius = 145;
      const currentMonth = new Date().getMonth();

      const getMonthPosition = (monthIndex) => {
        const angle = ((monthIndex - 2) / 12) * 2 * Math.PI - Math.PI / 2;
        return { x: center + Math.cos(angle) * monthRadius, y: center + Math.sin(angle) * monthRadius };
      };

      const getEventPosition = (monthIndex, eventIndex = 0) => {
        const angle = ((monthIndex - 2) / 12) * 2 * Math.PI - Math.PI / 2;
        const radius = innerRadius + 18 + (eventIndex * 12);
        return { x: center + Math.cos(angle) * radius, y: center + Math.sin(angle) * radius };
      };

      const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return { x: centerX + radius * Math.cos(angleInRadians), y: centerY + radius * Math.sin(angleInRadians) };
      };

      const describeArc = (startAngle, endAngle, radius) => {
        const start = polarToCartesian(center, center, radius, endAngle);
        const end = polarToCartesian(center, center, radius, startAngle);
        const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
        return `M ${start.x} ${start.y} A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y} L ${center} ${center} Z`;
      };

      const seasonArcs = [
        { id: 'winter', start: -60, end: 30, color: '#7EB3E0' },
        { id: 'spring', start: 30, end: 120, color: '#8FD4A0' },
        { id: 'summer', start: 120, end: 210, color: '#F9D07A' },
        { id: 'fall', start: 210, end: 300, color: '#E8A090' },
      ];

      return (
        <div style={styles.circleContainer}>
          <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
            {seasonArcs.map(season => (
              <path key={season.id} d={describeArc(season.start, season.end, outerRadius)} fill={season.color} opacity={0.35} />
            ))}

            <circle cx={center} cy={center} r={innerRadius} fill="var(--bg-card)" stroke="var(--border)" strokeWidth="1" />

            <text x={center} y={center - 12} textAnchor="middle" dominantBaseline="middle" fill="var(--text)"
              style={{ fontFamily: "'Fraunces', serif", fontSize: '1.75rem' }}>
              2026
            </text>

            {/* Theme word - only show if set */}
            {yearTheme && (
              <text x={center} y={center + 18} textAnchor="middle" dominantBaseline="middle" 
                fill="var(--accent)"
                style={{ fontFamily: "'Fraunces', serif", fontSize: '0.95rem', fontStyle: 'italic', cursor: 'pointer' }}
                onClick={() => {
                  const newTheme = prompt('Edit your theme word:', yearTheme);
                  if (newTheme !== null) setYearTheme(newTheme.toLowerCase());
                }}>
                {yearTheme}
              </text>
            )}

            {MONTHS.map((month, idx) => {
              const pos = getMonthPosition(idx);
              const isCurrent = idx === currentMonth;
              return (
                <g key={month}>
                  <text x={pos.x} y={pos.y} textAnchor="middle" dominantBaseline="middle"
                    fill={isCurrent ? 'var(--text)' : 'var(--text-light)'}
                    style={{ fontFamily: "'DM Sans', sans-serif", fontSize: '0.7rem', fontWeight: isCurrent ? 600 : 400 }}>
                    {month}
                  </text>
                  {isCurrent && <circle cx={pos.x} cy={pos.y + 10} r="2" fill="var(--accent)" />}
                </g>
              );
            })}

            {events.map((event) => {
              const monthEvents = events.filter(e => e.month === event.month);
              const eventIndex = monthEvents.indexOf(event);
              const pos = getEventPosition(event.month, eventIndex);
              const color = LIFE_AREAS[event.lifeArea]?.color || 'var(--accent)';
              return (
                <g key={event.id} className="fade-in">
                  <circle cx={pos.x} cy={pos.y} r="6" fill={color} />
                  <circle cx={pos.x} cy={pos.y} r="2.5" fill="white" opacity="0.5" />
                </g>
              );
            })}
          </svg>
        </div>
      );
    }

    // ============ SEASONS VIEW ============
    function SeasonsView({ seasonIntentions, setSeasonIntentions, revealed }) {
      const seasons = [
        { 
          id: 'winter', 
          name: 'Winter', 
          months: 'Dec â€“ Feb', 
          color: '#7EB3E0', 
          lightColor: '#F5F9FC', 
          elements: ['â„', 'Â·', 'â„', 'Â·', 'â„'],
          description: 'A time for rest, reflection, and turning inward. Shorter days invite quiet planning, cozy routines, and nurturing what matters most.'
        },
        { 
          id: 'spring', 
          name: 'Spring', 
          months: 'Mar â€“ May', 
          color: '#8FD4A0', 
          lightColor: '#F5FBF6', 
          elements: ['âœ¿', 'Â·', 'â€', 'Â·', 'âœ¿'],
          description: 'A time for new beginnings and fresh energy. Nature awakens â€” a good season to plant seeds, start projects, and embrace growth.'
        },
        { 
          id: 'summer', 
          name: 'Summer', 
          months: 'Jun â€“ Aug', 
          color: '#F9D07A', 
          lightColor: '#FFFDF7', 
          elements: ['â˜€', '~', 'â˜€', '~', 'â˜€'],
          description: 'A time for expansion, adventure, and connection. Long days invite travel, outdoor activities, and making memories with others.'
        },
        { 
          id: 'fall', 
          name: 'Fall', 
          months: 'Sep â€“ Nov', 
          color: '#E8A090', 
          lightColor: '#FDF7F5', 
          elements: ['ðŸ‚', 'Â·', 'ðŸ', 'Â·', 'ðŸ‚'],
          description: 'A time for harvest and gratitude. Energy turns toward completion, gathering, and preparing for the quieter months ahead.'
        },
      ];

      const currentSeason = (() => {
        const month = new Date().getMonth();
        if ([11, 0, 1].includes(month)) return 'winter';
        if ([2, 3, 4].includes(month)) return 'spring';
        if ([5, 6, 7].includes(month)) return 'summer';
        return 'fall';
      })();

      return (
        <div style={styles.seasonsContainer}>
          <div style={styles.seasonsGrid}>
            {seasons.map(season => (
              <div 
                key={season.id} 
                style={{
                  ...styles.seasonCard,
                  backgroundColor: season.lightColor,
                  borderColor: season.id === currentSeason ? season.color : 'transparent',
                  borderWidth: '2px',
                }}
              >
                {/* Decorative top */}
                <div style={{...styles.seasonDecorative, color: season.color}}>
                  {season.elements.map((el, i) => (
                    <span key={i} style={{opacity: i % 2 === 0 ? 1 : 0.5}}>{el}</span>
                  ))}
                </div>

                <div style={styles.seasonCardContent}>
                  <div style={styles.seasonCardHeader}>
                    <h3 style={{...styles.seasonName, color: season.color}}>{season.name}</h3>
                    <span style={styles.seasonMonths}>{season.months}</span>
                    {season.id === currentSeason && (
                      <span style={{...styles.currentBadge, backgroundColor: `${season.color}90`}}>Now</span>
                    )}
                  </div>
                  
                  <p style={styles.seasonDescription}>{season.description}</p>
                  
                  <div style={styles.seasonIntentionBox}>
                    <label style={{...styles.seasonLabel, color: season.color}}>What do you envision for this season?</label>
                    <textarea
                      style={{
                        ...styles.seasonTextarea,
                        borderColor: revealed ? season.color : 'var(--border)',
                        opacity: revealed ? 1 : 0.6,
                      }}
                      value={seasonIntentions[season.id] || ''}
                      onChange={(e) => setSeasonIntentions({...seasonIntentions, [season.id]: e.target.value})}
                      placeholder={revealed ? 'Your intention for this season...' : 'Complete conversation to unlock'}
                      disabled={!revealed}
                      rows={2}
                    />
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ============ MONTHLY VIEW ============
    function MonthlyView({ events, selectedMonth, setSelectedMonth, revealed, onAddEvent }) {
      const year = 2026;
      const daysInMonth = new Date(year, selectedMonth + 1, 0).getDate();
      const firstDayOfMonth = new Date(year, selectedMonth, 1).getDay();
      const monthEvents = events.filter(e => e.month === selectedMonth);
      const currentMonth = new Date().getMonth();
      const today = new Date().getDate();

      const getSeasonColor = (monthIdx) => {
        if ([11, 0, 1].includes(monthIdx)) return '#7EB3E0';
        if ([2, 3, 4].includes(monthIdx)) return '#8FD4A0';
        if ([5, 6, 7].includes(monthIdx)) return '#F9D07A';
        return '#E8A090';
      };

      const seasonColor = getSeasonColor(selectedMonth);

      return (
        <div style={styles.monthlyContainer}>
          {/* Month selector strip */}
          <div style={styles.monthStrip}>
            {MONTHS.map((month, idx) => (
              <button
                key={idx}
                style={{
                  ...styles.monthStripButton,
                  backgroundColor: selectedMonth === idx ? `${getSeasonColor(idx)}40` : 'transparent',
                  color: selectedMonth === idx ? getSeasonColor(idx) : 'var(--text-muted)',
                  fontWeight: selectedMonth === idx ? 600 : 400,
                }}
                onClick={() => setSelectedMonth(idx)}
              >
                {month}
              </button>
            ))}
          </div>

          {/* Calendar */}
          <div style={{...styles.calendarWrapper, borderColor: seasonColor}}>
            <div style={{...styles.calendarHeader, backgroundColor: `${seasonColor}90`}}>
              <button style={styles.calendarNav} onClick={() => setSelectedMonth(selectedMonth === 0 ? 11 : selectedMonth - 1)}>â€¹</button>
              <h2 style={styles.calendarTitle}>{MONTH_FULL[selectedMonth]} 2026</h2>
              <button style={styles.calendarNav} onClick={() => setSelectedMonth(selectedMonth === 11 ? 0 : selectedMonth + 1)}>â€º</button>
            </div>

            <div style={styles.calendarBody}>
              <div style={styles.calendarGrid}>
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => (
                  <div key={i} style={styles.calendarDayHeader}>{day}</div>
                ))}
                {Array.from({ length: firstDayOfMonth }, (_, i) => (
                  <div key={`empty-${i}`} style={styles.calendarDayEmpty}></div>
                ))}
                {Array.from({ length: daysInMonth }, (_, i) => {
                  const day = i + 1;
                  const isToday = selectedMonth === currentMonth && day === today;
                  return (
                    <div key={day} style={{
                      ...styles.calendarDay, 
                      ...(isToday && {...styles.calendarDayToday, backgroundColor: `${seasonColor}70`})
                    }}>
                      {day}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Events for this month */}
          <div style={styles.monthEventsSection}>
            {monthEvents.length > 0 ? (
              <div style={styles.monthEventsList}>
                {monthEvents.map(event => (
                  <div key={event.id} style={styles.monthEventItem}>
                    <span style={{...styles.eventDot, backgroundColor: LIFE_AREAS[event.lifeArea]?.color}}></span>
                    <span>{event.title}</span>
                  </div>
                ))}
              </div>
            ) : (
              <p style={styles.noEventsText}>No events in {MONTH_FULL[selectedMonth]}</p>
            )}
            {revealed && <button style={{...styles.addEventSmall, borderColor: seasonColor, color: seasonColor}} onClick={onAddEvent}>+ Add Event</button>}
          </div>
        </div>
      );
    }

    // ============ TENDY VIEW (Daily Values Tasks) ============
    function TendyView({ 
      vlqScores, 
      todaysTendies, 
      setTodaysTendies, 
      tendyHistory, 
      setTendyHistory,
      tendyPoints,
      setTendyPoints,
      tendyStreak,
      setTendyStreak,
      flexPoints,
      setFlexPoints,
      weeklyCustomTendy,
      setWeeklyCustomTendy,
      apiKey,
      onBack 
    }) {
      const today = new Date().toISOString().split('T')[0];
      const [showCelebration, setShowCelebration] = useState(false);
      const [justCompletedPoints, setJustCompletedPoints] = useState(0);
      const [showCustomTendyForm, setShowCustomTendyForm] = useState(false);
      const [customTendyText, setCustomTendyText] = useState('');
      const [isSubmittingCustom, setIsSubmittingCustom] = useState(false);

      // Get the week identifier (e.g., "2026-W03")
      const getWeekIdentifier = () => {
        const date = new Date();
        const year = date.getFullYear();
        const oneJan = new Date(year, 0, 1);
        const dayOfYear = Math.floor((date - oneJan) / 86400000) + 1;
        const weekNum = Math.ceil((dayOfYear + oneJan.getDay()) / 7);
        return `${year}-W${weekNum.toString().padStart(2, '0')}`;
      };

      const currentWeek = getWeekIdentifier();
      const canCreateCustomThisWeek = !weeklyCustomTendy || weeklyCustomTendy.weekOf !== currentWeek;
      
      // Check completions this week (stored as array of completion dates)
      const completionsThisWeek = weeklyCustomTendy?.completions?.filter(c => 
        c.startsWith(currentWeek)
      ) || [];
      const customCompletionsRemaining = 2 - completionsThisWeek.length;
      const hasApprovedCustom = weeklyCustomTendy?.status === 'approved' && 
                                weeklyCustomTendy.weekOf === currentWeek &&
                                customCompletionsRemaining > 0;

      // Check if we need to generate new tendies for today
      useEffect(() => {
        const tendiesAreFromToday = todaysTendies.length > 0 && todaysTendies[0]?.date === today;
        
        // Check if all tendies are from the same domain (v2 requirement)
        const allSameDomain = todaysTendies.length > 0 && 
          todaysTendies.every(t => t.domain === todaysTendies[0]?.domain);
        
        // Regenerate if: not from today, OR from today but have different domains (old version)
        if (vlqScores && (!tendiesAreFromToday || (tendiesAreFromToday && !allSameDomain))) {
          const newTendies = generateDailyTendies(vlqScores, tendyHistory);
          setTodaysTendies(newTendies);
        }
      }, [today, vlqScores]);

      const selectedTendy = todaysTendies.find(t => t.selected);
      const completedToday = todaysTendies.find(t => t.completed);

      const selectTendy = (tendyId) => {
        setTodaysTendies(todaysTendies.map(t => ({
          ...t,
          selected: t.id === tendyId
        })));
        // Allow both daily and custom tendy to be selected
      };

      const rerollTendy = () => {
        if (flexPoints < 1 || !selectedTendy) return;
        
        // Deduct flex point
        setFlexPoints(flexPoints - 1);
        
        // Deselect current tendy so they can pick a different difficulty
        setTodaysTendies(todaysTendies.map(t => ({
          ...t,
          selected: false
        })));
      };

      const completeTendy = () => {
        // Check if custom tendy is selected
        if (weeklyCustomTendy?.selected) {
          const completionTimestamp = new Date().toISOString();
          const completedCustom = {
            id: `custom-${currentWeek}-${completionsThisWeek.length + 1}`,
            date: today,
            text: weeklyCustomTendy.text,
            points: 1,
            difficulty: 'custom',
            domainName: 'Custom',
            domainIcon: 'âœ¨',
            completed: true,
            completedAt: completionTimestamp,
            gardenElement: { icon: 'ðŸŒŸ', element: 'Star', description: 'Personal intention' }
          };

          // Add to history
          setTendyHistory([...tendyHistory, completedCustom]);

          // Update points
          setTendyPoints(tendyPoints + 1);

          // Update streak
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split('T')[0];
          const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
          
          if (completedYesterday || tendyStreak === 0) {
            setTendyStreak(tendyStreak + 1);
          }

          // Add completion to weeklyCustomTendy (track all completions this week)
          const existingCompletions = weeklyCustomTendy.completions || [];
          setWeeklyCustomTendy({
            ...weeklyCustomTendy, 
            completions: [...existingCompletions, completionTimestamp],
            selected: false
          });

          // Show celebration
          setJustCompletedPoints(1);
          setShowCelebration(true);
          setTimeout(() => setShowCelebration(false), 2500);
          return;
        }

        // Regular tendy completion
        if (!selectedTendy) return;
        
        const completedTendy = {
          ...selectedTendy,
          completed: true,
          completedAt: new Date().toISOString()
        };

        // Update today's tendies
        setTodaysTendies(todaysTendies.map(t => 
          t.id === selectedTendy.id ? completedTendy : t
        ));

        // Add to history
        setTendyHistory([...tendyHistory, {
          ...completedTendy,
          templateText: completedTendy.text
        }]);

        // Update points
        const newPoints = tendyPoints + selectedTendy.points;
        setTendyPoints(newPoints);

        // Update streak (check if completed yesterday)
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
        
        if (completedYesterday || tendyStreak === 0) {
          setTendyStreak(tendyStreak + 1);
        }

        // Show celebration
        setJustCompletedPoints(selectedTendy.points);
        setShowCelebration(true);
        setTimeout(() => setShowCelebration(false), 2500);
      };

      const submitCustomTendy = async () => {
        if (!customTendyText.trim() || !apiKey) return;
        
        setIsSubmittingCustom(true);
        
        try {
          // Call Claude API to review the custom tendy
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey,
              "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 200,
              messages: [{
                role: "user",
                content: `I'm building an intentional living app where users can create one custom "Tendy" per week - a small action aligned with their values. Please review this custom Tendy and respond with ONLY "APPROVED" or "REJECTED" followed by a brief reason.

Approve if it's:
- A specific, actionable task
- Reasonable to complete in a day
- Values-aligned and intentional
- Not harmful or inappropriate

Reject if it's:
- Too vague or unmeasurable
- Impossible to complete
- Inappropriate or harmful
- Just a to-do item with no values connection

Custom Tendy: "${customTendyText}"

Response format: "APPROVED: [reason]" or "REJECTED: [reason]"`
              }]
            })
          });

          if (!response.ok) {
            throw new Error('API request failed');
          }

          const data = await response.json();
          const aiResponse = data.content[0].text;
          
          const isApproved = aiResponse.toUpperCase().startsWith('APPROVED');
          
          setWeeklyCustomTendy({
            text: customTendyText,
            status: isApproved ? 'approved' : 'rejected',
            weekOf: currentWeek,
            submittedAt: new Date().toISOString(),
            aiResponse: aiResponse
          });

          setCustomTendyText('');
          setShowCustomTendyForm(false);
          
        } catch (error) {
          console.error('Error submitting custom tendy:', error);
          alert('Error submitting custom tendy. Please check your API key in settings.');
        } finally {
          setIsSubmittingCustom(false);
        }
      };

      const getDifficultyLabel = (difficulty) => {
        switch(difficulty) {
          case 1: return { text: 'Quick Win', color: '#8FD4A0' };
          case 2: return { text: 'Balanced', color: '#F9D07A' };
          case 3: return { text: 'Deep Work', color: '#E8A090' };
          default: return { text: 'Task', color: '#7EB3E0' };
        }
      };

      const tendyStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          padding: '1.5rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        header: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '2rem',
          maxWidth: '500px',
          margin: '0 auto 2rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          color: 'var(--text-muted)',
          fontSize: '0.9rem',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.25rem',
        },
        stats: {
          display: 'flex',
          gap: '1rem',
          alignItems: 'center',
        },
        stat: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          fontSize: '0.85rem',
          color: 'var(--text-light)',
          backgroundColor: 'var(--bg-card)',
          padding: '0.5rem 0.75rem',
          borderRadius: '20px',
          border: '1px solid var(--border)',
        },
        content: {
          maxWidth: '500px',
          margin: '0 auto',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.75rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
          textAlign: 'center',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.9rem',
          textAlign: 'center',
          marginBottom: '2rem',
          lineHeight: 1.5,
        },
        tendyCard: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          padding: '1.25rem',
          marginBottom: '1rem',
          border: '2px solid var(--border)',
          cursor: 'pointer',
          transition: 'all 0.2s',
        },
        tendyCardSelected: {
          borderColor: 'var(--accent)',
          backgroundColor: 'var(--accent-light)',
        },
        tendyHeader: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'flex-start',
          marginBottom: '0.75rem',
        },
        tendyDomain: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
        },
        difficultyBadge: {
          fontSize: '0.7rem',
          padding: '0.25rem 0.625rem',
          borderRadius: '12px',
          fontWeight: 500,
        },
        tendyText: {
          fontSize: '1rem',
          color: 'var(--text)',
          lineHeight: 1.5,
          marginBottom: '0.75rem',
        },
        tendyFooter: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
        },
        gardenReward: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
        },
        selectButton: {
          width: '100%',
          padding: '1rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          marginTop: '1rem',
        },
        selectButtonDisabled: {
          backgroundColor: 'var(--border-dark)',
          cursor: 'not-allowed',
        },
        completeSection: {
          textAlign: 'center',
          padding: '2rem',
        },
        selectedCard: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '20px',
          padding: '2rem',
          marginBottom: '1.5rem',
          border: '1px solid var(--border)',
          textAlign: 'left',
        },
        completeButton: {
          padding: '1rem 2rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
        },
        celebrationOverlay: {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(125, 155, 118, 0.95)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          animation: 'fadeIn 0.3s ease-out',
        },
        celebrationIcon: {
          fontSize: '4rem',
          marginBottom: '1rem',
        },
        celebrationText: {
          color: 'white',
          fontSize: '1.5rem',
          fontFamily: "'Fraunces', serif",
          marginBottom: '0.5rem',
        },
        celebrationPoints: {
          color: 'rgba(255,255,255,0.9)',
          fontSize: '1.1rem',
        },
        completedState: {
          textAlign: 'center',
          padding: '3rem 2rem',
        },
        completedIcon: {
          fontSize: '3rem',
          marginBottom: '1rem',
        },
        completedTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        completedSubtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.95rem',
          marginBottom: '2rem',
        },
        gardenPreview: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '0.5rem',
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
          marginBottom: '1rem',
        },
      };

      // Already completed today
      if (completedToday) {
        return (
          <div style={tendyStyles.container}>
            <div style={tendyStyles.header}>
              <button style={tendyStyles.backButton} onClick={onBack}>
                â† Back
              </button>
              <div style={tendyStyles.stats}>
                <div style={tendyStyles.stat}>
                  <span>ðŸŒ±</span> {tendyPoints} pts
                </div>
              </div>
            </div>
            <div style={tendyStyles.content}>
              <div style={tendyStyles.completedState}>
                <div style={tendyStyles.completedIcon}>âœ¨</div>
                <h2 style={tendyStyles.completedTitle}>Daily Tend Complete!</h2>
                <p style={tendyStyles.completedSubtitle}>
                  You earned {completedToday.points} point{completedToday.points !== 1 ? 's' : ''} for your garden
                </p>
                <div style={tendyStyles.gardenPreview}>
                  <span style={{fontSize: '1.5rem'}}>{completedToday.gardenElement?.icon}</span>
                  <span style={{color: 'var(--text-light)'}}>
                    +1 {completedToday.gardenElement?.element} growing in your garden
                  </span>
                </div>
                <p style={{color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic'}}>
                  Come back tomorrow for your next Daily Tend
                </p>
              </div>
            </div>
          </div>
        );
      }

      // Already selected - show completion view
      if (selectedTendy || weeklyCustomTendy?.selected) {
        const hasBothSelected = selectedTendy && weeklyCustomTendy?.selected;
        
        return (
          <div style={tendyStyles.container}>
            {showCelebration && (
              <div style={tendyStyles.celebrationOverlay}>
                <div style={tendyStyles.celebrationIcon}>âœ¨</div>
                <div style={tendyStyles.celebrationText}>Daily Tend Complete!</div>
                <div style={tendyStyles.celebrationPoints}>+{justCompletedPoints} point{justCompletedPoints !== 1 ? 's' : ''}</div>
              </div>
            )}
            <div style={tendyStyles.header}>
              <button style={tendyStyles.backButton} onClick={onBack}>
                â† Back
              </button>
              <div style={tendyStyles.stats}>
                <div style={tendyStyles.stat}>
                  <span>ðŸª´</span> {flexPoints} flex
                </div>
                <div style={tendyStyles.stat}>
                  <span>ðŸŒ±</span> {tendyPoints} pts
                </div>
              </div>
            </div>
            <div style={tendyStyles.content}>
              <h1 style={tendyStyles.title}>{hasBothSelected ? 'Today\'s Tendies' : 'Today\'s Tendy'}</h1>
              <p style={tendyStyles.subtitle}>
                {hasBothSelected 
                  ? 'Complete these actions to tend to your values'
                  : 'Complete this small action to tend to your values'
                }
              </p>
              
              {/* Show regular tendy if selected */}
              {selectedTendy && (
                <div style={{marginBottom: hasBothSelected ? '1.5rem' : '0'}}>
                  <div style={tendyStyles.selectedCard}>
                    <div style={tendyStyles.tendyHeader}>
                      <div style={tendyStyles.tendyDomain}>
                        <span>{selectedTendy.domainIcon}</span>
                        <span>{selectedTendy.domainName}</span>
                      </div>
                      <span style={{
                        ...tendyStyles.difficultyBadge,
                        backgroundColor: getDifficultyLabel(selectedTendy.difficulty).color + '20',
                        color: getDifficultyLabel(selectedTendy.difficulty).color,
                      }}>
                        {getDifficultyLabel(selectedTendy.difficulty).text}
                      </span>
                    </div>
                    <p style={{...tendyStyles.tendyText, fontSize: '1.1rem'}}>
                      {selectedTendy.text}
                    </p>
                    <div style={tendyStyles.tendyFooter}>
                      <span>â± {selectedTendy.duration}</span>
                      <div style={tendyStyles.gardenReward}>
                        <span>{selectedTendy.gardenElement?.icon}</span>
                        <span>+{selectedTendy.points} pt{selectedTendy.points !== 1 ? 's' : ''}</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Reroll button */}
                  {flexPoints > 0 && !selectedTendy.completed && (
                    <button 
                      onClick={rerollTendy}
                      style={{
                        width: '100%',
                        padding: '0.75rem',
                        backgroundColor: 'transparent',
                        border: '1px solid var(--border-dark)',
                        borderRadius: '10px',
                        color: 'var(--text-muted)',
                        fontSize: '0.85rem',
                        cursor: 'pointer',
                        marginBottom: '0.75rem',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '0.5rem',
                      }}
                    >
                      <span>ðŸª´</span>
                      <span>Don't like this? Spend 1 flex point to try a different difficulty</span>
                    </button>
                  )}
                  
                  <button style={tendyStyles.completeButton} onClick={() => {
                    // Complete regular tendy
                    const completedTendy = {
                      ...selectedTendy,
                      completed: true,
                      completedAt: new Date().toISOString()
                    };
                    setTodaysTendies(todaysTendies.map(t => 
                      t.id === selectedTendy.id ? completedTendy : t
                    ));
                    setTendyHistory([...tendyHistory, {
                      ...completedTendy,
                      templateText: completedTendy.text
                    }]);
                    setTendyPoints(tendyPoints + selectedTendy.points);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
                    if (completedYesterday || tendyStreak === 0) {
                      setTendyStreak(tendyStreak + 1);
                    }
                    setJustCompletedPoints(selectedTendy.points);
                    setShowCelebration(true);
                    setTimeout(() => setShowCelebration(false), 2500);
                  }}>
                    âœ“ Mark Complete
                  </button>
                </div>
              )}

              {/* Show custom tendy if selected */}
              {weeklyCustomTendy?.selected && (
                <div>
                  <div style={tendyStyles.selectedCard}>
                    <div style={tendyStyles.tendyHeader}>
                      <div style={tendyStyles.tendyDomain}>
                        <span>âœ¨</span>
                        <span>Your Custom Tend</span>
                      </div>
                      <span style={{
                        ...tendyStyles.difficultyBadge,
                        backgroundColor: '#B8A9C920',
                        color: '#B8A9C9',
                      }}>
                        Personal
                      </span>
                    </div>
                    <p style={{...tendyStyles.tendyText, fontSize: '1.1rem'}}>
                      {weeklyCustomTendy.text}
                    </p>
                    <div style={tendyStyles.tendyFooter}>
                      <span>â± Self-paced</span>
                      <div style={tendyStyles.gardenReward}>
                        <span>ðŸŒŸ</span>
                        <span>+1 pt â€¢ {customCompletionsRemaining}/2 left</span>
                      </div>
                    </div>
                  </div>
                  <button style={tendyStyles.completeButton} onClick={() => {
                    // Complete custom tendy
                    const completionTimestamp = new Date().toISOString();
                    const completedCustom = {
                      id: `custom-${currentWeek}-${completionsThisWeek.length + 1}`,
                      date: today,
                      text: weeklyCustomTendy.text,
                      points: 1,
                      difficulty: 'custom',
                      domainName: 'Custom',
                      domainIcon: 'âœ¨',
                      completed: true,
                      completedAt: completionTimestamp,
                      gardenElement: { icon: 'ðŸŒŸ', element: 'Star', description: 'Personal intention' }
                    };
                    setTendyHistory([...tendyHistory, completedCustom]);
                    setTendyPoints(tendyPoints + 1);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
                    if (completedYesterday || tendyStreak === 0) {
                      setTendyStreak(tendyStreak + 1);
                    }
                    const existingCompletions = weeklyCustomTendy.completions || [];
                    setWeeklyCustomTendy({
                      ...weeklyCustomTendy, 
                      completions: [...existingCompletions, completionTimestamp],
                      selected: false
                    });
                    setJustCompletedPoints(1);
                    setShowCelebration(true);
                    setTimeout(() => setShowCelebration(false), 2500);
                  }}>
                    âœ“ Mark Complete
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Selection view - show all 3 tendies
      return (
        <div style={tendyStyles.container}>
          <div style={tendyStyles.header}>
            <button style={tendyStyles.backButton} onClick={onBack}>
              â† Back
            </button>
            <div style={tendyStyles.stats}>
              <div style={tendyStyles.stat}>
                <span>ðŸŒ±</span> {tendyPoints} pts
              </div>
            </div>
          </div>
          
          <div style={tendyStyles.content}>
            <h1 style={tendyStyles.title}>Choose Your Daily Tend</h1>
            <p style={tendyStyles.subtitle}>
              Pick a difficulty level to reveal your task for today.
            </p>

            {/* Today's Life Area */}
            {todaysTendies.length > 0 && (
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '0.5rem',
                padding: '1rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '12px',
                marginBottom: '1.5rem',
                fontSize: '1rem',
              }}>
                <span style={{fontSize: '1.5rem'}}>{todaysTendies[0].domainIcon}</span>
                <span style={{fontWeight: 500, color: 'var(--text)'}}>Today's Focus: {todaysTendies[0].domainName}</span>
              </div>
            )}

            {todaysTendies.map(tendy => {
              const diffLabel = getDifficultyLabel(tendy.difficulty);
              return (
                <div
                  key={tendy.id}
                  style={{
                    ...tendyStyles.tendyCard,
                    borderColor: tendy.selected ? 'var(--accent)' : 'var(--border)',
                    backgroundColor: tendy.selected ? 'var(--accent-light)' : 'var(--bg-card)',
                  }}
                  onClick={() => selectTendy(tendy.id)}
                >
                  <div style={{
                    ...tendyStyles.tendyHeader,
                    justifyContent: 'center',
                  }}>
                    <span style={{
                      ...tendyStyles.difficultyBadge,
                      backgroundColor: diffLabel.color + '20',
                      color: diffLabel.color,
                    }}>
                      {diffLabel.text}
                    </span>
                  </div>
                  {/* Mystery box - no content shown until selected */}
                  <div style={{
                    padding: '2rem 1rem',
                    textAlign: 'center',
                    color: 'var(--text-muted)',
                    fontSize: '0.85rem',
                  }}>
                    <div style={{fontSize: '2rem', marginBottom: '0.5rem'}}>?</div>
                    <div>Select to reveal your daily tend</div>
                  </div>
                  <div style={tendyStyles.tendyFooter}>
                    <span style={{opacity: 0}}>placeholder</span>
                    <div style={tendyStyles.gardenReward}>
                      <span>{tendy.gardenElement?.icon}</span>
                      <span>+{tendy.points} pt{tendy.points !== 1 ? 's' : ''}</span>
                    </div>
                  </div>
                </div>
              );
            })}

            {/* Custom Tendy - if approved this week */}
            {hasApprovedCustom && (
              <div
                style={{
                  ...tendyStyles.tendyCard,
                  borderColor: weeklyCustomTendy.selected ? 'var(--accent)' : 'var(--border)',
                  backgroundColor: weeklyCustomTendy.selected ? 'var(--accent-light)' : 'var(--bg-card)',
                }}
                onClick={() => {
                  setWeeklyCustomTendy({...weeklyCustomTendy, selected: !weeklyCustomTendy.selected});
                  // Allow both daily and custom to be selected
                }}
              >
                <div style={tendyStyles.tendyHeader}>
                  <div style={tendyStyles.tendyDomain}>
                    <span>âœ¨</span>
                    <span>Your Custom Tend</span>
                  </div>
                  <span style={{
                    ...tendyStyles.difficultyBadge,
                    backgroundColor: '#B8A9C920',
                    color: '#B8A9C9',
                  }}>
                    Personal
                  </span>
                </div>
                <p style={tendyStyles.tendyText}>{weeklyCustomTendy.text}</p>
                <div style={tendyStyles.tendyFooter}>
                  <span>â± Self-paced</span>
                  <div style={tendyStyles.gardenReward}>
                    <span>ðŸŒŸ</span>
                    <span>+1 pt â€¢ {customCompletionsRemaining}/2 left</span>
                  </div>
                </div>
              </div>
            )}

            {/* Create Custom Tendy Form */}
            {canCreateCustomThisWeek && !showCustomTendyForm && (
              <button
                style={{
                  ...tendyStyles.tendyCard,
                  cursor: 'pointer',
                  borderStyle: 'dashed',
                  borderColor: 'var(--border-dark)',
                  textAlign: 'center',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  minHeight: '100px',
                  color: 'var(--text-muted)',
                }}
                onClick={() => setShowCustomTendyForm(true)}
              >
                <div style={{fontSize: '1.5rem', marginBottom: '0.5rem'}}>+</div>
                <div style={{fontWeight: 500}}>Create Your Own Custom Tend</div>
                <div style={{fontSize: '0.75rem', marginTop: '0.25rem'}}>Worth 1 point if completed</div>
              </button>
            )}

            {/* Custom Tendy Creation Form */}
            {showCustomTendyForm && (
              <div style={{
                ...tendyStyles.tendyCard,
                borderColor: 'var(--accent)',
              }}>
                <div style={{marginBottom: '0.75rem', fontWeight: 500, color: 'var(--text)'}}>
                  Create Your Custom Tend
                </div>
                <textarea
                  value={customTendyText}
                  onChange={(e) => setCustomTendyText(e.target.value)}
                  placeholder="Describe a specific action aligned with your values..."
                  style={{
                    width: '100%',
                    minHeight: '80px',
                    padding: '0.75rem',
                    backgroundColor: 'var(--bg-elevated)',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    fontSize: '0.9rem',
                    fontFamily: "'DM Sans', sans-serif",
                    color: 'var(--text)',
                    marginBottom: '0.75rem',
                    resize: 'vertical',
                  }}
                />
                <div style={{display: 'flex', gap: '0.5rem'}}>
                  <button
                    onClick={submitCustomTendy}
                    disabled={!customTendyText.trim() || isSubmittingCustom || !apiKey}
                    style={{
                      flex: 1,
                      padding: '0.625rem',
                      backgroundColor: isSubmittingCustom || !apiKey ? 'var(--border-dark)' : 'var(--accent)',
                      border: 'none',
                      borderRadius: '8px',
                      color: 'white',
                      fontSize: '0.85rem',
                      fontWeight: 500,
                      cursor: isSubmittingCustom || !apiKey ? 'not-allowed' : 'pointer',
                    }}
                  >
                    {isSubmittingCustom ? 'Submitting...' : 'Submit for Approval'}
                  </button>
                  <button
                    onClick={() => {
                      setShowCustomTendyForm(false);
                      setCustomTendyText('');
                    }}
                    style={{
                      padding: '0.625rem 1rem',
                      backgroundColor: 'transparent',
                      border: '1px solid var(--border)',
                      borderRadius: '8px',
                      color: 'var(--text-muted)',
                      fontSize: '0.85rem',
                      cursor: 'pointer',
                    }}
                  >
                    Cancel
                  </button>
                </div>
                {!apiKey && (
                  <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem', fontStyle: 'italic'}}>
                    Set your API key in settings to enable custom daily tends
                  </div>
                )}
              </div>
            )}

            {/* Rejected Custom Tendy Message */}
            {weeklyCustomTendy?.status === 'rejected' && weeklyCustomTendy.weekOf === currentWeek && (
              <div style={{
                padding: '1rem',
                backgroundColor: '#FFF5F5',
                border: '1px solid #FED7D7',
                borderRadius: '12px',
                fontSize: '0.85rem',
                color: '#C53030',
              }}>
                <div style={{fontWeight: 500, marginBottom: '0.25rem'}}>Custom Daily Tend Not Approved</div>
                <div style={{color: '#744210'}}>{weeklyCustomTendy.aiResponse}</div>
                <div style={{marginTop: '0.5rem', fontSize: '0.75rem', color: '#744210'}}>
                  You can try again with a different daily tend this week.
                </div>
              </div>
            )}

            <button
              style={{
                ...tendyStyles.selectButton,
                ...((todaysTendies.every(t => !t.selected) && !weeklyCustomTendy?.selected) ? tendyStyles.selectButtonDisabled : {}),
              }}
              onClick={() => {
                // Selections are already tracked
              }}
              disabled={todaysTendies.every(t => !t.selected) && !weeklyCustomTendy?.selected}
            >
              {(() => {
                const dailySelected = todaysTendies.some(t => t.selected);
                const customSelected = weeklyCustomTendy?.selected;
                if (dailySelected && customSelected) return 'Confirm Both Selections â†’';
                if (dailySelected || customSelected) return 'Confirm Selection â†’';
                return 'Select a Daily Tend above';
              })()}
            </button>
          </div>
        </div>
      );
    }

    // ============ WEEKLY VIEW ============
    function WeeklyView({ weeklyHabits, setWeeklyHabits, revealed }) {
      const [newHabit, setNewHabit] = useState('');
      const [newFrequency, setNewFrequency] = useState(3);

      const addHabit = () => {
        if (!newHabit.trim()) return;
        setWeeklyHabits([...weeklyHabits, {
          id: Date.now(),
          text: newHabit,
          frequency: newFrequency,
          color: ['#7EB3E0', '#8FD4A0', '#F9D07A', '#E8A090', '#B8A9C9'][weeklyHabits.length % 5]
        }]);
        setNewHabit('');
        setNewFrequency(3);
      };

      const daysOfWeek = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

      return (
        <div style={styles.weeklyContainer}>
          <div style={styles.weeklyHeader}>
            <h2 style={styles.weeklyTitle}>Weekly Rhythms</h2>
            <p style={styles.weeklySubtitle}>What do you want to do each week?</p>
          </div>

          {weeklyHabits.length > 0 ? (
            <div style={styles.weeklyHabitsList}>
              {weeklyHabits.map(habit => (
                <div key={habit.id} style={styles.weeklyHabitRow}>
                  <div style={styles.weeklyHabitInfo}>
                    <span style={{...styles.weeklyHabitDot, backgroundColor: habit.color}}></span>
                    <span style={styles.weeklyHabitText}>{habit.text}</span>
                    <span style={styles.weeklyHabitFreq}>{habit.frequency}x/week</span>
                    <button 
                      style={styles.weeklyHabitDelete}
                      onClick={() => setWeeklyHabits(weeklyHabits.filter(h => h.id !== habit.id))}
                    >Ã—</button>
                  </div>
                  <div style={styles.weeklyHabitDays}>
                    {daysOfWeek.map((day, i) => (
                      <div 
                        key={i} 
                        style={{
                          ...styles.weeklyDayCircle,
                          backgroundColor: i < habit.frequency ? `${habit.color}30` : 'transparent',
                          borderColor: i < habit.frequency ? habit.color : 'var(--border)',
                        }}
                      >
                        <span style={{ fontSize: '0.65rem', color: i < habit.frequency ? habit.color : 'var(--text-muted)' }}>{day}</span>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div style={styles.weeklyEmpty}>
              <p style={styles.weeklyEmptyText}>No weekly habits yet.</p>
              <p style={{...styles.weeklyEmptyText, fontStyle: 'normal', color: 'var(--text-light)'}}>What rhythm do you want to create?</p>
            </div>
          )}

          {revealed ? (
            <div style={styles.addHabitSection}>
              <input
                type="text"
                value={newHabit}
                onChange={(e) => setNewHabit(e.target.value)}
                placeholder="Exercise, read, date night..."
                style={styles.addHabitInput}
                onKeyDown={(e) => e.key === 'Enter' && addHabit()}
              />
              <select 
                value={newFrequency} 
                onChange={(e) => setNewFrequency(parseInt(e.target.value))}
                style={styles.addHabitSelect}
              >
                {[1,2,3,4,5,6,7].map(n => (
                  <option key={n} value={n}>{n}x/week</option>
                ))}
              </select>
              <button onClick={addHabit} style={styles.addHabitButton}>+ Add</button>
            </div>
          ) : (
            <p style={styles.lockedText}>Complete the conversation to add weekly habits</p>
          )}
        </div>
      );
    }

    // ============ DAILY VIEW ============
    function DailyView({ dailyHabits, setDailyHabits, revealed }) {
      const [newHabit, setNewHabit] = useState('');

      const addHabit = () => {
        if (!newHabit.trim()) return;
        setDailyHabits([...dailyHabits, {
          id: Date.now(),
          text: newHabit,
          color: ['#7EB3E0', '#8FD4A0', '#F9D07A', '#E8A090', '#B8A9C9'][dailyHabits.length % 5]
        }]);
        setNewHabit('');
      };

      return (
        <div style={styles.dailyContainer}>
          <div style={styles.dailyHeader}>
            <h2 style={styles.dailyTitle}>Daily Intentions</h2>
            <p style={styles.dailySubtitle}>Small things that add up to a life well-lived</p>
          </div>

          {dailyHabits.length > 0 ? (
            <div style={styles.dailyList}>
              {dailyHabits.map(habit => (
                <div key={habit.id} style={styles.dailyHabitCard}>
                  <div style={{...styles.dailyHabitAccent, backgroundColor: habit.color}}></div>
                  <div style={styles.dailyHabitContent}>
                    <span style={styles.dailyHabitText}>{habit.text}</span>
                    <span style={styles.dailyHabitLabel}>every day</span>
                  </div>
                  <button 
                    style={styles.dailyHabitDelete}
                    onClick={() => setDailyHabits(dailyHabits.filter(h => h.id !== habit.id))}
                  >Ã—</button>
                </div>
              ))}
            </div>
          ) : (
            <div style={styles.dailyEmpty}>
              <p style={styles.dailyEmptyText}>What small daily practices would change your life?</p>
              <p style={styles.dailyEmptyExamples}>
                <em>10k steps Â· Morning pages Â· 8 glasses of water Â· Gratitude Â· Phone-free meals</em>
              </p>
            </div>
          )}

          {revealed ? (
            <div style={styles.addDailySection}>
              <input
                type="text"
                value={newHabit}
                onChange={(e) => setNewHabit(e.target.value)}
                placeholder="Walk 10k steps, drink water, journal..."
                style={styles.addDailyInput}
                onKeyDown={(e) => e.key === 'Enter' && addHabit()}
              />
              <button onClick={addHabit} style={styles.addDailyButton}>+ Add Daily Habit</button>
            </div>
          ) : (
            <p style={styles.lockedText}>Complete the conversation to add daily habits</p>
          )}
        </div>
      );
    }

    // ============ EVENTS TAB ============
    function EventsTab({ events, expandedEvent, setExpandedEvent, onUpdateDetails, onDelete, onAdd, revealed }) {
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>Your events will appear here.</p></div>;
      }

      return (
        <div style={styles.eventsTab}>
          <button style={styles.addItemButton} onClick={onAdd}>+ Add Event</button>
          
          {events.length === 0 ? (
            <p style={styles.emptyText}>No events yet.</p>
          ) : (
            <div style={styles.eventsList}>
              {events.map(event => (
                <div key={event.id} style={styles.eventCard}>
                  <div style={styles.eventHeader} onClick={() => setExpandedEvent(expandedEvent === event.id ? null : event.id)}>
                    <div style={styles.eventHeaderLeft}>
                      <span style={{...styles.eventDot, backgroundColor: LIFE_AREAS[event.lifeArea]?.color}}></span>
                      <span style={styles.eventMonth}>{MONTHS[event.month]}</span>
                      <span style={styles.eventTitle}>{event.title}</span>
                    </div>
                    <span style={styles.expandIcon}>{expandedEvent === event.id ? 'âˆ’' : '+'}</span>
                  </div>
                  
                  {expandedEvent === event.id && (
                    <div style={styles.eventDetails} className="slide-in">
                      {['flights', 'stays', 'activities', 'notes'].map(field => (
                        <div key={field} style={styles.detailField}>
                          <label style={styles.detailLabel}>
                            {field === 'flights' ? 'âœˆ' : field === 'stays' ? 'ðŸ ' : field === 'activities' ? 'â­' : 'ðŸ“'} {field.charAt(0).toUpperCase() + field.slice(1)}
                          </label>
                          <textarea
                            style={styles.detailInput}
                            value={event.details?.[field] || ''}
                            onChange={(e) => onUpdateDetails(event.id, field, e.target.value)}
                            placeholder={`Add ${field}...`}
                            rows={2}
                          />
                        </div>
                      ))}
                      <button style={styles.deleteEventButton} onClick={() => onDelete(event.id)}>Delete</button>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
          
          <p style={styles.tipText}>ðŸ’¡ Ask AI to suggest activities</p>
        </div>
      );
    }

    function NotesTab({ notes, setNotes, revealed }) {
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>A scratchpad for planning ideas.</p></div>;
      }
      return (
        <div style={styles.notesTab}>
          <textarea style={styles.notesTextarea} value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Jot down future plans, trip ideas, things to remember..." />
        </div>
      );
    }

    function GoalsTab({ goals, setGoals, onAdd, revealed }) {
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>Your goals will live here.</p></div>;
      }

      return (
        <div style={styles.goalsTab}>
          <button style={styles.addItemButton} onClick={onAdd}>+ Add Goal</button>
          {goals.length === 0 ? (
            <p style={styles.emptyText}>No goals yet.</p>
          ) : (
            <div style={styles.goalsList}>
              {goals.map(goal => (
                <div key={goal.id} style={{...styles.goalCard, opacity: goal.completed ? 0.6 : 1}}>
                  <button
                    style={{...styles.goalCheck, backgroundColor: goal.completed ? 'var(--accent)' : 'transparent'}}
                    onClick={() => setGoals(goals.map(g => g.id === goal.id ? {...g, completed: !g.completed} : g))}
                  >{goal.completed && 'âœ“'}</button>
                  <span style={{...styles.goalText, textDecoration: goal.completed ? 'line-through' : 'none'}}>{goal.text}</span>
                  <button style={styles.goalDelete} onClick={() => setGoals(goals.filter(g => g.id !== goal.id))}>Ã—</button>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function LifeAreasTab({ vlqScores, setVlqScores, goals, setGoals, onReassess, onAddGoal, revealed }) {
      if (!revealed) {
        return <div style={{padding: '1rem'}}><p style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontStyle: 'italic'}}>Complete the assessment to see your life areas.</p></div>;
      }

      // Categorize life areas
      const focusAreas = []; // gap >= 2
      const strengths = []; // importance >= 5, gap < 3
      const lowImportance = []; // importance < 5, gap < 3

      VLQ_ORDER.forEach(areaKey => {
        const area = VLQ_DOMAINS[areaKey];
        const importance = vlqScores[areaKey]?.importance || 5;
        const consistency = vlqScores[areaKey]?.consistency || 5;
        const gap = importance - consistency;

        const areaData = {
          key: areaKey,
          ...area,
          importance,
          consistency,
          gap
        };

        if (gap >= 2) {
          focusAreas.push(areaData);
        } else if (importance >= 5 && gap < 3) {
          strengths.push(areaData);
        } else if (importance < 5 && gap < 3) {
          lowImportance.push(areaData);
        }
      });

      const renderAreaCard = (area) => (
        <div key={area.key} style={{
          padding: '0.5rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '8px',
          borderLeft: `3px solid ${area.color}`,
          fontSize: '0.75rem'
        }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '0.375rem',
            marginBottom: '0.25rem'
          }}>
            <span style={{fontSize: '0.9rem'}}>{area.icon}</span>
            <span style={{fontWeight: 500, color: 'var(--text)'}}>{area.name}</span>
          </div>
          <div style={{
            display: 'flex',
            gap: '0.75rem',
            fontSize: '0.7rem',
            color: 'var(--text-muted)'
          }}>
            <span>Importance: {area.importance}</span>
            <span>Consistency: {area.consistency}</span>
          </div>
        </div>
      );

      return (
        <div style={{padding: '0.75rem', display: 'flex', flexDirection: 'column', gap: '1rem', height: '100%', overflowY: 'auto'}}>
          
          {/* Focus Areas */}
          {focusAreas.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                ðŸŒ± Focus On
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.375rem'}}>
                {focusAreas.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Strengths */}
          {strengths.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                ðŸ’ª Strengths
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.375rem'}}>
                {strengths.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Low Importance */}
          {lowImportance.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                ðŸ“Š Low Importance
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.375rem'}}>
                {lowImportance.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Goals Section */}
          <div style={{marginTop: '0.5rem'}}>
            <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem'}}>
              <h3 style={{fontSize: '0.7rem', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--text-muted)'}}>
                ðŸŽ¯ Goals
              </h3>
              <button style={{
                padding: '0.25rem 0.5rem',
                backgroundColor: 'var(--bg-elevated)',
                border: '1px solid var(--border)',
                borderRadius: '6px',
                color: 'var(--text-muted)',
                fontSize: '0.7rem',
                cursor: 'pointer'
              }} onClick={onAddGoal}>+ Add</button>
            </div>
            {goals.length === 0 ? (
              <p style={{fontSize: '0.75rem', color: 'var(--text-muted)', fontStyle: 'italic'}}>
                No goals yet
              </p>
            ) : (
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.375rem'}}>
                {goals.map(goal => (
                  <div key={goal.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                    padding: '0.5rem 0.625rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    opacity: goal.completed ? 0.5 : 1
                  }}>
                    <input
                      type="checkbox"
                      checked={goal.completed}
                      onChange={() => setGoals(goals.map(g => g.id === goal.id ? {...g, completed: !g.completed} : g))}
                      style={{margin: 0, cursor: 'pointer', accentColor: 'var(--accent)'}}
                    />
                    <span style={{
                      fontSize: '0.8rem',
                      textDecoration: goal.completed ? 'line-through' : 'none',
                      flex: 1,
                      color: 'var(--text)'
                    }}>{goal.text}</span>
                    <button 
                      style={{background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.8rem'}}
                      onClick={() => setGoals(goals.filter(g => g.id !== goal.id))}
                    >Ã—</button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Reassess Button */}
          <button 
            style={{
              padding: '0.625rem',
              backgroundColor: 'transparent',
              border: '1px dashed var(--border)',
              borderRadius: '8px',
              color: 'var(--text-muted)',
              fontSize: '0.75rem',
              cursor: 'pointer',
              marginTop: 'auto'
            }}
            onClick={onReassess}
          >
            Reassess My Values
          </button>
        </div>
      );
    }

    function ChatMessage({ message }) {
      const isAssistant = message.role === 'assistant';
      return (
        <div style={{...styles.chatMessage, justifyContent: isAssistant ? 'flex-start' : 'flex-end'}} className="fade-in">
          {isAssistant && <div style={styles.chatAvatar}><span style={styles.chatAvatarText}>T</span></div>}
          <div style={{...styles.chatBubble, ...(isAssistant ? styles.chatBubbleAssistant : styles.chatBubbleUser)}}>
            <div dangerouslySetInnerHTML={{ __html: message.content.replace(/\n/g, '<br/>') }} />
          </div>
        </div>
      );
    }

    function TypingIndicator() {
      return (
        <div style={styles.chatMessage} className="fade-in">
          <div style={styles.chatAvatar}><span style={styles.chatAvatarText}>T</span></div>
          <div style={styles.typingBubble}>
            <span style={{...styles.typingDot, animationDelay: '0s'}}>â€¢</span>
            <span style={{...styles.typingDot, animationDelay: '0.15s'}}>â€¢</span>
            <span style={{...styles.typingDot, animationDelay: '0.3s'}}>â€¢</span>
          </div>
        </div>
      );
    }

    function EventModal({ onClose, onAdd }) {
      const [title, setTitle] = useState('');
      const [month, setMonth] = useState(new Date().getMonth());
      const [lifeArea, setLifeArea] = useState('fun');

      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={styles.modal} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Add an event</h3>
              <button style={styles.modalClose} onClick={onClose}>Ã—</button>
            </div>
            <form onSubmit={(e) => { e.preventDefault(); if (title) onAdd({ title, month, lifeArea }); }} style={styles.modalForm}>
              <div style={styles.formField}>
                <label style={styles.formLabel}>What is it?</label>
                <input type="text" style={styles.textInput} value={title} onChange={(e) => setTitle(e.target.value)} placeholder="Trip, birthday, deadline..." autoFocus />
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>When?</label>
                <select style={styles.selectInput} value={month} onChange={(e) => setMonth(parseInt(e.target.value))}>
                  {MONTHS.map((m, i) => <option key={i} value={i}>{m} 2026</option>)}
                </select>
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>Life Area</label>
                <select style={styles.selectInput} value={lifeArea} onChange={(e) => setLifeArea(e.target.value)}>
                  {Object.entries(LIFE_AREAS).map(([key, area]) => (
                    <option key={key} value={key}>{area.icon} {area.name}</option>
                  ))}
                </select>
              </div>
              <button type="submit" style={{...styles.submitButton, ...(!title ? styles.submitButtonDisabled : {})}} disabled={!title}>Add to year</button>
            </form>
          </div>
        </div>
      );
    }

    function GoalModal({ onClose, onAdd }) {
      const [text, setText] = useState('');
      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={styles.modal} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Add a goal</h3>
              <button style={styles.modalClose} onClick={onClose}>Ã—</button>
            </div>
            <form onSubmit={(e) => { e.preventDefault(); if (text) onAdd({ text }); }} style={styles.modalForm}>
              <div style={styles.formField}>
                <label style={styles.formLabel}>What do you want to achieve?</label>
                <input type="text" style={styles.textInput} value={text} onChange={(e) => setText(e.target.value)} placeholder="Run a 5K, read 12 books..." autoFocus />
              </div>
              <button type="submit" style={{...styles.submitButton, ...(!text ? styles.submitButtonDisabled : {})}} disabled={!text}>Add goal</button>
            </form>
          </div>
        </div>
      );
    }

    function SettingsModal({ apiKey, setApiKey, onClose, user, onLogout }) {
      const [key, setKey] = useState(apiKey);
      
      const handleSave = () => {
        setApiKey(key);
        onClose();
      };

      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={{...styles.modal, maxWidth: '420px'}} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Settings</h3>
              <button style={styles.modalClose} onClick={onClose}>Ã—</button>
            </div>
            <div style={styles.modalForm}>
              {/* Account Section */}
              <div style={{...styles.formField, marginBottom: '1.5rem', paddingBottom: '1.5rem', borderBottom: '1px solid var(--border)'}}>
                <label style={styles.formLabel}>Account</label>
                <p style={{fontSize: '0.9rem', color: 'var(--text)', marginBottom: '0.75rem'}}>
                  {user?.email}
                </p>
                <button 
                  onClick={() => { onLogout(); onClose(); }} 
                  style={{
                    padding: '0.5rem 1rem',
                    backgroundColor: 'transparent',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    color: 'var(--text-muted)',
                    fontSize: '0.8rem',
                    cursor: 'pointer',
                  }}
                >
                  Sign Out
                </button>
              </div>

              {/* API Key Section */}
              <div style={styles.formField}>
                <label style={styles.formLabel}>Anthropic API Key</label>
                <input 
                  type="password" 
                  style={styles.textInput} 
                  value={key} 
                  onChange={(e) => setKey(e.target.value)} 
                  placeholder="sk-ant-..." 
                  autoFocus 
                />
                <p style={styles.settingsHint}>
                  Your key is stored locally in your browser only. Get one at{' '}
                  <a href="https://console.anthropic.com/api-keys" target="_blank" rel="noopener noreferrer" style={styles.settingsLink}>
                    console.anthropic.com
                  </a>
                </p>
              </div>
              <button onClick={handleSave} style={styles.submitButton}>Save</button>
              {apiKey && (
                <p style={styles.settingsStatus}>âœ“ API key is set</p>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Admin Dashboard - For Tend team to view user data structure
    function AdminDashboard({ 
      user,
      savedConversations, 
      trends, 
      userProfile,
      journalEntries,
      goals,
      events,
      onClose 
    }) {
      const conversationCount = Object.keys(savedConversations).length;
      const journalCount = Object.keys(journalEntries).length;
      const goalsCount = goals.length;
      const eventsCount = events.length;
      
      const dashStyles = {
        overlay: {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 10000,
          padding: '2rem'
        },
        container: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          maxWidth: '900px',
          width: '100%',
          maxHeight: '90vh',
          overflow: 'auto',
          padding: '2rem'
        },
        header: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '1.5rem'
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)'
        },
        closeButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.5rem',
          color: 'var(--text-muted)',
          cursor: 'pointer'
        },
        section: {
          marginBottom: '1.5rem',
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px'
        },
        sectionTitle: {
          fontSize: '1rem',
          fontWeight: 600,
          color: 'var(--text)',
          marginBottom: '0.75rem'
        },
        grid: {
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
          gap: '1rem'
        },
        stat: {
          padding: '0.75rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '8px'
        },
        statLabel: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
          marginBottom: '0.25rem'
        },
        statValue: {
          fontSize: '1.5rem',
          fontWeight: 600,
          color: 'var(--accent)'
        },
        code: {
          fontFamily: 'monospace',
          fontSize: '0.85rem',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '8px',
          overflowX: 'auto'
        },
        userId: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
          fontFamily: 'monospace'
        }
      };
      
      return (
        <div style={dashStyles.overlay} onClick={onClose}>
          <div style={dashStyles.container} onClick={(e) => e.stopPropagation()}>
            <div style={dashStyles.header}>
              <div>
                <h2 style={dashStyles.title}>Admin Dashboard</h2>
                <div style={dashStyles.userId}>User ID: {user?.uid.substring(0, 8)}...</div>
              </div>
              <button style={dashStyles.closeButton} onClick={onClose}>Ã—</button>
            </div>
            
            {/* Storage Overview */}
            <div style={dashStyles.section}>
              <h3 style={dashStyles.sectionTitle}>ðŸ“Š Storage Overview</h3>
              <div style={dashStyles.grid}>
                <div style={dashStyles.stat}>
                  <div style={dashStyles.statLabel}>Saved Conversations</div>
                  <div style={dashStyles.statValue}>{conversationCount}</div>
                </div>
                <div style={dashStyles.stat}>
                  <div style={dashStyles.statLabel}>Journal Entries</div>
                  <div style={dashStyles.statValue}>{journalCount}</div>
                </div>
                <div style={dashStyles.stat}>
                  <div style={dashStyles.statLabel}>Goals</div>
                  <div style={dashStyles.statValue}>{goalsCount}</div>
                </div>
                <div style={dashStyles.stat}>
                  <div style={dashStyles.statLabel}>Events</div>
                  <div style={dashStyles.statValue}>{eventsCount}</div>
                </div>
              </div>
            </div>
            
            {/* Trends */}
            {trends && (
              <div style={dashStyles.section}>
                <h3 style={dashStyles.sectionTitle}>ðŸ“ˆ Calculated Trends</h3>
                <pre style={dashStyles.code}>{JSON.stringify(trends, null, 2)}</pre>
              </div>
            )}
            
            {/* User Profile */}
            <div style={dashStyles.section}>
              <h3 style={dashStyles.sectionTitle}>ðŸ‘¤ User Profile</h3>
              <pre style={dashStyles.code}>{JSON.stringify(userProfile, null, 2)}</pre>
            </div>
            
            {/* Conversations */}
            {conversationCount > 0 && (
              <div style={dashStyles.section}>
                <h3 style={dashStyles.sectionTitle}>ðŸ’¬ Saved Conversations</h3>
                {Object.entries(savedConversations).map(([id, conv]) => (
                  <div key={id} style={{marginBottom: '1rem'}}>
                    <div style={{fontSize: '0.85rem', color: 'var(--text)', marginBottom: '0.5rem'}}>
                      <strong>{conv.type}</strong> - {new Date(conv.lastMessageAt).toLocaleDateString()}
                    </div>
                    <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>
                      Messages: {conv.messages?.length || 0} | Themes: {conv.insights?.themes?.join(', ') || 'none'}
                    </div>
                  </div>
                ))}
              </div>
            )}
            
            {/* Sample Data */}
            <div style={dashStyles.section}>
              <h3 style={dashStyles.sectionTitle}>ðŸ“ Sample Journal Entry</h3>
              {journalCount > 0 ? (
                <pre style={dashStyles.code}>{JSON.stringify(
                  Object.entries(journalEntries)[0], 
                  null, 
                  2
                ).substring(0, 500)}...</pre>
              ) : (
                <div style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>No journal entries yet</div>
              )}
            </div>
            
            <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '1.5rem', textAlign: 'center'}}>
              ðŸ”’ This is a development/QA view. User data is private and encrypted.
            </div>
          </div>
        </div>
      );
    }

    // ============ INSIGHTS VIEW (USER-FACING TRENDS) ============
    function InsightsView({ trends, vlqScores, yearTheme, flexPoints, onBack }) {
      if (!trends) return null;
      
      const insightsStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
        },
        header: {
          padding: '1rem 2rem',
          borderBottom: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        },
        headerLeft: {
          display: 'flex',
          alignItems: 'center',
          gap: '1rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.25rem',
          color: 'var(--text-muted)',
          cursor: 'pointer',
          padding: '0.25rem',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.25rem',
          color: 'var(--text)',
        },
        content: {
          flex: 1,
          padding: '2rem',
          maxWidth: '800px',
          margin: '0 auto',
          width: '100%',
        },
        section: {
          marginBottom: '2rem',
          padding: '1.5rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          border: '1px solid var(--border)',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '1rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        statsGrid: {
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
          gap: '1rem',
        },
        statCard: {
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
          textAlign: 'center',
        },
        statValue: {
          fontSize: '2rem',
          fontWeight: 600,
          color: 'var(--accent)',
          marginBottom: '0.25rem',
        },
        statLabel: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
        },
        areaItem: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '8px',
          marginBottom: '0.5rem',
        },
        areaName: {
          fontSize: '0.85rem',
          color: 'var(--text)',
        },
        areaStats: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
        },
        completionRate: {
          fontSize: '0.9rem',
          fontWeight: 600,
          color: 'var(--accent)',
        },
      };
      
      // Calculate top 3 life areas by completion rate
      const topAreas = Object.entries(trends.dailyTends.byLifeArea)
        .filter(([_, stats]) => stats.completed + stats.skipped > 0)
        .sort((a, b) => b[1].completionRate - a[1].completionRate)
        .slice(0, 3);
      
      return (
        <div style={insightsStyles.container}>
          <div style={insightsStyles.header}>
            <div style={insightsStyles.headerLeft}>
              <button style={insightsStyles.backButton} onClick={onBack} title="Back">
                â†
              </button>
              <h2 style={insightsStyles.title}>Your Insights</h2>
            </div>
            <div style={{fontSize: '0.9rem', color: 'var(--text-muted)'}}>
              {yearTheme && `${new Date().getFullYear()}: ${yearTheme}`}
            </div>
          </div>
          
          <div style={insightsStyles.content}>
            {/* Overview Stats */}
            <div style={insightsStyles.section}>
              <h3 style={insightsStyles.sectionTitle}>
                <span>ðŸ“Š</span>
                <span>Your Progress</span>
              </h3>
              <div style={insightsStyles.statsGrid}>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.dailyTends.totalCompleted}</div>
                  <div style={insightsStyles.statLabel}>Daily Tends Completed</div>
                </div>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.dailyTends.currentStreak}</div>
                  <div style={insightsStyles.statLabel}>Current Streak</div>
                </div>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.journaling.totalEntries}</div>
                  <div style={insightsStyles.statLabel}>Journal Entries</div>
                </div>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.journaling.currentStreak}</div>
                  <div style={insightsStyles.statLabel}>Journal Streak</div>
                </div>
              </div>
            </div>
            
            {/* Daily Tends by Life Area */}
            <div style={insightsStyles.section}>
              <h3 style={insightsStyles.sectionTitle}>
                <span>ðŸŒ±</span>
                <span>Daily Tends by Life Area</span>
              </h3>
              {topAreas.length > 0 ? (
                <>
                  <div style={{marginBottom: '1rem', fontSize: '0.85rem', color: 'var(--text-muted)'}}>
                    Your top 3 areas:
                  </div>
                  {topAreas.map(([areaKey, stats], index) => {
                    const area = VLQ_DOMAINS[areaKey];
                    if (!area) return null;
                    return (
                      <div key={areaKey} style={insightsStyles.areaItem}>
                        <div>
                          <div style={insightsStyles.areaName}>
                            {index + 1}. {area.icon} {area.name}
                          </div>
                          <div style={insightsStyles.areaStats}>
                            {stats.completed} completed, {stats.skipped} skipped
                          </div>
                        </div>
                        <div style={insightsStyles.completionRate}>
                          {stats.completionRate}%
                        </div>
                      </div>
                    );
                  })}
                </>
              ) : (
                <div style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>
                  Complete some daily tends to see your progress!
                </div>
              )}
            </div>
            
            {/* Goals Progress */}
            {trends.goals.totalCreated > 0 && (
              <div style={insightsStyles.section}>
                <h3 style={insightsStyles.sectionTitle}>
                  <span>ðŸŽ¯</span>
                  <span>Goals</span>
                </h3>
                <div style={insightsStyles.statsGrid}>
                  <div style={insightsStyles.statCard}>
                    <div style={insightsStyles.statValue}>{trends.goals.completed}</div>
                    <div style={insightsStyles.statLabel}>Completed</div>
                  </div>
                  <div style={insightsStyles.statCard}>
                    <div style={insightsStyles.statValue}>{trends.goals.inProgress}</div>
                    <div style={insightsStyles.statLabel}>In Progress</div>
                  </div>
                  <div style={insightsStyles.statCard}>
                    <div style={insightsStyles.statValue}>{trends.goals.completionRate}%</div>
                    <div style={insightsStyles.statLabel}>Completion Rate</div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Journaling */}
            <div style={insightsStyles.section}>
              <h3 style={insightsStyles.sectionTitle}>
                <span>ðŸ“</span>
                <span>Journaling</span>
              </h3>
              <div style={insightsStyles.statsGrid}>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.journaling.entriesThisMonth}</div>
                  <div style={insightsStyles.statLabel}>This Month</div>
                </div>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.journaling.entriesThisYear}</div>
                  <div style={insightsStyles.statLabel}>This Year</div>
                </div>
                <div style={insightsStyles.statCard}>
                  <div style={insightsStyles.statValue}>{trends.journaling.currentStreak}</div>
                  <div style={insightsStyles.statLabel}>Current Streak</div>
                </div>
              </div>
            </div>
            
            {/* Motivation */}
            <div style={{
              padding: '1.5rem',
              backgroundColor: 'var(--accent-light)',
              borderRadius: '16px',
              border: '2px solid var(--accent)',
              textAlign: 'center',
            }}>
              <div style={{fontSize: '0.85rem', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                You have
              </div>
              <div style={{fontSize: '2rem', fontWeight: 600, color: 'var(--accent)', marginBottom: '0.5rem'}}>
                {flexPoints} ðŸª´
              </div>
              <div style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>
                flex points for reselecting daily tends
              </div>
            </div>
          </div>
        </div>
      );
    }

    const styles = {
      container: { height: '100vh', maxHeight: '100vh', display: 'flex', flexDirection: 'column', backgroundColor: 'var(--bg-main)', overflow: 'hidden' },
      header: { padding: '0.875rem 2rem', borderBottom: '1px solid var(--border)', backgroundColor: 'var(--bg-card)', display: 'flex', alignItems: 'baseline', gap: '1rem' },
      logoContainer: { display: 'flex', alignItems: 'center' },
      logoText: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", fontWeight: 400, color: 'var(--text)' },
      tagline: { fontSize: '0.85rem', color: 'var(--text-muted)', fontStyle: 'italic', flex: 1 },
      settingsButton: { background: 'none', border: 'none', fontSize: '1.25rem', color: 'var(--text-muted)', cursor: 'pointer', padding: '0.25rem', opacity: 0.7, transition: 'opacity 0.2s' },

      main: { display: 'grid', gridTemplateColumns: '64px 1fr 320px', flex: 1, height: 'calc(100vh - 56px)', overflow: 'hidden' },

      sidebar: { backgroundColor: 'var(--bg-card)', borderRight: '1px solid var(--border)', display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden' },
      sidebarResizeHandle: { position: 'absolute', right: 0, top: 0, bottom: 0, width: '4px', cursor: 'ew-resize', backgroundColor: 'transparent', zIndex: 10, transition: 'background-color 0.2s' },
      sidebarNav: { display: 'flex', flexDirection: 'column', padding: '0.75rem 0.5rem', gap: '0.25rem', borderBottom: '1px solid var(--border)' },
      sidebarNavItem: { display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem', border: 'none', borderRadius: '10px', cursor: 'pointer', transition: 'background-color 0.2s', textAlign: 'left', width: '100%' },
      sidebarNavItemActive: { backgroundColor: 'var(--bg-elevated)' },
      sidebarNavIcon: { fontSize: '1.25rem', flexShrink: 0 },
      sidebarNavLabel: { fontSize: '0.85rem', color: 'var(--text)', fontWeight: 500, whiteSpace: 'nowrap', overflow: 'hidden', transition: 'opacity 0.2s, width 0.2s' },
      tabs: { display: 'flex', flex: 1 },
      tab: { flex: 1, padding: '0.875rem 0.375rem', backgroundColor: 'transparent', border: 'none', borderBottom: '2px solid transparent', color: 'var(--text-muted)', fontSize: '0.7rem', fontWeight: 500, cursor: 'pointer', whiteSpace: 'nowrap' },
      tabActive: { color: 'var(--text)', borderBottomColor: 'var(--accent)' },
      tabContent: { flex: 1, overflow: 'auto', padding: '1rem', minHeight: 0 },
      tabPlaceholder: { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', padding: '2rem' },
      placeholderText: { color: 'var(--text-muted)', fontSize: '0.85rem', textAlign: 'center', fontStyle: 'italic' },

      eventsTab: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      addItemButton: { padding: '0.625rem 1rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '8px', color: 'white', fontSize: '0.8rem', cursor: 'pointer', alignSelf: 'flex-start' },
      eventsList: { display: 'flex', flexDirection: 'column', gap: '0.5rem' },
      eventCard: { backgroundColor: 'var(--bg-elevated)', borderRadius: '10px', overflow: 'hidden' },
      eventHeader: { padding: '0.875rem 1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer' },
      eventHeaderLeft: { display: 'flex', alignItems: 'center', gap: '0.625rem' },
      eventDot: { width: '8px', height: '8px', borderRadius: '50%', flexShrink: 0 },
      eventMonth: { fontSize: '0.7rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase' },
      eventTitle: { fontSize: '0.875rem', color: 'var(--text)' },
      expandIcon: { color: 'var(--text-muted)', fontSize: '1rem' },
      eventDetails: { padding: '0 1rem 1rem', display: 'flex', flexDirection: 'column', gap: '0.75rem', borderTop: '1px solid var(--border)', paddingTop: '0.875rem' },
      detailField: { display: 'flex', flexDirection: 'column', gap: '0.25rem' },
      detailLabel: { fontSize: '0.7rem', color: 'var(--text-muted)' },
      detailInput: { padding: '0.5rem 0.75rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '6px', fontSize: '0.8rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none' },
      deleteEventButton: { padding: '0.5rem', backgroundColor: 'transparent', border: '1px solid var(--border)', borderRadius: '6px', color: 'var(--text-muted)', fontSize: '0.75rem', cursor: 'pointer', marginTop: '0.25rem' },
      emptyText: { color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic' },
      tipText: { color: 'var(--text-muted)', fontSize: '0.75rem', marginTop: 'auto', paddingTop: '1rem' },

      notesTab: { height: '100%' },
      notesTextarea: { width: '100%', height: '100%', minHeight: '300px', padding: '1rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.875rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none', lineHeight: 1.7 },

      goalsTab: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      goalsList: { display: 'flex', flexDirection: 'column', gap: '0.5rem' },
      goalCard: { display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '8px' },
      goalCheck: { width: '20px', height: '20px', borderRadius: '50%', border: '2px solid var(--accent)', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', color: 'white', fontSize: '0.7rem', flexShrink: 0 },
      goalText: { flex: 1, fontSize: '0.875rem', color: 'var(--text)' },
      goalDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1rem', opacity: 0.5 },

      centerPanel: { display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '1.5rem 1.25rem', backgroundColor: 'var(--bg-main)', gap: '1.5rem', overflow: 'auto', height: '100%', minHeight: 0 },
      viewSwitcher: { display: 'flex', gap: '2px', backgroundColor: 'var(--bg-card)', padding: '4px', borderRadius: '12px', border: '1px solid var(--border)' },
      viewButton: { padding: '0.5rem 1rem', backgroundColor: 'transparent', border: 'none', borderRadius: '10px', color: 'var(--text-muted)', fontSize: '0.8rem', fontWeight: 500, cursor: 'pointer', transition: 'all 0.2s ease' },
      viewButtonActive: { backgroundColor: 'var(--accent)', color: 'white' },

      circleContainer: { display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '1rem' },
      circleAddButton: { padding: '0.5rem 1.25rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '20px', color: 'white', fontSize: '0.8rem', cursor: 'pointer' },

      // Seasons
      seasonsContainer: { width: '100%', maxWidth: '580px' },
      seasonsGrid: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem' },
      seasonCard: { borderRadius: '16px', overflow: 'hidden', border: '2px solid transparent' },
      seasonDecorative: { padding: '0.75rem', display: 'flex', justifyContent: 'center', gap: '0.75rem', fontSize: '1rem', opacity: 0.7 },
      seasonCardContent: { padding: '1rem', backgroundColor: 'var(--bg-card)', borderBottomLeftRadius: '14px', borderBottomRightRadius: '14px' },
      seasonCardHeader: { marginBottom: '0.5rem', position: 'relative' },
      seasonName: { fontSize: '1.125rem', fontFamily: "'Fraunces', serif", marginBottom: '0.125rem' },
      seasonMonths: { fontSize: '0.75rem', color: 'var(--text-muted)' },
      currentBadge: { position: 'absolute', top: 0, right: 0, fontSize: '0.6rem', color: 'white', padding: '0.2rem 0.5rem', borderRadius: '8px' },
      seasonDescription: { fontSize: '0.75rem', color: 'var(--text-muted)', lineHeight: 1.5, marginBottom: '0.75rem', fontStyle: 'italic' },
      seasonIntentionBox: { },
      seasonLabel: { fontSize: '0.7rem', fontWeight: 500, display: 'block', marginBottom: '0.375rem' },
      seasonTextarea: { width: '100%', padding: '0.625rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', fontSize: '0.8rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none', lineHeight: 1.5 },

      // Monthly
      monthlyContainer: { width: '100%', maxWidth: '500px', display: 'flex', flexDirection: 'column', gap: '1rem' },
      monthStrip: { display: 'flex', gap: '2px', backgroundColor: 'var(--bg-card)', padding: '4px', borderRadius: '10px', border: '1px solid var(--border)' },
      monthStripButton: { flex: 1, padding: '0.5rem 0.25rem', border: 'none', borderRadius: '6px', fontSize: '0.65rem', fontWeight: 500, cursor: 'pointer', transition: 'all 0.2s ease' },
      calendarWrapper: { backgroundColor: 'var(--bg-card)', borderRadius: '16px', overflow: 'hidden', border: '1px solid var(--border)' },
      calendarHeader: { padding: '0.875rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', opacity: 0.85 },
      calendarNav: { background: 'none', border: 'none', color: 'white', fontSize: '1.25rem', cursor: 'pointer', padding: '0 0.5rem', opacity: 0.9 },
      calendarTitle: { color: 'white', fontSize: '1rem', fontFamily: "'Fraunces', serif" },
      calendarBody: { padding: '1rem' },
      calendarGrid: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' },
      calendarDayHeader: { padding: '0.5rem', textAlign: 'center', fontSize: '0.65rem', color: 'var(--text-muted)', fontWeight: 500 },
      calendarDayEmpty: { aspectRatio: '1' },
      calendarDay: { aspectRatio: '1', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.8rem', color: 'var(--text-light)', backgroundColor: 'var(--bg-elevated)', borderRadius: '8px' },
      calendarDayToday: { color: 'white', fontWeight: 600 },
      monthEventsSection: { display: 'flex', flexDirection: 'column', gap: '0.5rem', alignItems: 'center' },
      monthEventsList: { width: '100%', display: 'flex', flexDirection: 'column', gap: '0.375rem' },
      monthEventItem: { display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-card)', borderRadius: '8px', fontSize: '0.85rem', border: '1px solid var(--border)' },
      noEventsText: { color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic' },
      addEventSmall: { padding: '0.5rem 1rem', backgroundColor: 'transparent', border: '1px solid', borderRadius: '20px', fontSize: '0.8rem', cursor: 'pointer' },

      // Weekly
      weeklyContainer: { width: '100%', maxWidth: '650px', display: 'flex', flexDirection: 'column', gap: '1.5rem', padding: '1rem' },
      weeklyHeader: { textAlign: 'center', marginBottom: '0.5rem' },
      weeklyTitle: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", color: 'var(--text)', marginBottom: '0.375rem' },
      weeklySubtitle: { fontSize: '0.9rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      weeklyGrid: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      weeklyDaysHeader: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', maxWidth: '350px', margin: '0 auto' },
      weeklyDayLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', textAlign: 'center', fontWeight: 500 },
      weeklyHabitsList: { display: 'flex', flexDirection: 'column', gap: '0.75rem' },
      weeklyHabitRow: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '1.5rem', padding: '1rem 1.25rem', backgroundColor: 'var(--bg-card)', borderRadius: '12px', border: '1px solid var(--border)' },
      weeklyHabitInfo: { display: 'flex', alignItems: 'center', gap: '0.625rem', flex: '1' },
      weeklyHabitDot: { width: '10px', height: '10px', borderRadius: '50%', flexShrink: 0 },
      weeklyHabitText: { fontSize: '0.95rem', color: 'var(--text)', fontWeight: 500 },
      weeklyHabitFreq: { fontSize: '0.75rem', color: 'var(--text-muted)', backgroundColor: 'var(--bg-elevated)', padding: '0.25rem 0.625rem', borderRadius: '12px', marginLeft: '0.5rem' },
      weeklyHabitDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1.125rem', opacity: 0.5, marginLeft: '0.5rem' },
      weeklyHabitDays: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', width: '280px', flexShrink: 0 },
      weeklyDayCircle: { width: '32px', height: '32px', borderRadius: '50%', border: '2px solid', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto' },
      weeklyEmpty: { textAlign: 'center', padding: '3rem 2rem', backgroundColor: 'var(--bg-card)', borderRadius: '16px', border: '1px dashed var(--border)' },
      weeklyEmptyText: { fontSize: '1rem', color: 'var(--text-muted)', fontStyle: 'italic', marginBottom: '0.25rem' },
      addHabitSection: { display: 'flex', gap: '0.625rem', alignItems: 'center', justifyContent: 'center', flexWrap: 'wrap' },
      addHabitInput: { flex: '1', minWidth: '200px', maxWidth: '280px', padding: '0.75rem 1rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.9rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif" },
      addHabitSelect: { padding: '0.75rem 1rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.85rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif" },
      addHabitButton: { padding: '0.75rem 1.5rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '10px', color: 'white', fontSize: '0.85rem', cursor: 'pointer', fontWeight: 500 },
      lockedText: { textAlign: 'center', color: 'var(--text-muted)', fontSize: '0.9rem', fontStyle: 'italic', padding: '1rem' },

      // Daily
      dailyContainer: { width: '100%', maxWidth: '550px', display: 'flex', flexDirection: 'column', gap: '1.5rem', padding: '1rem' },
      dailyHeader: { textAlign: 'center', marginBottom: '0.5rem' },
      dailyTitle: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", color: 'var(--text)', marginBottom: '0.375rem' },
      dailySubtitle: { fontSize: '0.9rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      dailyList: { display: 'flex', flexDirection: 'column', gap: '0.75rem' },
      dailyHabitCard: { display: 'flex', alignItems: 'center', backgroundColor: 'var(--bg-card)', borderRadius: '14px', border: '1px solid var(--border)', overflow: 'hidden' },
      dailyHabitAccent: { width: '5px', height: '100%', minHeight: '70px', flexShrink: 0 },
      dailyHabitContent: { flex: 1, padding: '1rem 1.25rem', display: 'flex', flexDirection: 'column', gap: '0.2rem' },
      dailyHabitText: { fontSize: '1rem', color: 'var(--text)', fontWeight: 500 },
      dailyHabitLabel: { fontSize: '0.75rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      dailyHabitDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1.25rem', padding: '1rem', opacity: 0.5 },
      dailyEmpty: { textAlign: 'center', padding: '3rem 2rem', backgroundColor: 'var(--bg-card)', borderRadius: '16px', border: '1px dashed var(--border)' },
      dailyEmptyText: { fontSize: '1rem', color: 'var(--text-muted)', marginBottom: '0.75rem' },
      dailyEmptyExamples: { fontSize: '0.85rem', color: 'var(--text-muted)' },
      addDailySection: { display: 'flex', flexDirection: 'column', gap: '0.625rem', alignItems: 'center' },
      addDailyInput: { width: '100%', maxWidth: '400px', padding: '0.875rem 1.125rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '12px', fontSize: '0.95rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", textAlign: 'center' },
      addDailyButton: { padding: '0.75rem 1.5rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '12px', color: 'white', fontSize: '0.9rem', cursor: 'pointer', fontWeight: 500 },

      // Bottom section - VLQ Summary
      bottomSection: { display: 'flex', justifyContent: 'center', gap: '2rem', width: '100%', maxWidth: '600px', padding: '1rem 1.5rem', backgroundColor: 'var(--bg-card)', borderRadius: '14px', border: '1px solid var(--border)', marginTop: 'auto' },
      vlqSummary: { display: 'flex', gap: '2.5rem', justifyContent: 'center', width: '100%' },
      vlqSummaryColumn: { display: 'flex', flexDirection: 'column', gap: '0.5rem', alignItems: 'center' },
      vlqSummaryLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', fontWeight: 500 },
      vlqSummaryItems: { display: 'flex', flexWrap: 'wrap', gap: '0.375rem', justifyContent: 'center' },
      vlqSummaryTag: { display: 'inline-flex', alignItems: 'center', gap: '0.25rem', padding: '0.3rem 0.6rem', backgroundColor: 'transparent', border: '1px solid', borderRadius: '12px', fontSize: '0.7rem' },
      sectionLabel: { fontSize: '0.65rem', textTransform: 'uppercase', letterSpacing: '0.1em', color: 'var(--text-muted)', marginBottom: '0.5rem', fontFamily: "'DM Sans', sans-serif", fontWeight: 600 },
      slider: { width: '100%', height: '3px', cursor: 'pointer' },

      // Chat
      chatPanel: { backgroundColor: 'var(--bg-card)', borderLeft: '1px solid var(--border)', display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden', position: 'relative' },
      resizeHandle: { position: 'absolute', left: 0, top: 0, bottom: 0, width: '6px', cursor: 'ew-resize', backgroundColor: 'transparent', zIndex: 10, transition: 'background-color 0.2s' },
      chatMessages: { flex: 1, padding: '1.25rem', overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '0.875rem', minHeight: 0 },
      chatInputArea: { padding: '1rem 1.25rem 1.25rem', borderTop: '1px solid var(--border)' },
      skipButton: { width: '100%', padding: '0.5rem', marginBottom: '0.75rem', backgroundColor: 'transparent', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text-muted)', fontSize: '0.8rem', cursor: 'pointer' },
      inputRow: { display: 'flex', gap: '0.625rem', alignItems: 'flex-end' },
      chatInput: { flex: 1, padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '12px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif", resize: 'none' },
      sendButton: { width: '40px', height: '40px', borderRadius: '50%', backgroundColor: 'var(--accent)', border: 'none', color: 'white', fontSize: '1rem', cursor: 'pointer', flexShrink: 0 },
      sendButtonDisabled: { backgroundColor: 'var(--border)', cursor: 'not-allowed' },
      chatMessage: { display: 'flex', gap: '0.625rem', alignItems: 'flex-start' },
      chatAvatar: { width: '28px', height: '28px', borderRadius: '50%', backgroundColor: 'var(--accent-light)', border: '1px solid var(--accent)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 },
      chatAvatarText: { fontFamily: "'Fraunces', serif", fontSize: '0.75rem', color: 'var(--accent)' },
      chatBubble: { padding: '0.75rem 1rem', borderRadius: '14px', maxWidth: '88%', fontSize: '0.875rem', lineHeight: 1.55 },
      chatBubbleAssistant: { backgroundColor: 'var(--bg-elevated)', borderTopLeftRadius: '4px', color: 'var(--text)' },
      chatBubbleUser: { backgroundColor: 'var(--accent)', borderTopRightRadius: '4px', color: 'white' },
      typingBubble: { padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '14px', borderTopLeftRadius: '4px', display: 'flex', gap: '4px' },
      typingDot: { color: 'var(--accent)', fontSize: '1.125rem', lineHeight: 1, animation: 'pulse 1s infinite' },

      modalOverlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 },
      modal: { backgroundColor: 'var(--bg-card)', borderRadius: '16px', padding: '1.5rem', width: '90%', maxWidth: '360px', border: '1px solid var(--border)' },
      modalHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.25rem' },
      modalTitle: { fontSize: '1.125rem', fontFamily: "'Fraunces', serif", color: 'var(--text)' },
      modalClose: { width: '28px', height: '28px', borderRadius: '50%', backgroundColor: 'var(--bg-elevated)', border: 'none', color: 'var(--text-muted)', fontSize: '1rem', cursor: 'pointer' },
      modalForm: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      formField: { display: 'flex', flexDirection: 'column', gap: '0.375rem' },
      formLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', fontWeight: 500 },
      textInput: { padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif" },
      selectInput: { padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif" },
      submitButton: { padding: '0.75rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '10px', color: 'white', fontSize: '0.875rem', fontWeight: 500, cursor: 'pointer', marginTop: '0.5rem' },
      submitButtonDisabled: { backgroundColor: 'var(--border-dark)', cursor: 'not-allowed' },
      settingsHint: { fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem', lineHeight: 1.5 },
      settingsLink: { color: 'var(--accent)', textDecoration: 'none' },
      settingsStatus: { fontSize: '0.8rem', color: 'var(--accent)', textAlign: 'center', marginTop: '0.5rem' },
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TendApp />);
  </script>
</body>
</html>
