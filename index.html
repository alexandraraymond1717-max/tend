<!DOCTYPE html>
<html lang="en">
<!-- v2.2 - Daily Tends rename, Life Areas sidebar with editable values -->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tend ‚Äî Intentional Living</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;1,9..144,300;1,9..144,400&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBh7pjHsvlk_c3Ya22U-fWCkSoL89lvnKE",
      authDomain: "tend-17.firebaseapp.com",
      projectId: "tend-17",
      storageBucket: "tend-17.firebasestorage.app",
      messagingSenderId: "795612428176",
      appId: "1:795612428176:web:bff64a86add4ed2aee2515",
      measurementId: "G-2XFLRSET2Y"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-main: #FAF8F5;
      --bg-card: #FFFFFF;
      --bg-elevated: #F0EBE4;
      --text: #2D2A26;
      --text-light: #6B6660;
      --text-muted: #9A9590;
      --border: #E8E2D9;
      --border-dark: #D4CCC0;
      --accent: #7D9B76;
      --accent-light: #E8F0E6;
      
      --winter: #7EB3E0;
      --winter-light: #F5F9FC;
      --spring: #8FD4A0;
      --spring-light: #F5FBF6;
      --summer: #F9D07A;
      --summer-light: #FFFDF7;
      --fall: #E8A090;
      --fall-light: #FDF7F5;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background-color: var(--bg-main);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    h1, h2, h3, h4 { font-family: 'Fraunces', serif; font-weight: 400; }

    /* Hide scrollbars but keep scrolling functional */
    ::-webkit-scrollbar { width: 0px; height: 0px; }
    * { scrollbar-width: none; -ms-overflow-style: none; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.7; } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    .fade-in { animation: fadeIn 0.4s ease-out forwards; }
    .slide-in { animation: slideIn 0.4s ease-out forwards; }

    /* Prevent layout shift from scrollbar appearing */
    html { scrollbar-gutter: stable; }

    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--accent) !important; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ============ CONSTANTS ============
    const VLQ_DOMAINS = {
      family: { 
        name: 'Family', 
        description: 'Parents, siblings, children, extended family ‚Äî feeling connected to and supported by your family.',
        icon: 'üë®‚Äçüë©‚Äçüëß',
        color: '#E8A090'
      },
      partner: { 
        name: 'Partner & Romance', 
        description: 'Romantic relationship, intimacy, partnership ‚Äî feeling loved and loving fully.',
        icon: 'üíï',
        color: '#E88B9C'
      },
      friendships: { 
        name: 'Friendships', 
        description: 'Close friends, social connections ‚Äî feeling known, supported, and part of a community.',
        icon: 'üëØ',
        color: '#F9D07A'
      },
      career: { 
        name: 'Work & Career', 
        description: 'Professional growth, meaningful work, financial stability ‚Äî feeling purposeful in your work.',
        icon: 'üíº',
        color: '#7EB3E0'
      },
      education: { 
        name: 'Learning & Growth', 
        description: 'Knowledge, skills, intellectual curiosity ‚Äî feeling like you\'re growing and developing.',
        icon: 'üìö',
        color: '#B8A9C9'
      },
      recreation: { 
        name: 'Recreation & Fun', 
        description: 'Hobbies, play, leisure, relaxation ‚Äî feeling joy and lightness in life.',
        icon: 'üé®',
        color: '#8FD4A0'
      },
      spirituality: { 
        name: 'Spirituality & Meaning', 
        description: 'Purpose, faith, inner life, connection to something larger ‚Äî feeling grounded in meaning.',
        icon: '‚ú®',
        color: '#C4B5D4'
      },
      community: { 
        name: 'Community & Citizenship', 
        description: 'Giving back, volunteering, social responsibility ‚Äî feeling like you contribute to the world.',
        icon: 'üåç',
        color: '#8BC4A0'
      },
      health: { 
        name: 'Physical Health', 
        description: 'Body, movement, sleep, nutrition ‚Äî feeling strong, energized, and well.',
        icon: 'üí™',
        color: '#6BBF59'
      },
      mentalHealth: { 
        name: 'Mental Health', 
        description: 'Emotional wellbeing, self-care, inner peace ‚Äî feeling balanced and at ease with yourself.',
        icon: 'üß†',
        color: '#7EB3E0'
      },
    };

    const VLQ_ORDER = ['family', 'partner', 'friendships', 'career', 'education', 'recreation', 'spirituality', 'community', 'health', 'mentalHealth'];

    // Unique ID generator
    let idCounter = 0;
    const generateId = () => `${Date.now()}-${++idCounter}-${Math.random().toString(36).substr(2, 9)}`;

    const LIFE_AREAS = {
      health: { name: 'Health & Wellness', icon: '‚óê', color: '#6BBF59' },
      relationships: { name: 'Relationships', icon: '‚ô°', color: '#E88B9C' },
      career: { name: 'Career & Work', icon: '‚óÜ', color: '#5B9BD5' },
      finances: { name: 'Finances', icon: '‚óã', color: '#F4B942' },
      growth: { name: 'Personal Growth', icon: '‚ú¶', color: '#9B8AAE' },
      fun: { name: 'Fun & Adventure', icon: '‚ú∫', color: '#D66B4B' },
    };

    // ============ TENDY SYSTEM ============
    // Garden elements mapped to VLQ domains
    const GARDEN_ELEMENTS = {
      family: { element: 'Oak Tree', icon: 'üå≥', description: 'Deep-rooted trees' },
      partner: { element: 'Rose', icon: 'üåπ', description: 'Intertwined blooms' },
      friendships: { element: 'Wildflowers', icon: 'üå∏', description: 'Clustering flowers' },
      career: { element: 'Hedge', icon: 'üåø', description: 'Structured greens' },
      education: { element: 'Sapling', icon: 'üå±', description: 'Growing trees' },
      recreation: { element: 'Butterfly', icon: 'ü¶ã', description: 'Whimsy elements' },
      spirituality: { element: 'Stone', icon: 'ü™®', description: 'Grounding features' },
      community: { element: 'Bench', icon: 'ü™ë', description: 'Shared spaces' },
      health: { element: 'Vegetable', icon: 'ü•¨', description: 'Nourishing plants' },
      mentalHealth: { element: 'Water Lily', icon: 'ü™∑', description: 'Peaceful waters' },
    };

    // Tendy templates by domain and difficulty (1=easy, 2=medium, 3=hard)
    // Type weights per life area: { action: weight, reflective: weight }
    const TYPE_WEIGHTS = {
      career: { action: 0.5, reflective: 0.5 },
      health: { action: 0.7, reflective: 0.3 },
      education: { action: 0.5, reflective: 0.5 },
      recreation: { action: 0.7, reflective: 0.3 },
      family: { action: 0.5, reflective: 0.5 },
      partner: { action: 0.6, reflective: 0.4 },
      partnerSingle: { action: 0.5, reflective: 0.5 },
      friendships: { action: 0.55, reflective: 0.45 },
      community: { action: 0.55, reflective: 0.45 },
      finances: { action: 0.5, reflective: 0.5 },
      spirituality: { action: 0.5, reflective: 0.5 },
      mentalHealth: { action: 0.45, reflective: 0.55 },
    };

    const TENDY_TEMPLATES = {
      family: [
        // 5 min - Action
        { text: 'Send a "thinking of you" text to a family member', type: 'action', difficulty: 1 },
        { text: 'Share a photo or memory with a family member', type: 'action', difficulty: 1 },
        { text: 'Ask a family member one question about their life right now', type: 'action', difficulty: 1 },
        { text: 'Send a family member something that made you think of them (song, meme, article)', type: 'action', difficulty: 1 },
        { text: 'Look at old family photos for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Ask a family member for advice on something small', type: 'action', difficulty: 1 },
        { text: 'Text a sibling or cousin a "remember when..." memory', type: 'action', difficulty: 1 },
        { text: 'Learn one new thing happening in a family member\'s life', type: 'action', difficulty: 1 },
        { text: 'Thank a family member for something specific they did for you', type: 'action', difficulty: 1 },
        { text: 'Send a family member a photo of something from your day', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down one thing you appreciate about a family member', type: 'reflective', difficulty: 1 },
        { text: 'Write down one childhood memory with a family member', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing a family member taught you', type: 'reflective', difficulty: 1 },
        { text: 'Write down a question you wish you\'d asked (or still could ask) a family member', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: which family relationship needs the most attention right now?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one family tradition you want to keep alive', type: 'reflective', difficulty: 1 },
        { text: 'Write down something you admire about how a family member handles life', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you wish your family understood about you', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Call a family member for a real conversation', type: 'action', difficulty: 3 },
        { text: 'Plan a family activity for the upcoming weekend', type: 'action', difficulty: 3 },
        { text: 'Ask an older family member to tell you a story from their past', type: 'action', difficulty: 3 },
        { text: 'Cook a family recipe (or ask a family member to share one)', type: 'action', difficulty: 3 },
        { text: 'Have a device-free conversation with a family member', type: 'action', difficulty: 3 },
        { text: 'Help a family member with something they\'re working on', type: 'action', difficulty: 3 },
        { text: 'Video call a family member you haven\'t seen in person recently', type: 'action', difficulty: 3 },
        { text: 'Create something small for a family member (card, playlist, note)', type: 'action', difficulty: 3 },
        { text: 'Ask a family member what they\'re proud of lately', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Journal about your relationship with your family and one way to improve it', type: 'reflective', difficulty: 3 },
        { text: 'Journal about your role in your family and how it\'s changed over time', type: 'reflective', difficulty: 3 },
        { text: 'Write about a family pattern you want to continue ‚Äî and one you want to break', type: 'reflective', difficulty: 3 },
        { text: 'Write a letter to a family member you don\'t have to send', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on how your family shaped who you are today', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a family member who influenced you deeply', type: 'reflective', difficulty: 3 },
        { text: 'Write about what kind of family member you want to be', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on a difficult family moment and what you learned from it', type: 'reflective', difficulty: 3 },
        { text: 'Write about what "home" and "family" mean to you right now', type: 'reflective', difficulty: 3 },
      ],
      partner: [
        // 5 min - Action
        { text: 'Leave a sweet note for your partner', type: 'action', difficulty: 1 },
        { text: 'Send your partner a message about what you appreciate about them', type: 'action', difficulty: 1 },
        { text: 'Give your partner a genuine compliment', type: 'action', difficulty: 1 },
        { text: 'Send your partner a song that reminds you of them', type: 'action', difficulty: 1 },
        { text: 'Take a candid photo of your partner and tell them why you love it', type: 'action', difficulty: 1 },
        { text: 'Text your partner a favorite memory of the two of you', type: 'action', difficulty: 1 },
        { text: 'Do one small task your partner usually does', type: 'action', difficulty: 1 },
        { text: 'Put your partner\'s favorite snack somewhere they\'ll find it', type: 'action', difficulty: 1 },
        { text: 'Send your partner a "what I\'m looking forward to with you" message', type: 'action', difficulty: 1 },
        { text: 'Give your partner a 2-minute shoulder rub or back scratch', type: 'action', difficulty: 1 },
        { text: 'Ask your partner "what can I do to make your day easier?"', type: 'action', difficulty: 1 },
        { text: 'Put on a song and dance with your partner for one song', type: 'action', difficulty: 1 },
        { text: 'Tell your partner about a moment you fell more in love with them', type: 'action', difficulty: 1 },
        { text: 'Initiate a 2-minute hug with no agenda', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down one thing your partner did recently that you appreciated', type: 'reflective', difficulty: 1 },
        { text: 'Write down one way your partner has helped you grow', type: 'reflective', difficulty: 1 },
        { text: 'Write down something your partner does that you never want them to stop', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: when did you last feel really connected to your partner?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you want your partner to know but haven\'t said', type: 'reflective', difficulty: 1 },
        { text: 'Write down your favorite quirk or habit of your partner', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s one way you could show up better for your partner this week?', type: 'reflective', difficulty: 1 },
        { text: 'Write down a dream you have for your relationship', type: 'reflective', difficulty: 1 },
        { text: 'Write down what first attracted you to your partner ‚Äî and what attracts you now', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Have a device-free conversation about dreams and goals', type: 'action', difficulty: 3 },
        { text: 'Plan a surprise or date for your partner', type: 'action', difficulty: 3 },
        { text: 'Cook a meal together or for your partner', type: 'action', difficulty: 3 },
        { text: 'Look through old photos together and pick a favorite', type: 'action', difficulty: 3 },
        { text: 'Ask your partner about something they\'re excited or worried about right now', type: 'action', difficulty: 3 },
        { text: 'Learn something new about your partner\'s childhood or past', type: 'action', difficulty: 3 },
        { text: 'Play a quick game together (cards, would you rather, 20 questions)', type: 'action', difficulty: 3 },
        { text: 'Take a walk together with no phones', type: 'action', difficulty: 3 },
        { text: 'Give your partner your full attention while they talk about their day', type: 'action', difficulty: 3 },
        { text: 'Plan something to look forward to together (trip, date, project)', type: 'action', difficulty: 3 },
        { text: 'Watch a sunset, sunrise, or the stars together', type: 'action', difficulty: 3 },
        { text: 'Share your highs and lows of the week with each other', type: 'action', difficulty: 3 },
        { text: 'Create a shared playlist of songs that mean something to you both', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Journal about what makes your relationship strong and one area to grow', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a challenge you\'ve overcome together and what it taught you', type: 'reflective', difficulty: 3 },
        { text: 'Write about what kind of partner you want to be', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on your partner\'s love language and one way to speak it this week', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what makes your relationship different from others', type: 'reflective', difficulty: 3 },
        { text: 'Write about a moment when your partner surprised you', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on the rituals or routines that keep you connected', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what you\'ve learned about love from this relationship', type: 'reflective', difficulty: 3 },
        { text: 'Write about where you hope your relationship is in 5 years', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on something you want to apologize for or do differently', type: 'reflective', difficulty: 3 },
      ],
      partnerSingle: [
        // 5 min - Action
        { text: 'Do one small thing to take care of yourself today', type: 'action', difficulty: 1 },
        { text: 'Compliment yourself out loud or in writing', type: 'action', difficulty: 1 },
        { text: 'Wear something that makes you feel confident', type: 'action', difficulty: 1 },
        { text: 'Take yourself on a mini 5-minute "date" (coffee, a walk, a song)', type: 'action', difficulty: 1 },
        { text: 'Flirt with life ‚Äî do one thing that feels a little bold or playful', type: 'action', difficulty: 1 },
        { text: 'Unfollow or mute one account that makes you feel bad about being single', type: 'action', difficulty: 1 },
        { text: 'Say yes to a social invitation you might normally skip', type: 'action', difficulty: 1 },
        { text: 'Tell a friend one thing you\'re looking for in a future partner', type: 'action', difficulty: 1 },
        { text: 'Ask a friend to set you up with someone', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down one thing you love about your life right now as a single person', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what are you learning about yourself in this season?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one quality you want in a future partner', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s one way you\'ve grown since your last relationship?', type: 'reflective', difficulty: 1 },
        { text: 'Write down something you can do now that would be harder in a relationship', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: are you single by choice, circumstance, or healing? How do you feel about it?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you\'re proud of yourself for lately', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what would you want a future partner to know about you?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one relationship pattern you want to break', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: do you treat yourself the way you\'d want a partner to treat you?', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Take yourself on a real solo date (meal, museum, movie, walk)', type: 'action', difficulty: 3 },
        { text: 'Do something you\'ve been waiting for a partner to do with you', type: 'action', difficulty: 3 },
        { text: 'Reach out to someone you\'re curious about (romantically or platonically)', type: 'action', difficulty: 3 },
        { text: 'Cook yourself a nice meal ‚Äî plate it well, sit down, enjoy it', type: 'action', difficulty: 3 },
        { text: 'Write a letter to your future partner (you don\'t have to send it)', type: 'action', difficulty: 3 },
        { text: 'Plan a fun solo adventure for the weekend', type: 'action', difficulty: 3 },
        { text: 'Call a friend who\'s good at relationships and ask for advice', type: 'action', difficulty: 3 },
        { text: 'Do something that makes you feel attractive or confident', type: 'action', difficulty: 3 },
        { text: 'Treat yourself to something small that brings you joy', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Journal about what you want your next relationship to look like', type: 'reflective', difficulty: 3 },
        { text: 'Write about a past relationship and what it taught you', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on your relationship with yourself ‚Äî are you a good partner to you?', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what scares you most about dating or relationships', type: 'reflective', difficulty: 3 },
        { text: 'Write about the kind of partner you want to be someday', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: what do you need to heal before your next relationship?', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what "ready for a relationship" means to you', type: 'reflective', difficulty: 3 },
        { text: 'Write about the difference between being alone and being lonely', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on whether you\'re looking for a relationship to complete you or complement you', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what love means to you right now', type: 'reflective', difficulty: 3 },
      ],
      friendships: [
        // 5 min - Action
        { text: 'Send a genuine message to a friend you haven\'t talked to recently', type: 'action', difficulty: 1 },
        { text: 'React to a friend\'s post with a thoughtful comment', type: 'action', difficulty: 1 },
        { text: 'Send a friend a meme, song, or link that made you think of them', type: 'action', difficulty: 1 },
        { text: 'Respond to a friend\'s text you\'ve been meaning to get back to', type: 'action', difficulty: 1 },
        { text: 'Send a friend a compliment out of the blue', type: 'action', difficulty: 1 },
        { text: 'Share something you\'re excited about with a friend', type: 'action', difficulty: 1 },
        { text: 'Ask a friend for a recommendation (book, show, restaurant)', type: 'action', difficulty: 1 },
        { text: 'Send a friend a "remember when..." message', type: 'action', difficulty: 1 },
        { text: 'Congratulate a friend on something they accomplished', type: 'action', difficulty: 1 },
        { text: 'Ask a friend one real question about their life right now', type: 'action', difficulty: 1 },
        { text: 'Save the date for a friend\'s upcoming event or milestone', type: 'action', difficulty: 1 },
        { text: 'Forward a friend a job, opportunity, or article they\'d appreciate', type: 'action', difficulty: 1 },
        { text: 'Text a friend: "No need to reply, just thinking of you"', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down one friend you want to reconnect with and why', type: 'reflective', difficulty: 1 },
        { text: 'Write down what you appreciate most about a specific friend', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: which friendship have you been neglecting?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one way a friend has shown up for you recently', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you\'ve learned from a friend', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what kind of friend do you want to be?', type: 'reflective', difficulty: 1 },
        { text: 'Write down a friend who\'s going through something ‚Äî and how you could support them', type: 'reflective', difficulty: 1 },
        { text: 'Write down one quality you look for in friendships', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: do your friendships energize you or drain you? Why?', type: 'reflective', difficulty: 1 },
        { text: 'Write down a friendship you\'ve outgrown and how you feel about it', type: 'reflective', difficulty: 1 },
        { text: 'Write down a new friend you\'d like to get to know better', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Call a friend for a real catch-up conversation', type: 'action', difficulty: 3 },
        { text: 'Plan a get-together with friends', type: 'action', difficulty: 3 },
        { text: 'Reach out to an old friend you\'ve lost touch with', type: 'action', difficulty: 3 },
        { text: 'Make plans with a friend for the next 2 weeks', type: 'action', difficulty: 3 },
        { text: 'Write and send a longer message to a friend catching them up on your life', type: 'action', difficulty: 3 },
        { text: 'Look through old photos with a friend and reminisce', type: 'action', difficulty: 3 },
        { text: 'Send a friend a small gift, care package, or handwritten note', type: 'action', difficulty: 3 },
        { text: 'Help a friend with something they\'re working on or struggling with', type: 'action', difficulty: 3 },
        { text: 'Cook or share a meal with a friend', type: 'action', difficulty: 3 },
        { text: 'Take a walk or do an activity with a friend', type: 'action', difficulty: 3 },
        { text: 'Ask a friend to teach you something they know', type: 'action', difficulty: 3 },
        { text: 'Plan a trip, adventure, or new experience with a friend', type: 'action', difficulty: 3 },
        { text: 'Be fully present for 15 minutes while a friend vents or shares', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Journal about the friendships that matter most and how to nurture them', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a friend who shaped who you are today', type: 'reflective', difficulty: 3 },
        { text: 'Write about how your friendships have changed over the years', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on a time a friend was there for you when it mattered', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what you need from friendships right now in your life', type: 'reflective', difficulty: 3 },
        { text: 'Write about a friendship that ended and what you learned', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on the balance of giving and receiving in your friendships', type: 'reflective', difficulty: 3 },
        { text: 'Write about a difficult conversation you need to have with a friend', type: 'reflective', difficulty: 3 },
        { text: 'Journal about how you maintain friendships across distance or time', type: 'reflective', difficulty: 3 },
        { text: 'Write about a friend you admire and why', type: 'reflective', difficulty: 3 },
      ],
      career: [
        // 5 min - Action
        { text: 'Organize your workspace for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Write down your #1 priority for today', type: 'action', difficulty: 1 },
        { text: 'Send one networking message or professional email', type: 'action', difficulty: 1 },
        { text: 'Delete 10 emails or clear 3 items from your task list', type: 'action', difficulty: 1 },
        { text: 'Send a thank you message to a colleague who helped you', type: 'action', difficulty: 1 },
        { text: 'Add one task to your to-do list that you\'ve been avoiding', type: 'action', difficulty: 1 },
        { text: 'Take a 5-minute break away from your screen', type: 'action', difficulty: 1 },
        { text: 'Tidy your digital desktop or close unused tabs', type: 'action', difficulty: 1 },
        { text: 'Read one industry article or post', type: 'action', difficulty: 1 },
        { text: 'Block 30 minutes on your calendar for focused work tomorrow', type: 'action', difficulty: 1 },
        { text: 'Celebrate a colleague\'s win (publicly or privately)', type: 'action', difficulty: 1 },
        { text: 'Ask a coworker how their day is going ‚Äî and actually listen', type: 'action', difficulty: 1 },
        { text: 'Unsubscribe from one work newsletter you never read', type: 'action', difficulty: 1 },
        { text: 'Write down one skill you want to develop this quarter', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down one thing you accomplished today (however small)', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you\'re procrastinating on and why', type: 'reflective', difficulty: 1 },
        { text: 'Write down what energizes you most about your work', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what drained you at work today?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you\'re proud of from this week at work', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: are you doing work that matters to you? Why or why not?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one boundary you need to set at work', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what would make tomorrow at work 10% better?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you wish you could change about your job', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: who at work do you want to learn from?', type: 'reflective', difficulty: 1 },
        { text: 'Write down how you want to feel at work ‚Äî and how you actually feel', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s one thing you keep saying yes to that you should say no to?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one risk you\'ve been afraid to take at work', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Spend 15 minutes learning a skill that would advance your career', type: 'action', difficulty: 3 },
        { text: 'Update one section of your resume or portfolio', type: 'action', difficulty: 3 },
        { text: 'Reach out to one person for career advice or mentorship', type: 'action', difficulty: 3 },
        { text: 'Complete one work task you\'ve been putting off', type: 'action', difficulty: 3 },
        { text: 'Review your goals for the quarter and adjust if needed', type: 'action', difficulty: 3 },
        { text: 'Clean out your inbox or organize your files for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Draft a message you\'ve been putting off sending', type: 'action', difficulty: 3 },
        { text: 'Research one company, role, or opportunity you\'re curious about', type: 'action', difficulty: 3 },
        { text: 'Ask for feedback from someone you trust at work', type: 'action', difficulty: 3 },
        { text: 'Map out your ideal workday vs. your actual workday', type: 'action', difficulty: 3 },
        { text: 'Update your LinkedIn or professional profile', type: 'action', difficulty: 3 },
        { text: 'Schedule a coffee chat with someone in your field', type: 'action', difficulty: 3 },
        { text: 'Brainstorm what your next career move might be', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Write down your wins from the past month', type: 'reflective', difficulty: 3 },
        { text: 'Journal about where you want your career to be in 5 years', type: 'reflective', difficulty: 3 },
        { text: 'Write about what success means to you right now', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on a mistake at work and what you learned from it', type: 'reflective', difficulty: 3 },
        { text: 'Journal about the best boss, mentor, or colleague you\'ve had ‚Äî and why', type: 'reflective', difficulty: 3 },
        { text: 'Write about what kind of work environment helps you thrive', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on how your career has shaped who you are', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a career decision you\'re wrestling with', type: 'reflective', difficulty: 3 },
        { text: 'Write about the gap between where you are and where you want to be', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on what you\'d do if money weren\'t a factor', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a professional accomplishment you\'re proud of and why it mattered', type: 'reflective', difficulty: 3 },
        { text: 'Write about what kind of leader or coworker you want to be', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: is your current path aligned with your values?', type: 'reflective', difficulty: 3 },
      ],
      education: [
        // 5 min - Action
        { text: 'Read one article about something you want to learn', type: 'action', difficulty: 1 },
        { text: 'Watch one 5-minute educational video', type: 'action', difficulty: 1 },
        { text: 'Learn one new word, concept, or fact and write it down', type: 'action', difficulty: 1 },
        { text: 'Add one book or course to your learning list', type: 'action', difficulty: 1 },
        { text: 'Listen to 5 minutes of an educational podcast', type: 'action', difficulty: 1 },
        { text: 'Write down one question you\'re curious about', type: 'action', difficulty: 1 },
        { text: 'Look up a word or concept you\'ve heard but don\'t fully understand', type: 'action', difficulty: 1 },
        { text: 'Ask someone to explain something they know well', type: 'action', difficulty: 1 },
        { text: 'Review notes or highlights from something you recently learned', type: 'action', difficulty: 1 },
        { text: 'Find one new account, newsletter, or creator to learn from', type: 'action', difficulty: 1 },
        { text: 'Google something you\'ve always wondered about', type: 'action', difficulty: 1 },
        { text: 'Skim the table of contents of a book you want to read', type: 'action', difficulty: 1 },
        { text: 'Share something you learned recently with someone else', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down one thing you learned today (from anywhere)', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you want to learn and why it matters to you', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s stopping you from learning something you\'ve been wanting to?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one skill you wish you had', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: how do you learn best? (reading, watching, doing, etc.)', type: 'reflective', difficulty: 1 },
        { text: 'Write down something you learned recently that changed how you think', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what did you love learning as a kid?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one area where you feel like a beginner', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: who has taught you the most in your life?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you know now that you wish you\'d learned earlier', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: are you learning things that matter to you, or just consuming?', type: 'reflective', difficulty: 1 },
        { text: 'Write down what you\'d learn if you had unlimited time', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Spend 15 minutes on a course, tutorial, or book', type: 'action', difficulty: 3 },
        { text: 'Practice a skill you\'re learning for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Teach someone one thing you know well', type: 'action', difficulty: 3 },
        { text: 'Work on a personal project for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Take notes on something you\'re reading or watching', type: 'action', difficulty: 3 },
        { text: 'Summarize what you learned from a recent book, article, or video', type: 'action', difficulty: 3 },
        { text: 'Research a topic you\'ve been curious about', type: 'action', difficulty: 3 },
        { text: 'Practice explaining a concept in your own words', type: 'action', difficulty: 3 },
        { text: 'Start a new book, course, or learning project', type: 'action', difficulty: 3 },
        { text: 'Revisit something you learned a while ago and see what you remember', type: 'action', difficulty: 3 },
        { text: 'Create a simple study plan for something you want to learn', type: 'action', difficulty: 3 },
        { text: 'Watch a documentary or educational video on a new topic', type: 'action', difficulty: 3 },
        { text: 'Try a new skill hands-on for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Have a conversation with someone about something they\'re expert in', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Journal about what you want to learn this year and why', type: 'reflective', difficulty: 3 },
        { text: 'Write about a time when learning something changed your life', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on your relationship with learning ‚Äî do you enjoy it or dread it?', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a subject you gave up on and whether you\'d try again', type: 'reflective', difficulty: 3 },
        { text: 'Write about what being a "lifelong learner" means to you', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on the difference between learning for credentials vs. curiosity', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a teacher, mentor, or book that shaped how you think', type: 'reflective', difficulty: 3 },
        { text: 'Write about what you\'d want to master if you had 10 years to dedicate to it', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on something you thought you knew but realized you didn\'t', type: 'reflective', difficulty: 3 },
        { text: 'Journal about how learning connects to your bigger goals in life', type: 'reflective', difficulty: 3 },
        { text: 'Write about a mistake that taught you more than any class could', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: what would you teach others if given the chance?', type: 'reflective', difficulty: 3 },
      ],
      recreation: [
        // 5 min - Action
        { text: 'Do a crossword, sudoku, or word puzzle for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Listen to one song that brings you joy', type: 'action', difficulty: 1 },
        { text: 'Watch one funny video', type: 'action', difficulty: 1 },
        { text: 'Step outside and enjoy the weather for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Dance to one song like nobody\'s watching', type: 'action', difficulty: 1 },
        { text: 'Doodle or sketch something (no pressure for it to be good)', type: 'action', difficulty: 1 },
        { text: 'Play with a pet for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Text a friend a meme or joke', type: 'action', difficulty: 1 },
        { text: 'Look up a new recipe you\'d like to try', type: 'action', difficulty: 1 },
        { text: 'Stretch while listening to your favorite song', type: 'action', difficulty: 1 },
        { text: 'Read a few pages of a book you\'re enjoying', type: 'action', difficulty: 1 },
        { text: 'Sing along to a song (even badly)', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down one thing that\'s been bringing you joy lately', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: when did you last do something just for fun?', type: 'reflective', difficulty: 1 },
        { text: 'Write down a hobby you used to love and why you stopped', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what does "play" look like for you as an adult?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one fun thing you want to do this week', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: do you give yourself permission to have fun?', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Spend 15 minutes on a hobby you\'ve been neglecting', type: 'action', difficulty: 3 },
        { text: 'Draw, paint, write, or make something creative for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Play a video game, board game, or card game for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Do something fun with zero productive purpose for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Go for a walk with no destination in mind', type: 'action', difficulty: 3 },
        { text: 'Cook or bake something just because you want to', type: 'action', difficulty: 3 },
        { text: 'Do a mini photoshoot of something you find beautiful', type: 'action', difficulty: 3 },
        { text: 'Rearrange or redecorate a small space', type: 'action', difficulty: 3 },
        { text: 'Browse a bookstore, record store, or thrift shop in person', type: 'action', difficulty: 3 },
        { text: 'Build, craft, or tinker with something', type: 'action', difficulty: 3 },
        { text: 'Try a new recipe or food you\'ve never had', type: 'action', difficulty: 3 },
        { text: 'Play music or mess around with an instrument', type: 'action', difficulty: 3 },
        { text: 'Sign up for a class, league, or group for a hobby you\'re curious about', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Write about a hobby or interest you\'d love to pick back up', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: what\'s one thing you\'d do more of if you had more time?', type: 'reflective', difficulty: 3 },
        { text: 'Journal about the last time you laughed really hard', type: 'reflective', difficulty: 3 },
        { text: 'Write about what recharges you vs. what drains you', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: how do you balance productivity and play in your life?', type: 'reflective', difficulty: 3 },
      ],
      spirituality: [
        // 5 min - Action
        { text: 'Take 5 deep breaths and center yourself', type: 'action', difficulty: 1 },
        { text: 'Step outside and notice something beautiful', type: 'action', difficulty: 1 },
        { text: 'Light a candle and sit with it for a moment', type: 'action', difficulty: 1 },
        { text: 'Listen to a song that moves you ‚Äî really listen', type: 'action', difficulty: 1 },
        { text: 'Say one thing you\'re grateful for out loud', type: 'action', difficulty: 1 },
        { text: 'Look at the sky for 2 minutes without distraction', type: 'action', difficulty: 1 },
        { text: 'Read a poem, prayer, or passage that resonates with you', type: 'action', difficulty: 1 },
        { text: 'Put your hand on your heart and take 3 slow breaths', type: 'action', difficulty: 1 },
        { text: 'Send a silent wish of kindness to someone you love', type: 'action', difficulty: 1 },
        { text: 'Notice 5 things around you using your senses', type: 'action', difficulty: 1 },
        { text: 'Stretch your body slowly and notice how it feels', type: 'action', difficulty: 1 },
        { text: 'Speak one kind thing to yourself', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down 3 things you\'re grateful for', type: 'reflective', difficulty: 1 },
        { text: 'Name one thing that gives your life meaning today', type: 'reflective', difficulty: 1 },
        { text: 'Pause and ask yourself: what do I need right now?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one moment today when you felt fully present', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what are you holding onto that you could release?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing bigger than yourself that you feel connected to', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: when do you feel most at peace?', type: 'reflective', difficulty: 1 },
        { text: 'Write down a question you\'re sitting with right now', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what does your soul need today?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one small thing that felt sacred or meaningful recently', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: how do you want to show up in the world today?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you\'re letting go of today', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Meditate or sit in stillness for 15+ minutes', type: 'action', difficulty: 3 },
        { text: 'Spend 15 minutes in nature without your phone', type: 'action', difficulty: 3 },
        { text: 'Go for a slow, mindful walk ‚Äî no podcast, no music', type: 'action', difficulty: 3 },
        { text: 'Sit somewhere beautiful and just be for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Read something spiritually nourishing for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Write a letter of gratitude to someone (send it or not)', type: 'action', difficulty: 3 },
        { text: 'Do a body scan ‚Äî notice each part of your body without judgment', type: 'action', difficulty: 3 },
        { text: 'Watch the sunrise or sunset with full attention', type: 'action', difficulty: 3 },
        { text: 'Create something with no purpose other than expression', type: 'action', difficulty: 3 },
        { text: 'Practice a breathing exercise or guided meditation', type: 'action', difficulty: 3 },
        { text: 'Spend 15 minutes in silence ‚Äî no phone, no tasks', type: 'action', difficulty: 3 },
        { text: 'Visit a place that feels sacred or peaceful to you', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Journal about what gives your life meaning', type: 'reflective', difficulty: 3 },
        { text: 'Write about a difficult experience and what it taught you', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what you believe and why', type: 'reflective', difficulty: 3 },
        { text: 'Write about a moment when you felt awe or wonder', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on what death teaches you about how to live', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a person who embodies the kind of spirit you admire', type: 'reflective', difficulty: 3 },
        { text: 'Write about your relationship with uncertainty and not-knowing', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: what spiritual practices (if any) nourish you?', type: 'reflective', difficulty: 3 },
        { text: 'Journal about forgiveness ‚Äî who do you need to forgive (including yourself)?', type: 'reflective', difficulty: 3 },
        { text: 'Write about what "enough" means to you', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on a time you felt deeply connected to something larger than yourself', type: 'reflective', difficulty: 3 },
        { text: 'Journal about how you want to be remembered', type: 'reflective', difficulty: 3 },
      ],
      community: [
        // 5 min - Action
        { text: 'Hold the door, smile at a stranger, or give a genuine compliment', type: 'action', difficulty: 1 },
        { text: 'Share or repost a cause you care about on social media', type: 'action', difficulty: 1 },
        { text: 'Leave a positive review for a local business you like', type: 'action', difficulty: 1 },
        { text: 'Wave or say hello to a neighbor', type: 'action', difficulty: 1 },
        { text: 'Pick up a piece of litter on your street', type: 'action', difficulty: 1 },
        { text: 'Learn the name of someone you see regularly but don\'t know', type: 'action', difficulty: 1 },
        { text: 'Buy something from a local business instead of a chain', type: 'action', difficulty: 1 },
        { text: 'Thank a service worker by name', type: 'action', difficulty: 1 },
        { text: 'Let someone go ahead of you in line', type: 'action', difficulty: 1 },
        { text: 'Post about a local business or event you love', type: 'action', difficulty: 1 },
        { text: 'Text a neighbor about something happening in the area', type: 'action', difficulty: 1 },
        { text: 'Offer to help a neighbor with something small', type: 'action', difficulty: 1 },
        { text: 'Sign a petition for something you believe in', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down one way you could contribute to your community', type: 'reflective', difficulty: 1 },
        { text: 'Write down one neighbor you\'d like to know better', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: do you feel connected to your neighborhood? Why or why not?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you appreciate about where you live', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what kind of neighbor do you want to be?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one way your community has supported you', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what local issue do you care about most?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you could do to make your neighborhood better', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: who are the people who make your community run?', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Volunteer your time for a cause you care about', type: 'action', difficulty: 3 },
        { text: 'Attend a community event or meeting', type: 'action', difficulty: 3 },
        { text: 'Donate to or support a local organization', type: 'action', difficulty: 3 },
        { text: 'Have a real conversation with a neighbor', type: 'action', difficulty: 3 },
        { text: 'Walk around your neighborhood and notice something new', type: 'action', difficulty: 3 },
        { text: 'Cook or bake something and share it with a neighbor', type: 'action', difficulty: 3 },
        { text: 'Offer to help an elderly or busy neighbor with an errand', type: 'action', difficulty: 3 },
        { text: 'Explore a part of your neighborhood you haven\'t been to', type: 'action', difficulty: 3 },
        { text: 'Support a local fundraiser, market, or event', type: 'action', difficulty: 3 },
        { text: 'Introduce yourself to someone new in your building or block', type: 'action', difficulty: 3 },
        { text: 'Research what\'s happening locally (events, issues, news)', type: 'action', difficulty: 3 },
        { text: 'Join a local group, club, or online community for your area', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Research a local cause and write down how you could help', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what "community" means to you', type: 'reflective', difficulty: 3 },
        { text: 'Write about a time a stranger or neighbor helped you', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on how connected or isolated you feel in your area', type: 'reflective', difficulty: 3 },
        { text: 'Journal about the kind of community you want to live in', type: 'reflective', difficulty: 3 },
        { text: 'Write about what you could contribute that others can\'t', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: what\'s stopping you from being more involved locally?', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a community you\'ve been part of that felt like home', type: 'reflective', difficulty: 3 },
        { text: 'Write about the relationship between place and belonging', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: how do you balance your own needs with contributing to others?', type: 'reflective', difficulty: 3 },
      ],
      health: [
        // 5 min - Action
        { text: 'Drink a full glass of water', type: 'action', difficulty: 1 },
        { text: 'Stretch for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Do 10 jumping jacks, squats, or pushups', type: 'action', difficulty: 1 },
        { text: 'Eat a piece of fruit or a vegetable', type: 'action', difficulty: 1 },
        { text: 'Stand up and move your body for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Step outside and get some fresh air', type: 'action', difficulty: 1 },
        { text: 'Roll out a tight muscle with a ball or foam roller', type: 'action', difficulty: 1 },
        { text: 'Do a quick posture check and adjust how you\'re sitting', type: 'action', difficulty: 1 },
        { text: 'Swap one drink for water today', type: 'action', difficulty: 1 },
        { text: 'Set a timer to remind yourself to move in an hour', type: 'action', difficulty: 1 },
        { text: 'Take the stairs instead of the elevator', type: 'action', difficulty: 1 },
        { text: 'Eat one meal without screens today', type: 'action', difficulty: 1 },
        { text: 'Put on a song and dance or move to it', type: 'action', difficulty: 1 },
        { text: 'Pack a healthy snack for later', type: 'action', difficulty: 1 },
        { text: 'Read the ingredients label on something you eat often', type: 'action', difficulty: 1 },
        { text: 'Add one extra serving of vegetables to your day', type: 'action', difficulty: 1 },
        { text: 'Swap one processed snack for a whole food today', type: 'action', difficulty: 1 },
        { text: 'Check your screen time and set a goal to reduce it', type: 'action', difficulty: 1 },
        { text: 'Get 10 minutes of natural sunlight', type: 'action', difficulty: 1 },
        { text: 'Try eating one meal more slowly today', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Write down how your body feels right now', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: did you move your body today? How did it feel?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing your body did for you today', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what does your body need more of? Less of?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one healthy habit you want to build', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: how do you feel after eating well vs. eating poorly?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one way you could take better care of your body this week', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: do you listen to your body or push through its signals?', type: 'reflective', difficulty: 1 },
        { text: 'Write down how sleep (or lack of it) is affecting you', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s one thing you\'re grateful your body can do?', type: 'reflective', difficulty: 1 },
        { text: 'Write down what you ate today ‚Äî no judgment, just notice', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s one food you know makes you feel good?', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Exercise for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Prepare a healthy meal from scratch', type: 'action', difficulty: 3 },
        { text: 'Go for a 15-minute walk or run', type: 'action', difficulty: 3 },
        { text: 'Do a full stretching or yoga session', type: 'action', difficulty: 3 },
        { text: 'Go for a walk around your neighborhood', type: 'action', difficulty: 3 },
        { text: 'Do a 15-minute home workout (YouTube, app, or freestyle)', type: 'action', difficulty: 3 },
        { text: 'Prep healthy snacks or meals for the week', type: 'action', difficulty: 3 },
        { text: 'Try a new type of movement you haven\'t done before', type: 'action', difficulty: 3 },
        { text: 'Do a guided stretching or mobility routine', type: 'action', difficulty: 3 },
        { text: 'Clean out your fridge and toss expired or unhealthy items', type: 'action', difficulty: 3 },
        { text: 'Go to bed 15 minutes earlier tonight', type: 'action', difficulty: 3 },
        { text: 'Make a grocery list focused on whole foods', type: 'action', difficulty: 3 },
        { text: 'Do a body scan and stretch whatever feels tight', type: 'action', difficulty: 3 },
        { text: 'Walk or bike somewhere you\'d normally drive', type: 'action', difficulty: 3 },
        { text: 'Craft a doable, healthy morning routine you could actually stick to', type: 'action', difficulty: 3 },
        { text: 'Design a calming wind-down routine for better sleep', type: 'action', difficulty: 3 },
        { text: 'Set up your bedroom for better sleep (dark, cool, no screens)', type: 'action', difficulty: 3 },
        { text: 'Research one health topic you\'ve been curious about', type: 'action', difficulty: 3 },
        { text: 'Try cooking a new healthy recipe you\'ve been saving', type: 'action', difficulty: 3 },
        { text: 'Plan your meals for the upcoming week', type: 'action', difficulty: 3 },
        { text: 'Prep vegetables so they\'re washed, chopped, and ready to grab', type: 'action', difficulty: 3 },
        { text: 'Make a big batch of soup, grain, or protein for the week', type: 'action', difficulty: 3 },
        { text: 'Audit your pantry ‚Äî what could you swap for healthier options?', type: 'action', difficulty: 3 },
        { text: 'Try a new vegetable or ingredient you\'ve never cooked with', type: 'action', difficulty: 3 },
        { text: 'Make your own version of a takeout favorite at home', type: 'action', difficulty: 3 },
        { text: 'Learn to cook one simple, healthy dish you can repeat', type: 'action', difficulty: 3 },
        { text: 'Freeze healthy portions for busy days', type: 'action', difficulty: 3 },
        { text: 'Schedule a doctor, dentist, or health appointment you\'ve been putting off', type: 'action', difficulty: 3 },
        { text: 'Look into health benefits or resources you might not be using', type: 'action', difficulty: 3 },
        { text: 'Set up your workspace for better posture and ergonomics', type: 'action', difficulty: 3 },
        { text: 'Try a new form of movement or fitness class', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Journal about your relationship with your body', type: 'reflective', difficulty: 3 },
        { text: 'Write about what "being healthy" means to you', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on how your energy levels have been lately', type: 'reflective', difficulty: 3 },
        { text: 'Journal about a time you felt really good in your body', type: 'reflective', difficulty: 3 },
        { text: 'Write about what motivates you to take care of your health (or what blocks you)', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on the connection between your physical and mental health', type: 'reflective', difficulty: 3 },
        { text: 'Journal about how you want to feel in your body', type: 'reflective', difficulty: 3 },
        { text: 'Write about one health habit you\'ve successfully built ‚Äî and how', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: are you caring for your body out of love or punishment?', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what rest and recovery look like for you', type: 'reflective', difficulty: 3 },
        { text: 'Journal about your relationship with food', type: 'reflective', difficulty: 3 },
        { text: 'Write about what "eating well" realistically looks like for your life', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on which meals or foods give you energy vs. drain you', type: 'reflective', difficulty: 3 },
      ],
      finances: [
        // Easy - Action
        { text: 'Check your bank balance and note any surprises', type: 'action', difficulty: 1 },
        { text: 'Unsubscribe from one thing you don\'t use', type: 'action', difficulty: 1 },
        { text: 'Add one expense to a tracker or budget', type: 'action', difficulty: 1 },
        // Easy - Reflective
        { text: 'Write down one financial goal for this month', type: 'reflective', difficulty: 1 },
        { text: 'Reflect on one recent purchase - was it worth it?', type: 'reflective', difficulty: 1 },
        // Hard - Action
        { text: 'Review and organize your budget for the month', type: 'action', difficulty: 3 },
        { text: 'Research one way to save money or grow wealth', type: 'action', difficulty: 3 },
        { text: 'Set up or review an automatic savings transfer', type: 'action', difficulty: 3 },
        // Hard - Reflective
        { text: 'Journal about your relationship with money and one shift you want to make', type: 'reflective', difficulty: 3 },
      ],
      mentalHealth: [
        // 5 min - Action
        { text: 'Step away from screens for 5 minutes', type: 'action', difficulty: 1 },
        { text: 'Take 5 slow, deep breaths', type: 'action', difficulty: 1 },
        { text: 'Go outside for a quick change of scenery', type: 'action', difficulty: 1 },
        { text: 'Text someone you trust and tell them how you\'re doing', type: 'action', difficulty: 1 },
        { text: 'Tidy one small area of your space', type: 'action', difficulty: 1 },
        { text: 'Do something that usually makes you smile', type: 'action', difficulty: 1 },
        { text: 'Unfollow or mute one account that affects your mental health', type: 'action', difficulty: 1 },
        { text: 'Splash cold water on your face or hold ice', type: 'action', difficulty: 1 },
        { text: 'Put on a song that matches or shifts your mood', type: 'action', difficulty: 1 },
        { text: 'Cancel or reschedule something that\'s draining you', type: 'action', difficulty: 1 },
        { text: 'Say no to one thing today', type: 'action', difficulty: 1 },
        { text: 'Do one tiny task you\'ve been avoiding', type: 'action', difficulty: 1 },
        { text: 'Hug someone, a pet, or yourself for 20 seconds', type: 'action', difficulty: 1 },
        { text: 'List 3 things you can see, hear, and feel right now', type: 'action', difficulty: 1 },
        // 5 min - Reflective
        { text: 'Name your current emotion without judgment', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing that\'s weighing on you', type: 'reflective', difficulty: 1 },
        { text: 'Ask yourself: what do I need right now?', type: 'reflective', difficulty: 1 },
        { text: 'Write down what triggered your current mood', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s one thing you can control right now?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you\'re doing well, even if it\'s small', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what would you say to a friend feeling this way?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thought that\'s been on repeat lately', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: are you running from something or toward something today?', type: 'reflective', difficulty: 1 },
        { text: 'Write down one thing you need to let go of', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s one kind thing you can do for yourself today?', type: 'reflective', difficulty: 1 },
        { text: 'Write down how your body is holding your stress', type: 'reflective', difficulty: 1 },
        { text: 'Reflect: what\'s draining your energy lately?', type: 'reflective', difficulty: 1 },
        // 15 min - Action
        { text: 'Take a bath, nap, or do another restorative activity for 15 minutes', type: 'action', difficulty: 3 },
        { text: 'Set one boundary or say no to one thing that\'s draining you', type: 'action', difficulty: 3 },
        { text: 'Call or text someone who makes you feel safe', type: 'action', difficulty: 3 },
        { text: 'Do something comforting: tea, blanket, cozy show', type: 'action', difficulty: 3 },
        { text: 'Take a slow walk with no agenda', type: 'action', difficulty: 3 },
        { text: 'Write out everything in your head ‚Äî brain dump', type: 'action', difficulty: 3 },
        { text: 'Research a therapist, counselor, or support group', type: 'action', difficulty: 3 },
        { text: 'Create a "feel-better" list for hard days', type: 'action', difficulty: 3 },
        { text: 'Do something creative with no expectations', type: 'action', difficulty: 3 },
        { text: 'Set up your environment for calm (lighting, sounds, clutter)', type: 'action', difficulty: 3 },
        { text: 'Reach out to someone you\'ve been isolating from', type: 'action', difficulty: 3 },
        // 15 min - Reflective
        { text: 'Journal about how you\'re really feeling', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on your stress levels and write down one way to reduce them', type: 'reflective', difficulty: 3 },
        { text: 'Write a compassionate letter to yourself about something you\'re struggling with', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what\'s really going on beneath the surface', type: 'reflective', difficulty: 3 },
        { text: 'Write about a pattern you keep repeating and why', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on what self-care actually looks like for you (not Instagram)', type: 'reflective', difficulty: 3 },
        { text: 'Journal about your inner critic ‚Äî what does it say?', type: 'reflective', difficulty: 3 },
        { text: 'Write about a hard season you got through and how', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: what are you afraid to feel right now?', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what "good enough" would look like today', type: 'reflective', difficulty: 3 },
        { text: 'Write about how you\'re different when you\'re struggling vs. thriving', type: 'reflective', difficulty: 3 },
        { text: 'Reflect on one relationship that affects your mental health', type: 'reflective', difficulty: 3 },
        { text: 'Journal about what healing looks like for you right now', type: 'reflective', difficulty: 3 },
        { text: 'Write about one belief about yourself you\'d like to change', type: 'reflective', difficulty: 3 },
        { text: 'Reflect: are you being kind to yourself lately?', type: 'reflective', difficulty: 3 },
      ],
    };

    // ============ TEND PERSONALIZATION SYSTEM ============
    
    // What specific info enables personalization for each domain
    const DOMAIN_PERSONALIZABLE_FIELDS = {
      family: { structuredKeys: ['members', 'frequency'], nameField: 'members' },
      partner: { structuredKeys: ['name', 'activities'], nameField: 'name' },
      friendships: { structuredKeys: ['closeFriends', 'socialPrefs'], nameField: 'closeFriends' },
      career: { structuredKeys: ['situation', 'projects'], nameField: null },
      education: { structuredKeys: ['learning', 'resources'], nameField: null },
      recreation: { structuredKeys: ['hobbies', 'favorites'], nameField: null },
      spirituality: { structuredKeys: ['practice', 'tradition'], nameField: null },
      community: { structuredKeys: ['neighborhood', 'involvement'], nameField: 'neighbors' },
      health: { structuredKeys: ['exercise', 'gym'], nameField: 'gym' },
      finances: { structuredKeys: ['goals', 'tools'], nameField: null },
      mentalHealth: { structuredKeys: ['practices', 'support'], nameField: 'therapist' },
    };
    
    // Calculate personalization readiness for a specific life area
    // AI can generate from ANY rich context - not just goals/habits
    function calculateDomainReadiness(domain, userProfile, goals = [], weeklyHabits = [], journalEntries = {}) {
      const prefs = userProfile?.tendPreferences || {};
      const fieldConfig = DOMAIN_PERSONALIZABLE_FIELDS[domain] || {};
      
      // ========== GATHER ALL CONTEXT ==========
      
      // 1. Goals in this life area (very actionable)
      const domainGoals = goals.filter(g => g.lifeArea === domain && !g.completed);
      const hasGoals = domainGoals.length > 0;
      
      // 2. Habits in this life area (very actionable)
      const domainHabits = weeklyHabits.filter(h => h.lifeArea === domain);
      const hasHabits = domainHabits.length > 0;
      
      // 3. Structured info (names, places, specifics)
      const structuredInfo = prefs.structuredInfo?.[domain] || {};
      const filledFields = Object.entries(structuredInfo).filter(([_, v]) => v && v.trim());
      const hasNames = fieldConfig.nameField && structuredInfo[fieldConfig.nameField]?.trim();
      const hasStructuredDetails = filledFields.length >= 1;
      
      // 4. Life area notes (rich context for AI)
      const notes = prefs.lifeAreaNotes?.[domain] || '';
      const hasNotes = notes.length > 20; // At least a sentence
      const hasDetailedNotes = notes.length > 80; // A solid paragraph
      
      // 5. Recent journal mentions (last 7 days - shows what's on their mind)
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      const recentJournals = Object.entries(journalEntries)
        .filter(([date, entry]) => {
          const entryDate = new Date(date);
          return entryDate >= oneWeekAgo && entry.lifeArea === domain;
        });
      const hasRecentJournal = recentJournals.length >= 1;
      const hasMultipleJournals = recentJournals.length >= 3;
      
      // ========== CALCULATE AI PROBABILITY ==========
      // AI can work with ANY rich context - goals/habits are just one source
      
      let aiPct = 0;
      
      // Goals are most actionable (+25%)
      if (hasGoals) aiPct += 25;
      
      // Habits are very actionable (+20%)
      if (hasHabits) aiPct += 20;
      
      // Detailed notes give AI lots to work with (+20% for detailed, +10% for basic)
      if (hasDetailedNotes) aiPct += 20;
      else if (hasNotes) aiPct += 10;
      
      // Names/specific details help personalize (+15%)
      if (hasNames || hasStructuredDetails) aiPct += 15;
      
      // Recent journals show what's on their mind (+15% for multiple, +8% for one)
      if (hasMultipleJournals) aiPct += 15;
      else if (hasRecentJournal) aiPct += 8;
      
      // Cap at 85% - always some chance of pool variety
      aiPct = Math.min(aiPct, 85);
      
      const poolPct = 100 - aiPct;
      
      // ========== DETERMINE CAPABILITIES ==========
      
      // Can generate AI if we have ANY meaningful context (20%+ means we have something)
      const canGenerateAI = aiPct >= 20;
      
      // Can personalize pool templates if we have names/details/notes
      const canPersonalize = hasNames || hasStructuredDetails || hasDetailedNotes || hasNotes;
      
      // ========== BUILD DISPLAY INFO ==========
      
      const dataPoints = [];
      const missing = [];
      
      if (hasGoals) {
        dataPoints.push({
          type: 'goals',
          icon: 'üéØ',
          label: `${domainGoals.length} goal${domainGoals.length > 1 ? 's' : ''}`,
          detail: domainGoals[0].text.substring(0, 50) + (domainGoals[0].text.length > 50 ? '...' : ''),
          impact: 'ai',
          boost: '+25%'
        });
      }
      
      if (hasHabits) {
        dataPoints.push({
          type: 'habits',
          icon: 'üîÑ',
          label: `${domainHabits.length} habit${domainHabits.length > 1 ? 's' : ''}`,
          detail: domainHabits[0].text.substring(0, 50) + (domainHabits[0].text.length > 50 ? '...' : ''),
          impact: 'ai',
          boost: '+20%'
        });
      }
      
      if (hasNotes) {
        dataPoints.push({
          type: 'notes',
          icon: 'üí¨',
          label: 'Notes',
          detail: notes.substring(0, 50) + (notes.length > 50 ? '...' : ''),
          impact: 'ai',
          boost: hasDetailedNotes ? '+20%' : '+10%'
        });
      }
      
      if (hasNames) {
        // Show actual name if short enough
        const nameValue = structuredInfo[fieldConfig.nameField];
        const shortName = nameValue.length <= 20 ? nameValue : 'Names saved';
        dataPoints.push({
          type: 'names',
          icon: 'üë§',
          label: shortName,
          detail: nameValue,
          impact: 'both',
          boost: '+15%'
        });
      } else if (hasStructuredDetails) {
        // Show what kind of profile info we have
        dataPoints.push({
          type: 'details',
          icon: 'üìù',
          label: 'Profile info',
          detail: filledFields.slice(0, 2).map(([k, v]) => v).join(', ').substring(0, 50),
          impact: 'both',
          boost: '+15%'
        });
      }
      
      if (hasRecentJournal) {
        dataPoints.push({
          type: 'journal',
          icon: 'üìñ',
          label: `${recentJournals.length} journal${recentJournals.length > 1 ? 's' : ''} this week`,
          detail: 'In the last 7 days',
          impact: 'ai',
          boost: hasMultipleJournals ? '+15%' : '+8%'
        });
      }
      
      // What's missing - suggest the most impactful thing to add
      if (aiPct < 50) {
        if (!hasGoals) {
          missing.push({ type: 'goals', label: 'Add a goal', impact: '+25% AI' });
        } else if (!hasDetailedNotes && !hasNotes) {
          missing.push({ type: 'notes', label: 'Add notes', impact: '+10-20% AI' });
        } else if (!hasHabits) {
          missing.push({ type: 'habits', label: 'Add a habit', impact: '+20% AI' });
        }
      }
      
      // Determine tier for display
      let tier, color;
      if (aiPct >= 50) {
        tier = 'AI Ready';
        color = '#8FD4A0';
      } else if (aiPct >= 20) {
        tier = 'Some AI';
        color = '#B8E0C8';
      } else if (canPersonalize) {
        tier = 'Personalizable';
        color = '#7EB3E0';
      } else {
        tier = 'Pool Only';
        color = '#E8E0D5';
      }
      
      return {
        domain,
        domainName: VLQ_DOMAINS[domain]?.name,
        tier,
        color,
        aiPct,
        poolPct,
        canGenerateAI,
        canPersonalize,
        dataPoints,
        missing,
        // For backwards compatibility
        aiRatio: aiPct / 100,
        customPct: aiPct,
        personalizedPct: 0,
        score: dataPoints.length,
        maxScore: 6,
        level: tier
      };
    }
    
    // Calculate readiness for all domains
    function calculateAllDomainReadiness(userProfile, goals = [], weeklyHabits = [], journalEntries = {}) {
      const readiness = {};
      VLQ_ORDER.forEach(domain => {
        readiness[domain] = calculateDomainReadiness(domain, userProfile, goals, weeklyHabits, journalEntries);
      });
      return readiness;
    }
    
    // Get overall personalization summary
    function getPersonalizationSummary(userProfile, goals = [], weeklyHabits = [], journalEntries = {}) {
      const allReadiness = calculateAllDomainReadiness(userProfile, goals, weeklyHabits, journalEntries);
      const domains = Object.values(allReadiness);
      
      const aiReadyCount = domains.filter(d => d.tier === 'AI Ready').length;
      const someAICount = domains.filter(d => d.tier === 'Some AI').length;
      const personalizableCount = domains.filter(d => d.tier === 'Personalizable').length;
      const poolOnlyCount = domains.filter(d => d.tier === 'Pool Only').length;
      
      const avgAiPct = domains.reduce((sum, d) => sum + d.aiPct, 0) / domains.length;
      
      return {
        allReadiness,
        aiReadyCount,
        someAICount,
        personalizableCount,
        poolOnlyCount,
        avgAiPct: Math.round(avgAiPct),
        totalDomains: domains.length,
        domainsWithAI: domains.filter(d => d.canGenerateAI).length,
        domainsWithPersonalization: domains.filter(d => d.canPersonalize).length
      };
    }

    // Personalize a template using AI (only if domain has context)
    async function personalizeTemplate(templateText, userProfile, domain, apiKey) {
      const prefs = userProfile?.tendPreferences || {};
      
      // If no preferences or no API key, return original
      if (!apiKey || Object.keys(prefs).length === 0) {
        return templateText;
      }
      
      // Build context string
      const contextParts = [];
      
      // Add gardener type for tone/style guidance
      if (prefs.gardenerType) {
        contextParts.push(`Gardener type: ${prefs.gardenerType.name} - ${prefs.gardenerType.strength}`);
      }
      
      if (prefs.resources?.length) contextParts.push(`Has: ${prefs.resources.join(', ')}`);
      if (prefs.context) {
        Object.entries(prefs.context).forEach(([k, v]) => {
          if (v) contextParts.push(k.replace(/_/g, ' '));
        });
      }
      if (prefs.lifeAreaNotes?.[domain]) contextParts.push(`${domain} notes: ${prefs.lifeAreaNotes[domain]}`);
      
      // Add structured profile info for this domain
      const structuredInfo = prefs.structuredInfo?.[domain] || {};
      Object.entries(structuredInfo).forEach(([key, value]) => {
        if (value) contextParts.push(`${key}: ${value}`);
      });
      
      if (contextParts.length === 0) return templateText;
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 60,
            system: `Personalize this wellness task for the user. Keep it under 15 words. If you can't meaningfully personalize it, return EXACTLY the original text with no changes.

User context: ${contextParts.join('. ')}`,
            messages: [{ role: 'user', content: `Task: "${templateText}"` }]
          })
        });
        
        const data = await response.json();
        const result = data.content?.[0]?.text?.trim();
        
        // Only use if reasonable length and actually different
        if (result && result.length < 80 && result.length > 5) {
          return result;
        }
        return templateText;
      } catch (error) {
        console.error('Personalization error:', error);
        return templateText;
      }
    }

    // Generate a completely fresh AI tend
    async function generateFreshAITend(domain, difficulty, type, userProfile, apiKey, goals = [], weeklyHabits = [], journalEntries = {}, minutes = null) {
      const prefs = userProfile?.tendPreferences || {};
      const domainInfo = VLQ_DOMAINS[domain];
      // Use provided minutes, or fall back to old logic
      const timeMinutes = minutes || (difficulty === 1 ? 5 : 30);
      const timeLabel = `${timeMinutes} minutes`;
      
      // Build rich context
      const contextParts = [];
      
      // Add gardener type for personalized tone and approach
      if (prefs.gardenerType) {
        contextParts.push(`User's gardener type: "${prefs.gardenerType.name}" - ${prefs.gardenerType.description}`);
        contextParts.push(`Their superpower: ${prefs.gardenerType.strength}`);
      }
      
      // Add goals for this life area
      const domainGoals = goals.filter(g => g.lifeArea === domain && !g.completed);
      if (domainGoals.length > 0) {
        contextParts.push(`Their goals for ${domainInfo.name}: ${domainGoals.map(g => g.text).join(', ')}`);
      }
      
      // Add habits for this life area
      const domainHabits = weeklyHabits.filter(h => h.lifeArea === domain);
      if (domainHabits.length > 0) {
        contextParts.push(`Their habits for ${domainInfo.name}: ${domainHabits.map(h => `${h.text} (${h.frequency}x/week)`).join(', ')}`);
      }
      
      // Add recent journal context for mood-awareness
      const recentEntries = Object.entries(journalEntries)
        .filter(([_, entry]) => entry.gratitude || entry.reflection)
        .sort((a, b) => b[0].localeCompare(a[0]))
        .slice(0, 3);
      
      if (recentEntries.length > 0) {
        const journalText = recentEntries.map(([_, e]) => `${e.gratitude || ''} ${e.reflection || ''}`).join(' ').toLowerCase();
        
        // Mood detection
        if (/stressed|overwhelmed|anxious|tired|exhausted|frustrated|difficult|struggling/i.test(journalText)) {
          contextParts.push(`Recent journal entries suggest they may be stressed or overwhelmed - suggest something gentle and restorative`);
        } else if (/excited|motivated|energized|proud|accomplished|great|amazing/i.test(journalText)) {
          contextParts.push(`Recent journal entries suggest positive energy - can suggest something more ambitious`);
        }
        
        // Recent gratitude/reflection context
        const latestEntry = recentEntries[0]?.[1];
        if (latestEntry?.gratitude) {
          contextParts.push(`Recently grateful for: ${latestEntry.gratitude.substring(0, 80)}`);
        }
      }
      
      if (prefs.resources?.length) contextParts.push(`User has: ${prefs.resources.join(', ')}`);
      if (prefs.context) {
        Object.entries(prefs.context).forEach(([k, v]) => {
          if (v) contextParts.push(`User ${k.replace(/_/g, ' ')}`);
        });
      }
      if (prefs.preferences?.length) contextParts.push(`Prefers: ${prefs.preferences.join(', ')}`);
      if (prefs.lifeAreaNotes?.[domain]) contextParts.push(`Notes about ${domainInfo.name}: ${prefs.lifeAreaNotes[domain]}`);
      
      // Add structured profile info for this domain
      const structuredInfo = prefs.structuredInfo?.[domain] || {};
      Object.entries(structuredInfo).forEach(([key, value]) => {
        if (value) contextParts.push(`${key}: ${value}`);
      });
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 60,
            system: `Create a personalized ${timeLabel} wellness task for ${domainInfo.name}.

Requirements:
- ${type === 'action' ? 'Action-oriented (doing something concrete)' : 'Reflective (journaling, thinking, introspection)'}
- Specific and actionable, not vague
- Completable in exactly ${timeLabel}
- Personal to this user based on their context
- If they have goals or habits in this area, make the task support those
- Match their personality style if gardener type is provided
- Warm and encouraging, not preachy
- Under 15 words

${contextParts.length > 0 ? `User context: ${contextParts.join('. ')}` : ''}

Respond with ONLY the task text, nothing else.`,
            messages: [{ role: 'user', content: 'Generate the task.' }]
          })
        });
        
        const data = await response.json();
        const text = data.content?.[0]?.text?.trim();
        
        if (text && text.length < 80 && text.length > 10) {
          return text;
        }
        return null;
      } catch (error) {
        console.error('Fresh AI tend error:', error);
        return null;
      }
    }

    // Probability calculation for domain selection
    function calculateDomainProbabilities(vlqScores) {
      const epsilon = 0.01; // Minimum probability floor
      const weights = {};
      let totalWeight = 0;

      VLQ_ORDER.forEach(domain => {
        const scores = vlqScores[domain];
        const importance = scores?.importance || 5;
        const consistency = scores?.consistency || 5;
        const gap = Math.max(0, importance - consistency);
        
        // Formula: base weight from importance, STRONGLY boosted by gap
        // Gap of 0 = 1x multiplier, Gap of 5 = 2x, Gap of 10 = 3x
        const gapMultiplier = 1 + (gap / 5);
        const weight = importance * gapMultiplier + epsilon;
        
        weights[domain] = weight;
        totalWeight += weight;
      });

      // Normalize to probabilities
      const probabilities = {};
      VLQ_ORDER.forEach(domain => {
        probabilities[domain] = totalWeight > 0 ? weights[domain] / totalWeight : 0;
      });
      
      // Log probabilities for debugging
      console.log('Domain probabilities:', Object.entries(probabilities)
        .filter(([_, p]) => p > 0)
        .sort((a, b) => b[1] - a[1])
        .map(([d, p]) => `${d}: ${(p * 100).toFixed(1)}%`)
        .join(', ')
      );

      return probabilities;
    }

    // Select a domain based on weighted probabilities
    function selectWeightedDomain(probabilities, exclude = [], penaltyWeights = {}) {
      // Filter out excluded domains AND domains below importance threshold (probability = 0)
      const availableDomains = VLQ_ORDER.filter(d => 
        !exclude.includes(d) && probabilities[d] > 0
      );
      
      if (availableDomains.length === 0) {
        // Fallback: pick any domain with non-zero probability
        const nonZeroDomains = VLQ_ORDER.filter(d => probabilities[d] > 0);
        if (nonZeroDomains.length === 0) return VLQ_ORDER[0]; // Ultimate fallback
        return nonZeroDomains[Math.floor(Math.random() * nonZeroDomains.length)];
      }

      // Apply soft recency penalties to probabilities
      const adjustedProbs = {};
      availableDomains.forEach(d => {
        const penalty = penaltyWeights[d] || 1.0;
        adjustedProbs[d] = probabilities[d] * penalty;
      });

      // Recalculate probabilities for available domains
      let totalProb = 0;
      availableDomains.forEach(d => totalProb += adjustedProbs[d]);
      
      const rand = Math.random() * totalProb;
      let cumulative = 0;
      
      for (const domain of availableDomains) {
        cumulative += adjustedProbs[domain];
        if (rand <= cumulative) return domain;
      }
      
      return availableDomains[availableDomains.length - 1];
    }

    // Generate today's tendies (3 options with different difficulties)
    // Helper function to get local date string (YYYY-MM-DD)
    function getLocalDateString(date = new Date()) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    function generateDailyTendies(vlqScores, tendyHistory = [], previousShownDomain = null) {
      const probabilities = calculateDomainProbabilities(vlqScores);
      const today = getLocalDateString();
      
      // Check if it's a weekend (Sat=6, Sun=0)
      const dayOfWeek = new Date().getDay();
      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
      
      // GUARDRAIL 1: No same domain two days in a row
      // Check both completed tendies from yesterday AND the previously shown domain
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yesterdayStr = getLocalDateString(yesterday);
      const yesterdayCompletedDomains = tendyHistory
        .filter(t => t.date === yesterdayStr && !t.isWeekendTend) // Only consider daily tends
        .map(t => t.domain);
      
      // Combine completed domains with the previously shown domain (if provided)
      const domainsToAvoid = [...yesterdayCompletedDomains];
      if (previousShownDomain && !domainsToAvoid.includes(previousShownDomain)) {
        domainsToAvoid.push(previousShownDomain);
      }
      
      console.log('Domain guardrail - avoiding:', domainsToAvoid);
      
      // GUARDRAIL 2: Soft recency penalty for recently-selected domains (last 7 days)
      const recentDomainCounts = {};
      VLQ_ORDER.forEach(d => recentDomainCounts[d] = 0);
      
      tendyHistory
        .filter(t => {
          const daysDiff = (new Date(today) - new Date(t.date)) / (1000 * 60 * 60 * 24);
          return daysDiff > 0 && daysDiff <= 7;
        })
        .forEach(t => {
          if (t.domain) recentDomainCounts[t.domain]++;
        });
      
      // Also penalize the previously shown domain even if not completed
      if (previousShownDomain) {
        recentDomainCounts[previousShownDomain] = (recentDomainCounts[previousShownDomain] || 0) + 1;
      }
      
      // Apply soft penalty: reduce probability by 20% per recent appearance
      const penaltyWeights = {};
      VLQ_ORDER.forEach(d => {
        penaltyWeights[d] = Math.pow(0.8, recentDomainCounts[d]);
      });

      // Select domain for daily tend
      const dailyDomain = selectWeightedDomain(probabilities, domainsToAvoid, penaltyWeights);
      
      console.log('Selected domain for daily tend:', dailyDomain, isWeekend ? '(WEEKEND)' : '(weekday)');

      // Get type weights for this domain
      const typeWeights = TYPE_WEIGHTS[dailyDomain] || { action: 0.5, reflective: 0.5 };
      
      // Select type based on weights
      const selectType = () => {
        return Math.random() < typeWeights.action ? 'action' : 'reflective';
      };

      const tendies = [];
      
      // Get recent templates for cooldown
      const recentEasyTemplates = tendyHistory
        .filter(t => {
          const daysDiff = (new Date(today) - new Date(t.date)) / (1000 * 60 * 60 * 24);
          return daysDiff < 7 && t.difficulty === 1;
        })
        .map(t => t.templateText || t.text);
      
      const recentHardTemplates = tendyHistory
        .filter(t => {
          const daysDiff = (new Date(today) - new Date(t.date)) / (1000 * 60 * 60 * 24);
          return daysDiff < 30 && t.difficulty === 3;
        })
        .map(t => t.templateText || t.text);

      // Helper to create a tend from templates
      const createTendFromPool = (domain, templateDiff, points, tendId, isWeekendTend = false) => {
        const selectedType = selectType();
        const recentTemplates = templateDiff === 1 ? recentEasyTemplates : recentHardTemplates;
        
        let templates = TENDY_TEMPLATES[domain].filter(t => 
          t.difficulty === templateDiff && 
          t.type === selectedType && 
          !recentTemplates.includes(t.text)
        );

        if (templates.length === 0) {
          templates = TENDY_TEMPLATES[domain].filter(t => 
            t.difficulty === templateDiff && t.type === selectedType
          );
        }
        
        if (templates.length === 0) {
          templates = TENDY_TEMPLATES[domain].filter(t => 
            t.difficulty === templateDiff && !recentTemplates.includes(t.text)
          );
        }
        
        if (templates.length === 0) {
          templates = TENDY_TEMPLATES[domain].filter(t => t.difficulty === templateDiff);
        }

        if (templates.length > 0) {
          const template = templates[Math.floor(Math.random() * templates.length)];
          return {
            id: tendId,
            domain: domain,
            text: template.text,
            originalText: template.text,
            type: template.type,
            difficulty: templateDiff,
            points: points,
            minutes: points,
            gardenElement: GARDEN_ELEMENTS[domain],
            color: VLQ_DOMAINS[domain].color,
            domainName: VLQ_DOMAINS[domain].name,
            domainIcon: VLQ_DOMAINS[domain].icon,
            date: today,
            generatedAt: new Date().toISOString(),
            completed: false,
            selected: false,
            templateText: template.text,
            isPersonalized: false,
            isAIGenerated: false,
            isWeekend: isWeekend,
            isWeekendTend: isWeekendTend, // true for the special weekend challenge
            source: 'pool',
          };
        }
        return null;
      };

      // DAILY TEND: Always 5-min (difficulty 1 template)
      const dailyTend = createTendFromPool(dailyDomain, 1, 5, `${today}-daily`, false);
      if (dailyTend) {
        tendies.push(dailyTend);
      }

      // WEEKEND TEND: Only on weekends, 15-min deep activity (difficulty 3 template)
      if (isWeekend) {
        // Select a DIFFERENT domain for weekend tend for variety
        const weekendDomainsToAvoid = [...domainsToAvoid, dailyDomain];
        const weekendDomain = selectWeightedDomain(probabilities, weekendDomainsToAvoid, penaltyWeights);
        console.log('Selected domain for weekend tend:', weekendDomain);
        
        const weekendTend = createTendFromPool(weekendDomain, 3, 15, `${today}-weekend`, true);
        if (weekendTend) {
          tendies.push(weekendTend);
        }
      }

      return tendies;
    }

    // Async version that personalizes or generates fresh AI tends
    // Uses PER-DOMAIN readiness, not global score
    async function generatePersonalizedTendies(vlqScores, tendyHistory, previousShownDomain, userProfile, apiKey, goals = [], weeklyHabits = [], journalEntries = {}) {
      // First generate base tendies from pool
      const baseTendies = generateDailyTendies(vlqScores, tendyHistory, previousShownDomain);
      
      if (!apiKey || baseTendies.length === 0) {
        return baseTendies;
      }
      
      // Process each tend individually since they may have different domains
      const enhancedTendies = await Promise.all(baseTendies.map(async (tendy) => {
        const tendyDomain = tendy.domain;
        if (!tendyDomain) return tendy;
        
        // Calculate readiness for THIS tend's domain
        const domainReadiness = calculateDomainReadiness(tendyDomain, userProfile, goals, weeklyHabits, journalEntries);
        
        console.log(`Tend personalization for ${domainReadiness.domainName} (${tendy.isWeekendTend ? 'weekend' : 'daily'}):`, {
          tier: domainReadiness.tier,
          aiPct: `${domainReadiness.aiPct}%`,
          canGenerateAI: domainReadiness.canGenerateAI,
          canPersonalize: domainReadiness.canPersonalize,
        });
        
        // If no AI capability AND no personalization capability, return pool template as-is
        if (!domainReadiness.canGenerateAI && !domainReadiness.canPersonalize) {
          console.log(`No ${domainReadiness.domainName} context - using pool template`);
          return {
            ...tendy,
            personalizationNote: `No ${domainReadiness.domainName.toLowerCase()} info yet - add goals or share details!`
          };
        }
        
        const roll = Math.random() * 100; // 0-100
        
        // Decision 1: Try AI generation?
        if (roll < domainReadiness.aiPct && domainReadiness.canGenerateAI) {
          console.log(`ü§ñ AI generation for ${tendy.minutes}min (roll: ${roll.toFixed(1)} < ${domainReadiness.aiPct}%)`);
          const freshText = await generateFreshAITend(
            tendy.domain, 
            tendy.difficulty, 
            tendy.type, 
            userProfile, 
            apiKey,
            goals,
            weeklyHabits,
            journalEntries,
            tendy.minutes
          );
          
          if (freshText) {
            return {
              ...tendy,
              text: freshText,
              isAIGenerated: true,
              isPersonalized: true,
              source: 'ai',
              domainReadiness: domainReadiness.tier,
            };
          }
          // If AI generation failed, fall through to pool
          console.log(`AI generation failed, falling back to pool`);
        }
        
        // Decision 2: Use pool template, then try to personalize if we can
        if (domainReadiness.canPersonalize) {
          console.log(`üìù Pool template + personalization for ${tendy.minutes}min`);
          const personalizedText = await personalizeTemplate(tendy.originalText, userProfile, tendy.domain, apiKey);
          
          const wasPersonalized = personalizedText !== tendy.originalText;
          return {
            ...tendy,
            text: personalizedText,
            isPersonalized: wasPersonalized,
            source: wasPersonalized ? 'pool+personalized' : 'pool',
            domainReadiness: domainReadiness.tier,
          };
        }
        
        // No personalization possible - use pool template as-is
        console.log(`üìã Pool template (no personalization available) for ${tendy.minutes}min`);
        return {
          ...tendy,
          source: 'pool',
          domainReadiness: domainReadiness.tier,
        };
      }));
      
      return enhancedTendies;
    }

    const VALUE_KEYWORDS = {
      'Freedom': ['freedom', 'free', 'autonomy', 'independent', 'flexible'],
      'Connection': ['connection', 'connected', 'together', 'relationship', 'partner', 'love', 'present', 'presence'],
      'Growth': ['growth', 'grow', 'learn', 'improve', 'better', 'develop'],
      'Peace': ['peace', 'calm', 'peaceful', 'stress', 'less stressed', 'relaxed', 'balance'],
      'Health': ['health', 'healthy', 'fit', 'strong', 'energy', 'wellness'],
      'Adventure': ['adventure', 'travel', 'explore', 'new', 'exciting', 'experience'],
      'Creativity': ['creative', 'creativity', 'create', 'art', 'make', 'build'],
      'Family': ['family', 'kids', 'children', 'parents', 'home'],
      'Joy': ['joy', 'happy', 'happiness', 'fun', 'laugh', 'enjoy'],
      'Security': ['security', 'secure', 'stable', 'stability', 'safe'],
    };

    const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const MONTH_FULL = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    const PHASES = { EXPLORE: 'explore', GROUND: 'ground', REVEAL: 'reveal', PLAN: 'plan' };
    const CENTER_VIEWS = { YEAR: 'year', CALENDAR: 'calendar', WEEKLY: 'weekly', DAILY: 'daily', INSIGHTS: 'insights', TENDY: 'tendy', JOURNAL: 'journal' };
    
    // Onboarding steps configuration
    const ONBOARDING_STEPS = {
      0: { id: 'vlq', label: 'Values', icon: 'üíö', required: true },
      1: { id: 'goals', label: 'Goals', icon: 'üéØ', required: false }, // Goals OR prompts
      2: { id: 'habits', label: 'Habits', icon: 'üîÑ', required: false }, // Optional
      3: { id: 'quiz', label: 'Quiz', icon: 'üå∏', required: false },
      4: { id: 'lifemap', label: 'Life Map', icon: 'üó∫Ô∏è', required: false },
      5: { id: 'compass', label: 'Compass', icon: 'üß≠', required: false },
      6: { id: 'tend', label: 'First Tend', icon: 'üå±', required: true },
    };

    // ============ MAIN APP ============
    // ============ VLQ ASSESSMENT ============
    function VLQAssessment({ vlqScores, setVlqScores, vlqStep, setVlqStep, onComplete }) {
      
      // Calculate gaps for summary
      const getGaps = () => {
        return VLQ_ORDER.map(key => ({
          key,
          name: VLQ_DOMAINS[key].name,
          icon: VLQ_DOMAINS[key].icon,
          color: VLQ_DOMAINS[key].color,
          importance: vlqScores[key]?.importance || 5,
          consistency: vlqScores[key]?.consistency || 5,
          gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)
        })).sort((a, b) => b.gap - a.gap);
      };

      const vlqStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        card: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '24px',
          padding: '2.5rem',
          maxWidth: '700px',
          width: '100%',
          boxShadow: '0 4px 24px rgba(0,0,0,0.06)',
          border: '1px solid var(--border)',
        },
        header: {
          textAlign: 'center',
          marginBottom: '2rem',
        },
        stepIndicator: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
          textTransform: 'uppercase',
          letterSpacing: '0.1em',
          marginBottom: '0.5rem',
        },
        title: {
          fontSize: '1.5rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          fontSize: '0.9rem',
          color: 'var(--text-muted)',
          lineHeight: 1.5,
        },
        valuesGrid: {
          display: 'flex',
          flexDirection: 'column',
          gap: '0.75rem',
          marginBottom: '2rem',
        },
        valueRow: {
          display: 'grid',
          gridTemplateColumns: '140px 1fr 40px',
          alignItems: 'center',
          gap: '1rem',
          padding: '0.75rem 1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
        },
        valueInfo: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        valueIcon: {
          fontSize: '1.1rem',
        },
        valueName: {
          fontSize: '0.85rem',
          color: 'var(--text)',
          fontWeight: 500,
        },
        slider: {
          width: '100%',
          height: '6px',
          borderRadius: '3px',
          appearance: 'none',
          background: 'var(--border)',
          outline: 'none',
          cursor: 'pointer',
        },
        valueScore: {
          fontSize: '1.1rem',
          fontWeight: 600,
          textAlign: 'center',
          fontFamily: "'Fraunces', serif",
        },
        buttons: {
          display: 'flex',
          gap: '1rem',
          justifyContent: 'center',
        },
        backButton: {
          padding: '0.875rem 2rem',
          backgroundColor: 'transparent',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          color: 'var(--text-muted)',
          fontSize: '0.95rem',
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
        nextButton: {
          padding: '0.875rem 2.5rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '0.95rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
        hint: {
          textAlign: 'center',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
          marginBottom: '1.5rem',
          fontStyle: 'italic',
        },
        // Summary styles
        summarySection: {
          marginBottom: '1.5rem',
        },
        summarySectionTitle: {
          fontSize: '0.75rem',
          fontWeight: 600,
          textTransform: 'uppercase',
          letterSpacing: '0.1em',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
        },
        summaryItem: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.75rem',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '10px',
          marginBottom: '0.5rem',
        },
        summaryItemIcon: {
          fontSize: '1.25rem',
        },
        summaryItemName: {
          flex: 1,
          fontSize: '0.9rem',
          color: 'var(--text)',
        },
        summaryItemScores: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          fontSize: '0.85rem',
        },
        summaryItemGap: {
          fontSize: '0.75rem',
          padding: '0.2rem 0.5rem',
          borderRadius: '8px',
          fontWeight: 500,
        },
        intro: {
          textAlign: 'center',
        },
        introTitle: {
          fontSize: '2rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '1rem',
        },
        introText: {
          fontSize: '1rem',
          color: 'var(--text-muted)',
          lineHeight: 1.7,
          marginBottom: '2rem',
        },
        startButton: {
          padding: '1rem 3rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
        },
      };

      const handleImportanceChange = (key, value) => {
        setVlqScores(prev => ({
          ...prev,
          [key]: { ...prev[key], importance: value }
        }));
      };

      const handleConsistencyChange = (key, value) => {
        setVlqScores(prev => ({
          ...prev,
          [key]: { ...prev[key], consistency: value }
        }));
      };

      // Intro screen
      if (vlqStep === -1) {
        return (
          <div style={vlqStyles.container}>
            <div style={{...vlqStyles.card, ...vlqStyles.intro, maxWidth: '500px'}}>
              <svg width="80" height="80" viewBox="0 0 80 80" fill="none" style={{marginBottom: '1.5rem', opacity: 0.8}}>
                <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="1.5" strokeLinecap="round"/>
                <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
                <circle cx="40" cy="70" r="3" fill="none" stroke="var(--accent)" strokeWidth="1.5"/>
              </svg>
              <h1 style={vlqStyles.introTitle}>Welcome to Tend</h1>
              <p style={{...vlqStyles.introText, marginBottom: '1.5rem'}}>
                Tend helps you design a life aligned with your values ‚Äî not just survive, but live intentionally and mindfully.
              </p>
              <p style={vlqStyles.introText}>
                To get started, you'll reflect on <strong>10 areas of life</strong>. For each one, you'll rate:
                <br /><br />
                <em>How important is this to you?</em>
                <br />
                <em>How consistently have you been living it?</em>
                <br /><br />
                Think deeply, but don't worry about perfection ‚Äî you can reassess your values anytime.
              </p>
              <button style={vlqStyles.startButton} onClick={() => setVlqStep(0)}>
                Let's Begin
              </button>
            </div>
          </div>
        );
      }

      // Step 0: Importance ratings for all values
      if (vlqStep === 0) {
        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <div style={vlqStyles.stepIndicator}>Step 1 of 2</div>
                <h2 style={vlqStyles.title}>How important is each area to you?</h2>
                <p style={vlqStyles.subtitle}>
                  Rate each value from 1 (not important) to 10 (extremely important).
                </p>
              </div>
              
              <p style={vlqStyles.hint}>
                Not everything can be a 10 ‚Äî what truly matters most?
              </p>

              <div style={vlqStyles.valuesGrid}>
                {VLQ_ORDER.map(key => {
                  const domain = VLQ_DOMAINS[key];
                  const score = vlqScores[key]?.importance || 5;
                  return (
                    <div key={key} style={vlqStyles.valueRow}>
                      <div style={vlqStyles.valueInfo}>
                        <span style={vlqStyles.valueIcon}>{domain.icon}</span>
                        <span style={vlqStyles.valueName}>{domain.name}</span>
                      </div>
                      <input
                        type="range"
                        min="1"
                        max="10"
                        value={score}
                        onChange={(e) => handleImportanceChange(key, parseInt(e.target.value))}
                        style={{...vlqStyles.slider, accentColor: domain.color}}
                      />
                      <span style={{...vlqStyles.valueScore, color: domain.color}}>
                        {score}
                      </span>
                    </div>
                  );
                })}
              </div>

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(-1)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={() => setVlqStep(1)}>
                  Next
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Step 1: Consistency ratings for all values
      if (vlqStep === 1) {
        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <div style={vlqStyles.stepIndicator}>Step 2 of 2</div>
                <h2 style={vlqStyles.title}>How much have you been living each value?</h2>
                <p style={vlqStyles.subtitle}>
                  Rate your actual behavior ‚Äî not what you wish, but what you've actually been doing.
                </p>
              </div>
              
              <p style={vlqStyles.hint}>
                1 = not at all lately ¬∑ 10 = it's a major part of my life right now
              </p>

              <div style={vlqStyles.valuesGrid}>
                {VLQ_ORDER.map(key => {
                  const domain = VLQ_DOMAINS[key];
                  const score = vlqScores[key]?.consistency || 5;
                  return (
                    <div key={key} style={vlqStyles.valueRow}>
                      <div style={vlqStyles.valueInfo}>
                        <span style={vlqStyles.valueIcon}>{domain.icon}</span>
                        <span style={vlqStyles.valueName}>{domain.name}</span>
                      </div>
                      <input
                        type="range"
                        min="1"
                        max="10"
                        value={score}
                        onChange={(e) => handleConsistencyChange(key, parseInt(e.target.value))}
                        style={{...vlqStyles.slider, accentColor: domain.color}}
                      />
                      <span style={{...vlqStyles.valueScore, color: domain.color}}>
                        {score}
                      </span>
                    </div>
                  );
                })}
              </div>

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(0)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={() => setVlqStep(2)}>
                  See Results
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Step 2: Summary screen
      if (vlqStep === 2) {
        const gaps = getGaps();
        const growthAreas = gaps.filter(g => g.gap >= 3);
        // Strengths: high importance AND consistency, but NOT already a growth area (gap < 3)
        const strengths = gaps.filter(g => g.importance >= 6 && g.consistency >= 6 && g.gap < 3);
        const lowerPriority = gaps.filter(g => g.importance <= 5);
        // Middle ground: importance > 5, not a strength, not a growth area
        const middleGround = gaps.filter(g => 
          g.importance > 5 && g.gap < 3 && (g.consistency < 6 || g.importance < 6)
        );

        return (
          <div style={vlqStyles.container}>
            <div style={vlqStyles.card}>
              <div style={vlqStyles.header}>
                <h2 style={vlqStyles.title}>Your Values Landscape</h2>
                <p style={vlqStyles.subtitle}>
                  Here's what you shared about what matters and where you are.
                </p>
              </div>

              {growthAreas.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>üå± Growth Areas</h3>
                  <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem', fontStyle: 'italic'}}>
                    High importance, room to grow
                  </p>
                  {growthAreas.map(item => (
                    <div key={item.key} style={vlqStyles.summaryItem}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: item.color, fontWeight: 600}}>{item.importance}</span>
                        <span style={{color: 'var(--text-muted)', margin: '0 0.25rem'}}>|</span>
                        <span style={{color: 'var(--text-muted)'}}>{item.consistency}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {strengths.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>üí™ Strengths</h3>
                  <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem', fontStyle: 'italic'}}>
                    Important and you're living it
                  </p>
                  {strengths.map(item => (
                    <div key={item.key} style={vlqStyles.summaryItem}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: item.color, fontWeight: 600}}>{item.importance}</span>
                        <span style={{color: 'var(--text-muted)', margin: '0 0.25rem'}}>|</span>
                        <span style={{color: item.color, fontWeight: 600}}>{item.consistency}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {middleGround.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>üîÑ Maintaining</h3>
                  <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem', fontStyle: 'italic'}}>
                    Important and doing okay
                  </p>
                  {middleGround.map(item => (
                    <div key={item.key} style={vlqStyles.summaryItem}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: item.color, fontWeight: 600}}>{item.importance}</span>
                        <span style={{color: 'var(--text-muted)', margin: '0 0.25rem'}}>|</span>
                        <span style={{color: 'var(--text-muted)'}}>{item.consistency}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {lowerPriority.length > 0 && (
                <div style={vlqStyles.summarySection}>
                  <h3 style={vlqStyles.summarySectionTitle}>‚ö™ Lower Priority Right Now</h3>
                  <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem', fontStyle: 'italic'}}>
                    Less important to you at this time
                  </p>
                  {lowerPriority.map(item => (
                    <div key={item.key} style={{...vlqStyles.summaryItem, opacity: 0.7}}>
                      <span style={vlqStyles.summaryItemIcon}>{item.icon}</span>
                      <span style={vlqStyles.summaryItemName}>{item.name}</span>
                      <div style={vlqStyles.summaryItemScores}>
                        <span style={{color: 'var(--text-muted)'}}>{item.importance}</span>
                        <span style={{color: 'var(--text-muted)', margin: '0 0.25rem'}}>|</span>
                        <span style={{color: 'var(--text-muted)'}}>{item.consistency}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <div style={vlqStyles.buttons}>
                <button style={vlqStyles.backButton} onClick={() => setVlqStep(1)}>
                  Back
                </button>
                <button style={vlqStyles.nextButton} onClick={onComplete}>
                  Chat with Tend ‚Üí
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    // ============ AUTH MODAL ============
    function AuthModal({ onSuccess }) {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isLogin) {
            await auth.signInWithEmailAndPassword(email, password);
          } else {
            await auth.createUserWithEmailAndPassword(email, password);
          }
          onSuccess();
        } catch (err) {
          console.error('Auth error:', err);
          if (err.code === 'auth/email-already-in-use') {
            setError('This email is already registered. Try logging in.');
          } else if (err.code === 'auth/invalid-email') {
            setError('Please enter a valid email address.');
          } else if (err.code === 'auth/weak-password') {
            setError('Password should be at least 6 characters.');
          } else if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
            setError('Invalid email or password.');
          } else {
            setError(err.message);
          }
        } finally {
          setLoading(false);
        }
      };

      const authStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        card: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '24px',
          padding: '3rem',
          maxWidth: '400px',
          width: '100%',
          boxShadow: '0 4px 24px rgba(0,0,0,0.06)',
          border: '1px solid var(--border)',
          textAlign: 'center',
        },
        title: {
          fontSize: '1.75rem',
          fontFamily: "'Fraunces', serif",
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          fontSize: '0.9rem',
          color: 'var(--text-muted)',
          marginBottom: '2rem',
        },
        form: {
          display: 'flex',
          flexDirection: 'column',
          gap: '1rem',
        },
        input: {
          padding: '0.875rem 1rem',
          border: '1px solid var(--border)',
          borderRadius: '10px',
          fontSize: '0.95rem',
          fontFamily: "'DM Sans', sans-serif",
          backgroundColor: 'var(--bg-elevated)',
          color: 'var(--text)',
          outline: 'none',
        },
        button: {
          padding: '1rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          fontFamily: "'DM Sans', sans-serif",
          marginTop: '0.5rem',
        },
        toggle: {
          marginTop: '1.5rem',
          fontSize: '0.85rem',
          color: 'var(--text-muted)',
        },
        toggleLink: {
          color: 'var(--accent)',
          cursor: 'pointer',
          fontWeight: 500,
        },
        error: {
          color: '#d32f2f',
          fontSize: '0.85rem',
          marginTop: '0.5rem',
          padding: '0.5rem',
          backgroundColor: '#ffebee',
          borderRadius: '8px',
        },
      };

      return (
        <div style={authStyles.container}>
          <div style={authStyles.card}>
            <svg width="60" height="60" viewBox="0 0 80 80" fill="none" style={{marginBottom: '1rem', opacity: 0.8}}>
              <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="1.5" strokeLinecap="round"/>
              <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
              <circle cx="40" cy="70" r="3" fill="none" stroke="var(--accent)" strokeWidth="1.5"/>
            </svg>
            <h1 style={authStyles.title}>{isLogin ? 'Welcome back' : 'Create account'}</h1>
            <p style={authStyles.subtitle}>
              {isLogin ? 'Sign in to continue your journey' : 'Start designing your intentional life'}
            </p>

            <form style={authStyles.form} onSubmit={handleSubmit}>
              <input
                type="email"
                placeholder="Email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                style={authStyles.input}
                required
              />
              <input
                type="password"
                placeholder="Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                style={authStyles.input}
                required
              />
              {error && <div style={authStyles.error}>{error}</div>}
              <button type="submit" style={authStyles.button} disabled={loading}>
                {loading ? 'Please wait...' : (isLogin ? 'Sign In' : 'Create Account')}
              </button>
            </form>

            <p style={authStyles.toggle}>
              {isLogin ? "Don't have an account? " : "Already have an account? "}
              <span style={authStyles.toggleLink} onClick={() => { setIsLogin(!isLogin); setError(''); }}>
                {isLogin ? 'Sign up' : 'Sign in'}
              </span>
            </p>
          </div>
        </div>
      );
    }

    function TendApp() {
      // Auth state
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [dataLoaded, setDataLoaded] = useState(false);
      const [sessionGreeted, setSessionGreeted] = useState(false);
      const [showLoadingIcon, setShowLoadingIcon] = useState(true);
      const [appMode, setAppMode] = useState(null); // null = choose, 'journal', 'plan'

      const [phase, setPhase] = useState(PHASES.EXPLORE);
      const [vlqScores, setVlqScores] = useState({
        family: { importance: 5, consistency: 5 },
        partner: { importance: 5, consistency: 5 },
        friendships: { importance: 5, consistency: 5 },
        career: { importance: 5, consistency: 5 },
        education: { importance: 5, consistency: 5 },
        recreation: { importance: 5, consistency: 5 },
        spirituality: { importance: 5, consistency: 5 },
        community: { importance: 5, consistency: 5 },
        health: { importance: 5, consistency: 5 },
        mentalHealth: { importance: 5, consistency: 5 },
      });
      const [vlqCompleted, setVlqCompleted] = useState(false);
      const [vlqStep, setVlqStep] = useState(-1); // -1 for intro, 0-9 for domains, 10 for summary
      const [values, setValues] = useState([]);
      const [lifeAreaRatings, setLifeAreaRatings] = useState({
        health: { satisfaction: null, intention: null },
        relationships: { satisfaction: null, intention: null },
        career: { satisfaction: null, intention: null },
        finances: { satisfaction: null, intention: null },
        growth: { satisfaction: null, intention: null },
        fun: { satisfaction: null, intention: null }
      });
      const [lifeAreasCompleted, setLifeAreasCompleted] = useState(false);
      const [lifeAreasMode, setLifeAreasMode] = useState(false);
      const [currentLifeAreaIndex, setCurrentLifeAreaIndex] = useState(0);
      const [waitingForSatisfaction, setWaitingForSatisfaction] = useState(true);
      const [isLastLifeAreaResponse, setIsLastLifeAreaResponse] = useState(false);
      const lifeAreaOrder = ['health', 'relationships', 'career', 'finances', 'growth', 'fun'];
      const lifeAreaDescriptions = {
        health: 'physical energy, movement, sleep, how your body feels',
        relationships: 'partner, family, friendships, feeling connected',
        career: 'work satisfaction, growth, meaning in what you do',
        finances: 'financial security, freedom, relationship with money',
        growth: 'learning, self-improvement, becoming who you want to be',
        fun: 'play, adventure, hobbies, things that bring you joy'
      };
      const [events, setEvents] = useState([]);
      const [goals, setGoals] = useState([]);
      const [notes, setNotes] = useState(''); // Planning notes in sidebar
      const [journalEntries, setJournalEntries] = useState({}); // Daily journal entries by date
      const [monthlyReviews, setMonthlyReviews] = useState({}); // Monthly reviews by month (YYYY-MM)
      const [yearlyReflections, setYearlyReflections] = useState({}); // Yearly reflections by year
      const [seasonIntentions, setSeasonIntentions] = useState({
        winter: '', spring: '', summer: '', fall: ''
      });
      
      // Onboarding system (1-3 steps)
      // 1: Life Map (prompts + goals + habits per focus area), 2: Quiz (optional), 3: First Tend
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [onboardingCompleted, setOnboardingCompleted] = useState(false);
      const [showOnboardingOverlay, setShowOnboardingOverlay] = useState(null); // 'lifemap', 'quiz', or null
      const [currentOnboardingArea, setCurrentOnboardingArea] = useState(null); // Which life area is being focused on
      
      const [weeklyHabits, setWeeklyHabits] = useState([]);
      const [habitCompletions, setHabitCompletions] = useState({}); // { '2026-01-20': { daily: [id1, id2], weekly: [id3] } }
      
      // Tendy system state
      const [todaysTendies, setTodaysTendies] = useState([]);
      const [tendyHistory, setTendyHistory] = useState([]); // Completed tendies
      const [tendyPoints, setTendyPoints] = useState(0);
      const [tendyStreak, setTendyStreak] = useState(0);
      const [flexPoints, setFlexPoints] = useState(3); // For rerolling tendies
      const [flexPointsTracking, setFlexPointsTracking] = useState({
        lastJournalDate: null,
        lastWeeklyIntentionWeek: null,
        lastCustomTendyWeek: null,
        lastMondayBonusWeek: null,
        last7DayStreakDate: null,
        lastMonthlyReviewMonth: null,
        completedGoalIds: []
      });
      const [weeklyCustomTendy, setWeeklyCustomTendy] = useState(null); // { text, status: 'pending'|'approved'|'rejected', weekOf, submittedAt }
      
      // Knowledge & Intelligence Layer
      const [savedConversations, setSavedConversations] = useState({}); // Archive of important conversations
      const [currentConversationType, setCurrentConversationType] = useState('general'); // 'general' | 'monthly_review' | 'yearly_review' | 'onboarding'
      const [userProfile, setUserProfile] = useState({
        name: '',
        occupation: '',
        location: '',
        lifeStage: '',
        tendPreferences: {}
      });
      
      // Chat history system
      const [chatHistory, setChatHistory] = useState([]); // Array of past chats
      const [currentChatId, setCurrentChatId] = useState(null);
      const [messages, setMessages] = useState([]);
      const [inputValue, setInputValue] = useState('');
      const [isTyping, setIsTyping] = useState(false);
      const [exchangeCount, setExchangeCount] = useState(0);
      const [showChatHistory, setShowChatHistory] = useState(false);
      const messagesEndRef = useRef(null);
      const chatContainerRef = useRef(null);

      const [revealed, setRevealed] = useState(false);
      const [activeTab, setActiveTab] = useState('lifeareas');
      const [sidebarExpanded, setSidebarExpanded] = useState(false);
      const [sidebarWidth, setSidebarWidth] = useState(240);
      const [isResizingSidebar, setIsResizingSidebar] = useState(false);
      const [centerView, setCenterView] = useState(CENTER_VIEWS.YEAR);
      const [expandedEvent, setExpandedEvent] = useState(null);
      const [showEventModal, setShowEventModal] = useState(false);
      const [showGoalModal, setShowGoalModal] = useState(false);
      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [apiKey, setApiKey] = useState(() => localStorage.getItem('tend_api_key') || '');
      const [chatWidth, setChatWidth] = useState(320);
      const [chatMinimized, setChatMinimized] = useState(false);
      const [showChatOverlay, setShowChatOverlay] = useState(false); // Full-screen chat after onboarding
      const [isResizing, setIsResizing] = useState(false);
      const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
      const [showAdminDashboard, setShowAdminDashboard] = useState(() => {
        const params = new URLSearchParams(window.location.search);
        return params.get('admin') === 'true';
      });

      // Get "Focus on" life areas (gap >= 2)
      const getFocusAreas = () => {
        return VLQ_ORDER
          .map(key => ({
            key,
            importance: vlqScores[key]?.importance || 5,
            consistency: vlqScores[key]?.consistency || 5,
            gap: (vlqScores[key]?.importance || 5) - (vlqScores[key]?.consistency || 5)
          }))
          .filter(a => a.gap >= 2)
          .map(a => a.key);
      };

      // Check if onboarding step is complete
      const isStepComplete = (step) => {
        const focusAreas = getFocusAreas();
        const prefs = userProfile?.tendPreferences || {};
        
        switch(step) {
          case 1: // Life Map - 1 goal AND 1 prompt per focus area
            for (const area of focusAreas) {
              const hasPrompt = prefs.structuredInfo?.[area] && Object.values(prefs.structuredInfo[area]).some(v => v) || prefs.lifeAreaNotes?.[area];
              const hasGoal = goals.some(g => g.lifeArea === area);
              // Step is complete if user has BOTH a prompt AND a goal
              if (!hasPrompt || !hasGoal) return false;
            }
            return true;
          case 2: // Gardener Quiz - optional, complete only if they took it
            return !!prefs.gardenerType;
          case 3: // Daily Tend - has completed a tend
            return todaysTendies.some(t => t.completed);
          default:
            return false;
        }
      };

      // Get onboarding progress info for UI
      const getOnboardingProgress = () => {
        const focusAreas = getFocusAreas();
        const prefs = userProfile?.tendPreferences || {};
        
        // Check completion per focus area for step 1 (requires BOTH goal AND prompt)
        const focusAreaProgress = focusAreas.map(area => {
          const hasPrompt = prefs.structuredInfo?.[area] && Object.values(prefs.structuredInfo[area]).some(v => v) || prefs.lifeAreaNotes?.[area];
          const hasGoal = goals.some(g => g.lifeArea === area);
          const areaGoalIds = goals.filter(g => g.lifeArea === area).map(g => g.id);
          const hasLinkedHabit = weeklyHabits.some(h => h.lifeArea === area && areaGoalIds.includes(h.goalId));
          // Complete if has BOTH prompt AND goal
          return { area, hasPrompt, hasGoal, hasLinkedHabit, complete: hasPrompt && hasGoal };
        });
        
        const completeFocusAreas = focusAreaProgress.filter(p => p.complete).length;
        
        return {
          1: {
            current: completeFocusAreas,
            required: focusAreas.length,
            focusAreaProgress
          },
          2: { current: prefs.gardenerType ? 1 : 0, required: 0 }, // Optional
          3: { current: todaysTendies.some(t => t.completed) ? 1 : 0, required: 1 },
        };
      };

      // Auth state listener
      useEffect(() => {
        const unsubscribe = auth.onAuthStateChanged((firebaseUser) => {
          setUser(firebaseUser);
          setAuthLoading(false);
          if (firebaseUser) {
            // Load user data from Firestore
            loadUserData(firebaseUser.uid);
          } else {
            // User logged out - reset state to prevent data leakage
            setDataLoaded(false);
          }
        });
        return () => unsubscribe();
      }, []);

      // Show loading icon for at least 1.5 seconds
      useEffect(() => {
        const timer = setTimeout(() => {
          setShowLoadingIcon(false);
        }, 1500);
        return () => clearTimeout(timer);
      }, []);

      // Load user data from Firestore
      const loadUserData = async (userId) => {
        try {
          const doc = await db.collection('users').doc(userId).get();
          if (doc.exists) {
            const data = doc.data();
            // Fix null VLQ scores (migration for users who didn't move sliders)
            if (data.vlqScores) {
              const migratedScores = {};
              let needsMigration = false;
              Object.entries(data.vlqScores).forEach(([domain, scores]) => {
                migratedScores[domain] = {
                  importance: scores?.importance ?? 5,
                  consistency: scores?.consistency ?? 5
                };
                if (scores?.importance === null || scores?.consistency === null) {
                  needsMigration = true;
                }
              });
              setVlqScores(migratedScores);
              // Save migrated scores back to Firestore
              if (needsMigration && data.vlqCompleted) {
                console.log('Migrating null VLQ scores to default value of 5');
                db.collection('users').doc(userId).update({ vlqScores: migratedScores });
              }
            }
            if (data.vlqCompleted) setVlqCompleted(data.vlqCompleted);
            if (data.events) setEvents(data.events);
            if (data.goals) setGoals(data.goals);
            if (data.notes) setNotes(data.notes);
            if (data.journalEntries) setJournalEntries(data.journalEntries);
            if (data.monthlyReviews) setMonthlyReviews(data.monthlyReviews);
            if (data.yearlyReflections) setYearlyReflections(data.yearlyReflections);
            if (data.seasonIntentions) setSeasonIntentions(data.seasonIntentions);
            // Fix duplicate IDs in habits (migration for existing data)
            if (data.weeklyHabits) {
              const seen = new Set();
              const hasDuplicates = data.weeklyHabits.some(h => {
                if (seen.has(h.id)) return true;
                seen.add(h.id);
                return false;
              });
              if (hasDuplicates) {
                // Regenerate all IDs if duplicates found
                const fixed = data.weeklyHabits.map((h, i) => ({
                  ...h,
                  id: `${Date.now()}-weekly-${i}-${Math.random().toString(36).substr(2, 9)}`
                }));
                setWeeklyHabits(fixed);
                setHabitCompletions({}); // Clear completions since IDs changed
                console.log('Fixed duplicate weekly habit IDs');
              } else {
                setWeeklyHabits(data.weeklyHabits);
              }
            }
            if (data.habitCompletions && !data.weeklyHabits?.some((h, i, arr) => arr.findIndex(x => x.id === h.id) !== i)) {
              setHabitCompletions(data.habitCompletions);
            }
            // Check if todaysTendies are actually from today (using LOCAL date, not UTC)
            const today = getLocalDateString();
            const storedTendiesDate = data.todaysTendies?.[0]?.date;
            const storedTendyId = data.todaysTendies?.[0]?.id;
            const generatedAt = data.todaysTendies?.[0]?.generatedAt;
            const isSelectedButNotCompleted = data.todaysTendies?.some(t => t.selected) && !data.todaysTendies?.some(t => t.completed);
            
            // Check staleness - if no generatedAt (old format) or generated more than 18 hours ago, consider stale
            const isStale = !generatedAt || (new Date() - new Date(generatedAt)) > (18 * 60 * 60 * 1000);
            
            console.log('Firebase load - Tendies check:', { 
              today, 
              storedTendiesDate, 
              storedTendyId,
              generatedAt,
              isStale,
              isSelectedButNotCompleted,
              hasVlqScores: !!data.vlqScores 
            });
            
            // Check if tendies are old format (has difficulty=2, which we no longer use)
            const hasOldFormat = data.todaysTendies?.some(t => t.difficulty === 2);
            
            // Check if tendies are from today by BOTH date field AND id prefix, AND not stale, AND not old format
            const tendiesAreFromToday = data.todaysTendies && 
              data.todaysTendies.length > 0 && 
              storedTendiesDate === today &&
              storedTendyId?.startsWith(today) &&
              !isStale &&
              !hasOldFormat;
            
            if (tendiesAreFromToday) {
              // Tendies are from today, use them
              console.log('Using stored tendies from today');
              setTodaysTendies(data.todaysTendies);
            } else if (data.vlqScores && Object.keys(data.vlqScores).length > 0) {
              // Tendies are old, stale, old format, or missing - generate new ones
              const previousDomain = data.todaysTendies?.[0]?.domain || null;
              console.log('Generating fresh daily tendies for', today, '- stored date was', storedTendiesDate, 'isStale:', isStale, 'hasOldFormat:', hasOldFormat, 'previousDomain:', previousDomain);
              
              // Get API key for personalization
              const storedApiKey = localStorage.getItem('tend_api_key') || '';
              
              if (storedApiKey && data.userProfile) {
                // Use async personalized generation
                generatePersonalizedTendies(
                  data.vlqScores, 
                  data.tendyHistory || [], 
                  previousDomain, 
                  data.userProfile, 
                  storedApiKey,
                  data.goals || [],
                  data.weeklyHabits || [],
                  data.journalEntries || {}
                ).then(newTendies => {
                  setTodaysTendies(newTendies);
                }).catch(err => {
                  console.error('Personalization failed, using base tendies:', err);
                  const newTendies = generateDailyTendies(data.vlqScores, data.tendyHistory || [], previousDomain);
                  setTodaysTendies(newTendies);
                });
              } else {
                // No API key or profile, use sync version
                const newTendies = generateDailyTendies(data.vlqScores, data.tendyHistory || [], previousDomain);
                setTodaysTendies(newTendies);
              }
            } else {
              console.log('No VLQ scores available, cannot generate tendies');
            }
            if (data.tendyHistory) setTendyHistory(data.tendyHistory);
            if (data.tendyPoints) setTendyPoints(data.tendyPoints);
            if (data.tendyStreak) setTendyStreak(data.tendyStreak);
            if (data.flexPoints !== undefined) setFlexPoints(data.flexPoints);
            if (data.flexPointsTracking) setFlexPointsTracking(data.flexPointsTracking);
            if (data.weeklyCustomTendy) setWeeklyCustomTendy(data.weeklyCustomTendy);
            if (data.savedConversations) setSavedConversations(data.savedConversations);
            if (data.userProfile) setUserProfile(data.userProfile);
            // Load chat history
            if (data.chatHistory) setChatHistory(data.chatHistory);
            
            // Check if user is still in onboarding
            const isStillOnboarding = !data.onboardingCompleted && data.onboardingStep;
            
            // For onboarding users: restore current chat directly (don't archive it)
            if (isStillOnboarding && data.currentChat && data.currentChat.messages && data.currentChat.messages.length > 0) {
              console.log('Restoring onboarding chat from currentChat');
              setMessages(data.currentChat.messages);
              setExchangeCount(data.currentChat.exchangeCount || data.currentChat.messages.length);
              setSessionGreeted(true); // Don't add another greeting
            } else {
              // Archive previous chat to history if it had real conversation (more than 1 message)
              if (data.currentChat && data.currentChat.messages && data.currentChat.messages.length > 1) {
                const prevChat = {
                  id: data.currentChat.id || Date.now().toString(),
                  messages: data.currentChat.messages,
                  createdAt: data.currentChat.createdAt || new Date().toISOString(),
                  title: generateChatTitle(data.currentChat.messages)
                };
                setChatHistory(prev => [prevChat, ...(prev || [])].slice(0, 50)); // Keep last 50 chats
              }
              // Start fresh - messages will be set by the greeting effect
              setMessages([]);
              setExchangeCount(0);
            }
            setCurrentChatId(Date.now().toString());
            // Trends are calculated, not loaded
            if (data.revealed) setRevealed(data.revealed);
            if (data.phase) setPhase(data.phase);
            // Load onboarding state
            if (data.onboardingStep !== undefined) setOnboardingStep(data.onboardingStep);
            if (data.onboardingCompleted !== undefined) setOnboardingCompleted(data.onboardingCompleted);
            if (data.currentOnboardingArea) setCurrentOnboardingArea(data.currentOnboardingArea);
            // For existing users who completed onboarding in old system, mark complete
            if (data.onboardingCompleted === undefined && data.vlqCompleted && (data.goals?.length > 0 || data.weeklyHabits?.length > 0)) {
              setOnboardingCompleted(true);
              setOnboardingStep(null);
            }
            // If VLQ was completed, skip to step 2 (after summary) and reveal content
            if (data.vlqCompleted) {
              setVlqStep(2);
              setRevealed(true);
            }
          } else {
            // New user - reset ALL state to defaults
            console.log('New user detected - resetting all state');
            setCurrentChatId(Date.now().toString());
            setUserProfile({ name: '', occupation: '', location: '', lifeStage: '', tendPreferences: {} });
            setMessages([]);
            setChatHistory([]);
            setVlqScores({
              family: { importance: null, consistency: null },
              partner: { importance: null, consistency: null },
              friendships: { importance: null, consistency: null },
              career: { importance: null, consistency: null },
              education: { importance: null, consistency: null },
              recreation: { importance: null, consistency: null },
              spirituality: { importance: null, consistency: null },
              community: { importance: null, consistency: null },
              health: { importance: null, consistency: null },
              mentalHealth: { importance: null, consistency: null },
            });
            setVlqCompleted(false);
            setVlqStep(-1);
            setEvents([]);
            setGoals([]);
            setNotes({});
            setJournalEntries({});
            setMonthlyReviews({});
            setYearlyReflections({});
            setSeasonIntentions({});
            setWeeklyHabits([]);
            setHabitCompletions({});
            setTodaysTendies([]);
            setTendyHistory([]);
            setTendyPoints(0);
            setTendyStreak(0);
            setFlexPoints(3); // Start with 3 flex points
            setFlexPointsTracking({});
            setWeeklyCustomTendy(null);
            setSavedConversations([]);
            setRevealed(false);
            setPhase(PHASES.EXPLORE);
            setShowSettingsModal(false);
            setOnboardingStep(1);
            setOnboardingCompleted(false);
            setCurrentOnboardingArea(null);
            setSessionGreeted(false);
            setExchangeCount(0);
            setCurrentConversationType(null);
          }
          setDataLoaded(true);
        } catch (error) {
          console.error('Error loading user data:', error);
          setDataLoaded(true);
        }
      };

      // Generate a title for a chat based on its messages
      const generateChatTitle = (msgs) => {
        if (!msgs || msgs.length === 0) return 'New chat';
        // Find first user message
        const firstUserMsg = msgs.find(m => m.role === 'user');
        if (firstUserMsg) {
          const text = firstUserMsg.content.replace(/<[^>]*>/g, '').trim();
          return text.length > 40 ? text.substring(0, 40) + '...' : text;
        }
        // Fall back to date
        const date = msgs[0].timestamp ? new Date(msgs[0].timestamp) : new Date();
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };
      const extractInsights = (messages) => {
        const allText = messages.map(m => m.content).join(' ').toLowerCase();
        const userMessages = messages.filter(m => m.role === 'user').map(m => m.content).join(' ');
        
        // Extract themes (simple keyword matching for now)
        const themeKeywords = {
          'work-life balance': /work.{0,20}life|balance|burnout|overwhelm/,
          'career': /career|job|work|profession|promotion/,
          'health': /health|fitness|exercise|wellness|sleep/,
          'relationships': /relationship|family|friend|partner|social/,
          'finances': /money|financial|budget|savings|income/,
          'personal growth': /learn|growth|development|skill|course/,
        };
        
        const themes = [];
        Object.entries(themeKeywords).forEach(([theme, regex]) => {
          if (regex.test(allText)) themes.push(theme);
        });
        
        // Simple mood detection
        const positiveWords = /great|good|happy|excited|wonderful|amazing|love|proud/;
        const challengeWords = /difficult|hard|struggle|stress|worry|anxious|overwhelm/;
        const positiveCount = (allText.match(positiveWords) || []).length;
        const challengeCount = (allText.match(challengeWords) || []).length;
        
        let mood = 'neutral';
        if (positiveCount > challengeCount + 2) mood = 'positive';
        else if (challengeCount > positiveCount + 2) mood = 'challenging';
        
        // OPTION C: Auto-extract user profile
        const profileExtraction = {};
        
        // Extract occupation
        const occupationPatterns = [
          /i(?:'m| am) a ([a-z\s]{3,30}(?:developer|designer|engineer|teacher|doctor|nurse|manager|consultant|analyst|writer|artist|student))/i,
          /i work as (?:a |an )?([a-z\s]{3,30})/i,
          /my job is ([a-z\s]{3,30})/i,
          /i'm (?:a |an )?([a-z\s]{3,30}(?:developer|designer|engineer|teacher|doctor|nurse|manager|consultant|analyst|writer|artist|student))/i
        ];
        for (const pattern of occupationPatterns) {
          const match = userMessages.match(pattern);
          if (match && match[1]) {
            profileExtraction.occupation = match[1].trim();
            break;
          }
        }
        
        // Extract location
        const locationPatterns = [
          /i live in ([a-z\s,]{3,40})/i,
          /i'm (?:from|in) ([a-z\s,]{3,40}(?:city|state|country|york|angeles|francisco|chicago|boston|seattle|austin|denver|portland))/i,
          /based in ([a-z\s,]{3,40})/i,
          /located in ([a-z\s,]{3,40})/i
        ];
        for (const pattern of locationPatterns) {
          const match = userMessages.match(pattern);
          if (match && match[1]) {
            profileExtraction.location = match[1].trim();
            break;
          }
        }
        
        // Extract life stage indicators
        const lifeStagePatterns = [
          /i have (\d+) (?:kids|children)/i,
          /i'm (married|single|divorced|engaged)/i,
          /i'm in my (twenties|thirties|forties|fifties|early 20s|late 20s|early 30s|late 30s|early 40s)/i,
          /(?:my )?(?:partner|spouse|husband|wife)/i
        ];
        const lifeStageIndicators = [];
        lifeStagePatterns.forEach(pattern => {
          const match = userMessages.match(pattern);
          if (match) {
            lifeStageIndicators.push(match[0]);
          }
        });
        if (lifeStageIndicators.length > 0) {
          profileExtraction.lifeStage = lifeStageIndicators.join(', ');
        }
        
        return {
          themes,
          mood,
          profileExtraction, // NEW: Auto-extracted profile
          extractedAt: new Date().toISOString()
        };
      };

      // Save current conversation if it's important
      const saveCurrentConversation = () => {
        if (messages.length === 0) return;
        
        // Only save certain types of conversations
        const typesToSave = ['monthly_review', 'yearly_review', 'onboarding', 'year_theme', 'values_exploration', 'life_design', 'general'];
        if (!typesToSave.includes(currentConversationType)) {
          // For general conversations, just extract insights but don't save full conversation
          const insights = extractInsights(messages);
          console.log('Extracted insights from general conversation:', insights);
          
          // OPTION C: Update user profile if new info extracted
          if (insights.profileExtraction) {
            setUserProfile(prev => ({
              ...prev,
              ...Object.fromEntries(
                Object.entries(insights.profileExtraction)
                  .filter(([_, value]) => value && !prev[_]) // Only add if not already set
              )
            }));
          }
          return;
        }
        
        const conversationId = `${currentConversationType}_${Date.now()}`;
        const insights = extractInsights(messages);
        
        // OPTION C: Update user profile from saved conversations too
        if (insights.profileExtraction) {
          setUserProfile(prev => ({
            ...prev,
            ...Object.fromEntries(
              Object.entries(insights.profileExtraction)
                .filter(([_, value]) => value && !prev[_]) // Only add if not already set
            )
          }));
        }
        
        setSavedConversations(prev => ({
          ...prev,
          [conversationId]: {
            type: currentConversationType,
            messages: [...messages],
            startedAt: messages[0]?.timestamp || new Date().toISOString(),
            lastMessageAt: new Date().toISOString(),
            insights
          }
        }));
        
        console.log(`Saved ${currentConversationType} conversation:`, conversationId);
      };

      // Wrapper to save conversation before switching modes
      const switchAppMode = (newMode) => {
        if (messages.length >= 3) {
          saveCurrentConversation();
        }
        setAppMode(newMode);
      };

      // Calculate user trends from existing data
      const calculateTrends = () => {
        const now = new Date();
        const today = now.toISOString().split('T')[0];
        
        // Daily Tends Analysis
        const dailyTendsStats = {};
        VLQ_ORDER.forEach(area => {
          const areaHistory = tendyHistory.filter(t => t.lifeArea === area);
          const completed = areaHistory.filter(t => t.completed).length;
          const total = areaHistory.length;
          dailyTendsStats[area] = {
            completed,
            skipped: total - completed,
            completionRate: total > 0 ? Math.round((completed / total) * 100) : 0
          };
        });
        
        // Calculate current streak
        let currentStreak = 0;
        const sortedHistory = [...tendyHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
        for (let i = 0; i < sortedHistory.length; i++) {
          if (sortedHistory[i].completed) {
            currentStreak++;
          } else {
            break;
          }
        }
        
        // Journaling stats
        const journalEntryDates = Object.keys(journalEntries);
        const thisMonthEntries = journalEntryDates.filter(date => date.startsWith(today.substring(0, 7))).length;
        const thisYearEntries = journalEntryDates.filter(date => date.startsWith(today.substring(0, 4))).length;
        
        // Calculate journal streak
        let journalStreak = 0;
        let checkDate = new Date(today);
        while (journalEntries[checkDate.toISOString().split('T')[0]]) {
          journalStreak++;
          checkDate.setDate(checkDate.getDate() - 1);
        }
        
        // Goals stats
        const completedGoals = goals.filter(g => g.completed).length;
        const totalGoals = goals.length;
        
        // Goals by life area
        const goalsByArea = {};
        VLQ_ORDER.forEach(area => {
          const areaGoals = goals.filter(g => g.lifeArea === area);
          if (areaGoals.length > 0) {
            goalsByArea[area] = {
              created: areaGoals.length,
              completed: areaGoals.filter(g => g.completed).length
            };
          }
        });
        
        // OPTION D: Simple Pattern Detection
        const patterns = {};
        
        // Pattern: Which day of week user journals most
        const journalDayCounts = {};
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        journalEntryDates.forEach(dateStr => {
          const dayOfWeek = new Date(dateStr).getDay();
          journalDayCounts[dayOfWeek] = (journalDayCounts[dayOfWeek] || 0) + 1;
        });
        const mostJournalingDay = Object.entries(journalDayCounts)
          .sort((a, b) => b[1] - a[1])[0];
        if (mostJournalingDay) {
          patterns.mostJournalingDay = dayNames[mostJournalingDay[0]];
        }
        
        // Pattern: Which day of week user completes tends most
        const tendyDayCounts = {};
        tendyHistory.filter(t => t.completed && t.date).forEach(tendy => {
          const dayOfWeek = new Date(tendy.date).getDay();
          tendyDayCounts[dayOfWeek] = (tendyDayCounts[dayOfWeek] || 0) + 1;
        });
        const mostTendyDay = Object.entries(tendyDayCounts)
          .sort((a, b) => b[1] - a[1])[0];
        if (mostTendyDay) {
          patterns.mostProductiveDay = dayNames[mostTendyDay[0]];
        }
        
        // Pattern: Longest streaks
        let longestJournalStreak = 0;
        let currentJStreak = 0;
        const sortedJournalDates = journalEntryDates.sort();
        for (let i = 0; i < sortedJournalDates.length; i++) {
          if (i === 0) {
            currentJStreak = 1;
          } else {
            const prevDate = new Date(sortedJournalDates[i - 1]);
            const currDate = new Date(sortedJournalDates[i]);
            const dayDiff = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));
            if (dayDiff === 1) {
              currentJStreak++;
            } else {
              longestJournalStreak = Math.max(longestJournalStreak, currentJStreak);
              currentJStreak = 1;
            }
          }
        }
        longestJournalStreak = Math.max(longestJournalStreak, currentJStreak);
        patterns.longestJournalStreak = longestJournalStreak;
        
        // Pattern: Completion rate trend (weekday vs weekend)
        const weekdayCompletions = tendyHistory.filter(t => {
          const day = new Date(t.date).getDay();
          return day >= 1 && day <= 5 && t.completed;
        }).length;
        const weekdayTotal = tendyHistory.filter(t => {
          const day = new Date(t.date).getDay();
          return day >= 1 && day <= 5;
        }).length;
        const weekendCompletions = tendyHistory.filter(t => {
          const day = new Date(t.date).getDay();
          return (day === 0 || day === 6) && t.completed;
        }).length;
        const weekendTotal = tendyHistory.filter(t => {
          const day = new Date(t.date).getDay();
          return day === 0 || day === 6;
        }).length;
        
        if (weekdayTotal > 0 && weekendTotal > 0) {
          const weekdayRate = Math.round((weekdayCompletions / weekdayTotal) * 100);
          const weekendRate = Math.round((weekendCompletions / weekendTotal) * 100);
          if (weekdayRate > weekendRate + 10) {
            patterns.completionTrend = 'You complete more tends on weekdays';
          } else if (weekendRate > weekdayRate + 10) {
            patterns.completionTrend = 'You complete more tends on weekends';
          }
        }
        
        return {
          dailyTends: {
            byLifeArea: dailyTendsStats,
            currentStreak,
            totalCompleted: tendyHistory.filter(t => t.completed).length
          },
          journaling: {
            entriesThisMonth: thisMonthEntries,
            entriesThisYear: thisYearEntries,
            currentStreak: journalStreak,
            totalEntries: journalEntryDates.length
          },
          goals: {
            totalCreated: totalGoals,
            completed: completedGoals,
            inProgress: totalGoals - completedGoals,
            completionRate: totalGoals > 0 ? Math.round((completedGoals / totalGoals) * 100) : 0,
            byLifeArea: goalsByArea
          },
          patterns, // NEW: Simple patterns
          calculatedAt: now.toISOString()
        };
      };

      // Save user data to Firestore (debounced)
      const saveTimeoutRef = useRef(null);
      const pendingSaveRef = useRef(null); // Track pending save data
      
      const saveUserData = useCallback(() => {
        if (!user) return;
        
        // Clear existing timeout
        if (saveTimeoutRef.current) {
          clearTimeout(saveTimeoutRef.current);
        }
        
        // Store the save function for beforeunload
        pendingSaveRef.current = async () => {
          try {
            // Calculate trends before saving
            const trends = calculateTrends();
            
            await db.collection('users').doc(user.uid).set({
              vlqScores,
              vlqCompleted,
              events,
              goals,
              notes,
              journalEntries,
              monthlyReviews,
              yearlyReflections,
              seasonIntentions,
              weeklyHabits,
              habitCompletions,
              todaysTendies,
              tendyHistory,
              tendyPoints,
              tendyStreak,
              flexPoints,
              flexPointsTracking,
              weeklyCustomTendy,
              revealed,
              phase,
              // Onboarding
              onboardingStep,
              onboardingCompleted,
              currentOnboardingArea,
              // NEW: Knowledge & Intelligence
              savedConversations,
              userProfile,
              trends,
              // Chat history system
              chatHistory: chatHistory.slice(0, 50), // Keep last 50 chats
              // NEW: Current chat session (persists across refresh)
              currentChat: {
                id: currentChatId,
                messages,
                exchangeCount,
                conversationType: currentConversationType,
                createdAt: new Date().toISOString()
              },
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            }, { merge: true });
            console.log('Data saved (including current chat)');
          } catch (error) {
            console.error('Error saving user data:', error);
          }
        };
        
        // Debounce: save after 100ms of no changes
        saveTimeoutRef.current = setTimeout(async () => {
          if (pendingSaveRef.current) {
            await pendingSaveRef.current();
            pendingSaveRef.current = null;
          }
        }, 100);
      }, [user, vlqScores, vlqCompleted, events, goals, notes, journalEntries, monthlyReviews, yearlyReflections, seasonIntentions, weeklyHabits, habitCompletions, todaysTendies, tendyHistory, tendyPoints, tendyStreak, flexPoints, flexPointsTracking, weeklyCustomTendy, revealed, phase, onboardingStep, onboardingCompleted, currentOnboardingArea, savedConversations, userProfile, messages, exchangeCount, currentConversationType, chatHistory, currentChatId]);

      // Flush pending saves when page unloads
      useEffect(() => {
        const handleBeforeUnload = () => {
          if (pendingSaveRef.current) {
            // Use sendBeacon for reliability on unload
            pendingSaveRef.current();
          }
        };
        
        window.addEventListener('beforeunload', handleBeforeUnload);
        return () => window.removeEventListener('beforeunload', handleBeforeUnload);
      }, []);

      // Onboarding: Auto-advance when required steps are complete
      useEffect(() => {
        if (!vlqCompleted || onboardingCompleted || !onboardingStep) return;
        
        // Special case: When daily tend is completed (step 3), mark onboarding complete
        if (onboardingStep === 3 && todaysTendies.some(t => t.completed)) {
          setOnboardingCompleted(true);
          setOnboardingStep(null);
          
          // Show welcome message after onboarding completes
          const welcomeMsg = {
            role: 'assistant',
            content: `üå± **Welcome to Tend!**

Hi! I'm here to help you on your journey toward a more intentional life. 

You've completed your setup and your first Daily Tend ‚Äî amazing start! Here's what you can do now:

‚Ä¢ **Daily Tend** ‚Äî Get a personalized activity each day based on your life map
‚Ä¢ **Journal** ‚Äî Reflect on your day and track your progress  
‚Ä¢ **Calendar** ‚Äî See your history and plan ahead
‚Ä¢ **Life Map** ‚Äî Update your goals, habits, and priorities anytime

What would you like to explore?`,
            timestamp: new Date().toISOString()
          };
          setMessages([welcomeMsg]);
          setCurrentConversationType('main');
        }
      }, [vlqCompleted, onboardingCompleted, onboardingStep, goals, weeklyHabits, userProfile, todaysTendies]);

      // Track last completed area to detect new completions
      const [lastCompletedAreas, setLastCompletedAreas] = useState([]);
      
      // Monitor focus area completion during step 1 onboarding
      useEffect(() => {
        if (!vlqCompleted || onboardingCompleted || onboardingStep !== 1) return;
        
        const focusAreas = getFocusAreas();
        const prefs = userProfile?.tendPreferences || {};
        
        const getAreaProgress = (areaKey) => {
          const hasPrompt = prefs.structuredInfo?.[areaKey] && Object.values(prefs.structuredInfo[areaKey]).some(v => v) || prefs.lifeAreaNotes?.[areaKey];
          const hasGoal = goals.some(g => g.lifeArea === areaKey);
          // Complete requires BOTH goal AND prompt (no habit requirement)
          return { hasPrompt, hasGoal, complete: hasPrompt && hasGoal };
        };
        
        const completedAreas = focusAreas.filter(a => getAreaProgress(a).complete);
        const allComplete = focusAreas.every(a => getAreaProgress(a).complete);
        
        // If all focus areas complete, show the overlay
        if (allComplete && completedAreas.length > lastCompletedAreas.length) {
          setShowOnboardingOverlay('lifemap');
        }
        
        setLastCompletedAreas(completedAreas);
      }, [vlqCompleted, onboardingCompleted, onboardingStep, goals, weeklyHabits, userProfile]);

      // Onboarding: Auto-navigate to relevant view when step changes
      useEffect(() => {
        if (!vlqCompleted || onboardingCompleted || onboardingStep === null || onboardingStep === undefined) return;
        
        // Navigate to the appropriate view for each step
        switch(onboardingStep) {
          case 1: // Life Map - go to Insights
            setAppMode('insights');
            break;
          case 2: // Quiz - go to Insights
            setAppMode('insights');
            break;
          case 3: // Daily Tend - go to Tendy
            setAppMode('tendy');
            break;
        }
      }, [vlqCompleted, onboardingCompleted, onboardingStep]);

      // Flex Points Awarding System
      useEffect(() => {
        if (!user || !dataLoaded) return;
        
        const today = new Date().toISOString().split('T')[0];
        const now = new Date();
        const currentWeek = `${now.getFullYear()}-W${Math.ceil(((now - new Date(now.getFullYear(), 0, 1)) / 86400000 + new Date(now.getFullYear(), 0, 1).getDay() + 1) / 7)}`;
        const currentMonth = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
        
        let pointsToAward = 0;
        let newTracking = {...flexPointsTracking};
        
        // 1. Monday bonus (1 point per week)
        // Only award if user has tracking history (not first-ever load)
        const isMonday = now.getDay() === 1;
        const hasTrackingHistory = newTracking.lastMondayBonusWeek !== null || 
                                   newTracking.lastJournalDate !== null;
        if (isMonday && hasTrackingHistory && newTracking.lastMondayBonusWeek !== currentWeek) {
          pointsToAward += 1;
          newTracking.lastMondayBonusWeek = currentWeek;
        }
        
        // 2. Journal entry (0.5 points per day)
        if (journalEntries[today] && newTracking.lastJournalDate !== today) {
          pointsToAward += 0.5;
          newTracking.lastJournalDate = today;
        }
        
        // 3. Weekly intention set (0.5 points per week)
        const hasWeeklyIntention = weeklyHabits && weeklyHabits.length > 0;
        if (hasWeeklyIntention && newTracking.lastWeeklyIntentionWeek !== currentWeek) {
          pointsToAward += 0.5;
          newTracking.lastWeeklyIntentionWeek = currentWeek;
        }
        
        // 4. Custom tendy submitted (0.5 points per week)
        if (weeklyCustomTendy && weeklyCustomTendy.weekOf === currentWeek && 
            newTracking.lastCustomTendyWeek !== currentWeek) {
          pointsToAward += 0.5;
          newTracking.lastCustomTendyWeek = currentWeek;
        }
        
        // 5. 7-day check-in streak (1 point)
        const last7Days = Array.from({length: 7}, (_, i) => {
          const d = new Date();
          d.setDate(d.getDate() - i);
          return d.toISOString().split('T')[0];
        });
        const has7DayStreak = last7Days.every(date => journalEntries[date]);
        if (has7DayStreak && newTracking.last7DayStreakDate !== today) {
          pointsToAward += 1;
          newTracking.last7DayStreakDate = today;
        }
        
        // 6. Goal completion (0.5 points per goal)
        const completedGoals = goals.filter(g => g.completed);
        completedGoals.forEach(goal => {
          if (!newTracking.completedGoalIds.includes(goal.id)) {
            pointsToAward += 0.5;
            newTracking.completedGoalIds.push(goal.id);
          }
        });
        
        // Award points if any were earned
        if (pointsToAward > 0) {
          setFlexPoints(flexPoints + pointsToAward);
          setFlexPointsTracking(newTracking);
        }
      }, [user, dataLoaded, journalEntries, monthlyReviews, weeklyHabits, weeklyCustomTendy, goals, flexPoints, flexPointsTracking]);

      // Auto-save when data changes
      useEffect(() => {
        if (user && dataLoaded) {
          saveUserData();
        }
      }, [vlqScores, vlqCompleted, events, goals, notes, journalEntries, monthlyReviews, yearlyReflections, seasonIntentions, weeklyHabits, habitCompletions, todaysTendies, tendyHistory, tendyPoints, tendyStreak, flexPoints, flexPointsTracking, weeklyCustomTendy, revealed, phase, user, dataLoaded, messages, exchangeCount, currentConversationType, userProfile, savedConversations]);

      // Logout function
      const handleLogout = async () => {
        try {
          await auth.signOut();
          // Reset ALL state to defaults
          setVlqScores({
            family: { importance: null, consistency: null },
            partner: { importance: null, consistency: null },
            friendships: { importance: null, consistency: null },
            career: { importance: null, consistency: null },
            education: { importance: null, consistency: null },
            recreation: { importance: null, consistency: null },
            spirituality: { importance: null, consistency: null },
            community: { importance: null, consistency: null },
            health: { importance: null, consistency: null },
            mentalHealth: { importance: null, consistency: null },
          });
          setVlqCompleted(false);
          setVlqStep(-1);
          setEvents([]);
          setGoals([]);
          setNotes({});
          setJournalEntries({});
          setMonthlyReviews({});
          setYearlyReflections({});
          setSeasonIntentions({});
          setWeeklyHabits([]);
          setHabitCompletions({});
          setTodaysTendies([]);
          setTendyHistory([]);
          setTendyPoints(0);
          setTendyStreak(0);
          setFlexPoints(0);
          setFlexPointsTracking({});
          setWeeklyCustomTendy(null);
          setSavedConversations([]);
          setRevealed(false);
          setPhase(PHASES.EXPLORE);
          setMessages([]);
          setChatHistory([]);
          setUserProfile({ name: '', occupation: '', location: '', lifeStage: '', tendPreferences: {} });
          setShowSettingsModal(false);
          setOnboardingStep(1);
          setOnboardingCompleted(false);
          setCurrentOnboardingArea(null);
          setSessionGreeted(false);
          setExchangeCount(0);
          setCurrentConversationType(null);
          setCurrentChatId(null);
          setDataLoaded(false);
        } catch (error) {
          console.error('Error signing out:', error);
        }
      };

      // Delete account function
      const handleDeleteAccount = async () => {
        const confirmed = window.confirm(
          'Are you sure you want to delete your account? This will permanently delete all your data and cannot be undone.'
        );
        
        if (!confirmed) return;
        
        try {
          const userId = user.uid;
          
          // Try to delete the Firebase Auth user first
          try {
            await user.delete();
            console.log('User account deleted');
          } catch (authError) {
            if (authError.code === 'auth/requires-recent-login') {
              // Need to re-authenticate - ask for password
              const password = window.prompt('For security, please enter your password to delete your account:');
              if (!password) {
                return; // User cancelled
              }
              
              try {
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                await user.reauthenticateWithCredential(credential);
                await user.delete();
                console.log('User account deleted after re-auth');
              } catch (reAuthError) {
                if (reAuthError.code === 'auth/wrong-password') {
                  alert('Incorrect password. Please try again.');
                } else {
                  alert('Error: ' + reAuthError.message);
                }
                return;
              }
            } else {
              throw authError;
            }
          }
          
          // Delete user data from Firestore
          await db.collection('users').doc(userId).delete();
          console.log('User data deleted from Firestore');
          
          // Reset all state
          setVlqScores({
            family: { importance: null, consistency: null },
            partner: { importance: null, consistency: null },
            friendships: { importance: null, consistency: null },
            career: { importance: null, consistency: null },
            education: { importance: null, consistency: null },
            recreation: { importance: null, consistency: null },
            spirituality: { importance: null, consistency: null },
            community: { importance: null, consistency: null },
            health: { importance: null, consistency: null },
            mentalHealth: { importance: null, consistency: null },
          });
          setVlqCompleted(false);
          setVlqStep(-1);
          setEvents([]);
          setGoals([]);
          setNotes('');
          setSeasonIntentions({ winter: '', spring: '', summer: '', fall: '' });
          setWeeklyHabits([]);
          setRevealed(false);
          setPhase(PHASES.EXPLORE);
          setMessages([]);
          setChatHistory([]);
          setUserProfile({ name: '', occupation: '', location: '', lifeStage: '', tendPreferences: {} });
          setDataLoaded(false);
          
          alert('Your account has been deleted.');
        } catch (error) {
          console.error('Error deleting account:', error);
          alert('Error deleting account: ' + error.message);
        }
      };

      // Set conversation type based on phase and onboarding status
      useEffect(() => {
        if (phase === PHASES.EXPLORE || phase === PHASES.GROUND) {
          setCurrentConversationType('onboarding');
        } else if (phase === PHASES.REVEAL && !vlqCompleted) {
          setCurrentConversationType('onboarding');
        } else if (!onboardingCompleted && onboardingStep) {
          // Keep as 'onboarding' during the 7-step onboarding process
          setCurrentConversationType('onboarding');
        } else if (currentConversationType === 'onboarding' && onboardingCompleted) {
          // Save onboarding conversation once fully complete
          saveCurrentConversation();
          setCurrentConversationType('general');
        }
      }, [phase, vlqCompleted, onboardingCompleted, onboardingStep]);

      // Loading screen - just the icon
      const loadingScreen = (
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'var(--bg-main)',
        }}>
          <svg width="48" height="48" viewBox="0 0 80 80" fill="none" style={{opacity: 0.6}}>
            <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round"/>
            <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <circle cx="40" cy="70" r="4" fill="none" stroke="var(--accent)" strokeWidth="2"/>
          </svg>
        </div>
      );

      // Session greeting - add a fresh greeting each time user returns
      useEffect(() => {
        // Only greet after VLQ is complete and we haven't greeted this session
        // Also skip if messages already exist (restored from saved conversation)
        if (vlqCompleted && !sessionGreeted && messages.length === 0) {
          const timer = setTimeout(() => {
            setSessionGreeted(true);
            
            let openingMessage = '';
            const focusAreas = getFocusAreas();
            const focusAreaNames = focusAreas.map(k => VLQ_DOMAINS[k].name).slice(0, 3);

            // If onboarding is NOT complete, show step-specific message
            if (!onboardingCompleted && onboardingStep) {
              switch(onboardingStep) {
                case 1: // Life Map
                  const firstFocusArea = focusAreas[0];
                  const firstAreaName = VLQ_DOMAINS[firstFocusArea]?.name || firstFocusArea;
                  
                  // Set the first focus area as current
                  if (firstFocusArea && !currentOnboardingArea) {
                    setCurrentOnboardingArea(firstFocusArea);
                  }
                  
                  openingMessage = `Welcome to Tend! üå± I'm here to help you design your year with intention.

Based on your values assessment, ${focusAreaNames.length > 0 ? `you want to focus on growing in: <strong>${focusAreaNames.join('</strong>, <strong>')}</strong>` : 'there are areas where you want to grow'}.

Let's build out your <strong>Life Map</strong> ‚Äî for each focus area, we'll set a goal, add a weekly habit linked to that goal, and answer a prompt.

I've opened <strong>${firstAreaName}</strong> for you on the left. You can type directly into the input fields there, or just chat with me here about what matters to you and I'll help you fill it in.`;
                  break;
                  
                case 2: // Quiz (optional)
                  openingMessage = `Let's discover your gardener type! üå∏

The Gardener Quiz is a quick, fun way for me to understand how you approach growth. It's optional but helps me personalize your experience!

Take the quiz in the Insights tab, or skip ahead to your first Daily Tend.

[BUTTON: Skip to First Tend | skip quiz]`;
                  break;
                  
                case 3: // First Tend
                  openingMessage = `You're all set up! üå±

You have goals, habits, and a Life Map to guide your journey.

Time to complete your first daily tend!

[BUTTON: Go to Daily Tend | tendy]`;
                  break;
                  
                default:
                  openingMessage = `Hey! üå± Ready to continue setting up your intentional year?`;
              }
            } else {
              // Onboarding complete - show returning user message
              openingMessage = `Hey! üå± What would you like to explore today?

[BUTTON: Generate a daily tend | tendy]
[BUTTON: Check my goals | goals]
[BUTTON: Journal | journal]`;
            }

          // Set greeting as the first message of new chat
          setMessages([{
            role: 'assistant',
            content: openingMessage,
            timestamp: new Date().toISOString()
          }]);
          
          // Scroll to bottom after greeting is added
          setTimeout(() => scrollChatToBottom(), 100);
          }, 50);
          
          return () => clearTimeout(timer);
        }
      }, [vlqCompleted, sessionGreeted, onboardingCompleted, onboardingStep, messages.length]);

      // Auto-set currentOnboardingArea ONLY on initial entry to step 1 (not when user closes)
      const [hasAutoSetArea, setHasAutoSetArea] = useState(false);
      useEffect(() => {
        if (vlqCompleted && !onboardingCompleted && onboardingStep === 1 && !currentOnboardingArea && !hasAutoSetArea) {
          const focusAreas = getFocusAreas();
          if (focusAreas.length > 0) {
            console.log('Auto-setting first focus area:', focusAreas[0]);
            setCurrentOnboardingArea(focusAreas[0]);
            setHasAutoSetArea(true);
          }
        }
      }, [vlqCompleted, onboardingCompleted, onboardingStep, currentOnboardingArea, hasAutoSetArea]);

      // Track view/tab for system prompt context (no auto-messages)

      // Chat resize handlers
      const handleMouseDown = (e) => {
        setIsResizing(true);
        e.preventDefault();
      };

      useEffect(() => {
        const handleMouseMove = (e) => {
          if (!isResizing) return;
          const newWidth = window.innerWidth - e.clientX;
          setChatWidth(Math.min(Math.max(280, newWidth), 600));
        };

        const handleMouseUp = () => {
          setIsResizing(false);
        };

        if (isResizing) {
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        }

        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isResizing]);

      // Sidebar resize handlers
      const handleSidebarMouseDown = (e) => {
        setIsResizingSidebar(true);
        e.preventDefault();
      };

      useEffect(() => {
        const handleSidebarMouseMove = (e) => {
          if (!isResizingSidebar) return;
          const newWidth = e.clientX;
          setSidebarWidth(Math.min(Math.max(200, newWidth), 400));
        };

        const handleSidebarMouseUp = () => {
          setIsResizingSidebar(false);
        };

        if (isResizingSidebar) {
          document.addEventListener('mousemove', handleSidebarMouseMove);
          document.addEventListener('mouseup', handleSidebarMouseUp);
        }

        return () => {
          document.removeEventListener('mousemove', handleSidebarMouseMove);
          document.removeEventListener('mouseup', handleSidebarMouseUp);
        };
      }, [isResizingSidebar]);

      // Scroll chat to bottom
      const scrollChatToBottom = () => {
        if (chatContainerRef.current) {
          chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
      };

      // Scroll when messages change
      useEffect(() => {
        // Use requestAnimationFrame to ensure DOM is updated
        requestAnimationFrame(() => {
          scrollChatToBottom();
        });
      }, [messages]);

      // Scroll after session greeting is added
      useEffect(() => {
        if (sessionGreeted) {
          // Give time for the greeting message to render
          [100, 300, 500].forEach(delay => {
            setTimeout(scrollChatToBottom, delay);
          });
        }
      }, [sessionGreeted]);

      // Also scroll on initial load - with multiple attempts to ensure it works
      useEffect(() => {
        if (dataLoaded && vlqCompleted && messages.length > 0) {
          // Multiple attempts with increasing delays
          [100, 300, 500, 1000].forEach(delay => {
            setTimeout(scrollChatToBottom, delay);
          });
        }
      }, [dataLoaded, vlqCompleted, messages.length]);

      const analyzeText = (text) => {
        const lower = text.toLowerCase();
        const detected = { values: [] };
        Object.entries(VALUE_KEYWORDS).forEach(([value, keywords]) => {
          if (keywords.some(kw => lower.includes(kw)) && !values.includes(value)) {
            detected.values.push(value);
          }
        });
        return detected;
      };

      const processAnalysis = (detected) => {
        if (detected.values.length > 0) {
          setValues(prev => [...new Set([...prev, ...detected.values])].slice(0, 4));
        }
      };

      const parseEvents = (text) => {
        const lower = text.toLowerCase();
        const foundEvents = [];
        MONTH_FULL.forEach((month, idx) => {
          if (lower.includes(month.toLowerCase())) {
            foundEvents.push({ month: idx });
          }
        });
        return foundEvents;
      };

      const generateResponse = (userMessage, currentPhase, exchangeNum) => {
        const detected = analyzeText(userMessage);
        processAnalysis(detected);
        const lower = userMessage.toLowerCase();

        if (currentPhase === PHASES.EXPLORE) {
          if (exchangeNum === 1) {
            const hasFeeling = ['feel', 'feeling', 'want to be', 'less', 'more'].some(w => lower.includes(w));
            if (hasFeeling) {
              return `That's about <em>how</em> you want to feel ‚Äî which is often more important than what you achieve.

What's getting in the way of that right now?`;
            }
            return `Tell me more. What would it look like if this year actually embodied that?`;
          }
          
          if (exchangeNum === 2) {
            return `I'm starting to see what matters to you.

If nothing changed this year, how would that feel?`;
          }

          if (exchangeNum >= 3) {
            setPhase(PHASES.GROUND);
            return `Before I share what I'm hearing, help me understand what's already planned.

What's committed this year ‚Äî trips, big events, deadlines? Just mention the month and what it is.`;
          }
        }

        if (currentPhase === PHASES.GROUND) {
          const foundEvents = parseEvents(userMessage);
          
          if (foundEvents.length > 0) {
            const newEvents = foundEvents.map((e, i) => ({
              id: Date.now() + i,
              title: `Event in ${MONTHS[e.month]}`,
              month: e.month,
              lifeArea: 'fun',
              details: { flights: '', stays: '', activities: '', notes: '' },
            }));
            setEvents(prev => [...prev, ...newEvents]);
          }

          setTimeout(() => {
            setPhase(PHASES.REVEAL);
            setRevealed(true);
          }, 500);

          const valuesSummary = values.length > 0 
            ? values.slice(0, 3).join(', ')
            : 'intention and presence';

          return `<strong>Here's what I'm hearing:</strong>

Your values center around <em>${valuesSummary}</em>.

${foundEvents.length > 0 
  ? `You have ${foundEvents.length} thing${foundEvents.length > 1 ? 's' : ''} anchoring the year.`
  : `Your calendar is open ‚Äî that's space to be intentional.`}

Your year is taking shape. Switch between Year, Seasons, and Monthly views to explore different perspectives.

What's missing?`;
        }

        if (currentPhase === PHASES.REVEAL || currentPhase === PHASES.PLAN) {
          setPhase(PHASES.PLAN);

          // Sidebar tabs - Notes
          if (activeTab === 'notes') {
            return `This is your space to think out loud.

You can use it for:
‚Ä¢ Brain dumps when your head is full
‚Ä¢ Ideas you're not ready to act on
‚Ä¢ Reflections on how things are going
‚Ä¢ Anything that doesn't fit elsewhere

What's taking up mental space right now?`;
          }

          // Sidebar tabs - Goals
          if (activeTab === 'goals') {
            if (lower.includes('fitness') || lower.includes('health') || lower.includes('weight') || lower.includes('run') || lower.includes('exercise')) {
              return `Health goals are foundational.

Make them specific and achievable:
‚Ä¢ <em>"Run a 5K"</em> beats "get in shape"
‚Ä¢ <em>"Workout 3x/week for 3 months"</em> beats "exercise more"
‚Ä¢ <em>"Lose 10 pounds by June"</em> beats "lose weight"

What's your real target?`;
            }

            if (lower.includes('read') || lower.includes('book') || lower.includes('learn')) {
              return `Learning goals expand your world.

Some ways to frame them:
‚Ä¢ <em>"Read 12 books"</em> ‚Äî one a month
‚Ä¢ <em>"Finish one online course"</em>
‚Ä¢ <em>"Learn conversational Spanish"</em>

What do you want to know by year's end?`;
            }

            if (lower.includes('save') || lower.includes('money') || lower.includes('financial') || lower.includes('invest')) {
              return `Financial goals create options.

Be specific:
‚Ä¢ <em>"Save $10K for emergency fund"</em>
‚Ä¢ <em>"Max out retirement contribution"</em>
‚Ä¢ <em>"Pay off credit card by August"</em>

What number would make you feel more secure?`;
            }

            const goalCount = goals.length;
            if (goalCount > 0) {
              return `You have ${goalCount} goal${goalCount > 1 ? 's' : ''} set. Want to add another, or talk through how to make progress on one?

Goals work best when they're:
‚Ä¢ Specific enough to know when you've hit them
‚Ä¢ Connected to what actually matters to you`;
            }

            return `What do you want to be true by the end of this year that isn't true now?

Don't overthink it ‚Äî you can always refine. Start with what comes to mind.`;
          }

          // Calendar view - help with specific month planning
          if (centerView === CENTER_VIEWS.CALENDAR) {
            const monthName = MONTH_FULL[selectedMonth];
            
            if (lower.includes('plan') || lower.includes('suggest') || lower.includes('ideas') || lower.includes('what should')) {
              return `For <em>${monthName}</em>, let's think about:

<strong>What's already anchored?</strong>
Work commitments, birthdays, holidays, travel

<strong>What do you want to protect?</strong>
Rest days, date nights, creative time, nothing-days

<strong>What's one thing that would make this month feel successful?</strong>

Tell me what's on your mind for ${monthName}.`;
            }

            const monthEvents = events.filter(e => e.month === selectedMonth);
            if (monthEvents.length > 0) {
              return `You have <em>${monthEvents.length}</em> thing${monthEvents.length > 1 ? 's' : ''} in ${monthName}: ${monthEvents.map(e => e.title).join(', ')}.

Want me to help you think through any of these? I can suggest activities, help with logistics, or just think through what would make it great.`;
            }

            return `${monthName} is open ‚Äî that's possibility.

What would make this month feel intentional rather than just busy? Any trips, goals, or moments you want to create?`;
          }

          // Weekly view - help with weekly habits
          if (centerView === CENTER_VIEWS.WEEKLY) {
            if (lower.includes('exercise') || lower.includes('workout') || lower.includes('gym') || lower.includes('run') || lower.includes('movement')) {
              return `Movement is foundational. Some weekly rhythms to consider:

‚Ä¢ <em>3x strength, 2x cardio</em> ‚Äî classic balance
‚Ä¢ <em>Daily walks + 2x intense sessions</em> ‚Äî gentler approach
‚Ä¢ <em>1 long active adventure</em> ‚Äî hiking, biking, swimming

What feels sustainable for you? The best routine is one you'll actually do.`;
            }

            if (lower.includes('date') || lower.includes('partner') || lower.includes('relationship') || lower.includes('connect')) {
              return `Protecting time for relationships is one of the most important things you can do.

Ideas for weekly connection:
‚Ä¢ <em>Weekly date night</em> ‚Äî same night each week makes it automatic
‚Ä¢ <em>Morning coffee together</em> ‚Äî 15 minutes of presence
‚Ä¢ <em>Phone-free dinner</em> ‚Äî simple but powerful

What would help your relationships thrive?`;
            }

            if (lower.includes('creative') || lower.includes('hobby') || lower.includes('learn') || lower.includes('read')) {
              return `Making space for creativity and growth:

‚Ä¢ <em>2 hours of creative time</em> ‚Äî protect it like a meeting
‚Ä¢ <em>One chapter a day</em> ‚Äî books add up
‚Ä¢ <em>Weekly learning session</em> ‚Äî courses, podcasts, practice

What do you want to make more time for?`;
            }

            return `Think about the activities that, when you do them regularly, make everything else feel better.

What would you put on your <em>ideal week</em>? Start with just one or two ‚Äî you can always add more.`;
          }

          // Daily view - help with daily habits  
          if (centerView === CENTER_VIEWS.DAILY) {
            if (lower.includes('morning') || lower.includes('wake') || lower.includes('routine')) {
              return `Mornings set the tone for everything.

Some daily morning practices:
‚Ä¢ <em>No phone for first 30 minutes</em>
‚Ä¢ <em>10 minutes of movement</em>
‚Ä¢ <em>Write 3 things you're grateful for</em>
‚Ä¢ <em>One intentional deep breath</em>

What would your ideal morning include?`;
            }

            if (lower.includes('water') || lower.includes('hydrat') || lower.includes('drink')) {
              return `Hydration is one of those small things with outsized impact.

Simple targets:
‚Ä¢ <em>8 glasses / 2 liters</em> ‚Äî the classic
‚Ä¢ <em>Glass before each meal</em> ‚Äî easy to remember
‚Ä¢ <em>Water bottle always visible</em> ‚Äî environment design

What would help you drink more water?`;
            }

            if (lower.includes('walk') || lower.includes('step') || lower.includes('move')) {
              return `Daily movement doesn't have to be intense to be transformative.

Ideas:
‚Ä¢ <em>10,000 steps</em> ‚Äî the gold standard
‚Ä¢ <em>Walk after each meal</em> ‚Äî aids digestion too
‚Ä¢ <em>Standing desk + hourly movement breaks</em>

What level of daily movement feels right for you?`;
            }

            if (lower.includes('phone') || lower.includes('screen') || lower.includes('social media')) {
              return `Our relationship with technology shapes our days more than we realize.

Boundaries to consider:
‚Ä¢ <em>No phone in bedroom</em>
‚Ä¢ <em>App limits on social media</em>
‚Ä¢ <em>Phone-free first and last hour</em>
‚Ä¢ <em>Grayscale mode</em>

What boundary would give you the most peace?`;
            }

            return `Daily habits are about becoming the person you want to be, one small action at a time.

Start tiny ‚Äî what's one thing you could do <em>every single day</em> that would compound over a year?`;
          }
          
          // Default planning responses
          if (lower.includes('plan') || lower.includes('suggest') || lower.includes('ideas') || lower.includes('activities') || lower.includes('where to stay')) {
            const eventMention = events.find(e => lower.includes(MONTHS[e.month].toLowerCase()) || lower.includes(e.title.toLowerCase()));
            if (eventMention) {
              return `For your ${MONTHS[eventMention.month]} event:

<strong>Activities:</strong>
‚Ä¢ Explore the local neighborhood on foot
‚Ä¢ Find one "must-do" and leave room for spontaneity
‚Ä¢ Schedule downtime ‚Äî rest is part of the trip

<strong>Stays:</strong>
‚Ä¢ Look for somewhere with a kitchen for flexibility
‚Ä¢ Consider location vs. price

Click on the event in the sidebar to add details.`;
            }
            return `What event would you like to plan? I can suggest activities, places to stay, and things to consider.`;
          }

          const prompts = [
            `What's one thing you've been wanting to plan but haven't?`,
            `Looking at the seasons ‚Äî where do you need to protect space?`,
            `Is there a trip or experience you keep pushing off?`,
          ];
          return prompts[Math.floor(Math.random() * prompts.length)];
        }

        return `Tell me more about that.`;
      };

      // System prompt for Tend AI
      const getTendSystemPrompt = (pendingState = {}) => {
        const { 
          pendingLifeAreaUpdate, 
          pendingNextAreaIndex, 
          pendingWaitingForSatisfaction,
          pendingIsLastResponse 
        } = pendingState;
        
        // Use pending values if provided, otherwise use current state
        const effectiveAreaIndex = pendingNextAreaIndex !== undefined ? pendingNextAreaIndex : currentLifeAreaIndex;
        const effectiveWaitingFor = pendingWaitingForSatisfaction !== undefined ? pendingWaitingForSatisfaction : waitingForSatisfaction;
        const effectiveIsLast = pendingIsLastResponse || isLastLifeAreaResponse;
        
        // Build updated life area ratings including any pending update
        const effectiveRatings = pendingLifeAreaUpdate 
          ? {
              ...lifeAreaRatings,
              [pendingLifeAreaUpdate.area]: {
                ...lifeAreaRatings[pendingLifeAreaUpdate.area],
                [pendingLifeAreaUpdate.field]: pendingLifeAreaUpdate.score
              }
            }
          : lifeAreaRatings;

        const currentSeason = (() => {
          const month = new Date().getMonth();
          if ([11, 0, 1].includes(month)) return 'winter';
          if ([2, 3, 4].includes(month)) return 'spring';
          if ([5, 6, 7].includes(month)) return 'summer';
          return 'fall';
        })();

        const lifeAreasContext = vlqCompleted 
          ? VLQ_ORDER.map(key => {
              const scores = vlqScores[key];
              const gap = (scores?.importance || 0) - (scores?.consistency || 0);
              return `${VLQ_DOMAINS[key].name}: importance ${scores?.importance}/10, consistency ${scores?.consistency}/10${gap >= 3 ? ' (GROWTH AREA)' : ''}`;
            }).join('; ')
          : 'not assessed yet';

        // Check for misalignments between intentions and actual plans
        const getMisalignments = () => {
          if (!lifeAreasCompleted && !effectiveIsLast) return '';
          const ratingsToCheck = effectiveIsLast ? effectiveRatings : lifeAreaRatings;
          const misalignments = [];
          
          // High intention areas with low activity
          Object.entries(ratingsToCheck).forEach(([key, val]) => {
            if (val.intention >= 7) {
              const relatedHabits = weeklyHabits.filter(h => 
                h.text.toLowerCase().includes(key) || 
                (key === 'health' && /exercise|workout|gym|run|walk|yoga/i.test(h.text)) ||
                (key === 'relationships' && /date|partner|friend|family|call/i.test(h.text)) ||
                (key === 'fun' && /hobby|play|adventure|trip/i.test(h.text))
              );
              const relatedEvents = events.filter(e => e.lifeArea === key);
              
              if (relatedHabits.length === 0 && relatedEvents.length === 0) {
                misalignments.push(`${LIFE_AREAS[key].name} has high intention (${val.intention}) but no related habits or events`);
              }
            }
          });
          
          return misalignments.length > 0 
            ? `\n\nPotential misalignments to gently explore: ${misalignments.join('; ')}`
            : '';
        };

        // Get onboarding-specific context and instructions
        const getOnboardingContext = () => {
          if (onboardingCompleted || !onboardingStep) return '';
          
          const focusAreas = getFocusAreas();
          const focusAreaNames = focusAreas.map(k => VLQ_DOMAINS[k]?.name || k);
          const prefs = userProfile?.tendPreferences || {};
          
          // Check Life Map completion per focus area
          const getAreaProgress = (areaKey) => {
            const hasPrompt = prefs.structuredInfo?.[areaKey] && Object.values(prefs.structuredInfo[areaKey]).some(v => v) || prefs.lifeAreaNotes?.[areaKey];
            const hasGoal = goals.some(g => g.lifeArea === areaKey);
            const areaGoalIds = goals.filter(g => g.lifeArea === areaKey).map(g => g.id);
            const hasLinkedHabit = weeklyHabits.some(h => h.lifeArea === areaKey && areaGoalIds.includes(h.goalId));
            return { hasPrompt, hasGoal, hasLinkedHabit, complete: hasPrompt && hasGoal && hasLinkedHabit };
          };
          
          const focusAreaProgress = focusAreas.map(a => ({ area: a, name: VLQ_DOMAINS[a]?.name, ...getAreaProgress(a) }));
          const allFocusAreasComplete = focusAreaProgress.every(p => p.complete);
          const incompleteAreas = focusAreaProgress.filter(p => !p.complete);
          
          // Get current area being worked on
          const currentArea = currentOnboardingArea || focusAreas[0];
          const currentAreaName = VLQ_DOMAINS[currentArea]?.name || currentArea;
          const currentAreaProgress = getAreaProgress(currentArea);
          
          // Step 1: Life Map (combined goals, habits, prompts per focus area)
          if (onboardingStep === 1) {
            return `

=== ONBOARDING MODE: LIFE MAP (Step 1 of 3) ===
You're helping the user build out their Life Map one focus area at a time.

FOCUS AREAS: ${focusAreaNames.join(', ')}

CURRENTLY WORKING ON: ${currentAreaName} (${currentArea})
Progress for ${currentAreaName}:
- Goal set: ${currentAreaProgress.hasGoal ? '‚úì done' : '‚óã NEEDED'}
- Linked habit: ${currentAreaProgress.hasLinkedHabit ? '‚úì done' : '‚óã NEEDED'} (habit must be linked to a goal!)
- Prompt answered: ${currentAreaProgress.hasPrompt ? '‚úì done' : '‚óã NEEDED'}

OVERALL PROGRESS:
${focusAreaProgress.map(p => `${p.name}: ${p.complete ? '‚úì complete' : `${p.hasGoal ? '‚úì' : '‚óã'} goal | ${p.hasLinkedHabit ? '‚úì' : '‚óã'} linked habit | ${p.hasPrompt ? '‚úì' : '‚óã'} prompt`}`).join('\n')}

${allFocusAreasComplete ? 'üéâ ALL FOCUS AREAS COMPLETE!' : ''}

YOUR APPROACH FOR ${currentAreaName.toUpperCase()}:
1. The area is already expanded in the UI - user can fill in prompts directly OR chat with you
2. If they share something about this area, help them identify:
   - A meaningful goal (use [GOAL: goal text | ${currentArea}])
   - A supporting habit (use [WEEKLY_HABIT: habit text | frequency | ${currentArea}])
3. Be conversational - don't just list what's missing, have a real conversation
4. When they mention a goal or habit, confirm it feels right before adding it

EXAMPLE FLOW:
User: "I want to get better at staying in touch with friends"
You: "That's a meaningful goal! How about: 'Reach out to one friend weekly' ‚Äî does that capture it?"
User: "Yes!"
You: [GOAL: Reach out to one friend weekly | friendships] Got it! What habit would help you do this consistently? Maybe a weekly reminder to call or text someone?

WHEN THIS AREA IS COMPLETE:
- If more focus areas remain: "Great work on ${currentAreaName}! ‚úì Let's move on to [next area]. [FOCUS_AREA: nextAreaKey]"
- If all focus areas done: Offer to explore other areas OR move to quiz

NAVIGATION MARKER:
Use [FOCUS_AREA: areaKey] to navigate to and expand a different life area.

LIFE AREA KEYS: family, partner, friendships, career, education, recreation, spirituality, community, health, mentalHealth`;
          }
          
          // Step 2: Gardener Quiz (optional)
          if (onboardingStep === 2) {
            return `

=== ONBOARDING MODE: GARDENER QUIZ (Step 2 of 3 - OPTIONAL) ===
Encourage the user to take the Gardener Quiz in Insights. This step is completely optional.

The quiz helps them understand their growth style. It's fun but not required.

If they want to take it:
- Guide them to the Insights tab
- The quiz is at the top, they can expand it

When user completes quiz OR wants to skip:
"Ready to try your first Daily Tend?

[BUTTON: Yes, let's go! | next step]"`;
          }
          
          // Step 3: First Tend
          if (onboardingStep === 3) {
            return `

=== ONBOARDING MODE: FIRST TEND (Step 3 of 3) ===
The user is ready for their first Daily Tend! This is the final step.

ALWAYS offer a button to go to Daily Tend:
[BUTTON: Go to Daily Tend | tendy]

Guide them to:
1. Click the button above to go to Daily Tend
2. Look at the personalized tends generated for them
3. Pick one that resonates today
4. Mark it complete

Once they complete a tend, onboarding is done! Celebrate with them and welcome them to Tend.

Their journey is just beginning ‚Äî they have goals, habits, and a Life Map to guide them.`;
          }
          
          // Default fallback
          return `

=== ONBOARDING MODE: Step ${onboardingStep} of 3 ===
Guide the user through their onboarding journey. Be encouraging and help them make progress.`;
        };

        // Build personalization context from user profile
        const getPersonalizationContext = () => {
          const prefs = userProfile?.tendPreferences || {};
          const parts = [];
          
          // Gardener type and tending style
          if (prefs.gardenerType) {
            parts.push(`\n=== USER'S PERSONALITY (from Gardener Quiz) ===`);
            parts.push(`Gardener type: "${prefs.gardenerType.name}" - ${prefs.gardenerType.description}`);
            parts.push(`Superpower: ${prefs.gardenerType.strength}`);
            
            // Tending style preferences
            if (prefs.gardenerType.tendingStyle) {
              const style = prefs.gardenerType.tendingStyle;
              parts.push(`\nCommunication preferences based on their personality:`);
              if (style.checkInTone) parts.push(`- Chat tone: ${style.checkInTone} (adjust your warmth/directness accordingly)`);
              if (style.celebrationStyle) parts.push(`- When they accomplish something: ${style.celebrationStyle}`);
              if (style.habitApproach) parts.push(`- Habit approach: ${style.habitApproach}`);
              if (style.struggleSupport) parts.push(`- When they're struggling: ${style.struggleSupport}`);
              if (style.goalStyle) parts.push(`- Goal-setting style: ${style.goalStyle}`);
            }
            
            // Raw traits for additional context
            if (prefs.gardenerType.traits) {
              const t = prefs.gardenerType.traits;
              if (t.energy) parts.push(`- Recharges by: ${t.energy === 'solo' ? 'alone time' : t.energy === 'intimate' ? 'one-on-one connection' : t.energy === 'social' ? 'being around others' : 'physical activity'}`);
              if (t.timeOfDay) parts.push(`- Best time of day: ${t.timeOfDay}`);
              if (t.setback) parts.push(`- When they miss a goal: tends to be ${t.setback}`);
            }
          }
          
          // Life Map context - what they've shared about each area
          if (prefs.structuredInfo && Object.keys(prefs.structuredInfo).length > 0) {
            const filledAreas = VLQ_ORDER.filter(domain => {
              const info = prefs.structuredInfo[domain];
              return info && Object.values(info).some(v => v);
            });
            
            if (filledAreas.length > 0) {
              parts.push(`\n=== LIFE MAP DETAILS (what they've shared) ===`);
              filledAreas.forEach(domain => {
                const info = prefs.structuredInfo[domain];
                const domainName = VLQ_DOMAINS[domain]?.name;
                const details = Object.entries(info)
                  .filter(([_, v]) => v)
                  .map(([k, v]) => `${k}: ${v}`)
                  .join('; ');
                parts.push(`${domainName}: ${details}`);
              });
            }
          }
          
          // Life area notes
          if (prefs.lifeAreaNotes) {
            const notedAreas = Object.entries(prefs.lifeAreaNotes).filter(([_, note]) => note);
            if (notedAreas.length > 0) {
              parts.push(`\n=== ADDITIONAL NOTES ===`);
              notedAreas.forEach(([area, note]) => {
                parts.push(`${VLQ_DOMAINS[area]?.name || area}: ${note}`);
              });
            }
          }
          
          // Recent journal entries for context
          const getRecentJournalContext = () => {
            const entries = Object.entries(journalEntries || {})
              .filter(([_, entry]) => entry.gratitude || entry.reflection)
              .sort((a, b) => b[0].localeCompare(a[0])) // Most recent first
              .slice(0, 5); // Last 5 entries
            
            if (entries.length === 0) return '';
            
            const journalParts = [`\n=== RECENT JOURNAL ENTRIES ===`];
            
            // Analyze mood/themes across entries
            let stressIndicators = 0;
            let positiveIndicators = 0;
            const themes = [];
            
            entries.forEach(([date, entry]) => {
              const text = `${entry.gratitude || ''} ${entry.reflection || ''}`.toLowerCase();
              
              // Simple mood analysis
              if (/stressed|overwhelmed|anxious|tired|exhausted|frustrated|difficult|hard|struggling/i.test(text)) {
                stressIndicators++;
              }
              if (/grateful|happy|excited|proud|accomplished|good|great|amazing|peaceful|calm/i.test(text)) {
                positiveIndicators++;
              }
              
              // Format entry summary
              const dateObj = new Date(date);
              const dayLabel = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
              
              if (entry.gratitude) {
                journalParts.push(`${dayLabel} - Grateful for: ${entry.gratitude.substring(0, 100)}${entry.gratitude.length > 100 ? '...' : ''}`);
              }
              if (entry.reflection) {
                journalParts.push(`${dayLabel} - Reflection: ${entry.reflection.substring(0, 100)}${entry.reflection.length > 100 ? '...' : ''}`);
              }
            });
            
            // Add mood summary
            if (stressIndicators > positiveIndicators && stressIndicators >= 2) {
              journalParts.push(`\n‚ö†Ô∏è Recent entries suggest they may be feeling stressed or overwhelmed. Be extra supportive and gentle.`);
            } else if (positiveIndicators > stressIndicators && positiveIndicators >= 2) {
              journalParts.push(`\n‚ú® Recent entries suggest they're in a positive headspace. Match their energy!`);
            }
            
            return journalParts.join('\n');
          };
          
          parts.push(getRecentJournalContext());
          
          return parts.length > 0 ? parts.join('\n') : '';
        };

        return `You are Tend, a thoughtful AI companion for intentional living and life design. You help people design their year with intention ‚Äî not just survive, but live intentionally and mindfully.

Your personality:
- Warm, calm, and grounded ‚Äî like a wise friend
- You ask thoughtful questions rather than give prescriptive advice
- You're concise ‚Äî 2-4 sentences is often enough, occasionally more for important moments
- You use gentle emphasis with *italics* for key words (use asterisks for italics)
- You avoid bullet points in conversation ‚Äî speak naturally
${getPersonalizationContext()}

Current context:
- The user is designing their 2026
- Current view: ${centerView}
- Current sidebar tab: ${activeTab}
- Current season: ${currentSeason}
- Their values: ${values.length > 0 ? values.join(', ') : 'not identified yet'}
- Life areas (from VLQ): ${lifeAreasContext}
- Their goals: ${goals.length > 0 ? goals.map(g => `${g.text}${g.lifeArea ? ` (${VLQ_DOMAINS[g.lifeArea]?.name || g.lifeArea})` : ''}`).join(', ') : 'none yet'}
- Their events: ${events.length > 0 ? events.map(e => `${MONTHS[e.month]}: ${e.title}`).join(', ') : 'none yet'}
- Weekly habits: ${weeklyHabits.length > 0 ? weeklyHabits.map(h => `${h.text} (${h.frequency}x/week)${h.lifeArea ? ` [${VLQ_DOMAINS[h.lifeArea]?.name || h.lifeArea}]` : ''}`).join(', ') : 'none yet'}
- Phase: ${phase} (explore = getting to know them, ground = understanding commitments, reveal = unlocking the app, plan = ongoing planning)
- Conversation length: ${messages.length} messages so far
${getMisalignments()}
${getOnboardingContext()}

The user has already completed the VLQ (Valued Living Questionnaire) assessment. You know their values - use this knowledge to personalize your guidance.

EXTRACTING HABITS, EVENTS, GOALS, AND INTENTIONS:
When the user commits to something specific, include the appropriate marker at the END (hidden from user):

For GOALS: [GOAL: goal text | lifeArea]
Example: [GOAL: Run a 5K | health]
Life areas: family, partner, friendships, career, education, recreation, spirituality, community, health, mentalHealth

For HABITS: [WEEKLY_HABIT: habit text | frequency | lifeArea | goalText]
- frequency is 1-7 (times per week)
- "every day" or "daily" = frequency 7
- "3 times a week" = frequency 3
- goalText is the text of the goal this habit supports (required for onboarding!)
- ALWAYS use a separate marker for EACH habit
Examples:
[WEEKLY_HABIT: go to gym | 7 | health | Get fit and lose 10 pounds]
[WEEKLY_HABIT: morning meditation | 7 | mentalHealth | Reduce stress and anxiety]
[WEEKLY_HABIT: call mom | 1 | family | Stay closer with family]
[WEEKLY_HABIT: date night | 1 | partner | Strengthen our relationship]

IMPORTANT: When user mentions multiple habits, output MULTIPLE markers:
User: "I want to go to the gym daily and walk 10k steps"
‚Üí [WEEKLY_HABIT: go to gym | 7 | health | Get fit and lose 10 pounds]
‚Üí [WEEKLY_HABIT: walk 10k steps | 7 | health | Get fit and lose 10 pounds]

IMPORTANT: Always link habits to a goal. If the user hasn't set a goal for this area yet, help them identify one first, then add the habit linked to it.

For EVENTS: [EVENT: descriptive title | month | life_area | event_type]
- Title should be SPECIFIC (never generic like "event")
- Month: 0-11 (0=January)
- Life area: family, partner, friendships, career, education, recreation, spirituality, community, health, finances, growth, fun
- Event type: trip, celebration, project, personal
Examples:
[EVENT: Move to Colorado | 5 | personal | project]
[EVENT: Japan trip | 3 | fun | trip]

For SEASON INTENTIONS: [SEASON: season | intention]
Example: [SEASON: winter | rest and reflection]

For PERSONAL DETAILS (to personalize future daily tends): [LIFE_MAP: lifeArea | key | value]
Use this when users share personal details that would help personalize their experience ‚Äî names of people, pets, places, preferences, specifics about their life. This info gets saved to their Life Map and makes future daily tends more personal.
Examples:
- User mentions "my dog Max" ‚Üí [LIFE_MAP: health | pet | dog named Max]
- User says "my partner Sarah loves hiking" ‚Üí [LIFE_MAP: partner | partner name | Sarah] [LIFE_MAP: recreation | shared activities | hiking with partner]
- User mentions "I work from home" ‚Üí [LIFE_MAP: career | work situation | remote/work from home]
- User says "my mom lives in Portland" ‚Üí [LIFE_MAP: family | mom location | Portland]
- User mentions "I love morning runs by the lake" ‚Üí [LIFE_MAP: health | exercise preference | morning runs by the lake]

Extract personal details naturally as they come up in conversation. Don't ask interrogation-style questions just to fill out the Life Map ‚Äî let it emerge organically.

Only include markers when user has clearly committed or shared (not for vague ideas).

CURRENT VIEW: ${centerView.toUpperCase()}
${centerView === 'year' ? `
You're on the YEAR view. Help them see the big picture of their year. Offer the three paths (Seasons, Events, Rhythms) and ask what they want to explore.
` : ''}${centerView === 'seasons' ? `
You're on the SEASONS view. Help them think about what each season could feel like and hold for them. Ask about:
- What's already planned for each season?
- How do they want each season to feel?
- Are there natural rhythms they want to honor (rest in winter, growth in spring, adventure in summer, harvest in fall)?
` : ''}${centerView === 'monthly' ? `
You're on the MONTHLY view. Help them plan specific events and commitments. Ask about:
- What trips, events, or milestones are coming up?
- Are there months that feel too full or too empty?
- What needs to be scheduled to honor their values?
` : ''}${centerView === 'weekly' ? `
You're on the WEEKLY view. Help them establish weekly rhythms and recurring commitments. Ask about:
- What weekly habits would support their values? (exercise, date nights, creative time, rest)
- What's a realistic frequency for each?
- How can they protect time for what matters?
` : ''}${centerView === 'daily' ? `
You're on the DAILY view. Help them identify small daily habits that compound over time. Ask about:
- What tiny habits would make the biggest difference?
- What do they want their mornings or evenings to look like?
- What daily practice would support their theme word?
` : ''}
If they mention specific events, habits, or plans, acknowledge those and help them think through the details. When they COMMIT to something specific (not just considering it), use the appropriate marker to add it to their plan automatically.
If they seem stuck, offer a gentle prompt or example.
If you notice a misalignment between their VLQ values (high importance areas) and their actual plans, gently bring it up.

Remember: You can add things to their plan automatically using markers. When they commit to a goal, use [GOAL: goal text | lifeArea]. When they want a habit that supports a goal, use [WEEKLY_HABIT: habit text | frequency | lifeArea | goalText]. For example: "I want to get fit" ‚Üí [GOAL: Get fit and healthy | health], then "I'll go to the gym 3 times a week" ‚Üí [WEEKLY_HABIT: go to gym | 3 | health | Get fit and healthy]. The habit must reference the goal text to be linked! When they commit to "a trip to Hawaii in June", add [EVENT: Hawaii trip | 5 | fun | trip]. This makes the conversation feel magical ‚Äî they talk, and things appear in their plan.

Keep responses focused and conversational. You're not a productivity app ‚Äî you're helping them live with more intention.

NAVIGATION SYSTEM:
You are not just a chat assistant ‚Äî you ARE the app's guide. You can navigate users to different parts of the app and help them do things through conversation.

CATEGORY 1 - Dual Input (Chat OR Direct):
These can be done through chat OR directly in the app tabs. User's choice.
- Goals, Events, Habits: User can tell you about them (you add via markers) OR add directly in tabs
- When suggesting these, offer both options with a button:
  "I've added that goal! You can keep telling me more, or add them directly in the Goals tab."
  [BUTTON: Take me to Goals | goals]

CATEGORY 2 - Experience Required (You Navigate):
These REQUIRE the user to interact with the UI directly. Navigate them there.
- Gardener Quiz: "Let me take you to discover your gardener type!" [NAVIGATE: quiz]
- Life Map: "Let me show you your Life Map where you can tell me about your life visually." [NAVIGATE: life map]  
- Journal Mode: "I'll take you to journal mode ‚Äî a quieter space for reflection." [NAVIGATE: journal]

HOW TO USE:
- [BUTTON: Label | action] - Shows a clickable button in your message (for Category 1)
- [NAVIGATE: destination] - Auto-navigates the user (for Category 2, chat minimizes)

Valid destinations: goals, events, notes, plan, journal, insights, life map, quiz, tendy

When user says "what can I do?" or seems lost, offer options warmly:
"We could:
‚Ä¢ Talk about goals you're working toward
‚Ä¢ Build out your Life Map (I can take you there)
‚Ä¢ Take the gardener personality quiz (it's fun!)
‚Ä¢ Generate a daily tend
‚Ä¢ Or just chat ‚Äî what's on your mind?"`;
      };

      // Call Claude API
      const callClaudeAPI = async (userMessage, pendingState = {}) => {
        if (!apiKey) {
          return "I'd love to help you plan, but I need an API key to think deeply. Click the ‚öô settings icon to add your Anthropic API key.";
        }

        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 500,
              system: getTendSystemPrompt(pendingState),
              messages: [
                ...messages.map(m => ({
                  role: m.role === 'assistant' ? 'assistant' : 'user',
                  content: m.content.replace(/<[^>]*>/g, '') // Strip HTML for API
                })),
                { role: 'user', content: userMessage }
              ]
            })
          });

          if (!response.ok) {
            const error = await response.json();
            console.error('API Error:', error);
            if (response.status === 401) {
              return "That API key doesn't seem to be working. Check your key in settings (‚öô).";
            }
            return "Something went wrong connecting to Claude. Try again?";
          }

          const data = await response.json();
          return data.content[0].text;
        } catch (error) {
          console.error('Fetch error:', error);
          return "I couldn't connect to Claude. Check your internet connection and try again.";
        }
      };

      // Switch to a past chat
      const switchToChat = (chatId) => {
        // Save current chat to history first if it has messages
        if (messages.length > 1) {
          const currentChat = {
            id: currentChatId,
            messages: messages,
            createdAt: new Date().toISOString(),
            title: generateChatTitle(messages)
          };
          setChatHistory(prev => {
            // Remove if already exists, then add to front
            const filtered = prev.filter(c => c.id !== currentChatId);
            return [currentChat, ...filtered].slice(0, 50);
          });
        }
        
        // Load the selected chat
        const chat = chatHistory.find(c => c.id === chatId);
        if (chat) {
          setMessages(chat.messages);
          setCurrentChatId(chat.id);
          setShowChatHistory(false);
          setTimeout(() => scrollChatToBottom(), 100);
        }
      };

      // Start a new chat
      const startNewChat = () => {
        // Save current chat to history first if it has messages
        if (messages.length > 1) {
          const currentChat = {
            id: currentChatId,
            messages: messages,
            createdAt: new Date().toISOString(),
            title: generateChatTitle(messages)
          };
          setChatHistory(prev => {
            const filtered = prev.filter(c => c.id !== currentChatId);
            return [currentChat, ...filtered].slice(0, 50);
          });
        }
        
        // Reset for new chat
        setCurrentChatId(Date.now().toString());
        setSessionGreeted(false); // This will trigger a new greeting
        setMessages([]);
        setExchangeCount(0);
        setShowChatHistory(false);
      };

      // Handle navigation from chat buttons and NAVIGATE tags
      const handleChatNavigation = (action) => {
        const actionLower = action.toLowerCase().trim();
        
        // Handle "stay" - user wants to explore other life areas before moving on
        if (actionLower === 'stay') {
          const msg = {
            role: 'assistant',
            content: `Great! Feel free to click on any life area icon in the Life Map to add more goals, habits, and details. When you're ready to move on, just let me know!

[BUTTON: I'm ready for the quiz | next step]
[BUTTON: Skip to my first Tend | skip quiz]`,
            timestamp: new Date().toISOString()
          };
          setMessages(prev => [...prev, msg]);
          setTimeout(() => scrollChatToBottom(), 100);
          return;
        }
        
        // Handle "next step" - advance to next onboarding step
        if (actionLower === 'next step' || actionLower.startsWith('skip ')) {
          if (!onboardingCompleted && onboardingStep && onboardingStep < 3) {
            let nextStep;
            
            // Handle skip actions
            if (actionLower === 'skip quiz') {
              nextStep = 3; // Skip to First Tend
            } else {
              nextStep = onboardingStep + 1;
            }
            
            setOnboardingStep(nextStep);
            
            // Add step-specific greeting message
            const focusAreas = getFocusAreas();
            const focusAreaNames = focusAreas.map(k => VLQ_DOMAINS[k]?.name).slice(0, 3);
            
            let greeting = '';
            switch(nextStep) {
              case 2: // Quiz (optional)
                greeting = `Let's discover your gardener type! üå∏

The Gardener Quiz in the Insights tab helps me understand how you approach growth. It's quick and optional!

[BUTTON: Skip to First Tend | skip quiz]`;
                break;
              case 3: // First Tend
                greeting = `You're all set up! üå±

Time to complete your first daily tend!

[BUTTON: Go to Daily Tend | tendy]`;
                break;
            }
            
            if (greeting) {
              setMessages(prev => [...prev, {
                role: 'assistant',
                content: greeting,
                timestamp: new Date().toISOString()
              }]);
              setTimeout(() => scrollChatToBottom(), 100);
            }
          }
          return;
        }
        
        // Handle "add event" - show event modal
        if (actionLower === 'add event') {
          setShowEventModal(true);
          return;
        }
        
        // Map actions to navigation
        const navigationMap = {
          'goals': () => { setActiveTab('lifeareas'); setSidebarExpanded(true); setShowGoalModal(true); },
          'habits': () => { setCenterView(CENTER_VIEWS.WEEKLY); },
          'weekly habits': () => { setCenterView(CENTER_VIEWS.WEEKLY); },
          'lifeareas': () => { setActiveTab('lifeareas'); setSidebarExpanded(true); },
          'life areas': () => { setActiveTab('lifeareas'); setSidebarExpanded(true); },
          'notes': () => { setActiveTab('lifeareas'); setSidebarExpanded(true); },
          'calendar': () => { setCenterView(CENTER_VIEWS.CALENDAR); setSidebarExpanded(false); },
          'plan': () => setAppMode('plan'),
          'design': () => setAppMode('plan'),
          'plan & design': () => setAppMode('plan'),
          'journal': () => setAppMode('journal'),
          'insights': () => setAppMode('insights'),
          'life map': () => setAppMode('insights'),
          'lifemap': () => setAppMode('insights'),
          'quiz': () => setAppMode('quiz'),
          'gardener quiz': () => setAppMode('quiz'),
          'personality quiz': () => setAppMode('quiz'),
          'tendy': () => setAppMode('tendy'),
          'daily tend': () => setAppMode('tendy'),
          'tends': () => setAppMode('tendy'),
        };
        
        const navAction = navigationMap[actionLower];
        if (navAction) {
          navAction();
          // Don't minimize chat for Category 1 (dual-input) actions
          const category2Actions = ['journal', 'insights', 'life map', 'lifemap', 'quiz', 'gardener quiz', 'personality quiz'];
          if (category2Actions.includes(actionLower)) {
            setChatMinimized(true);
          }
        }
      };

      // Handle returning from an experience (Category 2) - add welcome back message
      const handleReturnFromExperience = (fromMode) => {
        setChatMinimized(false);
        setAppMode(null);
        
        // Don't show welcome back message during onboarding
        if (!onboardingCompleted && onboardingStep) {
          return;
        }
        
        // Add a welcome back message based on where they were
        const welcomeMessages = {
          'journal': `Welcome back from journaling! üìì

How did that feel? Is there anything you want to explore or work on next?

[BUTTON: Generate a daily tend | tendy]
[BUTTON: Let's talk about goals | goals]
[BUTTON: Show me the Life Map | life map]`,
          'insights': `Welcome back! üó∫Ô∏è

Did you discover anything interesting? Where would you like to go next?

[BUTTON: Generate a daily tend | tendy]
[BUTTON: Let's talk about goals | goals]
[BUTTON: Go to journal | journal]`,
          'tendy': `Welcome back! üå±

How did your tends go? What would you like to explore next?

[BUTTON: Let's talk about goals | goals]
[BUTTON: Show me the Life Map | life map]
[BUTTON: Go to journal | journal]`,
        };
        
        const message = welcomeMessages[fromMode];
        if (message) {
          setMessages(prev => [...prev, { role: 'assistant', content: message }]);
        }
      };

      const handleSendMessage = async (e) => {
        if (e) e.preventDefault();
        if (!inputValue.trim()) return;
        
        const userMessage = inputValue.trim();
        setMessages(prev => [...prev, { 
          role: 'user', 
          content: userMessage,
          timestamp: new Date().toISOString()
        }]);
        setInputValue('');
        setIsTyping(true);
        setExchangeCount(prev => prev + 1);

        try {
          // Handle life areas mode - parse numbers
          let pendingLifeAreaUpdate = null;
          let pendingNextAreaIndex = currentLifeAreaIndex;
          let pendingWaitingForSatisfaction = waitingForSatisfaction;
          let pendingIsLastResponse = false;
        
        if (lifeAreasMode) {
          const numbers = userMessage.match(/\b([1-9]|10)\b/g);
          if (numbers && numbers.length > 0) {
            const score = parseInt(numbers[0]);
            const currentArea = lifeAreaOrder[currentLifeAreaIndex];
            
            if (waitingForSatisfaction) {
              pendingLifeAreaUpdate = { area: currentArea, field: 'satisfaction', score };
              setLifeAreaRatings(prev => ({
                ...prev,
                [currentArea]: { ...prev[currentArea], satisfaction: score }
              }));
              setWaitingForSatisfaction(false);
              pendingWaitingForSatisfaction = false;
            } else {
              pendingLifeAreaUpdate = { area: currentArea, field: 'intention', score };
              setLifeAreaRatings(prev => ({
                ...prev,
                [currentArea]: { ...prev[currentArea], intention: score }
              }));
              
              // Move to next area
              if (currentLifeAreaIndex < lifeAreaOrder.length - 1) {
                setCurrentLifeAreaIndex(prev => prev + 1);
                setWaitingForSatisfaction(true);
                pendingNextAreaIndex = currentLifeAreaIndex + 1;
                pendingWaitingForSatisfaction = true;
              } else {
                // This is the final area - flag for summary, then complete
                setIsLastLifeAreaResponse(true);
                pendingIsLastResponse = true;
              }
            }
          }
        }

        // Analyze for values/events even with API
        const detected = analyzeText(userMessage);
        processAnalysis(detected);
        
        // Parse events from message
        const foundEvents = parseEvents(userMessage);
        if (foundEvents.length > 0 && phase === PHASES.GROUND) {
          const newEvents = foundEvents.map((e, i) => ({
            id: Date.now() + i,
            title: `Event in ${MONTHS[e.month]}`,
            month: e.month,
            lifeArea: 'fun',
            details: { flights: '', stays: '', activities: '', notes: '' },
          }));
          setEvents(prev => [...prev, ...newEvents]);
        }

        // Progress phases based on exchange count
        if (phase === PHASES.EXPLORE && exchangeCount >= 2) {
          setPhase(PHASES.GROUND);
        }
        if (phase === PHASES.GROUND && exchangeCount >= 3 && !revealed) {
          setPhase(PHASES.REVEAL);
          setRevealed(true);
          // Start life areas mode - Claude will handle the transition naturally via system prompt
          if (!lifeAreasCompleted) {
            setLifeAreasMode(true);
          }
        }

        // Get response from Claude API
        let response = await callClaudeAPI(userMessage, {
          pendingLifeAreaUpdate,
          pendingNextAreaIndex,
          pendingWaitingForSatisfaction,
          pendingIsLastResponse
        });
        
        // First, parse goals and collect them so we can link habits
        const goalMatches = [...response.matchAll(/\[GOAL:\s*([^|]+)\s*\|\s*([a-zA-Z]+)\]/g)];
        const newGoals = [];
        for (const match of goalMatches) {
          const goalText = match[1].trim();
          const lifeArea = match[2].trim();
          if (goalText && lifeArea) {
            // Check if this goal already exists
            const exists = goals.some(g => g.text.toLowerCase() === goalText.toLowerCase());
            if (!exists) {
              const newGoal = { 
                id: generateId(), 
                text: goalText, 
                lifeArea: lifeArea,
                completed: false
              };
              newGoals.push(newGoal);
              console.log('Goal added by Claude:', goalText, `[${lifeArea}]`);
            }
          }
        }
        
        // Add all new goals to state
        if (newGoals.length > 0) {
          setGoals(prev => [...prev, ...newGoals]);
        }
        
        // Now parse habits with the new format: [WEEKLY_HABIT: habit text | frequency | lifeArea | goalText]
        const weeklyHabitMatches = response.matchAll(/\[WEEKLY_HABIT:\s*([^|]+)\s*\|\s*(\d+)\s*\|\s*([a-zA-Z]+)(?:\s*\|\s*([^\]]+))?\]/g);
        for (const match of weeklyHabitMatches) {
          const habitText = match[1].trim();
          const frequency = parseInt(match[2]);
          const lifeArea = match[3]?.trim() || '';
          const goalText = match[4]?.trim() || '';
          
          if (habitText && frequency >= 1 && frequency <= 7) {
            // Find the goal to link to - check both existing goals and newly added goals
            let linkedGoalId = null;
            if (goalText) {
              // First check newly added goals from this response
              const matchingNewGoal = newGoals.find(g => 
                g.text.toLowerCase() === goalText.toLowerCase() || 
                g.text.toLowerCase().includes(goalText.toLowerCase()) ||
                goalText.toLowerCase().includes(g.text.toLowerCase())
              );
              if (matchingNewGoal) {
                linkedGoalId = matchingNewGoal.id;
              } else {
                // Check existing goals
                const matchingExistingGoal = goals.find(g => 
                  g.lifeArea === lifeArea && (
                    g.text.toLowerCase() === goalText.toLowerCase() || 
                    g.text.toLowerCase().includes(goalText.toLowerCase()) ||
                    goalText.toLowerCase().includes(g.text.toLowerCase())
                  )
                );
                if (matchingExistingGoal) {
                  linkedGoalId = matchingExistingGoal.id;
                }
              }
              
              // If still no match, try to find any goal in this life area
              if (!linkedGoalId) {
                const anyGoalInArea = newGoals.find(g => g.lifeArea === lifeArea) || goals.find(g => g.lifeArea === lifeArea);
                if (anyGoalInArea) {
                  linkedGoalId = anyGoalInArea.id;
                }
              }
            }
            
            setWeeklyHabits(prev => {
              // Don't add duplicates
              if (prev.some(h => h.text.toLowerCase() === habitText.toLowerCase())) return prev;
              console.log('Weekly habit added by Claude:', habitText, frequency + 'x/week', lifeArea ? `[${lifeArea}]` : '', linkedGoalId ? `linked to goal ${linkedGoalId}` : 'no goal link');
              return [...prev, { 
                id: generateId(), 
                text: habitText, 
                frequency,
                lifeArea: lifeArea || undefined,
                goalId: linkedGoalId || undefined,
                color: lifeArea && VLQ_DOMAINS[lifeArea]?.color ? VLQ_DOMAINS[lifeArea].color : ['#7EB3E0', '#8FD4A0', '#F9D07A', '#E8A090', '#B8A9C9'][prev.length % 5]
              }];
            });
          }
        }
        
        // Parse for events: [EVENT: title | month | life_area | event_type]
        // event_type is optional for backward compatibility
        const eventMatches = response.matchAll(/\[EVENT:\s*([^|]+)\s*\|\s*(\d+)\s*\|\s*([a-z]+)(?:\s*\|\s*([a-z]+))?\]/g);
        for (const match of eventMatches) {
          const title = match[1].trim();
          const month = parseInt(match[2]);
          const lifeArea = match[3].trim();
          const eventType = match[4]?.trim() || 'personal';
          const validTypes = ['trip', 'celebration', 'project', 'personal'];
          if (title && month >= 0 && month <= 11) {
            setEvents(prev => {
              // Don't add duplicates (by title)
              if (prev.some(e => e.title.toLowerCase() === title.toLowerCase())) return prev;
              console.log('Event added by Claude:', title, 'in month', month, 'type:', eventType);
              return [...prev, { 
                id: generateId(), 
                title, 
                month, 
                type: validTypes.includes(eventType) ? eventType : 'personal',
                lifeArea: VLQ_ORDER.includes(lifeArea) ? lifeArea : 'fun',
                details: { flights: '', stays: '', activities: '', notes: '' },
                relatedGoals: [],
                createdAt: new Date().toISOString()
              }];
            });
          }
        }
        
        // Parse for season intentions: [SEASON: season | intention]
        const seasonMatches = response.matchAll(/\[SEASON:\s*(winter|spring|summer|fall)\s*\|\s*([^\]]+)\]/g);
        for (const match of seasonMatches) {
          const season = match[1].toLowerCase();
          const intention = match[2].trim();
          if (season && intention) {
            setSeasonIntentions(prev => {
              console.log('Season intention set by Claude:', season, '-', intention);
              return { ...prev, [season]: intention };
            });
          }
        }
        
        // Process NAVIGATE tags (auto-navigation for Category 2 experiences)
        const navigateMatch = response.match(/\[NAVIGATE:\s*([^\]]+)\]/);
        if (navigateMatch) {
          const navTarget = navigateMatch[1].trim();
          // Delay navigation slightly so user sees the message first
          setTimeout(() => {
            handleChatNavigation(navTarget);
          }, 500);
        }
        
        // Process FOCUS_AREA tags (expand a life area in Insights)
        const focusAreaMatch = response.match(/\[FOCUS_AREA:\s*([a-zA-Z]+)\]/);
        if (focusAreaMatch) {
          const areaKey = focusAreaMatch[1].trim().toLowerCase();
          if (VLQ_ORDER.includes(areaKey)) {
            console.log('Focusing on area:', areaKey);
            setCurrentOnboardingArea(areaKey);
          }
        }
        
        // Parse for LIFE_MAP info: [LIFE_MAP: lifeArea | key | value]
        // This extracts personal info from chat and saves it to structuredInfo for daily tend personalization
        const lifeMapMatches = response.matchAll(/\[LIFE_MAP:\s*([a-zA-Z]+)\s*\|\s*([^|]+)\s*\|\s*([^\]]+)\]/g);
        for (const match of lifeMapMatches) {
          const lifeArea = match[1].trim().toLowerCase();
          const key = match[2].trim();
          const value = match[3].trim();
          
          if (lifeArea && key && value && VLQ_ORDER.includes(lifeArea)) {
            console.log('Life Map info extracted from chat:', lifeArea, '-', key, ':', value);
            setUserProfile(prev => {
              const prefs = prev?.tendPreferences || {};
              const existingInfo = prefs.structuredInfo?.[lifeArea] || {};
              
              // Append to existing value if key exists, otherwise create new
              const existingValue = existingInfo[key];
              const newValue = existingValue ? `${existingValue}, ${value}` : value;
              
              return {
                ...prev,
                tendPreferences: {
                  ...prefs,
                  structuredInfo: {
                    ...prefs.structuredInfo,
                    [lifeArea]: {
                      ...existingInfo,
                      [key]: newValue
                    }
                  }
                }
              };
            });
          }
        }
        
        // Remove all markers from displayed response (buttons handled by ChatMessage)
        response = response
          .replace(/\[YEAR_THEME:\s*[a-zA-Z]{4,15}\]/g, '')
          .replace(/\[GOAL:\s*[^\]]+\]/g, '')
          .replace(/\[WEEKLY_HABIT:\s*[^\]]+\]/g, '')
          .replace(/\[EVENT:\s*[^\]]+\]/g, '')
          .replace(/\[SEASON:\s*[^\]]+\]/g, '')
          .replace(/\[NAVIGATE:\s*[^\]]+\]/g, '')
          .replace(/\[FOCUS_AREA:\s*[^\]]+\]/g, '')
          .replace(/\[LIFE_MAP:\s*[^\]]+\]/g, '')
          .trim();
        
        setMessages(prev => [...prev, { 
          role: 'assistant', 
          content: response,
          timestamp: new Date().toISOString()
        }]);
        setIsTyping(false);
        
        // Save onboarding conversation periodically (when goals/habits are added)
        if (currentConversationType === 'onboarding' && !onboardingCompleted) {
          // Debounced save - let state settle first
          setTimeout(() => {
            saveCurrentConversation();
          }, 1000);
        }
        
        // Complete life areas after the summary response
        if (isLastLifeAreaResponse || pendingIsLastResponse) {
          setLifeAreasCompleted(true);
          setLifeAreasMode(false);
          setIsLastLifeAreaResponse(false);
        }
        } catch (error) {
          console.error('Error in handleSendMessage:', error);
          setIsTyping(false);
          setMessages(prev => [...prev, { 
            role: 'assistant', 
            content: "Sorry, something went wrong. Please try again.",
            timestamp: new Date().toISOString()
          }]);
        }
      };

      const handleSkip = () => {
        setPhase(PHASES.PLAN);
        setRevealed(true);
        setMessages(prev => [...prev, {
          role: 'assistant',
          content: `No problem ‚Äî let's dive in.

Use the view switcher to explore your year. Add events, set season intentions, and plan the details.

I'm here to help with any planning.`
        }]);
      };

      const handleAddEvent = (eventData) => {
        setEvents(prev => [...prev, { 
          ...eventData, 
          id: generateId(),
          type: eventData.type || 'personal',
          location: '',
          startDate: '',
          endDate: '',
          budget: { estimated: 0, spent: 0 },
          sections: {
            logistics: { tasks: [], notes: '', chatHistory: [] },
            activities: { tasks: [], notes: '', chatHistory: [] },
            preparation: { tasks: [], notes: '', chatHistory: [] },
            budget: { tasks: [], notes: '', chatHistory: [] }
          },
          details: { flights: '', stays: '', activities: '', notes: '' },
          relatedGoals: [],
          createdAt: new Date().toISOString()
        }]);
        setShowEventModal(false);
      };

      const handleUpdateEventDetails = (eventId, field, value) => {
        setEvents(prev => prev.map(e => 
          e.id === eventId ? { ...e, details: { ...e.details, [field]: value } } : e
        ));
      };

      const handleAddGoal = (goalData) => {
        // OPTION B: Add relationship mapping fields
        setGoals(prev => [...prev, { 
          ...goalData, 
          id: Date.now(), 
          completed: false,
          relatedEvents: [], // Track which events support this goal
          createdAt: new Date().toISOString()
        }]);
        setShowGoalModal(false);
      };

      const handleVlqComplete = () => {
        setVlqCompleted(true);
        setRevealed(true);
        // Pre-fill values based on high-importance domains
        const highImportance = VLQ_ORDER
          .filter(key => vlqScores[key]?.importance >= 7)
          .map(key => VLQ_DOMAINS[key].name.split(' ')[0]);
        if (highImportance.length > 0) {
          setValues(highImportance.slice(0, 3));
        }
        
        // Immediately trigger onboarding greeting for new users
        // This ensures the greeting shows right after VLQ without waiting for effect
        const focusAreas = getFocusAreas();
        const focusAreaNames = focusAreas.map(k => VLQ_DOMAINS[k].name).slice(0, 3);
        const firstFocusArea = focusAreas[0];
        const firstAreaName = VLQ_DOMAINS[firstFocusArea]?.name || firstFocusArea;
        
        // Set the first focus area as current for auto-expansion
        setCurrentOnboardingArea(firstFocusArea);
        
        const welcomeMessage = `Welcome to Tend! üå± I'm here to help you design your year with intention.

Based on your values assessment, ${focusAreaNames.length > 0 ? `you want to focus on growing in: <strong>${focusAreaNames.join('</strong>, <strong>')}</strong>` : 'there are areas where you want to grow'}.

Let's build out your <strong>Life Map</strong> ‚Äî for each focus area, we'll set a goal, add a weekly habit linked to that goal, and answer a prompt.

I've opened <strong>${firstAreaName}</strong> for you on the left. You can type directly into the input fields there, or just chat with me here about what matters to you and I'll help you fill it in.`;
        
        setMessages([{
          role: 'assistant',
          content: welcomeMessage,
          timestamp: new Date().toISOString()
        }]);
        setSessionGreeted(true);
        
        // Go to insights mode for Life Map step
        setAppMode('insights');
      };

      // Mode selection screen
      const modeSelectionScreen = (
        <div style={{
          minHeight: '100vh',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: 'var(--bg-main)',
          padding: '2rem',
          fontFamily: "'DM Sans', sans-serif",
        }}>
          <svg width="48" height="48" viewBox="0 0 80 80" fill="none" style={{opacity: 0.7, marginBottom: '1.5rem'}}>
            <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round"/>
            <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 35 Q32 28 30 18 Q38 25 40 35" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <path d="M40 28 Q48 22 52 12 Q44 20 40 28" stroke="var(--accent)" strokeWidth="2" fill="none" strokeLinecap="round"/>
            <circle cx="40" cy="70" r="4" fill="none" stroke="var(--accent)" strokeWidth="2"/>
          </svg>
          
          <h2 style={{
            fontFamily: "'Fraunces', serif",
            fontSize: '1.5rem',
            color: 'var(--text)',
            marginBottom: '0.5rem',
            fontWeight: 400,
          }}>
            Welcome
          </h2>
          <p style={{
            color: 'var(--text-muted)',
            fontSize: '0.95rem',
            marginBottom: '2rem',
          }}>
            What would you like to do today?
          </p>

          <div style={{
            display: 'flex',
            flexDirection: 'column',
            gap: '1rem',
            width: '100%',
            maxWidth: '320px',
          }}>
            {/* Tendies - Featured option */}
            <button
              onClick={() => { setAppMode('plan'); setCenterView(CENTER_VIEWS.TENDY); }}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--accent-light)',
                border: '2px solid var(--accent)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>üå±</span>
                <div style={{flex: 1}}>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Daily Tend</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>One small action aligned with your values</div>
                </div>
                {tendyPoints > 0 && (
                  <div style={{
                    backgroundColor: 'var(--accent)',
                    color: 'white',
                    fontSize: '0.7rem',
                    padding: '0.25rem 0.5rem',
                    borderRadius: '10px',
                    fontWeight: 500,
                  }}>
                    {tendyPoints} pts
                  </div>
                )}
              </div>
            </button>

            <button
              onClick={() => { setAppMode('plan'); setCenterView(CENTER_VIEWS.JOURNAL); }}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>üìù</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Journal</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>Reflect on your day</div>
                </div>
              </div>
            </button>

            <button
              onClick={() => { setAppMode('plan'); setCenterView(CENTER_VIEWS.INSIGHTS); }}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>üó∫Ô∏è</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Life Map</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>View and edit your life areas</div>
                </div>
              </div>
            </button>

            <button
              onClick={() => setAppMode('quiz')}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>üåª</span>
                <div style={{flex: 1}}>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Gardener Quiz</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>Discover your tending style</div>
                </div>
                {userProfile?.tendPreferences?.gardenerType && (
                  <div style={{
                    backgroundColor: '#E8F5E9',
                    color: '#2E7D32',
                    fontSize: '0.7rem',
                    padding: '0.25rem 0.5rem',
                    borderRadius: '10px',
                    fontWeight: 500,
                  }}>
                    ‚úì {userProfile.tendPreferences.gardenerType.name}
                  </div>
                )}
              </div>
            </button>

            <button
              onClick={() => { setAppMode('plan'); setCenterView(CENTER_VIEWS.CALENDAR); }}
              style={{
                padding: '1.25rem 1.5rem',
                backgroundColor: 'var(--bg-card)',
                border: '1px solid var(--border)',
                borderRadius: '16px',
                cursor: 'pointer',
                textAlign: 'left',
                transition: 'all 0.2s',
              }}
            >
              <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                <span style={{fontSize: '1.5rem'}}>üóìÔ∏è</span>
                <div>
                  <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>Calendar</div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>View your history and plan ahead</div>
                </div>
              </div>
            </button>
          </div>
        </div>
      );

      // Show loading icon for minimum time
      if (showLoadingIcon || authLoading) {
        return loadingScreen;
      }

      // Show auth screen if not logged in
      if (!user) {
        return <AuthModal onSuccess={() => {}} />;
      }

      // Wait for user data to load from Firebase before deciding what to show
      if (!dataLoaded) {
        return loadingScreen;
      }

      // Show VLQ assessment first (new users)
      if (!vlqCompleted) {
        return (
          <VLQAssessment
            vlqScores={vlqScores}
            setVlqScores={setVlqScores}
            vlqStep={vlqStep}
            setVlqStep={setVlqStep}
            onComplete={handleVlqComplete}
          />
        );
      }

      // Journal mode
      if (appMode === 'journal') {
        return (
          <>
            <JournalView 
              vlqScores={vlqScores}
              journalEntries={journalEntries}
              setJournalEntries={setJournalEntries}
              monthlyReviews={monthlyReviews}
              setMonthlyReviews={setMonthlyReviews}
              yearlyReflections={yearlyReflections}
              setYearlyReflections={setYearlyReflections}
              todaysTendies={todaysTendies}
              tendyHistory={tendyHistory}
              flexPoints={flexPoints}
              setFlexPoints={setFlexPoints}
              flexPointsTracking={flexPointsTracking}
              setFlexPointsTracking={setFlexPointsTracking}
              goals={goals}
              setAppMode={setAppMode}
              setMessages={setMessages}
              onSwitchMode={() => setAppMode('plan')}
              onBack={() => setAppMode(null)}
            />
            {/* Floating chat bubble for navigation */}
            <div style={{ position: 'fixed', bottom: '1.5rem', right: '1.5rem', zIndex: 1000 }}>
              <button
                onClick={() => handleReturnFromExperience('journal')}
                style={{
                  width: '60px', height: '60px', borderRadius: '50%',
                  backgroundColor: 'var(--accent)', border: 'none',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.2)', cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem',
                }}
                title="Chat with Tend"
              >üí¨</button>
            </div>
          </>
        );
      }

      // Quiz mode - Gardener Quiz standalone
      if (appMode === 'quiz') {
        return (
          <>
            <InsightsView
              trends={calculateTrends()}
              vlqScores={vlqScores}
              flexPoints={flexPoints}
              userProfile={userProfile}
              setUserProfile={setUserProfile}
              goals={goals}
              setGoals={setGoals}
              weeklyHabits={weeklyHabits}
              setWeeklyHabits={setWeeklyHabits}
              onReassessVLQ={() => { setVlqStep(-1); setVlqCompleted(false); setAppMode(null); }}
              onAddGoal={() => setShowGoalModal(true)}
              onBack={() => setAppMode(null)}
              apiKey={apiKey}
              embedded={false}
              autoExpandSection="quiz"
              hideLifeMap={true}
              onQuizComplete={(result) => {
                // After quiz, return to home
                setAppMode(null);
              }}
            />
            {/* Floating home button */}
            <div style={{ position: 'fixed', bottom: '1.5rem', right: '1.5rem', zIndex: 1000 }}>
              <button
                onClick={() => setAppMode(null)}
                style={{
                  width: '60px', height: '60px', borderRadius: '50%',
                  backgroundColor: 'var(--accent)', border: 'none',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.2)', cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem',
                }}
                title="Back to Home"
              >üè†</button>
            </div>
          </>
        );
      }

      // Insights mode - during onboarding keep chat visible, otherwise full screen
      if (appMode === 'insights') {
        // During onboarding steps 1-2 (life map and quiz), show insights WITHOUT chat panel
        if (!onboardingCompleted && (onboardingStep === 1 || onboardingStep === 2)) {
          return (
            <div style={{...styles.container, overflow: 'auto', scrollbarGutter: 'stable'}}>
              <header style={{...styles.header, justifyContent: 'space-between', alignItems: 'center', position: 'relative'}}>
                <div style={{...styles.headerLeft, position: 'absolute', left: '1rem'}}>
                  <div style={styles.logo}>
                    <svg width="28" height="28" viewBox="0 0 80 80" fill="none">
                      <path d="M40 70 L40 45" stroke="var(--accent)" strokeWidth="2.5" strokeLinecap="round"/>
                      <path d="M40 55 Q30 50 25 40 Q35 45 40 55" stroke="var(--accent)" strokeWidth="2.5" fill="none" strokeLinecap="round"/>
                      <path d="M40 45 Q50 38 55 28 Q45 35 40 45" stroke="var(--accent)" strokeWidth="2.5" fill="none" strokeLinecap="round"/>
                      <circle cx="40" cy="70" r="4" fill="none" stroke="var(--accent)" strokeWidth="2"/>
                    </svg>
                    <span style={styles.logoText}>tend</span>
                  </div>
                </div>
                {/* Progress bar in header - truly centered */}
                <div style={{flex: 1, display: 'flex', justifyContent: 'center'}}>
                  <OnboardingProgressBar 
                    currentStep={onboardingStep}
                    onStepClick={(step) => {
                      if (step === 0) {
                        setVlqStep(-1);
                        setVlqCompleted(false);
                        setAppMode(null);
                      } else {
                        setOnboardingStep(step);
                        setSessionGreeted(false);
                      }
                    }}
                    isStepComplete={isStepComplete}
                    getProgress={getOnboardingProgress}
                    vlqCompleted={vlqCompleted}
                  />
                </div>
                <div style={{position: 'absolute', right: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                  <button 
                    style={styles.settingsButton} 
                    onClick={() => setShowSettingsModal(true)}
                    title="Settings"
                  >
                    ‚öô
                  </button>
                </div>
              </header>
              
              <main style={{...styles.main, gridTemplateColumns: '1fr', maxWidth: '800px', margin: '0 auto', padding: '0.5rem 1rem', overflow: 'visible', height: 'auto'}}>
                {/* Full width content - no chat panel during onboarding */}
                <div style={{padding: '0'}}>
                  <InsightsView
                    trends={calculateTrends()}
                    vlqScores={vlqScores}
                    
                    flexPoints={flexPoints}
                    userProfile={userProfile}
                    setUserProfile={setUserProfile}
                    goals={goals}
                    setGoals={setGoals}
                    weeklyHabits={weeklyHabits}
                    setWeeklyHabits={setWeeklyHabits}
                    onReassessVLQ={() => { setVlqStep(-1); setVlqCompleted(false); setAppMode(null); }}
                    onAddGoal={() => setShowGoalModal(true)}
                    onBack={() => setAppMode(null)}
                    apiKey={apiKey}
                    embedded={true}
                    autoExpandSection={onboardingStep === 2 ? 'quiz' : null}
                    focusedArea={null}
                    onboardingStep={onboardingStep}
                    onboardingCompleted={onboardingCompleted}
                    onFocusedAreaChange={(area) => {
                      if (onboardingStep === 1) setCurrentOnboardingArea(area);
                    }}
                    onQuizComplete={(result) => {
                      // Move to step 3 (Daily Tend) when quiz is complete
                      setShowOnboardingOverlay('quiz'); // Show the quiz complete overlay
                    }}
                    onLifeMapAnswer={() => {
                      // The useEffect monitors completion and sends messages
                      // This callback just triggers re-renders
                    }}
                  />
                  
                  {/* Skip / Continue buttons */}
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: onboardingStep === 2 ? 'space-between' : 'flex-end', 
                    marginTop: '1.5rem',
                    paddingTop: '1rem',
                    borderTop: '1px solid var(--border)'
                  }}>
                    {/* Skip button - only for step 2 (Quiz) */}
                    {onboardingStep === 2 && (
                      <button 
                        onClick={() => setShowOnboardingOverlay('quiz-skip')}
                        style={{
                          padding: '0.6rem 1.25rem',
                          backgroundColor: 'transparent',
                          border: '1px solid var(--border)',
                          borderRadius: '8px',
                          color: 'var(--text-muted)',
                          fontSize: '0.85rem',
                          cursor: 'pointer'
                        }}
                      >
                        Skip for now ‚Üí
                      </button>
                    )}
                    <button 
                      onClick={() => {
                        if (onboardingStep === 1) {
                          setShowOnboardingOverlay('lifemap');
                        } else if (onboardingStep === 2) {
                          setShowOnboardingOverlay('quiz');
                        }
                      }}
                      style={{
                        padding: '0.6rem 1.25rem',
                        backgroundColor: 'var(--accent)',
                        border: 'none',
                        borderRadius: '8px',
                        color: 'white',
                        fontSize: '0.85rem',
                        fontWeight: 500,
                        cursor: 'pointer'
                      }}
                    >
                      Continue ‚Üí
                    </button>
                  </div>
                  
                  {/* Onboarding Completion Overlays */}
                  {showOnboardingOverlay && (
                    <div style={{
                      position: 'fixed',
                      top: 0,
                      left: 0,
                      right: 0,
                      bottom: 0,
                      backgroundColor: 'rgba(0,0,0,0.5)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      zIndex: 1000,
                      padding: '1rem',
                    }}>
                      <div style={{
                        backgroundColor: 'var(--bg-card)',
                        borderRadius: '20px',
                        padding: '2.5rem',
                        maxWidth: '400px',
                        width: '100%',
                        textAlign: 'center',
                        boxShadow: '0 10px 40px rgba(0,0,0,0.2)',
                      }}>
                        <div style={{fontSize: '3rem', marginBottom: '1rem'}}>
                          {showOnboardingOverlay === 'lifemap' ? 'üó∫Ô∏è' : 'üå∏'}
                        </div>
                        <h2 style={{
                          fontFamily: "'Fraunces', serif",
                          fontSize: '1.5rem',
                          color: 'var(--text)',
                          marginBottom: '0.75rem',
                        }}>
                          {showOnboardingOverlay === 'lifemap' ? 'Life Map Started!' : 
                           showOnboardingOverlay === 'quiz' ? 'Quiz Complete!' : 'Moving On!'}
                        </h2>
                        <p style={{
                          color: 'var(--text-muted)',
                          fontSize: '0.95rem',
                          lineHeight: 1.5,
                          marginBottom: '1.5rem',
                        }}>
                          {showOnboardingOverlay === 'lifemap' 
                            ? "Great start! Don't worry ‚Äî you can come back and add more to your Life Map anytime. It grows with you!"
                            : showOnboardingOverlay === 'quiz'
                            ? "We've learned your communication style! This helps us personalize how we talk with you."
                            : "No worries! You can always take the quiz later in your Life Map."}
                        </p>
                        <button
                          onClick={() => {
                            setShowOnboardingOverlay(null);
                            if (showOnboardingOverlay === 'lifemap') {
                              setOnboardingStep(2);
                            } else {
                              // Quiz complete or skipped - go to step 3 (First Tend)
                              setOnboardingStep(3);
                              setAppMode(null); // Exit onboarding InsightsView
                              setCenterView(CENTER_VIEWS.TENDY); // Navigate to TendyView
                            }
                          }}
                          style={{
                            width: '100%',
                            padding: '0.875rem 1.5rem',
                            backgroundColor: 'var(--accent)',
                            border: 'none',
                            borderRadius: '12px',
                            color: 'white',
                            fontSize: '1rem',
                            fontWeight: 500,
                            cursor: 'pointer',
                          }}
                        >
                          Continue ‚Üí
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              </main>
              
              {/* Settings Modal - accessible from onboarding */}
              {showSettingsModal && (
                <SettingsModal 
                  apiKey={apiKey} 
                  setApiKey={(key) => {
                    setApiKey(key);
                    localStorage.setItem('tend_api_key', key);
                  }} 
                  onClose={() => setShowSettingsModal(false)}
                  user={user}
                  onLogout={handleLogout}
                  onDeleteAccount={handleDeleteAccount}
                  onOpenAdmin={() => setShowAdminDashboard(true)}
                />
              )}
              {showAdminDashboard && (
                <AdminDashboard
                  user={user}
                  savedConversations={savedConversations}
                  trends={calculateTrends()}
                  userProfile={userProfile}
                  journalEntries={journalEntries}
                  goals={goals}
                  events={events}
                  todaysTendies={todaysTendies}
                  tendyHistory={tendyHistory}
                  vlqScores={vlqScores}
                  vlqCompleted={vlqCompleted}
                  weeklyHabits={weeklyHabits}
                  habitCompletions={habitCompletions}
                  chatHistory={chatHistory}
                  onboardingStep={onboardingStep}
                  onboardingCompleted={onboardingCompleted}
                  onClose={() => setShowAdminDashboard(false)}
                />
              )}
            </div>
          );
        }
        
        // Normal full-screen insights mode
        return (
          <>
            <InsightsView
              trends={calculateTrends()}
              vlqScores={vlqScores}
              
              flexPoints={flexPoints}
              userProfile={userProfile}
              setUserProfile={setUserProfile}
              goals={goals}
              setGoals={setGoals}
              weeklyHabits={weeklyHabits}
              setWeeklyHabits={setWeeklyHabits}
              onReassessVLQ={() => { setVlqStep(-1); setVlqCompleted(false); setAppMode(null); }}
              onAddGoal={() => setShowGoalModal(true)}
              onBack={() => setAppMode(null)}
              apiKey={apiKey}
            />
            {/* Floating chat bubble for navigation */}
            <div style={{ position: 'fixed', bottom: '1.5rem', right: '1.5rem', zIndex: 1000 }}>
              <button
                onClick={() => handleReturnFromExperience('insights')}
                style={{
                  width: '60px', height: '60px', borderRadius: '50%',
                  backgroundColor: 'var(--accent)', border: 'none',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.2)', cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem',
                }}
                title="Chat with Tend"
              >üí¨</button>
            </div>
          </>
        );
      }

      // Tendy mode
      if (appMode === 'tendy') {
        return (
          <>
            <TendyView
              vlqScores={vlqScores}
              todaysTendies={todaysTendies}
              setTodaysTendies={setTodaysTendies}
              tendyHistory={tendyHistory}
              setTendyHistory={setTendyHistory}
              tendyPoints={tendyPoints}
              setTendyPoints={setTendyPoints}
              tendyStreak={tendyStreak}
              setTendyStreak={setTendyStreak}
              flexPoints={flexPoints}
              setFlexPoints={setFlexPoints}
              weeklyCustomTendy={weeklyCustomTendy}
              setWeeklyCustomTendy={setWeeklyCustomTendy}
              userProfile={userProfile}
              setUserProfile={setUserProfile}
              goals={goals}
              weeklyHabits={weeklyHabits}
              journalEntries={journalEntries}
              apiKey={apiKey}
              onBack={() => setAppMode(null)}
              onTendComplete={() => setAppMode('journal')}
            />
            {/* Floating chat bubble for navigation */}
            <div style={{ position: 'fixed', bottom: '1.5rem', right: '1.5rem', zIndex: 1000 }}>
              <button
                onClick={() => handleReturnFromExperience('tendy')}
                style={{
                  width: '60px', height: '60px', borderRadius: '50%',
                  backgroundColor: 'var(--accent)', border: 'none',
                  boxShadow: '0 4px 20px rgba(0,0,0,0.2)', cursor: 'pointer',
                  display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '1.5rem',
                }}
                title="Chat with Tend"
              >üí¨</button>
            </div>
          </>
        );
      }

      return (
        <div style={styles.container}>
          <header style={styles.header}>
            <div style={styles.logoContainer}>
              <svg width="28" height="28" viewBox="0 0 32 32" fill="none" style={{ marginRight: '8px' }}>
                <path d="M16 26 Q16 18 16 14" stroke="var(--accent)" strokeWidth="2" strokeLinecap="round" fill="none"/>
                <path d="M16 18 Q10 16 8 10 Q14 12 16 18" fill="var(--accent)" opacity="0.5"/>
                <path d="M16 14 Q22 10 24 4 Q18 8 16 14" fill="var(--accent)"/>
                <path d="M16 10 Q14 6 16 2 Q18 6 16 10" fill="var(--accent)" opacity="0.7"/>
              </svg>
              <h1 style={styles.logoText}>tend</h1>
            </div>
            <p style={styles.tagline}>a space for designing your life with intention</p>
            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
              <button 
                style={styles.settingsButton} 
                onClick={() => setShowSettingsModal(true)}
                title="Settings"
              >
                ‚öô
              </button>
            </div>
          </header>

          <main style={{...styles.main, gridTemplateColumns: onboardingCompleted ? '1fr' : `1fr ${chatMinimized ? '0px' : chatWidth + 'px'}`}}>
            <div style={styles.centerPanel}>
              {/* Onboarding Progress Bar */}
              {!onboardingCompleted && onboardingStep !== null && (
                <OnboardingProgressBar 
                  currentStep={onboardingStep}
                  onStepClick={(step) => {
                    if (step === 0) {
                      // Go back to VLQ reassessment
                      setVlqStep(-1);
                      setVlqCompleted(false);
                      setAppMode(null);
                    } else {
                      setOnboardingStep(step);
                      setSessionGreeted(false); // Trigger new greeting
                    }
                  }}
                  isStepComplete={isStepComplete}
                  getProgress={getOnboardingProgress}
                  vlqCompleted={vlqCompleted}
                />
              )}
              
              <div style={styles.viewSwitcher}>
                {[
                  { id: CENTER_VIEWS.YEAR, label: 'Home' },
                  { id: CENTER_VIEWS.CALENDAR, label: 'Calendar' },
                  { id: CENTER_VIEWS.INSIGHTS, label: 'Life Map' },
                  { id: CENTER_VIEWS.TENDY, label: 'Daily Tend' },
                  { id: CENTER_VIEWS.JOURNAL, label: 'Journal' },
                ].map(view => (
                  <button
                    key={view.id}
                    style={{
                      ...styles.viewButton, 
                      ...(centerView === view.id && styles.viewButtonActive)
                    }}
                    onClick={() => setCenterView(view.id)}
                  >
                    {view.label}
                  </button>
                ))}
              </div>

              {/* Show views */}
              {centerView === CENTER_VIEWS.YEAR && (
                <YearCircleView 
                  events={events}
                  revealed={revealed}
                  onAddEvent={() => setShowEventModal(true)}
                />
              )}
              {centerView === CENTER_VIEWS.CALENDAR && (
                <MonthlyView 
                  events={events}
                  selectedMonth={selectedMonth}
                  setSelectedMonth={setSelectedMonth}
                  revealed={revealed}
                  onAddEvent={() => setShowEventModal(true)}
                  weeklyHabits={weeklyHabits}
                  habitCompletions={habitCompletions}
                  setHabitCompletions={setHabitCompletions}
                  journalEntries={journalEntries}
                  tendyHistory={tendyHistory}
                  onNavigateToTend={() => setCenterView(CENTER_VIEWS.TENDY)}
                />
              )}
              {centerView === CENTER_VIEWS.INSIGHTS && (
                <div style={{overflow: 'auto', maxHeight: 'calc(100vh - 140px)'}}>
                  <InsightsView
                    trends={calculateTrends()}
                    vlqScores={vlqScores}
                    flexPoints={flexPoints}
                    userProfile={userProfile}
                    setUserProfile={setUserProfile}
                    goals={goals}
                    setGoals={setGoals}
                    weeklyHabits={weeklyHabits}
                    setWeeklyHabits={setWeeklyHabits}
                    onReassessVLQ={() => { setVlqStep(-1); setVlqCompleted(false); setAppMode(null); }}
                    onAddGoal={() => setShowGoalModal(true)}
                    onBack={() => setCenterView(CENTER_VIEWS.YEAR)}
                    apiKey={apiKey}
                    embedded={true}
                  />
                </div>
              )}
              {centerView === CENTER_VIEWS.TENDY && (
                <div style={{overflow: 'auto', maxHeight: 'calc(100vh - 140px)'}}>
                  <TendyView
                    vlqScores={vlqScores}
                    todaysTendies={todaysTendies}
                    setTodaysTendies={setTodaysTendies}
                    tendyHistory={tendyHistory}
                    setTendyHistory={setTendyHistory}
                    tendyPoints={tendyPoints}
                    setTendyPoints={setTendyPoints}
                    tendyStreak={tendyStreak}
                    setTendyStreak={setTendyStreak}
                    flexPoints={flexPoints}
                    setFlexPoints={setFlexPoints}
                    weeklyCustomTendy={weeklyCustomTendy}
                    setWeeklyCustomTendy={setWeeklyCustomTendy}
                    userProfile={userProfile}
                    setUserProfile={setUserProfile}
                    goals={goals}
                    weeklyHabits={weeklyHabits}
                    journalEntries={journalEntries}
                    apiKey={apiKey}
                    onBack={() => setCenterView(CENTER_VIEWS.YEAR)}
                    isOnboarding={!onboardingCompleted && onboardingStep === 3}
                    onFinishOnboarding={() => {
                      setOnboardingCompleted(true);
                      setOnboardingStep(null);
                      setCenterView(CENTER_VIEWS.YEAR);
                      setShowChatOverlay(true);
                      // Send welcome message
                      setMessages([{
                        role: 'assistant',
                        content: `üéâ **Welcome to Tend!**

You've finished setting up ‚Äî great job!

Now it's time to make Tend yours. Here are some ways we can work together:

‚Ä¢ **Talk about what's on your mind** ‚Äî whether it's something you're looking to accomplish, how you want to feel, or your values
‚Ä¢ **Plan your day or week** ‚Äî I can help you be more intentional
‚Ä¢ **Explore the app** ‚Äî check out the tabs below: **Home** for your overview, **Calendar** for planning, **Life Map** for your goals, **Daily Tend** for your activities, and **Journal** for reflection

You can minimize this chat anytime and come back whenever you need me. I'm here to help you live more intentionally. üå±

What's on your mind today?`
                      }]);
                    }}
                  />
                </div>
              )}
              {centerView === CENTER_VIEWS.JOURNAL && (
                <div style={{overflow: 'auto', maxHeight: 'calc(100vh - 140px)'}}>
                  <JournalView 
                    vlqScores={vlqScores}
                    journalEntries={journalEntries}
                    setJournalEntries={setJournalEntries}
                    monthlyReviews={monthlyReviews}
                    setMonthlyReviews={setMonthlyReviews}
                    yearlyReflections={yearlyReflections}
                    setYearlyReflections={setYearlyReflections}
                    todaysTendies={todaysTendies}
                    tendyHistory={tendyHistory}
                    flexPoints={flexPoints}
                    setFlexPoints={setFlexPoints}
                    flexPointsTracking={flexPointsTracking}
                    setFlexPointsTracking={setFlexPointsTracking}
                    goals={goals}
                    setAppMode={setAppMode}
                    setMessages={setMessages}
                    onSwitchMode={() => setCenterView(CENTER_VIEWS.YEAR)}
                    onBack={() => setCenterView(CENTER_VIEWS.YEAR)}
                  />
                </div>
              )}
            </div>

            {/* Chat Panel - Only show during onboarding step 3 or when onboarding not complete */}
            {/* After onboarding, use the floating bubble + overlay instead */}
            {!onboardingCompleted && !chatMinimized ? (
              <div style={styles.chatPanel}>
                <div 
                  style={styles.resizeHandle} 
                  onMouseDown={handleMouseDown}
                  title="Drag to resize"
                />
                {/* Chat header with minimize button */}
                <div style={{
                  padding: '0.75rem 1rem',
                  borderBottom: '1px solid var(--border)',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  backgroundColor: 'var(--bg-elevated)',
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                    <span style={{ fontSize: '1rem' }}>üí¨</span>
                    <span style={{ fontSize: '0.85rem', fontWeight: 500, color: 'var(--text)' }}>Tend</span>
                  </div>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '0.25rem' }}>
                    {/* New Chat button */}
                    <button
                      onClick={startNewChat}
                      style={{
                        background: 'none',
                        border: 'none',
                        fontSize: '1rem',
                        color: 'var(--text-muted)',
                        cursor: 'pointer',
                        padding: '0.25rem 0.5rem',
                        lineHeight: 1,
                        borderRadius: '4px',
                      }}
                      title="New chat"
                    >
                      ‚úèÔ∏è
                    </button>
                    {/* Chat History button */}
                    <div style={{ position: 'relative' }}>
                      <button
                        onClick={() => setShowChatHistory(!showChatHistory)}
                        style={{
                          background: showChatHistory ? 'var(--bg-main)' : 'none',
                          border: 'none',
                          fontSize: '1rem',
                          color: 'var(--text-muted)',
                          cursor: 'pointer',
                          padding: '0.25rem 0.5rem',
                          lineHeight: 1,
                          borderRadius: '4px',
                        }}
                        title="Chat history"
                      >
                        üìã
                      </button>
                      {/* History dropdown */}
                      {showChatHistory && (
                        <div style={{
                          position: 'absolute',
                          top: '100%',
                          right: 0,
                          marginTop: '0.5rem',
                          backgroundColor: 'var(--bg-card)',
                          border: '1px solid var(--border)',
                          borderRadius: '8px',
                          boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                          width: '280px',
                          maxHeight: '400px',
                          overflowY: 'auto',
                          zIndex: 1000,
                        }}>
                          <div style={{
                            padding: '0.75rem 1rem',
                            borderBottom: '1px solid var(--border)',
                            fontWeight: 500,
                            fontSize: '0.85rem',
                            color: 'var(--text)',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                          }}>
                            <span>Past Chats</span>
                            <button
                              onClick={() => setShowChatHistory(false)}
                              style={{ background: 'none', border: 'none', cursor: 'pointer', color: 'var(--text-muted)' }}
                            >‚úï</button>
                          </div>
                          {chatHistory.length === 0 ? (
                            <div style={{ padding: '1rem', color: 'var(--text-muted)', fontSize: '0.85rem', textAlign: 'center' }}>
                              No past chats yet
                            </div>
                          ) : (
                            chatHistory.map(chat => (
                              <button
                                key={chat.id}
                                onClick={() => switchToChat(chat.id)}
                                style={{
                                  display: 'block',
                                  width: '100%',
                                  padding: '0.75rem 1rem',
                                  textAlign: 'left',
                                  background: 'none',
                                  border: 'none',
                                  borderBottom: '1px solid var(--border)',
                                  cursor: 'pointer',
                                  transition: 'background 0.15s',
                                }}
                                onMouseEnter={e => e.target.style.background = 'var(--bg-main)'}
                                onMouseLeave={e => e.target.style.background = 'none'}
                              >
                                <div style={{ fontSize: '0.85rem', color: 'var(--text)', marginBottom: '0.25rem', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                                  {chat.title}
                                </div>
                                <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                                  {new Date(chat.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}
                                </div>
                              </button>
                            ))
                          )}
                        </div>
                      )}
                    </div>
                    {/* Minimize button */}
                    <button
                      onClick={() => setChatMinimized(true)}
                      style={{
                        background: 'none',
                        border: 'none',
                        fontSize: '1.25rem',
                        color: 'var(--text-muted)',
                        cursor: 'pointer',
                        padding: '0.25rem',
                        lineHeight: 1,
                      }}
                      title="Minimize chat"
                    >
                      ‚àí
                    </button>
                  </div>
                </div>
                <div ref={chatContainerRef} style={styles.chatMessages}>
                  {messages.map((msg, idx) => (
                    <ChatMessage 
                      key={idx} 
                      message={msg} 
                      onButtonClick={handleChatNavigation}
                    />
                  ))}
                  {isTyping && <TypingIndicator />}
                  <div ref={messagesEndRef} />
                </div>
                
                <div style={styles.chatInputArea}>
                  {!revealed && phase === PHASES.EXPLORE && (
                    <button style={styles.skipButton} onClick={handleSkip}>Skip to planning ‚Üí</button>
                  )}
                  <div style={styles.inputRow}>
                    <textarea
                      style={styles.chatInput}
                      value={inputValue}
                      onChange={(e) => setInputValue(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                          e.preventDefault();
                          handleSendMessage();
                        }
                      }}
                      placeholder="Say whatever comes to mind..."
                      rows={2}
                    />
                    <button 
                      style={{...styles.sendButton, ...(inputValue.trim() ? {} : styles.sendButtonDisabled)}}
                      onClick={handleSendMessage}
                      disabled={!inputValue.trim()}
                    >‚Üë</button>
                  </div>
                </div>
              </div>
            ) : !onboardingCompleted && (
              /* Minimized Chat Bubble - only during onboarding */
              <div style={{
                position: 'fixed',
                bottom: '1.5rem',
                right: '1.5rem',
                zIndex: 1000,
              }}>
                <button
                  onClick={() => setChatMinimized(false)}
                  style={{
                    width: '60px',
                    height: '60px',
                    borderRadius: '50%',
                    backgroundColor: 'var(--accent)',
                    border: 'none',
                    boxShadow: '0 4px 20px rgba(0,0,0,0.2)',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '1.5rem',
                    transition: 'transform 0.2s, box-shadow 0.2s',
                  }}
                  onMouseOver={(e) => { e.currentTarget.style.transform = 'scale(1.1)'; e.currentTarget.style.boxShadow = '0 6px 25px rgba(0,0,0,0.25)'; }}
                  onMouseOut={(e) => { e.currentTarget.style.transform = 'scale(1)'; e.currentTarget.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)'; }}
                  title="Chat with Tend"
                >
                  üí¨
                </button>
                <div style={{
                  position: 'absolute',
                  bottom: '-0.25rem',
                  left: '50%',
                  transform: 'translateX(-50%)',
                  fontSize: '0.65rem',
                  color: 'var(--text-muted)',
                  whiteSpace: 'nowrap',
                  marginTop: '0.25rem',
                }}>
                  Chat with Tend
                </div>
              </div>
            )}
          </main>

          {showEventModal && <EventModal onClose={() => setShowEventModal(false)} onAdd={handleAddEvent} />}
          {showGoalModal && <GoalModal onClose={() => setShowGoalModal(false)} onAdd={handleAddGoal} focusAreas={getFocusAreas()} />}
          {showSettingsModal && (
            <SettingsModal 
              apiKey={apiKey} 
              setApiKey={(key) => {
                setApiKey(key);
                localStorage.setItem('tend_api_key', key);
              }} 
              onClose={() => setShowSettingsModal(false)}
              user={user}
              onLogout={handleLogout}
              onDeleteAccount={handleDeleteAccount}
              onOpenAdmin={() => setShowAdminDashboard(true)}
            />
          )}
          {showAdminDashboard && (
            <AdminDashboard
              user={user}
              savedConversations={savedConversations}
              trends={calculateTrends()}
              userProfile={userProfile}
              journalEntries={journalEntries}
              goals={goals}
              events={events}
              todaysTendies={todaysTendies}
              tendyHistory={tendyHistory}
              vlqScores={vlqScores}
              vlqCompleted={vlqCompleted}
              weeklyHabits={weeklyHabits}
              habitCompletions={habitCompletions}
              chatHistory={chatHistory}
              onboardingStep={onboardingStep}
              onboardingCompleted={onboardingCompleted}
              onClose={() => setShowAdminDashboard(false)}
            />
          )}
          
          {/* Full-screen Chat Overlay */}
          {showChatOverlay && (
            <div style={{
              position: 'fixed',
              top: 0,
              left: 0,
              right: 0,
              bottom: 0,
              backgroundColor: 'var(--bg-main)',
              zIndex: 1000,
              display: 'flex',
              flexDirection: 'column',
            }}>
              {/* Chat Header */}
              <div style={{
                padding: '1rem 1.5rem',
                borderBottom: '1px solid var(--border)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'space-between',
                backgroundColor: 'var(--bg-card)',
              }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                  <span style={{ fontSize: '1.5rem' }}>üí¨</span>
                  <div>
                    <div style={{ fontWeight: 600, color: 'var(--text)', fontSize: '1.1rem' }}>Chat with Tend</div>
                    <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>Your personal wellness guide</div>
                  </div>
                </div>
                <button
                  onClick={() => setShowChatOverlay(false)}
                  style={{
                    padding: '0.5rem 1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    color: 'var(--text)',
                    fontSize: '0.85rem',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                  }}
                >
                  <span>‚Üì</span> Minimize
                </button>
              </div>
              
              {/* Chat Messages */}
              <div 
                ref={chatContainerRef}
                style={{
                  flex: 1,
                  overflowY: 'auto',
                  padding: '1.5rem',
                  maxWidth: '700px',
                  width: '100%',
                  margin: '0 auto',
                }}
              >
                {messages.map((msg, idx) => (
                  <ChatMessage 
                    key={idx} 
                    message={msg} 
                    onButtonClick={handleChatNavigation}
                  />
                ))}
                {isTyping && <TypingIndicator />}
                <div ref={messagesEndRef} />
              </div>
              
              {/* Chat Input */}
              <div style={{
                padding: '1rem 1.5rem',
                borderTop: '1px solid var(--border)',
                backgroundColor: 'var(--bg-card)',
              }}>
                <div style={{
                  maxWidth: '700px',
                  margin: '0 auto',
                  display: 'flex',
                  gap: '0.75rem',
                }}>
                  <textarea
                    style={{
                      flex: 1,
                      padding: '0.875rem',
                      borderRadius: '12px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-main)',
                      color: 'var(--text)',
                      fontSize: '0.95rem',
                      fontFamily: "'DM Sans', sans-serif",
                      resize: 'none',
                      minHeight: '50px',
                      maxHeight: '150px',
                    }}
                    value={inputValue}
                    onChange={(e) => setInputValue(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend();
                      }
                    }}
                    placeholder="Type your message..."
                  />
                  <button
                    onClick={handleSend}
                    disabled={!inputValue.trim() || isTyping}
                    style={{
                      padding: '0.875rem 1.5rem',
                      backgroundColor: inputValue.trim() && !isTyping ? 'var(--accent)' : 'var(--border-dark)',
                      border: 'none',
                      borderRadius: '12px',
                      color: 'white',
                      fontSize: '0.95rem',
                      fontWeight: 500,
                      cursor: inputValue.trim() && !isTyping ? 'pointer' : 'not-allowed',
                      alignSelf: 'flex-end',
                    }}
                  >
                    Send
                  </button>
                </div>
              </div>
            </div>
          )}
          
          {/* Floating Chat Bubble - only show when overlay is closed and onboarding is complete */}
          {onboardingCompleted && !showChatOverlay && (
            <button
              onClick={() => setShowChatOverlay(true)}
              style={{
                position: 'fixed',
                bottom: '1.5rem',
                right: '1.5rem',
                width: '60px',
                height: '60px',
                borderRadius: '50%',
                backgroundColor: 'var(--accent)',
                border: 'none',
                boxShadow: '0 4px 20px rgba(0,0,0,0.2)',
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: '1.5rem',
                zIndex: 999,
                transition: 'transform 0.2s, box-shadow 0.2s',
              }}
              onMouseEnter={(e) => {
                e.target.style.transform = 'scale(1.05)';
                e.target.style.boxShadow = '0 6px 24px rgba(0,0,0,0.25)';
              }}
              onMouseLeave={(e) => {
                e.target.style.transform = 'scale(1)';
                e.target.style.boxShadow = '0 4px 20px rgba(0,0,0,0.2)';
              }}
              title="Chat with Tend"
            >
              üí¨
            </button>
          )}
        </div>
      );
    }

    // ============ JOURNAL VIEW (TABBED) ============
    function JournalView({ 
      vlqScores, 
      journalEntries, 
      setJournalEntries,
      monthlyReviews,
      setMonthlyReviews,
      yearlyReflections,
      setYearlyReflections,
      todaysTendies,
      tendyHistory,
      flexPoints,
      setFlexPoints,
      flexPointsTracking,
      setFlexPointsTracking,
      onSwitchMode, 
      onBack,
      setAppMode,
      setMessages,
      goals
    }) {
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
      
      // Check if it's time for monthly review (last 3 days of month AND user has been on Tend 15+ days)
      const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
      const daysUntilEndOfMonth = lastDayOfMonth - today.getDate();
      const isLastThreeDays = daysUntilEndOfMonth <= 2;
      
      // Calculate days on Tend - use earliest journal entry or tend date
      const allDates = [
        ...Object.keys(journalEntries),
        ...tendyHistory.map(t => t.date)
      ].filter(Boolean);
      const earliestDate = allDates.length > 0 
        ? new Date(Math.min(...allDates.map(d => new Date(d).getTime())))
        : today;
      const daysOnTend = Math.floor((today - earliestDate) / (1000 * 60 * 60 * 24));
      const hasBeenOnTend15Days = daysOnTend >= 15;
      
      const isMonthlyReviewTime = isLastThreeDays && hasBeenOnTend15Days;
      const monthlyReviewCompleted = monthlyReviews[currentMonth]?.completed;

      // Generate monthly summary
      const generateMonthlySummary = () => {
        const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const monthEntries = Object.entries(journalEntries).filter(([date]) => {
          const entryDate = new Date(date);
          return entryDate >= firstDayOfMonth && entryDate <= today;
        });
        
        const journalDays = monthEntries.length;
        const completedTends = tendyHistory.filter(t => {
          const tendDate = new Date(t.date);
          return tendDate >= firstDayOfMonth && tendDate <= today && t.completed;
        }).length;
        
        const completedGoals = goals.filter(g => {
          if (!g.completed) return false;
          // Assume completed this month if marked complete (we don't track completion date yet)
          return true;
        }).length;

        return `Hi! It's the end of ${monthName}, and I've prepared a summary of your month:

üìä **Your Month in Numbers:**
- You journaled ${journalDays} days this month
- You completed ${completedTends} daily tends
- You achieved ${completedGoals} goals

üå± **Areas You Focused On:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const gap = importance - (vlqScores[key]?.consistency || 5);
  return gap >= 2;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No specific focus areas'}

Let's reflect on your month together. What stood out to you most? What are you proud of? What would you like to carry forward into next month?`;
      };

      const startMonthlyReview = () => {
        // Save any previous conversation before starting new one
        saveCurrentConversation();
        
        const summary = generateMonthlySummary();
        setMessages([{
          role: 'assistant',
          content: summary
        }]);
        setCurrentConversationType('monthly_review');
        setMonthlyReviews(prev => ({
          ...prev,
          [currentMonth]: { 
            completed: true, 
            completedAt: new Date().toISOString(),
            conversationId: `monthly_${currentMonth}_${Date.now()}`
          }
        }));
        // Award flex points
        setFlexPoints(flexPoints + 1.5);
        setFlexPointsTracking(prev => ({
          ...prev,
          lastMonthlyReviewMonth: currentMonth
        }));
        // Switch to main view (which shows chat)
        setAppMode(null);
      };

      // Check if it's time for yearly review (last 7 days of December)
      const currentYear = today.getFullYear().toString();
      const isDecember = today.getMonth() === 11;
      const daysUntilEndOfYear = 31 - today.getDate();
      const isYearlyReviewTime = isDecember && daysUntilEndOfYear <= 6;
      const yearlyReviewCompleted = yearlyReflections[currentYear]?.completed;

      // Generate yearly summary
      const generateYearlySummary = () => {
        const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
        const yearEntries = Object.entries(journalEntries).filter(([date]) => {
          const entryDate = new Date(date);
          return entryDate >= firstDayOfYear && entryDate <= today;
        });
        
        const journalDays = yearEntries.length;
        const completedTends = tendyHistory.filter(t => {
          const tendDate = new Date(t.date);
          return tendDate >= firstDayOfYear && tendDate <= today && t.completed;
        }).length;
        
        const completedGoals = goals.filter(g => g.completed).length;

        // Count completed monthly reviews
        const monthsReviewed = Object.keys(monthlyReviews).filter(m => 
          m.startsWith(currentYear) && monthlyReviews[m]?.completed
        ).length;

        return `Hi! As we approach the end of ${currentYear}, I've prepared a reflection on your year:

üéä **Your Year in Numbers:**
- You journaled ${journalDays} days this year
- You completed ${completedTends} daily tends
- You achieved ${completedGoals} goals
- You completed ${monthsReviewed} monthly reflections

üå± **Your Growth Areas This Year:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const gap = importance - (vlqScores[key]?.consistency || 5);
  return gap >= 2;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No specific focus areas'}

üí™ **Your Strengths:**
${VLQ_ORDER.filter(key => {
  const importance = vlqScores[key]?.importance || 5;
  const consistency = vlqScores[key]?.consistency || 5;
  const gap = importance - consistency;
  return importance >= 5 && gap < 3;
}).map(key => `- ${VLQ_DOMAINS[key].icon} ${VLQ_DOMAINS[key].name}`).join('\n') || 'No identified strengths'}

This has been your year of growth and intention. What are you most proud of? What did you learn about yourself? As we move into ${parseInt(currentYear) + 1}, what do you want to carry forward, and what do you want to leave behind?`;
      };

      const startYearlyReview = () => {
        // Save any previous conversation before starting new one
        saveCurrentConversation();
        
        const summary = generateYearlySummary();
        setMessages([{
          role: 'assistant',
          content: summary
        }]);
        setCurrentConversationType('yearly_review');
        setYearlyReflections(prev => ({
          ...prev,
          [currentYear]: { 
            completed: true, 
            completedAt: new Date().toISOString(),
            conversationId: `yearly_${currentYear}_${Date.now()}`
          }
        }));
        // Award flex points (2 for yearly)
        setFlexPoints(flexPoints + 2);
        // Switch to main view (which shows chat)
        setAppMode(null);
      };

      const journalStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
        },
        header: {
          padding: '1rem 2rem',
          borderBottom: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        },
        headerLeft: {
          display: 'flex',
          alignItems: 'center',
          gap: '1rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.25rem',
          color: 'var(--text-muted)',
          cursor: 'pointer',
          padding: '0.25rem',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.25rem',
          color: 'var(--text)',
        },
        flexPointsBadge: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          padding: '0.375rem 0.75rem',
          backgroundColor: 'var(--accent-light)',
          border: '1px solid var(--accent)',
          borderRadius: '8px',
          fontSize: '0.8rem',
          color: 'var(--text)',
        },
        switchButton: {
          padding: '0.5rem 1rem',
          backgroundColor: 'var(--bg-elevated)',
          border: '1px solid var(--border)',
          borderRadius: '8px',
          color: 'var(--text-muted)',
          fontSize: '0.8rem',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        content: {
          flex: 1,
          padding: '2rem',
          maxWidth: '600px',
          margin: '0 auto',
          width: '100%',
        },
        reviewPrompt: {
          padding: '1.5rem',
          backgroundColor: 'var(--accent-light)',
          border: '2px solid var(--accent)',
          borderRadius: '12px',
          marginBottom: '2rem',
        },
        reviewPromptTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        reviewPromptText: {
          fontSize: '0.85rem',
          color: 'var(--text-muted)',
          marginBottom: '1rem',
        },
        reviewButton: {
          padding: '0.75rem 1.25rem',
          backgroundColor: 'var(--accent)',
          color: 'white',
          border: 'none',
          borderRadius: '8px',
          fontSize: '0.9rem',
          fontWeight: 500,
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
      };

      return (
        <div style={journalStyles.container}>
          <div style={journalStyles.header}>
            <div style={journalStyles.headerLeft}>
              <button style={journalStyles.backButton} onClick={onBack} title="Back">
                ‚Üê
              </button>
              <h2 style={journalStyles.title}>Daily Journal</h2>
            </div>
            <div style={{display: 'flex', gap: '0.75rem', alignItems: 'center'}}>
              <div style={journalStyles.flexPointsBadge}>
                <span>ü™¥</span>
                <span>{flexPoints} flex</span>
              </div>
            </div>
          </div>

          <div style={journalStyles.content}>
            {/* Monthly Review Prompt */}
            {isMonthlyReviewTime && !monthlyReviewCompleted && (
              <div style={journalStyles.reviewPrompt}>
                <h3 style={journalStyles.reviewPromptTitle}>
                  <span>üåô</span>
                  <span>Monthly Reflection Available</span>
                </h3>
                <p style={journalStyles.reviewPromptText}>
                  It's the end of the month! Let's reflect on your journey together. I've prepared a summary of your month and we can chat about what you learned, what you're proud of, and what you want to focus on next month.
                </p>
                <p style={{...journalStyles.reviewPromptText, fontSize: '0.75rem', fontStyle: 'italic'}}>
                  Earn +1.5 flex points for completing your monthly reflection
                </p>
                <button style={journalStyles.reviewButton} onClick={startMonthlyReview}>
                  <span>‚ú®</span>
                  <span>Start Monthly Reflection</span>
                </button>
              </div>
            )}

            {/* Yearly Review Prompt */}
            {isYearlyReviewTime && !yearlyReviewCompleted && (
              <div style={journalStyles.reviewPrompt}>
                <h3 style={journalStyles.reviewPromptTitle}>
                  <span>üéä</span>
                  <span>Year in Review Available</span>
                </h3>
                <p style={journalStyles.reviewPromptText}>
                  As {currentYear} comes to a close, let's reflect on your entire year together. I've prepared a comprehensive summary of your growth, achievements, and journey. This is a special moment to honor how far you've come.
                </p>
                <p style={{...journalStyles.reviewPromptText, fontSize: '0.75rem', fontStyle: 'italic'}}>
                  Earn +2 flex points for completing your yearly reflection
                </p>
                <button style={journalStyles.reviewButton} onClick={startYearlyReview}>
                  <span>üåü</span>
                  <span>Start Year in Review</span>
                </button>
              </div>
            )}

            <DailyJournalTab 
              vlqScores={vlqScores}
              journalEntries={journalEntries}
              setJournalEntries={setJournalEntries}
              todaysTendies={todaysTendies}
              tendyHistory={tendyHistory}
            />
          </div>
        </div>
      );
    }
    // ============ DAILY JOURNAL TAB ============
    function DailyJournalTab({ vlqScores, journalEntries, setJournalEntries, todaysTendies, tendyHistory }) {
      const today = new Date();
      const dateKey = today.toISOString().split('T')[0];
      const dateString = today.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'long', 
        day: 'numeric' 
      });
      
      const [isSaved, setIsSaved] = useState(false);
      const [reflectionText, setReflectionText] = useState('');

      // Load today's entry
      const todayEntry = journalEntries[dateKey] || {};
      
      // Initialize reflection text from saved entry
      React.useEffect(() => {
        if (todayEntry.tendReflection) {
          setReflectionText(todayEntry.tendReflection);
        }
      }, [dateKey]);

      // Get today's tend - check if revealed/selected
      const todaysTend = todaysTendies.find(t => t.selected || t.completed || t.revealed);
      
      // Auto-detect if tend was completed (from tendyHistory)
      const tendCompleted = tendyHistory.find(t => t.date === dateKey && t.completed);
      const tendSkipped = tendyHistory.find(t => t.date === dateKey && t.skipped);
      
      // Determine completion status
      const completionStatus = tendCompleted ? 'completed' : tendSkipped ? 'skipped' : null;

      // Save journal entry
      const saveEntry = () => {
        if (!reflectionText.trim()) return;
        
        setJournalEntries(prev => ({
          ...prev,
          [dateKey]: {
            ...prev[dateKey],
            tendReflection: reflectionText,
            tendId: todaysTend?.id,
            tendText: todaysTend?.text,
            tendDomain: todaysTend?.domain,
            completionStatus: completionStatus,
            savedAt: new Date().toISOString()
          }
        }));
        setIsSaved(true);
        setTimeout(() => setIsSaved(false), 2000);
      };

      const tabStyles = {
        date: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '1.5rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.75rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '120px',
          boxSizing: 'border-box',
        },
        tendyCard: {
          padding: '1rem',
          backgroundColor: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '10px',
          marginBottom: '1rem',
        },
        statusBadge: {
          display: 'inline-flex',
          alignItems: 'center',
          gap: '0.375rem',
          padding: '0.375rem 0.75rem',
          borderRadius: '20px',
          fontSize: '0.75rem',
          fontWeight: 500,
        },
        saveButton: {
          padding: '0.75rem 1.5rem',
          backgroundColor: 'var(--accent)',
          color: 'white',
          border: 'none',
          borderRadius: '8px',
          fontSize: '0.9rem',
          fontWeight: 500,
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '0.5rem',
          width: '100%',
          marginTop: '1rem',
        },
        savedButton: {
          padding: '0.75rem 1.5rem',
          backgroundColor: '#4CAF50',
          color: 'white',
          border: 'none',
          borderRadius: '8px',
          fontSize: '0.9rem',
          fontWeight: 500,
          cursor: 'default',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '0.5rem',
          width: '100%',
          marginTop: '1rem',
        },
        noTendCard: {
          padding: '1.5rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
          textAlign: 'center',
        },
      };

      return (
        <div>
          <div style={tabStyles.date}>{dateString}</div>

          {/* Daily Tend Reflection */}
          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Today's Tend</h3>
            
            {todaysTend ? (
              <>
                <div style={tabStyles.tendyCard}>
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.75rem'}}>
                    <div style={{fontSize: '0.9rem', color: 'var(--text)', flex: 1, marginRight: '1rem'}}>
                      {todaysTend.text}
                    </div>
                    {completionStatus && (
                      <div style={{
                        ...tabStyles.statusBadge,
                        backgroundColor: completionStatus === 'completed' ? '#E8F5E9' : '#FFF3E0',
                        color: completionStatus === 'completed' ? '#2E7D32' : '#E65100',
                      }}>
                        {completionStatus === 'completed' ? '‚úì Completed' : '‚óã Skipped'}
                      </div>
                    )}
                  </div>
                  <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>
                    {todaysTend.domainIcon} {todaysTend.domainName}
                  </div>
                </div>

                {completionStatus === 'completed' ? (
                  <div>
                    <div style={tabStyles.prompt}>How did it go? What did you notice or learn?</div>
                    <textarea
                      style={tabStyles.textarea}
                      value={reflectionText}
                      onChange={(e) => setReflectionText(e.target.value)}
                      placeholder="Reflect on your experience completing this tend..."
                      rows={5}
                    />
                  </div>
                ) : completionStatus === 'skipped' ? (
                  <div>
                    <div style={tabStyles.prompt}>What got in the way? Any thoughts on what you could do differently?</div>
                    <textarea
                      style={tabStyles.textarea}
                      value={reflectionText}
                      onChange={(e) => setReflectionText(e.target.value)}
                      placeholder="Reflect on what prevented you from completing it..."
                      rows={5}
                    />
                  </div>
                ) : (
                  <div style={{
                    padding: '1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    textAlign: 'center',
                    color: 'var(--text-muted)',
                    fontSize: '0.85rem',
                  }}>
                    Complete or skip your tend to reflect on it here
                  </div>
                )}

                {completionStatus && reflectionText.trim() && (
                  <button 
                    style={isSaved ? tabStyles.savedButton : tabStyles.saveButton}
                    onClick={saveEntry}
                    disabled={isSaved}
                  >
                    {isSaved ? (
                      <>
                        <span>‚úì</span>
                        <span>Saved!</span>
                      </>
                    ) : (
                      <>
                        <span>üíæ</span>
                        <span>Save Journal Entry</span>
                      </>
                    )}
                  </button>
                )}
                
                {todayEntry.savedAt && !isSaved && (
                  <div style={{
                    textAlign: 'center',
                    fontSize: '0.75rem',
                    color: 'var(--text-muted)',
                    marginTop: '0.5rem',
                  }}>
                    Last saved {new Date(todayEntry.savedAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                  </div>
                )}
              </>
            ) : (
              <div style={tabStyles.noTendCard}>
                <div style={{fontSize: '2rem', marginBottom: '0.75rem'}}>üå±</div>
                <div style={{fontSize: '0.9rem', color: 'var(--text)', marginBottom: '0.5rem'}}>
                  No tend revealed yet today
                </div>
                <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>
                  Head to Daily Tend to reveal today's activity
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }
    // ============ MONTHLY REVIEW TAB ============
    function MonthlyReviewTab({ monthlyReviews, setMonthlyReviews, flexPoints, setFlexPoints, flexPointsTracking, setFlexPointsTracking }) {
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
      const monthName = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      // Load this month's review or create empty
      const thisMonthReview = monthlyReviews[currentMonth] || {
        wins: '',
        challenges: '',
        lessons: '',
        nextMonth: ''
      };

      // Update this month's review
      const updateReview = (field, value) => {
        const wasComplete = isReviewComplete(thisMonthReview);
        
        const updatedReview = {
          ...thisMonthReview,
          [field]: value
        };
        
        setMonthlyReviews(prev => ({
          ...prev,
          [currentMonth]: updatedReview
        }));

        // Award flex points if review just became complete
        const isNowComplete = isReviewComplete(updatedReview);
        if (!wasComplete && isNowComplete && flexPointsTracking.lastMonthlyReviewMonth !== currentMonth) {
          setFlexPoints(flexPoints + 1.5);
          setFlexPointsTracking(prev => ({
            ...prev,
            lastMonthlyReviewMonth: currentMonth
          }));
        }
      };

      // Check if review is complete (all fields filled)
      const isReviewComplete = (review) => {
        return review.wins?.trim() && review.challenges?.trim() && 
               review.lessons?.trim() && review.nextMonth?.trim();
      };

      const completed = isReviewComplete(thisMonthReview);
      const alreadyAwarded = flexPointsTracking.lastMonthlyReviewMonth === currentMonth;

      const tabStyles = {
        monthName: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '2rem',
        },
        completionBadge: {
          display: 'inline-flex',
          alignItems: 'center',
          gap: '0.5rem',
          padding: '0.5rem 1rem',
          backgroundColor: 'var(--accent-light)',
          border: '1px solid var(--accent)',
          borderRadius: '8px',
          fontSize: '0.85rem',
          color: 'var(--text)',
          marginBottom: '2rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '100px',
        },
      };

      return (
        <div>
          <h2 style={tabStyles.monthName}>{monthName} Review</h2>
          <div style={tabStyles.subtitle}>
            Reflect on this month and earn 1.5 flex points for completing your review
          </div>

          {completed && alreadyAwarded && (
            <div style={tabStyles.completionBadge}>
              <span>‚ú®</span>
              <span>Review complete! +1.5 flex points earned</span>
            </div>
          )}

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Wins & Highlights</h3>
            <div style={tabStyles.prompt}>What were your biggest wins this month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.wins || ''}
              onChange={(e) => updateReview('wins', e.target.value)}
              placeholder="What went well? What are you proud of?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Challenges</h3>
            <div style={tabStyles.prompt}>What challenges did you face?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.challenges || ''}
              onChange={(e) => updateReview('challenges', e.target.value)}
              placeholder="What was difficult? What obstacles came up?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Lessons Learned</h3>
            <div style={tabStyles.prompt}>What did you learn about yourself this month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.lessons || ''}
              onChange={(e) => updateReview('lessons', e.target.value)}
              placeholder="What insights or realizations did you have?"
              rows={5}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Looking Ahead</h3>
            <div style={tabStyles.prompt}>What do you want to focus on next month?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisMonthReview.nextMonth || ''}
              onChange={(e) => updateReview('nextMonth', e.target.value)}
              placeholder="What intentions or goals do you have for next month?"
              rows={5}
            />
          </div>
        </div>
      );
    }
    // ============ YEARLY REFLECTION TAB ============
    function YearlyReflectionTab({ yearlyReflections, setYearlyReflections }) {
      const today = new Date();
      const currentYear = today.getFullYear().toString();

      // Load this year's reflection or create empty
      const thisYearReflection = yearlyReflections[currentYear] || {
        definingMoments: '',
        growth: '',
        gratitude: '',
        intentions: ''
      };

      // Update this year's reflection
      const updateReflection = (field, value) => {
        setYearlyReflections(prev => ({
          ...prev,
          [currentYear]: {
            ...prev[currentYear],
            [field]: value
          }
        }));
      };

      const tabStyles = {
        yearName: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.875rem',
          marginBottom: '2rem',
        },
        section: {
          marginBottom: '2rem',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        prompt: {
          fontSize: '0.875rem',
          color: 'var(--text-muted)',
          marginBottom: '0.75rem',
          fontStyle: 'italic',
        },
        textarea: {
          width: '100%',
          padding: '0.75rem',
          fontSize: '0.9rem',
          borderRadius: '8px',
          border: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          color: 'var(--text)',
          fontFamily: 'inherit',
          resize: 'vertical',
          minHeight: '120px',
        },
      };

      return (
        <div>
          <h2 style={tabStyles.yearName}>{currentYear} Reflection</h2>
          <div style={tabStyles.subtitle}>
            Take time to reflect on the year that was and set intentions for the year ahead
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Defining Moments</h3>
            <div style={tabStyles.prompt}>What were the defining moments of this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.definingMoments || ''}
              onChange={(e) => updateReflection('definingMoments', e.target.value)}
              placeholder="What experiences, decisions, or events shaped your year?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Growth & Change</h3>
            <div style={tabStyles.prompt}>How have you grown this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.growth || ''}
              onChange={(e) => updateReflection('growth', e.target.value)}
              placeholder="What have you learned? How have you changed?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Gratitude</h3>
            <div style={tabStyles.prompt}>What are you grateful for from this year?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.gratitude || ''}
              onChange={(e) => updateReflection('gratitude', e.target.value)}
              placeholder="Who and what are you thankful for?"
              rows={6}
            />
          </div>

          <div style={tabStyles.section}>
            <h3 style={tabStyles.sectionTitle}>Intentions for Next Year</h3>
            <div style={tabStyles.prompt}>What intentions do you have for the year ahead?</div>
            <textarea
              style={tabStyles.textarea}
              value={thisYearReflection.intentions || ''}
              onChange={(e) => updateReflection('intentions', e.target.value)}
              placeholder="What do you want to focus on? What kind of year do you want to create?"
              rows={6}
            />
          </div>
        </div>
      );
    }

    // ============ YEAR CIRCLE VIEW ============
    function YearCircleView({ events, revealed, onAddEvent }) {
      const size = 400;
      const center = size / 2;
      const outerRadius = 175;
      const innerRadius = 75;
      const monthRadius = 145;
      const currentMonth = new Date().getMonth();

      const getMonthPosition = (monthIndex) => {
        const angle = ((monthIndex - 2) / 12) * 2 * Math.PI - Math.PI / 2;
        return { x: center + Math.cos(angle) * monthRadius, y: center + Math.sin(angle) * monthRadius };
      };

      const getEventPosition = (monthIndex, eventIndex = 0) => {
        const angle = ((monthIndex - 2) / 12) * 2 * Math.PI - Math.PI / 2;
        const radius = innerRadius + 18 + (eventIndex * 12);
        return { x: center + Math.cos(angle) * radius, y: center + Math.sin(angle) * radius };
      };

      const polarToCartesian = (centerX, centerY, radius, angleInDegrees) => {
        const angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return { x: centerX + radius * Math.cos(angleInRadians), y: centerY + radius * Math.sin(angleInRadians) };
      };

      const describeArc = (startAngle, endAngle, radius) => {
        const start = polarToCartesian(center, center, radius, endAngle);
        const end = polarToCartesian(center, center, radius, startAngle);
        const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
        return `M ${start.x} ${start.y} A ${radius} ${radius} 0 ${largeArcFlag} 0 ${end.x} ${end.y} L ${center} ${center} Z`;
      };

      const seasonArcs = [
        { id: 'winter', start: -60, end: 30, color: '#7EB3E0' },
        { id: 'spring', start: 30, end: 120, color: '#8FD4A0' },
        { id: 'summer', start: 120, end: 210, color: '#F9D07A' },
        { id: 'fall', start: 210, end: 300, color: '#E8A090' },
      ];

      return (
        <div style={styles.circleContainer}>
          <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
            {seasonArcs.map(season => (
              <path key={season.id} d={describeArc(season.start, season.end, outerRadius)} fill={season.color} opacity={0.35} />
            ))}

            <circle cx={center} cy={center} r={innerRadius} fill="var(--bg-card)" stroke="var(--border)" strokeWidth="1" />

            <text x={center} y={center} textAnchor="middle" dominantBaseline="middle" fill="var(--text)"
              style={{ fontFamily: "'Fraunces', serif", fontSize: '1.75rem' }}>
              2026
            </text>

            {MONTHS.map((month, idx) => {
              const pos = getMonthPosition(idx);
              const isCurrent = idx === currentMonth;
              return (
                <g key={month}>
                  <text x={pos.x} y={pos.y} textAnchor="middle" dominantBaseline="middle"
                    fill={isCurrent ? 'var(--text)' : 'var(--text-light)'}
                    style={{ fontFamily: "'DM Sans', sans-serif", fontSize: '0.7rem', fontWeight: isCurrent ? 600 : 400 }}>
                    {month}
                  </text>
                  {isCurrent && <circle cx={pos.x} cy={pos.y + 10} r="2" fill="var(--accent)" />}
                </g>
              );
            })}

            {events.map((event) => {
              const monthEvents = events.filter(e => e.month === event.month);
              const eventIndex = monthEvents.indexOf(event);
              const pos = getEventPosition(event.month, eventIndex);
              const color = LIFE_AREAS[event.lifeArea]?.color || 'var(--accent)';
              return (
                <g key={event.id} className="fade-in">
                  <circle cx={pos.x} cy={pos.y} r="6" fill={color} />
                  <circle cx={pos.x} cy={pos.y} r="2.5" fill="white" opacity="0.5" />
                </g>
              );
            })}
          </svg>
        </div>
      );
    }

    // ============ SEASONS VIEW ============
    function SeasonsView({ seasonIntentions, setSeasonIntentions, revealed }) {
      const seasons = [
        { 
          id: 'winter', 
          name: 'Winter', 
          months: 'Dec ‚Äì Feb', 
          color: '#7EB3E0', 
          lightColor: '#F5F9FC', 
          elements: ['‚ùÑ', '¬∑', '‚ùÑ', '¬∑', '‚ùÑ'],
          description: 'A time for rest, reflection, and turning inward. Shorter days invite quiet planning, cozy routines, and nurturing what matters most.'
        },
        { 
          id: 'spring', 
          name: 'Spring', 
          months: 'Mar ‚Äì May', 
          color: '#8FD4A0', 
          lightColor: '#F5FBF6', 
          elements: ['‚úø', '¬∑', '‚ùÄ', '¬∑', '‚úø'],
          description: 'A time for new beginnings and fresh energy. Nature awakens ‚Äî a good season to plant seeds, start projects, and embrace growth.'
        },
        { 
          id: 'summer', 
          name: 'Summer', 
          months: 'Jun ‚Äì Aug', 
          color: '#F9D07A', 
          lightColor: '#FFFDF7', 
          elements: ['‚òÄ', '~', '‚òÄ', '~', '‚òÄ'],
          description: 'A time for expansion, adventure, and connection. Long days invite travel, outdoor activities, and making memories with others.'
        },
        { 
          id: 'fall', 
          name: 'Fall', 
          months: 'Sep ‚Äì Nov', 
          color: '#E8A090', 
          lightColor: '#FDF7F5', 
          elements: ['üçÇ', '¬∑', 'üçÅ', '¬∑', 'üçÇ'],
          description: 'A time for harvest and gratitude. Energy turns toward completion, gathering, and preparing for the quieter months ahead.'
        },
      ];

      const currentSeason = (() => {
        const month = new Date().getMonth();
        if ([11, 0, 1].includes(month)) return 'winter';
        if ([2, 3, 4].includes(month)) return 'spring';
        if ([5, 6, 7].includes(month)) return 'summer';
        return 'fall';
      })();

      return (
        <div style={styles.seasonsContainer}>
          <div style={styles.seasonsGrid}>
            {seasons.map(season => (
              <div 
                key={season.id} 
                style={{
                  ...styles.seasonCard,
                  backgroundColor: season.lightColor,
                  borderColor: season.id === currentSeason ? season.color : 'transparent',
                  borderWidth: '2px',
                }}
              >
                {/* Decorative top */}
                <div style={{...styles.seasonDecorative, color: season.color}}>
                  {season.elements.map((el, i) => (
                    <span key={i} style={{opacity: i % 2 === 0 ? 1 : 0.5}}>{el}</span>
                  ))}
                </div>

                <div style={styles.seasonCardContent}>
                  <div style={styles.seasonCardHeader}>
                    <h3 style={{...styles.seasonName, color: season.color}}>{season.name}</h3>
                    <span style={styles.seasonMonths}>{season.months}</span>
                    {season.id === currentSeason && (
                      <span style={{...styles.currentBadge, backgroundColor: `${season.color}90`}}>Now</span>
                    )}
                  </div>
                  
                  <p style={styles.seasonDescription}>{season.description}</p>
                  
                  <div style={styles.seasonIntentionBox}>
                    <label style={{...styles.seasonLabel, color: season.color}}>What do you envision for this season?</label>
                    <textarea
                      style={{
                        ...styles.seasonTextarea,
                        borderColor: revealed ? season.color : 'var(--border)',
                        opacity: revealed ? 1 : 0.6,
                      }}
                      value={seasonIntentions[season.id] || ''}
                      onChange={(e) => setSeasonIntentions({...seasonIntentions, [season.id]: e.target.value})}
                      placeholder={revealed ? 'Your intention for this season...' : 'Complete conversation to unlock'}
                      disabled={!revealed}
                      rows={2}
                    />
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // ============ MONTHLY VIEW ============
    function MonthlyView({ events, selectedMonth, setSelectedMonth, revealed, onAddEvent, weeklyHabits, habitCompletions, setHabitCompletions, journalEntries = {}, tendyHistory = [], onNavigateToTend }) {
      const year = 2026;
      const daysInMonth = new Date(year, selectedMonth + 1, 0).getDate();
      const firstDayOfMonth = new Date(year, selectedMonth, 1).getDay();
      const monthEvents = events.filter(e => e.month === selectedMonth);
      const currentMonth = new Date().getMonth();
      const today = new Date().getDate();
      const [selectedDay, setSelectedDay] = useState(null);

      const getSeasonColor = (monthIdx) => {
        if ([11, 0, 1].includes(monthIdx)) return '#7EB3E0';
        if ([2, 3, 4].includes(monthIdx)) return '#8FD4A0';
        if ([5, 6, 7].includes(monthIdx)) return '#F9D07A';
        return '#E8A090';
      };

      const seasonColor = getSeasonColor(selectedMonth);
      
      // Count total habits for display
      const totalHabits = weeklyHabits?.length || 0;
      
      // Get date string for a given day
      const getDateKey = (day) => {
        const month = (selectedMonth + 1).toString().padStart(2, '0');
        const dayStr = day.toString().padStart(2, '0');
        return `${year}-${month}-${dayStr}`;
      };
      
      // Check if a habit is completed for a given date
      const isHabitCompleted = (dateKey, habitId) => {
        const dayData = habitCompletions?.[dateKey];
        if (!dayData) return false;
        return dayData.weekly?.includes(habitId);
      };
      
      // Toggle habit completion
      const toggleHabit = (dateKey, habitId) => {
        setHabitCompletions(prev => {
          const dayData = prev[dateKey] || { weekly: [] };
          const list = [...(dayData.weekly || [])];
          
          if (list.includes(habitId)) {
            // Remove it
            return {
              ...prev,
              [dateKey]: {
                ...dayData,
                weekly: list.filter(id => id !== habitId)
              }
            };
          } else {
            // Add it
            return {
              ...prev,
              [dateKey]: {
                ...dayData,
                weekly: [...list, habitId]
              }
            };
          }
        });
      };
      
      // Count completions for a day
      const getCompletionCount = (day) => {
        const dateKey = getDateKey(day);
        const dayData = habitCompletions?.[dateKey];
        if (!dayData) return 0;
        return dayData.weekly?.length || 0;
      };

      // Day Detail Modal
      const DayDetail = ({ day, onClose }) => {
        const dayName = new Date(year, selectedMonth, day).toLocaleDateString('en-US', { weekday: 'long' });
        const fullDate = new Date(year, selectedMonth, day).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        const dateKey = getDateKey(day);
        
        // Get tend for this day
        const dayTend = tendyHistory.find(t => t.date === dateKey);
        
        // Get journal entry for this day
        const dayJournal = journalEntries[dateKey];
        
        // Check if this is today
        const isToday = selectedMonth === currentMonth && day === today;
        
        // Check if date is in the future
        const selectedDate = new Date(year, selectedMonth, day);
        const todayDate = new Date();
        todayDate.setHours(0, 0, 0, 0);
        const isFuture = selectedDate > todayDate;
        
        return (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0,0,0,0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 1000,
            padding: '1rem'
          }} onClick={onClose}>
            <div style={{
              backgroundColor: 'var(--bg-card)',
              borderRadius: '16px',
              padding: '1.5rem',
              maxWidth: '400px',
              width: '100%',
              maxHeight: '80vh',
              overflow: 'auto',
              boxShadow: '0 4px 24px rgba(0,0,0,0.15)'
            }} onClick={e => e.stopPropagation()}>
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'flex-start',
                marginBottom: '1.5rem'
              }}>
                <div>
                  <h3 style={{
                    fontFamily: "'Fraunces', serif",
                    fontSize: '1.25rem',
                    color: 'var(--text)',
                    marginBottom: '0.25rem'
                  }}>{dayName}</h3>
                  <p style={{
                    fontSize: '0.85rem',
                    color: 'var(--text-muted)'
                  }}>{fullDate}</p>
                </div>
                <button 
                  onClick={onClose}
                  style={{
                    background: 'none',
                    border: 'none',
                    fontSize: '1.5rem',
                    color: 'var(--text-muted)',
                    cursor: 'pointer',
                    padding: '0.25rem'
                  }}
                >√ó</button>
              </div>
              
              {/* Daily Tend */}
              <div style={{ marginBottom: '1.25rem' }}>
                <h4 style={{
                  fontSize: '0.75rem',
                  fontWeight: 600,
                  color: 'var(--text-muted)',
                  textTransform: 'uppercase',
                  letterSpacing: '0.05em',
                  marginBottom: '0.75rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}>
                  <span>üå±</span> Daily Tend
                </h4>
                
                {dayTend ? (
                  <div style={{
                    padding: '0.75rem',
                    backgroundColor: dayTend.completed ? '#E8F5E9' : dayTend.skipped ? '#FFF3E0' : 'var(--bg-elevated)',
                    borderRadius: '8px',
                    border: `1px solid ${dayTend.completed ? '#A5D6A7' : dayTend.skipped ? '#FFCC80' : 'var(--border)'}`,
                  }}>
                    <div style={{ fontSize: '0.9rem', color: 'var(--text)', marginBottom: '0.5rem' }}>
                      {dayTend.text}
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <span style={{ fontSize: '0.75rem', color: 'var(--text-muted)' }}>
                        {dayTend.domainIcon} {dayTend.domainName}
                      </span>
                      <span style={{
                        fontSize: '0.7rem',
                        fontWeight: 500,
                        padding: '0.2rem 0.5rem',
                        borderRadius: '10px',
                        backgroundColor: dayTend.completed ? '#2E7D32' : dayTend.skipped ? '#E65100' : 'var(--text-muted)',
                        color: 'white',
                      }}>
                        {dayTend.completed ? '‚úì Completed' : dayTend.skipped ? 'Skipped' : 'Revealed'}
                      </span>
                    </div>
                  </div>
                ) : isFuture ? (
                  <div style={{
                    padding: '1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    textAlign: 'center',
                    color: 'var(--text-muted)',
                    fontSize: '0.85rem',
                  }}>
                    Future date ‚Äî tend not yet available
                  </div>
                ) : isToday ? (
                  <div style={{
                    padding: '1rem',
                    backgroundColor: 'var(--accent-light)',
                    border: '1px dashed var(--accent)',
                    borderRadius: '8px',
                    textAlign: 'center',
                  }}>
                    <div style={{ fontSize: '0.85rem', color: 'var(--text)', marginBottom: '0.5rem' }}>
                      No tend revealed yet today
                    </div>
                    {onNavigateToTend && (
                      <button 
                        onClick={() => { onClose(); onNavigateToTend(); }}
                        style={{
                          padding: '0.5rem 1rem',
                          backgroundColor: 'var(--accent)',
                          color: 'white',
                          border: 'none',
                          borderRadius: '6px',
                          fontSize: '0.8rem',
                          cursor: 'pointer',
                        }}
                      >
                        Go to Daily Tend ‚Üí
                      </button>
                    )}
                  </div>
                ) : (
                  <div style={{
                    padding: '1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    textAlign: 'center',
                    color: 'var(--text-muted)',
                    fontSize: '0.85rem',
                  }}>
                    No tend recorded for this day
                  </div>
                )}
              </div>
              
              {/* Journal Entry */}
              <div style={{ marginBottom: '1.25rem' }}>
                <h4 style={{
                  fontSize: '0.75rem',
                  fontWeight: 600,
                  color: 'var(--text-muted)',
                  textTransform: 'uppercase',
                  letterSpacing: '0.05em',
                  marginBottom: '0.75rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem'
                }}>
                  <span>üìù</span> Journal
                </h4>
                
                {dayJournal && dayJournal.tendReflection ? (
                  <div style={{
                    padding: '0.75rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    border: '1px solid var(--border)',
                  }}>
                    <div style={{ 
                      fontSize: '0.85rem', 
                      color: 'var(--text)', 
                      lineHeight: 1.5,
                      whiteSpace: 'pre-wrap'
                    }}>
                      {dayJournal.tendReflection}
                    </div>
                    {dayJournal.savedAt && (
                      <div style={{ 
                        fontSize: '0.7rem', 
                        color: 'var(--text-muted)', 
                        marginTop: '0.5rem',
                        textAlign: 'right'
                      }}>
                        Saved {new Date(dayJournal.savedAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                      </div>
                    )}
                  </div>
                ) : isFuture ? (
                  <div style={{
                    padding: '1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    textAlign: 'center',
                    color: 'var(--text-muted)',
                    fontSize: '0.85rem',
                  }}>
                    Future date
                  </div>
                ) : (
                  <div style={{
                    padding: '1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    textAlign: 'center',
                    color: 'var(--text-muted)',
                    fontSize: '0.85rem',
                  }}>
                    No journal entry for this day
                  </div>
                )}
              </div>
              
              {/* Habits */}
              {weeklyHabits && weeklyHabits.length > 0 && (
                <div style={{ marginBottom: '1.25rem' }}>
                  <h4 style={{
                    fontSize: '0.75rem',
                    fontWeight: 600,
                    color: 'var(--text-muted)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    marginBottom: '0.75rem',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}>
                    <span>üîÑ</span> Habits
                  </h4>
                  {weeklyHabits.map(habit => {
                    const completed = isHabitCompleted(dateKey, habit.id);
                    return (
                      <div 
                        key={habit.id} 
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          padding: '0.6rem 0',
                          borderBottom: '1px solid var(--border)',
                          cursor: isFuture ? 'default' : 'pointer',
                          opacity: isFuture ? 0.5 : 1,
                        }}
                        onClick={(e) => {
                          if (isFuture) return;
                          e.stopPropagation();
                          toggleHabit(dateKey, habit.id);
                        }}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                          <div style={{
                            width: '20px',
                            height: '20px',
                            borderRadius: '4px',
                            border: completed ? 'none' : '2px solid var(--border)',
                            backgroundColor: completed ? (habit.color || '#7EB3E0') : 'transparent',
                            flexShrink: 0,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'all 0.2s ease'
                          }}>
                            {completed && <span style={{ color: 'white', fontSize: '0.75rem', fontWeight: 'bold' }}>‚úì</span>}
                          </div>
                          <span style={{ 
                            fontSize: '0.9rem', 
                            color: completed ? 'var(--text-muted)' : 'var(--text)',
                            textDecoration: completed ? 'line-through' : 'none',
                            transition: 'all 0.2s ease'
                          }}>{habit.text}</span>
                        </div>
                        <span style={{
                          fontSize: '0.75rem',
                          color: 'var(--text-muted)',
                          backgroundColor: 'var(--bg-elevated)',
                          padding: '0.2rem 0.5rem',
                          borderRadius: '8px'
                        }}>{habit.frequency}x/wk</span>
                      </div>
                    );
                  })}
                </div>
              )}
              
              {/* Empty state */}
              {totalHabits === 0 && !dayTend && !dayJournal && (
                <p style={{
                  fontSize: '0.9rem',
                  color: 'var(--text-muted)',
                  textAlign: 'center',
                  padding: '1rem 0'
                }}>Nothing recorded for this day yet.</p>
              )}
            </div>
          </div>
        );
      };

      return (
        <div style={styles.monthlyContainer}>
          {/* Month selector strip */}
          <div style={styles.monthStrip}>
            {MONTHS.map((month, idx) => (
              <button
                key={idx}
                style={{
                  ...styles.monthStripButton,
                  backgroundColor: selectedMonth === idx ? `${getSeasonColor(idx)}40` : 'transparent',
                  color: selectedMonth === idx ? getSeasonColor(idx) : 'var(--text-muted)',
                  fontWeight: selectedMonth === idx ? 600 : 400,
                }}
                onClick={() => setSelectedMonth(idx)}
              >
                {month}
              </button>
            ))}
          </div>

          {/* Calendar */}
          <div style={{...styles.calendarWrapper, borderColor: seasonColor}}>
            <div style={{...styles.calendarHeader, backgroundColor: `${seasonColor}90`}}>
              <button style={styles.calendarNav} onClick={() => setSelectedMonth(selectedMonth === 0 ? 11 : selectedMonth - 1)}>‚Äπ</button>
              <h2 style={styles.calendarTitle}>{MONTH_FULL[selectedMonth]} 2026</h2>
              <button style={styles.calendarNav} onClick={() => setSelectedMonth(selectedMonth === 11 ? 0 : selectedMonth + 1)}>‚Ä∫</button>
            </div>

            <div style={styles.calendarBody}>
              <div style={styles.calendarGrid}>
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map((day, i) => (
                  <div key={i} style={styles.calendarDayHeader}>{day}</div>
                ))}
                {Array.from({ length: firstDayOfMonth }, (_, i) => (
                  <div key={`empty-${i}`} style={styles.calendarDayEmpty}></div>
                ))}
                {Array.from({ length: daysInMonth }, (_, i) => {
                  const day = i + 1;
                  const isToday = selectedMonth === currentMonth && day === today;
                  const completionCount = getCompletionCount(day);
                  const hasCompletions = completionCount > 0;
                  return (
                    <div 
                      key={day} 
                      style={{
                        ...styles.calendarDay, 
                        ...(isToday && {...styles.calendarDayToday, backgroundColor: `${seasonColor}70`}),
                        cursor: 'pointer',
                        position: 'relative',
                        ...(hasCompletions && { backgroundColor: `${seasonColor}20` })
                      }}
                      onClick={() => setSelectedDay(day)}
                    >
                      <span>{day}</span>
                      {/* Show completion indicator or habit dots */}
                      {totalHabits > 0 && (
                        <div style={{
                          position: 'absolute',
                          bottom: '4px',
                          left: '50%',
                          transform: 'translateX(-50%)',
                          display: 'flex',
                          gap: '2px',
                          alignItems: 'center'
                        }}>
                          {hasCompletions ? (
                            <div style={{
                              fontSize: '0.6rem',
                              color: seasonColor,
                              fontWeight: 600
                            }}>{completionCount}/{totalHabits}</div>
                          ) : (
                            <>
                              {weeklyHabits && weeklyHabits.slice(0, 3).map((h, idx) => (
                                <div key={idx} style={{
                                  width: '4px',
                                  height: '4px',
                                  borderRadius: '50%',
                                  backgroundColor: h.color || '#7EB3E0',
                                  opacity: 0.4
                                }}></div>
                              ))}
                            </>
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>

          {/* Events for this month */}
          <div style={styles.monthEventsSection}>
            {monthEvents.length > 0 ? (
              <div style={styles.monthEventsList}>
                {monthEvents.map(event => (
                  <div key={event.id} style={styles.monthEventItem}>
                    <span style={{...styles.eventDot, backgroundColor: LIFE_AREAS[event.lifeArea]?.color}}></span>
                    <span>{event.title}</span>
                  </div>
                ))}
              </div>
            ) : (
              <p style={styles.noEventsText}>No events in {MONTH_FULL[selectedMonth]}</p>
            )}
            {revealed && <button style={{...styles.addEventSmall, borderColor: seasonColor, color: seasonColor}} onClick={onAddEvent}>+ Add Event</button>}
          </div>
          
          {/* Day Detail Modal */}
          {selectedDay && (
            <DayDetail day={selectedDay} onClose={() => setSelectedDay(null)} />
          )}
        </div>
      );
    }

    // ============ TENDY VIEW (Daily Values Tasks) ============
    function TendyView({ 
      vlqScores, 
      todaysTendies, 
      setTodaysTendies, 
      tendyHistory, 
      setTendyHistory,
      tendyPoints,
      setTendyPoints,
      tendyStreak,
      setTendyStreak,
      flexPoints,
      setFlexPoints,
      weeklyCustomTendy,
      setWeeklyCustomTendy,
      userProfile,
      setUserProfile,
      goals,
      weeklyHabits,
      journalEntries,
      apiKey,
      onBack,
      onTendComplete,
      isOnboarding = false,
      onFinishOnboarding
    }) {
      const today = getLocalDateString();
      const [showCelebration, setShowCelebration] = useState(false);
      const [justCompletedPoints, setJustCompletedPoints] = useState(0);
      const [showCustomTendyForm, setShowCustomTendyForm] = useState(false);
      const [customTendyText, setCustomTendyText] = useState('');
      const [isSubmittingCustom, setIsSubmittingCustom] = useState(false);
      
      // Tend chat state
      const [showTendChat, setShowTendChat] = useState(false);
      const [tendChatMessages, setTendChatMessages] = useState([]);
      const [tendChatInput, setTendChatInput] = useState('');
      const [isTendChatTyping, setIsTendChatTyping] = useState(false);
      const tendChatRef = useRef(null);
      
      // Reflection input for reflective tends
      const [reflectionInput, setReflectionInput] = useState('');

      // Get the week identifier (e.g., "2026-W03")
      const getWeekIdentifier = () => {
        const date = new Date();
        const year = date.getFullYear();
        const oneJan = new Date(year, 0, 1);
        const dayOfYear = Math.floor((date - oneJan) / 86400000) + 1;
        const weekNum = Math.ceil((dayOfYear + oneJan.getDay()) / 7);
        return `${year}-W${weekNum.toString().padStart(2, '0')}`;
      };

      const currentWeek = getWeekIdentifier();
      const canCreateCustomThisWeek = !weeklyCustomTendy || weeklyCustomTendy.weekOf !== currentWeek;
      
      // Check completions this week (stored as array of completion dates)
      const completionsThisWeek = weeklyCustomTendy?.completions?.filter(c => 
        c.startsWith(currentWeek)
      ) || [];
      const customCompletionsRemaining = 2 - completionsThisWeek.length;
      const hasApprovedCustom = weeklyCustomTendy?.status === 'approved' && 
                                weeklyCustomTendy.weekOf === currentWeek &&
                                customCompletionsRemaining > 0;
      
      // Ref to prevent regeneration loops
      const isGeneratingTendies = useRef(false);

      // Check if we need to generate new tendies for today
      useEffect(() => {
        // Skip if already generating
        if (isGeneratingTendies.current) {
          return;
        }
        
        // Skip if no VLQ scores yet
        if (!vlqScores || Object.keys(vlqScores).length === 0) {
          console.log('TendyView: No VLQ scores yet, skipping tend generation');
          return;
        }
        
        const tendiesDate = todaysTendies[0]?.date;
        const generatedAt = todaysTendies[0]?.generatedAt;
        const isStale = !generatedAt || (new Date() - new Date(generatedAt)) > (18 * 60 * 60 * 1000);
        
        // Check weekend logic
        const dayOfWeek = new Date().getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        const tendiesAreWeekend = todaysTendies[0]?.isWeekend;
        
        // On Sunday, keep Saturday's weekend tend if not completed
        const saturdayDate = (() => {
          if (!isSunday) return null;
          const sat = new Date();
          sat.setDate(sat.getDate() - 1);
          return getLocalDateString(sat);
        })();
        
        // Check if we need to preserve the weekend tend from Saturday
        const weekendTendFromSaturday = isSunday && todaysTendies.find(t => 
          t.isWeekendTend && t.date === saturdayDate && !t.completed
        );
        
        const tendiesAreFromToday = todaysTendies.length > 0 && tendiesDate === today && !isStale;
        
        console.log('TendyView check:', { 
          today, 
          tendiesDate,
          generatedAt,
          isStale,
          tendiesAreFromToday,
          isWeekend,
          isSunday,
          weekendTendFromSaturday: !!weekendTendFromSaturday,
          tendiesCount: todaysTendies.length 
        });
        
        // Don't regenerate if tendies are from today (and not stale)
        if (tendiesAreFromToday) {
          return;
        }
        
        // Skip regeneration if a tend is already selected (prevent glitch on selection)
        if (todaysTendies.some(t => t.selected || t.completed)) {
          console.log('Tend already selected/completed, skipping regeneration');
          return;
        }
        
        const previousDomain = todaysTendies.find(t => !t.isWeekendTend)?.domain || null;
        console.log('Generating new tendies. Previous daily domain:', previousDomain, isWeekend ? '(WEEKEND)' : '(weekday)');
        
        // Set generating flag
        isGeneratingTendies.current = true;
        
        const generateAndSet = async () => {
          let newTendies;
          
          if (apiKey && userProfile) {
            try {
              newTendies = await generatePersonalizedTendies(vlqScores, tendyHistory, previousDomain, userProfile, apiKey, goals, weeklyHabits, journalEntries);
            } catch (err) {
              console.error('Personalization failed:', err);
              newTendies = generateDailyTendies(vlqScores, tendyHistory, previousDomain);
            }
          } else {
            newTendies = generateDailyTendies(vlqScores, tendyHistory, previousDomain);
          }
          
          // On Sunday, preserve uncompleted weekend tend from Saturday
          if (weekendTendFromSaturday) {
            // Remove any newly generated weekend tend and keep Saturday's
            newTendies = newTendies.filter(t => !t.isWeekendTend);
            newTendies.push(weekendTendFromSaturday);
          }
          
          setTodaysTendies(newTendies);
          isGeneratingTendies.current = false;
        };
        
        generateAndSet();
      }, [today, vlqScores]);

      const selectedTendy = todaysTendies.find(t => t.selected);
      const completedToday = todaysTendies.find(t => t.completed);
      
      // For the new tend structure - find daily and weekend tends
      const dailyTend = todaysTendies.find(t => !t.isWeekendTend);
      const weekendTend = todaysTendies.find(t => t.isWeekendTend);

      const selectTendy = (tendyId) => {
        setTodaysTendies(todaysTendies.map(t => ({
          ...t,
          selected: t.id === tendyId
        })));
      };
      
      // No auto-select - user must click to reveal their tend

      const rerollTendy = () => {
        if (flexPoints < 1 || !selectedTendy) return;
        
        // Deduct flex point
        setFlexPoints(flexPoints - 1);
        
        // Deselect current tendy so they can pick a different difficulty
        setTodaysTendies(todaysTendies.map(t => ({
          ...t,
          selected: false
        })));
      };

      // Tend chat function
      const sendTendChatMessage = async () => {
        if (!tendChatInput.trim() || !apiKey || !selectedTendy) return;
        
        const userMessage = tendChatInput.trim();
        setTendChatInput('');
        setTendChatMessages(prev => [...prev, { role: 'user', content: userMessage }]);
        setIsTendChatTyping(true);
        
        try {
          const tendPreferences = userProfile?.tendPreferences || {};
          
          // Get recent journal context
          const recentJournalEntries = Object.entries(journalEntries || {})
            .filter(([_, entry]) => entry.gratitude || entry.reflection)
            .sort((a, b) => b[0].localeCompare(a[0]))
            .slice(0, 3);
          
          const journalContext = recentJournalEntries.length > 0
            ? `\n\nRecent journal entries:\n${recentJournalEntries.map(([date, entry]) => {
                const parts = [];
                if (entry.gratitude) parts.push(`Gratitude: ${entry.gratitude}`);
                if (entry.reflection) parts.push(`Reflection: ${entry.reflection}`);
                return `${date}: ${parts.join(' | ')}`;
              }).join('\n')}`
            : '';
          
          // Get Life Map context for this domain
          const domainInfo = tendPreferences.structuredInfo?.[selectedTendy.domain] || {};
          const domainNotes = tendPreferences.lifeAreaNotes?.[selectedTendy.domain] || '';
          const lifeMapContext = Object.entries(domainInfo).filter(([_, v]) => v).length > 0 || domainNotes
            ? `\n\nWhat you know about their ${selectedTendy.domainName}:\n${Object.entries(domainInfo).filter(([_, v]) => v).map(([k, v]) => `- ${k}: ${v}`).join('\n')}${domainNotes ? `\n- Notes: ${domainNotes}` : ''}`
            : '';
          
          const systemPrompt = `You are Tend, a helpful assistant for a daily wellness app. The user has selected a daily tend (task) and wants to chat about it.

Current tend: "${selectedTendy.text}"
Life area: ${selectedTendy.domainName} (key: ${selectedTendy.domain})
Type: ${selectedTendy.type || 'action'}
Difficulty: ${selectedTendy.difficulty === 1 ? '5 minutes' : '30 minutes'}
${lifeMapContext}${journalContext}

Your job is to:
1. Help them with this tend - clarify, motivate, or adapt it to their situation
2. Learn about their context, resources, and preferences to improve future tends
3. If they share relevant personal details, extract them so future tends can be more personalized

EXTRACTING INFO FOR PERSONALIZATION:
When you learn something useful, include markers at the END of your response:

For specific details (names, places, preferences): [LIFE_MAP: lifeArea | key | value]
Examples:
- "My dog Max" ‚Üí [LIFE_MAP: health | pet | dog named Max]
- "I go to Planet Fitness" ‚Üí [LIFE_MAP: health | gym | Planet Fitness]
- "My partner Sarah" ‚Üí [LIFE_MAP: partner | partner name | Sarah]
- "I work from home" ‚Üí [LIFE_MAP: career | work situation | remote]

For general notes/context: [LEARN: category | info]
Categories: resources, context, preferences, lifeAreaNotes.AREA
Examples:
- [LEARN: resources | has gym membership]
- [LEARN: context | works_from_home]
- [LEARN: lifeAreaNotes.health | prefers morning workouts]

Life areas: family, partner, friendships, career, education, recreation, spirituality, community, health, mentalHealth

Don't mention these markers to the user - just naturally acknowledge you'll remember. Keep responses concise and supportive.`;

          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 500,
              system: systemPrompt,
              messages: [...tendChatMessages, { role: 'user', content: userMessage }].map(m => ({
                role: m.role,
                content: m.content
              }))
            })
          });

          const data = await response.json();
          let assistantMessage = data.content?.[0]?.text || "I'm sorry, I couldn't process that.";
          
          // Extract and process LEARN tags
          const learnMatches = assistantMessage.matchAll(/\[LEARN:\s*([^\|]+)\s*\|\s*([^\]]+)\]/g);
          const newPreferences = { ...tendPreferences };
          
          for (const match of learnMatches) {
            const category = match[1].trim();
            const info = match[2].trim();
            
            if (category.startsWith('lifeAreaNotes.')) {
              // Check for multi-domain (comma-separated)
              const domainsStr = category.replace('lifeAreaNotes.', '');
              const domains = domainsStr.split(',').map(d => d.trim()).filter(d => VLQ_ORDER.includes(d));
              
              if (domains.length > 1) {
                // Multi-domain fact - store in special array
                newPreferences.multiDomainFacts = newPreferences.multiDomainFacts || [];
                const exists = newPreferences.multiDomainFacts.some(f => f.text === info);
                if (!exists) {
                  newPreferences.multiDomainFacts.push({ domains, text: info, addedAt: new Date().toISOString() });
                }
              } else if (domains.length === 1) {
                // Single domain - store as before
                const lifeArea = domains[0];
                newPreferences.lifeAreaNotes = newPreferences.lifeAreaNotes || {};
                // Append to existing notes rather than replace
                const existing = newPreferences.lifeAreaNotes[lifeArea];
                if (existing && !existing.includes(info)) {
                  newPreferences.lifeAreaNotes[lifeArea] = existing + '; ' + info;
                } else if (!existing) {
                  newPreferences.lifeAreaNotes[lifeArea] = info;
                }
              }
            } else if (category === 'resources') {
              newPreferences.resources = newPreferences.resources || [];
              if (!newPreferences.resources.includes(info)) {
                newPreferences.resources.push(info);
              }
            } else if (category === 'context') {
              newPreferences.context = newPreferences.context || {};
              // Parse key-value from info like "works from home" -> { worksFromHome: true }
              const key = info.replace(/\s+/g, '_').toLowerCase();
              newPreferences.context[key] = true;
            } else if (category === 'preferences') {
              newPreferences.preferences = newPreferences.preferences || [];
              if (!newPreferences.preferences.includes(info)) {
                newPreferences.preferences.push(info);
              }
            }
          }
          
          // Update user profile if we learned something new
          if (JSON.stringify(newPreferences) !== JSON.stringify(tendPreferences)) {
            setUserProfile(prev => ({
              ...prev,
              tendPreferences: newPreferences
            }));
            console.log('Updated tend preferences:', newPreferences);
          }
          
          // Also process LIFE_MAP markers (same as main chat) for structured info
          const lifeMapMatches = assistantMessage.matchAll(/\[LIFE_MAP:\s*([a-zA-Z]+)\s*\|\s*([^|]+)\s*\|\s*([^\]]+)\]/g);
          for (const match of lifeMapMatches) {
            const lifeArea = match[1].trim().toLowerCase();
            const key = match[2].trim();
            const value = match[3].trim();
            
            if (lifeArea && key && value && VLQ_ORDER.includes(lifeArea)) {
              console.log('Life Map info extracted from tend chat:', lifeArea, '-', key, ':', value);
              setUserProfile(prev => {
                const prefs = prev?.tendPreferences || {};
                const existingInfo = prefs.structuredInfo?.[lifeArea] || {};
                
                // Append to existing value if key exists, otherwise create new
                const existingValue = existingInfo[key];
                const newValue = existingValue ? `${existingValue}, ${value}` : value;
                
                return {
                  ...prev,
                  tendPreferences: {
                    ...prefs,
                    structuredInfo: {
                      ...prefs.structuredInfo,
                      [lifeArea]: {
                        ...existingInfo,
                        [key]: newValue
                      }
                    }
                  }
                };
              });
            }
          }
          
          // Remove LEARN and LIFE_MAP tags from displayed message
          assistantMessage = assistantMessage
            .replace(/\[LEARN:[^\]]+\]/g, '')
            .replace(/\[LIFE_MAP:[^\]]+\]/g, '')
            .trim();
          
          setTendChatMessages(prev => [...prev, { role: 'assistant', content: assistantMessage }]);
        } catch (error) {
          console.error('Tend chat error:', error);
          setTendChatMessages(prev => [...prev, { 
            role: 'assistant', 
            content: "Sorry, I couldn't connect right now. Try again in a moment." 
          }]);
        }
        
        setIsTendChatTyping(false);
      };

      // Scroll tend chat to bottom
      useEffect(() => {
        if (tendChatRef.current) {
          tendChatRef.current.scrollTop = tendChatRef.current.scrollHeight;
        }
      }, [tendChatMessages]);

      const completeTendy = () => {
        // Check if custom tendy is selected
        if (weeklyCustomTendy?.selected) {
          const completionTimestamp = new Date().toISOString();
          const completedCustom = {
            id: `custom-${currentWeek}-${completionsThisWeek.length + 1}`,
            date: today,
            text: weeklyCustomTendy.text,
            points: 1,
            difficulty: 'custom',
            domainName: 'Custom',
            domainIcon: '‚ú®',
            completed: true,
            completedAt: completionTimestamp,
            gardenElement: { icon: 'üåü', element: 'Star', description: 'Personal intention' }
          };

          // Add to history
          setTendyHistory([...tendyHistory, completedCustom]);

          // Update points
          setTendyPoints(tendyPoints + 1);

          // Update streak
          const yesterday = new Date();
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split('T')[0];
          const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
          
          if (completedYesterday || tendyStreak === 0) {
            setTendyStreak(tendyStreak + 1);
          }

          // Add completion to weeklyCustomTendy (track all completions this week)
          const existingCompletions = weeklyCustomTendy.completions || [];
          setWeeklyCustomTendy({
            ...weeklyCustomTendy, 
            completions: [...existingCompletions, completionTimestamp],
            selected: false
          });

          // Show celebration
          setJustCompletedPoints(1);
          setShowCelebration(true);
          setTimeout(() => {
            setShowCelebration(false);
            if (onTendComplete) onTendComplete();
          }, 2500);
          return;
        }

        // Regular tendy completion
        if (!selectedTendy) return;
        
        const completedTendy = {
          ...selectedTendy,
          completed: true,
          completedAt: new Date().toISOString()
        };

        // Update today's tendies
        setTodaysTendies(todaysTendies.map(t => 
          t.id === selectedTendy.id ? completedTendy : t
        ));

        // Add to history
        setTendyHistory([...tendyHistory, {
          ...completedTendy,
          templateText: completedTendy.text
        }]);

        // Update points
        const newPoints = tendyPoints + selectedTendy.points;
        setTendyPoints(newPoints);

        // Update streak (check if completed yesterday)
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
        
        if (completedYesterday || tendyStreak === 0) {
          setTendyStreak(tendyStreak + 1);
        }

        // Show celebration
        setJustCompletedPoints(selectedTendy.points);
        setShowCelebration(true);
        setTimeout(() => {
          setShowCelebration(false);
          if (onTendComplete) onTendComplete();
        }, 2500);
      };

      const submitCustomTendy = async () => {
        if (!customTendyText.trim() || !apiKey) return;
        
        setIsSubmittingCustom(true);
        
        try {
          // Call Claude API to review the custom tendy
          const response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "x-api-key": apiKey,
              "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
              model: "claude-sonnet-4-20250514",
              max_tokens: 200,
              messages: [{
                role: "user",
                content: `I'm building an intentional living app where users can create one custom "Tendy" per week - a small action aligned with their values. Please review this custom Tendy and respond with ONLY "APPROVED" or "REJECTED" followed by a brief reason.

Approve if it's:
- A specific, actionable task
- Reasonable to complete in a day
- Values-aligned and intentional
- Not harmful or inappropriate

Reject if it's:
- Too vague or unmeasurable
- Impossible to complete
- Inappropriate or harmful
- Just a to-do item with no values connection

Custom Tendy: "${customTendyText}"

Response format: "APPROVED: [reason]" or "REJECTED: [reason]"`
              }]
            })
          });

          if (!response.ok) {
            throw new Error('API request failed');
          }

          const data = await response.json();
          const aiResponse = data.content[0].text;
          
          const isApproved = aiResponse.toUpperCase().startsWith('APPROVED');
          
          setWeeklyCustomTendy({
            text: customTendyText,
            status: isApproved ? 'approved' : 'rejected',
            weekOf: currentWeek,
            submittedAt: new Date().toISOString(),
            aiResponse: aiResponse
          });

          setCustomTendyText('');
          setShowCustomTendyForm(false);
          
        } catch (error) {
          console.error('Error submitting custom tendy:', error);
          alert('Error submitting custom tendy. Please check your API key in settings.');
        } finally {
          setIsSubmittingCustom(false);
        }
      };

      // Check if it's a weekend (Sat=6, Sun=0)
      const isWeekendDay = () => {
        const day = new Date().getDay();
        return day === 0 || day === 6;
      };
      
      const getDifficultyLabel = (difficulty) => {
        const isWeekend = isWeekendDay();
        if (isWeekend) {
          // Weekend: 15 min or 30 min
          switch(difficulty) {
            case 1: return { text: '15 min', color: '#8FD4A0', minutes: 15 };
            case 3: return { text: '30 min', color: '#E8A090', minutes: 30 };
            default: return { text: '15 min', color: '#8FD4A0', minutes: 15 };
          }
        } else {
          // Weekday: 5 min or 15 min
          switch(difficulty) {
            case 1: return { text: '5 min', color: '#8FD4A0', minutes: 5 };
            case 3: return { text: '15 min', color: '#E8A090', minutes: 15 };
            default: return { text: '5 min', color: '#8FD4A0', minutes: 5 };
          }
        }
      };

      const tendyStyles = {
        container: {
          minHeight: '100vh',
          backgroundColor: 'var(--bg-main)',
          padding: '1.5rem',
          fontFamily: "'DM Sans', sans-serif",
        },
        header: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '2rem',
          maxWidth: '500px',
          margin: '0 auto 2rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          color: 'var(--text-muted)',
          fontSize: '0.9rem',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '0.25rem',
        },
        stats: {
          display: 'flex',
          gap: '1rem',
          alignItems: 'center',
        },
        stat: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
          fontSize: '0.85rem',
          color: 'var(--text-light)',
          backgroundColor: 'var(--bg-card)',
          padding: '0.5rem 0.75rem',
          borderRadius: '20px',
          border: '1px solid var(--border)',
        },
        content: {
          maxWidth: '500px',
          margin: '0 auto',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.75rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
          textAlign: 'center',
        },
        subtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.9rem',
          textAlign: 'center',
          marginBottom: '2rem',
          lineHeight: 1.5,
        },
        tendyCard: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          padding: '1.25rem',
          marginBottom: '1rem',
          border: '2px solid var(--border)',
          cursor: 'pointer',
          transition: 'all 0.2s',
        },
        tendyCardSelected: {
          borderColor: 'var(--accent)',
          backgroundColor: 'var(--accent-light)',
        },
        tendyHeader: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'flex-start',
          marginBottom: '0.75rem',
        },
        tendyDomain: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
        },
        difficultyBadge: {
          fontSize: '0.7rem',
          padding: '0.25rem 0.625rem',
          borderRadius: '12px',
          fontWeight: 500,
        },
        tendyText: {
          fontSize: '1rem',
          color: 'var(--text)',
          lineHeight: 1.5,
          marginBottom: '0.75rem',
        },
        tendyFooter: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          fontSize: '0.8rem',
          color: 'var(--text-muted)',
        },
        gardenReward: {
          display: 'flex',
          alignItems: 'center',
          gap: '0.375rem',
        },
        selectButton: {
          width: '100%',
          padding: '1rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
          marginTop: '1rem',
        },
        selectButtonDisabled: {
          backgroundColor: 'var(--border-dark)',
          cursor: 'not-allowed',
        },
        completeSection: {
          textAlign: 'center',
          padding: '2rem',
        },
        selectedCard: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '20px',
          padding: '2rem',
          marginBottom: '1.5rem',
          border: '1px solid var(--border)',
          textAlign: 'left',
        },
        completeButton: {
          padding: '1rem 2rem',
          backgroundColor: 'var(--accent)',
          border: 'none',
          borderRadius: '12px',
          color: 'white',
          fontSize: '1rem',
          fontWeight: 500,
          cursor: 'pointer',
        },
        celebrationOverlay: {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(125, 155, 118, 0.95)',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          zIndex: 1000,
          animation: 'fadeIn 0.3s ease-out',
        },
        celebrationIcon: {
          fontSize: '4rem',
          marginBottom: '1rem',
        },
        celebrationText: {
          color: 'white',
          fontSize: '1.5rem',
          fontFamily: "'Fraunces', serif",
          marginBottom: '0.5rem',
        },
        celebrationPoints: {
          color: 'rgba(255,255,255,0.9)',
          fontSize: '1.1rem',
        },
        completedState: {
          textAlign: 'center',
          padding: '3rem 2rem',
        },
        completedIcon: {
          fontSize: '3rem',
          marginBottom: '1rem',
        },
        completedTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)',
          marginBottom: '0.5rem',
        },
        completedSubtitle: {
          color: 'var(--text-muted)',
          fontSize: '0.95rem',
          marginBottom: '2rem',
        },
        gardenPreview: {
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '0.5rem',
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
          marginBottom: '1rem',
        },
      };

      // Check completion states
      const completedDaily = todaysTendies.find(t => !t.isWeekendTend && t.completed);
      const completedWeekend = todaysTendies.find(t => t.isWeekendTend && t.completed);
      const pendingDaily = todaysTendies.find(t => !t.isWeekendTend && !t.completed);
      const pendingWeekend = todaysTendies.find(t => t.isWeekendTend && !t.completed);
      const isWeekendNow = isWeekendDay(); // Use the existing function

      // Already completed - show completed state
      // On weekdays: show complete if daily is done
      // On weekends: show complete if both are done OR if any is done (show partial state)
      if (completedToday) {
        const allDone = isWeekendNow ? (completedDaily && completedWeekend) : completedDaily;
        const somePending = isWeekendNow && (completedDaily ? pendingWeekend : pendingDaily);
        
        return (
          <div style={tendyStyles.container}>
            <div style={tendyStyles.header}>
              <button style={tendyStyles.backButton} onClick={onBack}>
                ‚Üê Back
              </button>
              <div style={tendyStyles.stats}>
                <div style={tendyStyles.stat}>
                  <span>üå±</span> {tendyPoints} pts
                </div>
              </div>
            </div>
            <div style={tendyStyles.content}>
              <div style={tendyStyles.completedState}>
                <div style={tendyStyles.completedIcon}>‚ú®</div>
                <h2 style={tendyStyles.completedTitle}>
                  {completedToday.isWeekendTend ? 'Weekend Challenge' : 'Daily Tend'} Complete!
                </h2>
                <p style={tendyStyles.completedSubtitle}>
                  You earned {completedToday.points} point{completedToday.points !== 1 ? 's' : ''} for your garden
                </p>
                <div style={tendyStyles.gardenPreview}>
                  <span style={{fontSize: '1.5rem'}}>{completedToday.gardenElement?.icon}</span>
                  <span style={{color: 'var(--text-light)'}}>
                    +1 {completedToday.gardenElement?.element} growing in your garden
                  </span>
                </div>
                
                {/* Show pending tend if on weekend and one is still available */}
                {somePending && (
                  <div style={{
                    marginTop: '1.5rem',
                    padding: '1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '12px',
                    border: '1px solid var(--border)',
                  }}>
                    <p style={{fontSize: '0.9rem', fontWeight: 500, color: 'var(--text)', marginBottom: '0.5rem'}}>
                      {somePending.isWeekendTend ? 'üåü Weekend Challenge Available' : '‚úÖ Daily Tend Available'}
                    </p>
                    <p style={{fontSize: '0.85rem', color: 'var(--text-muted)', marginBottom: '0.75rem'}}>
                      {somePending.text}
                    </p>
                    <button
                      onClick={() => selectTendy(somePending.id)}
                      style={{
                        padding: '0.5rem 1rem',
                        backgroundColor: 'var(--accent)',
                        border: 'none',
                        borderRadius: '8px',
                        color: 'white',
                        fontSize: '0.85rem',
                        cursor: 'pointer',
                      }}
                    >
                      Start This Tend ‚Üí
                    </button>
                  </div>
                )}
                
                {!somePending && (
                  <div style={{marginTop: '1.5rem', display: 'flex', flexDirection: 'column', gap: '0.75rem', alignItems: 'center'}}>
                    <button
                      onClick={() => {
                        onBack();
                        // Navigate to journal - we'll need to communicate this up
                      }}
                      style={{
                        padding: '0.75rem 1.5rem',
                        backgroundColor: 'var(--accent)',
                        border: 'none',
                        borderRadius: '12px',
                        color: 'white',
                        fontSize: '0.95rem',
                        fontWeight: 500,
                        cursor: 'pointer',
                        width: '100%',
                        maxWidth: '280px',
                      }}
                    >
                      üìù Take Me to Journal
                    </button>
                    {isWeekendNow && pendingWeekend && (
                      <button
                        onClick={() => selectTendy(pendingWeekend.id)}
                        style={{
                          padding: '0.75rem 1.5rem',
                          backgroundColor: 'var(--bg-elevated)',
                          border: '2px solid var(--accent)',
                          borderRadius: '12px',
                          color: 'var(--accent)',
                          fontSize: '0.95rem',
                          fontWeight: 500,
                          cursor: 'pointer',
                          width: '100%',
                          maxWidth: '280px',
                        }}
                      >
                        üåü Take On Weekend Challenge
                      </button>
                    )}
                    <p style={{color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic', marginTop: '0.5rem'}}>
                      {isWeekendNow && !pendingWeekend
                        ? 'Great weekend work! See you Monday for your next tend'
                        : !isWeekendNow ? 'Come back tomorrow for your next Daily Tend' : ''
                      }
                    </p>
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      }

      // Already selected - show completion view
      if (selectedTendy || weeklyCustomTendy?.selected) {
        const hasBothSelected = selectedTendy && weeklyCustomTendy?.selected;
        
        return (
          <div style={tendyStyles.container}>
            {showCelebration && (
              <div style={tendyStyles.celebrationOverlay}>
                <div style={tendyStyles.celebrationIcon}>‚ú®</div>
                <div style={tendyStyles.celebrationText}>{selectedTendy?.isWeekendTend ? 'Weekend Challenge' : 'Daily Tend'} Complete!</div>
                <div style={tendyStyles.celebrationPoints}>+{justCompletedPoints} point{justCompletedPoints !== 1 ? 's' : ''}</div>
              </div>
            )}
            
            {/* Tend Chat Modal */}
            {showTendChat && (
              <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                backgroundColor: 'rgba(0,0,0,0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000,
                padding: '1rem',
              }}>
                <div style={{
                  backgroundColor: 'var(--bg-card)',
                  borderRadius: '16px',
                  width: '100%',
                  maxWidth: '500px',
                  maxHeight: '80vh',
                  display: 'flex',
                  flexDirection: 'column',
                  overflow: 'hidden',
                }}>
                  {/* Chat Header */}
                  <div style={{
                    padding: '1rem',
                    borderBottom: '1px solid var(--border)',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center',
                  }}>
                    <div>
                      <div style={{ fontWeight: 600, color: 'var(--text)' }}>Chat about this tend</div>
                      <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>{selectedTendy?.domainName}</div>
                    </div>
                    <button 
                      onClick={() => setShowTendChat(false)}
                      style={{
                        background: 'none',
                        border: 'none',
                        fontSize: '1.5rem',
                        cursor: 'pointer',
                        color: 'var(--text-muted)',
                      }}
                    >√ó</button>
                  </div>
                  
                  {/* Chat Messages */}
                  <div 
                    ref={tendChatRef}
                    style={{
                      flex: 1,
                      overflowY: 'auto',
                      padding: '1rem',
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '0.75rem',
                    }}
                  >
                    {tendChatMessages.map((msg, i) => (
                      <div 
                        key={i}
                        style={{
                          alignSelf: msg.role === 'user' ? 'flex-end' : 'flex-start',
                          backgroundColor: msg.role === 'user' ? 'var(--accent)' : 'var(--bg-elevated)',
                          color: msg.role === 'user' ? 'white' : 'var(--text)',
                          padding: '0.75rem 1rem',
                          borderRadius: '12px',
                          maxWidth: '85%',
                          fontSize: '0.9rem',
                          whiteSpace: 'pre-wrap',
                        }}
                      >
                        {msg.content}
                      </div>
                    ))}
                    {isTendChatTyping && (
                      <div style={{
                        alignSelf: 'flex-start',
                        backgroundColor: 'var(--bg-elevated)',
                        padding: '0.75rem 1rem',
                        borderRadius: '12px',
                        color: 'var(--text-muted)',
                        fontSize: '0.9rem',
                      }}>
                        Thinking...
                      </div>
                    )}
                  </div>
                  
                  {/* Chat Input */}
                  <div style={{
                    padding: '1rem',
                    borderTop: '1px solid var(--border)',
                    display: 'flex',
                    gap: '0.5rem',
                  }}>
                    <input
                      type="text"
                      value={tendChatInput}
                      onChange={(e) => setTendChatInput(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && sendTendChatMessage()}
                      placeholder="Ask about this tend..."
                      style={{
                        flex: 1,
                        padding: '0.75rem',
                        borderRadius: '10px',
                        border: '1px solid var(--border)',
                        backgroundColor: 'var(--bg-main)',
                        color: 'var(--text)',
                        fontSize: '0.9rem',
                      }}
                    />
                    <button
                      onClick={sendTendChatMessage}
                      disabled={!tendChatInput.trim() || isTendChatTyping}
                      style={{
                        padding: '0.75rem 1rem',
                        borderRadius: '10px',
                        border: 'none',
                        backgroundColor: 'var(--accent)',
                        color: 'white',
                        cursor: tendChatInput.trim() && !isTendChatTyping ? 'pointer' : 'not-allowed',
                        opacity: tendChatInput.trim() && !isTendChatTyping ? 1 : 0.5,
                      }}
                    >
                      Send
                    </button>
                  </div>
                </div>
              </div>
            )}
            
            <div style={tendyStyles.header}>
              <button style={tendyStyles.backButton} onClick={onBack}>
                ‚Üê Back
              </button>
              <div style={tendyStyles.stats}>
                <div style={tendyStyles.stat}>
                  <span>ü™¥</span> {flexPoints} flex
                </div>
                <div style={tendyStyles.stat}>
                  <span>üå±</span> {tendyPoints} pts
                </div>
              </div>
            </div>
            <div style={tendyStyles.content}>
              <h1 style={tendyStyles.title}>{hasBothSelected ? 'Today\'s Tendies' : 'Today\'s Tendy'}</h1>
              <p style={tendyStyles.subtitle}>
                {hasBothSelected 
                  ? 'Complete these actions to tend to your values'
                  : 'Complete this small action to tend to your values'
                }
              </p>
              
              {/* Show regular tendy if selected */}
              {selectedTendy && (
                <div style={{marginBottom: hasBothSelected ? '1.5rem' : '0'}}>
                  <div style={tendyStyles.selectedCard}>
                    <div style={tendyStyles.tendyHeader}>
                      <div style={tendyStyles.tendyDomain}>
                        <span>{selectedTendy.domainIcon}</span>
                        <span>{selectedTendy.domainName}</span>
                      </div>
                      <span style={{
                        ...tendyStyles.difficultyBadge,
                        backgroundColor: getDifficultyLabel(selectedTendy.difficulty).color + '20',
                        color: getDifficultyLabel(selectedTendy.difficulty).color,
                      }}>
                        {getDifficultyLabel(selectedTendy.difficulty).text}
                      </span>
                    </div>
                    <p style={{...tendyStyles.tendyText, fontSize: '1.1rem'}}>
                      {selectedTendy.text}
                    </p>
                    <div style={tendyStyles.tendyFooter}>
                      <div style={tendyStyles.gardenReward}>
                        <span>{selectedTendy.gardenElement?.icon}</span>
                        <span>+{selectedTendy.points} pt{selectedTendy.points !== 1 ? 's' : ''}</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Reroll button - costs 1 flex point */}
                  {flexPoints >= 1 && !selectedTendy.completed && (
                    <button 
                      onClick={rerollTendy}
                      style={{
                        width: '100%',
                        padding: '0.75rem',
                        backgroundColor: 'transparent',
                        border: '1px solid var(--border-dark)',
                        borderRadius: '10px',
                        color: 'var(--text-muted)',
                        fontSize: '0.85rem',
                        cursor: 'pointer',
                        marginBottom: '0.75rem',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '0.5rem',
                      }}
                    >
                      <span>ü™¥</span>
                      <span>Spend 1 flex point to pick a different difficulty</span>
                    </button>
                  )}
                  
                  {/* Chat about this tend button */}
                  <button 
                    onClick={() => {
                      setShowTendChat(true);
                      setTendChatMessages([{
                        role: 'assistant',
                        content: `This tend is: "${selectedTendy.text}"\n\nHow can I help? You can ask me to clarify, adapt it to your situation, or share what works/doesn't work for you.`
                      }]);
                    }}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      backgroundColor: 'transparent',
                      border: '1px solid var(--border)',
                      borderRadius: '10px',
                      color: 'var(--text-muted)',
                      fontSize: '0.85rem',
                      cursor: 'pointer',
                      marginBottom: '0.75rem',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      gap: '0.5rem',
                    }}
                  >
                    <span>üí¨</span>
                    <span>Chat about this tend</span>
                  </button>
                  
                  {/* Reflection input for reflective tends */}
                  {selectedTendy.type === 'reflective' && (
                    <div style={{ marginBottom: '1rem' }}>
                      <label style={{
                        display: 'block',
                        fontSize: '0.85rem',
                        color: 'var(--text-muted)',
                        marginBottom: '0.5rem',
                        fontWeight: 500,
                      }}>
                        ‚úçÔ∏è Your reflection (optional)
                      </label>
                      <textarea
                        value={reflectionInput}
                        onChange={(e) => setReflectionInput(e.target.value)}
                        placeholder="Write your thoughts here..."
                        style={{
                          width: '100%',
                          minHeight: '100px',
                          padding: '0.75rem',
                          borderRadius: '10px',
                          border: '1px solid var(--border)',
                          backgroundColor: 'var(--bg-card)',
                          color: 'var(--text)',
                          fontSize: '0.95rem',
                          fontFamily: 'inherit',
                          resize: 'vertical',
                          boxSizing: 'border-box',
                        }}
                      />
                    </div>
                  )}
                  
                  <button style={tendyStyles.completeButton} onClick={() => {
                    // Complete regular tendy
                    const completedTendy = {
                      ...selectedTendy,
                      completed: true,
                      completedAt: new Date().toISOString(),
                      reflection: selectedTendy.type === 'reflective' ? reflectionInput : undefined
                    };
                    setTodaysTendies(todaysTendies.map(t => 
                      t.id === selectedTendy.id ? completedTendy : t
                    ));
                    setTendyHistory([...tendyHistory, {
                      ...completedTendy,
                      templateText: completedTendy.text
                    }]);
                    setTendyPoints(tendyPoints + selectedTendy.points);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
                    if (completedYesterday || tendyStreak === 0) {
                      setTendyStreak(tendyStreak + 1);
                    }
                    setJustCompletedPoints(selectedTendy.points);
                    setReflectionInput(''); // Clear reflection input
                    setShowCelebration(true);
                    setTimeout(() => {
                      setShowCelebration(false);
                      if (onTendComplete) onTendComplete();
                    }, 2500);
                  }}>
                    ‚úì Mark Complete
                  </button>
                </div>
              )}

              {/* Show custom tendy if selected */}
              {weeklyCustomTendy?.selected && (
                <div>
                  <div style={tendyStyles.selectedCard}>
                    <div style={tendyStyles.tendyHeader}>
                      <div style={tendyStyles.tendyDomain}>
                        <span>‚ú®</span>
                        <span>Your Custom Tend</span>
                      </div>
                      <span style={{
                        ...tendyStyles.difficultyBadge,
                        backgroundColor: '#B8A9C920',
                        color: '#B8A9C9',
                      }}>
                        Personal
                      </span>
                    </div>
                    <p style={{...tendyStyles.tendyText, fontSize: '1.1rem'}}>
                      {weeklyCustomTendy.text}
                    </p>
                    <div style={tendyStyles.tendyFooter}>
                      <span>‚è± Self-paced</span>
                      <div style={tendyStyles.gardenReward}>
                        <span>üåü</span>
                        <span>+1 pt ‚Ä¢ {customCompletionsRemaining}/2 left</span>
                      </div>
                    </div>
                  </div>
                  <button style={tendyStyles.completeButton} onClick={() => {
                    // Complete custom tendy
                    const completionTimestamp = new Date().toISOString();
                    const completedCustom = {
                      id: `custom-${currentWeek}-${completionsThisWeek.length + 1}`,
                      date: today,
                      text: weeklyCustomTendy.text,
                      points: 1,
                      difficulty: 'custom',
                      domainName: 'Custom',
                      domainIcon: '‚ú®',
                      completed: true,
                      completedAt: completionTimestamp,
                      gardenElement: { icon: 'üåü', element: 'Star', description: 'Personal intention' }
                    };
                    setTendyHistory([...tendyHistory, completedCustom]);
                    setTendyPoints(tendyPoints + 1);
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    const completedYesterday = tendyHistory.some(t => t.date === yesterdayStr && t.completed);
                    if (completedYesterday || tendyStreak === 0) {
                      setTendyStreak(tendyStreak + 1);
                    }
                    const existingCompletions = weeklyCustomTendy.completions || [];
                    setWeeklyCustomTendy({
                      ...weeklyCustomTendy, 
                      completions: [...existingCompletions, completionTimestamp],
                      selected: false
                    });
                    setJustCompletedPoints(1);
                    setShowCelebration(true);
                    setTimeout(() => {
                      setShowCelebration(false);
                      if (onTendComplete) onTendComplete();
                    }, 2500);
                  }}>
                    ‚úì Mark Complete
                  </button>
                </div>
              )}
            </div>
          </div>
        );
      }

      // Selection view - show daily tend directly + weekend tend if applicable
      const dayOfWeek = new Date().getDay();
      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
      const isSunday = dayOfWeek === 0;
      
      return (
        <div style={tendyStyles.container}>
          <div style={tendyStyles.header}>
            {isOnboarding ? (
              <div style={{color: 'var(--accent)', fontSize: '0.85rem', fontWeight: 500}}>
                üå± Your First Tend
              </div>
            ) : (
              <button style={tendyStyles.backButton} onClick={onBack}>
                ‚Üê Back
              </button>
            )}
            <div style={tendyStyles.stats}>
              <div style={tendyStyles.stat}>
                <span>üå±</span> {tendyPoints} pts
              </div>
            </div>
          </div>
          
          {/* Onboarding welcome message */}
          {isOnboarding && (
            <div style={{
              backgroundColor: 'var(--accent-light)',
              border: '1px solid var(--accent)',
              borderRadius: '12px',
              padding: '1rem',
              marginBottom: '1.5rem',
              textAlign: 'center',
            }}>
              <p style={{color: 'var(--text)', fontSize: '0.9rem', marginBottom: '0.5rem'}}>
                üéâ <strong>You're almost done with setup!</strong>
              </p>
              <p style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>
                Here's your first daily tend. Try it out, or you can skip and explore the app!
              </p>
            </div>
          )}
          
          <div style={tendyStyles.content}>
            <h1 style={tendyStyles.title}>Today's Tends</h1>
            <p style={tendyStyles.subtitle}>
              {isWeekend 
                ? 'Your quick daily tend + an optional weekend challenge!'
                : 'A small action to tend to your values today.'
              }
            </p>

            {/* Daily Tend Section */}
            {dailyTend && (
              <div style={{ marginBottom: isWeekend ? '2rem' : '1rem' }}>
                <div style={{
                  fontSize: '0.8rem',
                  fontWeight: 600,
                  color: 'var(--text-muted)',
                  marginBottom: '0.75rem',
                  textTransform: 'uppercase',
                  letterSpacing: '0.05em',
                }}>
                  Daily Tend ‚Ä¢ 5 min
                </div>
                <div
                  style={{
                    ...tendyStyles.tendyCard,
                    borderColor: dailyTend.selected ? 'var(--accent)' : 'var(--border)',
                    backgroundColor: dailyTend.selected ? 'var(--accent-light)' : 'var(--bg-card)',
                    cursor: 'pointer',
                  }}
                  onClick={() => selectTendy(dailyTend.id)}
                >
                  {dailyTend.selected ? (
                    <>
                      <div style={tendyStyles.tendyHeader}>
                        <div style={tendyStyles.tendyDomain}>
                          <span>{dailyTend.domainIcon}</span>
                          <span>{dailyTend.domainName}</span>
                        </div>
                        <span style={{
                          ...tendyStyles.difficultyBadge,
                          backgroundColor: '#8FD4A020',
                          color: '#8FD4A0',
                        }}>
                          5 min
                        </span>
                      </div>
                      <p style={tendyStyles.tendyText}>{dailyTend.text}</p>
                      <div style={tendyStyles.tendyFooter}>
                        <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>
                          {dailyTend.type === 'reflective' ? '‚úçÔ∏è Reflective' : '‚ö° Action'}
                        </span>
                        <div style={tendyStyles.gardenReward}>
                          <span>{dailyTend.gardenElement?.icon}</span>
                          <span>+{dailyTend.points} pt{dailyTend.points !== 1 ? 's' : ''}</span>
                        </div>
                      </div>
                    </>
                  ) : (
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      padding: '1.5rem',
                      gap: '0.75rem',
                    }}>
                      <span style={{fontSize: '2rem'}}>üå±</span>
                      <div style={{textAlign: 'left'}}>
                        <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>
                          Click to reveal your daily tend
                        </div>
                        <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>
                          A quick 5-minute activity for your {dailyTend.domainName.toLowerCase()} values
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Weekend Tend Section - Only on weekends */}
            {isWeekend && weekendTend && (
              <div style={{ marginBottom: '1rem' }}>
                <div style={{
                  fontSize: '0.8rem',
                  fontWeight: 600,
                  color: 'var(--text-muted)',
                  marginBottom: '0.75rem',
                  textTransform: 'uppercase',
                  letterSpacing: '0.05em',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem',
                }}>
                  <span>üåü</span> Weekend Challenge ‚Ä¢ 15 min
                  {isSunday && (
                    <span style={{
                      fontSize: '0.7rem',
                      backgroundColor: '#FFF3CD',
                      color: '#856404',
                      padding: '0.2rem 0.5rem',
                      borderRadius: '4px',
                      fontWeight: 500,
                    }}>
                      Expires tonight!
                    </span>
                  )}
                </div>
                <div
                  style={{
                    ...tendyStyles.tendyCard,
                    borderColor: weekendTend.selected ? 'var(--accent)' : 'var(--border)',
                    backgroundColor: weekendTend.selected ? 'var(--accent-light)' : 'var(--bg-card)',
                    cursor: 'pointer',
                  }}
                  onClick={() => selectTendy(weekendTend.id)}
                >
                  {weekendTend.selected ? (
                    <>
                      <div style={tendyStyles.tendyHeader}>
                        <div style={tendyStyles.tendyDomain}>
                          <span>{weekendTend.domainIcon}</span>
                          <span>{weekendTend.domainName}</span>
                        </div>
                        <span style={{
                          ...tendyStyles.difficultyBadge,
                          backgroundColor: '#E8A09020',
                          color: '#E8A090',
                        }}>
                          15 min
                        </span>
                      </div>
                      <p style={tendyStyles.tendyText}>{weekendTend.text}</p>
                      <div style={tendyStyles.tendyFooter}>
                        <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>
                          {weekendTend.type === 'reflective' ? '‚úçÔ∏è Reflective' : '‚ö° Action'}
                        </span>
                        <div style={tendyStyles.gardenReward}>
                          <span>{weekendTend.gardenElement?.icon}</span>
                          <span>+{weekendTend.points} pt{weekendTend.points !== 1 ? 's' : ''}</span>
                        </div>
                      </div>
                    </>
                  ) : (
                    <div style={{
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      padding: '1.5rem',
                      gap: '0.75rem',
                    }}>
                      <span style={{fontSize: '2rem'}}>üåü</span>
                      <div style={{textAlign: 'left'}}>
                        <div style={{fontWeight: 500, color: 'var(--text)', marginBottom: '0.25rem'}}>
                          Click to reveal your weekend challenge
                        </div>
                        <div style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>
                          A 15-minute activity for your {weekendTend.domainName.toLowerCase()} values
                        </div>
                      </div>
                    </div>
                  )}
                </div>
                <p style={{
                  fontSize: '0.75rem',
                  color: 'var(--text-muted)',
                  textAlign: 'center',
                  marginTop: '0.5rem',
                  fontStyle: 'italic',
                }}>
                  Optional: Take on this deeper activity anytime this weekend
                </p>
              </div>
            )}

            {/* Custom Tendy - if approved this week */}
            {hasApprovedCustom && (
              <div
                style={{
                  ...tendyStyles.tendyCard,
                  borderColor: weeklyCustomTendy.selected ? 'var(--accent)' : 'var(--border)',
                  backgroundColor: weeklyCustomTendy.selected ? 'var(--accent-light)' : 'var(--bg-card)',
                }}
                onClick={() => {
                  setWeeklyCustomTendy({...weeklyCustomTendy, selected: !weeklyCustomTendy.selected});
                }}
              >
                <div style={tendyStyles.tendyHeader}>
                  <div style={tendyStyles.tendyDomain}>
                    <span>‚ú®</span>
                    <span>Your Custom Tend</span>
                  </div>
                  <span style={{
                    ...tendyStyles.difficultyBadge,
                    backgroundColor: '#B8A9C920',
                    color: '#B8A9C9',
                  }}>
                    Personal
                  </span>
                </div>
                <p style={tendyStyles.tendyText}>{weeklyCustomTendy.text}</p>
                <div style={tendyStyles.tendyFooter}>
                  <span>‚è± Self-paced</span>
                  <div style={tendyStyles.gardenReward}>
                    <span>üåü</span>
                    <span>+1 pt ‚Ä¢ {customCompletionsRemaining}/2 left</span>
                  </div>
                </div>
              </div>
            )}

            {/* Create Custom Tendy Form */}
            {canCreateCustomThisWeek && !showCustomTendyForm && (
              <button
                style={{
                  ...tendyStyles.tendyCard,
                  cursor: 'pointer',
                  borderStyle: 'dashed',
                  borderColor: 'var(--border-dark)',
                  textAlign: 'center',
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  justifyContent: 'center',
                  minHeight: '80px',
                  color: 'var(--text-muted)',
                  marginTop: '1rem',
                }}
                onClick={() => setShowCustomTendyForm(true)}
              >
                <div style={{fontSize: '1.25rem', marginBottom: '0.25rem'}}>+</div>
                <div style={{fontWeight: 500, fontSize: '0.9rem'}}>Create Your Own Custom Tend</div>
              </button>
            )}

            {/* Custom Tendy Creation Form */}
            {showCustomTendyForm && (
              <div style={{
                ...tendyStyles.tendyCard,
                borderColor: 'var(--accent)',
                marginTop: '1rem',
              }}>
                <div style={{marginBottom: '0.75rem', fontWeight: 500, color: 'var(--text)'}}>
                  Create Your Custom Tend
                </div>
                <textarea
                  value={customTendyText}
                  onChange={(e) => setCustomTendyText(e.target.value)}
                  placeholder="Describe a specific action aligned with your values..."
                  style={{
                    width: '100%',
                    minHeight: '80px',
                    padding: '0.75rem',
                    backgroundColor: 'var(--bg-elevated)',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    fontSize: '0.9rem',
                    fontFamily: "'DM Sans', sans-serif",
                    color: 'var(--text)',
                    marginBottom: '0.75rem',
                    resize: 'vertical',
                  }}
                />
                <div style={{display: 'flex', gap: '0.5rem'}}>
                  <button
                    onClick={submitCustomTendy}
                    disabled={!customTendyText.trim() || isSubmittingCustom || !apiKey}
                    style={{
                      flex: 1,
                      padding: '0.625rem',
                      backgroundColor: isSubmittingCustom || !apiKey ? 'var(--border-dark)' : 'var(--accent)',
                      border: 'none',
                      borderRadius: '8px',
                      color: 'white',
                      fontSize: '0.85rem',
                      fontWeight: 500,
                      cursor: isSubmittingCustom || !apiKey ? 'not-allowed' : 'pointer',
                    }}
                  >
                    {isSubmittingCustom ? 'Submitting...' : 'Submit for Approval'}
                  </button>
                  <button
                    onClick={() => {
                      setShowCustomTendyForm(false);
                      setCustomTendyText('');
                    }}
                    style={{
                      padding: '0.625rem 1rem',
                      backgroundColor: 'transparent',
                      border: '1px solid var(--border)',
                      borderRadius: '8px',
                      color: 'var(--text-muted)',
                      fontSize: '0.85rem',
                      cursor: 'pointer',
                    }}
                  >
                    Cancel
                  </button>
                </div>
                {!apiKey && (
                  <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem', fontStyle: 'italic'}}>
                    Set your API key in settings to enable custom tends
                  </div>
                )}
              </div>
            )}

            {/* Rejected Custom Tendy Message */}
            {weeklyCustomTendy?.status === 'rejected' && weeklyCustomTendy.weekOf === currentWeek && (
              <div style={{
                padding: '1rem',
                backgroundColor: '#FFF5F5',
                border: '1px solid #FED7D7',
                borderRadius: '12px',
                fontSize: '0.85rem',
                color: '#C53030',
                marginTop: '1rem',
              }}>
                <div style={{fontWeight: 500, marginBottom: '0.25rem'}}>Custom Tend Not Approved</div>
                <div style={{color: '#744210'}}>{weeklyCustomTendy.aiResponse}</div>
                <div style={{marginTop: '0.5rem', fontSize: '0.75rem', color: '#744210'}}>
                  You can try again with a different tend this week.
                </div>
              </div>
            )}

            {/* Confirm button - only show if a tend is selected */}
            {(todaysTendies.some(t => t.selected) || weeklyCustomTendy?.selected) && (
              <button
                style={{
                  ...tendyStyles.selectButton,
                  marginTop: '1.5rem',
                }}
                onClick={() => {
                  // Selection already tracked, button confirms intent
                }}
              >
                Start This Tend ‚Üí
              </button>
            )}
            
            {/* Finish Onboarding button - only during onboarding */}
            {isOnboarding && (
              <div style={{
                marginTop: '2rem',
                paddingTop: '1.5rem',
                borderTop: '1px solid var(--border)',
                textAlign: 'center',
              }}>
                <p style={{
                  color: 'var(--text-muted)',
                  fontSize: '0.85rem',
                  marginBottom: '1rem',
                }}>
                  Ready to explore Tend on your own?
                </p>
                <button
                  onClick={onFinishOnboarding}
                  style={{
                    width: '100%',
                    padding: '1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    border: '2px solid var(--accent)',
                    borderRadius: '12px',
                    color: 'var(--accent)',
                    fontSize: '1rem',
                    fontWeight: 500,
                    cursor: 'pointer',
                  }}
                >
                  Finish Setup & Go Home ‚Üí
                </button>
                <p style={{
                  color: 'var(--text-muted)',
                  fontSize: '0.75rem',
                  marginTop: '0.75rem',
                  fontStyle: 'italic',
                }}>
                  You can always come back to your Daily Tend anytime!
                </p>
              </div>
            )}
          </div>
        </div>
      );
    }

    // ============ WEEKLY VIEW ============
    function WeeklyView({ weeklyHabits, setWeeklyHabits, revealed, focusAreas = [] }) {
      const [newHabit, setNewHabit] = useState('');
      const [newFrequency, setNewFrequency] = useState(3);
      const [newLifeArea, setNewLifeArea] = useState('');

      const addHabit = () => {
        if (!newHabit.trim()) return;
        setWeeklyHabits([...weeklyHabits, {
          id: generateId(),
          text: newHabit,
          frequency: newFrequency,
          lifeArea: newLifeArea,
          color: newLifeArea ? VLQ_DOMAINS[newLifeArea]?.color : ['#7EB3E0', '#8FD4A0', '#F9D07A', '#E8A090', '#B8A9C9'][weeklyHabits.length % 5]
        }]);
        setNewHabit('');
        setNewFrequency(3);
        setNewLifeArea('');
      };

      return (
        <div style={styles.weeklyContainer}>
          <div style={styles.weeklyHeader}>
            <h2 style={styles.weeklyTitle}>Weekly Rhythms</h2>
            <p style={styles.weeklySubtitle}>What do you want to do each week?</p>
            {focusAreas.length > 0 && (
              <p style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem'}}>
                Cover your focus areas: {focusAreas.map(a => VLQ_DOMAINS[a]?.name.split(' ')[0]).join(', ')}
              </p>
            )}
          </div>

          {weeklyHabits.length > 0 ? (
            <div style={styles.weeklyHabitsList}>
              {weeklyHabits.map(habit => (
                <div key={habit.id} style={{
                  ...styles.weeklyHabitRow,
                  padding: '1rem 1.25rem',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between'
                }}>
                  <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                    <span style={{...styles.weeklyHabitDot, backgroundColor: habit.color}}></span>
                    <div>
                      <span style={styles.weeklyHabitText}>{habit.text}</span>
                      {habit.lifeArea && (
                        <span style={{fontSize: '0.7rem', color: 'var(--text-muted)', marginLeft: '0.5rem'}}>
                          {VLQ_DOMAINS[habit.lifeArea]?.icon} {VLQ_DOMAINS[habit.lifeArea]?.name.split(' ')[0]}
                        </span>
                      )}
                    </div>
                  </div>
                  <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem'}}>
                    <span style={{
                      fontSize: '0.8rem',
                      color: 'var(--text-muted)',
                      backgroundColor: 'var(--bg-elevated)',
                      padding: '0.25rem 0.75rem',
                      borderRadius: '12px'
                    }}>{habit.frequency}x/week</span>
                    <button 
                      style={styles.weeklyHabitDelete}
                      onClick={() => setWeeklyHabits(weeklyHabits.filter(h => h.id !== habit.id))}
                    >√ó</button>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div style={styles.weeklyEmpty}>
              <p style={styles.weeklyEmptyText}>No weekly habits yet.</p>
              <p style={{...styles.weeklyEmptyText, fontStyle: 'normal', color: 'var(--text-light)'}}>What rhythm do you want to create?</p>
            </div>
          )}

          {revealed ? (
            <div style={styles.addHabitSection}>
              <input
                type="text"
                value={newHabit}
                onChange={(e) => setNewHabit(e.target.value)}
                placeholder="Exercise, read, date night..."
                style={styles.addHabitInput}
                onKeyDown={(e) => e.key === 'Enter' && addHabit()}
              />
              <select 
                value={newFrequency} 
                onChange={(e) => setNewFrequency(parseInt(e.target.value))}
                style={styles.addHabitSelect}
              >
                {[1,2,3,4,5,6,7].map(n => (
                  <option key={n} value={n}>{n}x/week</option>
                ))}
              </select>
              <select 
                value={newLifeArea} 
                onChange={(e) => setNewLifeArea(e.target.value)}
                style={{...styles.addHabitSelect, minWidth: '100px'}}
              >
                <option value="">Life Area</option>
                {VLQ_ORDER.map(key => (
                  <option key={key} value={key}>{VLQ_DOMAINS[key].icon} {VLQ_DOMAINS[key].name.split(' ')[0]}</option>
                ))}
              </select>
              <button onClick={addHabit} style={styles.addHabitButton}>+ Add</button>
            </div>
          ) : (
            <p style={styles.lockedText}>Complete the conversation to add weekly habits</p>
          )}
        </div>
      );
    }

    // ============ EVENTS TAB ============
    function EventsTab({ events, setEvents, expandedEvent, setExpandedEvent, onUpdateDetails, onDelete, onAdd, revealed, apiKey }) {
      const [planningEvent, setPlanningEvent] = useState(null);
      const [activeSection, setActiveSection] = useState('overview');
      const [sectionChat, setSectionChat] = useState('');
      const [isAiThinking, setIsAiThinking] = useState(false);
      const [newActivityText, setNewActivityText] = useState('');
      
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>Your events will appear here.</p></div>;
      }
      
      const EVENT_TYPES = {
        trip: { label: 'Trip', icon: '‚úàÔ∏è', color: '#7EB3E0' },
        celebration: { label: 'Celebration', icon: 'üéâ', color: '#F9D07A' },
        project: { label: 'Project', icon: 'üìã', color: '#8FD4A0' },
        personal: { label: 'Personal', icon: '‚≠ê', color: '#E8A090' }
      };
      
      const SECTIONS = {
        overview: { label: 'Overview', icon: 'üìç' },
        logistics: { label: 'Logistics', icon: 'üöÄ' },
        activities: { label: 'Activities', icon: '‚ú®' }
      };
      
      // Default logistics tasks based on event type
      const DEFAULT_LOGISTICS = {
        trip: [
          { id: 'book-flights', text: 'Book flights', completed: false },
          { id: 'book-hotel', text: 'Book hotel/accommodation', completed: false },
          { id: 'book-transport', text: 'Arrange transportation', completed: false },
          { id: 'travel-insurance', text: 'Get travel insurance', completed: false },
          { id: 'pack-bags', text: 'Pack bags', completed: false }
        ],
        celebration: [
          { id: 'book-venue', text: 'Book venue', completed: false },
          { id: 'send-invites', text: 'Send invitations', completed: false },
          { id: 'order-food', text: 'Order food/catering', completed: false },
          { id: 'decorations', text: 'Get decorations', completed: false },
          { id: 'confirm-guests', text: 'Confirm guest list', completed: false }
        ],
        project: [
          { id: 'define-scope', text: 'Define scope', completed: false },
          { id: 'set-timeline', text: 'Set timeline', completed: false },
          { id: 'gather-resources', text: 'Gather resources', completed: false },
          { id: 'assign-tasks', text: 'Assign tasks', completed: false }
        ],
        personal: [
          { id: 'set-date', text: 'Set date/time', completed: false },
          { id: 'make-reservation', text: 'Make reservations', completed: false },
          { id: 'prepare-items', text: 'Prepare needed items', completed: false }
        ]
      };
      
      // Initialize event sections if they don't exist
      const ensureEventSections = (event) => {
        if (!event.sections) {
          const eventType = event.type || 'personal';
          return {
            ...event,
            type: eventType,
            location: event.location || '',
            startDate: event.startDate || '',
            endDate: event.endDate || '',
            sections: {
              logistics: { 
                tasks: DEFAULT_LOGISTICS[eventType].map(t => ({ ...t, id: generateId() })),
                chatHistory: [] 
              },
              activities: { tasks: [], chatHistory: [] }
            }
          };
        }
        return event;
      };
      
      // Calculate progress
      const getProgress = (event) => {
        const e = ensureEventSections(event);
        let total = 0;
        let completed = 0;
        Object.values(e.sections || {}).forEach(section => {
          section.tasks?.forEach(task => {
            total++;
            if (task.completed) completed++;
          });
        });
        return total === 0 ? 0 : Math.round((completed / total) * 100);
      };
      
      // Chat with AI about activities
      const chatWithAI = async (event, message) => {
        if (!apiKey || !message.trim()) return;
        setIsAiThinking(true);
        
        const e = ensureEventSections(event);
        const existingActivities = e.sections?.activities?.tasks?.map(t => t.text).join(', ') || 'none yet';
        
        try {
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
              'anthropic-version': '2023-06-01',
              'anthropic-dangerous-direct-browser-access': 'true'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 600,
              system: `You're helping plan activities for a ${event.type || 'event'} called "${event.title}"${event.location ? ` in/at ${event.location}` : ''}. Current activities planned: ${existingActivities}. Suggest specific, interesting activities. Be concise and helpful. When suggesting activities, list them clearly so the user can add them.`,
              messages: [
                ...(e.sections?.activities?.chatHistory || []).slice(-6),
                { role: 'user', content: message }
              ]
            })
          });
          
          const data = await response.json();
          const aiResponse = data.content[0].text;
          
          // Update chat history
          setEvents(prev => prev.map(ev => {
            if (ev.id !== event.id) return ev;
            const updated = ensureEventSections(ev);
            return {
              ...updated,
              sections: {
                ...updated.sections,
                activities: {
                  ...updated.sections.activities,
                  chatHistory: [
                    ...(updated.sections.activities?.chatHistory || []).slice(-8),
                    { role: 'user', content: message },
                    { role: 'assistant', content: aiResponse }
                  ]
                }
              }
            };
          }));
        } catch (error) {
          console.error('Error chatting with AI:', error);
        }
        setIsAiThinking(false);
        setSectionChat('');
      };
      
      // Toggle task completion
      const toggleTask = (eventId, sectionKey, taskId) => {
        setEvents(prev => prev.map(e => {
          if (e.id !== eventId) return e;
          const updated = ensureEventSections(e);
          return {
            ...updated,
            sections: {
              ...updated.sections,
              [sectionKey]: {
                ...updated.sections[sectionKey],
                tasks: updated.sections[sectionKey].tasks.map(t =>
                  t.id === taskId ? { ...t, completed: !t.completed } : t
                )
              }
            }
          };
        }));
      };
      
      // Delete task
      const deleteTask = (eventId, sectionKey, taskId) => {
        setEvents(prev => prev.map(e => {
          if (e.id !== eventId) return e;
          const updated = ensureEventSections(e);
          return {
            ...updated,
            sections: {
              ...updated.sections,
              [sectionKey]: {
                ...updated.sections[sectionKey],
                tasks: updated.sections[sectionKey].tasks.filter(t => t.id !== taskId)
              }
            }
          };
        }));
      };
      
      // Add activity
      const addActivity = (eventId) => {
        if (!newActivityText.trim()) return;
        setEvents(prev => prev.map(e => {
          if (e.id !== eventId) return e;
          const updated = ensureEventSections(e);
          return {
            ...updated,
            sections: {
              ...updated.sections,
              activities: {
                ...updated.sections.activities,
                tasks: [...(updated.sections.activities?.tasks || []), {
                  id: generateId(),
                  text: newActivityText,
                  completed: false
                }]
              }
            }
          };
        }));
        setNewActivityText('');
      };
      
      // Add custom logistics task
      const [newLogisticsText, setNewLogisticsText] = useState('');
      const addLogisticsTask = (eventId) => {
        if (!newLogisticsText.trim()) return;
        setEvents(prev => prev.map(e => {
          if (e.id !== eventId) return e;
          const updated = ensureEventSections(e);
          return {
            ...updated,
            sections: {
              ...updated.sections,
              logistics: {
                ...updated.sections.logistics,
                tasks: [...(updated.sections.logistics?.tasks || []), {
                  id: generateId(),
                  text: newLogisticsText,
                  completed: false
                }]
              }
            }
          };
        }));
        setNewLogisticsText('');
      };
      
      // Update event field
      const updateEventField = (eventId, field, value) => {
        setEvents(prev => prev.map(e => 
          e.id === eventId ? { ...e, [field]: value } : e
        ));
      };
      
      // Event List View
      if (!planningEvent) {
        return (
          <div style={styles.eventsTab}>
            <button style={styles.addItemButton} onClick={onAdd}>+ Add Event</button>
            
            {events.length === 0 ? (
              <div style={{ textAlign: 'center', padding: '2rem 1rem' }}>
                <p style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>üóìÔ∏è</p>
                <p style={styles.emptyText}>No events planned yet.</p>
                <p style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>Add trips, celebrations, or projects!</p>
              </div>
            ) : (
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                {events.map(event => {
                  const e = ensureEventSections(event);
                  const progress = getProgress(e);
                  const typeInfo = EVENT_TYPES[e.type] || EVENT_TYPES.personal;
                  
                  return (
                    <div 
                      key={event.id} 
                      style={{
                        backgroundColor: 'var(--bg-card)',
                        borderRadius: '12px',
                        border: '1px solid var(--border)',
                        overflow: 'hidden',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease'
                      }}
                      onClick={() => setPlanningEvent(event.id)}
                    >
                      <div style={{ padding: '0.875rem' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.4rem' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                            <span style={{ fontSize: '1.1rem' }}>{typeInfo.icon}</span>
                            <div>
                              <h3 style={{ 
                                fontFamily: "'Fraunces', serif",
                                fontSize: '0.95rem',
                                fontWeight: 600,
                                color: 'var(--text)',
                                margin: 0
                              }}>{event.title}</h3>
                              <p style={{ fontSize: '0.7rem', color: 'var(--text-muted)', margin: '0.1rem 0 0' }}>
                                {MONTHS[event.month]} {e.location && `‚Ä¢ ${e.location}`}
                              </p>
                            </div>
                          </div>
                        </div>
                        
                        {/* Progress bar */}
                        <div style={{ 
                          height: '3px', 
                          backgroundColor: 'var(--border)', 
                          borderRadius: '2px',
                          overflow: 'hidden',
                          marginTop: '0.5rem'
                        }}>
                          <div style={{
                            height: '100%',
                            width: `${progress}%`,
                            backgroundColor: typeInfo.color,
                            borderRadius: '2px',
                            transition: 'width 0.3s ease'
                          }}></div>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        );
      }
      
      // Event Planning View
      const event = events.find(e => e.id === planningEvent);
      if (!event) {
        setPlanningEvent(null);
        return null;
      }
      
      const e = ensureEventSections(event);
      const typeInfo = EVENT_TYPES[e.type] || EVENT_TYPES.personal;
      const currentSection = e.sections?.[activeSection] || { tasks: [], chatHistory: [] };
      
      return (
        <div style={{ 
          display: 'flex', 
          flexDirection: 'column', 
          height: '100%',
          backgroundColor: 'var(--bg)'
        }}>
          {/* Compact Header */}
          <div style={{
            padding: '0.75rem',
            borderBottom: '1px solid var(--border)',
            backgroundColor: 'var(--bg-card)'
          }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
              <button 
                onClick={() => setPlanningEvent(null)}
                style={{
                  background: 'none',
                  border: 'none',
                  fontSize: '1rem',
                  cursor: 'pointer',
                  color: 'var(--text-muted)',
                  padding: '0.15rem'
                }}
              >‚Üê</button>
              <span style={{ fontSize: '1rem' }}>{typeInfo.icon}</span>
              <span style={{
                fontFamily: "'Fraunces', serif",
                fontSize: '0.9rem',
                fontWeight: 600,
                color: 'var(--text)',
                flex: 1
              }}>{event.title}</span>
              <span style={{ fontSize: '0.7rem', color: 'var(--text-muted)' }}>
                {MONTH_FULL[event.month]}
              </span>
            </div>
            
            {/* Section tabs */}
            <div style={{ 
              display: 'flex', 
              gap: '0.25rem'
            }}>
              {Object.entries(SECTIONS).map(([key, section]) => (
                <button
                  key={key}
                  onClick={() => setActiveSection(key)}
                  style={{
                    padding: '0.35rem 0.6rem',
                    borderRadius: '6px',
                    border: 'none',
                    backgroundColor: activeSection === key ? typeInfo.color : 'transparent',
                    color: activeSection === key ? 'white' : 'var(--text-muted)',
                    fontSize: '0.7rem',
                    fontWeight: 500,
                    cursor: 'pointer',
                    transition: 'all 0.2s ease'
                  }}
                >
                  {section.icon} {section.label}
                </button>
              ))}
              <button
                onClick={() => {
                  onDelete(event.id);
                  setPlanningEvent(null);
                }}
                style={{
                  marginLeft: 'auto',
                  background: 'none',
                  border: 'none',
                  color: '#E88B9C',
                  fontSize: '0.7rem',
                  cursor: 'pointer'
                }}
              >Delete</button>
            </div>
          </div>
          
          {/* Section Content */}
          <div style={{ flex: 1, overflow: 'auto', padding: '0.875rem' }}>
            {activeSection === 'overview' ? (
              /* Overview Section */
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.875rem' }}>
                <div>
                  <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Event Name</label>
                  <input
                    type="text"
                    value={event.title || ''}
                    onChange={(ev) => updateEventField(event.id, 'title', ev.target.value)}
                    placeholder="What is this event?"
                    style={{
                      width: '100%',
                      padding: '0.5rem',
                      marginTop: '0.35rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-elevated)',
                      fontSize: '0.9rem',
                      fontWeight: 500,
                      color: 'var(--text)'
                    }}
                  />
                </div>
                
                <div>
                  <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Type</label>
                  <div style={{ display: 'flex', gap: '0.4rem', marginTop: '0.4rem', flexWrap: 'wrap' }}>
                    {Object.entries(EVENT_TYPES).map(([key, type]) => (
                      <button
                        key={key}
                        onClick={() => updateEventField(event.id, 'type', key)}
                        style={{
                          padding: '0.35rem 0.6rem',
                          borderRadius: '6px',
                          border: e.type === key ? 'none' : '1px solid var(--border)',
                          backgroundColor: e.type === key ? type.color : 'var(--bg-elevated)',
                          color: e.type === key ? 'white' : 'var(--text)',
                          fontSize: '0.75rem',
                          cursor: 'pointer'
                        }}
                      >
                        {type.icon} {type.label}
                      </button>
                    ))}
                  </div>
                </div>
                
                <div>
                  <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Location</label>
                  <input
                    type="text"
                    value={e.location || ''}
                    onChange={(ev) => updateEventField(event.id, 'location', ev.target.value)}
                    placeholder="Where is this happening?"
                    style={{
                      width: '100%',
                      padding: '0.5rem',
                      marginTop: '0.35rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-elevated)',
                      fontSize: '0.8rem',
                      color: 'var(--text)'
                    }}
                  />
                </div>
                
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.6rem' }}>
                  <div>
                    <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase' }}>Start</label>
                    <input
                      type="date"
                      value={e.startDate || ''}
                      onChange={(ev) => updateEventField(event.id, 'startDate', ev.target.value)}
                      style={{
                        width: '100%',
                        padding: '0.5rem',
                        marginTop: '0.35rem',
                        borderRadius: '6px',
                        border: '1px solid var(--border)',
                        backgroundColor: 'var(--bg-elevated)',
                        fontSize: '0.8rem',
                        color: 'var(--text)'
                      }}
                    />
                  </div>
                  <div>
                    <label style={{ fontSize: '0.65rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase' }}>End</label>
                    <input
                      type="date"
                      value={e.endDate || ''}
                      onChange={(ev) => updateEventField(event.id, 'endDate', ev.target.value)}
                      style={{
                        width: '100%',
                        padding: '0.5rem',
                        marginTop: '0.35rem',
                        borderRadius: '6px',
                        border: '1px solid var(--border)',
                        backgroundColor: 'var(--bg-elevated)',
                        fontSize: '0.8rem',
                        color: 'var(--text)'
                      }}
                    />
                  </div>
                </div>
              </div>
            ) : activeSection === 'logistics' ? (
              /* Logistics Section */
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                {(currentSection.tasks || []).map(task => (
                  <div 
                    key={task.id}
                    style={{
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.6rem',
                      padding: '0.6rem',
                      backgroundColor: 'var(--bg-card)',
                      borderRadius: '8px',
                      border: '1px solid var(--border)'
                    }}
                  >
                    <button
                      onClick={() => toggleTask(event.id, 'logistics', task.id)}
                      style={{
                        width: '18px',
                        height: '18px',
                        borderRadius: '4px',
                        border: task.completed ? 'none' : '2px solid var(--border)',
                        backgroundColor: task.completed ? typeInfo.color : 'transparent',
                        color: 'white',
                        fontSize: '0.65rem',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        flexShrink: 0
                      }}
                    >
                      {task.completed && '‚úì'}
                    </button>
                    <span style={{
                      flex: 1,
                      fontSize: '0.8rem',
                      color: task.completed ? 'var(--text-muted)' : 'var(--text)',
                      textDecoration: task.completed ? 'line-through' : 'none'
                    }}>{task.text}</span>
                    <button
                      onClick={() => deleteTask(event.id, 'logistics', task.id)}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: 'var(--text-muted)',
                        fontSize: '0.9rem',
                        cursor: 'pointer',
                        padding: '0.2rem'
                      }}
                    >√ó</button>
                  </div>
                ))}
                
                {/* Add custom logistics task */}
                <div style={{ display: 'flex', gap: '0.4rem', marginTop: '0.5rem' }}>
                  <input
                    type="text"
                    value={newLogisticsText}
                    onChange={(ev) => setNewLogisticsText(ev.target.value)}
                    onKeyDown={(ev) => ev.key === 'Enter' && addLogisticsTask(event.id)}
                    placeholder="Add a task..."
                    style={{
                      flex: 1,
                      padding: '0.5rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-elevated)',
                      fontSize: '0.8rem',
                      color: 'var(--text)'
                    }}
                  />
                  <button
                    onClick={() => addLogisticsTask(event.id)}
                    style={{
                      padding: '0.5rem 0.75rem',
                      borderRadius: '6px',
                      border: 'none',
                      backgroundColor: typeInfo.color,
                      color: 'white',
                      fontSize: '0.8rem',
                      cursor: 'pointer'
                    }}
                  >+</button>
                </div>
              </div>
            ) : (
              /* Activities Section */
              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.75rem' }}>
                {/* Activity List */}
                {(currentSection.tasks || []).length > 0 && (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                    {currentSection.tasks.map(activity => (
                      <div 
                        key={activity.id}
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.6rem',
                          padding: '0.6rem',
                          backgroundColor: 'var(--bg-card)',
                          borderRadius: '8px',
                          border: '1px solid var(--border)'
                        }}
                      >
                        <button
                          onClick={() => toggleTask(event.id, 'activities', activity.id)}
                          style={{
                            width: '18px',
                            height: '18px',
                            borderRadius: '4px',
                            border: activity.completed ? 'none' : '2px solid var(--border)',
                            backgroundColor: activity.completed ? typeInfo.color : 'transparent',
                            color: 'white',
                            fontSize: '0.65rem',
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            flexShrink: 0
                          }}
                        >
                          {activity.completed && '‚úì'}
                        </button>
                        <span style={{
                          flex: 1,
                          fontSize: '0.8rem',
                          color: activity.completed ? 'var(--text-muted)' : 'var(--text)',
                          textDecoration: activity.completed ? 'line-through' : 'none'
                        }}>{activity.text}</span>
                        <button
                          onClick={() => deleteTask(event.id, 'activities', activity.id)}
                          style={{
                            background: 'none',
                            border: 'none',
                            color: 'var(--text-muted)',
                            fontSize: '0.9rem',
                            cursor: 'pointer',
                            padding: '0.2rem'
                          }}
                        >√ó</button>
                      </div>
                    ))}
                  </div>
                )}
                
                {/* Add Activity Input */}
                <div style={{ display: 'flex', gap: '0.4rem' }}>
                  <input
                    type="text"
                    value={newActivityText}
                    onChange={(ev) => setNewActivityText(ev.target.value)}
                    onKeyDown={(ev) => ev.key === 'Enter' && addActivity(event.id)}
                    placeholder="Add an activity..."
                    style={{
                      flex: 1,
                      padding: '0.5rem',
                      borderRadius: '6px',
                      border: '1px solid var(--border)',
                      backgroundColor: 'var(--bg-elevated)',
                      fontSize: '0.8rem',
                      color: 'var(--text)'
                    }}
                  />
                  <button
                    onClick={() => addActivity(event.id)}
                    style={{
                      padding: '0.5rem 0.75rem',
                      borderRadius: '6px',
                      border: 'none',
                      backgroundColor: typeInfo.color,
                      color: 'white',
                      fontSize: '0.8rem',
                      cursor: 'pointer'
                    }}
                  >+</button>
                </div>
                
                {/* AI Chat Section */}
                <div style={{
                  marginTop: '0.5rem',
                  padding: '0.75rem',
                  backgroundColor: 'var(--bg-card)',
                  borderRadius: '10px',
                  border: '1px solid var(--border)'
                }}>
                  <h4 style={{
                    fontSize: '0.7rem',
                    fontWeight: 600,
                    color: 'var(--text-muted)',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    marginBottom: '0.6rem'
                  }}>üí¨ Ask for activity ideas</h4>
                  
                  {/* Chat History */}
                  {currentSection.chatHistory?.length > 0 && (
                    <div style={{
                      maxHeight: '180px',
                      overflowY: 'auto',
                      marginBottom: '0.6rem',
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '0.4rem'
                    }}>
                      {currentSection.chatHistory.map((msg, i) => (
                        <div 
                          key={i}
                          style={{
                            padding: '0.4rem 0.6rem',
                            borderRadius: '6px',
                            backgroundColor: msg.role === 'user' ? `${typeInfo.color}20` : 'var(--bg-elevated)',
                            fontSize: '0.75rem',
                            color: 'var(--text)',
                            alignSelf: msg.role === 'user' ? 'flex-end' : 'flex-start',
                            maxWidth: '85%'
                          }}
                        >
                          {msg.content}
                        </div>
                      ))}
                    </div>
                  )}
                  
                  {/* Chat Input */}
                  <div style={{ display: 'flex', gap: '0.4rem' }}>
                    <input
                      type="text"
                      value={sectionChat}
                      onChange={(ev) => setSectionChat(ev.target.value)}
                      onKeyDown={(ev) => ev.key === 'Enter' && chatWithAI(e, sectionChat)}
                      placeholder={e.location ? `What to do in ${e.location}?` : 'What activities should I plan?'}
                      disabled={isAiThinking}
                      style={{
                        flex: 1,
                        padding: '0.5rem',
                        borderRadius: '6px',
                        border: '1px solid var(--border)',
                        backgroundColor: 'var(--bg-elevated)',
                        fontSize: '0.75rem',
                        color: 'var(--text)'
                      }}
                    />
                    <button
                      onClick={() => chatWithAI(e, sectionChat)}
                      disabled={isAiThinking || !sectionChat.trim()}
                      style={{
                        padding: '0.5rem 0.75rem',
                        borderRadius: '6px',
                        border: 'none',
                        backgroundColor: isAiThinking ? 'var(--border)' : typeInfo.color,
                        color: 'white',
                        fontSize: '0.75rem',
                        cursor: isAiThinking ? 'default' : 'pointer'
                      }}
                    >
                      {isAiThinking ? '...' : '‚Üí'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    function NotesTab({ notes, setNotes, revealed }) {
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>A scratchpad for planning ideas.</p></div>;
      }
      return (
        <div style={styles.notesTab}>
          <textarea style={styles.notesTextarea} value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Jot down future plans, trip ideas, things to remember..." />
        </div>
      );
    }

    function GoalsTab({ goals, setGoals, onAdd, revealed }) {
      if (!revealed) {
        return <div style={styles.tabPlaceholder}><p style={styles.placeholderText}>Your goals will live here.</p></div>;
      }

      return (
        <div style={styles.goalsTab}>
          <button style={styles.addItemButton} onClick={onAdd}>+ Add Goal</button>
          {goals.length === 0 ? (
            <p style={styles.emptyText}>No goals yet.</p>
          ) : (
            <div style={styles.goalsList}>
              {goals.map(goal => (
                <div key={goal.id} style={{...styles.goalCard, opacity: goal.completed ? 0.6 : 1}}>
                  <button
                    style={{...styles.goalCheck, backgroundColor: goal.completed ? 'var(--accent)' : 'transparent'}}
                    onClick={() => setGoals(goals.map(g => g.id === goal.id ? {...g, completed: !g.completed} : g))}
                  >{goal.completed && '‚úì'}</button>
                  <span style={{...styles.goalText, textDecoration: goal.completed ? 'line-through' : 'none'}}>{goal.text}</span>
                  <button style={styles.goalDelete} onClick={() => setGoals(goals.filter(g => g.id !== goal.id))}>√ó</button>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    function LifeAreasTab({ vlqScores, setVlqScores, goals, setGoals, onReassess, onAddGoal, revealed }) {
      if (!revealed) {
        return <div style={{padding: '1rem'}}><p style={{fontSize: '0.8rem', color: 'var(--text-muted)', fontStyle: 'italic'}}>Complete the assessment to see your life areas.</p></div>;
      }

      // Categorize life areas
      const focusAreas = []; // gap >= 2
      const strengths = []; // importance >= 5, gap < 3
      const lowImportance = []; // importance < 5, gap < 3

      VLQ_ORDER.forEach(areaKey => {
        const area = VLQ_DOMAINS[areaKey];
        const importance = vlqScores[areaKey]?.importance || 5;
        const consistency = vlqScores[areaKey]?.consistency || 5;
        const gap = importance - consistency;

        const areaData = {
          key: areaKey,
          ...area,
          importance,
          consistency,
          gap
        };

        if (gap >= 2) {
          focusAreas.push(areaData);
        } else if (importance >= 5 && gap < 3) {
          strengths.push(areaData);
        } else if (importance < 5 && gap < 3) {
          lowImportance.push(areaData);
        }
      });

      // Get goals for a specific life area
      const getAreaGoals = (areaKey) => goals.filter(g => g.lifeArea === areaKey);
      
      // Get goals without a life area
      const unassignedGoals = goals.filter(g => !g.lifeArea);

      const renderAreaCard = (area) => {
        const areaGoals = getAreaGoals(area.key);
        
        return (
          <div key={area.key} style={{
            padding: '0.5rem',
            backgroundColor: 'var(--bg-elevated)',
            borderRadius: '8px',
            borderLeft: `3px solid ${area.color}`,
            fontSize: '0.75rem'
          }}>
            <div style={{
              display: 'flex',
              alignItems: 'center',
              gap: '0.375rem',
              marginBottom: '0.25rem'
            }}>
              <span style={{fontSize: '0.9rem'}}>{area.icon}</span>
              <span style={{fontWeight: 500, color: 'var(--text)'}}>{area.name}</span>
            </div>
            <div style={{
              display: 'flex',
              gap: '0.75rem',
              fontSize: '0.65rem',
              color: 'var(--text-muted)',
              marginBottom: areaGoals.length > 0 ? '0.5rem' : 0
            }}>
              <span>Importance: {area.importance}</span>
              <span>Consistency: {area.consistency}</span>
            </div>
            
            {/* Goals for this area */}
            {areaGoals.length > 0 && (
              <div style={{
                marginTop: '0.375rem',
                paddingTop: '0.375rem',
                borderTop: '1px solid var(--border)',
                display: 'flex',
                flexDirection: 'column',
                gap: '0.25rem'
              }}>
                {areaGoals.map(goal => (
                  <div key={goal.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.375rem',
                    padding: '0.25rem 0',
                    opacity: goal.completed ? 0.5 : 1
                  }}>
                    <input
                      type="checkbox"
                      checked={goal.completed}
                      onChange={() => setGoals(goals.map(g => g.id === goal.id ? {...g, completed: !g.completed} : g))}
                      style={{margin: 0, cursor: 'pointer', accentColor: area.color, width: '14px', height: '14px'}}
                    />
                    <span style={{
                      fontSize: '0.75rem',
                      textDecoration: goal.completed ? 'line-through' : 'none',
                      flex: 1,
                      color: 'var(--text)'
                    }}>{goal.text}</span>
                    <button 
                      style={{background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.7rem', padding: '0 2px'}}
                      onClick={() => setGoals(goals.filter(g => g.id !== goal.id))}
                    >√ó</button>
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      };

      return (
        <div style={{padding: '0.75rem', display: 'flex', flexDirection: 'column', gap: '1rem', height: '100%', overflowY: 'auto'}}>
          
          {/* Add Goal Button */}
          <button style={{
            padding: '0.5rem',
            backgroundColor: 'var(--accent-light)',
            border: '1px solid var(--accent)',
            borderRadius: '8px',
            color: 'var(--accent)',
            fontSize: '0.75rem',
            cursor: 'pointer',
            fontWeight: 500
          }} onClick={onAddGoal}>+ Add Goal</button>
          
          {/* Focus Areas */}
          {focusAreas.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                üå± Focus On
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                {focusAreas.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Strengths */}
          {strengths.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                üí™ Thriving
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                {strengths.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Low Importance */}
          {lowImportance.length > 0 && (
            <div>
              <h3 style={{
                fontSize: '0.7rem', 
                fontWeight: 600, 
                textTransform: 'uppercase', 
                letterSpacing: '0.05em', 
                color: 'var(--text-muted)', 
                marginBottom: '0.5rem'
              }}>
                üìä Low Priority
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                {lowImportance.map(renderAreaCard)}
              </div>
            </div>
          )}

          {/* Unassigned Goals */}
          {unassignedGoals.length > 0 && (
            <div style={{marginTop: '0.5rem'}}>
              <h3 style={{fontSize: '0.7rem', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em', color: 'var(--text-muted)', marginBottom: '0.5rem'}}>
                üéØ Other Goals
              </h3>
              <div style={{display: 'flex', flexDirection: 'column', gap: '0.375rem'}}>
                {unassignedGoals.map(goal => (
                  <div key={goal.id} style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                    padding: '0.5rem 0.625rem',
                    backgroundColor: 'var(--bg-elevated)',
                    borderRadius: '8px',
                    opacity: goal.completed ? 0.5 : 1
                  }}>
                    <input
                      type="checkbox"
                      checked={goal.completed}
                      onChange={() => setGoals(goals.map(g => g.id === goal.id ? {...g, completed: !g.completed} : g))}
                      style={{margin: 0, cursor: 'pointer', accentColor: 'var(--accent)'}}
                    />
                    <span style={{
                      fontSize: '0.8rem',
                      textDecoration: goal.completed ? 'line-through' : 'none',
                      flex: 1,
                      color: 'var(--text)'
                    }}>{goal.text}</span>
                    <button 
                      style={{background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.8rem'}}
                      onClick={() => setGoals(goals.filter(g => g.id !== goal.id))}
                    >√ó</button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Reassess Button */}
          <button 
            style={{
              padding: '0.625rem',
              backgroundColor: 'transparent',
              border: '1px dashed var(--border)',
              borderRadius: '8px',
              color: 'var(--text-muted)',
              fontSize: '0.75rem',
              cursor: 'pointer',
              marginTop: 'auto'
            }}
            onClick={onReassess}
          >
            Reassess My Values
          </button>
        </div>
      );
    }

    function ChatMessage({ message, onNavigate, onButtonClick }) {
      const isAssistant = message.role === 'assistant';
      
      // Parse content for buttons and clean display text
      const parseContent = (content) => {
        // Extract buttons [BUTTON: label | action]
        const buttons = [];
        const buttonRegex = /\[BUTTON:\s*([^\|]+)\s*\|\s*([^\]]+)\]/g;
        let match;
        while ((match = buttonRegex.exec(content)) !== null) {
          buttons.push({ label: match[1].trim(), action: match[2].trim() });
        }
        
        // Remove button tags from display
        let cleanContent = content.replace(/\[BUTTON:[^\]]+\]/g, '').trim();
        // Remove navigate tags from display (handled separately)
        cleanContent = cleanContent.replace(/\[NAVIGATE:[^\]]+\]/g, '').trim();
        
        return { cleanContent, buttons };
      };
      
      const { cleanContent, buttons } = parseContent(message.content);
      
      // Collapse multiple line breaks into single breaks for cleaner display
      const formattedContent = cleanContent
        .replace(/\n{3,}/g, '\n\n')  // Max 2 line breaks (one blank line)
        .replace(/\n/g, '<br/>');
      
      return (
        <div style={{...styles.chatMessage, justifyContent: isAssistant ? 'flex-start' : 'flex-end'}} className="fade-in">
          {isAssistant && <div style={styles.chatAvatar}><span style={styles.chatAvatarText}>T</span></div>}
          <div style={{...styles.chatBubble, ...(isAssistant ? styles.chatBubbleAssistant : styles.chatBubbleUser)}}>
            <div dangerouslySetInnerHTML={{ __html: formattedContent }} />
            {buttons.length > 0 && (
              <div style={{ marginTop: '0.75rem', display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                {buttons.map((btn, i) => (
                  <button
                    key={i}
                    onClick={() => onButtonClick && onButtonClick(btn.action)}
                    style={{
                      padding: '0.6rem 1rem',
                      backgroundColor: 'var(--accent)',
                      color: 'white',
                      border: 'none',
                      borderRadius: '8px',
                      fontSize: '0.85rem',
                      fontWeight: 500,
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      justifyContent: 'center',
                    }}
                  >
                    <span>üìç</span> {btn.label}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    function TypingIndicator() {
      return (
        <div style={styles.chatMessage} className="fade-in">
          <div style={styles.chatAvatar}><span style={styles.chatAvatarText}>T</span></div>
          <div style={styles.typingBubble}>
            <span style={{...styles.typingDot, animationDelay: '0s'}}>‚Ä¢</span>
            <span style={{...styles.typingDot, animationDelay: '0.15s'}}>‚Ä¢</span>
            <span style={{...styles.typingDot, animationDelay: '0.3s'}}>‚Ä¢</span>
          </div>
        </div>
      );
    }

    // Onboarding Progress Bar Component
    function OnboardingProgressBar({ currentStep, onStepClick, isStepComplete, getProgress, vlqCompleted }) {
      const steps = [
        { num: 0, id: 'vlq', label: 'Values', icon: 'üíö', alwaysComplete: true },
        { num: 1, id: 'lifemap', label: 'Life Map', icon: 'üó∫Ô∏è' },
        { num: 2, id: 'quiz', label: 'Quiz', icon: 'üå∏', optional: true },
        { num: 3, id: 'tend', label: 'First Tend', icon: 'üå±' },
      ];

      const progress = getProgress();

      return (
        <div style={{
          background: 'var(--bg-card)',
          border: '1px solid var(--border)',
          borderRadius: '12px',
          padding: '0.75rem 1rem 0.5rem',
          width: '100%',
          maxWidth: '480px',
        }}>
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '0.25rem',
          }}>
            {steps.map((step, idx) => {
              const isActive = currentStep === step.num;
              const isComplete = step.alwaysComplete ? vlqCompleted : isStepComplete(step.num);
              const isPast = step.num < currentStep;
              const isClickable = step.alwaysComplete || step.num <= currentStep || isComplete;
              const stepProgress = progress[step.num];
              
              return (
                <React.Fragment key={step.num}>
                  {idx > 0 && (
                    <div style={{
                      flex: '1',
                      height: '2px',
                      maxWidth: '40px',
                      backgroundColor: isPast || isComplete ? 'var(--accent)' : 'var(--border)',
                      transition: 'background-color 0.3s ease',
                      borderRadius: '1px',
                    }} />
                  )}
                  <button
                    onClick={() => isClickable && onStepClick(step.num)}
                    disabled={!isClickable}
                    style={{
                      display: 'flex',
                      flexDirection: 'column',
                      alignItems: 'center',
                      gap: '0.25rem',
                      padding: '0.35rem 0.5rem 0.25rem',
                      backgroundColor: isActive ? 'var(--accent-light)' : 'transparent',
                      border: 'none',
                      borderRadius: '10px',
                      cursor: isClickable ? 'pointer' : 'default',
                      opacity: isClickable ? 1 : 0.4,
                      transition: 'all 0.2s ease',
                      minWidth: '52px',
                      position: 'relative',
                    }}
                    title={step.optional ? `${step.label} (optional)` : step.label}
                  >
                    <div style={{
                      width: '30px',
                      height: '30px',
                      borderRadius: '50%',
                      backgroundColor: isComplete ? 'var(--accent)' : isActive ? 'white' : 'var(--bg-elevated)',
                      border: isActive ? '2px solid var(--accent)' : '1px solid var(--border)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '1rem',
                      transition: 'all 0.2s ease',
                      boxShadow: isActive ? '0 2px 6px rgba(107, 139, 98, 0.3)' : 'none',
                    }}>
                      {isComplete ? <span style={{ color: 'white', fontSize: '0.8rem' }}>‚úì</span> : step.icon}
                    </div>
                    <span style={{
                      fontSize: '0.65rem',
                      fontWeight: isActive ? 600 : 400,
                      color: isActive ? 'var(--accent)' : 'var(--text-muted)',
                      whiteSpace: 'nowrap',
                      letterSpacing: '0.02em',
                    }}>
                      {step.label}
                    </span>
                    {step.optional && !isComplete && (
                      <span style={{
                        position: 'absolute',
                        top: '2px',
                        right: '2px',
                        fontSize: '0.5rem',
                        color: 'var(--text-muted)',
                        opacity: 0.6,
                      }}>skip</span>
                    )}
                  </button>
                </React.Fragment>
              );
            })}
          </div>
          {/* Progress hint for current step */}
          {currentStep !== null && progress[currentStep] && (
            <div style={{
              textAlign: 'center',
              marginTop: '0.35rem',
              fontSize: '0.65rem',
              color: 'var(--text-muted)',
            }}>
              {currentStep === 1 && (
                <span>
                  {progress[1].current}/{progress[1].required} focus areas complete
                </span>
              )}
              {currentStep === 2 && <span>{progress[2].current === 1 ? 'Quiz completed!' : 'Take the quiz (optional)'}</span>}
              {currentStep === 3 && <span>{progress[3].current === 1 ? 'First tend completed!' : 'Complete your first daily tend'}</span>}
            </div>
          )}
        </div>
      );
    }

    function EventModal({ onClose, onAdd }) {
      const [title, setTitle] = useState('');
      const [month, setMonth] = useState(new Date().getMonth());
      const [lifeArea, setLifeArea] = useState('');
      const [eventType, setEventType] = useState('personal');
      
      const EVENT_TYPES = {
        trip: { label: 'Trip', icon: '‚úàÔ∏è' },
        celebration: { label: 'Celebration', icon: 'üéâ' },
        project: { label: 'Project', icon: 'üìã' },
        personal: { label: 'Personal', icon: '‚≠ê' }
      };

      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={styles.modal} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Add an event</h3>
              <button style={styles.modalClose} onClick={onClose}>√ó</button>
            </div>
            <form onSubmit={(e) => { e.preventDefault(); if (title) onAdd({ title, month, lifeArea, type: eventType }); }} style={styles.modalForm}>
              <div style={styles.formField}>
                <label style={styles.formLabel}>What is it?</label>
                <input type="text" style={styles.textInput} value={title} onChange={(e) => setTitle(e.target.value)} placeholder="Trip, birthday, deadline..." autoFocus />
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>Type</label>
                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                  {Object.entries(EVENT_TYPES).map(([key, type]) => (
                    <button
                      key={key}
                      type="button"
                      onClick={() => setEventType(key)}
                      style={{
                        padding: '0.4rem 0.75rem',
                        borderRadius: '8px',
                        border: eventType === key ? 'none' : '1px solid var(--border)',
                        backgroundColor: eventType === key ? 'var(--accent)' : 'var(--bg-elevated)',
                        color: eventType === key ? 'white' : 'var(--text)',
                        fontSize: '0.8rem',
                        cursor: 'pointer'
                      }}
                    >
                      {type.icon} {type.label}
                    </button>
                  ))}
                </div>
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>When?</label>
                <select style={styles.selectInput} value={month} onChange={(e) => setMonth(parseInt(e.target.value))}>
                  {MONTHS.map((m, i) => <option key={i} value={i}>{m} 2026</option>)}
                </select>
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>Life Area</label>
                <select style={styles.selectInput} value={lifeArea} onChange={(e) => setLifeArea(e.target.value)}>
                  <option value="">‚Äî N/A ‚Äî</option>
                  {VLQ_ORDER.map(key => (
                    <option key={key} value={key}>{VLQ_DOMAINS[key].icon} {VLQ_DOMAINS[key].name}</option>
                  ))}
                </select>
              </div>
              <button type="submit" style={{...styles.submitButton, ...(!title ? styles.submitButtonDisabled : {})}} disabled={!title}>Add to year</button>
            </form>
          </div>
        </div>
      );
    }

    function GoalModal({ onClose, onAdd, focusAreas = [] }) {
      const [text, setText] = useState('');
      const [lifeArea, setLifeArea] = useState('');
      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={styles.modal} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Add a goal</h3>
              <button style={styles.modalClose} onClick={onClose}>√ó</button>
            </div>
            <form onSubmit={(e) => { e.preventDefault(); if (text) onAdd({ text, lifeArea }); }} style={styles.modalForm}>
              <div style={styles.formField}>
                <label style={styles.formLabel}>What do you want to achieve?</label>
                <input type="text" style={styles.textInput} value={text} onChange={(e) => setText(e.target.value)} placeholder="Run a 5K, read 12 books..." autoFocus />
              </div>
              <div style={styles.formField}>
                <label style={styles.formLabel}>Life Area {focusAreas.length > 0 && <span style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>(cover your focus areas: {focusAreas.map(a => VLQ_DOMAINS[a]?.name.split(' ')[0]).join(', ')})</span>}</label>
                <select style={styles.selectInput} value={lifeArea} onChange={(e) => setLifeArea(e.target.value)}>
                  <option value="">‚Äî Select life area ‚Äî</option>
                  {VLQ_ORDER.map(key => (
                    <option key={key} value={key} style={focusAreas.includes(key) ? { fontWeight: 'bold' } : {}}>
                      {VLQ_DOMAINS[key].icon} {VLQ_DOMAINS[key].name} {focusAreas.includes(key) ? '‚≠ê' : ''}
                    </option>
                  ))}
                </select>
              </div>
              <button type="submit" style={{...styles.submitButton, ...(!text ? styles.submitButtonDisabled : {})}} disabled={!text}>Add goal</button>
            </form>
          </div>
        </div>
      );
    }

    function SettingsModal({ apiKey, setApiKey, onClose, user, onLogout, onDeleteAccount, onOpenAdmin }) {
      const [key, setKey] = useState(apiKey);
      
      const handleSave = () => {
        setApiKey(key);
        onClose();
      };

      return (
        <div style={styles.modalOverlay} onClick={onClose}>
          <div style={{...styles.modal, maxWidth: '420px'}} onClick={e => e.stopPropagation()} className="fade-in">
            <div style={styles.modalHeader}>
              <h3 style={styles.modalTitle}>Settings</h3>
              <button style={styles.modalClose} onClick={onClose}>√ó</button>
            </div>
            <div style={styles.modalForm}>
              {/* Account Section */}
              <div style={{...styles.formField, marginBottom: '1.5rem', paddingBottom: '1.5rem', borderBottom: '1px solid var(--border)'}}>
                <label style={styles.formLabel}>Account</label>
                <p style={{fontSize: '0.9rem', color: 'var(--text)', marginBottom: '0.75rem'}}>
                  {user?.email}
                </p>
                <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
                  <button 
                    onClick={() => { onLogout(); onClose(); }} 
                    style={{
                      padding: '0.5rem 1rem',
                      backgroundColor: 'transparent',
                      border: '1px solid var(--border)',
                      borderRadius: '8px',
                      color: 'var(--text-muted)',
                      fontSize: '0.8rem',
                      cursor: 'pointer',
                    }}
                  >
                    Sign Out
                  </button>
                  <button 
                    onClick={() => { onDeleteAccount(); }} 
                    style={{
                      padding: '0.5rem 1rem',
                      backgroundColor: 'transparent',
                      border: '1px solid #dc3545',
                      borderRadius: '8px',
                      color: '#dc3545',
                      fontSize: '0.8rem',
                      cursor: 'pointer',
                    }}
                  >
                    Delete Account
                  </button>
                </div>
              </div>

              {/* API Key Section */}
              <div style={{...styles.formField, marginBottom: '1.5rem', paddingBottom: '1.5rem', borderBottom: '1px solid var(--border)'}}>
                <label style={styles.formLabel}>Anthropic API Key</label>
                <input 
                  type="password" 
                  style={styles.textInput} 
                  value={key} 
                  onChange={(e) => setKey(e.target.value)} 
                  placeholder="sk-ant-..." 
                  autoFocus 
                />
                <p style={styles.settingsHint}>
                  Your key is stored locally in your browser only. Get one at{' '}
                  <a href="https://console.anthropic.com/api-keys" target="_blank" rel="noopener noreferrer" style={styles.settingsLink}>
                    console.anthropic.com
                  </a>
                </p>
              </div>
              
              {/* Beta Tools Section */}
              <div style={styles.formField}>
                <label style={styles.formLabel}>Beta Tools</label>
                <button 
                  onClick={() => { onOpenAdmin(); onClose(); }} 
                  style={{
                    padding: '0.5rem 1rem',
                    backgroundColor: 'var(--bg-elevated)',
                    border: '1px solid var(--border)',
                    borderRadius: '8px',
                    color: 'var(--text)',
                    fontSize: '0.8rem',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem',
                  }}
                >
                  <span>üõ†Ô∏è</span> Admin Dashboard
                </button>
                <p style={{...styles.settingsHint, marginTop: '0.5rem'}}>
                  View your data, tend system info, and debug tools
                </p>
              </div>
              
              <button onClick={handleSave} style={{...styles.submitButton, marginTop: '1.5rem'}}>Save</button>
              {apiKey && (
                <p style={styles.settingsStatus}>‚úì API key is set</p>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Admin Dashboard - For Tend team to view user data structure
    function AdminDashboard({ 
      user,
      savedConversations, 
      trends, 
      userProfile,
      journalEntries,
      goals,
      events,
      todaysTendies,
      tendyHistory,
      vlqScores,
      vlqCompleted,
      weeklyHabits,
      habitCompletions,
      chatHistory,
      onboardingStep,
      onboardingCompleted,
      onClose 
    }) {
      const [activeTab, setActiveTab] = useState('overview');
      const conversationCount = Object.keys(savedConversations || {}).length;
      const journalCount = Object.keys(journalEntries || {}).length;
      const goalsCount = (goals || []).length;
      const eventsCount = (events || []).length;
      const prefs = userProfile?.tendPreferences || {};
      
      const dashStyles = {
        overlay: {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 10000,
          padding: '2rem'
        },
        container: {
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          maxWidth: '1000px',
          width: '100%',
          maxHeight: '90vh',
          overflow: 'auto',
          padding: '2rem'
        },
        header: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '1rem'
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.5rem',
          color: 'var(--text)'
        },
        closeButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.5rem',
          color: 'var(--text-muted)',
          cursor: 'pointer'
        },
        tabs: {
          display: 'flex',
          gap: '0.5rem',
          marginBottom: '1.5rem',
          borderBottom: '1px solid var(--border)',
          paddingBottom: '0.75rem',
          flexWrap: 'wrap'
        },
        tab: (isActive) => ({
          padding: '0.5rem 1rem',
          backgroundColor: isActive ? 'var(--accent)' : 'var(--bg-elevated)',
          color: isActive ? 'white' : 'var(--text-muted)',
          border: 'none',
          borderRadius: '6px',
          cursor: 'pointer',
          fontSize: '0.8rem',
          fontWeight: isActive ? 600 : 400
        }),
        section: {
          marginBottom: '1.5rem',
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px'
        },
        sectionTitle: {
          fontSize: '1rem',
          fontWeight: 600,
          color: 'var(--text)',
          marginBottom: '0.75rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem'
        },
        grid: {
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
          gap: '0.75rem'
        },
        stat: {
          padding: '0.75rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '8px',
          textAlign: 'center'
        },
        statLabel: {
          fontSize: '0.7rem',
          color: 'var(--text-muted)',
          marginBottom: '0.25rem'
        },
        statValue: {
          fontSize: '1.25rem',
          fontWeight: 600,
          color: 'var(--accent)'
        },
        code: {
          fontFamily: 'monospace',
          fontSize: '0.75rem',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '8px',
          overflowX: 'auto',
          maxHeight: '300px',
          whiteSpace: 'pre-wrap',
          wordBreak: 'break-word'
        },
        dataSource: {
          padding: '0.75rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '8px',
          marginBottom: '0.75rem'
        },
        sourceLabel: {
          fontSize: '0.75rem',
          fontWeight: 600,
          color: 'var(--accent)',
          marginBottom: '0.5rem',
          textTransform: 'uppercase',
          letterSpacing: '0.5px'
        }
      };
      
      return (
        <div style={dashStyles.overlay} onClick={onClose}>
          <div style={dashStyles.container} onClick={(e) => e.stopPropagation()}>
            <div style={dashStyles.header}>
              <div>
                <h2 style={dashStyles.title}>üîç Data Explorer</h2>
                <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', fontFamily: 'monospace'}}>
                  User: {user?.uid?.substring(0, 8)}... | Onboarding: {onboardingCompleted ? 'Complete' : `Step ${onboardingStep}`}
                </div>
              </div>
              <button style={dashStyles.closeButton} onClick={onClose}>√ó</button>
            </div>
            
            {/* Tabs */}
            <div style={dashStyles.tabs}>
              <button style={dashStyles.tab(activeTab === 'overview')} onClick={() => setActiveTab('overview')}>üìä Overview</button>
              <button style={dashStyles.tab(activeTab === 'tendengine')} onClick={() => setActiveTab('tendengine')}>üé≤ Tend Engine</button>
              <button style={dashStyles.tab(activeTab === 'vlq')} onClick={() => setActiveTab('vlq')}>üìã VLQ Scores</button>
              <button style={dashStyles.tab(activeTab === 'lifemap')} onClick={() => setActiveTab('lifemap')}>üó∫Ô∏è Life Map</button>
              <button style={dashStyles.tab(activeTab === 'quiz')} onClick={() => setActiveTab('quiz')}>üåª Gardener Quiz</button>
              <button style={dashStyles.tab(activeTab === 'goals')} onClick={() => setActiveTab('goals')}>üéØ Goals & Habits</button>
              <button style={dashStyles.tab(activeTab === 'raw')} onClick={() => setActiveTab('raw')}>üîß Raw Data</button>
            </div>
            
            {/* Overview Tab */}
            {activeTab === 'overview' && (
              <>
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üìä Data Summary</h3>
                  <div style={dashStyles.grid}>
                    <div style={dashStyles.stat}>
                      <div style={dashStyles.statLabel}>VLQ Status</div>
                      <div style={{...dashStyles.statValue, color: vlqCompleted ? '#8FD4A0' : '#E8A090'}}>{vlqCompleted ? '‚úì' : '‚Äî'}</div>
                    </div>
                    <div style={dashStyles.stat}>
                      <div style={dashStyles.statLabel}>Life Map Items</div>
                      <div style={dashStyles.statValue}>{Object.values(prefs.structuredInfo || {}).reduce((acc, obj) => acc + Object.values(obj || {}).filter(v => v).length, 0)}</div>
                    </div>
                    <div style={dashStyles.stat}>
                      <div style={dashStyles.statLabel}>Gardener Quiz</div>
                      <div style={{...dashStyles.statValue, color: prefs.gardenerType ? '#8FD4A0' : '#E8A090'}}>{prefs.gardenerType ? '‚úì' : '‚Äî'}</div>
                    </div>
                    <div style={dashStyles.stat}>
                      <div style={dashStyles.statLabel}>Goals</div>
                      <div style={dashStyles.statValue}>{goalsCount}</div>
                    </div>
                    <div style={dashStyles.stat}>
                      <div style={dashStyles.statLabel}>Weekly Habits</div>
                      <div style={dashStyles.statValue}>{(weeklyHabits || []).length}</div>
                    </div>
                    <div style={dashStyles.stat}>
                      <div style={dashStyles.statLabel}>Journal Entries</div>
                      <div style={dashStyles.statValue}>{journalCount}</div>
                    </div>
                    <div style={dashStyles.stat}>
                      <div style={dashStyles.statLabel}>Saved Chats</div>
                      <div style={dashStyles.statValue}>{conversationCount}</div>
                    </div>
                    <div style={dashStyles.stat}>
                      <div style={dashStyles.statLabel}>Daily Tends Done</div>
                      <div style={dashStyles.statValue}>{trends?.dailyTends?.totalCompleted || 0}</div>
                    </div>
                  </div>
                </div>
                
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üå± How Tend Uses Your Data</h3>
                  <div style={{fontSize: '0.85rem', color: 'var(--text)', lineHeight: 1.6}}>
                    <p style={{marginBottom: '0.5rem', fontWeight: 500}}>For Daily Tends:</p>
                    <p style={{marginBottom: '0.75rem', paddingLeft: '1rem', color: 'var(--text-muted)'}}>
                      <strong>VLQ Scores</strong> ‚Üí Picks which life area to focus on (higher importance + bigger gap = more likely)<br/>
                      <strong>Goals</strong> (+25% AI) ‚Üí AI creates tends based on what you're working toward<br/>
                      <strong>Habits</strong> (+20% AI) ‚Üí AI references your existing routines<br/>
                      <strong>Notes</strong> (+10-20% AI) ‚Üí AI uses your context to suggest things you wouldn't think of<br/>
                      <strong>Profile Info & Names</strong> (+15% AI) ‚Üí Personalizes templates with specific people/places<br/>
                      <strong>Recent Journals</strong> (+8-15% AI) ‚Üí AI knows what's on your mind this week<br/>
                      <strong>Chat History</strong> ‚Üí Details you share in chat are saved and boost future AI %
                    </p>
                    <p style={{marginBottom: '0.5rem', fontWeight: 500}}>For Chat:</p>
                    <p style={{marginBottom: '0.75rem', paddingLeft: '1rem', color: 'var(--text-muted)'}}>
                      <strong>All of the above</strong> ‚Üí Chat knows your full context for personalized guidance<br/>
                      <strong>Gardener Type</strong> ‚Üí Sets communication tone and how Tend celebrates/supports you
                    </p>
                  </div>
                </div>
              </>
            )}
            
            {/* Tend Engine Tab */}
            {activeTab === 'tendengine' && (() => {
              // Calculate probabilities
              const baseProbabilities = vlqCompleted ? calculateDomainProbabilities(vlqScores) : {};
              
              // Get today's domain if tendies exist
              const currentDomain = todaysTendies?.[0]?.domain;
              
              // Calculate readiness for each domain (NOW WITH GOALS, HABITS, JOURNAL)
              const allReadiness = calculateAllDomainReadiness(userProfile, goals, weeklyHabits, journalEntries);
              
              return (
                <>
                  {/* Domain Selection Probabilities */}
                  <div style={dashStyles.section}>
                    <h3 style={dashStyles.sectionTitle}>üéØ Life Area Selection Probabilities</h3>
                    <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '1rem'}}>
                      Based on VLQ scores: importance √ó (1 + gap/5). Higher importance + bigger gap = higher chance of being selected.
                    </p>
                    {vlqCompleted ? (
                      <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                        {VLQ_ORDER
                          .map(domain => ({
                            domain,
                            prob: baseProbabilities[domain] || 0,
                            importance: vlqScores[domain]?.importance || 5,
                            consistency: vlqScores[domain]?.consistency || 5,
                            gap: Math.max(0, (vlqScores[domain]?.importance || 5) - (vlqScores[domain]?.consistency || 5))
                          }))
                          .sort((a, b) => b.prob - a.prob)
                          .map(({ domain, prob, importance, consistency, gap }) => (
                            <div key={domain} style={{
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '0.75rem',
                              padding: '0.5rem 0.75rem',
                              backgroundColor: domain === currentDomain ? 'var(--accent-light)' : 'var(--bg-card)',
                              borderRadius: '8px',
                              border: domain === currentDomain ? '2px solid var(--accent)' : '1px solid var(--border)'
                            }}>
                              <span style={{width: '24px'}}>{VLQ_DOMAINS[domain]?.icon}</span>
                              <span style={{flex: 1, fontSize: '0.85rem', color: 'var(--text)'}}>{VLQ_DOMAINS[domain]?.name}</span>
                              <span style={{fontSize: '0.75rem', color: 'var(--text-muted)', width: '80px'}}>
                                {importance}|{consistency} (gap:{gap})
                              </span>
                              <div style={{width: '100px', height: '8px', backgroundColor: 'var(--border)', borderRadius: '4px', overflow: 'hidden'}}>
                                <div style={{
                                  width: `${prob * 100}%`,
                                  height: '100%',
                                  backgroundColor: prob > 0.15 ? '#8FD4A0' : prob > 0.08 ? '#F9D07A' : '#E8A090',
                                  borderRadius: '4px'
                                }}/>
                              </div>
                              <span style={{fontSize: '0.8rem', fontWeight: 600, width: '45px', textAlign: 'right', color: 'var(--accent)'}}>
                                {(prob * 100).toFixed(1)}%
                              </span>
                            </div>
                          ))}
                      </div>
                    ) : (
                      <p style={{color: 'var(--text-muted)'}}>Complete VLQ to see probabilities</p>
                    )}
                    <p style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.75rem', fontStyle: 'italic'}}>
                      Note: Yesterday's domain gets 0% (no repeats). Recent domains get 20% penalty per appearance in last 7 days.
                    </p>
                  </div>
                  
                  {/* How Tends Get Generated */}
                  <div style={dashStyles.section}>
                    <h3 style={dashStyles.sectionTitle}>ü§ñ How Tends Get Generated (by Life Area)</h3>
                    
                    {/* Simple Explanation */}
                    <div style={{padding: '0.75rem', backgroundColor: 'var(--bg-card)', borderRadius: '8px', marginBottom: '1rem', fontSize: '0.8rem', color: 'var(--text-muted)'}}>
                      <div style={{display: 'flex', alignItems: 'center', gap: '1rem', flexWrap: 'wrap'}}>
                        <span><strong style={{color: '#8FD4A0'}}>ü§ñ AI %</strong> = Custom tend created from your info</span>
                        <span><strong style={{color: '#999'}}>üìã Pool %</strong> = Template from our pool</span>
                        <span><strong style={{color: '#7EB3E0'}}>‚ú®</strong> = Pool templates get personalized</span>
                      </div>
                    </div>
                    
                    {/* Per-domain breakdown */}
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '0.75rem'}}>
                      {VLQ_ORDER.map(domain => {
                        const readiness = allReadiness[domain];
                        
                        return (
                          <div key={domain} style={{
                            padding: '0.75rem',
                            backgroundColor: domain === currentDomain ? 'var(--accent-light)' : 'var(--bg-card)',
                            borderRadius: '8px',
                            border: domain === currentDomain ? '2px solid var(--accent)' : '1px solid var(--border)'
                          }}>
                            {/* Header with name and bar */}
                            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem'}}>
                              <span style={{fontSize: '1rem'}}>{VLQ_DOMAINS[domain]?.icon}</span>
                              <span style={{fontWeight: 500, fontSize: '0.85rem', minWidth: '100px'}}>{VLQ_DOMAINS[domain]?.name}</span>
                              
                              {/* Inline probability bar */}
                              <div style={{flex: 1, display: 'flex', gap: '1px', height: '18px', borderRadius: '4px', overflow: 'hidden'}}>
                                {readiness.aiPct > 0 && (
                                  <div style={{
                                    width: `${readiness.aiPct}%`, 
                                    backgroundColor: readiness.aiPct >= 50 ? '#8FD4A0' : '#B8E0C8', 
                                    display: 'flex', 
                                    alignItems: 'center', 
                                    justifyContent: 'center'
                                  }}>
                                    <span style={{fontSize: '0.6rem', fontWeight: 600}}>ü§ñ{readiness.aiPct}%</span>
                                  </div>
                                )}
                                <div style={{
                                  flex: 1, 
                                  backgroundColor: readiness.canPersonalize ? '#d4e8f0' : '#E8E0D5', 
                                  display: 'flex', 
                                  alignItems: 'center', 
                                  justifyContent: 'center'
                                }}>
                                  <span style={{fontSize: '0.6rem', fontWeight: 600}}>
                                    üìã{readiness.poolPct}%{readiness.canPersonalize ? '‚ú®' : ''}
                                  </span>
                                </div>
                              </div>
                            </div>
                            
                            {/* What we have OR what to add */}
                            {readiness.dataPoints.length > 0 ? (
                              <div style={{display: 'flex', flexWrap: 'wrap', gap: '0.4rem'}}>
                                {readiness.dataPoints.map((dp, i) => (
                                  <span key={i} style={{
                                    fontSize: '0.7rem',
                                    padding: '0.15rem 0.4rem',
                                    backgroundColor: dp.impact === 'ai' || dp.impact === 'both' ? '#e8f5e9' : '#e3f2fd',
                                    borderRadius: '4px',
                                    color: 'var(--text)'
                                  }}>
                                    {dp.icon} {dp.label} <span style={{color: '#8FD4A0', fontWeight: 600}}>{dp.boost}</span>
                                  </span>
                                ))}
                              </div>
                            ) : (
                              <div style={{fontSize: '0.7rem', color: 'var(--text-muted)'}}>
                                {readiness.missing.length > 0 && (
                                  <span>üí° {readiness.missing[0].label} ‚Üí <span style={{color: '#8FD4A0'}}>{readiness.missing[0].impact}</span></span>
                                )}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  
                  {/* Today's Tendies */}
                  {todaysTendies?.length > 0 && (
                    <div style={dashStyles.section}>
                      <h3 style={dashStyles.sectionTitle}>üìã Today's Generated Tends</h3>
                      <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                        {todaysTendies.map((tendy, idx) => {
                          // Handle all source name variants
                          const isAI = tendy.source === 'ai' || tendy.source === 'custom' || tendy.source === 'ai-generated';
                          const isPersonalized = tendy.source === 'pool+personalized' || tendy.source === 'personalized' || tendy.source === 'pool-personalized';
                          const sourceColor = isAI ? '#8FD4A0' : isPersonalized ? '#d4e8f0' : '#E8E0D5';
                          const sourceLabel = isAI ? 'ü§ñ AI' : isPersonalized ? 'üìã Pool ‚ú®' : 'üìã Pool';
                          
                          return (
                            <div key={idx} style={{
                              padding: '0.75rem',
                              backgroundColor: tendy.selected ? 'var(--accent-light)' : 'var(--bg-card)',
                              borderRadius: '8px',
                              border: tendy.selected ? '2px solid var(--accent)' : '1px solid var(--border)'
                            }}>
                              <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem'}}>
                                <span style={{
                                  fontSize: '0.7rem',
                                  padding: '0.15rem 0.4rem',
                                  borderRadius: '4px',
                                  backgroundColor: sourceColor,
                                  fontWeight: 600
                                }}>{sourceLabel}</span>
                                <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>{tendy.minutes || tendy.points} min ‚Ä¢ {tendy.type}</span>
                                {tendy.selected && <span style={{fontSize: '0.7rem', color: 'var(--accent)', fontWeight: 600}}>SELECTED</span>}
                                {tendy.completed && <span style={{fontSize: '0.7rem', color: '#8FD4A0', fontWeight: 600}}>COMPLETED</span>}
                              </div>
                              <div style={{fontSize: '0.85rem', color: 'var(--text)'}}>{tendy.text}</div>
                              {tendy.originalText && tendy.originalText !== tendy.text && (
                                <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.25rem', fontStyle: 'italic'}}>
                                  Original template: {tendy.originalText}
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  {/* Template Pools - All Life Areas */}
                  <div style={dashStyles.section}>
                    <h3 style={dashStyles.sectionTitle}>üìö Template Pools (All Life Areas)</h3>
                    <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '1rem'}}>
                      All available templates grouped by life area. Difficulty 1 = 5 min (weekday short), Difficulty 3 = 15/30/60 min (weekday long / weekend).
                    </p>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                      {VLQ_ORDER.map(domain => {
                        const templates = TENDY_TEMPLATES[domain] || [];
                        const diff1Action = templates.filter(t => t.difficulty === 1 && t.type === 'action');
                        const diff1Reflective = templates.filter(t => t.difficulty === 1 && t.type === 'reflective');
                        const diff3Action = templates.filter(t => t.difficulty === 3 && t.type === 'action');
                        const diff3Reflective = templates.filter(t => t.difficulty === 3 && t.type === 'reflective');
                        
                        return (
                          <div key={domain} style={{
                            padding: '1rem',
                            backgroundColor: domain === currentDomain ? 'var(--accent-light)' : 'var(--bg-card)',
                            borderRadius: '8px',
                            border: domain === currentDomain ? '2px solid var(--accent)' : '1px solid var(--border)'
                          }}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.75rem'}}>
                              <span style={{fontSize: '1.2rem'}}>{VLQ_DOMAINS[domain]?.icon}</span>
                              <span style={{fontWeight: 600, fontSize: '1rem'}}>{VLQ_DOMAINS[domain]?.name}</span>
                              <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>({templates.length} templates)</span>
                            </div>
                            
                            <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '1rem'}}>
                              {/* Difficulty 1 */}
                              <div>
                                <div style={{fontSize: '0.75rem', fontWeight: 600, color: 'var(--accent)', marginBottom: '0.5rem'}}>
                                  5 min (Quick)
                                </div>
                                {diff1Action.length > 0 && (
                                  <div style={{marginBottom: '0.5rem'}}>
                                    <div style={{fontSize: '0.65rem', color: 'var(--text-muted)', textTransform: 'uppercase'}}>Action ({diff1Action.length})</div>
                                    {diff1Action.map((t, i) => (
                                      <div key={i} style={{fontSize: '0.75rem', color: 'var(--text)', padding: '0.2rem 0', borderBottom: '1px solid var(--border)'}}>
                                        ‚Ä¢ {t.text}
                                      </div>
                                    ))}
                                  </div>
                                )}
                                {diff1Reflective.length > 0 && (
                                  <div>
                                    <div style={{fontSize: '0.65rem', color: 'var(--text-muted)', textTransform: 'uppercase'}}>Reflective ({diff1Reflective.length})</div>
                                    {diff1Reflective.map((t, i) => (
                                      <div key={i} style={{fontSize: '0.75rem', color: 'var(--text)', padding: '0.2rem 0', borderBottom: '1px solid var(--border)'}}>
                                        ‚Ä¢ {t.text}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                              
                              {/* Difficulty 3 */}
                              <div>
                                <div style={{fontSize: '0.75rem', fontWeight: 600, color: 'var(--accent)', marginBottom: '0.5rem'}}>
                                  15-60 min (Deep)
                                </div>
                                {diff3Action.length > 0 && (
                                  <div style={{marginBottom: '0.5rem'}}>
                                    <div style={{fontSize: '0.65rem', color: 'var(--text-muted)', textTransform: 'uppercase'}}>Action ({diff3Action.length})</div>
                                    {diff3Action.map((t, i) => (
                                      <div key={i} style={{fontSize: '0.75rem', color: 'var(--text)', padding: '0.2rem 0', borderBottom: '1px solid var(--border)'}}>
                                        ‚Ä¢ {t.text}
                                      </div>
                                    ))}
                                  </div>
                                )}
                                {diff3Reflective.length > 0 && (
                                  <div>
                                    <div style={{fontSize: '0.65rem', color: 'var(--text-muted)', textTransform: 'uppercase'}}>Reflective ({diff3Reflective.length})</div>
                                    {diff3Reflective.map((t, i) => (
                                      <div key={i} style={{fontSize: '0.75rem', color: 'var(--text)', padding: '0.2rem 0', borderBottom: '1px solid var(--border)'}}>
                                        ‚Ä¢ {t.text}
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  
                  {/* Gathered Context */}
                  <div style={dashStyles.section}>
                    <h3 style={dashStyles.sectionTitle}>üß† Gathered Context (influences personalization)</h3>
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '1rem'}}>
                      {/* Life Area Notes */}
                      <div>
                        <h4 style={{fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem'}}>Life Area Notes</h4>
                        {Object.entries(prefs.lifeAreaNotes || {}).filter(([_, v]) => v).length > 0 ? (
                          Object.entries(prefs.lifeAreaNotes || {}).filter(([_, v]) => v).map(([area, note]) => (
                            <div key={area} style={{fontSize: '0.8rem', marginBottom: '0.5rem', padding: '0.5rem', backgroundColor: 'var(--bg-card)', borderRadius: '6px'}}>
                              <strong>{VLQ_DOMAINS[area]?.name}:</strong> {note.substring(0, 100)}{note.length > 100 ? '...' : ''}
                            </div>
                          ))
                        ) : (
                          <p style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>None yet</p>
                        )}
                      </div>
                      
                      {/* Preferences */}
                      <div>
                        <h4 style={{fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem'}}>Preferences</h4>
                        {(prefs.preferences || []).length > 0 ? (
                          (prefs.preferences || []).map((p, i) => (
                            <div key={i} style={{fontSize: '0.8rem', marginBottom: '0.25rem'}}>‚Ä¢ {p}</div>
                          ))
                        ) : (
                          <p style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>None yet</p>
                        )}
                      </div>
                      
                      {/* Resources */}
                      <div>
                        <h4 style={{fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem'}}>Resources</h4>
                        {(prefs.resources || []).length > 0 ? (
                          (prefs.resources || []).map((r, i) => (
                            <div key={i} style={{fontSize: '0.8rem', marginBottom: '0.25rem'}}>‚Ä¢ {r}</div>
                          ))
                        ) : (
                          <p style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>None yet</p>
                        )}
                      </div>
                      
                      {/* Context Items */}
                      <div>
                        <h4 style={{fontSize: '0.85rem', fontWeight: 600, marginBottom: '0.5rem'}}>Context Items</h4>
                        {Object.entries(prefs.context || {}).filter(([_, v]) => v).length > 0 ? (
                          Object.entries(prefs.context || {}).filter(([_, v]) => v).slice(0, 8).map(([key, val]) => (
                            <div key={key} style={{fontSize: '0.8rem', marginBottom: '0.25rem'}}>
                              <strong>{key.replace(/_/g, ' ')}:</strong> {val}
                            </div>
                          ))
                        ) : (
                          <p style={{fontSize: '0.8rem', color: 'var(--text-muted)'}}>None yet</p>
                        )}
                      </div>
                    </div>
                  </div>
                </>
              );
            })()}
            
            {/* VLQ Tab */}
            {activeTab === 'vlq' && (
              <div style={dashStyles.section}>
                <h3 style={dashStyles.sectionTitle}>üìã Values-Life Questionnaire Scores</h3>
                {vlqCompleted && vlqScores ? (
                  <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                    {VLQ_ORDER.map(domain => {
                      const score = vlqScores[domain];
                      const area = VLQ_DOMAINS[domain];
                      return (
                        <div key={domain} style={{display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.5rem', backgroundColor: 'var(--bg-card)', borderRadius: '6px'}}>
                          <span style={{fontSize: '1.1rem'}}>{area?.icon}</span>
                          <span style={{flex: 1, fontSize: '0.85rem', color: 'var(--text)'}}>{area?.name}</span>
                          <div style={{display: 'flex', gap: '0.5rem', alignItems: 'center'}}>
                            <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>Importance:</span>
                            <span style={{fontWeight: 600, color: score?.importance >= 7 ? 'var(--accent)' : 'var(--text)'}}>{score?.importance || '‚Äî'}</span>
                            <span style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginLeft: '0.5rem'}}>Consistency:</span>
                            <span style={{fontWeight: 600, color: score?.consistency >= 7 ? 'var(--accent)' : 'var(--text)'}}>{score?.consistency || '‚Äî'}</span>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <p style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>VLQ not completed yet</p>
                )}
              </div>
            )}
            
            {/* Life Map Tab */}
            {activeTab === 'lifemap' && (
              <div style={dashStyles.section}>
                <h3 style={dashStyles.sectionTitle}>üó∫Ô∏è Life Map Data (from prompts)</h3>
                {Object.keys(prefs.structuredInfo || {}).length > 0 ? (
                  <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                    {VLQ_ORDER.map(domain => {
                      const info = prefs.structuredInfo?.[domain] || {};
                      const filledEntries = Object.entries(info).filter(([k, v]) => v);
                      const notes = prefs.lifeAreaNotes?.[domain];
                      if (filledEntries.length === 0 && !notes) return null;
                      return (
                        <div key={domain} style={dashStyles.dataSource}>
                          <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem'}}>
                            <span>{VLQ_DOMAINS[domain]?.icon}</span>
                            <span style={{fontWeight: 600, color: 'var(--text)'}}>{VLQ_DOMAINS[domain]?.name}</span>
                          </div>
                          {filledEntries.map(([key, value]) => (
                            <div key={key} style={{fontSize: '0.8rem', marginBottom: '0.25rem', paddingLeft: '1.5rem'}}>
                              <span style={{color: 'var(--text-muted)'}}>{key}:</span> <span style={{color: 'var(--text)'}}>{value}</span>
                            </div>
                          ))}
                          {notes && (
                            <div style={{fontSize: '0.8rem', paddingLeft: '1.5rem', fontStyle: 'italic', color: 'var(--text-muted)'}}>
                              Notes: {notes}
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <p style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>No Life Map data yet</p>
                )}
              </div>
            )}
            
            {/* Gardener Quiz Tab */}
            {activeTab === 'quiz' && (
              <>
                <div style={{padding: '0.75rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '8px', marginBottom: '1rem', fontSize: '0.8rem', color: 'var(--text-muted)', lineHeight: 1.5}}>
                  Everything on this tab comes from the <strong style={{color: 'var(--text)'}}>Gardener Quiz</strong>. The quiz captures your personality traits and generates your gardener type + tending style preferences that personalize how Tend communicates with you.
                </div>
                
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üåª Your Gardener Type</h3>
                  {prefs.gardenerType ? (
                    <div style={{padding: '1rem', backgroundColor: `${prefs.gardenerType.color}15`, borderRadius: '10px', border: `1px solid ${prefs.gardenerType.color}30`}}>
                      <div style={{display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.75rem'}}>
                        <span style={{fontSize: '2rem'}}>{prefs.gardenerType.emoji}</span>
                        <div>
                          <div style={{fontWeight: 600, fontSize: '1.1rem', color: 'var(--text)'}}>{prefs.gardenerType.name}</div>
                          <div style={{fontSize: '0.8rem', color: prefs.gardenerType.color}}>{prefs.gardenerType.strength}</div>
                        </div>
                      </div>
                      <p style={{fontSize: '0.85rem', color: 'var(--text)', lineHeight: 1.5, marginBottom: '0.75rem'}}>{prefs.gardenerType.description}</p>
                    </div>
                  ) : (
                    <p style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>Quiz not completed yet</p>
                  )}
                </div>
                
                {prefs.gardenerType?.tendingStyle && (
                  <div style={dashStyles.section}>
                    <h3 style={dashStyles.sectionTitle}>‚öôÔ∏è Your Tending Style <span style={{fontSize: '0.75rem', fontWeight: 400, color: 'var(--text-muted)'}}>(from quiz)</span></h3>
                    <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem'}}>These preferences tell Tend how to communicate with you:</p>
                    <div style={dashStyles.grid}>
                      {Object.entries(prefs.gardenerType.tendingStyle).map(([key, value]) => (
                        <div key={key} style={dashStyles.stat}>
                          <div style={dashStyles.statLabel}>{key.replace(/([A-Z])/g, ' $1').trim()}</div>
                          <div style={{fontSize: '0.9rem', fontWeight: 600, color: 'var(--text)'}}>{value}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
                
                {prefs.gardenerType?.traits && (
                  <div style={dashStyles.section}>
                    <h3 style={dashStyles.sectionTitle}>üß¨ Your Quiz Answers <span style={{fontSize: '0.75rem', fontWeight: 400, color: 'var(--text-muted)'}}>(raw traits)</span></h3>
                    <p style={{fontSize: '0.8rem', color: 'var(--text-muted)', marginBottom: '0.75rem'}}>The personality traits captured from your quiz responses:</p>
                    <div style={dashStyles.grid}>
                      {Object.entries(prefs.gardenerType.traits).map(([key, value]) => (
                        <div key={key} style={dashStyles.stat}>
                          <div style={dashStyles.statLabel}>{key}</div>
                          <div style={{fontSize: '0.85rem', fontWeight: 500, color: 'var(--text)'}}>{value}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </>
            )}
            
            {/* Goals & Habits Tab */}
            {activeTab === 'goals' && (
              <>
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üéØ Goals ({goalsCount})</h3>
                  {goalsCount > 0 ? (
                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                      {(goals || []).map(goal => (
                        <div key={goal.id} style={{padding: '0.5rem 0.75rem', backgroundColor: 'var(--bg-card)', borderRadius: '6px', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                          <span>{VLQ_DOMAINS[goal.lifeArea]?.icon || 'üéØ'}</span>
                          <span style={{flex: 1, fontSize: '0.85rem', color: 'var(--text)'}}>{goal.text}</span>
                          {goal.completed && <span style={{color: '#8FD4A0'}}>‚úì</span>}
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>No goals set yet</p>
                  )}
                </div>
                
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üîÑ Weekly Habits ({(weeklyHabits || []).length})</h3>
                  {(weeklyHabits || []).length > 0 ? (
                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.5rem'}}>
                      {(weeklyHabits || []).map(habit => {
                        const linkedGoal = (goals || []).find(g => g.id === habit.goalId);
                        return (
                          <div key={habit.id} style={{padding: '0.5rem 0.75rem', backgroundColor: 'var(--bg-card)', borderRadius: '6px'}}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                              <span>{VLQ_DOMAINS[habit.lifeArea]?.icon || 'üîÑ'}</span>
                              <span style={{flex: 1, fontSize: '0.85rem', color: 'var(--text)'}}>{habit.text}</span>
                              <span style={{fontSize: '0.75rem', color: 'var(--text-muted)'}}>{habit.frequency}x/wk</span>
                            </div>
                            {linkedGoal && (
                              <div style={{fontSize: '0.75rem', color: 'var(--text-muted)', paddingLeft: '1.5rem', marginTop: '0.25rem'}}>
                                ‚Ü≥ Linked to: {linkedGoal.text}
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <p style={{color: 'var(--text-muted)', fontSize: '0.85rem'}}>No habits set yet</p>
                  )}
                </div>
              </>
            )}
            
            {/* Raw Data Tab */}
            {activeTab === 'raw' && (
              <>
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üìã VLQ Data</h3>
                  <div style={{marginBottom: '0.5rem', fontSize: '0.8rem', color: 'var(--text-muted)'}}>
                    vlqCompleted: <strong style={{color: vlqCompleted ? '#8FD4A0' : '#E8A090'}}>{String(vlqCompleted)}</strong>
                  </div>
                  <pre style={dashStyles.code}>{JSON.stringify(vlqScores, null, 2)}</pre>
                </div>
                
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üîß Full userProfile.tendPreferences</h3>
                  <pre style={dashStyles.code}>{JSON.stringify(prefs, null, 2)}</pre>
                </div>
                
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üìà Calculated Trends</h3>
                  <pre style={dashStyles.code}>{JSON.stringify(trends, null, 2)}</pre>
                </div>
                
                <div style={dashStyles.section}>
                  <h3 style={dashStyles.sectionTitle}>üí¨ Current Chat History ({(chatHistory || []).length} messages)</h3>
                  <pre style={dashStyles.code}>{JSON.stringify(chatHistory?.slice(-10), null, 2)}</pre>
                  {(chatHistory || []).length > 10 && <p style={{fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem'}}>Showing last 10 of {chatHistory.length} messages</p>}
                </div>
              </>
            )}
          </div>
        </div>
      );
    }
    // ============ INSIGHTS VIEW (USER-FACING TRENDS) ============
    // Structured prompts for each life area - used in profile section
    const LIFE_AREA_PROMPTS = {
      family: {
        title: 'Family',
        why: 'Help me personalize family-related tends',
        example: '"Call your mom Sarah" instead of "Call a family member"',
        prompts: [
          { key: 'members', label: 'Family members you connect with', placeholder: 'e.g., Mom (Sarah), Sister (Amy), Dad' },
          { key: 'frequency', label: 'How often do you typically connect?', placeholder: 'e.g., Call mom weekly, text sister daily' },
        ]
      },
      partner: {
        title: 'Partner/Relationship',
        why: 'Help me suggest meaningful connection activities',
        example: '"Plan a date with Sarah" instead of "Spend quality time"',
        prompts: [
          { key: 'name', label: "Partner's name", placeholder: 'e.g., Sarah' },
          { key: 'activities', label: 'Things you enjoy doing together', placeholder: 'e.g., cooking, hiking, movie nights' },
        ]
      },
      friendships: {
        title: 'Friendships',
        why: 'Help me remind you to nurture friendships',
        example: '"Text your friend Mike" instead of "Reach out to a friend"',
        prompts: [
          { key: 'closeFriends', label: 'Close friends you want to stay connected with', placeholder: 'e.g., Mike, Jessica, the book club group' },
          { key: 'socialPrefs', label: 'How you prefer to connect', placeholder: 'e.g., prefer calls over texts, love group dinners' },
        ]
      },
      career: {
        title: 'Career & Work',
        why: 'Help me understand your work context',
        example: '"Work on Tend for 30 min" instead of "Work on a project"',
        prompts: [
          { key: 'situation', label: 'Your work situation', placeholder: 'e.g., Software engineer, work from home' },
          { key: 'projects', label: 'Current projects or focus areas', placeholder: 'e.g., Building Tend app, Q1 planning' },
        ]
      },
      education: {
        title: 'Learning & Growth',
        why: 'Help me suggest relevant learning activities',
        example: '"Practice guitar for 10 min" instead of "Learn something new"',
        prompts: [
          { key: 'learning', label: 'What are you currently learning?', placeholder: 'e.g., Guitar, Spanish, cooking' },
          { key: 'resources', label: 'Resources you use', placeholder: 'e.g., Duolingo, YouTube tutorials, local class' },
        ]
      },
      recreation: {
        title: 'Recreation & Fun',
        why: 'Help me suggest activities you actually enjoy',
        example: '"Play a round of chess" instead of "Do something fun"',
        prompts: [
          { key: 'hobbies', label: 'Hobbies and interests', placeholder: 'e.g., Chess, reading, gardening, video games' },
          { key: 'resources', label: 'Things you have access to', placeholder: 'e.g., Chess.com account, Kindle, garden' },
        ]
      },
      spirituality: {
        title: 'Spirituality & Meaning',
        why: 'Help me respect your spiritual practice',
        example: '"10 min meditation with Headspace" instead of "Practice mindfulness"',
        prompts: [
          { key: 'practices', label: 'Spiritual or mindfulness practices', placeholder: 'e.g., Meditation, prayer, journaling, yoga' },
          { key: 'resources', label: 'Apps or resources you use', placeholder: 'e.g., Headspace, local temple, meditation group' },
        ]
      },
      community: {
        title: 'Community & Contribution',
        why: 'Help me suggest ways to contribute',
        example: '"Volunteer at the food bank" instead of "Help your community"',
        prompts: [
          { key: 'involvement', label: 'How are you involved in your community?', placeholder: 'e.g., Food bank volunteer, neighborhood association' },
          { key: 'causes', label: 'Causes you care about', placeholder: 'e.g., Environment, education, homelessness' },
        ]
      },
      health: {
        title: 'Physical Health',
        why: 'Help me suggest realistic health activities',
        example: '"Go to your yoga class" instead of "Exercise"',
        prompts: [
          { key: 'activities', label: 'Exercise or health activities you do', placeholder: 'e.g., Yoga, running, gym workouts' },
          { key: 'resources', label: 'Resources you have', placeholder: 'e.g., Gym membership, Peloton, running shoes' },
        ]
      },
      mentalHealth: {
        title: 'Mental & Emotional Health',
        why: 'Help me support your wellbeing',
        example: '"Journal about your day" instead of "Practice self-care"',
        prompts: [
          { key: 'practices', label: 'Self-care practices that help you', placeholder: 'e.g., Journaling, therapy, baths, walks' },
          { key: 'boundaries', label: 'Boundaries or needs', placeholder: 'e.g., Need alone time, avoid work after 7pm' },
        ]
      },
    };

    function InsightsView({ trends, vlqScores, flexPoints, userProfile, setUserProfile, goals = [], setGoals, weeklyHabits = [], setWeeklyHabits, onReassessVLQ, onAddGoal, onBack, apiKey, embedded = false, autoExpandSection = null, onQuizComplete = null, onLifeMapAnswer = null, focusedArea = null, onFocusedAreaChange = null, onboardingStep = null, onboardingCompleted = false, hideLifeMap = false }) {
      const [expandedArea, setExpandedArea] = useState(autoExpandSection || focusedArea);
      const [editingArea, setEditingArea] = useState(null);
      const [tempFormData, setTempFormData] = useState(autoExpandSection === 'quiz' ? { quizStep: 0, quizAnswers: {}, isGenerating: false, generatedResult: null } : {});
      const [tempNotes, setTempNotes] = useState('');
      const [lastScrolledArea, setLastScrolledArea] = useState(null);
      const [hoveredNode, setHoveredNode] = useState(null); // { domain, goals, habits, x, y }
      const [hoveredLine, setHoveredLine] = useState(null); // { question, answer, x, y }
      
      // Auto-expand and scroll to focusedArea whenever it changes (including initial set)
      React.useEffect(() => {
        if (focusedArea && focusedArea !== 'quiz' && focusedArea !== lastScrolledArea) {
          console.log('Auto-expanding and scrolling to:', focusedArea);
          setExpandedArea(focusedArea);
          setLastScrolledArea(focusedArea);
          setTimeout(() => {
            const element = document.getElementById(`life-area-${focusedArea}`);
            if (element) {
              element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 300);
        }
      }, [focusedArea, lastScrolledArea]);
      
      // Also handle autoExpandSection on mount
      React.useEffect(() => {
        if (autoExpandSection && autoExpandSection !== 'quiz' && !focusedArea && !lastScrolledArea) {
          setExpandedArea(autoExpandSection);
          setLastScrolledArea(autoExpandSection);
          setTimeout(() => {
            const element = document.getElementById(`life-area-${autoExpandSection}`);
            if (element) {
              element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 300);
        }
        
        // Handle quiz auto-scroll
        if (autoExpandSection === 'quiz') {
          setTimeout(() => {
            const quizElement = document.getElementById('gardener-quiz-section');
            if (quizElement) {
              quizElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 300);
        }
      }, [autoExpandSection]);
      
      // Notify parent when expanded area changes
      const handleExpandArea = (area) => {
        const newArea = expandedArea === area ? null : area;
        setExpandedArea(newArea);
        if (onFocusedAreaChange) onFocusedAreaChange(newArea);
      };
      
      if (!trends) return null;
      
      const insightsStyles = {
        container: {
          minHeight: embedded ? '100%' : '100vh',
          backgroundColor: 'var(--bg-main)',
          display: 'flex',
          flexDirection: 'column',
          height: embedded ? '100%' : 'auto',
          overflow: embedded ? 'visible' : 'visible',
          flex: embedded ? 1 : 'auto',
          width: '100%',
        },
        header: {
          padding: '1rem 2rem',
          borderBottom: '1px solid var(--border)',
          backgroundColor: 'var(--bg-card)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        },
        headerLeft: {
          display: 'flex',
          alignItems: 'center',
          gap: '1rem',
        },
        backButton: {
          background: 'none',
          border: 'none',
          fontSize: '1.25rem',
          color: 'var(--text-muted)',
          cursor: 'pointer',
          padding: '0.25rem',
        },
        title: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.25rem',
          color: 'var(--text)',
        },
        content: {
          flex: 1,
          padding: '0.5rem 1rem',
          maxWidth: '800px',
          margin: '0 auto',
          width: '100%',
        },
        section: {
          marginBottom: '1rem',
          padding: '1rem',
          backgroundColor: 'var(--bg-card)',
          borderRadius: '16px',
          border: '1px solid var(--border)',
        },
        sectionTitle: {
          fontFamily: "'Fraunces', serif",
          fontSize: '1.1rem',
          color: 'var(--text)',
          marginBottom: '0.75rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem',
        },
        statsGrid: {
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
          gap: '1rem',
        },
        statCard: {
          padding: '1rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '12px',
          textAlign: 'center',
        },
        statValue: {
          fontSize: '2rem',
          fontWeight: 600,
          color: 'var(--accent)',
          marginBottom: '0.25rem',
        },
        statLabel: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
        },
        areaItem: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          padding: '0.75rem',
          backgroundColor: 'var(--bg-elevated)',
          borderRadius: '8px',
          marginBottom: '0.5rem',
        },
        areaName: {
          fontSize: '0.85rem',
          color: 'var(--text)',
        },
        areaStats: {
          fontSize: '0.75rem',
          color: 'var(--text-muted)',
        },
        completionRate: {
          fontSize: '0.9rem',
          fontWeight: 600,
          color: 'var(--accent)',
        },
      };
      
      // Calculate top 3 life areas by completion rate
      const topAreas = Object.entries(trends.dailyTends.byLifeArea)
        .filter(([_, stats]) => stats.completed + stats.skipped > 0)
        .sort((a, b) => b[1].completionRate - a[1].completionRate)
        .slice(0, 3);
      
      return (
        <div style={insightsStyles.container}>
          {!embedded && (
            <div style={insightsStyles.header}>
              <div style={insightsStyles.headerLeft}>
                <button style={insightsStyles.backButton} onClick={onBack} title="Back">
                  ‚Üê
                </button>
                <h2 style={insightsStyles.title}>Your Insights</h2>
              </div>
            </div>
          )}
          
          <div style={insightsStyles.content}>
{/* Your Life Map - Visual Knowledge Graph - Hidden when taking quiz or when hideLifeMap is true */}
            {!hideLifeMap && expandedArea !== 'quiz' && (
            <div style={{...insightsStyles.section, padding: 0, border: 'none', backgroundColor: 'transparent'}}>
              
              {/* Visual Knowledge Graph */}
              {(() => {
                const prefs = userProfile?.tendPreferences || {};
                
                // Count goals per domain
                const domainGoalCounts = {};
                VLQ_ORDER.forEach(d => domainGoalCounts[d] = 0);
                goals.forEach(g => {
                  if (g.lifeArea && domainGoalCounts[g.lifeArea] !== undefined) {
                    domainGoalCounts[g.lifeArea]++;
                  }
                });
                
                // Count habits per domain
                const domainHabitCounts = {};
                VLQ_ORDER.forEach(d => domainHabitCounts[d] = 0);
                weeklyHabits.forEach(h => {
                  if (h.lifeArea && domainHabitCounts[h.lifeArea] !== undefined) {
                    domainHabitCounts[h.lifeArea]++;
                  }
                });
                
                // Collect all facts (prompt answers) from profile with question info
                const allFacts = [];
                const domainFactCounts = {};
                VLQ_ORDER.forEach(d => domainFactCounts[d] = 0);
                
                // Discovery questions lookup for displaying in tooltip
                const discoveryQsLookup = {
                  family: { closeTo: "Who are you closest to?", tradition: "What's a tradition you cherish?", values: "What family values matter most?", time: "How do you spend time together?", grateful: "What are you grateful for about your family?", improve: "What would you like to improve?", history: "What family history shapes you?", support: "How does your family support you?", challenge: "What's challenging right now?", celebrate: "How do you celebrate together?", communicate: "How do you stay connected?", boundaries: "What boundaries matter with family?", roles: "What role do you play in your family?", future: "What do you hope for your family's future?", learn: "What have you learned from family?", miss: "What do you miss about family?", proud: "What makes you proud of your family?", conflict: "How do you handle family conflict?", memories: "What's a favorite family memory?", wish: "What do you wish family knew about you?" },
                  partner: { name: "What's their name?", together: "What do you love doing together?", goals: "What are you building together?", appreciate: "What do you appreciate about them?", met: "How did you meet?", love: "What made you fall in love?", challenge: "What do you work on together?", dream: "What's a shared dream?", support: "How do they support you?", language: "What's their love language?", laugh: "What makes you both laugh?", grow: "How have you grown together?", date: "What's your ideal date?", strength: "What's your relationship's strength?", ritual: "Do you have any rituals together?", navigate: "How do you navigate disagreements?", admire: "What do you admire about them?", team: "How do you work as a team?", future: "What excites you about your future together?", grateful: "What are you most grateful for?" },
                  friendships: { crew: "Who's in your inner circle?", hangout: "How do you like to connect?", support: "How do friends support you?", new: "How do you make new friends?", long: "Who's your longest friendship?", miss: "Which friends do you miss?", give: "What do you bring to friendships?", need: "What do you need from friends?", maintain: "How do you maintain friendships?", challenge: "What's challenging about friendships now?", group: "Do you have a friend group?", one: "Describe a friendship that shaped you", conflict: "How do you handle conflict with friends?", celebrate: "How do you celebrate friends?", boundaries: "What boundaries matter in friendships?", grow: "How have your friendships evolved?", want: "What kind of friends do you want more of?", hard: "Have you had a hard friendship ending?", fun: "What's the most fun with friends?", grateful: "What are you grateful for in your friendships?" },
                  career: { role: "What do you do?", focus: "What's energizing you right now?", growth: "Where do you want to grow?", purpose: "What gives your work meaning?", proud: "What are you most proud of professionally?", dream: "What's your dream role or project?", challenge: "What's your biggest work challenge?", balance: "How's your work-life balance?", team: "Who do you work with?", learn: "What are you learning at work?", environment: "What work environment suits you?", values: "What values matter in your work?", stress: "What stresses you about work?", success: "How do you define career success?", mentor: "Who has mentored you?", risk: "What career risk would you take?", five: "Where do you see yourself in 5 years?", strength: "What's your professional superpower?", change: "What would you change about your work?", passion: "What work would you do for free?" },
                  education: { learning: "What are you learning?", curious: "What makes you curious?", skills: "What skills do you want to develop?", resources: "How do you like to learn?", goal: "What's a learning goal?", obstacle: "What stops you from learning more?", teacher: "Who has taught you the most?", proud: "What have you taught yourself?", formal: "Any formal education plans?", topic: "What topic could you talk about for hours?", mistake: "What have you learned from mistakes?", child: "What did you love learning as a child?", share: "What knowledge do you want to share?", book: "What book changed your thinking?", skill: "What skill do you wish you had?", practice: "How do you practice what you learn?", community: "Do you learn with others?", stuck: "What do you do when stuck on something?", surprise: "What surprised you while learning something?", next: "What's next on your learning list?" },
                  recreation: { fun: "What's fun for you?", loseTrack: "What makes you lose track of time?", try: "What do you want to try?", recharge: "How does play recharge you?", childhood: "What did you love doing as a kid?", weekend: "What's your ideal weekend?", solo: "What do you enjoy doing alone?", social: "What do you enjoy with others?", creative: "Do you have a creative outlet?", active: "What active hobbies do you enjoy?", relax: "How do you truly relax?", bucket: "What's on your bucket list?", dropped: "Any hobbies you've dropped?", season: "What's your favorite seasonal activity?", money: "If money was no object, what would you do for fun?", guilty: "What's a guilty pleasure?", share: "What hobby do you want to share with others?", obstacle: "What stops you from having more fun?", plan: "Do you plan fun or let it happen?", joy: "What brings you pure joy?" },
                  spirituality: { peace: "What brings you peace?", believe: "What do you believe in?", practice: "Do you have a spiritual practice?", meaning: "What gives life meaning?", wonder: "What fills you with wonder?", tradition: "Any spiritual traditions you follow?", question: "What big questions do you ponder?", connect: "How do you connect to something bigger?", values: "What values guide your life?", growth: "How has your spirituality evolved?", ritual: "Do you have any personal rituals?", nature: "How does nature affect you spiritually?", community: "Do you have a spiritual community?", challenge: "What challenges your beliefs?", comfort: "What comforts you in hard times?", gratitude: "What are you grateful for?", death: "How do you think about mortality?", sacred: "What do you consider sacred?", teacher: "Who or what has been a spiritual teacher?", hope: "What gives you hope?" },
                  community: { belong: "Where do you feel you belong?", give: "How do you like to give back?", causes: "What causes matter to you?", connect: "How do you connect to community?", role: "What role do you play in your community?", local: "How engaged are you locally?", online: "Any online communities you're part of?", impact: "What impact do you want to make?", time: "How much time do you give to community?", money: "What causes do you support financially?", skill: "What skills could you offer?", barrier: "What stops you from being more involved?", inspired: "Who inspires you in community work?", change: "What would you change in your community?", tradition: "Any community traditions you love?", new: "What communities would you like to join?", receive: "What have you received from community?", voice: "How do you use your voice?", bridge: "Do you bridge different communities?", legacy: "What community legacy do you want to leave?" },
                  health: { move: "How do you like to move?", fuel: "What makes your body feel good?", sleep: "How's your sleep?", energy: "What gives you energy?", goal: "What's a health goal?", challenge: "What's your biggest health challenge?", routine: "Describe your morning routine", habit: "What healthy habit are you building?", break: "What unhealthy habit do you want to break?", body: "How's your relationship with your body?", checkup: "How do you stay on top of health?", stress: "How does stress affect your health?", water: "How's your hydration?", food: "What's your relationship with food?", rest: "How do you rest and recover?", nature: "Do you spend time outdoors?", support: "Who supports your health journey?", age: "How do you think about aging?", best: "When do you feel your best physically?", invest: "How do you invest in your health?" },
                  mentalHealth: { recharge: "How do you recharge?", boundaries: "What boundaries matter to you?", support: "What supports your mental health?", stress: "How do you handle stress?", anxious: "What makes you anxious?", calm: "What calms you down?", mood: "How do you track your mood?", therapy: "Have you tried therapy?", medication: "Any thoughts on medication?", trigger: "What triggers difficult emotions?", cope: "What are your go-to coping strategies?", talk: "Who can you talk to about hard things?", self: "How's your self-talk?", down: "What do you do when you're feeling down?", growth: "How has your mental health journey evolved?", stigma: "How do you feel about mental health stigma?", routine: "Do you have mental health routines?", warning: "What are your warning signs?", joy: "What brings you genuine joy?", proud: "What mental health progress are you proud of?" },
                };
                
                // Check for multi-domain facts (stored as comma-separated domains)
                const multiDomainFacts = prefs.multiDomainFacts || [];
                
                VLQ_ORDER.forEach(domain => {
                  const color = VLQ_DOMAINS[domain]?.color || '#888';
                  const structured = prefs.structuredInfo?.[domain] || {};
                  const notes = prefs.lifeAreaNotes?.[domain];
                  const domainQs = discoveryQsLookup[domain] || {};
                  const storedQuestions = prefs.promptQuestions?.[domain] || {};
                  
                  Object.entries(structured).forEach(([key, value]) => {
                    if (value) {
                      // Check stored questions first (for AI-generated), then lookup, then use key
                      const question = storedQuestions[key] || domainQs[key] || key;
                      allFacts.push({ domain, domains: [domain], text: value, question, key, color, type: 'structured' });
                      domainFactCounts[domain]++;
                    }
                  });
                  
                  if (notes) {
                    allFacts.push({ domain, domains: [domain], text: notes, question: 'Notes', key: 'notes', color, type: 'notes' });
                    domainFactCounts[domain]++;
                  }
                });
                
                // Add multi-domain facts
                multiDomainFacts.forEach(fact => {
                  if (fact.domains && fact.domains.length > 0 && fact.text) {
                    const primaryDomain = fact.domains[0];
                    allFacts.push({
                      domain: primaryDomain,
                      domains: fact.domains,
                      text: fact.text,
                      color: VLQ_DOMAINS[primaryDomain]?.color || '#888',
                      type: 'multi'
                    });
                    fact.domains.forEach(d => domainFactCounts[d]++);
                  }
                });
                
                // Calculate icon scale based on GOALS count (1.0 to 1.6)
                const maxGoals = Math.max(...Object.values(domainGoalCounts), 1);
                const getIconScale = (domain) => {
                  const count = domainGoalCounts[domain] || 0;
                  if (count === 0) return 1.0;
                  return 1.0 + (count / maxGoals) * 0.6; // Scale from 1.0 to 1.6
                };
                
                // Cleaner SVG layout - wider to prevent overlap
                const width = 400;
                const height = 280;
                const centerX = width / 2;
                const centerY = height / 2;
                
                // Life area icons - positioned in a wider ellipse, with growing sizes based on goals
                const categoryNodes = VLQ_ORDER.map((domain, i) => {
                  const angle = (i / VLQ_ORDER.length) * Math.PI * 2 - Math.PI / 2;
                  const hasContent = prefs.structuredInfo?.[domain] || prefs.lifeAreaNotes?.[domain];
                  const factCount = domainFactCounts[domain] || 0;
                  const goalCount = domainGoalCounts[domain] || 0;
                  const habitCount = domainHabitCounts[domain] || 0;
                  const scale = getIconScale(domain);
                  return {
                    domain,
                    icon: VLQ_DOMAINS[domain]?.icon,
                    color: VLQ_DOMAINS[domain]?.color,
                    x: centerX + Math.cos(angle) * 160,
                    y: centerY + Math.sin(angle) * 100,
                    hasContent: !!hasContent,
                    factCount,
                    goalCount,
                    habitCount,
                    scale,
                    baseRadius: 20,
                  };
                });
                
                // Create lines from center to each icon for each prompt answer
                const promptLines = [];
                allFacts.forEach((fact, idx) => {
                  const node = categoryNodes.find(n => n.domain === fact.domain);
                  if (node) {
                    // Offset lines slightly so multiple don't overlap completely
                    const offsetAngle = (idx * 0.15);
                    promptLines.push({
                      node,
                      fact,
                      offsetX: Math.cos(offsetAngle) * 3,
                      offsetY: Math.sin(offsetAngle) * 3,
                    });
                  }
                });
                
                // Find multi-domain connections (facts that link multiple areas)
                const connections = [];
                allFacts.filter(f => f.domains && f.domains.length > 1).forEach(fact => {
                  const domainNodes = fact.domains.map(d => categoryNodes.find(n => n.domain === d)).filter(Boolean);
                  for (let i = 0; i < domainNodes.length; i++) {
                    for (let j = i + 1; j < domainNodes.length; j++) {
                      connections.push({
                        from: domainNodes[i],
                        to: domainNodes[j],
                        color: fact.color,
                        text: fact.text
                      });
                    }
                  }
                });
                
                return (
                  <div>
                    {/* The Constellation - sticky when scrolling */}
                    <div style={{
                      position: 'sticky',
                      top: 0,
                      zIndex: 50,
                      background: 'linear-gradient(180deg, #FDFBF7 0%, #F8F4EC 100%)',
                      borderRadius: '20px',
                      padding: '1rem 0.5rem 1.25rem',
                      marginBottom: '1rem',
                      border: '1px solid #EDE8DD',
                      boxShadow: '0 2px 8px rgba(0,0,0,0.05)',
                    }}>
                      {/* Title inside sticky area */}
                      <h3 style={{
                        fontFamily: "'Fraunces', serif",
                        fontSize: '0.9rem',
                        color: 'var(--text)',
                        marginBottom: '0.5rem',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '0.4rem',
                      }}>
                        <span style={{fontSize: '0.85rem'}}>‚ú®</span>
                        <span>Your Life Map</span>
                      </h3>
                      <svg width={width} height={height} style={{ display: 'block', margin: '0 auto' }}>
                        {/* Subtle decorative rings */}
                        <circle cx={centerX} cy={centerY} r="30" fill="none" stroke="#C5B89A" strokeWidth="0.5" opacity="0.2" />
                        <circle cx={centerX} cy={centerY} r="65" fill="none" stroke="#C5B89A" strokeWidth="0.5" opacity="0.15" strokeDasharray="3 3" />
                        
                        {/* Multi-domain connection lines (curved) */}
                        {connections.map((conn, i) => {
                          const midX = (conn.from.x + conn.to.x) / 2;
                          const midY = (conn.from.y + conn.to.y) / 2;
                          // Curve toward center
                          const ctrlX = midX + (centerX - midX) * 0.5;
                          const ctrlY = midY + (centerY - midY) * 0.5;
                          return (
                            <g key={`conn-${i}`}>
                              <path
                                d={`M ${conn.from.x} ${conn.from.y} Q ${ctrlX} ${ctrlY} ${conn.to.x} ${conn.to.y}`}
                                fill="none"
                                stroke={conn.color}
                                strokeWidth="2.5"
                                opacity="0.35"
                                strokeLinecap="round"
                              />
                              <title>{conn.text}</title>
                            </g>
                          );
                        })}
                        
                        {/* Lines from center to icons for each prompt answer */}
                        {promptLines.map((line, i) => {
                          const midX = (centerX + line.offsetX + line.node.x) / 2;
                          const midY = (centerY + line.offsetY + line.node.y) / 2;
                          return (
                            <g key={`prompt-line-${i}`}
                              style={{ cursor: 'pointer' }}
                              onMouseEnter={() => setHoveredLine({ 
                                question: line.fact.question, 
                                answer: line.fact.text,
                                x: midX,
                                y: midY,
                                color: line.fact.color
                              })}
                              onMouseLeave={() => setHoveredLine(null)}
                            >
                              <line 
                                x1={centerX + line.offsetX} 
                                y1={centerY + line.offsetY} 
                                x2={line.node.x} 
                                y2={line.node.y}
                                stroke={line.fact.color} 
                                strokeWidth="2.5" 
                                opacity="0.5"
                                strokeLinecap="round"
                              />
                              {/* Invisible wider line for easier hovering */}
                              <line 
                                x1={centerX + line.offsetX} 
                                y1={centerY + line.offsetY} 
                                x2={line.node.x} 
                                y2={line.node.y}
                                stroke="transparent" 
                                strokeWidth="12" 
                              />
                            </g>
                          );
                        })}
                        
                        {/* Category icons (outer ellipse) - size grows with goals */}
                        {categoryNodes.map((node, i) => {
                          const r = node.baseRadius * node.scale;
                          const fontSize = 15 * node.scale;
                          const nodeFacts = allFacts.filter(f => f.domain === node.domain);
                          const nodeGoals = goals.filter(g => g.lifeArea === node.domain);
                          const nodeHabits = weeklyHabits.filter(h => h.lifeArea === node.domain);
                          
                          // Habit indicators: small dots in a ring around the icon
                          const habitDots = [];
                          for (let h = 0; h < Math.min(node.habitCount, 5); h++) {
                            const dotAngle = (h / Math.min(node.habitCount, 5)) * Math.PI * 2 - Math.PI / 2;
                            const dotRadius = r + 8;
                            habitDots.push({
                              x: node.x + Math.cos(dotAngle) * dotRadius,
                              y: node.y + Math.sin(dotAngle) * dotRadius,
                            });
                          }
                          
                          return (
                            <g key={`cat-${i}`} style={{ cursor: 'pointer' }}
                              onMouseEnter={() => {
                                if (nodeFacts.length > 0 || nodeGoals.length > 0 || nodeHabits.length > 0) {
                                  setHoveredNode({ 
                                    domain: node.domain, 
                                    facts: nodeFacts, 
                                    goals: nodeGoals,
                                    habits: nodeHabits,
                                    x: node.x, 
                                    y: node.y, 
                                    name: VLQ_DOMAINS[node.domain]?.name 
                                  });
                                }
                              }}
                              onMouseLeave={() => setHoveredNode(null)}
                              onClick={() => {
                                handleExpandArea(node.domain);
                                if (expandedArea !== node.domain) {
                                  setTimeout(() => {
                                    document.getElementById(`life-area-${node.domain}`)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                  }, 100);
                                }
                              }}>
                              
                              {/* Habit indicator dots around the icon */}
                              {habitDots.map((dot, hi) => (
                                <circle key={`habit-${hi}`} cx={dot.x} cy={dot.y} r="3" fill={node.color} opacity="0.6" />
                              ))}
                              
                              {/* Main icon circle */}
                              <circle cx={node.x} cy={node.y} r={r}
                                fill={node.hasContent || node.goalCount > 0 ? node.color : '#FDFBF7'}
                                stroke={node.color} strokeWidth={node.hasContent || node.goalCount > 0 ? "0" : "1.5"}
                                opacity={node.hasContent || node.goalCount > 0 ? 0.85 : 0.6} />
                              <text x={node.x} y={node.y + fontSize * 0.4} textAnchor="middle" fontSize={fontSize} style={{ pointerEvents: 'none' }}>
                                {node.icon}
                              </text>
                              
                              {/* Goal count badge */}
                              {node.goalCount > 0 && (
                                <g>
                                  <circle cx={node.x + r * 0.7} cy={node.y - r * 0.7} r="8" fill="var(--accent)" />
                                  <text x={node.x + r * 0.7} y={node.y - r * 0.7 + 3} textAnchor="middle" fill="white" fontSize="9" fontWeight="600">
                                    {node.goalCount}
                                  </text>
                                </g>
                              )}
                            </g>
                          );
                        })}
                        
                        {/* Center node */}
                        <circle cx={centerX} cy={centerY} r="28" fill="var(--accent)" />
                        <text x={centerX} y={centerY - 2} textAnchor="middle" fill="white" fontSize="11" fontWeight="600">You</text>
                        <text x={centerX} y={centerY + 11} textAnchor="middle" fill="white" fontSize="9" opacity="0.9">
                          {goals.length} {goals.length === 1 ? 'goal' : 'goals'}
                        </text>
                      </svg>
                      
                      {/* Hover tooltip for goals and habits only */}
                      {hoveredNode && (hoveredNode.goals?.length > 0 || hoveredNode.habits?.length > 0) && (
                        <div style={{
                          position: 'absolute',
                          left: '50%',
                          bottom: '1rem',
                          transform: 'translateX(-50%)',
                          backgroundColor: 'white',
                          border: '1px solid var(--border)',
                          borderRadius: '10px',
                          padding: '0.75rem 1rem',
                          boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
                          maxWidth: '320px',
                          zIndex: 100,
                        }}>
                          <div style={{ fontSize: '0.7rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.4rem', textTransform: 'uppercase' }}>
                            {hoveredNode.name}
                          </div>
                          
                          {/* Goals with linked habits */}
                          {hoveredNode.goals?.length > 0 && (
                            <div style={{ marginBottom: '0.4rem' }}>
                              {hoveredNode.goals.map((goal, idx) => {
                                const linkedHabits = hoveredNode.habits?.filter(h => h.goalId === goal.id) || [];
                                return (
                                  <div key={idx} style={{ marginBottom: '0.3rem' }}>
                                    <div style={{ fontSize: '0.8rem', color: 'var(--text)' }}>
                                      üéØ {goal.text}
                                    </div>
                                    {linkedHabits.map((habit, hi) => (
                                      <div key={hi} style={{ fontSize: '0.75rem', color: 'var(--text-muted)', paddingLeft: '1rem', marginTop: '0.15rem' }}>
                                        ‚Ü≥ üîÑ {habit.text} ({habit.frequency}x/wk)
                                      </div>
                                    ))}
                                  </div>
                                );
                              })}
                            </div>
                          )}
                          
                          {/* Unlinked Habits */}
                          {(() => {
                            const unlinkedHabits = hoveredNode.habits?.filter(h => !h.goalId) || [];
                            if (unlinkedHabits.length === 0) return null;
                            return (
                              <div>
                                {unlinkedHabits.map((habit, idx) => (
                                  <div key={idx} style={{ fontSize: '0.8rem', color: 'var(--text)' }}>
                                    üîÑ {habit.text} ({habit.frequency}x/wk)
                                  </div>
                                ))}
                              </div>
                            );
                          })()}
                        </div>
                      )}
                      
                      {/* Hover tooltip for prompt lines - shows question and answer */}
                      {hoveredLine && (
                        <div style={{
                          position: 'absolute',
                          left: '50%',
                          bottom: '1rem',
                          transform: 'translateX(-50%)',
                          backgroundColor: 'white',
                          border: `2px solid ${hoveredLine.color}`,
                          borderRadius: '10px',
                          padding: '0.75rem 1rem',
                          boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                          maxWidth: '300px',
                          zIndex: 101,
                        }}>
                          <div style={{ fontSize: '0.75rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.3rem' }}>
                            {hoveredLine.question}
                          </div>
                          <div style={{ fontSize: '0.9rem', color: 'var(--text)' }}>
                            "{hoveredLine.answer}"
                          </div>
                        </div>
                      )}
                      
                      {/* Empty state text - positioned below SVG */}
                      {goals.length === 0 && allFacts.length === 0 && (
                        <div style={{ textAlign: 'center', color: '#9A8F7D', fontSize: '0.8rem', marginTop: '-0.25rem' }}>
                          {onboardingStep === 1 
                            ? 'Click on each focus area to add one goal and answer one prompt to build the base of your map'
                            : 'Add goals and answer prompts to build your map'
                          }
                        </div>
                      )}
                    </div>
                    
                    {/* Life Area Cards - Grouped by category */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem', marginTop: '0.5rem' }}>
                      
                      {(() => {
                        // Categorize life areas with new logic:
                        // Back Burner: importance ‚â§ 4
                        // Strengths: importance ‚â• 5 AND gap < 3 (sorted by importance desc)
                        // Focus Areas: importance ‚â• 5 AND gap ‚â• 3 (sorted by gap desc)
                        const backBurner = [];
                        const strengths = [];
                        const focusAreas = [];
                        
                        VLQ_ORDER.forEach(areaKey => {
                          const scores = vlqScores[areaKey] || {};
                          const importance = scores.importance || 5;
                          const consistency = scores.consistency || 5;
                          const gap = importance - consistency;
                          const areaGoals = goals.filter(g => g.lifeArea === areaKey);
                          const areaHabits = weeklyHabits.filter(h => h.lifeArea === areaKey);
                          const notes = prefs.lifeAreaNotes?.[areaKey] || '';
                          const structured = prefs.structuredInfo?.[areaKey] || {};
                          const hasLifeMapInfo = notes || Object.values(structured).some(v => v);
                          
                          const areaData = { areaKey, importance, consistency, gap, areaGoals, areaHabits, hasLifeMapInfo, notes, structured };
                          
                          if (importance <= 4) {
                            backBurner.push(areaData);
                          } else if (gap >= 3) {
                            // importance >= 5 AND gap >= 3
                            focusAreas.push(areaData);
                          } else {
                            // importance >= 5 AND gap < 3
                            strengths.push(areaData);
                          }
                        });
                        
                        // Sort each group
                        backBurner.sort((a, b) => b.importance - a.importance);
                        strengths.sort((a, b) => b.importance - a.importance);
                        focusAreas.sort((a, b) => b.gap - a.gap);
                        
                        const renderAreaCard = (areaData) => {
                          const { areaKey, importance, consistency, gap, areaGoals, areaHabits, hasLifeMapInfo, notes, structured } = areaData;
                          const area = VLQ_DOMAINS[areaKey];
                          const isExpanded = expandedArea === areaKey;
                          
                          const discoveryQs = {
                            family: [
                              { key: 'closeTo', q: "Who are you closest to?", placeholder: "Names, relationships..." },
                              { key: 'tradition', q: "What's a tradition you cherish?", placeholder: "Weekly calls, holiday rituals..." },
                              { key: 'values', q: "What family values matter most?", placeholder: "Loyalty, openness, togetherness..." },
                              { key: 'time', q: "How do you spend time together?", placeholder: "Dinners, trips, game nights..." },
                              { key: 'grateful', q: "What are you grateful for about your family?", placeholder: "Support, memories, love..." },
                              { key: 'improve', q: "What would you like to improve?", placeholder: "Communication, quality time..." },
                              { key: 'history', q: "What family history shapes you?", placeholder: "Stories, heritage, lessons..." },
                              { key: 'support', q: "How does your family support you?", placeholder: "Encouragement, advice, presence..." },
                              { key: 'challenge', q: "What's challenging right now?", placeholder: "Distance, disagreements, busy schedules..." },
                              { key: 'celebrate', q: "How do you celebrate together?", placeholder: "Holidays, milestones, everyday moments..." },
                              { key: 'communicate', q: "How do you stay connected?", placeholder: "Calls, texts, visits..." },
                              { key: 'boundaries', q: "What boundaries matter with family?", placeholder: "Privacy, time, topics..." },
                              { key: 'roles', q: "What role do you play in your family?", placeholder: "Peacemaker, planner, listener..." },
                              { key: 'future', q: "What do you hope for your family's future?", placeholder: "Closeness, health, adventures..." },
                              { key: 'learn', q: "What have you learned from family?", placeholder: "Values, skills, perspectives..." },
                              { key: 'miss', q: "What do you miss about family?", placeholder: "People, places, moments..." },
                              { key: 'proud', q: "What makes you proud of your family?", placeholder: "Achievements, resilience, love..." },
                              { key: 'conflict', q: "How do you handle family conflict?", placeholder: "Talk it out, give space, mediate..." },
                              { key: 'memories', q: "What's a favorite family memory?", placeholder: "Trips, gatherings, simple moments..." },
                              { key: 'wish', q: "What do you wish family knew about you?", placeholder: "Dreams, struggles, needs..." }
                            ],
                            partner: [
                              { key: 'name', q: "What's their name?", placeholder: "Your person..." },
                              { key: 'together', q: "What do you love doing together?", placeholder: "Cooking, hiking, lazy Sundays..." },
                              { key: 'goals', q: "What are you building together?", placeholder: "A home, a family, adventures..." },
                              { key: 'appreciate', q: "What do you appreciate about them?", placeholder: "Their humor, kindness, support..." },
                              { key: 'met', q: "How did you meet?", placeholder: "The story of you two..." },
                              { key: 'love', q: "What made you fall in love?", placeholder: "Qualities, moments, feelings..." },
                              { key: 'challenge', q: "What do you work on together?", placeholder: "Communication, balance, growth..." },
                              { key: 'dream', q: "What's a shared dream?", placeholder: "Travel, home, experiences..." },
                              { key: 'support', q: "How do they support you?", placeholder: "Encouragement, listening, helping..." },
                              { key: 'language', q: "What's their love language?", placeholder: "Words, acts, time, touch, gifts..." },
                              { key: 'laugh', q: "What makes you both laugh?", placeholder: "Inside jokes, shows, memories..." },
                              { key: 'grow', q: "How have you grown together?", placeholder: "Challenges overcome, lessons learned..." },
                              { key: 'date', q: "What's your ideal date?", placeholder: "Dinner, adventure, cozy night..." },
                              { key: 'strength', q: "What's your relationship's strength?", placeholder: "Trust, communication, fun..." },
                              { key: 'ritual', q: "Do you have any rituals together?", placeholder: "Morning coffee, weekly dates..." },
                              { key: 'navigate', q: "How do you navigate disagreements?", placeholder: "Talk, space, compromise..." },
                              { key: 'admire', q: "What do you admire about them?", placeholder: "Work ethic, kindness, passion..." },
                              { key: 'team', q: "How do you work as a team?", placeholder: "Divide tasks, decisions, support..." },
                              { key: 'future', q: "What excites you about your future together?", placeholder: "Plans, possibilities, growth..." },
                              { key: 'grateful', q: "What are you most grateful for?", placeholder: "Their presence, love, partnership..." }
                            ],
                            friendships: [
                              { key: 'crew', q: "Who's in your inner circle?", placeholder: "Best friends, your people..." },
                              { key: 'hangout', q: "How do you like to connect?", placeholder: "Calls, dinners, adventures..." },
                              { key: 'support', q: "How do friends support you?", placeholder: "Listening, advice, fun..." },
                              { key: 'new', q: "How do you make new friends?", placeholder: "Through work, hobbies, mutual friends..." },
                              { key: 'long', q: "Who's your longest friendship?", placeholder: "Childhood friend, college buddy..." },
                              { key: 'miss', q: "Which friends do you miss?", placeholder: "People who moved, drifted..." },
                              { key: 'give', q: "What do you bring to friendships?", placeholder: "Loyalty, humor, advice..." },
                              { key: 'need', q: "What do you need from friends?", placeholder: "Honesty, fun, support..." },
                              { key: 'maintain', q: "How do you maintain friendships?", placeholder: "Regular calls, meetups, texts..." },
                              { key: 'challenge', q: "What's challenging about friendships now?", placeholder: "Time, distance, life stages..." },
                              { key: 'group', q: "Do you have a friend group?", placeholder: "How you met, what you do..." },
                              { key: 'one', q: "Describe a friendship that shaped you", placeholder: "What they taught you..." },
                              { key: 'conflict', q: "How do you handle conflict with friends?", placeholder: "Address it, let it go, space..." },
                              { key: 'celebrate', q: "How do you celebrate friends?", placeholder: "Birthdays, wins, just because..." },
                              { key: 'boundaries', q: "What boundaries matter in friendships?", placeholder: "Time, energy, topics..." },
                              { key: 'grow', q: "How have your friendships evolved?", placeholder: "Deeper, different, new..." },
                              { key: 'want', q: "What kind of friends do you want more of?", placeholder: "Adventurous, deep, local..." },
                              { key: 'hard', q: "Have you had a hard friendship ending?", placeholder: "What happened, what you learned..." },
                              { key: 'fun', q: "What's the most fun with friends?", placeholder: "Activities, conversations, trips..." },
                              { key: 'grateful', q: "What are you grateful for in your friendships?", placeholder: "Specific people, qualities, moments..." }
                            ],
                            career: [
                              { key: 'role', q: "What do you do?", placeholder: "Your work, your craft..." },
                              { key: 'focus', q: "What's energizing you right now?", placeholder: "Projects, goals, challenges..." },
                              { key: 'growth', q: "Where do you want to grow?", placeholder: "Skills, leadership, impact..." },
                              { key: 'purpose', q: "What gives your work meaning?", placeholder: "Helping others, creating, solving..." },
                              { key: 'proud', q: "What are you most proud of professionally?", placeholder: "Achievements, growth, impact..." },
                              { key: 'dream', q: "What's your dream role or project?", placeholder: "Position, company, creation..." },
                              { key: 'challenge', q: "What's your biggest work challenge?", placeholder: "Time, skills, politics..." },
                              { key: 'balance', q: "How's your work-life balance?", placeholder: "Boundaries, struggles, wins..." },
                              { key: 'team', q: "Who do you work with?", placeholder: "Team, mentors, collaborators..." },
                              { key: 'learn', q: "What are you learning at work?", placeholder: "Skills, lessons, insights..." },
                              { key: 'environment', q: "What work environment suits you?", placeholder: "Remote, office, hybrid..." },
                              { key: 'values', q: "What values matter in your work?", placeholder: "Integrity, creativity, impact..." },
                              { key: 'stress', q: "What stresses you about work?", placeholder: "Deadlines, politics, uncertainty..." },
                              { key: 'success', q: "How do you define career success?", placeholder: "Money, impact, freedom, growth..." },
                              { key: 'mentor', q: "Who has mentored you?", placeholder: "People who shaped your career..." },
                              { key: 'risk', q: "What career risk would you take?", placeholder: "New field, startup, own business..." },
                              { key: 'five', q: "Where do you see yourself in 5 years?", placeholder: "Role, company, achievements..." },
                              { key: 'strength', q: "What's your professional superpower?", placeholder: "Skill, trait, approach..." },
                              { key: 'change', q: "What would you change about your work?", placeholder: "Role, company, industry..." },
                              { key: 'passion', q: "What work would you do for free?", placeholder: "If money wasn't a factor..." }
                            ],
                            education: [
                              { key: 'learning', q: "What are you learning?", placeholder: "Skills, subjects, interests..." },
                              { key: 'curious', q: "What makes you curious?", placeholder: "Topics you'd love to explore..." },
                              { key: 'skills', q: "What skills do you want to develop?", placeholder: "Technical, creative, interpersonal..." },
                              { key: 'resources', q: "How do you like to learn?", placeholder: "Books, courses, hands-on..." },
                              { key: 'goal', q: "What's a learning goal?", placeholder: "Language, instrument, degree..." },
                              { key: 'obstacle', q: "What stops you from learning more?", placeholder: "Time, money, motivation..." },
                              { key: 'teacher', q: "Who has taught you the most?", placeholder: "Teachers, mentors, experiences..." },
                              { key: 'proud', q: "What have you taught yourself?", placeholder: "Skills learned independently..." },
                              { key: 'formal', q: "Any formal education plans?", placeholder: "Degrees, certifications, courses..." },
                              { key: 'topic', q: "What topic could you talk about for hours?", placeholder: "Your areas of expertise or passion..." },
                              { key: 'mistake', q: "What have you learned from mistakes?", placeholder: "Lessons from failures..." },
                              { key: 'child', q: "What did you love learning as a child?", placeholder: "Early interests and passions..." },
                              { key: 'share', q: "What knowledge do you want to share?", placeholder: "Teaching, mentoring, creating..." },
                              { key: 'book', q: "What book changed your thinking?", placeholder: "Impactful reads..." },
                              { key: 'skill', q: "What skill do you wish you had?", placeholder: "Something you'd love to do..." },
                              { key: 'practice', q: "How do you practice what you learn?", placeholder: "Application, projects, repetition..." },
                              { key: 'community', q: "Do you learn with others?", placeholder: "Groups, classes, study buddies..." },
                              { key: 'stuck', q: "What do you do when stuck on something?", placeholder: "Research, ask, take a break..." },
                              { key: 'surprise', q: "What surprised you while learning something?", placeholder: "Unexpected discoveries..." },
                              { key: 'next', q: "What's next on your learning list?", placeholder: "Upcoming topics or skills..." }
                            ],
                            recreation: [
                              { key: 'fun', q: "What's fun for you?", placeholder: "Hobbies, guilty pleasures..." },
                              { key: 'loseTrack', q: "What makes you lose track of time?", placeholder: "That thing you could do for hours..." },
                              { key: 'try', q: "What do you want to try?", placeholder: "New hobbies, experiences..." },
                              { key: 'recharge', q: "How does play recharge you?", placeholder: "Energy, creativity, joy..." },
                              { key: 'childhood', q: "What did you love doing as a kid?", placeholder: "Games, activities, adventures..." },
                              { key: 'weekend', q: "What's your ideal weekend?", placeholder: "Activities, pace, company..." },
                              { key: 'solo', q: "What do you enjoy doing alone?", placeholder: "Solo hobbies and activities..." },
                              { key: 'social', q: "What do you enjoy with others?", placeholder: "Group activities, games..." },
                              { key: 'creative', q: "Do you have a creative outlet?", placeholder: "Art, music, writing, crafts..." },
                              { key: 'active', q: "What active hobbies do you enjoy?", placeholder: "Sports, hiking, dancing..." },
                              { key: 'relax', q: "How do you truly relax?", placeholder: "Activities that calm you..." },
                              { key: 'bucket', q: "What's on your bucket list?", placeholder: "Experiences you want to have..." },
                              { key: 'dropped', q: "Any hobbies you've dropped?", placeholder: "Things you used to do..." },
                              { key: 'season', q: "What's your favorite seasonal activity?", placeholder: "Summer, winter, fall, spring fun..." },
                              { key: 'money', q: "If money was no object, what would you do for fun?", placeholder: "Dream activities..." },
                              { key: 'guilty', q: "What's a guilty pleasure?", placeholder: "Things you enjoy but maybe shouldn't..." },
                              { key: 'share', q: "What hobby do you want to share with others?", placeholder: "Teaching, doing together..." },
                              { key: 'obstacle', q: "What stops you from having more fun?", placeholder: "Time, money, energy..." },
                              { key: 'plan', q: "Do you plan fun or let it happen?", placeholder: "Your approach to recreation..." },
                              { key: 'joy', q: "What brings you pure joy?", placeholder: "Simple pleasures..." }
                            ],
                            spirituality: [
                              { key: 'peace', q: "What brings you peace?", placeholder: "Meditation, nature, music..." },
                              { key: 'believe', q: "What do you believe in?", placeholder: "Values, faith, philosophy..." },
                              { key: 'practice', q: "Do you have a spiritual practice?", placeholder: "Prayer, meditation, reflection..." },
                              { key: 'meaning', q: "What gives life meaning?", placeholder: "Connection, growth, purpose..." },
                              { key: 'wonder', q: "What fills you with wonder?", placeholder: "Nature, art, universe..." },
                              { key: 'tradition', q: "Any spiritual traditions you follow?", placeholder: "Religious, cultural, personal..." },
                              { key: 'question', q: "What big questions do you ponder?", placeholder: "Life, death, purpose, existence..." },
                              { key: 'connect', q: "How do you connect to something bigger?", placeholder: "Nature, community, faith..." },
                              { key: 'values', q: "What values guide your life?", placeholder: "Core principles..." },
                              { key: 'growth', q: "How has your spirituality evolved?", placeholder: "Changes over time..." },
                              { key: 'ritual', q: "Do you have any personal rituals?", placeholder: "Morning routine, gratitude, reflection..." },
                              { key: 'nature', q: "How does nature affect you spiritually?", placeholder: "Connection, peace, awe..." },
                              { key: 'community', q: "Do you have a spiritual community?", placeholder: "Church, sangha, group..." },
                              { key: 'challenge', q: "What challenges your beliefs?", placeholder: "Doubts, questions, experiences..." },
                              { key: 'comfort', q: "What comforts you in hard times?", placeholder: "Beliefs, practices, people..." },
                              { key: 'gratitude', q: "What are you grateful for?", placeholder: "Blessings, gifts, moments..." },
                              { key: 'death', q: "How do you think about mortality?", placeholder: "Beliefs, fears, acceptance..." },
                              { key: 'sacred', q: "What do you consider sacred?", placeholder: "People, places, practices..." },
                              { key: 'teacher', q: "Who or what has been a spiritual teacher?", placeholder: "People, books, experiences..." },
                              { key: 'hope', q: "What gives you hope?", placeholder: "Beliefs, observations, faith..." }
                            ],
                            community: [
                              { key: 'belong', q: "Where do you feel you belong?", placeholder: "Groups, places, causes..." },
                              { key: 'give', q: "How do you like to give back?", placeholder: "Volunteering, helping..." },
                              { key: 'causes', q: "What causes matter to you?", placeholder: "Environment, education, justice..." },
                              { key: 'connect', q: "How do you connect to community?", placeholder: "Events, organizations, neighbors..." },
                              { key: 'role', q: "What role do you play in your community?", placeholder: "Leader, helper, participant..." },
                              { key: 'local', q: "How engaged are you locally?", placeholder: "Neighborhood, city involvement..." },
                              { key: 'online', q: "Any online communities you're part of?", placeholder: "Forums, groups, networks..." },
                              { key: 'impact', q: "What impact do you want to make?", placeholder: "Change you want to create..." },
                              { key: 'time', q: "How much time do you give to community?", placeholder: "Hours, frequency, commitment..." },
                              { key: 'money', q: "What causes do you support financially?", placeholder: "Donations, memberships..." },
                              { key: 'skill', q: "What skills could you offer?", placeholder: "Expertise you could share..." },
                              { key: 'barrier', q: "What stops you from being more involved?", placeholder: "Time, energy, access..." },
                              { key: 'inspired', q: "Who inspires you in community work?", placeholder: "Leaders, activists, helpers..." },
                              { key: 'change', q: "What would you change in your community?", placeholder: "Issues you'd address..." },
                              { key: 'tradition', q: "Any community traditions you love?", placeholder: "Events, gatherings, customs..." },
                              { key: 'new', q: "What communities would you like to join?", placeholder: "Groups you're curious about..." },
                              { key: 'receive', q: "What have you received from community?", placeholder: "Support, belonging, growth..." },
                              { key: 'voice', q: "How do you use your voice?", placeholder: "Advocacy, voting, speaking up..." },
                              { key: 'bridge', q: "Do you bridge different communities?", placeholder: "Connecting groups, translating..." },
                              { key: 'legacy', q: "What community legacy do you want to leave?", placeholder: "Long-term impact..." }
                            ],
                            health: [
                              { key: 'move', q: "How do you like to move?", placeholder: "Workouts, sports, dancing..." },
                              { key: 'fuel', q: "What makes your body feel good?", placeholder: "Foods, habits, routines..." },
                              { key: 'sleep', q: "How's your sleep?", placeholder: "Routine, quality, challenges..." },
                              { key: 'energy', q: "What gives you energy?", placeholder: "Activities, foods, rest..." },
                              { key: 'goal', q: "What's a health goal?", placeholder: "Fitness, nutrition, wellness..." },
                              { key: 'challenge', q: "What's your biggest health challenge?", placeholder: "Obstacles, conditions, habits..." },
                              { key: 'routine', q: "Describe your morning routine", placeholder: "How you start your day..." },
                              { key: 'habit', q: "What healthy habit are you building?", placeholder: "New practices..." },
                              { key: 'break', q: "What unhealthy habit do you want to break?", placeholder: "Things to let go of..." },
                              { key: 'body', q: "How's your relationship with your body?", placeholder: "Acceptance, struggles, growth..." },
                              { key: 'checkup', q: "How do you stay on top of health?", placeholder: "Checkups, monitoring, awareness..." },
                              { key: 'stress', q: "How does stress affect your health?", placeholder: "Physical symptoms, impact..." },
                              { key: 'water', q: "How's your hydration?", placeholder: "Water intake, habits..." },
                              { key: 'food', q: "What's your relationship with food?", placeholder: "Enjoyment, challenges, balance..." },
                              { key: 'rest', q: "How do you rest and recover?", placeholder: "Recovery practices..." },
                              { key: 'nature', q: "Do you spend time outdoors?", placeholder: "Fresh air, nature, sunlight..." },
                              { key: 'support', q: "Who supports your health journey?", placeholder: "Doctors, trainers, partners..." },
                              { key: 'age', q: "How do you think about aging?", placeholder: "Goals, concerns, acceptance..." },
                              { key: 'best', q: "When do you feel your best physically?", placeholder: "Conditions, times, activities..." },
                              { key: 'invest', q: "How do you invest in your health?", placeholder: "Time, money, attention..." }
                            ],
                            mentalHealth: [
                              { key: 'recharge', q: "How do you recharge?", placeholder: "Rest, solitude, activities..." },
                              { key: 'boundaries', q: "What boundaries matter to you?", placeholder: "Time, energy, space..." },
                              { key: 'support', q: "What supports your mental health?", placeholder: "Therapy, journaling, friends..." },
                              { key: 'stress', q: "How do you handle stress?", placeholder: "Exercise, talking, nature..." },
                              { key: 'anxious', q: "What makes you anxious?", placeholder: "Triggers, situations, thoughts..." },
                              { key: 'calm', q: "What calms you down?", placeholder: "Activities, people, practices..." },
                              { key: 'mood', q: "How do you track your mood?", placeholder: "Journaling, apps, awareness..." },
                              { key: 'therapy', q: "Have you tried therapy?", placeholder: "Experience, interest, thoughts..." },
                              { key: 'medication', q: "Any thoughts on medication?", placeholder: "Experience, openness..." },
                              { key: 'trigger', q: "What triggers difficult emotions?", placeholder: "Situations, people, thoughts..." },
                              { key: 'cope', q: "What are your go-to coping strategies?", placeholder: "Healthy ways you manage..." },
                              { key: 'talk', q: "Who can you talk to about hard things?", placeholder: "Safe people in your life..." },
                              { key: 'self', q: "How's your self-talk?", placeholder: "Kind, critical, working on it..." },
                              { key: 'down', q: "What do you do when you're feeling down?", placeholder: "Activities that help..." },
                              { key: 'growth', q: "How has your mental health journey evolved?", placeholder: "Progress, setbacks, learning..." },
                              { key: 'stigma', q: "How do you feel about mental health stigma?", placeholder: "Experiences, thoughts..." },
                              { key: 'routine', q: "Do you have mental health routines?", placeholder: "Daily practices..." },
                              { key: 'warning', q: "What are your warning signs?", placeholder: "Signals you're struggling..." },
                              { key: 'joy', q: "What brings you genuine joy?", placeholder: "Simple pleasures..." },
                              { key: 'proud', q: "What mental health progress are you proud of?", placeholder: "Growth and wins..." }
                            ],
                          };
                          
                          // Function to generate AI prompt when all static prompts are answered
                          const generateAIPrompt = async () => {
                            if (!apiKey) return null;
                            const areaName = area.name;
                            const existingAnswers = Object.entries(structured).map(([k, v]) => v).filter(Boolean);
                            try {
                              const response = await fetch('https://api.anthropic.com/v1/messages', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                                body: JSON.stringify({
                                  model: 'claude-sonnet-4-20250514',
                                  max_tokens: 150,
                                  messages: [{ role: 'user', content: `Generate ONE unique, thoughtful question about someone's ${areaName} life area. They've already answered questions about: ${existingAnswers.join(', ')}. Ask something different and meaningful. Return ONLY the question text, nothing else. Keep it under 10 words.` }]
                                })
                              });
                              const data = await response.json();
                              return data.content?.[0]?.text?.trim();
                            } catch (e) {
                              return null;
                            }
                          };
                          const questions = discoveryQs[areaKey] || [];
                          
                          return (
                            <div key={areaKey} id={`life-area-${areaKey}`} style={{
                              backgroundColor: 'var(--bg-elevated)',
                              borderRadius: '12px',
                              borderLeft: `4px solid ${area.color}`,
                              overflow: 'hidden',
                            }}>
                              {/* Collapsed Header */}
                              <div 
                                onClick={() => handleExpandArea(areaKey)}
                                style={{ 
                                  padding: '0.75rem 1rem',
                                  cursor: 'pointer',
                                  display: 'flex',
                                  justifyContent: 'space-between',
                                  alignItems: 'center',
                                }}
                              >
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                  <span style={{ fontSize: '1.1rem' }}>{area.icon}</span>
                                  <span style={{ fontWeight: 600, color: 'var(--text)', fontSize: '0.9rem' }}>{area.name}</span>
                                  {(areaGoals.length > 0 || areaHabits.length > 0) && (
                                    <span style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginLeft: '0.25rem' }}>
                                      ({areaGoals.length > 0 ? `${areaGoals.length} goal${areaGoals.length > 1 ? 's' : ''}` : ''}{areaGoals.length > 0 && areaHabits.length > 0 ? ', ' : ''}{areaHabits.length > 0 ? `${areaHabits.length} habit${areaHabits.length > 1 ? 's' : ''}` : ''})
                                    </span>
                                  )}
                                </div>
                                <span style={{ color: 'var(--text-muted)', fontSize: '0.8rem', transition: 'transform 0.2s', transform: isExpanded ? 'rotate(180deg)' : 'rotate(0deg)' }}>‚ñº</span>
                              </div>
                              
                              {/* Expanded Content */}
                              {isExpanded && (
                                <div style={{ padding: '0 1rem 1rem 1rem', borderTop: '1px solid var(--border)' }}>
                                  
                                  {/* Progress indicator during onboarding */}
                                  {!onboardingCompleted && onboardingStep === 1 && (() => {
                                    return (
                                      <div style={{ 
                                        display: 'flex', 
                                        gap: '1rem', 
                                        padding: '0.75rem', 
                                        backgroundColor: 'var(--bg-card)', 
                                        borderRadius: '8px', 
                                        marginTop: '0.75rem',
                                        fontSize: '0.75rem'
                                      }}>
                                        <span style={{ color: areaGoals.length > 0 ? 'var(--accent)' : 'var(--text-muted)' }}>
                                          {areaGoals.length > 0 ? '‚úì' : '‚óã'} Goal
                                        </span>
                                        <span style={{ color: hasLifeMapInfo ? 'var(--accent)' : 'var(--text-muted)' }}>
                                          {hasLifeMapInfo ? '‚úì' : '‚óã'} Prompt
                                        </span>
                                      </div>
                                    );
                                  })()}
                                  
                                  {/* 1. Goals */}
                                  <div style={{ marginTop: '0.75rem' }}>
                                    <div style={{ fontSize: '0.75rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.5rem' }}>
                                      {areaGoals.length > 0 ? 'YOUR GOALS' : 'ADD A GOAL'}
                                    </div>
                                    
                                    {/* Show existing goals */}
                                    {areaGoals.length > 0 && (
                                      <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                        {areaGoals.map(goal => (
                                          <div key={goal.id} style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between', 
                                            alignItems: 'center',
                                            padding: '0.5rem 0.75rem', 
                                            backgroundColor: 'var(--bg-elevated)', 
                                            borderRadius: '8px',
                                            border: '1px solid var(--border)'
                                          }}>
                                            <span style={{ fontSize: '0.85rem', color: 'var(--text)' }}>üéØ {goal.text}</span>
                                            <button 
                                              onClick={() => setGoals(prev => prev.filter(g => g.id !== goal.id))}
                                              style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.8rem', padding: '0.25rem' }}
                                            >√ó</button>
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                    
                                    {/* Add another goal input */}
                                    <div>
                                      <input type="text" 
                                        value={tempFormData[`newGoal_${areaKey}`] || ''}
                                        onChange={(e) => setTempFormData(prev => ({...prev, [`newGoal_${areaKey}`]: e.target.value}))}
                                        placeholder={areaGoals.length > 0 ? "Add another goal..." : "What do you want to accomplish?"}
                                        onKeyDown={(e) => {
                                          if (e.key === 'Enter' && tempFormData[`newGoal_${areaKey}`]?.trim()) {
                                            setGoals(prev => [...prev, { id: Date.now().toString(), text: tempFormData[`newGoal_${areaKey}`].trim(), lifeArea: areaKey, completed: false }]);
                                            setTempFormData(prev => ({...prev, [`newGoal_${areaKey}`]: ''}));
                                            if (onLifeMapAnswer) onLifeMapAnswer(areaKey);
                                          }
                                        }}
                                        style={{ width: '100%', padding: '0.6rem 0.75rem', border: '1px solid var(--border)', borderRadius: '8px', backgroundColor: 'white', color: 'var(--text)', fontSize: '0.85rem', boxSizing: 'border-box' }}
                                      />
                                      <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>Press Enter to save</div>
                                    </div>
                                  </div>
                                  
                                  {/* 2. Weekly Habits - Only show after onboarding */}
                                  {onboardingCompleted && (
                                  <div style={{ marginTop: '0.75rem' }}>
                                    <div style={{ fontSize: '0.75rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.5rem' }}>
                                      {areaHabits.length > 0 ? 'YOUR WEEKLY HABITS' : 'ADD A WEEKLY HABIT'} <span style={{ fontWeight: 400, fontSize: '0.65rem', color: 'var(--text-muted)' }}>(optional)</span>
                                    </div>
                                    
                                    {/* Show existing habits */}
                                    {areaHabits.length > 0 && (
                                      <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                        {areaHabits.map(habit => (
                                          <div key={habit.id} style={{ 
                                            display: 'flex', 
                                            justifyContent: 'space-between', 
                                            alignItems: 'center',
                                            padding: '0.5rem 0.75rem', 
                                            backgroundColor: 'var(--bg-elevated)', 
                                            borderRadius: '8px',
                                            border: '1px solid var(--border)'
                                          }}>
                                            <span style={{ fontSize: '0.85rem', color: 'var(--text)' }}>
                                              üîÑ {habit.text} <span style={{ color: 'var(--text-muted)', fontSize: '0.75rem' }}>({habit.frequency}x/wk)</span>
                                            </span>
                                            <button 
                                              onClick={() => setWeeklyHabits(prev => prev.filter(h => h.id !== habit.id))}
                                              style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.8rem', padding: '0.25rem' }}
                                            >√ó</button>
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                    
                                    {/* Add another habit input */}
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                      <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                        <input type="text" 
                                          value={tempFormData[`newHabit_${areaKey}`] || ''}
                                          onChange={(e) => setTempFormData(prev => ({...prev, [`newHabit_${areaKey}`]: e.target.value}))}
                                          placeholder={areaHabits.length > 0 ? "Add another habit..." : "What will you do regularly?"}
                                          onKeyDown={(e) => {
                                            if (e.key === 'Enter' && tempFormData[`newHabit_${areaKey}`]?.trim()) {
                                              const freq = parseInt(tempFormData[`habitFreq_${areaKey}`]) || 3;
                                              // Auto-link to first goal if user didn't select one
                                              const linkedGoalId = tempFormData[`linkedGoal_${areaKey}`] || (areaGoals.length > 0 ? areaGoals[0].id : null);
                                              setWeeklyHabits(prev => [...prev, { 
                                                id: Date.now().toString(), 
                                                text: tempFormData[`newHabit_${areaKey}`].trim(), 
                                                lifeArea: areaKey, 
                                                frequency: freq, 
                                                color: area.color,
                                                goalId: linkedGoalId
                                              }]);
                                              setTempFormData(prev => ({...prev, [`newHabit_${areaKey}`]: '', [`habitFreq_${areaKey}`]: '', [`linkedGoal_${areaKey}`]: ''}));
                                              if (onLifeMapAnswer) onLifeMapAnswer(areaKey);
                                            }
                                          }}
                                          style={{ flex: 1, padding: '0.6rem 0.75rem', border: '1px solid var(--border)', borderRadius: '8px', backgroundColor: 'white', color: 'var(--text)', fontSize: '0.85rem' }}
                                        />
                                        <select 
                                          value={tempFormData[`habitFreq_${areaKey}`] || '3'}
                                          onChange={(e) => setTempFormData(prev => ({...prev, [`habitFreq_${areaKey}`]: e.target.value}))}
                                          style={{ padding: '0.6rem', border: '1px solid var(--border)', borderRadius: '8px', backgroundColor: 'white', color: 'var(--text)', fontSize: '0.85rem' }}
                                        >
                                          {[1,2,3,4,5,6,7].map(n => <option key={n} value={n}>{n}x/wk</option>)}
                                        </select>
                                      </div>
                                      
                                      {/* Link to goal dropdown - show during onboarding or if there are goals */}
                                      {areaGoals.length > 0 && (
                                        <select 
                                          value={tempFormData[`linkedGoal_${areaKey}`] || (areaGoals.length === 1 ? areaGoals[0].id : '')}
                                          onChange={(e) => setTempFormData(prev => ({...prev, [`linkedGoal_${areaKey}`]: e.target.value}))}
                                          style={{ padding: '0.5rem 0.75rem', border: '1px solid var(--border)', borderRadius: '8px', backgroundColor: 'white', color: 'var(--text-muted)', fontSize: '0.8rem' }}
                                        >
                                          {areaGoals.length === 1 ? (
                                            <option value={areaGoals[0].id}>üéØ {areaGoals[0].text}</option>
                                          ) : (
                                            <>
                                              <option value="">Link to a goal</option>
                                              {areaGoals.map(g => (
                                                <option key={g.id} value={g.id}>üéØ {g.text}</option>
                                              ))}
                                            </>
                                          )}
                                        </select>
                                      )}
                                    </div>
                                    <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>Press Enter to save</div>
                                  </div>
                                  )}
                                  
                                  {/* 3. Life Area Prompt */}
                                  <div style={{ marginTop: '0.75rem' }}>
                                    {/* Current prompt question - show from questions array or use tempFormData.currentPromptIdx */}
                                    {(() => {
                                      const promptIdx = tempFormData[`promptIdx_${areaKey}`] || 0;
                                      const aiPrompt = tempFormData[`aiPrompt_${areaKey}`];
                                      const isGeneratingPrompt = tempFormData[`generatingPrompt_${areaKey}`];
                                      const promptQuestions = prefs.promptQuestions?.[areaKey] || {};
                                      
                                      // Use AI prompt if we've cycled through all static ones, otherwise use static
                                      const currentQuestion = aiPrompt 
                                        ? { key: `ai_${Date.now()}`, q: aiPrompt, placeholder: "Your answer..." }
                                        : (questions[promptIdx] || questions[0]);
                                      
                                      const answeredKeys = Object.keys(structured).filter(k => structured[k]);
                                      
                                      // Get question text for an answer key
                                      const getQuestionText = (key) => {
                                        // First check if we have a stored question for this key
                                        if (promptQuestions[key]) return promptQuestions[key];
                                        // Otherwise find it in the questions array
                                        const q = questions.find(q => q.key === key);
                                        return q?.q || key;
                                      };
                                      
                                      return (
                                        <>
                                          {/* Show existing answers */}
                                          {answeredKeys.length > 0 && (
                                            <>
                                              <div style={{ fontSize: '0.75rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.5rem' }}>
                                                YOUR ANSWERS
                                              </div>
                                              <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem', marginBottom: '0.75rem' }}>
                                                {answeredKeys.map(key => (
                                                  <div key={key} style={{ 
                                                    padding: '0.5rem 0.75rem', 
                                                    backgroundColor: 'var(--bg-elevated)', 
                                                    borderRadius: '8px',
                                                    border: '1px solid var(--border)'
                                                  }}>
                                                    <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginBottom: '0.25rem' }}>
                                                      {getQuestionText(key)}
                                                    </div>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                                      <span style={{ fontSize: '0.85rem', color: 'var(--text)', flex: 1 }}>{structured[key]}</span>
                                                      <button 
                                                        onClick={() => {
                                                          const newStructured = { ...structured };
                                                          delete newStructured[key];
                                                          setUserProfile(prev => ({
                                                            ...prev,
                                                            tendPreferences: {
                                                              ...prev?.tendPreferences,
                                                              structuredInfo: { 
                                                                ...prev?.tendPreferences?.structuredInfo, 
                                                                [areaKey]: newStructured
                                                              }
                                                            }
                                                          }));
                                                        }}
                                                        style={{ background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '0.8rem', padding: '0.25rem', marginLeft: '0.5rem' }}
                                                      >√ó</button>
                                                    </div>
                                                  </div>
                                                ))}
                                              </div>
                                            </>
                                          )}
                                          
                                          <div style={{ fontSize: '0.75rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.5rem' }}>
                                            {isGeneratingPrompt ? 'Thinking of a question...' : (answeredKeys.length > 0 ? 'ADD MORE' : (currentQuestion?.q || 'TELL ME MORE'))} {!isGeneratingPrompt && answeredKeys.length > 0 && <span style={{ fontWeight: 400, fontSize: '0.65rem' }}>(optional)</span>}
                                          </div>
                                          
                                          {/* Show the question if user has answered some already */}
                                          {answeredKeys.length > 0 && !isGeneratingPrompt && (
                                            <div style={{ fontSize: '0.8rem', color: 'var(--text)', marginBottom: '0.5rem', fontStyle: 'italic' }}>
                                              {currentQuestion?.q}
                                            </div>
                                          )}
                                          
                                          {/* Input for current prompt */}
                                          {!isGeneratingPrompt && (
                                            <div>
                                              <input type="text" 
                                                value={tempFormData[`prompt_${areaKey}`] || ''}
                                                onChange={(e) => setTempFormData(prev => ({...prev, [`prompt_${areaKey}`]: e.target.value}))}
                                                placeholder={currentQuestion?.placeholder || "Share your thoughts..."}
                                                onKeyDown={(e) => {
                                                  if (e.key === 'Enter' && tempFormData[`prompt_${areaKey}`]?.trim()) {
                                                    const keyToUse = aiPrompt ? `ai_${Date.now()}` : currentQuestion.key;
                                                    setUserProfile(prev => ({
                                                      ...prev,
                                                      tendPreferences: {
                                                        ...prev?.tendPreferences,
                                                        structuredInfo: { 
                                                          ...prev?.tendPreferences?.structuredInfo, 
                                                          [areaKey]: { ...structured, [keyToUse]: tempFormData[`prompt_${areaKey}`] }
                                                        },
                                                        // Also store the question text for AI prompts
                                                        promptQuestions: {
                                                          ...prev?.tendPreferences?.promptQuestions,
                                                          [areaKey]: {
                                                            ...prev?.tendPreferences?.promptQuestions?.[areaKey],
                                                            [keyToUse]: currentQuestion.q
                                                          }
                                                        }
                                                      }
                                                    }));
                                                    setTempFormData(prev => ({...prev, [`prompt_${areaKey}`]: '', [`aiPrompt_${areaKey}`]: null}));
                                                    if (onLifeMapAnswer) onLifeMapAnswer(areaKey);
                                                  }
                                                }}
                                                style={{ width: '100%', padding: '0.6rem 0.75rem', border: '1px solid var(--border)', borderRadius: '8px', backgroundColor: 'white', color: 'var(--text)', fontSize: '0.85rem', boxSizing: 'border-box' }}
                                              />
                                              <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginTop: '0.25rem' }}>Press Enter to save</div>
                                            </div>
                                          )}
                                          
                                          {/* Try another prompt button */}
                                          <button
                                            disabled={isGeneratingPrompt}
                                            onClick={async () => {
                                              const nextIdx = promptIdx + 1;
                                              // If we've gone through all static prompts, generate AI one
                                              if (nextIdx >= questions.length) {
                                                setTempFormData(prev => ({...prev, [`generatingPrompt_${areaKey}`]: true, [`prompt_${areaKey}`]: ''}));
                                                const aiQ = await generateAIPrompt();
                                                setTempFormData(prev => ({
                                                  ...prev, 
                                                  [`generatingPrompt_${areaKey}`]: false,
                                                  [`aiPrompt_${areaKey}`]: aiQ || "What else would you like to share?",
                                                  [`promptIdx_${areaKey}`]: nextIdx
                                                }));
                                              } else {
                                                setTempFormData(prev => ({...prev, [`promptIdx_${areaKey}`]: nextIdx, [`aiPrompt_${areaKey}`]: null, [`prompt_${areaKey}`]: ''}));
                                              }
                                            }}
                                            style={{ 
                                              marginTop: '0.5rem',
                                              padding: '0.4rem 0.75rem', 
                                              border: '1px dashed var(--border)', 
                                              borderRadius: '6px', 
                                              backgroundColor: 'transparent', 
                                              color: 'var(--text-muted)', 
                                              fontSize: '0.75rem', 
                                              cursor: isGeneratingPrompt ? 'wait' : 'pointer',
                                              display: 'flex',
                                              alignItems: 'center',
                                              gap: '0.35rem',
                                              opacity: isGeneratingPrompt ? 0.5 : 1
                                            }}
                                          >
                                            <span>{isGeneratingPrompt ? '‚è≥' : 'üîÑ'}</span> {isGeneratingPrompt ? 'Generating...' : 'Try a different prompt'}
                                          </button>
                                        </>
                                      );
                                    })()}
                                  </div>
                                  
                                </div>
                              )}
                            </div>
                          );
                        };
                        
                        return (
                          <>
                            {/* Focus Areas */}
                            {focusAreas.length > 0 ? (
                              <div>
                                <div style={{ fontSize: '0.75rem', fontWeight: 600, color: '#E8A090', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                  <span>üå±</span> FOCUS AREAS
                                  <span style={{ fontWeight: 400, color: 'var(--text-muted)' }}>‚Äî room to grow</span>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                  {focusAreas.map(renderAreaCard)}
                                </div>
                              </div>
                            ) : (
                              <div style={{ 
                                padding: '1rem', 
                                backgroundColor: 'var(--bg-elevated)', 
                                borderRadius: '8px', 
                                textAlign: 'center',
                                marginBottom: '1rem'
                              }}>
                                <span style={{ fontSize: '1.5rem' }}>‚ú®</span>
                                <p style={{ fontSize: '0.85rem', color: 'var(--text-muted)', marginTop: '0.5rem' }}>
                                  You're doing great across the board! No major gaps right now.
                                </p>
                              </div>
                            )}
                            
                            {/* Strengths - Only show after onboarding */}
                            {onboardingCompleted && strengths.length > 0 && (
                              <div>
                                <div style={{ fontSize: '0.75rem', fontWeight: 600, color: 'var(--accent)', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                  <span>üí™</span> STRENGTHS
                                  <span style={{ fontWeight: 400, color: 'var(--text-muted)' }}>‚Äî thriving here</span>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                  {strengths.map(renderAreaCard)}
                                </div>
                              </div>
                            )}
                            
                            {/* Back Burner - Only show after onboarding */}
                            {onboardingCompleted && backBurner.length > 0 && (
                              <div>
                                <div style={{ fontSize: '0.75rem', fontWeight: 600, color: 'var(--text-muted)', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                  <span>üåø</span> BACK BURNER
                                  <span style={{ fontWeight: 400, color: 'var(--text-muted)' }}>‚Äî lower priority</span>
                                </div>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                                  {backBurner.map(renderAreaCard)}
                                </div>
                              </div>
                            )}
                          </>
                        );
                      })()}
                    </div>
                  </div>
                );
              })()}
            </div>
            )}
            
                        {/* Gardener Type Section - hide during Life Map onboarding step */}
            {onboardingStep !== 1 && (
            <div id="gardener-quiz-section">
            {(() => {
              const savedGardenerType = userProfile?.tendPreferences?.gardenerType;
              const quizStep = tempFormData.quizStep || 0;
              const quizAnswers = tempFormData.quizAnswers || {};
              const isGenerating = tempFormData.isGenerating || false;
              const generatedResult = tempFormData.generatedResult || null;
              
              // Auto-open quiz when autoExpandSection is 'quiz'
              if (autoExpandSection === 'quiz' && !savedGardenerType && expandedArea !== 'quiz') {
                setTimeout(() => setExpandedArea('quiz'), 100);
              }
              
              // If taking the quiz, show it here
              if (expandedArea === 'quiz') {
                const quizQuestions = [
                  // Q1: Energy source (introvert/extrovert) - affects how Tend suggests activities
                  { q: "After a long week, what actually recharges you?", trait: 'energy', options: [
                    { text: "Solo time ‚Äî a bath, a book, blissful silence", id: 'a', value: 'solo' },
                    { text: "Quality time with my favorite person or two", id: 'b', value: 'intimate' },
                    { text: "Getting out ‚Äî dinner, a party, being around people", id: 'c', value: 'social' },
                    { text: "Doing something active or creative with my hands", id: 'd', value: 'active' },
                  ]},
                  // Q2: Time preference - affects when Tend suggests habits/check-ins
                  { q: "When do you feel most like yourself?", trait: 'timeOfDay', options: [
                    { text: "Early morning, before the world wakes up", id: 'a', value: 'earlyMorning' },
                    { text: "Mid-morning, coffee in hand, ready to go", id: 'b', value: 'morning' },
                    { text: "Afternoon or evening, once I've warmed up", id: 'c', value: 'afternoon' },
                    { text: "Late night, when it's quiet and I can think", id: 'd', value: 'night' },
                  ]},
                  // Q3: Motivation style - affects how Tend frames goals and celebrates
                  { q: "What makes you actually want to stick with something?", trait: 'motivation', options: [
                    { text: "Seeing progress, even tiny wins along the way", id: 'a', value: 'progress' },
                    { text: "Knowing someone else is counting on me", id: 'b', value: 'accountability' },
                    { text: "A clear deadline or target to hit", id: 'c', value: 'deadline' },
                    { text: "Genuinely enjoying the process itself", id: 'd', value: 'intrinsic' },
                  ]},
                  // Q4: Pace preference - affects habit frequency and goal chunking
                  { q: "How do you prefer to tackle big things?", trait: 'pace', options: [
                    { text: "Slow and steady ‚Äî small steps, every day", id: 'a', value: 'steady' },
                    { text: "Focused bursts with breaks in between", id: 'b', value: 'bursts' },
                    { text: "All at once when I'm feeling inspired", id: 'c', value: 'intense' },
                    { text: "Flexibly ‚Äî depends on my energy that day", id: 'd', value: 'flexible' },
                  ]},
                  // Q5: Structure preference - affects how rigid/flexible Tend is
                  { q: "Your ideal daily routine is:", trait: 'structure', options: [
                    { text: "Predictable ‚Äî I thrive with consistency", id: 'a', value: 'structured' },
                    { text: "Loosely planned with room to adjust", id: 'b', value: 'semi' },
                    { text: "Different every day ‚Äî variety keeps me engaged", id: 'c', value: 'varied' },
                    { text: "What routine? I go where the day takes me", id: 'd', value: 'spontaneous' },
                  ]},
                  // Q6: Stress response - affects how Tend supports during hard times
                  { q: "When life gets overwhelming, you need:", trait: 'stressResponse', options: [
                    { text: "Space to process on my own first", id: 'a', value: 'space' },
                    { text: "Someone to talk it through with", id: 'b', value: 'talk' },
                    { text: "A clear action plan to feel in control", id: 'c', value: 'action' },
                    { text: "A break ‚Äî something fun to reset my brain", id: 'd', value: 'distraction' },
                  ]},
                  // Q7: Feedback style - affects Tend's tone and celebration style
                  { q: "When you accomplish something, you want people to:", trait: 'feedback', options: [
                    { text: "Notice and celebrate with me!", id: 'a', value: 'celebrate' },
                    { text: "Acknowledge it simply, no big fuss", id: 'b', value: 'acknowledge' },
                    { text: "Ask what I learned or what's next", id: 'c', value: 'growth' },
                    { text: "Honestly? I celebrate internally, that's enough", id: 'd', value: 'internal' },
                  ]},
                  // Q8: Communication preference - affects Tend's chat style
                  { q: "The vibe you want from a supportive friend:", trait: 'communication', options: [
                    { text: "Warm and encouraging ‚Äî be my cheerleader", id: 'a', value: 'warm' },
                    { text: "Honest and direct ‚Äî tell it like it is", id: 'b', value: 'direct' },
                    { text: "Curious and thoughtful ‚Äî ask good questions", id: 'c', value: 'curious' },
                    { text: "Chill and low-pressure ‚Äî no judgment ever", id: 'd', value: 'chill' },
                  ]},
                  // Q9: Challenge preference - affects goal difficulty suggestions
                  { q: "When setting goals, you tend to:", trait: 'challenge', options: [
                    { text: "Start small ‚Äî I'd rather succeed than overcommit", id: 'a', value: 'conservative' },
                    { text: "Aim high ‚Äî I'm motivated by ambitious targets", id: 'b', value: 'ambitious' },
                    { text: "Set a range ‚Äî minimum and stretch goals", id: 'c', value: 'range' },
                    { text: "Avoid specific goals ‚Äî they stress me out", id: 'd', value: 'avoidant' },
                  ]},
                  // Q10: Growth mindset - affects how Tend handles setbacks
                  { q: "When you miss a goal or break a streak:", trait: 'setback', options: [
                    { text: "I'm hard on myself, but I get back up", id: 'a', value: 'selfCritical' },
                    { text: "I shrug it off ‚Äî tomorrow's a new day", id: 'b', value: 'resilient' },
                    { text: "I analyze what went wrong and adjust", id: 'c', value: 'analytical' },
                    { text: "I often give up and start something new", id: 'd', value: 'restarter' },
                  ]},
                ];
                
                const generateGardenerType = async (answers) => {
                  setTempFormData(prev => ({ ...prev, isGenerating: true }));
                  
                  // Extract trait values from answers
                  const traits = {};
                  const answerDetails = quizQuestions.map((q, i) => {
                    const selectedOption = q.options.find(o => o.id === answers[i]);
                    if (q.trait && selectedOption?.value) {
                      traits[q.trait] = selectedOption.value;
                    }
                    return `Q: ${q.q}\nA: ${selectedOption?.text || 'No answer'}`;
                  });
                  const answerSummary = answerDetails.join('\n\n');
                  
                  // Build trait summary for the AI
                  const traitSummary = `
PERSONALITY TRAITS IDENTIFIED:
- Energy: ${traits.energy || 'unknown'} (how they recharge)
- Best time of day: ${traits.timeOfDay || 'unknown'}
- Motivation style: ${traits.motivation || 'unknown'}
- Pace preference: ${traits.pace || 'unknown'}
- Structure need: ${traits.structure || 'unknown'}
- Stress response: ${traits.stressResponse || 'unknown'}
- Feedback preference: ${traits.feedback || 'unknown'}
- Communication style wanted: ${traits.communication || 'unknown'}
- Goal-setting approach: ${traits.challenge || 'unknown'}
- Setback response: ${traits.setback || 'unknown'}`;
                  
                  const prefs = userProfile?.tendPreferences || {};
                  const lifeMapContext = [];
                  VLQ_ORDER.forEach(domain => {
                    const structured = prefs.structuredInfo?.[domain] || {};
                    const notes = prefs.lifeAreaNotes?.[domain];
                    const filledValues = Object.values(structured).filter(v => v);
                    if (filledValues.length > 0 || notes) {
                      lifeMapContext.push(`${VLQ_DOMAINS[domain]?.name}: ${[...filledValues, notes].filter(Boolean).join(', ')}`);
                    }
                  });
                  
                  try {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                      body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        system: `You are creating a personalized "gardener type" for someone based on their personality quiz answers. This is for a wellness app called Tend where life = garden.

Create a gardener type that uses ACTUAL GARDENING WORDS. The name must be gardening-themed!

NAME GUIDELINES - MUST use gardening terminology:
- Good examples: "The Patient Gardener", "The Dawn Planter", "The Steady Cultivator", "The Careful Pruner", "The Wild Gardener", "The Container Gardener", "The Greenhouse Tender", "The Seed Starter", "The Root Tender", "The Season Planner"
- BAD examples (not gardening-related): "The Flexible Flow Finder", "The Deep Diver", "The Morning Starter", "The Quiet Achiever"
- The noun MUST be a gardening word: Gardener, Planter, Cultivator, Pruner, Tender, Grower, Harvester, Sower, Weeder, etc.
- Format: "The [Adjective] [Gardening Noun]"

TONE: Grounded and practical, NOT whimsical or spiritual. No "bloom keeper" or "storm dancer" nonsense.

The description should be 3-4 sentences that use gardening metaphors naturally. Reference patterns from their answers. Make them feel understood.

IMPORTANT: Include a "tendingStyle" object that will help the app personalize their experience.

Respond in this exact JSON format only:
{
  "name": "The [Adjective] [Gardening Noun]",
  "emoji": "[single plant/garden emoji]",
  "description": "[3-4 sentences using gardening metaphors, warm but grounded]",
  "strength": "[Their superpower in 4-6 words, gardening-themed]",
  "color": "[hex color matching the vibe]",
  "tendingStyle": {
    "checkInTone": "[warm/direct/curious/chill]",
    "celebrationStyle": "[big/simple/growth-focused/internal]",
    "reminderTiming": "[morning/afternoon/evening/flexible]",
    "habitApproach": "[steady-small/focused-bursts/flexible]",
    "struggleSupport": "[give-space/talk-through/action-plan/distraction]",
    "goalStyle": "[conservative/ambitious/range-based/process-focused]"
  }
}`,
                        messages: [{ role: 'user', content: `Based on these quiz answers, create a unique gardener archetype:\n\n${answerSummary}\n\n${traitSummary}${lifeMapContext.length > 0 ? `\n\nLife context:\n${lifeMapContext.join('\n')}` : ''}` }]
                      })
                    });
                    const data = await response.json();
                    const text = data.content?.[0]?.text;
                    const jsonMatch = text.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                      const result = JSON.parse(jsonMatch[0]);
                      // Add the raw traits to the result for direct access
                      result.traits = traits;
                      setTempFormData(prev => ({ ...prev, isGenerating: false, generatedResult: result }));
                    } else throw new Error('Parse failed');
                  } catch (error) {
                    console.error('Error generating gardener type:', error);
                    setTempFormData(prev => ({ ...prev, isGenerating: false, generatedResult: {
                      name: "The Steady Gardener", emoji: "üå±",
                      description: "You tend your garden with patience and care, understanding that growth happens in its own time. You're not one to rush the seasons or force a bloom before it's ready. Your approach is thoughtful ‚Äî you plant seeds knowing some will flourish and others will teach you something. There's wisdom in how you nurture what matters most.",
                      strength: "Nurturing growth with patience", color: "#85B79D",
                      traits: traits,
                      tendingStyle: {
                        checkInTone: traits.communication || 'warm',
                        celebrationStyle: traits.feedback === 'celebrate' ? 'big' : 'simple',
                        reminderTiming: traits.timeOfDay === 'earlyMorning' || traits.timeOfDay === 'morning' ? 'morning' : 'evening',
                        habitApproach: traits.pace === 'steady' ? 'steady-small' : 'flexible',
                        struggleSupport: traits.stressResponse || 'talk-through',
                        goalStyle: traits.challenge || 'conservative'
                      }
                    }}));
                  }
                };
                
                const currentQ = quizQuestions[quizStep];
                const progress = (quizStep / quizQuestions.length) * 100;
                
                return (
                  <div style={{ ...insightsStyles.section, marginBottom: '2rem', border: '2px solid var(--accent)' }}>
                    {!generatedResult && !isGenerating && (
                      <div style={{ height: '4px', backgroundColor: '#EDE8DD', marginBottom: '1rem', borderRadius: '2px' }}>
                        <div style={{ height: '100%', width: `${progress}%`, backgroundColor: 'var(--accent)', transition: 'width 0.3s', borderRadius: '2px' }} />
                      </div>
                    )}
                    
                    {!generatedResult && (
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '1rem' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                          <span style={{ fontSize: '1.5rem' }}>üå±</span>
                          <div>
                            <div style={{ fontWeight: 600, fontSize: '1rem' }}>{isGenerating ? 'Discovering your type...' : 'What kind of gardener are you?'}</div>
                            <div style={{ fontSize: '0.8rem', color: 'var(--text-muted)' }}>{isGenerating ? 'This takes a moment' : `Question ${quizStep + 1} of ${quizQuestions.length}`}</div>
                          </div>
                        </div>
                        {!isGenerating && <button onClick={() => { setExpandedArea(null); setTempFormData({}); }} style={{ background: 'none', border: 'none', fontSize: '1.5rem', color: 'var(--text-muted)', cursor: 'pointer' }}>√ó</button>}
                      </div>
                    )}
                    {generatedResult && (
                      <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '0.5rem' }}>
                        <button onClick={() => { setExpandedArea(null); setTempFormData({}); }} style={{ background: 'none', border: 'none', fontSize: '1.5rem', color: 'var(--text-muted)', cursor: 'pointer' }}>√ó</button>
                      </div>
                    )}
                    
                    {isGenerating ? (
                      <div style={{ textAlign: 'center', padding: '2rem 1rem' }}>
                        <div style={{ fontSize: '3rem', marginBottom: '1rem', animation: 'pulse 1.5s ease-in-out infinite' }}>üå±</div>
                        <div style={{ fontWeight: 500 }}>Growing your unique gardener profile...</div>
                        <div style={{ color: 'var(--text-muted)', fontSize: '0.85rem' }}>Analyzing your answers to create something just for you</div>
                        <style>{`@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); opacity: 0.8; } }`}</style>
                      </div>
                    ) : generatedResult ? (
                      <div>
                        <div style={{ padding: '1.75rem', backgroundColor: `${generatedResult.color}12`, borderRadius: '16px', marginBottom: '1.25rem', border: `1px solid ${generatedResult.color}25` }}>
                          <div style={{ fontSize: '4rem', textAlign: 'center', marginBottom: '0.75rem' }}>{generatedResult.emoji}</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 700, color: generatedResult.color, textAlign: 'center', marginBottom: '0.35rem', fontFamily: "'Fraunces', serif" }}>{generatedResult.name}</div>
                          <div style={{ fontSize: '0.75rem', color: 'var(--text-muted)', textAlign: 'center', marginBottom: '1.25rem', textTransform: 'uppercase', letterSpacing: '1px' }}>Your Gardener Type</div>
                          <div style={{ fontSize: '0.95rem', lineHeight: 1.7, textAlign: 'center', marginBottom: '1.25rem' }}>{generatedResult.description}</div>
                          <div style={{ padding: '0.75rem', backgroundColor: 'white', borderRadius: '8px', textAlign: 'center' }}>
                            <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', marginBottom: '0.25rem', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Your superpower</div>
                            <div style={{ fontSize: '0.95rem', color: generatedResult.color, fontWeight: 600 }}>{generatedResult.strength}</div>
                          </div>
                        </div>
                        <button onClick={() => { setUserProfile(prev => ({ ...prev, tendPreferences: { ...prev?.tendPreferences, gardenerType: { ...generatedResult, answers: quizAnswers, completedAt: new Date().toISOString() } } })); setTempFormData({}); setExpandedArea(null); if (onQuizComplete) onQuizComplete(generatedResult); }}
                          style={{ width: '100%', padding: '1rem', border: 'none', borderRadius: '12px', backgroundColor: generatedResult.color, color: 'white', fontSize: '1rem', cursor: 'pointer', fontWeight: 600 }}>
                          Save my gardener type
                        </button>
                        <button onClick={() => setTempFormData({ quizStep: 0, quizAnswers: {}, isGenerating: false, generatedResult: null })}
                          style={{ width: '100%', padding: '0.75rem', border: 'none', backgroundColor: 'transparent', color: 'var(--text-muted)', fontSize: '0.85rem', cursor: 'pointer', marginTop: '0.75rem' }}>
                          Retake quiz
                        </button>
                      </div>
                    ) : (
                      <div>
                        <div style={{ fontSize: '0.95rem', marginBottom: '1rem', fontWeight: 500, lineHeight: 1.4 }}>{currentQ?.q}</div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>
                          {currentQ?.options.map((option, i) => (
                            <button key={i} onClick={() => {
                              const newAnswers = { ...quizAnswers, [quizStep]: option.id };
                              if (quizStep < quizQuestions.length - 1) setTempFormData({ quizStep: quizStep + 1, quizAnswers: newAnswers });
                              else { setTempFormData({ quizStep, quizAnswers: newAnswers }); generateGardenerType(newAnswers); }
                            }}
                            style={{ padding: '0.85rem 1rem', border: '1px solid var(--border)', borderRadius: '10px', backgroundColor: 'var(--bg-elevated)', fontSize: '0.85rem', cursor: 'pointer', textAlign: 'left', transition: 'all 0.15s' }}
                            onMouseOver={(e) => { e.currentTarget.style.backgroundColor = 'var(--accent-light)'; e.currentTarget.style.borderColor = 'var(--accent)'; }}
                            onMouseOut={(e) => { e.currentTarget.style.backgroundColor = 'var(--bg-elevated)'; e.currentTarget.style.borderColor = 'var(--border)'; }}>
                              {option.text}
                            </button>
                          ))}
                        </div>
                        {quizStep > 0 && <button onClick={() => setTempFormData({ ...tempFormData, quizStep: quizStep - 1 })} style={{ marginTop: '1rem', padding: '0.5rem', border: 'none', backgroundColor: 'transparent', color: 'var(--text-muted)', fontSize: '0.85rem', cursor: 'pointer' }}>‚Üê Back</button>}
                      </div>
                    )}
                  </div>
                );
              }
              
              // If they have a saved gardener type, show it
              if (savedGardenerType) {
                return (
                  <div style={{ ...insightsStyles.section, marginBottom: '2rem', background: `linear-gradient(135deg, ${savedGardenerType.color}08 0%, ${savedGardenerType.color}15 100%)`, border: `1px solid ${savedGardenerType.color}30` }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                      <div style={{ fontSize: '3rem' }}>{savedGardenerType.emoji}</div>
                      <div style={{ flex: 1 }}>
                        <div style={{ fontSize: '0.7rem', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px', marginBottom: '0.25rem' }}>Your Gardener Type</div>
                        <div style={{ fontSize: '1.25rem', fontWeight: 700, color: savedGardenerType.color, fontFamily: "'Fraunces', serif" }}>{savedGardenerType.name}</div>
                      </div>
                      <button onClick={() => { setExpandedArea('quiz'); setTempFormData({ quizStep: 0, quizAnswers: {}, isGenerating: false, generatedResult: null }); }}
                        style={{ padding: '0.5rem 1rem', border: `1px solid ${savedGardenerType.color}40`, borderRadius: '8px', backgroundColor: 'transparent', color: savedGardenerType.color, fontSize: '0.8rem', cursor: 'pointer' }}>
                        Retake
                      </button>
                    </div>
                    <div style={{ marginTop: '1rem', fontSize: '0.9rem', lineHeight: 1.6, color: 'var(--text)' }}>{savedGardenerType.description}</div>
                    <div style={{ marginTop: '1rem', padding: '0.6rem 1rem', backgroundColor: 'white', borderRadius: '8px', display: 'inline-block' }}>
                      <span style={{ fontSize: '0.7rem', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Superpower: </span>
                      <span style={{ fontSize: '0.85rem', color: savedGardenerType.color, fontWeight: 600 }}>{savedGardenerType.strength}</span>
                    </div>
                  </div>
                );
              }
              
              // Otherwise show the quiz teaser
              return (
                <div onClick={() => setExpandedArea('quiz')} style={{
                  ...insightsStyles.section,
                  marginBottom: '2rem',
                  background: 'linear-gradient(135deg, #F5EBD9 0%, #FBF7F0 100%)',
                  border: '1px solid #E8DCC8',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '1rem',
                  transition: 'transform 0.15s, box-shadow 0.15s',
                }}
                onMouseOver={(e) => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)'; }}
                onMouseOut={(e) => { e.currentTarget.style.transform = 'none'; e.currentTarget.style.boxShadow = 'none'; }}>
                  <div style={{ fontSize: '2.5rem' }}>üåª</div>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, color: '#5D4E37', fontSize: '1rem', marginBottom: '0.25rem' }}>What kind of gardener are you?</div>
                    <div style={{ fontSize: '0.85rem', color: '#8A7B62' }}>Take a 2-minute quiz to discover your unique tending style</div>
                  </div>
                  <div style={{ color: '#8A7B62', fontSize: '1.5rem' }}>‚Üí</div>
                </div>
              );
            })()}
            </div>
            )}
          </div>
        </div>
      );
    }

    const styles = {
      container: { height: '100vh', maxHeight: '100vh', display: 'flex', flexDirection: 'column', backgroundColor: 'var(--bg-main)', overflow: 'hidden' },
      header: { padding: '0.875rem 2rem', borderBottom: '1px solid var(--border)', backgroundColor: 'var(--bg-card)', display: 'flex', alignItems: 'baseline', gap: '1rem' },
      logoContainer: { display: 'flex', alignItems: 'center' },
      logoText: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", fontWeight: 400, color: 'var(--text)' },
      tagline: { fontSize: '0.85rem', color: 'var(--text-muted)', fontStyle: 'italic', flex: 1 },
      settingsButton: { background: 'none', border: 'none', fontSize: '1.25rem', color: 'var(--text-muted)', cursor: 'pointer', padding: '0.25rem', opacity: 0.7, transition: 'opacity 0.2s' },

      main: { display: 'grid', gridTemplateColumns: '64px 1fr 320px', flex: 1, height: 'calc(100vh - 56px)', overflow: 'hidden' },

      sidebar: { backgroundColor: 'var(--bg-card)', borderRight: '1px solid var(--border)', display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden' },
      sidebarResizeHandle: { position: 'absolute', right: 0, top: 0, bottom: 0, width: '4px', cursor: 'ew-resize', backgroundColor: 'transparent', zIndex: 10, transition: 'background-color 0.2s' },
      sidebarNav: { display: 'flex', flexDirection: 'column', padding: '0.75rem 0.5rem', gap: '0.25rem', borderBottom: '1px solid var(--border)' },
      sidebarNavItem: { display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem', border: 'none', borderRadius: '10px', cursor: 'pointer', transition: 'background-color 0.2s', textAlign: 'left', width: '100%' },
      sidebarNavItemActive: { backgroundColor: 'var(--bg-elevated)' },
      sidebarNavIcon: { fontSize: '1.25rem', flexShrink: 0 },
      sidebarNavLabel: { fontSize: '0.85rem', color: 'var(--text)', fontWeight: 500, whiteSpace: 'nowrap', overflow: 'hidden', transition: 'opacity 0.2s, width 0.2s' },
      tabs: { display: 'flex', flex: 1 },
      tab: { flex: 1, padding: '0.875rem 0.375rem', backgroundColor: 'transparent', border: 'none', borderBottom: '2px solid transparent', color: 'var(--text-muted)', fontSize: '0.7rem', fontWeight: 500, cursor: 'pointer', whiteSpace: 'nowrap' },
      tabActive: { color: 'var(--text)', borderBottomColor: 'var(--accent)' },
      tabContent: { flex: 1, overflow: 'auto', padding: '1rem', minHeight: 0 },
      tabPlaceholder: { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', padding: '2rem' },
      placeholderText: { color: 'var(--text-muted)', fontSize: '0.85rem', textAlign: 'center', fontStyle: 'italic' },

      eventsTab: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      addItemButton: { padding: '0.625rem 1rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '8px', color: 'white', fontSize: '0.8rem', cursor: 'pointer', alignSelf: 'flex-start' },
      eventsList: { display: 'flex', flexDirection: 'column', gap: '0.5rem' },
      eventCard: { backgroundColor: 'var(--bg-elevated)', borderRadius: '10px', overflow: 'hidden' },
      eventHeader: { padding: '0.875rem 1rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer' },
      eventHeaderLeft: { display: 'flex', alignItems: 'center', gap: '0.625rem' },
      eventDot: { width: '8px', height: '8px', borderRadius: '50%', flexShrink: 0 },
      eventMonth: { fontSize: '0.7rem', fontWeight: 600, color: 'var(--text-muted)', textTransform: 'uppercase' },
      eventTitle: { fontSize: '0.875rem', color: 'var(--text)' },
      expandIcon: { color: 'var(--text-muted)', fontSize: '1rem' },
      eventDetails: { padding: '0 1rem 1rem', display: 'flex', flexDirection: 'column', gap: '0.75rem', borderTop: '1px solid var(--border)', paddingTop: '0.875rem' },
      detailField: { display: 'flex', flexDirection: 'column', gap: '0.25rem' },
      detailLabel: { fontSize: '0.7rem', color: 'var(--text-muted)' },
      detailInput: { padding: '0.5rem 0.75rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '6px', fontSize: '0.8rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none' },
      deleteEventButton: { padding: '0.5rem', backgroundColor: 'transparent', border: '1px solid var(--border)', borderRadius: '6px', color: 'var(--text-muted)', fontSize: '0.75rem', cursor: 'pointer', marginTop: '0.25rem' },
      emptyText: { color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic' },
      tipText: { color: 'var(--text-muted)', fontSize: '0.75rem', marginTop: 'auto', paddingTop: '1rem' },

      notesTab: { height: '100%' },
      notesTextarea: { width: '100%', height: '100%', minHeight: '300px', padding: '1rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.875rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none', lineHeight: 1.7 },

      goalsTab: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      goalsList: { display: 'flex', flexDirection: 'column', gap: '0.5rem' },
      goalCard: { display: 'flex', alignItems: 'center', gap: '0.75rem', padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '8px' },
      goalCheck: { width: '20px', height: '20px', borderRadius: '50%', border: '2px solid var(--accent)', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', color: 'white', fontSize: '0.7rem', flexShrink: 0 },
      goalText: { flex: 1, fontSize: '0.875rem', color: 'var(--text)' },
      goalDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1rem', opacity: 0.5 },

      centerPanel: { display: 'flex', flexDirection: 'column', alignItems: 'center', padding: '1.5rem 1.25rem', backgroundColor: 'var(--bg-main)', gap: '1.5rem', overflow: 'auto', height: '100%', minHeight: 0, flex: 1 },
      viewSwitcher: { display: 'flex', gap: '2px', backgroundColor: 'var(--bg-card)', padding: '4px', borderRadius: '12px', border: '1px solid var(--border)' },
      viewButton: { padding: '0.5rem 1rem', backgroundColor: 'transparent', border: 'none', borderRadius: '10px', color: 'var(--text-muted)', fontSize: '0.8rem', fontWeight: 500, cursor: 'pointer', transition: 'all 0.2s ease' },
      viewButtonActive: { backgroundColor: 'var(--accent)', color: 'white' },

      circleContainer: { display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '1rem' },
      circleAddButton: { padding: '0.5rem 1.25rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '20px', color: 'white', fontSize: '0.8rem', cursor: 'pointer' },

      // Seasons
      seasonsContainer: { width: '100%', maxWidth: '580px' },
      seasonsGrid: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem' },
      seasonCard: { borderRadius: '16px', overflow: 'hidden', border: '2px solid transparent' },
      seasonDecorative: { padding: '0.75rem', display: 'flex', justifyContent: 'center', gap: '0.75rem', fontSize: '1rem', opacity: 0.7 },
      seasonCardContent: { padding: '1rem', backgroundColor: 'var(--bg-card)', borderBottomLeftRadius: '14px', borderBottomRightRadius: '14px' },
      seasonCardHeader: { marginBottom: '0.5rem', position: 'relative' },
      seasonName: { fontSize: '1.125rem', fontFamily: "'Fraunces', serif", marginBottom: '0.125rem' },
      seasonMonths: { fontSize: '0.75rem', color: 'var(--text-muted)' },
      currentBadge: { position: 'absolute', top: 0, right: 0, fontSize: '0.6rem', color: 'white', padding: '0.2rem 0.5rem', borderRadius: '8px' },
      seasonDescription: { fontSize: '0.75rem', color: 'var(--text-muted)', lineHeight: 1.5, marginBottom: '0.75rem', fontStyle: 'italic' },
      seasonIntentionBox: { },
      seasonLabel: { fontSize: '0.7rem', fontWeight: 500, display: 'block', marginBottom: '0.375rem' },
      seasonTextarea: { width: '100%', padding: '0.625rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', fontSize: '0.8rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", resize: 'none', lineHeight: 1.5 },

      // Monthly
      monthlyContainer: { width: '100%', maxWidth: '500px', display: 'flex', flexDirection: 'column', gap: '1rem' },
      monthStrip: { display: 'flex', gap: '2px', backgroundColor: 'var(--bg-card)', padding: '4px', borderRadius: '10px', border: '1px solid var(--border)' },
      monthStripButton: { flex: 1, padding: '0.5rem 0.25rem', border: 'none', borderRadius: '6px', fontSize: '0.65rem', fontWeight: 500, cursor: 'pointer', transition: 'all 0.2s ease' },
      calendarWrapper: { backgroundColor: 'var(--bg-card)', borderRadius: '16px', overflow: 'hidden', border: '1px solid var(--border)' },
      calendarHeader: { padding: '0.875rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center', opacity: 0.85 },
      calendarNav: { background: 'none', border: 'none', color: 'white', fontSize: '1.25rem', cursor: 'pointer', padding: '0 0.5rem', opacity: 0.9 },
      calendarTitle: { color: 'white', fontSize: '1rem', fontFamily: "'Fraunces', serif" },
      calendarBody: { padding: '1rem' },
      calendarGrid: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '4px' },
      calendarDayHeader: { padding: '0.5rem', textAlign: 'center', fontSize: '0.65rem', color: 'var(--text-muted)', fontWeight: 500 },
      calendarDayEmpty: { aspectRatio: '1' },
      calendarDay: { aspectRatio: '1', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '0.8rem', color: 'var(--text-light)', backgroundColor: 'var(--bg-elevated)', borderRadius: '8px' },
      calendarDayToday: { color: 'white', fontWeight: 600 },
      monthEventsSection: { display: 'flex', flexDirection: 'column', gap: '0.5rem', alignItems: 'center' },
      monthEventsList: { width: '100%', display: 'flex', flexDirection: 'column', gap: '0.375rem' },
      monthEventItem: { display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-card)', borderRadius: '8px', fontSize: '0.85rem', border: '1px solid var(--border)' },
      noEventsText: { color: 'var(--text-muted)', fontSize: '0.85rem', fontStyle: 'italic' },
      addEventSmall: { padding: '0.5rem 1rem', backgroundColor: 'transparent', border: '1px solid', borderRadius: '20px', fontSize: '0.8rem', cursor: 'pointer' },

      // Weekly
      weeklyContainer: { width: '100%', maxWidth: '650px', display: 'flex', flexDirection: 'column', gap: '1.5rem', padding: '1rem' },
      weeklyHeader: { textAlign: 'center', marginBottom: '0.5rem' },
      weeklyTitle: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", color: 'var(--text)', marginBottom: '0.375rem' },
      weeklySubtitle: { fontSize: '0.9rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      weeklyGrid: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      weeklyDaysHeader: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', maxWidth: '350px', margin: '0 auto' },
      weeklyDayLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', textAlign: 'center', fontWeight: 500 },
      weeklyHabitsList: { display: 'flex', flexDirection: 'column', gap: '0.75rem' },
      weeklyHabitRow: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '1.5rem', padding: '1rem 1.25rem', backgroundColor: 'var(--bg-card)', borderRadius: '12px', border: '1px solid var(--border)' },
      weeklyHabitInfo: { display: 'flex', alignItems: 'center', gap: '0.625rem', flex: '1' },
      weeklyHabitDot: { width: '10px', height: '10px', borderRadius: '50%', flexShrink: 0 },
      weeklyHabitText: { fontSize: '0.95rem', color: 'var(--text)', fontWeight: 500 },
      weeklyHabitFreq: { fontSize: '0.75rem', color: 'var(--text-muted)', backgroundColor: 'var(--bg-elevated)', padding: '0.25rem 0.625rem', borderRadius: '12px', marginLeft: '0.5rem' },
      weeklyHabitDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1.125rem', opacity: 0.5, marginLeft: '0.5rem' },
      weeklyHabitDays: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '0.5rem', width: '280px', flexShrink: 0 },
      weeklyDayCircle: { width: '32px', height: '32px', borderRadius: '50%', border: '2px solid', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto' },
      weeklyEmpty: { textAlign: 'center', padding: '3rem 2rem', backgroundColor: 'var(--bg-card)', borderRadius: '16px', border: '1px dashed var(--border)' },
      weeklyEmptyText: { fontSize: '1rem', color: 'var(--text-muted)', fontStyle: 'italic', marginBottom: '0.25rem' },
      addHabitSection: { display: 'flex', gap: '0.625rem', alignItems: 'center', justifyContent: 'center', flexWrap: 'wrap' },
      addHabitInput: { flex: '1', minWidth: '200px', maxWidth: '280px', padding: '0.75rem 1rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.9rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif" },
      addHabitSelect: { padding: '0.75rem 1rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '10px', fontSize: '0.85rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif" },
      addHabitButton: { padding: '0.75rem 1.5rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '10px', color: 'white', fontSize: '0.85rem', cursor: 'pointer', fontWeight: 500 },
      lockedText: { textAlign: 'center', color: 'var(--text-muted)', fontSize: '0.9rem', fontStyle: 'italic', padding: '1rem' },

      // Daily
      dailyContainer: { width: '100%', maxWidth: '550px', display: 'flex', flexDirection: 'column', gap: '1.5rem', padding: '1rem' },
      dailyHeader: { textAlign: 'center', marginBottom: '0.5rem' },
      dailyTitle: { fontSize: '1.5rem', fontFamily: "'Fraunces', serif", color: 'var(--text)', marginBottom: '0.375rem' },
      dailySubtitle: { fontSize: '0.9rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      dailyList: { display: 'flex', flexDirection: 'column', gap: '0.75rem' },
      dailyHabitCard: { display: 'flex', alignItems: 'center', backgroundColor: 'var(--bg-card)', borderRadius: '14px', border: '1px solid var(--border)', overflow: 'hidden' },
      dailyHabitAccent: { width: '5px', height: '100%', minHeight: '70px', flexShrink: 0 },
      dailyHabitContent: { flex: 1, padding: '1rem 1.25rem', display: 'flex', flexDirection: 'column', gap: '0.2rem' },
      dailyHabitText: { fontSize: '1rem', color: 'var(--text)', fontWeight: 500 },
      dailyHabitLabel: { fontSize: '0.75rem', color: 'var(--text-muted)', fontStyle: 'italic' },
      dailyHabitDelete: { background: 'none', border: 'none', color: 'var(--text-muted)', cursor: 'pointer', fontSize: '1.25rem', padding: '1rem', opacity: 0.5 },
      dailyEmpty: { textAlign: 'center', padding: '3rem 2rem', backgroundColor: 'var(--bg-card)', borderRadius: '16px', border: '1px dashed var(--border)' },
      dailyEmptyText: { fontSize: '1rem', color: 'var(--text-muted)', marginBottom: '0.75rem' },
      dailyEmptyExamples: { fontSize: '0.85rem', color: 'var(--text-muted)' },
      addDailySection: { display: 'flex', flexDirection: 'column', gap: '0.625rem', alignItems: 'center' },
      addDailyInput: { width: '100%', maxWidth: '400px', padding: '0.875rem 1.125rem', backgroundColor: 'var(--bg-card)', border: '1px solid var(--border)', borderRadius: '12px', fontSize: '0.95rem', color: 'var(--text)', fontFamily: "'DM Sans', sans-serif", textAlign: 'center' },
      addDailyButton: { padding: '0.75rem 1.5rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '12px', color: 'white', fontSize: '0.9rem', cursor: 'pointer', fontWeight: 500 },

      // Bottom section - VLQ Summary
      bottomSection: { display: 'flex', justifyContent: 'center', gap: '2rem', width: '100%', maxWidth: '600px', padding: '1rem 1.5rem', backgroundColor: 'var(--bg-card)', borderRadius: '14px', border: '1px solid var(--border)', marginTop: 'auto' },
      vlqSummary: { display: 'flex', gap: '2.5rem', justifyContent: 'center', width: '100%' },
      vlqSummaryColumn: { display: 'flex', flexDirection: 'column', gap: '0.5rem', alignItems: 'center' },
      vlqSummaryLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', fontWeight: 500 },
      vlqSummaryItems: { display: 'flex', flexWrap: 'wrap', gap: '0.375rem', justifyContent: 'center' },
      vlqSummaryTag: { display: 'inline-flex', alignItems: 'center', gap: '0.25rem', padding: '0.3rem 0.6rem', backgroundColor: 'transparent', border: '1px solid', borderRadius: '12px', fontSize: '0.7rem' },
      sectionLabel: { fontSize: '0.65rem', textTransform: 'uppercase', letterSpacing: '0.1em', color: 'var(--text-muted)', marginBottom: '0.5rem', fontFamily: "'DM Sans', sans-serif", fontWeight: 600 },
      slider: { width: '100%', height: '3px', cursor: 'pointer' },

      // Chat
      chatPanel: { backgroundColor: 'var(--bg-card)', borderLeft: '1px solid var(--border)', display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden', position: 'relative' },
      resizeHandle: { position: 'absolute', left: 0, top: 0, bottom: 0, width: '6px', cursor: 'ew-resize', backgroundColor: 'transparent', zIndex: 10, transition: 'background-color 0.2s' },
      chatMessages: { flex: 1, padding: '1.25rem', overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: '0.875rem', minHeight: 0 },
      chatInputArea: { padding: '1rem 1.25rem 1.25rem', borderTop: '1px solid var(--border)' },
      chatInputForm: { padding: '1rem 1.25rem 1.25rem', borderTop: '1px solid var(--border)', display: 'flex', gap: '0.625rem', alignItems: 'center' },
      skipButton: { width: '100%', padding: '0.5rem', marginBottom: '0.75rem', backgroundColor: 'transparent', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text-muted)', fontSize: '0.8rem', cursor: 'pointer' },
      inputRow: { display: 'flex', gap: '0.625rem', alignItems: 'flex-end' },
      chatInput: { flex: 1, padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '12px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif", resize: 'none' },
      sendButton: { width: '40px', height: '40px', borderRadius: '50%', backgroundColor: 'var(--accent)', border: 'none', color: 'white', fontSize: '1rem', cursor: 'pointer', flexShrink: 0 },
      sendButtonDisabled: { backgroundColor: 'var(--border)', cursor: 'not-allowed' },
      chatMessage: { display: 'flex', gap: '0.625rem', alignItems: 'flex-start' },
      chatAvatar: { width: '28px', height: '28px', borderRadius: '50%', backgroundColor: 'var(--accent-light)', border: '1px solid var(--accent)', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 },
      chatAvatarText: { fontFamily: "'Fraunces', serif", fontSize: '0.75rem', color: 'var(--accent)' },
      chatBubble: { padding: '0.75rem 1rem', borderRadius: '14px', maxWidth: '88%', fontSize: '0.875rem', lineHeight: 1.55 },
      chatBubbleAssistant: { backgroundColor: 'var(--bg-elevated)', borderTopLeftRadius: '4px', color: 'var(--text)' },
      chatBubbleUser: { backgroundColor: 'var(--accent)', borderTopRightRadius: '4px', color: 'white' },
      typingBubble: { padding: '0.75rem 1rem', backgroundColor: 'var(--bg-elevated)', borderRadius: '14px', borderTopLeftRadius: '4px', display: 'flex', gap: '4px' },
      typingDot: { color: 'var(--accent)', fontSize: '1.125rem', lineHeight: 1, animation: 'pulse 1s infinite' },

      modalOverlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 },
      modal: { backgroundColor: 'var(--bg-card)', borderRadius: '16px', padding: '1.5rem', width: '90%', maxWidth: '360px', border: '1px solid var(--border)' },
      modalHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.25rem' },
      modalTitle: { fontSize: '1.125rem', fontFamily: "'Fraunces', serif", color: 'var(--text)' },
      modalClose: { width: '28px', height: '28px', borderRadius: '50%', backgroundColor: 'var(--bg-elevated)', border: 'none', color: 'var(--text-muted)', fontSize: '1rem', cursor: 'pointer' },
      modalForm: { display: 'flex', flexDirection: 'column', gap: '1rem' },
      formField: { display: 'flex', flexDirection: 'column', gap: '0.375rem' },
      formLabel: { fontSize: '0.7rem', color: 'var(--text-muted)', textTransform: 'uppercase', letterSpacing: '0.05em', fontWeight: 500 },
      textInput: { padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif" },
      selectInput: { padding: '0.625rem 0.875rem', backgroundColor: 'var(--bg-elevated)', border: '1px solid var(--border)', borderRadius: '8px', color: 'var(--text)', fontSize: '0.875rem', fontFamily: "'DM Sans', sans-serif" },
      submitButton: { padding: '0.75rem', backgroundColor: 'var(--accent)', border: 'none', borderRadius: '10px', color: 'white', fontSize: '0.875rem', fontWeight: 500, cursor: 'pointer', marginTop: '0.5rem' },
      submitButtonDisabled: { backgroundColor: 'var(--border-dark)', cursor: 'not-allowed' },
      settingsHint: { fontSize: '0.75rem', color: 'var(--text-muted)', marginTop: '0.5rem', lineHeight: 1.5 },
      settingsLink: { color: 'var(--accent)', textDecoration: 'none' },
      settingsStatus: { fontSize: '0.8rem', color: 'var(--accent)', textAlign: 'center', marginTop: '0.5rem' },
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<TendApp />);
  </script>
</body>
</html>






























